<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="nginx,">










<meta name="description" content="Nginx源码解读，正在阅读中。">
<meta name="keywords" content="nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx架构及源码阅读">
<meta property="og:url" content="http://yoursite.com/2021/09/30/nginx架构及源码解读/index.html">
<meta property="og:site_name" content="chst&#39;s Blog">
<meta property="og:description" content="Nginx源码解读，正在阅读中。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://z3.ax1x.com/2021/11/01/IPik9I.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/27/WItYGR.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/05/26/2pk4cn.md.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/05/30/2ELokD.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/05/30/2EXtrq.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/06/01/2npYee.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/06/03/21Zga9.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/02/RcHHKK.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/04/RW0I2j.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/05/R5gtCn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/08/10/fGIoYn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/06/RI50gJ.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/06/R7D2DO.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/06/R7DzPs.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/07/Rq8iGT.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/10/13/5Mizo8.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/10/16/5J4rrD.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/08/01/WzSSNq.png">
<meta property="og:image" content="http://yoursite.com/Users/wangyinkui/Library/Application%20Support/typora-user-images/image-20210801153020166.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/08/03/fFttns.png">
<meta property="og:updated_time" content="2021-12-03T16:11:34.663Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx架构及源码阅读">
<meta name="twitter:description" content="Nginx源码解读，正在阅读中。">
<meta name="twitter:image" content="https://z3.ax1x.com/2021/11/01/IPik9I.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/09/30/nginx架构及源码解读/">





  <title>nginx架构及源码阅读 | chst's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">chst's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">个人网站</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/30/nginx架构及源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chst">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chst's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">nginx架构及源码阅读</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-09-30T15:39:42+08:00">
                2021-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web服务/" itemprop="url" rel="index">
                    <span itemprop="name">Web服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/09/30/nginx架构及源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/09/30/nginx架构及源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/09/30/nginx架构及源码解读/" class="leancloud_visitors" data-flag-title="nginx架构及源码阅读">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Nginx源码解读，正在阅读中。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h1><p>从官方网站下载源码包（<a href="http://nginx.org/en/download.html)。" target="_blank" rel="noopener">http://nginx.org/en/download.html)。</a></p>
<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.*.tar.gz</span><br></pre></td></tr></table></figure>
<p>编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd nginx</span><br><span class="line">./config</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./config --help</span><br></pre></td></tr></table></figure>
<p>查看config包含的参数。</p>
<p>这里主要介绍几个参数：</p>
<h2 id="—prefix-PATH"><a href="#—prefix-PATH" class="headerlink" title="—prefix=PATH"></a>—prefix=PATH</h2><p>nginx安装部署后的根目录。默认在/usr/local/nginx目录。该目录影响其他目录的相对目录。</p>
<h2 id="—sbin-path-PATH"><a href="#—sbin-path-PATH" class="headerlink" title="—sbin-path=PATH"></a>—sbin-path=PATH</h2><p>该目录是可执行文件放置的目录。默认为\<prefix>/sbin/nginx。</prefix></p>
<h2 id="—conf-path-PATH"><a href="#—conf-path-PATH" class="headerlink" title="—conf-path=PATH"></a>—conf-path=PATH</h2><p>配置文件目录。默认为\<prefix>/conf/nginx.conf。执行时读取的默认配置。</prefix></p>
<h2 id="—error-log-path-PATH"><a href="#—error-log-path-PATH" class="headerlink" title="—error-log-path=PATH"></a>—error-log-path=PATH</h2><p>error日志的放置路径。默认为\<prefix>/log/error.log。可以打印不同等级的log日志，在nginx.conf中控制。</prefix></p>
<h2 id="—pid-path-PATH"><a href="#—pid-path-PATH" class="headerlink" title="—pid-path=PATH"></a>—pid-path=PATH</h2><p>pid文件存放路径。默认为\<prefix>/log/nginx.pid。该文件以ASCII码存放着nginx master的进程ID。</prefix></p>
<h1 id="nginx的命令行控制"><a href="#nginx的命令行控制" class="headerlink" title="nginx的命令行控制"></a>nginx的命令行控制</h1><h2 id="直接执行Nginx二进制文件"><a href="#直接执行Nginx二进制文件" class="headerlink" title="直接执行Nginx二进制文件"></a>直接执行Nginx二进制文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>读取默认配置文件</p>
<h2 id="指定配置文件"><a href="#指定配置文件" class="headerlink" title="指定配置文件"></a>指定配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -c 配置文件路径</span><br></pre></td></tr></table></figure>
<h2 id="另行指定全局配置项"><a href="#另行指定全局配置项" class="headerlink" title="另行指定全局配置项"></a>另行指定全局配置项</h2><p>-g</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -g &quot;pid /tem/test.pid;&quot;</span><br></pre></td></tr></table></figure>
<p>这时，pid文件将写到<code>/tem/test.pid</code>。-g的配置不能与nginx.conf不一致。</p>
<p>对于以-g启动的nginx来说，要执行其他操作，也应该包含-g参数，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -g &quot;pid /tem/test.pid;&quot; -s stop</span><br></pre></td></tr></table></figure>
<h2 id="测试配置信息是否错误"><a href="#测试配置信息是否错误" class="headerlink" title="测试配置信息是否错误"></a>测试配置信息是否错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure>
<h2 id="显示版本"><a href="#显示版本" class="headerlink" title="显示版本"></a>显示版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -v</span><br></pre></td></tr></table></figure>
<h2 id="显示编译阶段参数"><a href="#显示编译阶段参数" class="headerlink" title="显示编译阶段参数"></a>显示编译阶段参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>
<h2 id="快速停止服务"><a href="#快速停止服务" class="headerlink" title="快速停止服务"></a>快速停止服务</h2><p>-s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br></pre></td></tr></table></figure>
<p>-s参数是告诉Nginx向正在运行的服务发送信号。直接使用kill也是可以的。</p>
<h2 id="优雅的停止服务"><a href="#优雅的停止服务" class="headerlink" title="优雅的停止服务"></a>优雅的停止服务</h2><p>关闭监听端口，处理完当前所有请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s quit</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s SIGQIT masterpid</span><br></pre></td></tr></table></figure>
<p>停止某个worker进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s SIGQIT workerpid</span><br></pre></td></tr></table></figure>
<h1 id="Nginx的配置"><a href="#Nginx的配置" class="headerlink" title="Nginx的配置"></a>Nginx的配置</h1><p>部署Nginx是，都是使用一个master进程来管理多个worker进程，一般worker进程数量与服务器中的CPU核心数一致。</p>
<h2 id="配置demo"><a href="#配置demo" class="headerlink" title="配置demo"></a>配置demo</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> nobody;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_process</span> <span class="number">8</span>;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log <span class="literal">error</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#pid logs/nginx.pid</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">500000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">include</span> mime.types;</span><br><span class="line">  <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">    <span class="string">'<span class="variable">$status</span> <span class="variable">$bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">    <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line">  <span class="attribute">access_log</span> logs/access.log main buffer=<span class="number">32k</span>;</span><br><span class="line">   </span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="块配置"><a href="#块配置" class="headerlink" title="块配置"></a>块配置</h2><p>块配置项由一个块配置名和一对大括号组成。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    ...;</span><br><span class="line">    <span class="attribute">location</span> /webstatic &#123;</span><br><span class="line">      <span class="attribute">gzip</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的events、http、server、location、upstream都是块配置项，块配置项可以嵌套。</p>
<h2 id="配置项语法"><a href="#配置项语法" class="headerlink" title="配置项语法"></a>配置项语法</h2><p>基本的配置项语法为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置项名 配置项值1 配置项值2 ... ;</span><br></pre></td></tr></table></figure>
<p>配置项值可以是数字，字符串，正则表达式，这取决于该配置项名实际需求。（这个有点像是函数名和参数的关系）。</p>
<h2 id="配置项单位"><a href="#配置项单位" class="headerlink" title="配置项单位"></a>配置项单位</h2><p>指定大小时，可以使用的单位包括：</p>
<ol>
<li>K或者k字节（KiB）</li>
<li>M或者m字节（MiB）</li>
</ol>
<p>指定时间时，可以使用：</p>
<ol>
<li>ms（毫秒）</li>
<li>s（秒）</li>
<li>m（分钟）</li>
<li>h（小时）</li>
<li>d（天）</li>
<li>w（周）</li>
<li>M（月，30天）</li>
<li>y（年，365天）</li>
</ol>
<h2 id="配置中使用变量"><a href="#配置中使用变量" class="headerlink" title="配置中使用变量"></a>配置中使用变量</h2><p>部分模块可以使用变量，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format main &apos;$remote_addr [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">    &apos;$status $bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br></pre></td></tr></table></figure>
<p>变量前加上<code>$</code>。</p>
<h2 id="nginx提供的基础服务"><a href="#nginx提供的基础服务" class="headerlink" title="nginx提供的基础服务"></a>nginx提供的基础服务</h2><h3 id="用语调试和定位问题的配置"><a href="#用语调试和定位问题的配置" class="headerlink" title="用语调试和定位问题的配置"></a>用语调试和定位问题的配置</h3><h4 id="是否以守护进程来执行"><a href="#是否以守护进程来执行" class="headerlink" title="是否以守护进程来执行"></a>是否以守护进程来执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">daemon on|off</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">daemon on</span><br></pre></td></tr></table></figure>
<h4 id="是否以master-worker方式进行工作"><a href="#是否以master-worker方式进行工作" class="headerlink" title="是否以master/worker方式进行工作"></a>是否以master/worker方式进行工作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master_process on|off</span><br><span class="line"></span><br><span class="line">#deault</span><br><span class="line">master_process on</span><br></pre></td></tr></table></figure>
<h4 id="error日志设置"><a href="#error日志设置" class="headerlink" title="error日志设置"></a>error日志设置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_log /path/file level</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">error_log logs/error.log error</span><br></pre></td></tr></table></figure>
<p>当指定<code>/path/file</code>为<code>/dev/null</code>时即关闭日志。</p>
<p><code>level</code>为日志级别。取值为<code>debug</code> <code>info</code> <code>notice</code> <code>warn</code> <code>error</code> <code>crit</code> <code>alert</code> <code>emerg</code>。从左到右等级依次升高。指定的等级时，大于等于该等级的日志都会输出。</p>
<h4 id="设置特殊的调试点"><a href="#设置特殊的调试点" class="headerlink" title="设置特殊的调试点"></a>设置特殊的调试点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug_points [stop|abort]</span><br></pre></td></tr></table></figure>
<p>nginx在关键逻辑中设置了调试点。如果设置为stop，则nginx代码运行到这些调试点就会发出SIGSTOP信号以用于调试。如果设置为abort，则会产生一个coredump文件，可以使用gdb来查看。</p>
<h4 id="对指定客户端输出debug级别日志"><a href="#对指定客户端输出debug级别日志" class="headerlink" title="对指定客户端输出debug级别日志"></a>对指定客户端输出debug级别日志</h4><p>该配置属于事件类型配置，要放在events中才有效，起值可以是IP地址或者CIDR地址，如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">debug_connection</span> <span class="number">10.224.66.14</span>;</span><br><span class="line">  <span class="attribute">debug_connection</span> <span class="number">10.224.57.0</span>/<span class="number">24</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，只有配置的IP才会打印debug级别日志，其他请求仍然沿用error_log中配置的日志级别。</p>
<h4 id="限制coredump核心转储文件大小"><a href="#限制coredump核心转储文件大小" class="headerlink" title="限制coredump核心转储文件大小"></a>限制coredump核心转储文件大小</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_core size;</span><br></pre></td></tr></table></figure>
<h4 id="指定coredump文件生成目录"><a href="#指定coredump文件生成目录" class="headerlink" title="指定coredump文件生成目录"></a>指定coredump文件生成目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">working_directory path;</span><br></pre></td></tr></table></figure>
<h3 id="正常运行配置"><a href="#正常运行配置" class="headerlink" title="正常运行配置"></a>正常运行配置</h3><h4 id="定义环境变量"><a href="#定义环境变量" class="headerlink" title="定义环境变量"></a>定义环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env VAR|VAR=VALUE</span><br></pre></td></tr></table></figure>
<p>该配置可以让用户直接设置操作系统上的环境变量。仅是变更运行时使用的环境变量。</p>
<h4 id="嵌入其他配置"><a href="#嵌入其他配置" class="headerlink" title="嵌入其他配置"></a>嵌入其他配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /path/file</span><br></pre></td></tr></table></figure>
<p>将其他配置文件嵌入到当前配置中，参数可以是绝对路径，也可以是相对路径（相对于当前配置文件的目录）。路径可以是字符串和正则表达式。</p>
<h4 id="pid文件路径"><a href="#pid文件路径" class="headerlink" title="pid文件路径"></a>pid文件路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pid path/file</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">pid logs/nginx.pid</span><br></pre></td></tr></table></figure>
<p>master进程的pid</p>
<h4 id="nginx进程运行的用户及用户组"><a href="#nginx进程运行的用户及用户组" class="headerlink" title="nginx进程运行的用户及用户组"></a>nginx进程运行的用户及用户组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user username [groupname]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">user nobody nobody</span><br></pre></td></tr></table></figure>
<h4 id="worker进程最大句柄描述符个数"><a href="#worker进程最大句柄描述符个数" class="headerlink" title="worker进程最大句柄描述符个数"></a>worker进程最大句柄描述符个数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile limit;</span><br></pre></td></tr></table></figure>
<h4 id="限制信号队列"><a href="#限制信号队列" class="headerlink" title="限制信号队列"></a>限制信号队列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_sigpending limit;</span><br></pre></td></tr></table></figure>
<p>设置每个用户发往nginx的信号队列大小，当超过该值时，该用户发送的信号将被丢弃。</p>
<h3 id="性能优化配置"><a href="#性能优化配置" class="headerlink" title="性能优化配置"></a>性能优化配置</h3><h4 id="nginx的worker进程数"><a href="#nginx的worker进程数" class="headerlink" title="nginx的worker进程数"></a>nginx的worker进程数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_processes number;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">worker_processes 1;</span><br></pre></td></tr></table></figure>
<h4 id="绑定nginx的worker进程到指定的CPU内核"><a href="#绑定nginx的worker进程到指定的CPU内核" class="headerlink" title="绑定nginx的worker进程到指定的CPU内核"></a>绑定nginx的worker进程到指定的CPU内核</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity cpumask [cpumask, ...]</span><br></pre></td></tr></table></figure>
<p>避免多个worker进程抢占同一个cpu，设置每个进程绑定的cpu内核来加速。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  8;</span><br><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span><br></pre></td></tr></table></figure>
<h3 id="事件类配置-都在event块中"><a href="#事件类配置-都在event块中" class="headerlink" title="事件类配置(都在event块中)"></a>事件类配置(都在event块中)</h3><h4 id="是否打开负载均衡锁"><a href="#是否打开负载均衡锁" class="headerlink" title="是否打开负载均衡锁"></a>是否打开负载均衡锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex [on|off]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">accept_mutex on;</span><br></pre></td></tr></table></figure>
<p>Accept_mutex是nginx的负载均衡锁。该锁来让各个worker进程直接负载均衡。关闭该锁可以加快TCP连接速度，但会导致负载不均衡。</p>
<h4 id="lock文件路径"><a href="#lock文件路径" class="headerlink" title="lock文件路径"></a>lock文件路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lock_file path/file;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">lock_file logs/nginx.lock;</span><br></pre></td></tr></table></figure>
<p>存储负载均衡锁所需文件路径。</p>
<h4 id="使用accept锁后未建立连接后等待时间"><a href="#使用accept锁后未建立连接后等待时间" class="headerlink" title="使用accept锁后未建立连接后等待时间"></a>使用accept锁后未建立连接后等待时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex_delay Nms;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">accept_mutex_delay 500ms;</span><br></pre></td></tr></table></figure>
<p>使用accept锁后，每个时刻，只能有一个worker进程能够获取accept锁。该accept不是阻塞锁，没有获取就会立即返回。如果一个worker进程尝试获取accept锁没有获得时，至少要等到accept_mutex_delay时间才能再次获取。</p>
<h4 id="批量建立新连接"><a href="#批量建立新连接" class="headerlink" title="批量建立新连接"></a>批量建立新连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">multi_accept [on|off];</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">multi_accept off;</span><br></pre></td></tr></table></figure>
<p>当事件模型通知有新连接时，尽可能地对本次调度中客户端发起的所有TCP请求都建立连接。</p>
<h4 id="选择事件模型"><a href="#选择事件模型" class="headerlink" title="选择事件模型"></a>选择事件模型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use [kqueue|rtsig|epoll|/dev/poll|select|poll|eventport]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">use 最适合的（nginx自己寻找）。</span><br></pre></td></tr></table></figure>
<h4 id="每个master的最大连接数"><a href="#每个master的最大连接数" class="headerlink" title="每个master的最大连接数"></a>每个master的最大连接数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_connections number;</span><br></pre></td></tr></table></figure>
<h2 id="虚拟主机与请求的分发"><a href="#虚拟主机与请求的分发" class="headerlink" title="虚拟主机与请求的分发"></a>虚拟主机与请求的分发</h2><p>由于IP地址限制，存在多个主机域名对应同一IP地址的情况，这时在nginx.conf中按照server_name(对应用户请求中的主机域名）并通过server块来定义虚拟机，每个server块就是一个虚拟机，它只处理与之相对应的主机域名请求。这样，一台服务器上的nginx就能够以不同方式处理访问不同主机域名的HTTP的请求了。</p>
<h3 id="监听端口"><a href="#监听端口" class="headerlink" title="监听端口"></a>监听端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen address:port [default(deprecated in 0.8.21) | default_server | [backlog=num | rcvbuf=size | sndbuf=size | accept_filter=filter | deferred | bind | ipv6only=[on|off] ssl]];</span><br><span class="line"></span><br><span class="line">#default </span><br><span class="line">listion 80;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>listen决定nginx服务监听端口。listen后可以加IP地址、端口号或者主机名。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen 127.0.0.1:8002;</span><br><span class="line">listen 127.0.0.1; //default port 80</span><br><span class="line">listen *:8000;</span><br></pre></td></tr></table></figure>
<p>地址后可以加其他参数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>将所在server块作为整个web服务的默认server块。当一个请求无法匹配配置文件中的所有主机域名时，就会选择默认虚拟主机。如果所有server都未指定，则默认选第一个。</td>
</tr>
<tr>
<td>backlog=num</td>
<td>TCP中backlog大小。（默认-1，无限制）在TCP建立三次连接时，进程还未监听句柄，此时backlog队列将会放置这些连接。如果backlog已满，还有客户端企图建立连接，则会失败。</td>
</tr>
<tr>
<td>rcvbuf=size</td>
<td>设置监听句柄的SO_RCVBUF参数。</td>
</tr>
<tr>
<td>sndbuf=size</td>
<td>设置监听句柄的SO_SNDBUF参数。</td>
</tr>
<tr>
<td>Accept_filter</td>
<td>设置accept过滤，只对FreeBSD系统有用。</td>
</tr>
<tr>
<td>deferred</td>
<td>设置该参数时，若用户建立了TCP连接（三次握手），内核也不会对该连接调度worker进程来处理，只会在用户真正发送请求时才会分配worker进程。使用于大并发情况下。</td>
</tr>
<tr>
<td>bind</td>
<td>绑定当前端口/地址对，如127.0.0.1:8000。</td>
</tr>
<tr>
<td>ssl</td>
<td>在当前监听的端口上建立的连接必须基于SSL。</td>
</tr>
</tbody>
</table>
</div>
<h3 id="主机名称"><a href="#主机名称" class="headerlink" title="主机名称"></a>主机名称</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_name name [...];</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">server_name &quot;&quot;;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>Server_name后面可以有多个主机名称，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name www.testweb.com download.testweb.com</span><br></pre></td></tr></table></figure>
<p>在开始处理一个HTTP请求时，nginx会取出header头中的Host，与每个server中的server_name进行比对，以决定由哪个server块来处理该请求。server_name与Host匹配优先级为：</p>
<ol>
<li>最先选择完全匹配的</li>
<li>其次选择通配符在前面的，如*.testweb.com</li>
<li>再次选择通配符在后面的，如www.testweb.*</li>
<li>最后选择使用正则表达式的，如~^\.testweb.com$</li>
</ol>
<p>Server_name后面是空字符串时，表示匹配没有这个host这个http头的请求。</p>
<h3 id="server-name-hash-bucket-size"><a href="#server-name-hash-bucket-size" class="headerlink" title="server_name_hash_bucket_size"></a>server_name_hash_bucket_size</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_name_hash_bucket_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">server_name_hash_bucket_size 32|64|128;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http server location</span><br></pre></td></tr></table></figure>
<p>为快速寻找对应server_name能力，nginx使用散列来存储server name。server_name_hash_bucket_size设置每个散列桶占用内存大小。</p>
<h3 id="重定向主机名称处理"><a href="#重定向主机名称处理" class="headerlink" title="重定向主机名称处理"></a>重定向主机名称处理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_name_in_redirect on|off;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">server_name_in_redirect on|off;</span><br><span class="line"></span><br><span class="line"># conf block</span><br><span class="line">http server location</span><br></pre></td></tr></table></figure>
<p>该配置配合server_name使用。在打开on时，表示重定向请求时会使用server_name的配置的第一个主机名代替原先请求的Host，使用off时，表示重定向时使用请求本身的Host。</p>
<h3 id="location"><a href="#location" class="headerlink" title="location"></a>location</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location [=|~|~*|^~|@] /uri/ &#123;...&#125;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>location尝试根据用户请求中的URI来匹配上面的/uri表达式，如果可以匹配，就选择location块中的请求来处理。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>把URI作为字符串，与参数的uri做完全匹配</td>
<td>Location = / {}</td>
</tr>
<tr>
<td><code>~</code></td>
<td>匹配URI时是大小写敏感的</td>
<td></td>
</tr>
<tr>
<td><code>~*</code></td>
<td>忽略大小写</td>
<td></td>
</tr>
<tr>
<td><code>^~</code></td>
<td>匹配前半部分uri即可。</td>
<td></td>
</tr>
<tr>
<td><code>@</code></td>
<td>表示仅用于nginx服务内部请求之间的重定向，带有@的请求不直接处理用户请求。</td>
</tr>
</tbody>
</table>
</div>
<p>最常用的是uri为正则表达式。</p>
<h2 id="文件路径的定义"><a href="#文件路径的定义" class="headerlink" title="文件路径的定义"></a>文件路径的定义</h2><h3 id="以root方式设置资源路径"><a href="#以root方式设置资源路径" class="headerlink" title="以root方式设置资源路径"></a>以root方式设置资源路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root path</span><br><span class="line"></span><br><span class="line"># default</span><br><span class="line">root html</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http, server, location, if</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /download/ &#123;</span><br><span class="line">  <span class="attribute">root</span> /opt/web/html/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于上面的配置，如果有一个请求的URI是/download/index/test.html，那么web服务器返回服务器上/opt/web/html/download/index/test.html文件的内容。</p>
<h3 id="alias方式设置资源路径"><a href="#alias方式设置资源路径" class="headerlink" title="alias方式设置资源路径"></a>alias方式设置资源路径</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alias path;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">location</span><br></pre></td></tr></table></figure>
<p>alias也是用来设置文件资源路径，与root不同点主要在于如何解读跟在location后面的uri参数，这使得alias与root以不同的方式将用户请求映射到真正的磁盘文件上。例如，如果一个请求的URI是/conf/nginx.conf，而用户实际希望访问的文件在/usr/location/nginx/conf/nginx.conf。中，如果想要使用alias来进行设置的话，可以采用如下形式：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /conf &#123;</span><br><span class="line">  <span class="attribute">alias</span> /usr/local/nginx/conf/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用root，则语句如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /conf &#123;</span><br><span class="line">  <span class="attribute">root</span> /usr/location/nginx/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用alias时，在URI向实际路径的映射过程中，已经将location后配置的/conf部分去除了，因此/conf/nginx.conf请求将根据alias path映射为path/nginx.conf。root则会根据完整的URI请求来映射，因此root会根据root path映射为path/conf/nginx.conf。</p>
<p>alias后面还可以添加正则表达式，例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> ~^/test/(\w+)\.(w+)$ &#123;</span><br><span class="line">  <span class="attribute">alias</span> /usr/location/nginx/<span class="variable">$2</span>/<span class="variable">$1</span>.<span class="variable">$2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="访问首页"><a href="#访问首页" class="headerlink" title="访问首页"></a>访问首页</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index file</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">index index.html</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http, server, location</span><br></pre></td></tr></table></figure>
<p>有时，访问站点的URI为/，这一般是网页站点，这与root和alias都不同，使用nginx_http_index_module模块提供的index配置实现。index后面可以更多个文件参数，nginx会按顺序访问这些文件，例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">root</span> path;</span><br><span class="line">  <span class="attribute">index</span> index.html, /html/index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="根据http返回码重定向页面"><a href="#根据http返回码重定向页面" class="headerlink" title="根据http返回码重定向页面"></a>根据http返回码重定向页面</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_page code[code...][=|=answer-code] uri | @named_location</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location,if</span><br></pre></td></tr></table></figure>
<p>对于某个请求返回错误码时，如果匹配上了error_page中设置的code，则重定向到新的URI中，例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span>  /<span class="number">404</span>.html</span><br><span class="line">error_page <span class="number">502</span> <span class="number">504</span> <span class="number">504</span> /50x.html</span><br><span class="line">error_page <span class="number">403</span> http://example.com/forbidden.html</span><br><span class="line">error_page <span class="number">404</span> = <span class="variable">@fetch</span></span><br></pre></td></tr></table></figure>
<p>注意，虽然重定向了URI，但返回的HTTP错误码还是原来的错误码。可以通过’=’来更改返回的错误码，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error_page 404 = 200  /empty.html;</span><br><span class="line">error_page 404 = 403  /forbidden.gif;</span><br></pre></td></tr></table></figure>
<p>也可以不指定确切的错误码，而是由重定向后时间处理的真实结果来决定，这时只要把=后面的错误码去掉即可，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page 404  /empty.html;</span><br></pre></td></tr></table></figure>
<p>如果不想修改URI，只是想让请求重定向到另一个location中进行处理，那么可以设置为：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">404</span> <span class="variable">@fallback</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="variable">@fallback</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，出现404错误时，请求转发到反向代理<a href="http://backend服务上。" target="_blank" rel="noopener">http://backend服务上。</a></p>
<h3 id="是否允许递归使用error-page"><a href="#是否允许递归使用error-page" class="headerlink" title="是否允许递归使用error_page"></a>是否允许递归使用error_page</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">recursive_error_pages [on|off];</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">recursive_error_pages off;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<h3 id="try-file"><a href="#try-file" class="headerlink" title="try_file"></a>try_file</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">try_file path1[path2] uri;</span><br><span class="line"></span><br><span class="line">#conf bloak</span><br><span class="line">server,location</span><br></pre></td></tr></table></figure>
<p>try_file后跟若果路径，如path1，path2…，最后必须要有uri参数，意义为：尝试顺序访问每一个path，如果可以有效获取，就直接向用户返回对于的文件请求，并结束，否则接着向下访问，如果所有path都找不到，则重定向到最后的uri上。例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">try_file</span> /sys/main.html <span class="variable">$uri</span> <span class="variable">$uri</span>/index/html <span class="variable">$uri</span>.html <span class="variable">@other</span>;</span><br><span class="line"><span class="attribute">location</span> <span class="variable">@other</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>一个网页，要访问服务器上3个页面，为路径$path下的index.html,master.html和slave.html，其中index.html是首页，其请求的uri为/。后面两个文件是index.html返回后，请求的两个页面，请求的uri分别为/showmaster/和/showslave/。此时，nginx配置可设置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">error_log /home/work/error.log debug;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    log_format main &apos;&quot;$request&quot;&apos;;</span><br><span class="line">    access_log /home/work/debug.log main;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8894;</span><br><span class="line">        location ~* ^/show([a-z]+)\/$ &#123;</span><br><span class="line">           root path/$1.html;</span><br><span class="line">        &#125;</span><br><span class="line">       location / &#123;</span><br><span class="line">           root path;</span><br><span class="line">           index index.html;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内存及磁盘资源的分配"><a href="#内存及磁盘资源的分配" class="headerlink" title="内存及磁盘资源的分配"></a>内存及磁盘资源的分配</h2><h3 id="HTTP包体只存储在磁盘文件中"><a href="#HTTP包体只存储在磁盘文件中" class="headerlink" title="HTTP包体只存储在磁盘文件中"></a>HTTP包体只存储在磁盘文件中</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_in_file_only on | clean | off</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_in_file_only off</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>当设置为非off时，用户请求的HTTP包体一律存储到磁盘文件中，即使只有0字节也会存储为文件。当配置结束时，如果设置为on，则该文件不会被删除（常用于调试），如果配置为clean，则会在请求结束，清除文件。</p>
<h3 id="HTTP包体尽量写到一个内存buffer中"><a href="#HTTP包体尽量写到一个内存buffer中" class="headerlink" title="HTTP包体尽量写到一个内存buffer中"></a>HTTP包体尽量写到一个内存buffer中</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_in_single_buffer on | off</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_in_single_buffer off</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>配置on时，HTTP包体一律存储到内存buffer。如果大小超过了client_body_buffer_size值，包体依然会写入磁盘。</p>
<h3 id="存储HTTP请求头部的内存大小"><a href="#存储HTTP请求头部的内存大小" class="headerlink" title="存储HTTP请求头部的内存大小"></a>存储HTTP请求头部的内存大小</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_header_buffer_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_header_buffer_size 1k</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>该配置定义了正常情况下Nginx接收用户请求中HTTP header部分（包括HTTP行和HTTP头部）分配的内存buffer大小。当HTTP header部分超过该值时，定义的buffer大小将失效。</p>
<h3 id="存储超大HTTP头部的内存buffer大小"><a href="#存储超大HTTP头部的内存buffer大小" class="headerlink" title="存储超大HTTP头部的内存buffer大小"></a>存储超大HTTP头部的内存buffer大小</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lager_client_header_buffer number size;</span><br><span class="line"></span><br><span class="line">#defult</span><br><span class="line">lager_client_header_buffer 4 8k;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>订阅了Nginx接收一个超大HTTP头部请求的buffer个数和每个buffer大小。如果请求行（如GET /index HTTP/1.1）大小超过上面单个大小限制时，返回Request URI too large（414）。请求中有很多header，每个header的大小也不能超过单个buffer大小，否则会返回Bad request（400）。请求行和请求头总数也不能超过buffer个数*buffer大小。</p>
<h3 id="存储HTTP包体的内存buffer大小"><a href="#存储HTTP包体的内存buffer大小" class="headerlink" title="存储HTTP包体的内存buffer大小"></a>存储HTTP包体的内存buffer大小</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_buffer_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_buffer_size 8k/16k;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>定义了Nginx接收http请求包体的内存缓冲区大小。即HTTP包体会先接收到指定的缓存中，再决定是否写入磁盘。</p>
<h3 id="HTTP包体临时存放目录"><a href="#HTTP包体临时存放目录" class="headerlink" title="HTTP包体临时存放目录"></a>HTTP包体临时存放目录</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_temp_path dir-path [level1 [level2 [level3]]]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_temp_path client_body_temp</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>配置包体存放的临时目录。包体大小超过client_body_buffer_size指定大小时，会以递增的整数命名并存放到client_body_temp_path指定目录。后面的level1，level2，level3是防止一个目录文件过多，影响性能，使用level参数，可以按文件临时名再多加3层目录。</p>
<h3 id="connection-pool-size"><a href="#connection-pool-size" class="headerlink" title="connection_pool_size"></a>connection_pool_size</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connection_pool_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">connection_pool_size 256;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>Nginx对每一个建立的成功的TCP连接会预先分配一个内存池，这里size指定内存池初始大小，用于减少对小块内存的分配次数。过大的size导致内存资源浪费，过小的size，导致重复分配次数增加，影响性能，谨慎设置。</p>
<h3 id="request-pool-size"><a href="#request-pool-size" class="headerlink" title="request_pool_size"></a>request_pool_size</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">request_pool_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">request_pool_size 4k</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>Nginx开始处理HTTP请求时，会为每个请求都分配一个内存池。这里size指定内存池初始大小，用于减少对小块内存的分配次数。TCP连接关闭时会销毁connection_pool_size指定的内存池，HTTP请求结束会销毁request_pool_size指定的内存池，但其创建和销毁时间并不一致，因为一个TCP连接可能被复用于多个HTTP请求。</p>
<h2 id="网络连接设置"><a href="#网络连接设置" class="headerlink" title="网络连接设置"></a>网络连接设置</h2><h3 id="读取HTTP头部超时时间"><a href="#读取HTTP头部超时时间" class="headerlink" title="读取HTTP头部超时时间"></a>读取HTTP头部超时时间</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_header_timeout time(s)</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_header_timeout 60;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http，server，location</span><br></pre></td></tr></table></figure>
<p>客户端与服务器建立TCP连接后将开始接收HTTP头部，在这个过程中，如果在一个时间间隔内没有读取到客户端发来的字节，则认为超时，向客户端返回408（Request timed out）响应。</p>
<h3 id="读取HTTP包体超时时间"><a href="#读取HTTP包体超时时间" class="headerlink" title="读取HTTP包体超时时间"></a>读取HTTP包体超时时间</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_timeout time(s);</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_timeout 60;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>与client_header_timeout类似，不过使用在读取http包体。</p>
<h3 id="发送响应超时时间"><a href="#发送响应超时时间" class="headerlink" title="发送响应超时时间"></a>发送响应超时时间</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">send_timeout time;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">send_timeout 60;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>Nginx向客户端发送数据包，客户端一直没有接收数据包，超过超时响应时间后，Nginx关闭连接。</p>
<p>还有很多网络连接配置，看书。</p>
<h2 id="client-body-in-file-only"><a href="#client-body-in-file-only" class="headerlink" title="client_body_in_file_only"></a>client_body_in_file_only</h2><p>此指令禁用NGINX缓冲区并将请求体存储在临时文件中。 文件包含纯文本数据。 该指令在NGINX配置的http，server和location区块使用。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_body_in_file_only off|on|clean</span><br><span class="line"></span><br><span class="line">default</span><br><span class="line">off</span><br></pre></td></tr></table></figure>
<p>不同值含义如下：</p>
<ol>
<li>off 该值将禁用文件写入</li>
<li>clean:请求body将被写入文件。 该文件将在处理请求后删除。</li>
<li>on:请求正文将被写入文件。 处理请求后，将不会删除该文件。</li>
</ol>
<h2 id="client-body-in-single-buffer"><a href="#client-body-in-single-buffer" class="headerlink" title="client_body_in_single_buffer"></a>client_body_in_single_buffer</h2><p>该指令设置NGINX将完整的请求主体存储在单个缓冲区中。 默认情况下，指令值为off。如果启用，它将优化读取$request_body变量时涉及的I/O操作。</p>
<h2 id="长连接"><a href="#长连接" class="headerlink" title="长连接"></a>长连接</h2><p>http为了避免每次都需要进行连接的三次握手和四次挥手，支持连接的复用，报错连接为长连接。nginx也支持该功能。对应的配置包括。</p>
<h3 id="keepalive-requests"><a href="#keepalive-requests" class="headerlink" title="keepalive_requests"></a>keepalive_requests</h3><p>长连接最多接收的请求数量。语法为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	keepalive_requests number;</span><br><span class="line">Default:	</span><br><span class="line">keepalive_requests <span class="number">1000</span>;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<h3 id="keepalive-timeout"><a href="#keepalive-timeout" class="headerlink" title="keepalive_timeout"></a>keepalive_timeout</h3><p>对于保持长连接的请求来说，如果指定事件未收到请求，则关闭连接。配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	keepalive_timeout timeout [header_timeout];</span><br><span class="line">Default:	</span><br><span class="line">keepalive_timeout 75s;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<p>如果配置的事件为0，则表示不支持长连接。可选的第二个参数在响应的header域中设置一个值“Keep-Alive: timeout=time”。这两个参数可以不一样。</p>
<p>除了长连接以外，还有一个特性为pipeline。</p>
<p>在http1.1中，引入了一种新的特性，即pipeline。那么什么是pipeline呢？pipeline其实就是流水线作业，它可以看作为keepalive的一种升华，因为pipeline也是基于长连接的，目的就是利用一个连接做多次请求。如果客户端要提交多个请求，对于keepalive来说，那么第二个请求，必须要等到第一个请求的响应接收完全后，才能发起，这和TCP的停止等待协议是一样的，得到两个响应的时间至少为2<em>RTT。而对pipeline来说，客户端不必等到第一个请求处理完后，就可以马上发起第二个请求。得到两个响应的时间可能能够达到1</em>RTT。nginx是直接支持pipeline的，但是，nginx对pipeline中的多个请求的处理却不是并行的，依然是一个请求接一个请求的处理，只是在处理第一个请求的时候，客户端就可以发起第二个请求。这样，nginx利用pipeline减少了处理完一个请求后，等待第二个请求的请求头数据的时间。其实nginx的做法很简单，前面说到，nginx在读取数据时，会将读取的数据放到一个buffer里面，所以，如果nginx在处理完前一个请求后，如果发现buffer里面还有数据，就认为剩下的数据是下一个请求的开始，然后就接下来处理下一个请求，否则就设置keepalive。</p>
<h2 id="tcp-nopush-tcp-nodelay"><a href="#tcp-nopush-tcp-nodelay" class="headerlink" title="tcp_nopush/tcp_nodelay"></a>tcp_nopush/tcp_nodelay</h2><p>对于tcp连接来说，缓存中数据发送方式会对传输存在一定的影响。</p>
<p>如果是缓存中有数据就立即发出，将导致负载过高的问题。例如可能传输的数据只有一个字节，但tcp头本身就有40字节长度，效率过低。因此当前tcp默认传输方式是使用Nagle算法，TCP堆栈实现了等待数据 0.2秒钟，因此操作后它不会发送一个数据包，而是将这段时间内的数据打成一个大的包。</p>
<p>但等待0.2秒不一定适合所有场景，因此有了tcp_nopush和tcp_nodelay方式，这些都是套接字属性，通过<code>setsockopt</code>系统调用设置套接字属性即可。</p>
<p>在 nginx 中，tcp_nopush 配置和 tcp_nodelay “互斥”。它可以配置一次发送数据的包大小。也就是说，它不是按时间累计 0.2 秒后发送包，而是当包累计到一定大小后就发送。在 nginx 中，tcp_nopush 必须和 sendfile 搭配使用。</p>
<p>tcp_nodelay表示不使用等待，立即发送。</p>
<p>默认配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp_nopush : on;</span><br></pre></td></tr></table></figure>
<p>配置块在http、server、location中。</p>
<h2 id="延迟关闭（lingering-close）"><a href="#延迟关闭（lingering-close）" class="headerlink" title="延迟关闭（lingering_close）"></a>延迟关闭（lingering_close）</h2><p>lingering_close，字面意思就是延迟关闭，也就是说，当nginx要关闭连接时，并非立即关闭连接，而是先关闭tcp连接的写，再等待一段时间后再关掉连接的读。为什么要这样呢？我们先来看看这样一个场景。nginx在接收客户端的请求时，可能由于客户端或服务端出错了，要立即响应错误信息给客户端，而nginx在响应错误信息后，大分部情况下是需要关闭当前连接。nginx执行完write()系统调用把错误信息发送给客户端，write()系统调用返回成功并不表示数据已经发送到客户端，有可能还在tcp连接的write buffer里。接着如果直接执行close()系统调用关闭tcp连接，内核会首先检查tcp的read buffer里有没有客户端发送过来的数据留在内核态没有被用户态进程读取，如果有则发送给客户端RST报文来关闭tcp连接丢弃write buffer里的数据，如果没有则等待write buffer里的数据发送完毕，然后再经过正常的4次分手报文断开连接。所以,当在某些场景下出现tcp write buffer里的数据在write()系统调用之后到close()系统调用执行之前没有发送完毕，且tcp read buffer里面还有数据没有读，close()系统调用会导致客户端收到RST报文且不会拿到服务端发送过来的错误信息数据。那客户端肯定会想，这服务器好霸道，动不动就reset我的连接，连个错误信息都没有。</p>
<p>在上面这个场景中，我们可以看到，关键点是服务端给客户端发送了RST包，导致自己发送的数据在客户端忽略掉了。所以，解决问题的重点是，让服务端别发RST包。再想想，我们发送RST是因为我们关掉了连接，关掉连接是因为我们不想再处理此连接了，也不会有任何数据产生了。对于全双工的TCP连接来说，我们只需要关掉写就行了，读可以继续进行，我们只需要丢掉读到的任何数据就行了，这样的话，当我们关掉连接后，客户端再发过来的数据，就不会再收到RST了。当然最终我们还是需要关掉这个读端的，所以我们会设置一个超时时间，在这个时间过后，就关掉读，客户端再发送数据来就不管了，作为服务端我会认为，都这么长时间了，发给你的错误信息也应该读到了，再慢就不关我事了，要怪就怪你RP不好了。当然，正常的客户端，在读取到数据后，会关掉连接，此时服务端就会在超时时间内关掉读端。这些正是lingering_close所做的事情。协议栈提供 SO_LINGER 这个选项，它的一种配置情况就是来处理lingering_close的情况的，不过nginx是自己实现的lingering_close。lingering_close存在的意义就是来读取剩下的客户端发来的数据，所以nginx会有一个读超时时间，通过lingering_timeout选项来设置，如果在lingering_timeout时间内还没有收到数据，则直接关掉连接。nginx还支持设置一个总的读取时间，通过lingering_time来设置，这个时间也就是nginx在关闭写之后，保留socket的时间，客户端需要在这个时间内发送完所有的数据，否则nginx在这个时间过后，会直接关掉连接。</p>
<h3 id="lingering-close"><a href="#lingering-close" class="headerlink" title="lingering_close"></a>lingering_close</h3><p>设置是否需要延迟关闭。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	lingering_close off | on | always;</span><br><span class="line">Default:	</span><br><span class="line">lingering_close on;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<p>默认值“on”指示 nginx 在完全关闭连接之前等待并处理来自客户端的额外数据，但前提是启发式表明客户端可能正在发送更多数据。</p>
<p>值“always”将导致 nginx 无条件等待和处理额外的客户端数据。</p>
<p>值“off”告诉nginx永远不要等待更多数据并立即关闭连接。 这种行为违反了协议，不应在正常情况下使用。</p>
<h3 id="lingering-time"><a href="#lingering-time" class="headerlink" title="lingering_time"></a>lingering_time</h3><p>设置总的延迟时间。当 lingering_close 生效时，该指令指定 nginx 处理（读取和忽略）来自客户端的附加数据的最长时间。 之后，即使会有更多数据，连接也会关闭。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	lingering_time time;</span><br><span class="line">Default:	</span><br><span class="line">lingering_time 30s;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<h3 id="lingering-timeout"><a href="#lingering-timeout" class="headerlink" title="lingering_timeout"></a>lingering_timeout</h3><p>当 lingering_close 生效时，该指令指定更多客户端数据到达的最大等待时间。 如果在此期间未收到数据，则关闭连接。 否则，数据被读取并忽略，nginx再次开始等待更多数据。 重复“等待-读取-忽略”循环，但不会超过 lingering_time 指令指定的时间。</p>
<p>语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	lingering_timeout time;</span><br><span class="line">Default:	</span><br><span class="line">lingering_timeout 5s;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<h2 id="加速close"><a href="#加速close" class="headerlink" title="加速close"></a>加速close</h2><p>在某个请求超时时，nginx会主动关闭该请求，这时会主动调用close函数来关闭套接字，但主动关闭套接字会导致套接字处于TIME_WAIT状态，这将导致大量的超时连接无法被立即释放，造成大量浪费。</p>
<p>tcp通过了<code>SO_LINGER</code>选项来设置关闭方式。其中参数为<code>linger</code>结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linger</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">int</span> l_onoff;		<span class="comment">/* Nonzero to linger on close.  */</span></span><br><span class="line">    <span class="keyword">int</span> l_linger;		<span class="comment">/* Time to linger.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>当<code>l_onoff</code>为正数，<code>l_linger</code>为0时，会立即在执行close时，立即向客户端发送<code>RST</code>报文，立即关闭连接，并释放此套接字占用的所有内存。</p>
<p>nginx中使用<code>reset_timedout_connection</code>配置来支持该功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	reset_timedout_connection on | off;</span><br><span class="line">Default:	</span><br><span class="line">reset_timedout_connection off;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<p>当配置为<code>on</code>时，会快速关闭。</p>
<h1 id="Nginx常用数据结构"><a href="#Nginx常用数据结构" class="headerlink" title="Nginx常用数据结构"></a>Nginx常用数据结构</h1><h2 id="ngx-buf-t"><a href="#ngx-buf-t" class="headerlink" title="ngx_buf_t"></a>ngx_buf_t</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_buf_s</span>  <span class="title">ngx_buf_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_buf_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// pos通常表示从该位置处理内存中的数据</span></span><br><span class="line">    u_char          *pos;</span><br><span class="line">    <span class="comment">// last表示有效内容的结尾。ps到last的内存是nginx需要处理的内容</span></span><br><span class="line">    u_char          *last;</span><br><span class="line">    <span class="comment">// 处理文件时，file_post与file_last和处理内存时的pos与last相同</span></span><br><span class="line">    <span class="keyword">off_t</span>            file_pos;</span><br><span class="line">    <span class="keyword">off_t</span>            file_last;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果ngx_buf_t缓冲区用于内存，那么start指向这段内存的起始地址</span></span><br><span class="line">    u_char          *start;         <span class="comment">/* start of buffer */</span></span><br><span class="line">    <span class="comment">// 如果ngx_buf_t缓冲区用于内存，那么start指向这段内存的结束地址</span></span><br><span class="line">    u_char          *end;           <span class="comment">/* end of buffer */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 表示当前缓冲区类型，例如由哪个模块使用，就执行该模块的ngx_module_t变量的地址</span></span><br><span class="line">    <span class="keyword">ngx_buf_tag_t</span>    tag;</span><br><span class="line">    <span class="comment">// 引用的文件</span></span><br><span class="line">    <span class="keyword">ngx_file_t</span>      *file;</span><br><span class="line">    <span class="comment">// 当前缓冲区的影子缓冲区，使用较少。</span></span><br><span class="line">    <span class="keyword">ngx_buf_t</span>       *shadow;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the buf's content could be changed */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         temporary:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the buf's content is in a memory cache or in a read only memory</span></span><br><span class="line"><span class="comment">     * and must not be changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         memory:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the buf's content is mmap()ed and must not be changed */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         mmap:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否可回收</span></span><br><span class="line">    <span class="keyword">unsigned</span>         recycled:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 处理的是否为文件</span></span><br><span class="line">    <span class="keyword">unsigned</span>         in_file:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否需要flush</span></span><br><span class="line">    <span class="keyword">unsigned</span>         flush:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否使用同步方式，需谨慎考虑，可能会阻塞nginx。sync为1时可能会以阻塞的方式进行I/O</span></span><br><span class="line">    <span class="keyword">unsigned</span>         sync:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否为最后一个缓冲区。因为ngx_buf_t可以由ngx_chain_t链表串联起来。</span></span><br><span class="line">    <span class="keyword">unsigned</span>         last_buf:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否为ngx_chain_t中最后一个缓冲区</span></span><br><span class="line">    <span class="keyword">unsigned</span>         last_in_chain:<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省份为最后一个影子缓冲区，与shadow配合使用</span></span><br><span class="line">    <span class="keyword">unsigned</span>         last_shadow:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 当前缓冲区是否为临时文件</span></span><br><span class="line">    <span class="keyword">unsigned</span>         temp_file:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* STUB */</span> <span class="keyword">int</span>   num;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ngx_buf_t为缓存区结构。</p>
<h2 id="ngx-chain-s"><a href="#ngx-chain-s" class="headerlink" title="ngx_chain_s"></a>ngx_chain_s</h2><p>该结构为配合<code>ngx_buf_t</code>使用的链表，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_chain_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_buf_t</span>    *buf;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>  *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-list-t"><a href="#ngx-list-t" class="headerlink" title="ngx_list_t"></a>ngx_list_t</h2><p><code>ngx_list_t</code>为nginx封装的链表容器，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_list_part_s</span>  <span class="title">ngx_list_part_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_list_part_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>             *elts; <span class="comment">// 数组元素的起始地址</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        nelts; <span class="comment">// 当前已经使用的元素数量</span></span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>  *next; <span class="comment">// 下一个链表元素地址</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>  *last; <span class="comment">// 指向链表中最后一个元素的地址</span></span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>   part; <span class="comment">// 链表的首个数组元素</span></span><br><span class="line">    <span class="keyword">size_t</span>            size; <span class="comment">// 每个ngx_list_part_s中的元素大小</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        nalloc; <span class="comment">// 每个ngx_list_part_s可以容纳的元素数量</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *pool; <span class="comment">// 链表中管理内存分配的内存池</span></span><br><span class="line">&#125; <span class="keyword">ngx_list_t</span>;</span><br></pre></td></tr></table></figure>
<p><code>ngx_list_t</code>描述整个链表，<code>ngx_list_part_s</code>，描述每个链表的元素。每个链表的元素<code>ngx_list_part_s</code>是一个数组，拥有连续的内存，依赖<code>ngx_list_t</code>的size和nalloc来表示数组容量，又依赖每个<code>ngx_list_part_s</code>成员的nelts来表示已经使用的容量。</p>
<p><a href="https://imgtu.com/i/IPik9I" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/11/01/IPik9I.png" alt="IPik9I.png"></a></p>
<h3 id="初始化链表ngx-list-init"><a href="#初始化链表ngx-list-init" class="headerlink" title="初始化链表ngx_list_init"></a>初始化链表ngx_list_init</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static ngx_inline ngx_int_t</span><br><span class="line">ngx_list_init(ngx_list_t *list, ngx_pool_t *pool, ngx_uint_t n, size_t size)</span><br><span class="line">&#123;</span><br><span class="line">    // 为第一个元素分配指定的空间</span><br><span class="line">    list-&gt;part.elts = ngx_palloc(pool, n * size);</span><br><span class="line">    if (list-&gt;part.elts == NULL) &#123;</span><br><span class="line">        return NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    list-&gt;part.nelts = 0;</span><br><span class="line">    list-&gt;part.next = NULL;</span><br><span class="line">    list-&gt;last = &amp;list-&gt;part;</span><br><span class="line">    list-&gt;size = size;</span><br><span class="line">    list-&gt;nalloc = n;</span><br><span class="line">    list-&gt;pool = pool;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建list-ngx-list-create"><a href="#创建list-ngx-list-create" class="headerlink" title="创建list ngx_list_create"></a>创建list ngx_list_create</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_list_t</span> *</span><br><span class="line">ngx_list_create(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_uint_t</span> n, <span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_list_t</span>  *<span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">list</span> = ngx_palloc(pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_list_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_list_init(<span class="built_in">list</span>, pool, n, size) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加数据ngx-list-push"><a href="#添加数据ngx-list-push" class="headerlink" title="添加数据ngx_list_push"></a>添加数据ngx_list_push</h3><p>该方法返回添加元素对应的地址，返回地址后由调用方对地址赋值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_list_push(<span class="keyword">ngx_list_t</span> *l)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>             *elt;</span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>  *last;</span><br><span class="line"></span><br><span class="line">    last = l-&gt;last;</span><br><span class="line">    <span class="comment">// 如果最后的地址已经使用完了，新建一个元素</span></span><br><span class="line">    <span class="keyword">if</span> (last-&gt;nelts == l-&gt;nalloc) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the last part is full, allocate a new list part */</span></span><br><span class="line"></span><br><span class="line">        last = ngx_palloc(l-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_list_part_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (last == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        last-&gt;elts = ngx_palloc(l-&gt;pool, l-&gt;nalloc * l-&gt;size);</span><br><span class="line">        <span class="keyword">if</span> (last-&gt;elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        last-&gt;nelts = <span class="number">0</span>;</span><br><span class="line">        last-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        l-&gt;last-&gt;next = last;</span><br><span class="line">        l-&gt;last = last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配一个地址</span></span><br><span class="line">    elt = (<span class="keyword">char</span> *) last-&gt;elts + l-&gt;size * last-&gt;nelts;</span><br><span class="line">    <span class="comment">// 已使用地址+1</span></span><br><span class="line">    last-&gt;nelts++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-table-elt-t"><a href="#ngx-table-elt-t" class="headerlink" title="ngx_table_elt_t"></a>ngx_table_elt_t</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        hash; <span class="comment">// 某个散列表中执行对应的hash算法计算的hash值</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>         key;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>         value;</span><br><span class="line">    u_char           *lowcase_key; <span class="comment">// 全小写的key值</span></span><br><span class="line">&#125; <span class="keyword">ngx_table_elt_t</span>;</span><br></pre></td></tr></table></figure>
<p><code>ngx_table_elt_t</code>是一个Key/Value对。主要使用于解析http头部。</p>
<h2 id="散列表（ngx-hash-t）"><a href="#散列表（ngx-hash-t）" class="headerlink" title="散列表（ngx_hash_t）"></a>散列表（ngx_hash_t）</h2><p>存储散列表的类有如下三个相关结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash基础数据类</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>         key;  <span class="comment">// key值</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        key_hash; <span class="comment">// key经过ngx_hash_key_pt转换的类</span></span><br><span class="line">    <span class="keyword">void</span>             *value; <span class="comment">// key对应的值</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_key_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 散列表中存储的每个数据</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>             *value;  <span class="comment">// 对应存储的数据</span></span><br><span class="line">    u_short           len;    <span class="comment">// name长度</span></span><br><span class="line">    u_char            name[<span class="number">1</span>];  <span class="comment">// key值，name</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_elt_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际存储散列表的结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_hash_elt_t</span>  **buckets; <span class="comment">// 存储数据内容。为了解决冲突，因此是一个二维数组。</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        size;    <span class="comment">// 桶大小，多少个桶</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用来构建散列表的结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_hash_t</span>       *hash;</span><br><span class="line">    ngx_hash_key_pt   key; <span class="comment">// 将数据的key进行转换的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        max_size; <span class="comment">// hash表中的桶的个数。该字段越大，元素存储时冲突的可能性越小，每个桶中存储的元素会更少，则查询起来的速度更快。当然，这个值越大，越造成内存的浪费也越大，(实际上也浪费不了多少)。</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        bucket_size; <span class="comment">// 每个桶的最大限制大小，单位是字节。如果在初始化一个hash表的时候，发现某个桶里面无法存的下所有属于该桶的元素，则hash表初始化失败。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>             *name;  <span class="comment">// 散列表的名称</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *pool; <span class="comment">// 内存池</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *temp_pool; <span class="comment">// 临时内存池</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_init_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_uint_t</span> <span class="params">(*ngx_hash_key_pt)</span> <span class="params">(u_char *data, <span class="keyword">size_t</span> len)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="散列表构建"><a href="#散列表构建" class="headerlink" title="散列表构建"></a>散列表构建</h3><p>构建hash表使用函数ngx_hash_init:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_HASH_ELT_SIZE(name)                                               \</span></span><br><span class="line">    (<span class="keyword">sizeof</span>(<span class="keyword">void</span> *) + ngx_align((name)-&gt;key.len + <span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)))</span><br><span class="line"><span class="comment">/* 该宏返回每个key生成ngx_hash_elt_t大小（字节）的sizeof(void *)的整数倍，这即使用其占用内存大小（虽然可能实际需要内存小于该值）。这里sizeof(void *)对应于ngx_hash_elt_t的value指针，(name)-&gt;key.len对应与name占用空间，2对应于len字节。这里使用ngx_align方法不是为了内存对其，而是为了将每个ngx_hash_elt_t进行划分，为了方便查询时更方快速获取。由于ngx_hash_t中的buckets申请的连续内存，name字段是要存储在该连续内存中，因此每个ngx_hash_elt_t所占用空间大小不一致，不能直接使用下标进行获取，使用该方法是为了内存对其，加速获取速度，具体查找时的方法参加下一小*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_hash_init(<span class="keyword">ngx_hash_init_t</span> *hinit, <span class="keyword">ngx_hash_key_t</span> *names, <span class="keyword">ngx_uint_t</span> nelts)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里参数ngx_hash_key_t一般是存储在ngx_array_t中第一个元素，nelts是元素数量</span></span><br><span class="line">    u_char          *elts;</span><br><span class="line">    <span class="keyword">size_t</span>           len;</span><br><span class="line">    u_short         *test;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       i, n, key, size, start, bucket_size;</span><br><span class="line">    <span class="keyword">ngx_hash_elt_t</span>  *elt, **buckets;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// max_size为0表示不能分配一个桶</span></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;max_size == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"could not build %s, you should "</span></span><br><span class="line">                      <span class="string">"increase %s_max_size: %i"</span>,</span><br><span class="line">                      hinit-&gt;name, hinit-&gt;name, hinit-&gt;max_size);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 每个桶的容量（字节数量）过大</span></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;bucket_size &gt; <span class="number">65536</span> - ngx_cacheline_size) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"could not build %s, too large "</span></span><br><span class="line">                      <span class="string">"%s_bucket_size: %i"</span>,</span><br><span class="line">                      hinit-&gt;name, hinit-&gt;name, hinit-&gt;bucket_size);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">        <span class="comment">/* 如果某个key构建的ngx_hash_elt_t所需空间加上一个void*所用空间大于bucket_siz，则报错。这里增加void*指针，是因为在ngx_hash_t中的buckets中，对于每一个桶，并没有指名末尾是什么，因此需要在最后增加一个void*的空间，对应获取到ngx_hash_elt_t的value字段，该字段设置为空，表示桶的末尾。*/</span></span><br><span class="line">        <span class="keyword">if</span> (hinit-&gt;bucket_size &lt; NGX_HASH_ELT_SIZE(&amp;names[n]) + <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"could not build %s, you should "</span></span><br><span class="line">                          <span class="string">"increase %s_bucket_size: %i"</span>,</span><br><span class="line">                          hinit-&gt;name, hinit-&gt;name, hinit-&gt;bucket_size);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配 存储每个hash元素所需要的空间大小 数组</span></span><br><span class="line">    test = ngx_alloc(hinit-&gt;max_size * <span class="keyword">sizeof</span>(u_short), hinit-&gt;pool-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (test == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// bucket_size为允许桶存储的大小减去末尾记录为结尾的空间</span></span><br><span class="line">    bucket_size = hinit-&gt;bucket_size - <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 初始分配需要多少个桶，使用元素数量/(每个桶允许存储数据的字节大小/(2 * sizeof(void *))，这里2 * sizeof(void *)是一个ngx_hash_elt_t预估占用内存大小，因此实际为元素数量除以每个桶允许存放的元素个数 */</span></span><br><span class="line">    start = nelts / (bucket_size / (<span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line">    start = start ? start : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;max_size &gt; <span class="number">10000</span> &amp;&amp; nelts &amp;&amp; hinit-&gt;max_size / nelts &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        start = hinit-&gt;max_size - <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找实际需要多少个桶才能满足每个桶中最多分配bucket_size内存，实际需要的桶数量不能超过限制的最大值max_size</span></span><br><span class="line">    <span class="keyword">for</span> (size = start; size &lt;= hinit-&gt;max_size; size++) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_memzero(test, size * <span class="keyword">sizeof</span>(u_short));</span><br><span class="line">        <span class="comment">// 遍历每一个元素</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (names[n].key.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 找到以当前分配桶的数量时，其应该存放到哪个桶中</span></span><br><span class="line">            key = names[n].key_hash % size;</span><br><span class="line">            <span class="comment">// 计算当前分配到这个桶中所以元素所占用的内存大小</span></span><br><span class="line">            len = test[key] + NGX_HASH_ELT_SIZE(&amp;names[n]);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui: %ui %uz \"%V\""</span>,</span><br><span class="line">                          size, key, len, &amp;names[n].key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 如果当前该桶占用的内存已经超出限制，则表示当前分配的桶数量不足，增加桶的数量，再查找验证</span></span><br><span class="line">            <span class="keyword">if</span> (len &gt; bucket_size) &#123;</span><br><span class="line">                <span class="keyword">goto</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果循环结束，依然位发现有某个桶分配的元素所占用内存过大，则说明找到了桶大小</span></span><br><span class="line">            test[key] = (u_short) len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> found;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未找到，则表示hash表初始化失败，报错</span></span><br><span class="line">    size = hinit-&gt;max_size;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_WARN, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"could not build optimal %s, you should increase "</span></span><br><span class="line">                  <span class="string">"either %s_max_size: %i or %s_bucket_size: %i; "</span></span><br><span class="line">                  <span class="string">"ignoring %s_bucket_size"</span>,</span><br><span class="line">                  hinit-&gt;name, hinit-&gt;name, hinit-&gt;max_size,</span><br><span class="line">                  hinit-&gt;name, hinit-&gt;bucket_size, hinit-&gt;name);</span><br><span class="line"></span><br><span class="line">found:</span><br><span class="line"><span class="comment">// 查找到需要建立多少个桶的处理</span></span><br><span class="line">    <span class="comment">// 每一个桶中先分配一个作为末尾表示的空指针对应的存储空间大小</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        test[i] = <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每个元素</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (names[n].key.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 计算每个元素在该桶大小下分配到哪个桶中</span></span><br><span class="line">        key = names[n].key_hash % size;</span><br><span class="line">        <span class="comment">// 记录该桶中当前已占用内存大小</span></span><br><span class="line">        len = test[key] + NGX_HASH_ELT_SIZE(&amp;names[n]);</span><br><span class="line">        <span class="comment">// 超过该值报错</span></span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">65536</span> - ngx_cacheline_size) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"could not build %s, you should "</span></span><br><span class="line">                          <span class="string">"increase %s_max_size: %i"</span>,</span><br><span class="line">                          hinit-&gt;name, hinit-&gt;name, hinit-&gt;max_size);</span><br><span class="line">            ngx_free(test);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        test[key] = (u_short) len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 变量每一个桶，计算总共需要创建的内存大小</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="comment">// 空的桶不需要创建内存</span></span><br><span class="line">        <span class="keyword">if</span> (test[i] == <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 为了加速请求速度，每个桶分配内存都为cache line的整数倍 </span></span><br><span class="line">        test[i] = (u_short) (ngx_align(test[i], ngx_cacheline_size));</span><br><span class="line"></span><br><span class="line">        len += test[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配hash需要的内存大小，分配buckets空间</span></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        hinit-&gt;hash = ngx_pcalloc(hinit-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_wildcard_t</span>)</span><br><span class="line">                                             + size * <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_elt_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (hinit-&gt;hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_free(test);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buckets = (<span class="keyword">ngx_hash_elt_t</span> **)</span><br><span class="line">                      ((u_char *) hinit-&gt;hash + <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_wildcard_t</span>));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buckets = ngx_pcalloc(hinit-&gt;pool, size * <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_elt_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (buckets == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_free(test);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配存储所有元素需要的空间大小</span></span><br><span class="line">    elts = ngx_palloc(hinit-&gt;pool, len + ngx_cacheline_size);</span><br><span class="line">    <span class="keyword">if</span> (elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_free(test);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为加速，进行内存行对其</span></span><br><span class="line">    elts = ngx_align_ptr(elts, ngx_cacheline_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历每个桶</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (test[i] == <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用分配的内存，初始化每个桶的起始位置</span></span><br><span class="line">        buckets[i] = (<span class="keyword">ngx_hash_elt_t</span> *) elts;</span><br><span class="line">        elts += test[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        test[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对每一个元素赋值</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (names[n].key.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到该元素分配到每个哪个桶中</span></span><br><span class="line">        key = names[n].key_hash % size;</span><br><span class="line">        <span class="comment">// 找到该元素应该分配到桶中的内存起始位置</span></span><br><span class="line">        elt = (<span class="keyword">ngx_hash_elt_t</span> *) ((u_char *) buckets[key] + test[key]);</span><br><span class="line">        <span class="comment">// 对元素赋值</span></span><br><span class="line">        elt-&gt;value = names[n].value;</span><br><span class="line">        elt-&gt;len = (u_short) names[n].key.len;</span><br><span class="line"></span><br><span class="line">        ngx_strlow(elt-&gt;name, names[n].key.data, names[n].key.len);</span><br><span class="line">        <span class="comment">// 增加该桶中使用了的内存大小</span></span><br><span class="line">        test[key] = (u_short) (test[key] + NGX_HASH_ELT_SIZE(&amp;names[n]));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对每一个桶中，增加结束标识</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buckets[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取到当前桶已经使用到的内存位置</span></span><br><span class="line">        elt = (<span class="keyword">ngx_hash_elt_t</span> *) ((u_char *) buckets[i] + test[i]);</span><br><span class="line">        <span class="comment">// 对该位置的value设置为null，查找时作为结束标识</span></span><br><span class="line">        elt-&gt;value = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_free(test);</span><br><span class="line">    <span class="comment">// 赋值桶和桶大小</span></span><br><span class="line">    hinit-&gt;hash-&gt;buckets = buckets;</span><br><span class="line">    hinit-&gt;hash-&gt;size = size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">ngx_str_t</span>   val;</span><br><span class="line">        <span class="keyword">ngx_uint_t</span>  key;</span><br><span class="line"></span><br><span class="line">        elt = buckets[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (elt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui: NULL"</span>, i);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (elt-&gt;value) &#123;</span><br><span class="line">            val.len = elt-&gt;len;</span><br><span class="line">            val.data = &amp;elt-&gt;name[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            key = hinit-&gt;key(val.data, val.len);</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui: %p \"%V\" %ui"</span>, i, elt, &amp;val, key);</span><br><span class="line"></span><br><span class="line">            elt = (<span class="keyword">ngx_hash_elt_t</span> *) ngx_align_ptr(&amp;elt-&gt;name[<span class="number">0</span>] + elt-&gt;len,</span><br><span class="line">                                                   <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="散列表查找"><a href="#散列表查找" class="headerlink" title="散列表查找"></a>散列表查找</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_hash_find(<span class="keyword">ngx_hash_t</span> *hash, <span class="keyword">ngx_uint_t</span> key, u_char *name, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       i;</span><br><span class="line">    <span class="keyword">ngx_hash_elt_t</span>  *elt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"hf:\"%*s\""</span>, len, name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 找到该元素属于哪个桶</span></span><br><span class="line">    elt = hash-&gt;buckets[key % hash-&gt;size];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (elt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找桶中元素，直到末尾</span></span><br><span class="line">    <span class="keyword">while</span> (elt-&gt;value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (len != (<span class="keyword">size_t</span>) elt-&gt;len) &#123;</span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name[i] != elt-&gt;name[i]) &#123;</span><br><span class="line">                <span class="keyword">goto</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到后返回</span></span><br><span class="line">        <span class="keyword">return</span> elt-&gt;value;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line"></span><br><span class="line">        elt = (<span class="keyword">ngx_hash_elt_t</span> *) ngx_align_ptr(&amp;elt-&gt;name[<span class="number">0</span>] + elt-&gt;len,</span><br><span class="line">                                               <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="管理散列表（ngx-hash-keys-arrays-t）"><a href="#管理散列表（ngx-hash-keys-arrays-t）" class="headerlink" title="管理散列表（ngx_hash_keys_arrays_t）"></a>管理散列表（ngx_hash_keys_arrays_t）</h2><p>nginx为了让大家方便的构造hash表，提供给了此辅助类型，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 将要构建的hash表的桶的个数。对于使用这个结构中包含的信息构建的三种类型的hash表都会使用此参数。</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        hsize;</span><br><span class="line">    <span class="comment">// 构建这些hash表使用的pool。</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *pool;</span><br><span class="line">    <span class="comment">// 在构建这个类型以及最终的三个hash表过程中可能用到临时pool。该temp_pool可以在构建完成以后，被销毁掉。这里只是存放临时的一些内存消耗。</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *temp_pool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放所有非通配符key的数组。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>       keys;</span><br><span class="line">    <span class="comment">/*这是个二维数组，第一个维度代表的是bucket的编号，那么keys_hash[i]中存放的是所有的key算出来的hash值对hsize取模以后的值为i的key。假设有3个key,分别是key1,key2和key3假设hash值算出来以后对hsize取模的值都是i，那么这三个key的值就顺序存放在keys_hash[i][0],keys_hash[i][1], keys_hash[i][2]。该值在调用的过程中用来保存和检测是否有冲突的key值，也就是是否有重复。用于存放非通配符数据*/</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>      *keys_hash;</span><br><span class="line">    <span class="comment">// 放前向通配符key被处理完成以后的值。比如：“*.abc.com” 被处理完成以后，变成 “com.abc.” 被存放在此数组中。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>       dns_wc_head;</span><br><span class="line">    <span class="comment">// 该值在调用的过程中用来保存和检测是否有冲突的前向通配符的key值，也就是是否有重复。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>      *dns_wc_head_hash;</span><br><span class="line">    <span class="comment">// 存放后向通配符key被处理完成以后的值。比如：“mail.xxx.*” 被处理完成以后，变成 “mail.xxx.” 被存放在此数组中。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>       dns_wc_tail;</span><br><span class="line">    <span class="comment">// 该值在调用的过程中用来保存和检测是否有冲突的后向通配符的key值，也就是是否有重复。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>      *dns_wc_tail_hash;</span><br><span class="line">&#125; <span class="keyword">ngx_hash_keys_arrays_t</span>;</span><br><span class="line"><span class="comment">// 一维数组存储数据一般ngx_hash_key_t，二维数组存储数据一般ngx_str_t</span></span><br></pre></td></tr></table></figure>
<h3 id="构建ngx-hash-keys-arrays-t"><a href="#构建ngx-hash-keys-arrays-t" class="headerlink" title="构建ngx_hash_keys_arrays_t"></a>构建ngx_hash_keys_arrays_t</h3><p>使用ngx_hash_keys_array_init构建该结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line"><span class="comment">// type指名构建的大小。其中NGX_HASH_SMALL表示待初始化的元素较少，NGX_HASH_LARGE表示待初始化的元素较多</span></span><br><span class="line">ngx_hash_keys_array_init(<span class="keyword">ngx_hash_keys_arrays_t</span> *ha, <span class="keyword">ngx_uint_t</span> type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 数组预分配空间大小 </span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  asize;</span><br><span class="line">    <span class="comment">// 初始化较少时，预分配大小为4，桶数量为107</span></span><br><span class="line">    <span class="keyword">if</span> (type == NGX_HASH_SMALL) &#123;</span><br><span class="line">        asize = <span class="number">4</span>;</span><br><span class="line">        ha-&gt;hsize = <span class="number">107</span>;</span><br><span class="line">    <span class="comment">// 初始化较多时，预分配大小为16384，桶数量为10007</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        asize = NGX_HASH_LARGE_ASIZE;</span><br><span class="line">        ha-&gt;hsize = NGX_HASH_LARGE_HSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化存储数据的三个数组</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;keys, ha-&gt;temp_pool, asize, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;dns_wc_head, ha-&gt;temp_pool, asize,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;dns_wc_tail, ha-&gt;temp_pool, asize,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化用于查看是否有重复的简易hash表</span></span><br><span class="line">    ha-&gt;keys_hash = ngx_pcalloc(ha-&gt;temp_pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_array_t</span>) * ha-&gt;hsize);</span><br><span class="line">    <span class="keyword">if</span> (ha-&gt;keys_hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ha-&gt;dns_wc_head_hash = ngx_pcalloc(ha-&gt;temp_pool,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_array_t</span>) * ha-&gt;hsize);</span><br><span class="line">    <span class="keyword">if</span> (ha-&gt;dns_wc_head_hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ha-&gt;dns_wc_tail_hash = ngx_pcalloc(ha-&gt;temp_pool,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_array_t</span>) * ha-&gt;hsize);</span><br><span class="line">    <span class="keyword">if</span> (ha-&gt;dns_wc_tail_hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加元素"><a href="#添加元素" class="headerlink" title="添加元素"></a>添加元素</h3><p>使用如下函数增加元素：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* flag取值有三种：NGX_HASH_WILDCARD_KEY表示需要处理通配符。 NGX_HASH_READONLY_KEY表示不能对关键字做变更，即不能通过全小写关键字来获取散列码，其他值：即不处理通配符，又允许把关键字全小写获取散列码*/</span></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_hash_add_key(<span class="keyword">ngx_hash_keys_arrays_t</span> *ha, <span class="keyword">ngx_str_t</span> *key, <span class="keyword">void</span> *value,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>           len;</span><br><span class="line">    u_char          *p;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>       *name;</span><br><span class="line">    <span class="comment">// skip表示起始位置要跳过字符数量，last表示到末尾的长度</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       i, k, n, skip, last;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>     *keys, *hwc;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>  *hk;</span><br><span class="line"></span><br><span class="line">    last = key-&gt;len;</span><br><span class="line">    <span class="comment">// 处理通配符</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_HASH_WILDCARD_KEY) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * supported wildcards:</span></span><br><span class="line"><span class="comment">         *     "*.example.com", ".example.com", and "www.example.*"</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 校验字符串正确性</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; key-&gt;len; i++) &#123;</span><br><span class="line">            <span class="comment">// 如果出现多个*表示为nginx不正常的通配符格式（只支持首尾一个通配符）</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (++n &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 错误通配符数据</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'.'</span> &amp;&amp; key-&gt;data[i + <span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 字符串以\0结尾</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'\0'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ".example.com"格式数据,存储数据时去带.</span></span><br><span class="line">        <span class="keyword">if</span> (key-&gt;len &gt; <span class="number">1</span> &amp;&amp; key-&gt;data[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            skip = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> wildcard;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key-&gt;len &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// "*.example.com"格式数据,存储数据时去带.*</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[<span class="number">0</span>] == <span class="string">'*'</span> &amp;&amp; key-&gt;data[<span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                skip = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">goto</span> wildcard;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// "www.example.*"格式数据,存储数据时去带.*</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i - <span class="number">2</span>] == <span class="string">'.'</span> &amp;&amp; key-&gt;data[i - <span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                skip = <span class="number">0</span>;</span><br><span class="line">                last -= <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">goto</span> wildcard;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 存在通配符*,但不在首尾</span></span><br><span class="line">        <span class="keyword">if</span> (n) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* exact hash */</span></span><br><span class="line">    <span class="comment">// 未找到通配符或不查看通配符</span></span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 根据是否可以转换为小写计算哈希值</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; last; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; NGX_HASH_READONLY_KEY)) &#123;</span><br><span class="line">            key-&gt;data[i] = ngx_tolower(key-&gt;data[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        k = ngx_hash(k, key-&gt;data[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    k %= ha-&gt;hsize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check conflicts in exact hash */</span></span><br><span class="line">    <span class="comment">// 找到在keys_hash精准匹配的哪个桶中</span></span><br><span class="line">    name = ha-&gt;keys_hash[k].elts;</span><br><span class="line">    <span class="comment">// 如果桶不为空，查看桶中是否有当前值</span></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ha-&gt;keys_hash[k].nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (last != name[i].len) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(key-&gt;data, name[i].data, last) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 初始化桶</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;keys_hash[k], ha-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加元素到桶中</span></span><br><span class="line">    name = ngx_array_push(&amp;ha-&gt;keys_hash[k]);</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *name = *key;</span><br><span class="line"></span><br><span class="line">    hk = ngx_array_push(&amp;ha-&gt;keys);</span><br><span class="line">    <span class="keyword">if</span> (hk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hk-&gt;key = *key;</span><br><span class="line">    hk-&gt;key_hash = ngx_hash_key(key-&gt;data, last);</span><br><span class="line">    hk-&gt;value = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通配符处理逻辑</span></span><br><span class="line">wildcard:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* wildcard hash */</span></span><br><span class="line">    <span class="comment">// 去除通配符相关字段*.,.，转换小写计算hash值</span></span><br><span class="line">    k = ngx_hash_strlow(&amp;key-&gt;data[skip], &amp;key-&gt;data[skip], last - skip);</span><br><span class="line"></span><br><span class="line">    k %= ha-&gt;hsize;</span><br><span class="line">    <span class="comment">// 对于是.example.com这种形式的key，其只能和精准的example.com两者直接存在一个。或者在精准中存在一个example.com，或者在前缀匹配中，存在一个.example.com</span></span><br><span class="line">    <span class="keyword">if</span> (skip == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check conflicts in exact hash for ".example.com" */</span></span><br><span class="line"></span><br><span class="line">        name = ha-&gt;keys_hash[k].elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name) &#123;</span><br><span class="line">            len = last - skip;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ha-&gt;keys_hash[k].nelts; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (len != name[i].len) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果精准匹配中已存在，则返回</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_strncmp(&amp;key-&gt;data[<span class="number">1</span>], name[i].data, len) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;keys_hash[k], ha-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                               <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>))</span><br><span class="line">                != NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果精准匹配中不存在，则添加一个example.com形式的key到精准匹配中，避免精准匹配中再增加</span></span><br><span class="line">        name = ngx_array_push(&amp;ha-&gt;keys_hash[k]);</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        name-&gt;len = last - <span class="number">1</span>;</span><br><span class="line">        name-&gt;data = ngx_pnalloc(ha-&gt;temp_pool, name-&gt;len);</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(name-&gt;data, &amp;key-&gt;data[<span class="number">1</span>], name-&gt;len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于前置通配符</span></span><br><span class="line">    <span class="keyword">if</span> (skip) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * convert "*.example.com" to "com.example.\0"</span></span><br><span class="line"><span class="comment">         *      and ".example.com" to "com.example\0"</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(ha-&gt;temp_pool, last);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = <span class="number">0</span>;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 转换*.example.com到com.example.\0，.example.com到com.example\0，注意这里的i未到0</span></span><br><span class="line">        <span class="keyword">for</span> (i = last - <span class="number">1</span>; i; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                ngx_memcpy(&amp;p[n], &amp;key-&gt;data[i + <span class="number">1</span>], len);</span><br><span class="line">                n += len;</span><br><span class="line">                p[n++] = <span class="string">'.'</span>;</span><br><span class="line">                len = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            len++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于.example.com的来说，将example拼接上</span></span><br><span class="line">        <span class="keyword">if</span> (len) &#123;</span><br><span class="line">            ngx_memcpy(&amp;p[n], &amp;key-&gt;data[<span class="number">1</span>], len);</span><br><span class="line">            n += len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p[n] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">        hwc = &amp;ha-&gt;dns_wc_head;</span><br><span class="line">        keys = &amp;ha-&gt;dns_wc_head_hash[k];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* convert "www.example.*" to "www.example\0" */</span></span><br><span class="line"></span><br><span class="line">        last++;</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(ha-&gt;temp_pool, last);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_cpystrn(p, key-&gt;data, last);</span><br><span class="line"></span><br><span class="line">        hwc = &amp;ha-&gt;dns_wc_tail;</span><br><span class="line">        keys = &amp;ha-&gt;dns_wc_tail_hash[k];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check conflicts in wildcard hash */</span></span><br><span class="line">    <span class="comment">// 在对应的通配符表中查找是否已经存在</span></span><br><span class="line">    name = keys-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        len = last - skip;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; keys-&gt;nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (len != name[i].len) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(key-&gt;data + skip, name[i].data, len) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(keys, ha-&gt;temp_pool, <span class="number">4</span>, <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>)) != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向对应的简易hash表中增加数据，注意，这里增加的是去除通配符字段后原始数据，并未将首通配符样式字段倒排</span></span><br><span class="line">    name = ngx_array_push(keys);</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    name-&gt;len = last - skip;</span><br><span class="line">    name-&gt;data = ngx_pnalloc(ha-&gt;temp_pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (name-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(name-&gt;data, key-&gt;data + skip, name-&gt;len);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add to wildcard hash */</span></span><br><span class="line">    <span class="comment">// 添加数据到对于的数组中，这里添加的是处理后的数据，即将首通配符样式字段倒排</span></span><br><span class="line">    hk = ngx_array_push(hwc);</span><br><span class="line">    <span class="keyword">if</span> (hk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// *.baidu.com被存储为com.baidu.;.baidu.com被存储为com.baidu; www.baidu.*被存储为www.baidu</span></span><br><span class="line">    hk-&gt;key.len = last - <span class="number">1</span>;</span><br><span class="line">    hk-&gt;key.data = p;</span><br><span class="line">    hk-&gt;key_hash = <span class="number">0</span>;</span><br><span class="line">    hk-&gt;value = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于构建好的通配符数组，不能直接调用ngx_hash_wildcard_init来构建包含通配符的散列表，而是要先对数组进行排序，这就是为什么要在字节后面添加\0的作用，用于判断字符串结尾。排序时，<code>.</code>被认为是最低顺序的字节，即：<code>example.com</code>小于（排在前面）<code>example1.com</code>。</p>
<h2 id="带有通配符的散列表（ngx-hash-wildcard-t）"><a href="#带有通配符的散列表（ngx-hash-wildcard-t）" class="headerlink" title="带有通配符的散列表（ngx_hash_wildcard_t）"></a>带有通配符的散列表（ngx_hash_wildcard_t）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 基本散列表</span><br><span class="line">    ngx_hash_t        hash;</span><br><span class="line">    // 当使用ngx_hash_wildcard_t通配符散列表作为某容器的元素时，可以使用value指向用户数据</span><br><span class="line">    void             *value;</span><br><span class="line">&#125; ngx_hash_wildcard_t;</span><br></pre></td></tr></table></figure>
<p>nginx支持的带通配符的散列表，仅支持在起始或末尾带有散列表，即如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">www.baidu.*</span><br><span class="line">*.baidu.com</span><br><span class="line">.baidu.com // 有可能被记录为不带通配符的baidu.com</span><br></pre></td></tr></table></figure>
<h3 id="构建带有通配符的散列表"><a href="#构建带有通配符的散列表" class="headerlink" title="构建带有通配符的散列表"></a>构建带有通配符的散列表</h3><p>ngx_hash_wildcard_init函数用来构建带有通配符的散列表。这里需要注意，不论是构建前置为通配符还是后置为通配符，其中的参数，即ngx_hash_key_t列表，均是z已被排序好的，即key均被排序完成，这时为了方便后续的构建。对于含有通配符的hash表来说，其是一个层级结构。例如对于如下两个key：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www.baidu.com</span><br><span class="line">www.tencent.com</span><br></pre></td></tr></table></figure>
<p>则构建的hash表为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一级   第二级    第三极</span><br><span class="line">        baidu    com</span><br><span class="line">www </span><br><span class="line">        tencent  com</span><br></pre></td></tr></table></figure>
<p>查找时也是同样的逻辑，先按照<code>.</code>划分块，再一层一层查找。这也是为啥要将前置的通配符反转，变更成类似于后置的结构。</p>
<p>具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_hash_wildcard_init(<span class="keyword">ngx_hash_init_t</span> *hinit, <span class="keyword">ngx_hash_key_t</span> *names,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> nelts)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                len, dot_len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            i, n, dot;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>           curr_names, next_names;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>       *name, *next_name;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>       h;</span><br><span class="line">    <span class="keyword">ngx_hash_wildcard_t</span>  *wdc;</span><br><span class="line">    <span class="comment">// 分配当前层级数据空间</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;curr_names, hinit-&gt;temp_pool, nelts,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配当下一层级数据空间</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;next_names, hinit-&gt;temp_pool, nelts,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从第一个开始查看，并不是简单的遍历</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n = i) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"wc0: \"%V\""</span>, &amp;names[n].key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 记录是否查找到逗号，并使用len记录逗号所在下标</span></span><br><span class="line">        dot = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (len = <span class="number">0</span>; len &lt; names[n].key.len; len++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (names[n].key.data[len] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                dot = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加当前的数据到当前层级数据中，对于查找到逗号的情况，其key变更为逗号前的部分，value为当前key对应数据的value</span></span><br><span class="line">        name = ngx_array_push(&amp;curr_names);</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        name-&gt;key.len = len;</span><br><span class="line">        name-&gt;key.data = names[n].key.data;</span><br><span class="line">        name-&gt;key_hash = hinit-&gt;key(name-&gt;key.data, name-&gt;key.len);</span><br><span class="line">        name-&gt;value = names[n].value;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"wc1: \"%V\" %ui"</span>, &amp;name-&gt;key, dot);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 记录从开始到当前位置的长度，用于切割key</span></span><br><span class="line">        dot_len = len + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 如果发现了.，则len加一，对比时，.字符也会用来比较相同前缀的key</span></span><br><span class="line">        <span class="keyword">if</span> (dot) &#123;</span><br><span class="line">            len++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        next_names.nelts = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 表示并为遍历到结尾，后面还有待切割字段，则将后面部分数据添加到构建下一层hash表的列表中</span></span><br><span class="line">        <span class="keyword">if</span> (names[n].key.len != len) &#123;</span><br><span class="line">            next_name = ngx_array_push(&amp;next_names);</span><br><span class="line">            <span class="keyword">if</span> (next_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            next_name-&gt;key.len = names[n].key.len - len;</span><br><span class="line">            next_name-&gt;key.data = names[n].key.data + len;</span><br><span class="line">            next_name-&gt;key_hash = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// value存储对于的数据，后续可能会变更</span></span><br><span class="line">            next_name-&gt;value = names[n].value;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"wc2: \"%V\""</span>, &amp;next_name-&gt;key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历后面的key，找到第一个和当前查找到的前缀不匹配的key，注意 . 也会被匹配，即，查看的应该是 example.或者com这两种形式的查找匹配。</span></span><br><span class="line">        <span class="keyword">for</span> (i = n + <span class="number">1</span>; i &lt; nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(names[n].key.data, names[i].key.data, len) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没有查找到逗号，即当前的n是切割的末尾了，并且当前的i长度要大于现在的n的长度，且i的len不是.就结束查找。这时由于，com.ex也要是com的子一层hash表。但comm不是com子一层。</span></span><br><span class="line">            <span class="keyword">if</span> (!dot</span><br><span class="line">                &amp;&amp; names[i].key.len &gt; len</span><br><span class="line">                &amp;&amp; names[i].key.data[len] != <span class="string">'.'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将查找到属于当前n的子一层hash元素的数据添加到用来构建子一层hash表的数组中。</span></span><br><span class="line">            next_name = ngx_array_push(&amp;next_names);</span><br><span class="line">            <span class="keyword">if</span> (next_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 同样是要把当前一层的key去掉，子一层只用剩下的字符串</span></span><br><span class="line">            next_name-&gt;key.len = names[i].key.len - dot_len;</span><br><span class="line">            next_name-&gt;key.data = names[i].key.data + dot_len;</span><br><span class="line">            next_name-&gt;key_hash = <span class="number">0</span>;</span><br><span class="line">            next_name-&gt;value = names[i].value;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"wc3: \"%V\""</span>, &amp;next_name-&gt;key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果存在需要构建子一层hash表的key</span></span><br><span class="line">        <span class="keyword">if</span> (next_names.nelts) &#123;</span><br><span class="line"></span><br><span class="line">            h = *hinit;</span><br><span class="line">            h.hash = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">// 对子数组递归调用ngx_hash_wildcard_init构建函数。这里会调用ngx_hash_init，对于hash等于null来说，构建的hash是ngx_hash_wildcard_t结构</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_hash_wildcard_init(&amp;h, (<span class="keyword">ngx_hash_key_t</span> *) next_names.elts,</span><br><span class="line">                                       next_names.nelts)</span><br><span class="line">                != NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 转换为ngx_hash_wildcard_t</span></span><br><span class="line">            wdc = (<span class="keyword">ngx_hash_wildcard_t</span> *) h.hash;</span><br><span class="line">            <span class="comment">// 如果当前的n是查询的末尾，那么用ngx_hash_wildcard_t存储对应的value，如果不是查询末尾，则ngx_hash_wildcard_t存储对应的value对应为NULL</span></span><br><span class="line">            <span class="keyword">if</span> (names[n].key.len == len) &#123;</span><br><span class="line">                wdc-&gt;value = names[n].value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当前ngx_hash_key_t的value指向下一层的hash表。同时利用指针最后两位来标识当前节点状况。10表示当前的value指向下一层hash表，11表示当前value指向下一层hash并且该字符串后面跟随着 .</span></span><br><span class="line">            name-&gt;value = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) wdc | (dot ? <span class="number">3</span> : <span class="number">2</span>));</span><br><span class="line">        <span class="comment">// 如果不需要建下一层的hash表，并且发现了.，即com.example.这种情况，使用01记录。00则表示是最后的节点，其下层没有hash表，并且字段后面没有. 当前的value指向对应的数据</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dot) &#123;</span><br><span class="line">            name-&gt;value = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) name-&gt;value | <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建当前层级的hash表</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_init(hinit, (<span class="keyword">ngx_hash_key_t</span> *) curr_names.elts,</span><br><span class="line">                      curr_names.nelts)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于如下数据：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*.baidu.com               value1</span><br><span class="line">*.baidu.cn                value2</span><br><span class="line">*.tencent.com             value3</span><br><span class="line">*.example.baidu.com       value4 </span><br><span class="line">*.example.baidu-int.com   value5</span><br></pre></td></tr></table></figure>
<p>首先被转换并排序为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cn.baidu.                value2</span><br><span class="line">com.baidu.               value1</span><br><span class="line">com.baidu.example.       value4 </span><br><span class="line">com.baidu-int.example.   value5</span><br><span class="line">com.tencent.             value3</span><br></pre></td></tr></table></figure>
<p>构建多层hash表如下：</p>
<p><a href="https://imgtu.com/i/WItYGR" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/27/WItYGR.png" alt="WItYGR.png"></a></p>
<h3 id="查找后缀通配符"><a href="#查找后缀通配符" class="headerlink" title="查找后缀通配符"></a>查找后缀通配符</h3><p>使用ngx_hash_find_wc_tail在后缀通配符中查找：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_hash_find_wc_tail(<span class="keyword">ngx_hash_wildcard_t</span> *hwc, u_char *name, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, key;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"wct:\"%*s\""</span>, len, name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 使用.进行切割。如果查找到末尾还未找到，则返回null。由于是后缀通配符，因此查找到了末尾还未找到对应数据，则应该在精准匹配里面查找，而不应该在后置表中查找。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name[i] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 计算切割后的hash值</span></span><br><span class="line">        key = ngx_hash(key, name[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i == len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"key:\"%ui\""</span>, key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 查找当前的hash表</span></span><br><span class="line">    value = ngx_hash_find(&amp;hwc-&gt;hash, key, name, i);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"value:\"%p\""</span>, value);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the 2 low bits of value have the special meaning:</span></span><br><span class="line"><span class="comment">         *     00 - value is data pointer;</span></span><br><span class="line"><span class="comment">         *     11 - value is pointer to wildcard hash allowing "example.*".</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 对于指针倒数第二位来说，如果是1，则表明value值是下一层的hash数据</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 加1，去掉 . 继续查找</span></span><br><span class="line">            i++;</span><br><span class="line">            <span class="comment">// 恢复指针为正常指针</span></span><br><span class="line">            hwc = (<span class="keyword">ngx_hash_wildcard_t</span> *) ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line">            <span class="comment">// 查找下一层的hash数据</span></span><br><span class="line">            value = ngx_hash_find_wc_tail(hwc, &amp;name[i], len - i);</span><br><span class="line">            <span class="comment">// 如果找到，则返回</span></span><br><span class="line">            <span class="keyword">if</span> (value) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 未找到，则查找到的value对应的hash表结构ngx_hash_wildcard_t的value值，有可能为null（取决于构建时是否构建该层级的数据）</span></span><br><span class="line">            <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果hash表中没有对应切割的数据，那么返回当前层级hash表结构ngx_hash_wildcard_t的value值。有可能为空，因为查找时找最长匹配，如果后面没有对应的匹配，则使用当前层级的hash对应数据（有可能为null）。</span></span><br><span class="line">    <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查找前缀通配符"><a href="#查找前缀通配符" class="headerlink" title="查找前缀通配符"></a>查找前缀通配符</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_hash_find_wc_head(<span class="keyword">ngx_hash_wildcard_t</span> *hwc, u_char *name, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, n, key;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"wch:\"%*s\""</span>, len, name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    n = len;</span><br><span class="line">    <span class="comment">// 从后向前切词</span></span><br><span class="line">    <span class="keyword">while</span> (n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name[n - <span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 计算切词的hash值</span></span><br><span class="line">    <span class="keyword">for</span> (i = n; i &lt; len; i++) &#123;</span><br><span class="line">        key = ngx_hash(key, name[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"key:\"%ui\""</span>, key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 查找当前的前缀表</span></span><br><span class="line">    value = ngx_hash_find(&amp;hwc-&gt;hash, key, &amp;name[n], len - n);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"value:\"%p\""</span>, value);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 在当前hash表中查找到了对应数据</span></span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the 2 low bits of value have the special meaning:</span></span><br><span class="line"><span class="comment">         *     00 - value is data pointer for both "example.com"</span></span><br><span class="line"><span class="comment">         *          and "*.example.com";</span></span><br><span class="line"><span class="comment">         *     01 - value is data pointer for "*.example.com" only;</span></span><br><span class="line"><span class="comment">         *     10 - value is pointer to wildcard hash allowing</span></span><br><span class="line"><span class="comment">         *          both "example.com" and "*.example.com";</span></span><br><span class="line"><span class="comment">         *     11 - value is pointer to wildcard hash allowing</span></span><br><span class="line"><span class="comment">         *          "*.example.com" only.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 指针的倒数第二位是1，表示当前value指向的是下一层hash表</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 查找到了key的末尾</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* "example.com" */</span></span><br><span class="line">                <span class="comment">// 11表示构建hash时，是*.example.com，并且其后还有下一层hash。而当前搜索的key是example.com，返回空</span></span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 10表示构建hash时，是.example.com，并且其后还有下一层hash。其允许搜索的是example.com，因此返回value对应的ngx_hash_wildcard_t中的value数据</span></span><br><span class="line">                hwc = (<span class="keyword">ngx_hash_wildcard_t</span> *)</span><br><span class="line">                                          ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 恢复原指针，进行向下查找</span></span><br><span class="line">            hwc = (<span class="keyword">ngx_hash_wildcard_t</span> *) ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">            value = ngx_hash_find_wc_head(hwc, name, n - <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (value) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没找到，则返回value对应的ngx_hash_wildcard_t中的value数据（有可能为空）</span></span><br><span class="line">            <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 01表示构建表的时候，是*.example.com，且其后没有下一层hash表了</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 而当前搜索的key是example.com，返回空</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* "example.com" */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 01表示构建表的时候，是.example.com，且其后没有下一层hash表了，其存储的是普通数据</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是00，表示就是普通数据</span></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果hash表中没有对应切割的数据，那么返回当前层级hash表结构ngx_hash_wildcard_t的value值。有可能为空，因为查找时找最长匹配，如果后面没有对应的匹配，则使用当前层级的hash对应数据（有可能为null）。</span></span><br><span class="line">    <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-queue-t双向循环链表"><a href="#ngx-queue-t双向循环链表" class="headerlink" title="ngx_queue_t双向循环链表"></a>ngx_queue_t双向循环链表</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span>  <span class="title">ngx_queue_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *prev; <span class="comment">// 指向前一个元素的指针</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *next; <span class="comment">// 指向后一个元素的指针</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ngx_queue_s维持了双向链表，忽略了其实际元素的内容，不负责链表元素的内存分配。要想使用双向链表，则要求我们定义的类能够通过指针转换为ngx_queue_s，因此其必须包含<code>*prev</code>和<code>*next</code>。此时可以直接通过指针来进行转换。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_test</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *prev;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *next;</span><br><span class="line">    <span class="keyword">int</span> num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">my_test a;</span><br><span class="line">a.prev = &amp;a;</span><br><span class="line">a.next = &amp;a;</span><br><span class="line">ngx_queue_s *q = (ngx_queue_s *)&amp;a</span><br></pre></td></tr></table></figure>
<p>注意双向循环链表存在一个维护双向链表结构的节点，该节点不存储数据，只是作为维护结构的节点。后续参数中h，表示维护链表的节点，参数为q表示存储数据的节点。</p>
<h3 id="初始化双向循环链表：ngx-queue-init-q"><a href="#初始化双向循环链表：ngx-queue-init-q" class="headerlink" title="初始化双向循环链表：ngx_queue_init(q)"></a>初始化双向循环链表：ngx_queue_init(q)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_init(q)                                                     \</span><br><span class="line">    (q)-&gt;prev = q;                                                            \</span><br><span class="line">    (q)-&gt;next = q</span><br></pre></td></tr></table></figure>
<p>q为链表容器结构ngx_queue_s。</p>
<h3 id="判空：ngx-queue-empty-h"><a href="#判空：ngx-queue-empty-h" class="headerlink" title="判空：ngx_queue_empty(h)"></a>判空：ngx_queue_empty(h)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_empty(h)                                                    \</span><br><span class="line">    (h == (h)-&gt;prev)</span><br></pre></td></tr></table></figure>
<p>由于是循环链表，因此只需要判断任意一个链表元素的前驱是否为自身即可。这里使用的是维护结构的节点。</p>
<h3 id="在头部插入元素：ngx-queue-insert-head（h，x）"><a href="#在头部插入元素：ngx-queue-insert-head（h，x）" class="headerlink" title="在头部插入元素：ngx_queue_insert_head（h，x）"></a>在头部插入元素：ngx_queue_insert_head（h，x）</h3><p>在维护链表的节点后增加一个元素，即为在链表头插入元素。：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_insert_head(h, x)                                           \</span><br><span class="line">    (x)-&gt;next = (h)-&gt;next;                                                    \</span><br><span class="line">    (x)-&gt;next-&gt;prev = x;                                                      \</span><br><span class="line">    (x)-&gt;prev = h;                                                            \</span><br><span class="line">    (h)-&gt;next = x</span><br></pre></td></tr></table></figure>
<h3 id="在尾部插入节点：ngx-queue-insert-tail（h，x）"><a href="#在尾部插入节点：ngx-queue-insert-tail（h，x）" class="headerlink" title="在尾部插入节点：ngx_queue_insert_tail（h，x）"></a>在尾部插入节点：ngx_queue_insert_tail（h，x）</h3><p>在维护链表的节点前插入一个元素，即为在链表尾部插入元素（双向的作用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_insert_tail(h, x)                                           \</span><br><span class="line">    (x)-&gt;prev = (h)-&gt;prev;                                                    \</span><br><span class="line">    (x)-&gt;prev-&gt;next = x;                                                      \</span><br><span class="line">    (x)-&gt;next = h;                                                            \</span><br><span class="line">    (h)-&gt;prev = x</span><br></pre></td></tr></table></figure>
<h3 id="获取列表第一个元素：ngx-queue-head-h"><a href="#获取列表第一个元素：ngx-queue-head-h" class="headerlink" title="获取列表第一个元素：ngx_queue_head(h)"></a>获取列表第一个元素：ngx_queue_head(h)</h3><p>维护链表节点的后一个元素即为首尾元素：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_head(h)                                                     \</span><br><span class="line">    (h)-&gt;next</span><br></pre></td></tr></table></figure>
<h3 id="获取列表中最后一个元素：ngx-queue-last-h"><a href="#获取列表中最后一个元素：ngx-queue-last-h" class="headerlink" title="获取列表中最后一个元素：ngx_queue_last(h)"></a>获取列表中最后一个元素：ngx_queue_last(h)</h3><p>维护链表节点的前一个元素即为首尾元素：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_last(h)                                                     \</span><br><span class="line">    (h)-&gt;prev</span><br></pre></td></tr></table></figure>
<h3 id="返回链表容器结构体指针：ngx-queue-sentinel-h"><a href="#返回链表容器结构体指针：ngx-queue-sentinel-h" class="headerlink" title="返回链表容器结构体指针：ngx_queue_sentinel(h)"></a>返回链表容器结构体指针：ngx_queue_sentinel(h)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_queue_sentinel(h)                                                 \</span></span><br><span class="line">    (h)</span><br></pre></td></tr></table></figure>
<p>常在循环中判断终止。</p>
<h3 id="获取当前元素的下一个元素：ngx-queue-next-q"><a href="#获取当前元素的下一个元素：ngx-queue-next-q" class="headerlink" title="获取当前元素的下一个元素：ngx_queue_next(q)"></a>获取当前元素的下一个元素：ngx_queue_next(q)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_next(q)                                                     \</span><br><span class="line">    (q)-&gt;next</span><br></pre></td></tr></table></figure>
<h3 id="获取当前元素的上一个元素：ngx-queue-prev-q"><a href="#获取当前元素的上一个元素：ngx-queue-prev-q" class="headerlink" title="获取当前元素的上一个元素：ngx_queue_prev(q)"></a>获取当前元素的上一个元素：ngx_queue_prev(q)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_prev(q)                                                     \</span><br><span class="line">    (q)-&gt;prev</span><br></pre></td></tr></table></figure>
<h3 id="移出元素：ngx-queue-remove-x"><a href="#移出元素：ngx-queue-remove-x" class="headerlink" title="移出元素：ngx_queue_remove(x)"></a>移出元素：ngx_queue_remove(x)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_remove(x)                                                   \</span><br><span class="line">    (x)-&gt;next-&gt;prev = (x)-&gt;prev;                                              \</span><br><span class="line">    (x)-&gt;prev-&gt;next = (x)-&gt;next</span><br></pre></td></tr></table></figure>
<h3 id="拆分链表：ngx-queue-split-h-q-n"><a href="#拆分链表：ngx-queue-split-h-q-n" class="headerlink" title="拆分链表：ngx_queue_split(h, q, n)"></a>拆分链表：ngx_queue_split(h, q, n)</h3><p>h为维护链表节点，q为其中一个元素，该方法将链表切割成两部分，通过q进行切割成两个链表h和n，前半部分h由原链表的前半部分构成（不包含q），n链表由原链表的后半部分组成，q为其首元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_split(h, q, n)                                              \</span><br><span class="line">    (n)-&gt;prev = (h)-&gt;prev;                                                    \</span><br><span class="line">    (n)-&gt;prev-&gt;next = n;                                                      \</span><br><span class="line">    (n)-&gt;next = q;                                                            \</span><br><span class="line">    (h)-&gt;prev = (q)-&gt;prev;                                                    \</span><br><span class="line">    (h)-&gt;prev-&gt;next = h;                                                      \</span><br><span class="line">    (q)-&gt;prev = n;</span><br></pre></td></tr></table></figure>
<h3 id="合并链表：ngx-queue-add-h-n"><a href="#合并链表：ngx-queue-add-h-n" class="headerlink" title="合并链表：ngx_queue_add(h, n)"></a>合并链表：ngx_queue_add(h, n)</h3><p>将n链表添加到h链表的末尾。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_add(h, n)                                                   \</span><br><span class="line">    (h)-&gt;prev-&gt;next = (n)-&gt;next;                                              \</span><br><span class="line">    (n)-&gt;next-&gt;prev = (h)-&gt;prev;                                              \</span><br><span class="line">    (h)-&gt;prev = (n)-&gt;prev;                                                    \</span><br><span class="line">    (h)-&gt;prev-&gt;next = h;</span><br></pre></td></tr></table></figure>
<h3 id="返回元素对应的地址：ngx-queue-data-q-type-link"><a href="#返回元素对应的地址：ngx-queue-data-q-type-link" class="headerlink" title="返回元素对应的地址：ngx_queue_data(q, type, link)"></a>返回元素对应的地址：ngx_queue_data(q, type, link)</h3><p>对应能够转换为ngx_queue_t的元素，使用该方法，通过元素内容，获取ngx_queue_t的起始地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_data(q, type, link)                                         \</span><br><span class="line">    (type *) ((u_char *) q - offsetof(type, link))</span><br></pre></td></tr></table></figure>
<h3 id="在指定元素后插入内容：ngx-queue-insert-after-h-x"><a href="#在指定元素后插入内容：ngx-queue-insert-after-h-x" class="headerlink" title="在指定元素后插入内容：ngx_queue_insert_after(h, x)"></a>在指定元素后插入内容：ngx_queue_insert_after(h, x)</h3><p>与ngx_queue_insert_head类似，不过一个是维护链表的节点，一个是存储数据的节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_queue_insert_after   ngx_queue_insert_head</span><br></pre></td></tr></table></figure>
<h3 id="返回链表中心元素：ngx-queue-middle-ngx-queue-t-queue"><a href="#返回链表中心元素：ngx-queue-middle-ngx-queue-t-queue" class="headerlink" title="返回链表中心元素：ngx_queue_middle(ngx_queue_t *queue)"></a>返回链表中心元素：ngx_queue_middle(ngx_queue_t *queue)</h3><p>其处理方式为，分配两个指针middle和next，都从头开始遍历链表，让next一次走两步，middle一个走一步，当next走到终点时，milddle就是中间节点。具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_queue_t</span> *</span><br><span class="line">ngx_queue_middle(<span class="keyword">ngx_queue_t</span> *<span class="built_in">queue</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *middle, *next;</span><br><span class="line"></span><br><span class="line">    middle = ngx_queue_head(<span class="built_in">queue</span>);</span><br><span class="line">    <span class="comment">// 判断是否只有一个元素</span></span><br><span class="line">    <span class="keyword">if</span> (middle == ngx_queue_last(<span class="built_in">queue</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next = ngx_queue_head(<span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// middle先走一步</span></span><br><span class="line">        middle = ngx_queue_next(middle);</span><br><span class="line">        <span class="comment">// next走第一步</span></span><br><span class="line">        next = ngx_queue_next(next);</span><br><span class="line">        <span class="comment">// 判断next是否到末尾</span></span><br><span class="line">        <span class="keyword">if</span> (next == ngx_queue_last(<span class="built_in">queue</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> middle;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// next再走一步，并判断是否到末尾</span></span><br><span class="line">        next = ngx_queue_next(next);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next == ngx_queue_last(<span class="built_in">queue</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> middle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="对链表排序：ngx-queue-sort"><a href="#对链表排序：ngx-queue-sort" class="headerlink" title="对链表排序：ngx_queue_sort"></a>对链表排序：ngx_queue_sort</h3><p>按照指定排序方式对链表排序：采用稳定的插入排序算法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_queue_sort(<span class="keyword">ngx_queue_t</span> *<span class="built_in">queue</span>,</span><br><span class="line">    <span class="keyword">ngx_int_t</span> (*cmp)(<span class="keyword">const</span> <span class="keyword">ngx_queue_t</span> *, <span class="keyword">const</span> <span class="keyword">ngx_queue_t</span> *))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *q, *prev, *next;</span><br><span class="line"></span><br><span class="line">    q = ngx_queue_head(<span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (q == ngx_queue_last(<span class="built_in">queue</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历链表</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_next(q); q != ngx_queue_sentinel(<span class="built_in">queue</span>); q = next) &#123;</span><br><span class="line"></span><br><span class="line">        prev = ngx_queue_prev(q);</span><br><span class="line">        <span class="comment">// 记录下一个要遍历的节点</span></span><br><span class="line">        next = ngx_queue_next(q);</span><br><span class="line">        <span class="comment">// 先移出节点q</span></span><br><span class="line">        ngx_queue_remove(q);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 找到在q前面第一个无序的节点</span></span><br><span class="line">            <span class="keyword">if</span> (cmp(prev, q) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            prev = ngx_queue_prev(prev);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> (prev != ngx_queue_sentinel(<span class="built_in">queue</span>));</span><br><span class="line">        <span class="comment">// 在第一个无序节点后添加q</span></span><br><span class="line">        ngx_queue_insert_after(prev, q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="红黑树ngx-rbtree-node-t"><a href="#红黑树ngx-rbtree-node-t" class="headerlink" title="红黑树ngx_rbtree_node_t"></a>红黑树ngx_rbtree_node_t</h2><p>关于红黑树具体介绍及代码实现可以参考如下文档：<a href="http://www.yinkuiwang.cn/2019/06/13/%E7%BA%A2%E9%BB%91%E6%A0%91/" target="_blank" rel="noopener">红黑树</a>。</p>
<h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">ngx_uint_t</span>  <span class="keyword">ngx_rbtree_key_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">ngx_int_t</span>   <span class="keyword">ngx_rbtree_key_int_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_rbtree_node_s</span>  <span class="title">ngx_rbtree_node_t</span>;</span></span><br><span class="line"><span class="comment">// 节点类</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_rbtree_node_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// 无符合整型关键字，排序依据</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_key_t</span>       key;</span><br><span class="line">    <span class="comment">// 左子树</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>     *left;</span><br><span class="line">    <span class="comment">// 右子树</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>     *right;</span><br><span class="line">    <span class="comment">// 父节点</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>     *parent;</span><br><span class="line">    <span class="comment">// 节点颜色 0表示红色，1表示黑色</span></span><br><span class="line">    u_char                 color;</span><br><span class="line">    <span class="comment">// 仅一个字节的节点数据。由于表示空间过小，很少使用</span></span><br><span class="line">    u_char                 data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_rbtree_s</span>  <span class="title">ngx_rbtree_t</span>;</span></span><br><span class="line"><span class="comment">// 为解决不同节点含有相同关键字的元素冲突问题，红黑树设置了ngx_rbtree_insert_pt指针来灵活地添加冲突元素</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_rbtree_insert_pt)</span> <span class="params">(<span class="keyword">ngx_rbtree_node_t</span> *root,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_rbtree_node_t</span> *node, <span class="keyword">ngx_rbtree_node_t</span> *sentinel)</span></span>;</span><br><span class="line"><span class="comment">// 红黑树容器</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_rbtree_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// 根节点</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>     *root;</span><br><span class="line">    <span class="comment">// 哨兵节点</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>     *sentinel;</span><br><span class="line">    <span class="comment">// 指示红黑树添加元素的指针函数，其决定在添加新节点时的行为是替换还是新增</span></span><br><span class="line">    ngx_rbtree_insert_pt   insert;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对应节点来说，与之前的结构类似，存储数据要依托于ngx_rbtree_node_s结构，因此可以自定义节点元素，但是必须包含ngx_rbtree_node_s结构，以使得方便结构体强制转换为ngx_rbtree_node_s结构。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span> node;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="红黑树节点提供的方法"><a href="#红黑树节点提供的方法" class="headerlink" title="红黑树节点提供的方法"></a>红黑树节点提供的方法</h3><h4 id="设置节点颜色"><a href="#设置节点颜色" class="headerlink" title="设置节点颜色"></a>设置节点颜色</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_rbt_red(node)               ((node)-&gt;color = 1)</span><br><span class="line">#define ngx_rbt_black(node)             ((node)-&gt;color = 0)</span><br></pre></td></tr></table></figure>
<h4 id="判断节点颜色"><a href="#判断节点颜色" class="headerlink" title="判断节点颜色"></a>判断节点颜色</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_rbt_is_red(node)            ((node)-&gt;color)</span><br><span class="line">#define ngx_rbt_is_black(node)          (!ngx_rbt_is_red(node))</span><br></pre></td></tr></table></figure>
<h4 id="拷贝节点颜色"><a href="#拷贝节点颜色" class="headerlink" title="拷贝节点颜色"></a>拷贝节点颜色</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_rbt_copy_color(n1, n2)      (n1-&gt;color = n2-&gt;color)</span><br></pre></td></tr></table></figure>
<p>将n1节点变更为与n2一样。</p>
<h4 id="初始化哨兵节点"><a href="#初始化哨兵节点" class="headerlink" title="初始化哨兵节点"></a>初始化哨兵节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_rbtree_sentinel_init(node)  ngx_rbt_black(node)</span><br></pre></td></tr></table></figure>
<p>哨兵节点为黑色节点，因此设置节点为黑色即可。</p>
<h4 id="查找子树中最小节点"><a href="#查找子树中最小节点" class="headerlink" title="查找子树中最小节点"></a>查找子树中最小节点</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">ngx_rbtree_node_t</span> *</span><br><span class="line">ngx_rbtree_min(<span class="keyword">ngx_rbtree_node_t</span> *node, <span class="keyword">ngx_rbtree_node_t</span> *sentinel)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (node-&gt;left != sentinel) &#123;</span><br><span class="line">        node = node-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以key为关键字，查找最小的一个节点。</p>
<h3 id="红黑树容器提供的方法"><a href="#红黑树容器提供的方法" class="headerlink" title="红黑树容器提供的方法"></a>红黑树容器提供的方法</h3><h4 id="初始化红黑树ngx-rbtree-init"><a href="#初始化红黑树ngx-rbtree-init" class="headerlink" title="初始化红黑树ngx_rbtree_init"></a>初始化红黑树ngx_rbtree_init</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_rbtree_init(tree, s, i)                                           \</span><br><span class="line">    ngx_rbtree_sentinel_init(s);                                              \</span><br><span class="line">    (tree)-&gt;root = s;                                                         \</span><br><span class="line">    (tree)-&gt;sentinel = s;                                                     \</span><br><span class="line">    (tree)-&gt;insert = i</span><br></pre></td></tr></table></figure>
<p>参数tree是红黑树容器指针，s是哨兵节点指针，i为ngx_rbtree_insert_pt类型的节点添加方法。</p>
<h4 id="寻找下一个元素ngx-rbtree-next"><a href="#寻找下一个元素ngx-rbtree-next" class="headerlink" title="寻找下一个元素ngx_rbtree_next"></a>寻找下一个元素ngx_rbtree_next</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在tree容器中，找到第一个比node大的元素</span></span><br><span class="line"><span class="keyword">ngx_rbtree_node_t</span> *</span><br><span class="line">ngx_rbtree_next(<span class="keyword">ngx_rbtree_t</span> *tree, <span class="keyword">ngx_rbtree_node_t</span> *node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  *root, *sentinel, *parent;</span><br><span class="line"></span><br><span class="line">    sentinel = tree-&gt;sentinel;</span><br><span class="line">    <span class="comment">// node节点如果存在又子树，则比node节点大的第一个元素为其右子树的最小值</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;right != sentinel) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_rbtree_min(node-&gt;right, sentinel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果node节点不存在右子树，则向上查找其父辈节点，找到第一个使node节点处于其左子树的父节点。如果没有，则说明node自身为最大的节点，不存在下一个节点</span></span><br><span class="line">    root = tree-&gt;root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        parent = node-&gt;parent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node == root) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node == parent-&gt;left) &#123;</span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node = parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="旋转节点"><a href="#旋转节点" class="headerlink" title="旋转节点"></a>旋转节点</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 左旋</span></span><br><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">void</span></span><br><span class="line">ngx_rbtree_left_rotate(<span class="keyword">ngx_rbtree_node_t</span> **root, <span class="keyword">ngx_rbtree_node_t</span> *sentinel,</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span> *node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  *temp;</span><br><span class="line"></span><br><span class="line">    temp = node-&gt;right;</span><br><span class="line">    node-&gt;right = temp-&gt;left;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (temp-&gt;left != sentinel) &#123;</span><br><span class="line">        temp-&gt;left-&gt;parent = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp-&gt;parent = node-&gt;parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node == *root) &#123;</span><br><span class="line">        *root = temp;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node == node-&gt;parent-&gt;left) &#123;</span><br><span class="line">        node-&gt;parent-&gt;left = temp;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node-&gt;parent-&gt;right = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp-&gt;left = node;</span><br><span class="line">    node-&gt;parent = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 右旋</span></span><br><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">void</span></span><br><span class="line">ngx_rbtree_right_rotate(<span class="keyword">ngx_rbtree_node_t</span> **root, <span class="keyword">ngx_rbtree_node_t</span> *sentinel,</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span> *node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  *temp;</span><br><span class="line"></span><br><span class="line">    temp = node-&gt;left;</span><br><span class="line">    node-&gt;left = temp-&gt;right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (temp-&gt;right != sentinel) &#123;</span><br><span class="line">        temp-&gt;right-&gt;parent = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp-&gt;parent = node-&gt;parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node == *root) &#123;</span><br><span class="line">        *root = temp;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node == node-&gt;parent-&gt;right) &#123;</span><br><span class="line">        node-&gt;parent-&gt;right = temp;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node-&gt;parent-&gt;left = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp-&gt;right = node;</span><br><span class="line">    node-&gt;parent = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于节点旋转，这里不详细介绍，具体参考文档：<a href="http://www.yinkuiwang.cn/2019/06/13/%E7%BA%A2%E9%BB%91%E6%A0%91/" target="_blank" rel="noopener">红黑树</a>。</p>
<h4 id="添加节点ngx-rbtree-insert"><a href="#添加节点ngx-rbtree-insert" class="headerlink" title="添加节点ngx_rbtree_insert"></a>添加节点ngx_rbtree_insert</h4><p>向红黑树容器中增加节点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_rbtree_insert(<span class="keyword">ngx_rbtree_t</span> *tree, <span class="keyword">ngx_rbtree_node_t</span> *node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  **root, *temp, *sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* a binary tree insert */</span></span><br><span class="line"></span><br><span class="line">    root = &amp;tree-&gt;root;</span><br><span class="line">    sentinel = tree-&gt;sentinel;</span><br><span class="line">    <span class="comment">// 如果红黑树为空，则直接设置root节点即可</span></span><br><span class="line">    <span class="keyword">if</span> (*root == sentinel) &#123;</span><br><span class="line">        node-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">        node-&gt;left = sentinel;</span><br><span class="line">        node-&gt;right = sentinel;</span><br><span class="line">        ngx_rbt_black(node);</span><br><span class="line">        *root = node;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则，调用容器的ngx_rbtree_insert_pt函数，向其中增加节点</span></span><br><span class="line">    tree-&gt;insert(*root, node, sentinel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* re-balance tree */</span></span><br><span class="line">    <span class="comment">// 增加节点后导致红黑树无法满足原性质，进行调整。</span></span><br><span class="line">    <span class="keyword">while</span> (node != *root &amp;&amp; ngx_rbt_is_red(node-&gt;parent)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;parent == node-&gt;parent-&gt;parent-&gt;left) &#123;</span><br><span class="line">            temp = node-&gt;parent-&gt;parent-&gt;right;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_rbt_is_red(temp)) &#123;</span><br><span class="line">                ngx_rbt_black(node-&gt;parent);</span><br><span class="line">                ngx_rbt_black(temp);</span><br><span class="line">                ngx_rbt_red(node-&gt;parent-&gt;parent);</span><br><span class="line">                node = node-&gt;parent-&gt;parent;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (node == node-&gt;parent-&gt;right) &#123;</span><br><span class="line">                    node = node-&gt;parent;</span><br><span class="line">                    ngx_rbtree_left_rotate(root, sentinel, node);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_rbt_black(node-&gt;parent);</span><br><span class="line">                ngx_rbt_red(node-&gt;parent-&gt;parent);</span><br><span class="line">                ngx_rbtree_right_rotate(root, sentinel, node-&gt;parent-&gt;parent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp = node-&gt;parent-&gt;parent-&gt;left;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_rbt_is_red(temp)) &#123;</span><br><span class="line">                ngx_rbt_black(node-&gt;parent);</span><br><span class="line">                ngx_rbt_black(temp);</span><br><span class="line">                ngx_rbt_red(node-&gt;parent-&gt;parent);</span><br><span class="line">                node = node-&gt;parent-&gt;parent;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (node == node-&gt;parent-&gt;left) &#123;</span><br><span class="line">                    node = node-&gt;parent;</span><br><span class="line">                    ngx_rbtree_right_rotate(root, sentinel, node);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_rbt_black(node-&gt;parent);</span><br><span class="line">                ngx_rbt_red(node-&gt;parent-&gt;parent);</span><br><span class="line">                ngx_rbtree_left_rotate(root, sentinel, node-&gt;parent-&gt;parent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_rbt_black(*root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx提供了三种ngx_rbtree_insert_pt方法来增加元素，后续会详细介绍，关于如果重新平衡二叉树，也参考文档即可：<a href="http://www.yinkuiwang.cn/2019/06/13/%E7%BA%A2%E9%BB%91%E6%A0%91/" target="_blank" rel="noopener">红黑树</a>。</p>
<h4 id="删除元素"><a href="#删除元素" class="headerlink" title="删除元素"></a>删除元素</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_rbtree_delete(<span class="keyword">ngx_rbtree_t</span> *tree, <span class="keyword">ngx_rbtree_node_t</span> *node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>           red;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  **root, *sentinel, *subst, *temp, *w;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* a binary tree delete */</span></span><br><span class="line"></span><br><span class="line">    root = &amp;tree-&gt;root;</span><br><span class="line">    sentinel = tree-&gt;sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;left == sentinel) &#123;</span><br><span class="line">        temp = node-&gt;right;</span><br><span class="line">        subst = node;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;right == sentinel) &#123;</span><br><span class="line">        temp = node-&gt;left;</span><br><span class="line">        subst = node;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subst = ngx_rbtree_min(node-&gt;right, sentinel);</span><br><span class="line">        temp = subst-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subst == *root) &#123;</span><br><span class="line">        *root = temp;</span><br><span class="line">        ngx_rbt_black(temp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* DEBUG stuff */</span></span><br><span class="line">        node-&gt;left = <span class="literal">NULL</span>;</span><br><span class="line">        node-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">        node-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">        node-&gt;key = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    red = ngx_rbt_is_red(subst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subst == subst-&gt;parent-&gt;left) &#123;</span><br><span class="line">        subst-&gt;parent-&gt;left = temp;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subst-&gt;parent-&gt;right = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subst == node) &#123;</span><br><span class="line"></span><br><span class="line">        temp-&gt;parent = subst-&gt;parent;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (subst-&gt;parent == node) &#123;</span><br><span class="line">            temp-&gt;parent = subst;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp-&gt;parent = subst-&gt;parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        subst-&gt;left = node-&gt;left;</span><br><span class="line">        subst-&gt;right = node-&gt;right;</span><br><span class="line">        subst-&gt;parent = node-&gt;parent;</span><br><span class="line">        ngx_rbt_copy_color(subst, node);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node == *root) &#123;</span><br><span class="line">            *root = subst;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (node == node-&gt;parent-&gt;left) &#123;</span><br><span class="line">                node-&gt;parent-&gt;left = subst;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                node-&gt;parent-&gt;right = subst;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (subst-&gt;left != sentinel) &#123;</span><br><span class="line">            subst-&gt;left-&gt;parent = subst;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (subst-&gt;right != sentinel) &#123;</span><br><span class="line">            subst-&gt;right-&gt;parent = subst;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DEBUG stuff */</span></span><br><span class="line">    node-&gt;left = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;key = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (red) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* a delete fixup */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (temp != *root &amp;&amp; ngx_rbt_is_black(temp)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (temp == temp-&gt;parent-&gt;left) &#123;</span><br><span class="line">            w = temp-&gt;parent-&gt;right;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_rbt_is_red(w)) &#123;</span><br><span class="line">                ngx_rbt_black(w);</span><br><span class="line">                ngx_rbt_red(temp-&gt;parent);</span><br><span class="line">                ngx_rbtree_left_rotate(root, sentinel, temp-&gt;parent);</span><br><span class="line">                w = temp-&gt;parent-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_rbt_is_black(w-&gt;left) &amp;&amp; ngx_rbt_is_black(w-&gt;right)) &#123;</span><br><span class="line">                ngx_rbt_red(w);</span><br><span class="line">                temp = temp-&gt;parent;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_rbt_is_black(w-&gt;right)) &#123;</span><br><span class="line">                    ngx_rbt_black(w-&gt;left);</span><br><span class="line">                    ngx_rbt_red(w);</span><br><span class="line">                    ngx_rbtree_right_rotate(root, sentinel, w);</span><br><span class="line">                    w = temp-&gt;parent-&gt;right;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_rbt_copy_color(w, temp-&gt;parent);</span><br><span class="line">                ngx_rbt_black(temp-&gt;parent);</span><br><span class="line">                ngx_rbt_black(w-&gt;right);</span><br><span class="line">                ngx_rbtree_left_rotate(root, sentinel, temp-&gt;parent);</span><br><span class="line">                temp = *root;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w = temp-&gt;parent-&gt;left;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_rbt_is_red(w)) &#123;</span><br><span class="line">                ngx_rbt_black(w);</span><br><span class="line">                ngx_rbt_red(temp-&gt;parent);</span><br><span class="line">                ngx_rbtree_right_rotate(root, sentinel, temp-&gt;parent);</span><br><span class="line">                w = temp-&gt;parent-&gt;left;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_rbt_is_black(w-&gt;left) &amp;&amp; ngx_rbt_is_black(w-&gt;right)) &#123;</span><br><span class="line">                ngx_rbt_red(w);</span><br><span class="line">                temp = temp-&gt;parent;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_rbt_is_black(w-&gt;left)) &#123;</span><br><span class="line">                    ngx_rbt_black(w-&gt;right);</span><br><span class="line">                    ngx_rbt_red(w);</span><br><span class="line">                    ngx_rbtree_left_rotate(root, sentinel, w);</span><br><span class="line">                    w = temp-&gt;parent-&gt;left;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_rbt_copy_color(w, temp-&gt;parent);</span><br><span class="line">                ngx_rbt_black(temp-&gt;parent);</span><br><span class="line">                ngx_rbt_black(w-&gt;left);</span><br><span class="line">                ngx_rbtree_right_rotate(root, sentinel, temp-&gt;parent);</span><br><span class="line">                temp = *root;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_rbt_black(temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>删除元素这里也不过多介绍，阅读文档即可。</p>
<h4 id="架构提供的三个ngx-rbtree-insert-pt增加节点函数。"><a href="#架构提供的三个ngx-rbtree-insert-pt增加节点函数。" class="headerlink" title="架构提供的三个ngx_rbtree_insert_pt增加节点函数。"></a>架构提供的三个ngx_rbtree_insert_pt增加节点函数。</h4><h5 id="ngx-rbtree-insert-value"><a href="#ngx-rbtree-insert-value" class="headerlink" title="ngx_rbtree_insert_value"></a>ngx_rbtree_insert_value</h5><p>使用场景：向红黑树中增加数据节点，每个数据节点的关键字都是唯一的，不存在同一个关键字有多个节点的情况。</p>
<p>逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_rbtree_insert_value(<span class="keyword">ngx_rbtree_node_t</span> *temp, <span class="keyword">ngx_rbtree_node_t</span> *node,</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span> *sentinel)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  **p;</span><br><span class="line">    <span class="comment">// 自订向下查找，遇到比自己的key大的节点就进入左子树继续查找，遇到比自己小的节点就到右子树继续查找，直到哨兵节点，决定添加位置。</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        p = (node-&gt;key &lt; temp-&gt;key) ? &amp;temp-&gt;left : &amp;temp-&gt;right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*p == sentinel) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        temp = *p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *p = node;</span><br><span class="line">    <span class="comment">// 添加节点，设置节点为红色</span></span><br><span class="line">    node-&gt;parent = temp;</span><br><span class="line">    node-&gt;left = sentinel;</span><br><span class="line">    node-&gt;right = sentinel;</span><br><span class="line">    ngx_rbt_red(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-rbtree-insert-timer-value"><a href="#ngx-rbtree-insert-timer-value" class="headerlink" title="ngx_rbtree_insert_timer_value"></a>ngx_rbtree_insert_timer_value</h5><p>该函数向红黑树添加数据节点，每个节点的关键字表示时间或者时间差。因此其中的key可能为负数。这是并不关心是否有重复的key。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_rbtree_insert_timer_value(<span class="keyword">ngx_rbtree_node_t</span> *temp, <span class="keyword">ngx_rbtree_node_t</span> *node,</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span> *sentinel)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  **p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Timer values</span></span><br><span class="line"><span class="comment">         * 1) are spread in small range, usually several minutes,</span></span><br><span class="line"><span class="comment">         * 2) and overflow each 49 days, if milliseconds are stored in 32 bits.</span></span><br><span class="line"><span class="comment">         * The comparison takes into account that overflow.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*  node-&gt;key &lt; temp-&gt;key */</span></span><br><span class="line"></span><br><span class="line">        p = ((<span class="keyword">ngx_rbtree_key_int_t</span>) (node-&gt;key - temp-&gt;key) &lt; <span class="number">0</span>)</span><br><span class="line">            ? &amp;temp-&gt;left : &amp;temp-&gt;right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*p == sentinel) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        temp = *p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *p = node;</span><br><span class="line">    node-&gt;parent = temp;</span><br><span class="line">    node-&gt;left = sentinel;</span><br><span class="line">    node-&gt;right = sentinel;</span><br><span class="line">    ngx_rbt_red(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与ngx_rbtree_insert_value逻辑一致，只是做了一个ngx_rbtree_key_int_t的强制类型转换，支持负数。</p>
<h5 id="ngx-str-rbtree-insert-value"><a href="#ngx-str-rbtree-insert-value" class="headerlink" title="ngx_str_rbtree_insert_value"></a>ngx_str_rbtree_insert_value</h5><p>向红黑树中增加节点，每个数据节点的关键字可以不唯一，但是以字符串作为唯一标识，存放在ngx_str_node_t的str中。ngx_str_node_t定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>         node;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 str;</span><br><span class="line">&#125; <span class="keyword">ngx_str_node_t</span>;</span><br></pre></td></tr></table></figure>
<p>对应的插入方法为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_str_rbtree_insert_value(<span class="keyword">ngx_rbtree_node_t</span> *temp,</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span> *node, <span class="keyword">ngx_rbtree_node_t</span> *sentinel)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_str_node_t</span>      *n, *t;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  **p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        n = (<span class="keyword">ngx_str_node_t</span> *) node;</span><br><span class="line">        t = (<span class="keyword">ngx_str_node_t</span> *) temp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;key != temp-&gt;key) &#123;</span><br><span class="line"></span><br><span class="line">            p = (node-&gt;key &lt; temp-&gt;key) ? &amp;temp-&gt;left : &amp;temp-&gt;right;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n-&gt;str.len != t-&gt;str.len) &#123;</span><br><span class="line"></span><br><span class="line">            p = (n-&gt;str.len &lt; t-&gt;str.len) ? &amp;temp-&gt;left : &amp;temp-&gt;right;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p = (ngx_memcmp(n-&gt;str.data, t-&gt;str.data, n-&gt;str.len) &lt; <span class="number">0</span>)</span><br><span class="line">                 ? &amp;temp-&gt;left : &amp;temp-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*p == sentinel) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        temp = *p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *p = node;</span><br><span class="line">    node-&gt;parent = temp;</span><br><span class="line">    node-&gt;left = sentinel;</span><br><span class="line">    node-&gt;right = sentinel;</span><br><span class="line">    ngx_rbt_red(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与前两个类似，但是增加了对str的比较。</p>
<h1 id="Nginx特殊技巧"><a href="#Nginx特殊技巧" class="headerlink" title="Nginx特殊技巧"></a>Nginx特殊技巧</h1><h2 id="ngx-align-值对齐宏"><a href="#ngx-align-值对齐宏" class="headerlink" title="ngx_align 值对齐宏"></a>ngx_align 值对齐宏</h2><p>ngx_align 为nginx中的一个值对齐宏。主要在需要内存申请的地方使用，为了减少在不同的 cache line 中内存而生。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// d 为需要对齐的</span></span><br><span class="line"><span class="comment">// a 为对齐宽度，必须为 2 的幂</span></span><br><span class="line"><span class="comment">// 返回对齐值</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_align(d, a)     (((d) + (a - 1)) &amp; ~(a - 1))</span></span><br></pre></td></tr></table></figure>
<p>原理简单，利用 <code>~(a - 1)</code> 的低位全为 0。在与 <code>~(a - 1)</code> 做 <code>&amp;</code> 操作时，低位的1被丢弃，就得到了a倍数的值（对齐）。</p>
<p>如果使用原始值直接与 <code>~(a - 1)</code> 做 <code>&amp;</code> 操作，那么得到的对齐值是会小于等于原始值的，这样会造成内存重叠，而期望的对齐值是一个大于等于原始值的，所以需要加上一个数来补上至对齐值这中间的差，这个数为 <code>(a - 1)</code> ，选择这个数的原因是 <code>(a - 1) &amp; ~(a - 1)</code> 的结果为0。</p>
<p>该操作含义为：取大于d且为a整数倍的第一个数。</p>
<h2 id="ngx-align-ptr内存对其"><a href="#ngx-align-ptr内存对其" class="headerlink" title="ngx_align_ptr内存对其"></a>ngx_align_ptr内存对其</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_align_ptr(p, a)                                                   \</span></span><br><span class="line">    (u_char *) (((<span class="keyword">uintptr_t</span>) (p) + ((<span class="keyword">uintptr_t</span>) a - <span class="number">1</span>)) &amp; ~((<span class="keyword">uintptr_t</span>) a - <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<p>这里和上面都存储对其类似，a一般是cache line大小。对其后，指针指向cache line的整数倍的地方，加快读取速度。具体参考下面文章。</p>
<p><a href="https://oopschen.github.io/posts/2013/cpu-cacheline/" target="_blank" rel="noopener">https://oopschen.github.io/posts/2013/cpu-cacheline/</a></p>
<h2 id="指针最后两位一定是0"><a href="#指针最后两位一定是0" class="headerlink" title="指针最后两位一定是0"></a>指针最后两位一定是0</h2><p>字节对齐和系统有关，也和编译器有关，具体到底是几字节对齐和本问题关系不大。主要是因为无论如何对齐，都是字节对齐，而不是bit对齐。也就是说指针的起始存放地址只可能是8的倍数，比如0x00,0x08,0x10,转换成二进制后三位永远是0。不可能出现0x02到0x22作为一个四字节的指针。</p>
<p>ps1：有些资料中将之描述为指针的后2位永远是0，猜想是汇编语言中好像有的语句可以把4bit看作一个基本的操作单位，所以只能保证指针的后2位永远是0。</p>
<p>ps2：是否可以申请一个数组，然后对其中的位进行操作，使之出现一个类似0x02到0x22作为一个四字节指针的情况，将这个畸形的指针传入指针操作API中会导致什么后果，这个问题还有待考证。</p>
<p>出处：<a href="https://www.zhihu.com/question/40636241/answer/311889614" target="_blank" rel="noopener">https://www.zhihu.com/question/40636241/answer/311889614</a></p>
<h2 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h2><p>内联汇编语言可以直接操作硬件。可以用来在nginx源码中实现对整数的原子操作。</p>
<p>使用GCC编译器在C语言中嵌入汇编语言的方式是使用__asm__关键字，语法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">asm__ <span class="title">volatile</span> <span class="params">( 汇编语句部分</span></span></span><br><span class="line"><span class="function"><span class="params">     : 输出部分    <span class="comment">/*可选*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">     : 输入部分    <span class="comment">/*可选*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">     : 破坏描述部分 <span class="comment">/*可选*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">）;</span></span></span><br></pre></td></tr></table></figure>
<p>加入volatile关键字用于限制GCC编译器对这段代码做优化。</p>
<p>内联汇编语言包含四部分：</p>
<ol>
<li><p>汇编语句部分</p>
<p>引号中所包含的汇编语句可以直接用占位符%来引用C语言中的变量（最多10个，%0-%9）。</p>
</li>
<li><p>输出部分</p>
<p>将寄存器中的值设置到C语言的变量中</p>
</li>
<li><p>输入部分</p>
<p>将C语言中的变量设置到寄存器中。</p>
</li>
<li><p>破坏描述部分</p>
<p>通知编译器使用了哪些寄存器、内存。</p>
</li>
</ol>
<p>以如下语句举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">ngx_atomic_uint_t</span></span><br><span class="line">ngx_atomic_cmp_set(<span class="keyword">ngx_atomic_t</span> *lock, <span class="keyword">ngx_atomic_uint_t</span> old,</span><br><span class="line">    <span class="keyword">ngx_atomic_uint_t</span> <span class="built_in">set</span>)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  res;</span><br><span class="line"></span><br><span class="line">    __<span class="function">asm__ <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"    lock                "</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"    cmpxchgl  %3, %1;   "</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"    sete      %0;       "</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    : <span class="string">"=a"</span> (res) : <span class="string">"m"</span> (*lock), <span class="string">"a"</span> (old), <span class="string">"r"</span> (<span class="built_in">set</span>) : <span class="string">"cc"</span>, <span class="string">"memory"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看输入部分：”m” (*lock)表示<em>lock变量是在内存中，操作\</em>lock直接通过内存（不使用寄存器处理）,而”a” (old)表示把old变量写入eax寄存器中，”r” (set)表示把set变量写入通用寄存器中。这些都是为cmpxchgl做准备。</p>
<p>再来看汇编语句部分：”lock”表示在多核架构上首先锁住总线。</p>
<p>cmpxchgl语句含义为如下代码表示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * &quot;cmpxchgl  r, [m]&quot;:</span><br><span class="line"> *</span><br><span class="line"> *     if (eax == [m]) &#123;</span><br><span class="line"> *         zf = 1;</span><br><span class="line"> *         [m] = r;</span><br><span class="line"> *     &#125; else &#123;</span><br><span class="line"> *         zf = 0;</span><br><span class="line"> *         eax = [m];</span><br><span class="line"> *     &#125;</span><br><span class="line"> *</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p>即判断寄存器中的值是否等于[m]，如果相等，则设置[m]为r，并且设置sf为1。否则，设置zf为0，并且设置寄存器中值为[m]。</p>
<p>在语句cmpxchgl  %3, %1;中，寄存器变量为old。%3表示set，%1表示<em>loct。先比较\</em>lock是否等于old，如果相等设置*lock为set。并进行zf设置。</p>
<p>“sete      %0;”表示设置zf值到寄存器变量中。</p>
<p>返回部分”=a” (res)将寄存器中值写入res变量中，返回。</p>
<h1 id="Nginx架构及启动流程"><a href="#Nginx架构及启动流程" class="headerlink" title="Nginx架构及启动流程"></a>Nginx架构及启动流程</h1><h2 id="Nginx的架构设计"><a href="#Nginx的架构设计" class="headerlink" title="Nginx的架构设计"></a>Nginx的架构设计</h2><h3 id="优秀的模块化设计"><a href="#优秀的模块化设计" class="headerlink" title="优秀的模块化设计"></a>优秀的模块化设计</h3><p>高度模块化的设计是Nginx的架构基础。在nginx中，除了少量的核心代码，其他一切皆为模块。其具有如下特点：</p>
<ol>
<li><p>高度抽象的模块接口</p>
<p>所有模块都遵循同样的ngx_module_t接口设计规范，减少了系统变数。</p>
</li>
<li><p>模块接口非常简单，具有高度灵活性</p>
<p>模块的基本接口nginx_module_t足够简单，只设计模块的初始化、退出以及对配置项的处理，同时带来了足够的灵活性。</p>
<p><a href="https://imgtu.com/i/2pk4cn" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/05/26/2pk4cn.md.png" alt="2pk4cn.md.png"></a></p>
</li>
</ol>
<p><center>图8-1</center><br>如图所示，nginx_module_t结构体作为所有模块的通用接口，其只定义了<code>init_master</code> <code>init_module</code> <code>init_process</code> <code>init_thread</code> <code>exit_thread</code> <code>exit_process</code> <code>exit_master</code>这七个回调方法，他们负责模块的初始化与退出，同时权限非常高，可以处理核心结构体nginx_cycle_t。</p>
<h4 id="nginx-module-t类"><a href="#nginx-module-t类" class="headerlink" title="nginx_module_t类"></a>nginx_module_t类</h4><p>nginx_module_t结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_module_s</span> &#123;</span></span><br><span class="line">  <span class="comment">/* 下面的ctx_index、index、spare0、spare1、spare2、spare3、version不需要在定义时赋值，可以用Nginx准备好的宏NGINX_MODULE_V1来定义，其已经定义好了这7个值。 #define NGINX_MODULE_V1 0,0,0,0,0,0,1 */</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 对于一类模块（同一type）而言，ctx_index表示当前模块在这类模块中的序号，改成员变量通常由管理这类模块的一个nginx核心模块设置的，对于http而言，由核心模块nginx_http_module设置。ctx_index十分重要，nginx模块化依赖各个模块顺序，其既表达优先级，也用于表面每个模块的位置*/</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            ctx_index;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* index表示当前模块在ngx_modules数组中序号，即为当前模块在所有模块中的序号，nginx启动时，依据ngx_modules数组设置该值*/</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>                 *name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            spare0;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            spare1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            version;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>           *signature;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 指向一类模块的上下文结构体，例如在http模块中，ctx指向ngx_http_module_t结构体*/</span></span><br><span class="line">    <span class="keyword">void</span>                 *ctx;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* commands将处理nginx.conf中的配置项 */</span></span><br><span class="line">    <span class="keyword">ngx_command_t</span>        *commands;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* master进程启动时回调init_master，但目前未使用，设置为NULL*/</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_master)(<span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 初始化所有模块是调用init_module，在master/worker模式下，该阶段在启动worker子进程前完成，具体执行位置在ngx_init_cycle中，执行完成配置解析，并打开监听端口号后，执行每个模块的init_module */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_module)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*init_process在正常服务前被调用，在master/worker模式下，多个worker子进程已产生，在每个woker进程的初始化过程中会调用所有模块的该函数 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_process)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_thread)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">void</span>                (*exit_thread)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*exit_process在服务停止前被调用，在master/worker模式下，worker进程退出前调用 */</span></span><br><span class="line">    <span class="keyword">void</span>                (*exit_process)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*exit_master在master进程退出前调用*/</span></span><br><span class="line">    <span class="keyword">void</span>                (*exit_master)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook0;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook1;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook2;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook3;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook4;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook5;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook6;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook7;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ctx是void指针，可以指向任何数据，这改模块提供了极大的灵活性。</p>
<ol>
<li><p>配置模块的设计</p>
<p>ngx_module_t接口中type类型指名了nginx在设计模块时定义模块类型，允许专注于不同领域的模块按照类型来区别。配置类型模块是唯一一个只有一个模块的模块类型。配置模块的类型叫做NGX_CONF_MODULE，其仅有的模块为ngx_conf_module，其为底层模块，指导所有模块以配置项为核心来提供功能。</p>
</li>
<li><p>核心模块的简单化</p>
</li>
<li><p>多层次，多类别的模块设计</p>
<p>所以模块间是分层次、分类别的，官方Nginx共用5大类型模块：核心模块、配置模块、时间模块、HTTP模块、mail模块。虽然都具备相同的ngx_module_t接口，但在请求处理中的层级并不相同。</p>
<p><a href="https://imgtu.com/i/2ELokD" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/05/30/2ELokD.png" alt="2ELokD.png"></a></p>
</li>
</ol>
<p><center>图8-2</center><br>如上图，配置模块和核心模块由Nginx的框架代码定义，配置模块是所有模块的基础，其实现了最基础的配置项解析功能（解析nginx.conf）。Nginx框架还会调用核心模块，但其他3种模块都不会与框架产生直接关系。事件模块、HTTP模块、mail模块的共性为：它们在核心模块中各有一个模块，作为其代言人，并在同类模块中有一个作为核心业务与管理功能的模块。</p>
<h3 id="事件驱动框架"><a href="#事件驱动框架" class="headerlink" title="事件驱动框架"></a>事件驱动框架</h3><p>事件驱动指：由一些事件发送源来产生事件，由一个或多个时间收集器来收集、分发时间，然后许多事件处理器会注册自己感兴趣的，同时会消费这些事件。</p>
<p>对于nginx来说，一般会由网卡、磁盘产生事件，事件模块负责收集、分发操作，所有模块都可能是消费者，其首选向事件模块注册感兴趣的事件类型，这样，有事件产生时，事件模块会把事件分发到响应模块中进行处理。</p>
<p>传统Web服务器，采用的事件驱动往往局限于在TCP连接、关闭事件上，一个连接建立后，在其关闭前所有操作都不再是事件驱动，此时会退化为按需执行每个操作的批处理模式，这样，每个请求在连接后都将始终占有系统资源，直到连接关闭才会释放。</p>
<p>Nginx则不然，他不会使用进程或线程作为事件消费者，所谓事件消费者只能是某个模块。只有事件收集器、分发器才有资格占用进程资源，它们会在分发某个事件时调用事件消费模块使用当前占用进程资源。</p>
<p><a href="https://imgtu.com/i/2EXtrq" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/05/30/2EXtrq.png" alt="2EXtrq.png"></a></p>
<p><center>图8-4</center><br>如上图，在事件收集、分发者进程的一次处理过程中，5个事件按序被收集后，将开始使用当前进程分发事件，从而调用响应的事件消费者模块来处理事件。事件消费者只是被事件分发者进程短期调用而已。</p>
<h3 id="请求的多阶段异步处理"><a href="#请求的多阶段异步处理" class="headerlink" title="请求的多阶段异步处理"></a>请求的多阶段异步处理</h3><p>请求的多阶段异步处理是指：把一个请求过程按照事件的触发方式划分为多个阶段，每个阶段都可以由事件收集、分发来触发。</p>
<p>请求的多阶段异步处理优势：这种设计配合事件驱动架构，将极地提高网络性能，同时使得每个进程都能全力运转，不会或者尽量少的出现进程休眠状况。</p>
<p>划分请求阶段原则为：找到请求处理流程中阻塞方法，在阻塞代码段上按照下面四个方法来划分阶段：</p>
<ol>
<li><p>将阻塞进程的方法按照相关的触发事件分解为两个阶段：</p>
<p>一个本身可能导致进程休眠的方法或系统调用，一般可以分解为多个更小的方法或者系统调用，这些调用间可以通过事件触发关联起来。大部分情况，一个阻塞的方法调用可以划分为两个阶段：第一阶段为，将阻塞方法改为非阻塞方法，并将进程归还给事件分发器；第二阶段，用于处理非阻塞方法最终返回结果，这里的返回结果就是第二阶段触发事件。</p>
<p>例如使用send调用时，如果使用阻塞socket句柄，send向内核发送数据后将使当前进程休眠，直到成功发出数据。可以将send调用划分为两个阶段：使用非阻塞socket句柄，发送后进程不休眠，再将socket句柄加入事件收集器中就可以等待相应事件触发下一阶段，send发送数据被对方接收后会触发send结果返回阶段。</p>
</li>
<li><p>将阻塞方法调用按照时间分解为多个阶段的方法调用</p>
<p>系统中事件收集器、分发器并非可以处理任何事件。例如读取文件调用（非异步I/O），如果我们读取10MB文件，这些文件在磁盘块未必是连续的，此时可能需要多次驱动硬盘寻址，寻址时，进程多半会休眠或等待。如果内核不支持异步I/O时（或未打开），就不能采用第一个方案。此时可以分解读取文件调用：把10MB的文件划分为1000份，每次读取10KB。每次读取10KB的时间是可控的，意味着该事件不会占用进程太久，整个系统可以及时处理其他请求。</p>
<p>在读取0KB-10KB后如何进入10KB-20KB呢，可以有多种方式：如读取完10KB要使用网络进行发送，可以由网络事件进行触发。或者没有网络事件，可以设置一个简单的定时器。</p>
</li>
<li><p>在”无所事事”且必须等待系统响应时，使用定时器划分阶段</p>
<p>有时阻塞代码可以是这样的：进行某个无阻塞的系统调用后，必须通过持续检查标志位来确定是否继续向下执行，当标志位没有获得满足时就循环地检查。此时，应该使用定时器来代替循环检查标志，这样定时器事件发送时就会先检查标志，如果标志不满足，就立即归还进程控制权，同时继续加入期望的下一个定时器事件。</p>
</li>
<li><p>如果阻塞方法完全无法划分，则必须使用独立的进程执行这个阻塞方法</p>
<p>如果某个方法的调用时可能导致进程休眠，或者占用进程时间过长，开始又无法将该方法分级为非阻塞的方法，那么，这与事件驱动框架是相违背的。通常是由于方法实现者未开放非阻塞接口所导致，这时必须通过产生新的进程或者指定某个非事件分发者进程来执行阻塞方法，并在阻塞方法执行完毕时向事件收集、分发者进程发送事件通知继续执行。因此，至少要拆分为两个阶段：阻塞方法执行前阶段、阻塞方法执行后阶段，阻塞方法由单独的进程取调度，并在方法返回后发送事件通知。一旦出现这种情况，应该考虑这样的事件消费者是否合理，有没有必要使用这种违反事件驱动的方式来解决阻塞问题。</p>
</li>
</ol>
<h3 id="管理进程、多工作进程设计"><a href="#管理进程、多工作进程设计" class="headerlink" title="管理进程、多工作进程设计"></a>管理进程、多工作进程设计</h3><p>Nginx采用一个master管理进程，多个worker工作进程的设计方式，如下图：</p>
<p><a href="https://imgtu.com/i/2npYee" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/06/01/2npYee.png" alt="2npYee.png"></a></p>
<p><center>图8-5</center><br>该设计的优点为：</p>
<ol>
<li><p>利用多核系统的并发处理能力</p>
</li>
<li><p>负载均衡</p>
<p>每个worker工作进程通过进程间通信来实现负载均衡，即一个请求到达时会更容易地被分配到负载较轻的进程中。</p>
</li>
<li><p>管理进程负责监控工作进程的状态，并负责其行为</p>
<p>管理进程不会占用太多系统资源，其只用来启动、停止、建库或使用其他行为来控制工作进程。首选，这提高了系统的可靠性，当工作进程出现问题时，管理进程可以启动新的工作进程来避免系统性能下降。其次，管理进程支持nginx服务运行中的程序升级、配置项的修改等操作。这种设计使得动态可扩展性、动态定制性、动态可进化性较容易实现。</p>
</li>
</ol>
<h3 id="内存池的设计"><a href="#内存池的设计" class="headerlink" title="内存池的设计"></a>内存池的设计</h3><p>为了避免出现内存碎片、减少向操作系统申请内存的次数、降低各个模块的开发复杂度，Nginx设计了简单的内存池。内存池没有很复杂的功能：其通常不负责回收内存池中已经分配的内存。内存池最大的优点在于：把多次向系统申请内存的操作整合到一次，这大大减少了CPU资源消耗，同时减少了内存碎片。</p>
<h2 id="Nginx框架中的核心结构体ngx-cycle-t"><a href="#Nginx框架中的核心结构体ngx-cycle-t" class="headerlink" title="Nginx框架中的核心结构体ngx_cycle_t"></a>Nginx框架中的核心结构体ngx_cycle_t</h2><p>Nginx核心的框架代码围绕ngx_cycle_t结构体展开。</p>
<h3 id="ngx-listening-t结构体"><a href="#ngx-listening-t结构体" class="headerlink" title="ngx_listening_t结构体"></a>ngx_listening_t结构体</h3><p>作为web服务器，nginx首先需要监听端口并处理其中的网络事件。ngx_cycle_t对象有一个动态数组成员listening，其每个元素都是ngx_listening_t结构体，每个ngx_listening_t结构体代表nginx服务器监听的一个端口。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_listening_s</span>  <span class="title">ngx_listening_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_listening_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_socket_t</span>        fd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>    *<span class="title">sockaddr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span>           socklen;    <span class="comment">/* size of sockaddr */</span></span><br><span class="line">    <span class="keyword">size_t</span>              addr_text_max_len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>           addr_text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>                 type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* TCP实现监听时的backlog队列，它表示允许正在通过三次握手建立TCP连接但还没有任何进程开始处理的连接的最大个数 */</span></span><br><span class="line">    <span class="keyword">int</span>                 backlog;</span><br><span class="line">  <span class="comment">/* 内核中对该套接字的接收缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">int</span>                 rcvbuf;</span><br><span class="line">  <span class="comment">/* 内核中对该套接字的发送缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">int</span>                 sndbuf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KEEPALIVE_TUNABLE)</span></span><br><span class="line">    <span class="keyword">int</span>                 keepidle;</span><br><span class="line">    <span class="keyword">int</span>                 keepintvl;</span><br><span class="line">    <span class="keyword">int</span>                 keepcnt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler of accepted connection */</span></span><br><span class="line">    <span class="comment">/* 当新的TCP连接成功建立后的处理方法 */</span></span><br><span class="line">    ngx_connection_handler_pt   handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>               *servers;  <span class="comment">/* array of ngx_http_in_addr_t, for example */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* log和kogp都是可用的日志对象的指针 */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>           <span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>          *logp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果为新的TCP连接创建内存池，则内存池从初始大小 */</span></span><br><span class="line">    <span class="keyword">size_t</span>              pool_size;</span><br><span class="line">    <span class="comment">/* should be here because of the AcceptEx() preread */</span></span><br><span class="line">    <span class="keyword">size_t</span>              post_accept_buffer_size;</span><br><span class="line">    <span class="comment">/* should be here because of the deferred accept */</span></span><br><span class="line">    <span class="comment">/* TCP_DEFER_ACCEPT选项将在建立TCP连接成功并且接受到用户请求数据后，才向对监听套接字感兴趣的进程发送事件通知，而连接成功后，如果post_accept_timeout秒后仍未收到用户数据，则内核直接丢弃连接 */</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>          post_accept_timeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 前一个ngx_listening_t的指针，多个ngx_listening_t结构体之间由previous指针组成单链表 */</span></span><br><span class="line">    <span class="keyword">ngx_listening_t</span>    *previous;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 当前监听句柄对应着的ngx_connection_t结构体，为一个单链表 */</span></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>   *connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>        rbtree;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>   sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>          worker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 标志位，为1表示当前监听句柄有效，且执行ngx_init_cycle时不关闭监听端口，为0正常关闭。该标志由架构代码自动设置 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            open:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 为1表示已有ngx_cycle_t来初始化新的ngx_cycle_t结构体时，不关闭原先打开的监听端口，对运行中升级程序很有效。为0时，表示正常关闭曾经打开的监听端口。该标志由架构代码自动设置 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            remain:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 1表示跳过设置当前ngx_listening_t结构体中套接字，0正常初始化套接字。 该标志由架构代码自动设置*/</span></span><br><span class="line">    <span class="keyword">unsigned</span>            ignore:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>            bound:<span class="number">1</span>;       <span class="comment">/* already bound */</span></span><br><span class="line">    <span class="comment">/* 当前监听句柄是否来着于前一个进程 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            inherited:<span class="number">1</span>;   <span class="comment">/* inherited from previous process */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            nonblocking_accept:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* （书中说是当前套接字是否已监听），看代码似乎是说要重新执行listing函数来设置监听的第二个参数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            listen:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 套接字是否阻塞，目前无意义 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            nonblocking:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            shared:<span class="number">1</span>;    <span class="comment">/* shared between threads or processes */</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 1时nginx将网络地址转变为字符串形式地址 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            addr_ntop:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            wildcard:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">    <span class="keyword">unsigned</span>            ipv6only:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">unsigned</span>            reuseport:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            add_reuseport:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            keepalive:<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>            deferred_accept:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            delete_deferred:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            add_deferred:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    <span class="keyword">char</span>               *accept_filter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">    <span class="keyword">int</span>                 setfib;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">    <span class="keyword">int</span>                 fastopen;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ngx_connection_handler_pt类型的handler成员表示在这个监听端口上成功建立新的tcp连接后，就会回调handler方法，其定义为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*ngx_connection_handler_pt)(ngx_connect_t *c);</span><br></pre></td></tr></table></figure>
<h3 id="ngx-cycle-t结构体"><a href="#ngx-cycle-t结构体" class="headerlink" title="ngx_cycle_t结构体"></a>ngx_cycle_t结构体</h3><p>首先来介绍一下ngx_cycle_t中的成员（其中connectins、read_events、write_events、files、free_connection成员与事件模块强相关，在事件模块中详细介绍）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_cycle_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 保存着所有模块（modules）存储配置项的结构体的指针。其首先是一个数组，每个数组成员又是一个指针，这个指针指向另一个存储着指针的数组 */</span></span><br><span class="line">    <span class="keyword">void</span>                  ****conf_ctx;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 内存池 */</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>               *pool;</span><br><span class="line">    <span class="comment">/* 在未执行ngx_init_cycle方法前，未确定日志输出位置时，暂时使用log，将内容输出到屏幕上，在执行了ngx_init_cycle方法后，确定日志输出位置时，会替换该值 */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>                *<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">/* 由nginx.conf配置文件读取到日志后，将开始初始化error_log日志文件，但log依然在向屏幕输出日志。这时会使用new_log对象暂时替代log日志，待初始化成功，使用new_log的地址替换log指针 */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 new_log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                log_use_stderr;  <span class="comment">/* unsigned  log_use_stderr:1; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 对于poll、rtsig的事件模块，会以有效文件句柄来预先建立这些ngx_connection_t结构体，以加速事件的收集分发，此时file保存了ngx_connection_t的指针数组 */</span></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>        **files;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 可用连接池，与free_connection_n配合使用 */</span></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>         *free_connections;</span><br><span class="line">    <span class="comment">/* 可用连接池中连接总数 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                free_connection_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_module_t</span>            **modules;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                modules_n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                modules_used;    <span class="comment">/* unsigned  modules_used:1; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 双向链表容器，元素类型为ngx_connection_t，表示可重复使用连接队列 */</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>               reusable_connections_queue;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                reusable_connections_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 动态数组，每个数组元素中存储着ngx_listening_t成员，表示监听端口及相关参数 */</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               listening;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 动态数组容器，其存储着Nginx所有要操作的目录。如果目录不存在则会试图创建，创建失败将会导致nginx启动失败.比如配置了client_body_temp_path，此时就需要创建一个路径临时存放请求用户http包体*/</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               paths;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               config_dump;</span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>              config_dump_rbtree;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>         config_dump_sentinel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 单链表容器，元素类型为ngx_open_file_t结构体，其表示nginx已经打开的所有文件 */</span></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                open_files;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 单链表容器，元素类型为ngx_shm_zone_y，每一个元素表示一块共享内存 */</span></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                shared_memory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 当前进程中连接总数 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                connection_n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                files_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 指向当前进程中所有链接对象，与connection_n配合使用 */</span> </span><br><span class="line">    <span class="keyword">ngx_connection_t</span>         *connections;</span><br><span class="line">    <span class="comment">/* 指向当前进程中所有读事件 connection_n同时表示读事件总数*/</span> </span><br><span class="line">    <span class="keyword">ngx_event_t</span>              *read_events;</span><br><span class="line">    <span class="comment">/* 指向当前进程中所有写事件 connection_n同时表示写事件总数*/</span> </span><br><span class="line">    <span class="keyword">ngx_event_t</span>              *write_events;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 旧的ngx_cycle_t对象引用上一个ngx_cycle_t对象的成员。在调用ngx_init_cycle方法前会建立一个临时ngx_cycle_t对象保存一些变量，再调用ngx_init_cycle方法时将旧的ngx_cycle_t传递进去，此时old_cycle将保存旧的ngx_cycle_t */</span></span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>              *old_cycle;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 配置文件相对按照目录的路径名 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_file;</span><br><span class="line">    <span class="comment">/* nginx处理配置文件时需要特殊处理的在命令行携带的参数，一般是-g选项携带的参数 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_param;</span><br><span class="line">    <span class="comment">/* nginx配置文件所在目录的路径 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_prefix;</span><br><span class="line">    <span class="comment">/* nginx安装目录 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 prefix;</span><br><span class="line">    <span class="comment">/* 用于进程间同步的锁的名称 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 lock_file;</span><br><span class="line">    <span class="comment">/* gethostname获取到的主机名 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 hostname;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-cycle-t支持的方法"><a href="#ngx-cycle-t支持的方法" class="headerlink" title="ngx_cycle_t支持的方法"></a>ngx_cycle_t支持的方法</h3><p>每个模块都可以通过init_module、init_process、exit_process、exit_master等方法操作进程的单独的ngx_cycle_t结构体。nginx框架关于ngx_cycle_t结构体方法如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>方法名</th>
<th>参数含义</th>
<th>执行含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_cycle_t <em>ngx_init_cycle(ngx_cycle_t </em>old_cycle)</td>
<td>old_cycle表示临时的ngx_cycle_t指针，一般用来传递配置文件路径等参数。</td>
<td>返回初始化完成的结构体，该函数将会负责初始化ngx_cycle_t中的数据结构、解析配置文件、加载所有模块、打开监听端口、初始化进程间通讯方式等工作。失败返回null。</td>
</tr>
<tr>
<td>ngx_init_t <em>ngx_process_options(ngx_cycle_t </em>cycle)</td>
<td>与上一个参数一致</td>
<td>用运行Nginx时可能携带的目录参数来初始化cycle，包括初始化运行目录、配置目录，并生成完整的nginx.conf配置文件路径</td>
</tr>
<tr>
<td>ngx_init_t <em>ngx_add_inherited_sockets(ngx_cycle_t </em>cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>在不重启服务器升级时，老的nginx进程会通过环境变量NGINX来传递需要打开的监听端口，新的nginx进程会通过ngx_add_ingerited_sockets方法来使用已经打开的TCP监听端口</td>
</tr>
<tr>
<td>ngx_int_t ngx_open_listening_sockets(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>监听、绑定cycle中listening动态数组指定的相应端口</td>
</tr>
<tr>
<td>void <em>ngx_configure_listening_sockets(ngx_cycle_t </em>cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>根据nginx.conf中的配置项设置已经监听的句柄</td>
</tr>
<tr>
<td>void ngx_close_listening_sockets(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>关闭cycle中listening动态数组中已经监听的句柄</td>
</tr>
<tr>
<td>void <em>ngx_master_process_cycle(ngx_cycle_t </em>cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>进入master进程主循环</td>
</tr>
<tr>
<td>void ngx_master_single_cycle(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>进入单进程模式的工作循环</td>
</tr>
<tr>
<td>void ngx_start_worker_processes(ngx_cycle_t *cycle, ngx_int_t n, ngx_int_t type)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针，n是启动进程数量，type是启动方式，其取值为如下5个；1）NGX_PROCESS_RESPAWN；2)NGX_PROCESS_NORESPAWN；3)NGX_PROCESS_JUST_SPAWN；4)NGX_PROCESS_JUST_RESPAWN；5)NGX_PROCESS_DEFACHED。type值影响ngx_process_t中respawn，detached，just_spawn标志位值</td>
<td>启动n个work子进程，并设置好每个子进程与父进程之间使用socketpair系统调用建立起来的socket句柄通信机制</td>
</tr>
<tr>
<td>void ngx_start_cache_manger_processes(ngx_cycle_t *cycle, ngx_nint_t respawn)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,respawn与ngx_start_worker_processes的type一致</td>
<td>根据是否使用文件缓存模块，即cycle中存储路径的动态数组中是否有路径的manage标志打开，来决定是否启动cache manage子进程，根据loader标志位来决定是否启动cache loader子进程</td>
</tr>
<tr>
<td>void ngx_pass_open_channel(ngx_cycle_t <em>cycle, ngx_channel_t </em>ch)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针，ch是将要发送的信息</td>
<td>向所有已经打开的channel（通过socketpair生成的句柄进行通信）发送ch信息</td>
</tr>
<tr>
<td>void ngx_single_worker_processes(ngx_cycle_t *cycle, int signo)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针，signo是信号</td>
<td>处理worker进程接受到的信号</td>
</tr>
<tr>
<td>ngx_uint_t ngx_reap_children(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>检查master进程的所有子进程，根据每个子进程的状态(ngx_process_t结构体中标志位)判断是否要启动子进程、更改pid文件等</td>
</tr>
<tr>
<td>void ngx_master_process_exit(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>退出master进程主循环</td>
</tr>
<tr>
<td>void ngx_work_process_cycle(ngx_cycle_t <em>cycle, void </em>data)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,data目前还未使用，null</td>
<td>进入worker进程主循环</td>
</tr>
<tr>
<td>void ngx_work_process_init(ngx_cycle_t *cycle, ngx_uint_t priority)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,priority是当前worker进程的优先级</td>
<td>进入worker进程主循环之前的初始化工作</td>
</tr>
<tr>
<td>void ngx_work_process_exit(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>退出worker进程主循环</td>
</tr>
<tr>
<td>void ngx_cache_manager_process_cycle(ngx_cycle_t <em>cycle, void </em>data)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,data是传入的ngx_cache_manager_ctx_t结构体指针</td>
<td>执行缓存管理工作的循环方法。</td>
</tr>
<tr>
<td>void ngx_process_events_and_timers(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>使用事件管理模块处理截止到现在已经收集到的事件</td>
</tr>
</tbody>
</table>
</div>
<h3 id="nginx启动时框架处理流程"><a href="#nginx启动时框架处理流程" class="headerlink" title="nginx启动时框架处理流程"></a>nginx启动时框架处理流程</h3><p><a href="https://imgtu.com/i/21Zga9" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/06/03/21Zga9.png" alt="21Zga9.png"></a></p>
<p><center>图8-6</center></p>
<h2 id="nginx启动过程详解"><a href="#nginx启动过程详解" class="headerlink" title="nginx启动过程详解"></a>nginx启动过程详解</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ngx_cdecl</span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> *argv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>        *b;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>        *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>      *cycle, init_cycle;</span><br><span class="line">    <span class="keyword">ngx_conf_dump_t</span>  *cd;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    ngx_debug_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_strerror_init() != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_get_options(argc, argv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_show_version) &#123;</span><br><span class="line">        ngx_show_version_info();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ngx_test_config) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* TODO */</span> ngx_max_sockets = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    ngx_time_init();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    ngx_regex_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取进程id和父进程id</span></span><br><span class="line">    ngx_pid = ngx_getpid();</span><br><span class="line">    ngx_parent = ngx_getppid();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = ngx_log_init(ngx_prefix);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* STUB */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_OPENSSL)</span></span><br><span class="line">    ngx_ssl_init(<span class="built_in">log</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * init_cycle-&gt;log is required for signal handlers and</span></span><br><span class="line"><span class="comment">     * ngx_process_options()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;init_cycle, <span class="keyword">sizeof</span>(<span class="keyword">ngx_cycle_t</span>));</span><br><span class="line">    init_cycle.<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    ngx_cycle = &amp;init_cycle;</span><br><span class="line"></span><br><span class="line">    init_cycle.pool = ngx_create_pool(<span class="number">1024</span>, <span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (init_cycle.pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_save_argv(&amp;init_cycle, argc, argv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_process_options(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_os_init(<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ngx_crc32_table_init() requires ngx_cacheline_size set in ngx_os_init()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_crc32_table_init() != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ngx_slab_sizes_init() requires ngx_pagesize set in ngx_os_init()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_slab_sizes_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_preinit_modules() != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle = ngx_init_cycle(&amp;init_cycle);</span><br><span class="line">    <span class="keyword">if</span> (cycle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">            ngx_log_stderr(<span class="number">0</span>, <span class="string">"configuration file %s test failed"</span>,</span><br><span class="line">                           init_cycle.conf_file.data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ngx_quiet_mode) &#123;</span><br><span class="line">            ngx_log_stderr(<span class="number">0</span>, <span class="string">"configuration file %s test is successful"</span>,</span><br><span class="line">                           cycle-&gt;conf_file.data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_dump_config) &#123;</span><br><span class="line">            cd = cycle-&gt;config_dump.elts;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;config_dump.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">                ngx_write_stdout(<span class="string">"# configuration file "</span>);</span><br><span class="line">                (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, cd[i].name.data,</span><br><span class="line">                                    cd[i].name.len);</span><br><span class="line">                ngx_write_stdout(<span class="string">":"</span> NGX_LINEFEED);</span><br><span class="line"></span><br><span class="line">                b = cd[i].buffer;</span><br><span class="line"></span><br><span class="line">                (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, b-&gt;pos, b-&gt;last - b-&gt;pos);</span><br><span class="line">                ngx_write_stdout(NGX_LINEFEED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_signal) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_signal_process(cycle, ngx_signal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_os_status(cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    ngx_cycle = cycle;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;master &amp;&amp; ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">        ngx_process = NGX_PROCESS_MASTER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(NGX_WIN32)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_init_signals(cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ngx_inherited &amp;&amp; ccf-&gt;daemon) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_daemon(cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_daemonized = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_inherited) &#123;</span><br><span class="line">        ngx_daemonized = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_create_pidfile(&amp;ccf-&gt;pid, cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_log_redirect_stderr(cycle) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;file-&gt;fd != ngx_stderr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_close_file(<span class="built_in">log</span>-&gt;file-&gt;fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_close_file_n <span class="string">" built-in log failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_use_stderr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">        ngx_single_process_cycle(cycle);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_master_process_cycle(cycle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析启动参数"><a href="#解析启动参数" class="headerlink" title="解析启动参数"></a>解析启动参数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_get_options(argc, argv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>逐字符解析启动请求参数，根据解析参数设置全局变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_get_options(<span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> *argv)</span><br><span class="line">&#123;</span><br><span class="line">    u_char     *p;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>   i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line"></span><br><span class="line">        p = (u_char *) argv[i];</span><br><span class="line">        <span class="comment">// 启动参数，必须使用-开始</span></span><br><span class="line">        <span class="keyword">if</span> (*p++ != <span class="string">'-'</span>) &#123;</span><br><span class="line">            ngx_log_stderr(<span class="number">0</span>, <span class="string">"invalid option: \"%s\""</span>, argv[i]);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (*p) &#123;</span><br><span class="line">            <span class="comment">// 检查参数</span></span><br><span class="line">            <span class="keyword">switch</span> (*p++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">                <span class="comment">// 打印help信息标识</span></span><br><span class="line">                ngx_show_version = <span class="number">1</span>;</span><br><span class="line">                ngx_show_help = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'v'</span>:</span><br><span class="line">                <span class="comment">// 打印版本标识</span></span><br><span class="line">                ngx_show_version = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'V'</span>:</span><br><span class="line">                <span class="comment">// 打印版本标识和显示配置编译阶段信息</span></span><br><span class="line">                ngx_show_version = <span class="number">1</span>;</span><br><span class="line">                ngx_show_configure = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                <span class="comment">// 测试配置正确性标识</span></span><br><span class="line">                ngx_test_config = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'T'</span>:</span><br><span class="line">                <span class="comment">// 测速配置正确性标识，dump配置并输出标识</span></span><br><span class="line">                ngx_test_config = <span class="number">1</span>;</span><br><span class="line">                ngx_dump_config = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'q'</span>:</span><br><span class="line">                <span class="comment">// 测试配置选项时，使用-q使得error级别以下的信息不输出</span></span><br><span class="line">                ngx_quiet_mode = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'p'</span>:</span><br><span class="line">                <span class="comment">// 另行指定nginx安装目录。决定了，error日志，conf配置和pid文件存储的默认位置</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    <span class="comment">// 使用ngx_prefix存储值，-p直接接目录，如 -p/home/work/nginx</span></span><br><span class="line">                    ngx_prefix = p;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// -p /home/work/nginx</span></span><br><span class="line">                <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_prefix = (u_char *) argv[i];</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-p\" requires directory name"</span>);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'c'</span>:</span><br><span class="line">                <span class="comment">// 配置文件目录，使用ngx_conf_file存储</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    ngx_conf_file = p;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_conf_file = (u_char *) argv[i];</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-c\" requires file name"</span>);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'g'</span>:</span><br><span class="line">                <span class="comment">// 指定一些全局变量，使用ngx_conf_params存储，后续会被与解析配置方式一样进行解析，使用ngx_conf_params存储</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    ngx_conf_params = p;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_conf_params = (u_char *) argv[i];</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-g\" requires parameter"</span>);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                <span class="comment">// 发送信号，使用ngx_signal存储</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    ngx_signal = (<span class="keyword">char</span> *) p;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_signal = argv[i];</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-s\" requires parameter"</span>);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_strcmp(ngx_signal, <span class="string">"stop"</span>) == <span class="number">0</span></span><br><span class="line">                    || ngx_strcmp(ngx_signal, <span class="string">"quit"</span>) == <span class="number">0</span></span><br><span class="line">                    || ngx_strcmp(ngx_signal, <span class="string">"reopen"</span>) == <span class="number">0</span></span><br><span class="line">                    || ngx_strcmp(ngx_signal, <span class="string">"reload"</span>) == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 如果是上述四种之一，设置ngx_process为NGX_PROCESS_SIGNALLER</span></span><br><span class="line">                    ngx_process = NGX_PROCESS_SIGNALLER;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"invalid option: \"-s %s\""</span>, ngx_signal);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"invalid option: \"%c\""</span>, *(p - <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化信息"><a href="#初始化信息" class="headerlink" title="初始化信息"></a>初始化信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_time_init();</span><br></pre></td></tr></table></figure>
<p>详见事件处理部分。</p>
<h3 id="初始化log打印描述符"><a href="#初始化log打印描述符" class="headerlink" title="初始化log打印描述符"></a>初始化log打印描述符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log = ngx_log_init(ngx_prefix);</span><br></pre></td></tr></table></figure>
<p>更加启动参数或默认log路径，初始化log信息，包括描述符和等级等信息。</p>
<h3 id="申请内存池空间Pool"><a href="#申请内存池空间Pool" class="headerlink" title="申请内存池空间Pool"></a>申请内存池空间Pool</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ngx_memzero(&amp;init_cycle, sizeof(ngx_cycle_t));</span><br><span class="line">init_cycle.log = log;</span><br><span class="line">ngx_cycle = &amp;init_cycle;</span><br><span class="line"></span><br><span class="line">init_cycle.pool = ngx_create_pool(1024, log);</span><br></pre></td></tr></table></figure>
<h3 id="存储命令行参数"><a href="#存储命令行参数" class="headerlink" title="存储命令行参数"></a>存储命令行参数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_save_argv(&amp;init_cycle, argc, argv) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将命令行存储到全国变量中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ngx_argv</span><br><span class="line">ngx_argc</span><br></pre></td></tr></table></figure>
<h3 id="设置相关路径"><a href="#设置相关路径" class="headerlink" title="设置相关路径"></a>设置相关路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_process_options(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过启动命令行参数或默认值设置cycle中的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_process_options(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  *p;</span><br><span class="line">    <span class="keyword">size_t</span>   len;</span><br><span class="line">    <span class="comment">// 如果存在-p参数，即设置了nginx环境目录</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_prefix) &#123;</span><br><span class="line">        len = ngx_strlen(ngx_prefix);</span><br><span class="line">        p = ngx_prefix;</span><br><span class="line">        <span class="comment">// 如果设置的目录最后不是/，则添加一个/</span></span><br><span class="line">        <span class="keyword">if</span> (len &amp;&amp; !ngx_path_separator(p[len - <span class="number">1</span>])) &#123;</span><br><span class="line">            p = ngx_pnalloc(cycle-&gt;pool, len + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_memcpy(p, ngx_prefix, len);</span><br><span class="line">            p[len++] = <span class="string">'/'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置conf_prefix配置文件所在目录路径和prefix安装路径</span></span><br><span class="line">        cycle-&gt;conf_prefix.len = len;</span><br><span class="line">        cycle-&gt;conf_prefix.data = p;</span><br><span class="line">        cycle-&gt;prefix.len = len;</span><br><span class="line">        cycle-&gt;prefix.data = p;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果未设置，则使用默认路径</span></span><br><span class="line"></span><br><span class="line">#ifndef NGX_PREFIX</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(cycle-&gt;pool, NGX_MAX_PATH);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_getcwd(p, NGX_MAX_PATH) == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_stderr(ngx_errno, <span class="string">"[emerg]: "</span> ngx_getcwd_n <span class="string">" failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = ngx_strlen(p);</span><br><span class="line"></span><br><span class="line">        p[len++] = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">        cycle-&gt;conf_prefix.len = len;</span><br><span class="line">        cycle-&gt;conf_prefix.data = p;</span><br><span class="line">        cycle-&gt;prefix.len = len;</span><br><span class="line">        cycle-&gt;prefix.data = p;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NGX_CONF_PREFIX</span></span><br><span class="line">        <span class="comment">// 设置conf_prefix为conf/，为相对于prefix路径</span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;conf_prefix, NGX_CONF_PREFIX);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;conf_prefix, NGX_PREFIX);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// /usr/local/nginx/</span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;prefix, NGX_PREFIX);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果-c指定了配置文件，则设置为对应文件</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_file) &#123;</span><br><span class="line">        cycle-&gt;conf_file.len = ngx_strlen(ngx_conf_file);</span><br><span class="line">        cycle-&gt;conf_file.data = ngx_conf_file;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则设置为相对与prefix的路径conf/nginx.conf</span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;conf_file, NGX_CONF_PATH);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据prefix、和conf_file二者确认实际配置文件路径</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_full_name(cycle, &amp;cycle-&gt;conf_file, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据conf_file设置conf_prefix</span></span><br><span class="line">    <span class="keyword">for</span> (p = cycle-&gt;conf_file.data + cycle-&gt;conf_file.len - <span class="number">1</span>;</span><br><span class="line">         p &gt; cycle-&gt;conf_file.data;</span><br><span class="line">         p--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_path_separator(*p)) &#123;</span><br><span class="line">            cycle-&gt;conf_prefix.len = p - cycle-&gt;conf_file.data + <span class="number">1</span>;</span><br><span class="line">            cycle-&gt;conf_prefix.data = cycle-&gt;conf_file.data;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果使用-g指定了额外参数，使用cycle-&gt;conf_param存储</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_params) &#123;</span><br><span class="line">        cycle-&gt;conf_param.len = ngx_strlen(ngx_conf_params);</span><br><span class="line">        cycle-&gt;conf_param.data = ngx_conf_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">        cycle-&gt;<span class="built_in">log</span>-&gt;log_level = NGX_LOG_INFO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化系统相关全局变量"><a href="#初始化系统相关全局变量" class="headerlink" title="初始化系统相关全局变量"></a>初始化系统相关全局变量</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_os_init(<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>待详细查看。目前看包括如下数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ngx_pagesize = getpagesize(); // 内存分页大小</span><br><span class="line">ngx_cacheline_size = NGX_CPU_CACHE_LINE; // 缓存行的大小</span><br><span class="line">ngx_ncpu = sysconf(_SC_NPROCESSORS_ONLN); // cpu数据</span><br><span class="line"></span><br><span class="line">getrlimit(RLIMIT_NOFILE, &amp;rlmt);</span><br><span class="line">ngx_max_sockets = (ngx_int_t) rlmt.rlim_cur; // 最大sockets链接数量</span><br></pre></td></tr></table></figure>
<h3 id="初始化差错校验"><a href="#初始化差错校验" class="headerlink" title="初始化差错校验"></a>初始化差错校验</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_crc32_table_init() != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx使用CRC：循环冗余检测（Cycle Redundancy Check)来进行差错校验。</p>
<h3 id="初始化slab共享内存"><a href="#初始化slab共享内存" class="headerlink" title="初始化slab共享内存"></a>初始化slab共享内存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_slab_sizes_init();</span><br></pre></td></tr></table></figure>
<p>具体详见slab共享内存。</p>
<h3 id="监听环境变量中的端口"><a href="#监听环境变量中的端口" class="headerlink" title="监听环境变量中的端口"></a>监听环境变量中的端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于平滑升级来说，需要保证用户无感知，因此要将原本开发监听的套接字存放于环境变量，而后，由新启动的进程读取，重新进行监听。</p>
<p>首选从环境变量NGINX中读取到套接字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_add_inherited_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *p, *v, *inherited;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         s;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>  *ls;</span><br><span class="line">    <span class="comment">// 首选从环境变量NGINX中读取到套接字：</span></span><br><span class="line">    inherited = (u_char *) getenv(NGINX_VAR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inherited == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"using inherited sockets from \"%s\""</span>, inherited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cycle-&gt;listening, cycle-&gt;pool, <span class="number">10</span>,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_listening_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (p = inherited, v = p; *p; p++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*p == <span class="string">':'</span> || *p == <span class="string">';'</span>) &#123;</span><br><span class="line">            s = ngx_atoi(v, p - v);</span><br><span class="line">            <span class="keyword">if</span> (s == NGX_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"invalid socket number \"%s\" in "</span> NGINX_VAR</span><br><span class="line">                              <span class="string">" environment variable, ignoring the rest"</span></span><br><span class="line">                              <span class="string">" of the variable"</span>, v);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            v = p + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 将环境变量里的套接字添加到cyyle的listening中</span></span><br><span class="line">            ls = ngx_array_push(&amp;cycle-&gt;listening);</span><br><span class="line">            <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_memzero(ls, <span class="keyword">sizeof</span>(<span class="keyword">ngx_listening_t</span>));</span><br><span class="line"></span><br><span class="line">            ls-&gt;fd = (<span class="keyword">ngx_socket_t</span>) s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v != p) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"invalid socket number \"%s\" in "</span> NGINX_VAR</span><br><span class="line">                      <span class="string">" environment variable, ignoring"</span>, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_inherited = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_set_inherited_sockets(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取套接字对应的信息ngx_set_inherited_sockets：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line">getsockname(ls[i].fd, ls[i].sockaddr, &amp;ls[i].socklen); <span class="comment">// 获取套接字的sockaddr</span></span><br><span class="line">getsockopt; <span class="comment">// 获取套接字上设置的额外信息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_set_inherited_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line">    <span class="keyword">socklen_t</span>                  olen;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT || NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">    <span class="keyword">ngx_err_t</span>                  err;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">accept_filter_arg</span>   <span class="title">af</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span></span><br><span class="line">    <span class="keyword">int</span>                        timeout;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">    <span class="keyword">int</span>                        reuseport;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 当前listening中的套接字均为从环境变量中继承而来，遍历每一个套接字，获取其对应的ngx_listening_t结构中字段信息</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 分配套接字地址</span></span><br><span class="line">        ls[i].sockaddr = ngx_palloc(cycle-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (ls[i].sockaddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用getsockname函数获取套接字地址，如果获取失败，则ignore置1，表示忽略该套接字。</span></span><br><span class="line">        ls[i].socklen = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line">        <span class="keyword">if</span> (getsockname(ls[i].fd, ls[i].sockaddr, &amp;ls[i].socklen) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockname() of the inherited "</span></span><br><span class="line">                          <span class="string">"socket #%d failed"</span>, ls[i].fd);</span><br><span class="line">            ls[i].ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].socklen &gt; (<span class="keyword">socklen_t</span>) <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>)) &#123;</span><br><span class="line">            ls[i].socklen = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据套接字族类型，设置addr_text_max_len大小，即用于存储addr_text字段的空间大小</span></span><br><span class="line">        <span class="keyword">switch</span> (ls[i].sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            ls[i].addr_text_max_len = NGX_INET6_ADDRSTRLEN;</span><br><span class="line">            len = NGX_INET6_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">"[]:65535"</span>) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">        <span class="keyword">case</span> AF_UNIX:</span><br><span class="line">            ls[i].addr_text_max_len = NGX_UNIX_ADDRSTRLEN;</span><br><span class="line">            len = NGX_UNIX_ADDRSTRLEN;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AF_INET:</span><br><span class="line">            ls[i].addr_text_max_len = NGX_INET_ADDRSTRLEN;</span><br><span class="line">            len = NGX_INET_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"the inherited socket #%d has "</span></span><br><span class="line">                          <span class="string">"an unsupported protocol family"</span>, ls[i].fd);</span><br><span class="line">            ls[i].ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].addr_text.data = ngx_pnalloc(cycle-&gt;pool, len);</span><br><span class="line">        <span class="keyword">if</span> (ls[i].addr_text.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用地址回填addr_text内容，IP:PORT</span></span><br><span class="line">        len = ngx_sock_ntop(ls[i].sockaddr, ls[i].socklen,</span><br><span class="line">                            ls[i].addr_text.data, len, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].addr_text.len = len;</span><br><span class="line">        <span class="comment">// 设置默认的backlog</span></span><br><span class="line">        ls[i].backlog = NGX_LISTEN_BACKLOG;</span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">        <span class="comment">// 使用getsockopt获取套接字类型吗，如果失败，则ignore置1</span></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_TYPE, (<span class="keyword">void</span> *) &amp;ls[i].type,</span><br><span class="line">                       &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_TYPE) %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">            ls[i].ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">        <span class="comment">// 使用getsockopt获取套接字rcvbuf，如果没有设置，则默认值-1，后续内容一样，都是通过getsockopt获取套接字的其他特性</span></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_RCVBUF, (<span class="keyword">void</span> *) &amp;ls[i].rcvbuf,</span><br><span class="line">                       &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_RCVBUF) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">            ls[i].rcvbuf = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_SNDBUF, (<span class="keyword">void</span> *) &amp;ls[i].sndbuf,</span><br><span class="line">                       &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_SNDBUF) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">            ls[i].sndbuf = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        <span class="comment">/* SO_SETFIB is currently a set only option */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_SETFIB,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;ls[i].setfib, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_SETFIB) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">            ls[i].setfib = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line"></span><br><span class="line">        reuseport = <span class="number">0</span>;</span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_REUSEPORT_LB</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT_LB,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;reuseport, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_REUSEPORT_LB) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ls[i].reuseport = reuseport ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;reuseport, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_REUSEPORT) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ls[i].reuseport = reuseport ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].type != SOCK_STREAM) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, IPPROTO_TCP, TCP_FASTOPEN,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;ls[i].fastopen, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err != NGX_EOPNOTSUPP &amp;&amp; err != NGX_ENOPROTOOPT</span><br><span class="line">                &amp;&amp; err != NGX_EINVAL)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                              <span class="string">"getsockopt(TCP_FASTOPEN) %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].fastopen = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line"></span><br><span class="line">        ngx_memzero(&amp;af, <span class="keyword">sizeof</span>(struct accept_filter_arg));</span><br><span class="line">        olen = <span class="keyword">sizeof</span>(struct accept_filter_arg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_ACCEPTFILTER, &amp;af, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EINVAL) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"getsockopt(SO_ACCEPTFILTER) for %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (olen &lt; <span class="keyword">sizeof</span>(struct accept_filter_arg) || af.af_name[<span class="number">0</span>] == <span class="string">'\0'</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].accept_filter = ngx_palloc(cycle-&gt;pool, <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> (ls[i].accept_filter == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        (<span class="keyword">void</span>) ngx_cpystrn((u_char *) ls[i].accept_filter,</span><br><span class="line">                           (u_char *) af.af_name, <span class="number">16</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span></span><br><span class="line"></span><br><span class="line">        timeout = <span class="number">0</span>;</span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, IPPROTO_TCP, TCP_DEFER_ACCEPT, &amp;timeout, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EOPNOTSUPP) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"getsockopt(TCP_DEFER_ACCEPT) for %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (olen &lt; <span class="keyword">sizeof</span>(<span class="keyword">int</span>) || timeout == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].deferred_accept = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预初始化模块"><a href="#预初始化模块" class="headerlink" title="预初始化模块"></a>预初始化模块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_preinit_modules() != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">ngx_int_t</span><br><span class="line">ngx_preinit_modules(void)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_uint_t  i;</span><br><span class="line"></span><br><span class="line">    for (i = 0; ngx_modules[i]; i++) &#123;</span><br><span class="line">        // 设置每个模块在所有模块中的index</span><br><span class="line">        ngx_modules[i]-&gt;index = i;</span><br><span class="line">        ngx_modules[i]-&gt;name = ngx_module_names[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_modules_n = i;</span><br><span class="line">    ngx_max_module = ngx_modules_n + NGX_MAX_DYNAMIC_MODULES;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化cycle"><a href="#初始化cycle" class="headerlink" title="初始化cycle"></a>初始化cycle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cycle = ngx_init_cycle(&amp;init_cycle);</span><br><span class="line">if (cycle == NULL) &#123;</span><br><span class="line">   if (ngx_test_config) &#123;</span><br><span class="line">      ngx_log_stderr(0, &quot;configuration file %s test failed&quot;,</span><br><span class="line">                           init_cycle.conf_file.data);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br></pre></td><td class="code"><pre><span class="line">/* 这里参数ngx_cycle_t被视为old cycle，一方面在不终止服务重新加载配置时会执行该操作，此时会传递一个old的cycle，另一方面，在一个新启动的服务来说，根据之前的操作，已经加载了相应的cycle参数，这里会继承上述获取到的部分参数，并进行升级合并 */</span><br><span class="line">ngx_cycle_t *</span><br><span class="line">ngx_init_cycle(ngx_cycle_t *old_cycle)</span><br><span class="line">&#123;</span><br><span class="line">    void                *rv;</span><br><span class="line">    char               **senv;</span><br><span class="line">    ngx_uint_t           i, n;</span><br><span class="line">    ngx_log_t           *log;</span><br><span class="line">    ngx_time_t          *tp;</span><br><span class="line">    ngx_conf_t           conf;</span><br><span class="line">    ngx_pool_t          *pool;</span><br><span class="line">    ngx_cycle_t         *cycle, **old;</span><br><span class="line">    ngx_shm_zone_t      *shm_zone, *oshm_zone;</span><br><span class="line">    ngx_list_part_t     *part, *opart;</span><br><span class="line">    ngx_open_file_t     *file;</span><br><span class="line">    ngx_listening_t     *ls, *nls;</span><br><span class="line">    ngx_core_conf_t     *ccf, *old_ccf;</span><br><span class="line">    ngx_core_module_t   *module;</span><br><span class="line">    char                 hostname[NGX_MAXHOSTNAMELEN];</span><br><span class="line">    // 读取环境变量的TZ，获取时区</span><br><span class="line">    ngx_timezone_update();</span><br><span class="line"></span><br><span class="line">    /* force localtime update with a new timezone */</span><br><span class="line"></span><br><span class="line">    tp = ngx_timeofday();</span><br><span class="line">    tp-&gt;sec = 0;</span><br><span class="line"></span><br><span class="line">    ngx_time_update();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    log = old_cycle-&gt;log;</span><br><span class="line"></span><br><span class="line">    pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, log);</span><br><span class="line">    if (pool == NULL) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    pool-&gt;log = log;</span><br><span class="line">    // 创建一个新的ngx_cycle_t</span><br><span class="line">    cycle = ngx_pcalloc(pool, sizeof(ngx_cycle_t));</span><br><span class="line">    if (cycle == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;pool = pool;</span><br><span class="line">    cycle-&gt;log = log;</span><br><span class="line">    // 存储老的cycle</span><br><span class="line">    cycle-&gt;old_cycle = old_cycle;</span><br><span class="line">    // 继承老的cycle中conf_prefix、prefix、conf_file、conf_param信息</span><br><span class="line">    cycle-&gt;conf_prefix.len = old_cycle-&gt;conf_prefix.len;</span><br><span class="line">    cycle-&gt;conf_prefix.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;conf_prefix);</span><br><span class="line">    if (cycle-&gt;conf_prefix.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;prefix.len = old_cycle-&gt;prefix.len;</span><br><span class="line">    cycle-&gt;prefix.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;prefix);</span><br><span class="line">    if (cycle-&gt;prefix.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;conf_file.len = old_cycle-&gt;conf_file.len;</span><br><span class="line">    cycle-&gt;conf_file.data = ngx_pnalloc(pool, old_cycle-&gt;conf_file.len + 1);</span><br><span class="line">    if (cycle-&gt;conf_file.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    ngx_cpystrn(cycle-&gt;conf_file.data, old_cycle-&gt;conf_file.data,</span><br><span class="line">                old_cycle-&gt;conf_file.len + 1);</span><br><span class="line"></span><br><span class="line">    cycle-&gt;conf_param.len = old_cycle-&gt;conf_param.len;</span><br><span class="line">    cycle-&gt;conf_param.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;conf_param);</span><br><span class="line">    if (cycle-&gt;conf_param.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据旧的path（管理路径列表）分配相应的新的cycle中paths的内存</span><br><span class="line">    n = old_cycle-&gt;paths.nelts ? old_cycle-&gt;paths.nelts : 10;</span><br><span class="line"></span><br><span class="line">    if (ngx_array_init(&amp;cycle-&gt;paths, pool, n, sizeof(ngx_path_t *))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(cycle-&gt;paths.elts, n * sizeof(ngx_path_t *));</span><br><span class="line"></span><br><span class="line">    // 初始化config_dump数组</span><br><span class="line">    if (ngx_array_init(&amp;cycle-&gt;config_dump, pool, 1, sizeof(ngx_conf_dump_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // 初始化config_dump_rbtree红黑树，具体参看红黑树部分解析</span><br><span class="line">    ngx_rbtree_init(&amp;cycle-&gt;config_dump_rbtree, &amp;cycle-&gt;config_dump_sentinel,</span><br><span class="line">                    ngx_str_rbtree_insert_value);</span><br><span class="line">    // 根据旧的open_files（打开文件列表）分配相应的新的cycle中open_files的内存</span><br><span class="line">    if (old_cycle-&gt;open_files.part.nelts) &#123;</span><br><span class="line">        n = old_cycle-&gt;open_files.part.nelts;</span><br><span class="line">        for (part = old_cycle-&gt;open_files.part.next; part; part = part-&gt;next) &#123;</span><br><span class="line">            n += part-&gt;nelts;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        n = 20;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ngx_list_init(&amp;cycle-&gt;open_files, pool, n, sizeof(ngx_open_file_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 根据旧的shared_memory（共享内存列表）分配相应的新的cycle中shared_memory的内存</span><br><span class="line">    if (old_cycle-&gt;shared_memory.part.nelts) &#123;</span><br><span class="line">        n = old_cycle-&gt;shared_memory.part.nelts;</span><br><span class="line">        for (part = old_cycle-&gt;shared_memory.part.next; part; part = part-&gt;next)</span><br><span class="line">        &#123;</span><br><span class="line">            n += part-&gt;nelts;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        n = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ngx_list_init(&amp;cycle-&gt;shared_memory, pool, n, sizeof(ngx_shm_zone_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据旧的listening（监听地址列表）分配相应的新的cycle中listening的内存</span><br><span class="line">    n = old_cycle-&gt;listening.nelts ? old_cycle-&gt;listening.nelts : 10;</span><br><span class="line"></span><br><span class="line">    if (ngx_array_init(&amp;cycle-&gt;listening, pool, n, sizeof(ngx_listening_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(cycle-&gt;listening.elts, n * sizeof(ngx_listening_t));</span><br><span class="line"></span><br><span class="line">    // 初始化用于事件模块的reusable_connections_queue，其值为双向队列。具体参考事件模块的处理</span><br><span class="line">    ngx_queue_init(&amp;cycle-&gt;reusable_connections_queue);</span><br><span class="line"></span><br><span class="line">    // 分配配置文件解析内存</span><br><span class="line">    cycle-&gt;conf_ctx = ngx_pcalloc(pool, ngx_max_module * sizeof(void *));</span><br><span class="line">    if (cycle-&gt;conf_ctx == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据gethostname获取机器的hostname</span><br><span class="line">    if (gethostname(hostname, NGX_MAXHOSTNAMELEN) == -1) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, log, ngx_errno, &quot;gethostname() failed&quot;);</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* on Linux gethostname() silently truncates name that does not fit */</span><br><span class="line"></span><br><span class="line">    hostname[NGX_MAXHOSTNAMELEN - 1] = &apos;\0&apos;;</span><br><span class="line">    cycle-&gt;hostname.len = ngx_strlen(hostname);</span><br><span class="line"></span><br><span class="line">    cycle-&gt;hostname.data = ngx_pnalloc(pool, cycle-&gt;hostname.len);</span><br><span class="line">    if (cycle-&gt;hostname.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_strlow(cycle-&gt;hostname.data, (u_char *) hostname, cycle-&gt;hostname.len);</span><br><span class="line"></span><br><span class="line">    // 复制全局变量ngx_modules（模块列表）到cycle的modules（深拷贝）</span><br><span class="line">    if (ngx_cycle_modules(cycle) != NGX_OK) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 执行每个核心模块的create_conf方法。由于核心模块管理者其所属下的各个模块。如ngx_http_module模块管理所有http模块。创建一个结构体，用于管理其下所有模块解析后的结果。具体可以参考配置解析*/</span><br><span class="line">    for (i = 0; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        if (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        module = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        if (module-&gt;create_conf) &#123;</span><br><span class="line">            rv = module-&gt;create_conf(cycle);</span><br><span class="line">            if (rv == NULL) &#123;</span><br><span class="line">                ngx_destroy_pool(pool);</span><br><span class="line">                return NULL;</span><br><span class="line">            &#125;</span><br><span class="line">            cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index] = rv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    senv = environ;</span><br><span class="line"></span><br><span class="line">    // 配置解析，解析包括-g传递的参数，和配置文件</span><br><span class="line">    ngx_memzero(&amp;conf, sizeof(ngx_conf_t));</span><br><span class="line">    /* STUB: init array ? */</span><br><span class="line">    conf.args = ngx_array_create(pool, 10, sizeof(ngx_str_t));</span><br><span class="line">    if (conf.args == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conf.temp_pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, log);</span><br><span class="line">    if (conf.temp_pool == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    conf.ctx = cycle-&gt;conf_ctx;</span><br><span class="line">    conf.cycle = cycle;</span><br><span class="line">    conf.pool = pool;</span><br><span class="line">    conf.log = log;</span><br><span class="line">    conf.module_type = NGX_CORE_MODULE;</span><br><span class="line">    conf.cmd_type = NGX_MAIN_CONF;</span><br><span class="line"></span><br><span class="line">#if 0</span><br><span class="line">    log-&gt;log_level = NGX_LOG_DEBUG_ALL;</span><br><span class="line">#endif</span><br><span class="line">    // 解析-g传递的参数</span><br><span class="line">    if (ngx_conf_param(&amp;conf) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析配置文件</span><br><span class="line">    if (ngx_conf_parse(&amp;conf, &amp;cycle-&gt;conf_file) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 如果是测试配置文件正确性，正常打印error级别下错误</span><br><span class="line">    if (ngx_test_config &amp;&amp; !ngx_quiet_mode) &#123;</span><br><span class="line">        ngx_log_stderr(0, &quot;the configuration file %s syntax is ok&quot;,</span><br><span class="line">                       cycle-&gt;conf_file.data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 执行每个核心模块的init方法。用于将create_conf时创建的管理配置项的类中，未设置的成员，设置为默认值</span><br><span class="line">    for (i = 0; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        if (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        module = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        if (module-&gt;init_conf) &#123;</span><br><span class="line">            if (module-&gt;init_conf(cycle,</span><br><span class="line">                                  cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index])</span><br><span class="line">                == NGX_CONF_ERROR)</span><br><span class="line">            &#123;</span><br><span class="line">                environ = senv;</span><br><span class="line">                ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">                return NULL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 如果是要给已存在服务发送信号，则结束处理。</span><br><span class="line">    if (ngx_process == NGX_PROCESS_SIGNALLER) &#123;</span><br><span class="line">        return cycle;</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取核心模块ngx_core_module解析配置后生成的ngx_core_conf_t结构体</span><br><span class="line">    ccf = (ngx_core_conf_t *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    // 如果是测试配置文件</span><br><span class="line">    if (ngx_test_config) &#123;</span><br><span class="line">        // 创建pid文件，如果是以单进程模式运行，即非master-worker方式，就不创建了</span><br><span class="line">        if (ngx_create_pidfile(&amp;ccf-&gt;pid, log) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else if (!ngx_is_init_cycle(old_cycle)) &#123;</span><br><span class="line">    // 如果不是新开始的一个服务（即已存在的服务调用init函数时），通过查看old_cycle是否存在ctx_conf来判断</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * we do not create the pid file in the first ngx_init_cycle() call</span><br><span class="line">         * because we need to write the demonized process pid</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">        old_ccf = (ngx_core_conf_t *) ngx_get_conf(old_cycle-&gt;conf_ctx,</span><br><span class="line">                                                   ngx_core_module);</span><br><span class="line">        // 如果新的pid目录和当前的不一致，则创建一个最新的，并删除当前的</span><br><span class="line">        if (ccf-&gt;pid.len != old_ccf-&gt;pid.len</span><br><span class="line">            || ngx_strcmp(ccf-&gt;pid.data, old_ccf-&gt;pid.data) != 0)</span><br><span class="line">        &#123;</span><br><span class="line">            /* new pid file name */</span><br><span class="line"></span><br><span class="line">            if (ngx_create_pidfile(&amp;ccf-&gt;pid, log) != NGX_OK) &#123;</span><br><span class="line">                goto failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_delete_pidfile(old_cycle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 测试锁文件，即为了解决惊群现象，多个子进程见使用锁来实现负载均衡。如果系统不支持原子的锁机制，则使用文件锁的形式，这时需要创建一个文件。*/</span><br><span class="line">    if (ngx_test_lockfile(cycle-&gt;lock_file.data, log) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    // 创建管理路径，具体下面介绍</span><br><span class="line">    if (ngx_create_paths(cycle, ccf-&gt;user) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 打开日志文件，具体下面介绍</span><br><span class="line">    if (ngx_log_open_default(cycle) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* open the new files */</span><br><span class="line">    // 对于需要打开的文件，执行创建</span><br><span class="line">    part = &amp;cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (file[i].name.len == 0) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        file[i].fd = ngx_open_file(file[i].name.data,</span><br><span class="line">                                   NGX_FILE_APPEND,</span><br><span class="line">                                   NGX_FILE_CREATE_OR_OPEN,</span><br><span class="line">                                   NGX_FILE_DEFAULT_ACCESS);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_CORE, log, 0,</span><br><span class="line">                       &quot;log: %p %d \&quot;%s\&quot;&quot;,</span><br><span class="line">                       &amp;file[i], file[i].fd, file[i].name.data);</span><br><span class="line"></span><br><span class="line">        if (file[i].fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          ngx_open_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if !(NGX_WIN32)</span><br><span class="line">        // 设置文件为执行时关闭，即子进程执行exec后不继承该文件描述符，适用于平滑升级</span><br><span class="line">        if (fcntl(file[i].fd, F_SETFD, FD_CLOEXEC) == -1) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          &quot;fcntl(FD_CLOEXEC) \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;log = &amp;cycle-&gt;new_log;</span><br><span class="line">    pool-&gt;log = &amp;cycle-&gt;new_log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* create shared memory */</span><br><span class="line">    // 创见共享内存，具体在共享内存介绍</span><br><span class="line">    part = &amp;cycle-&gt;shared_memory.part;</span><br><span class="line">    shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            shm_zone = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (shm_zone[i].shm.size == 0) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, 0,</span><br><span class="line">                          &quot;zero size shared memory zone \&quot;%V\&quot;&quot;,</span><br><span class="line">                          &amp;shm_zone[i].shm.name);</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        shm_zone[i].shm.log = cycle-&gt;log;</span><br><span class="line"></span><br><span class="line">        opart = &amp;old_cycle-&gt;shared_memory.part;</span><br><span class="line">        oshm_zone = opart-&gt;elts;</span><br><span class="line"></span><br><span class="line">        for (n = 0; /* void */ ; n++) &#123;</span><br><span class="line"></span><br><span class="line">            if (n &gt;= opart-&gt;nelts) &#123;</span><br><span class="line">                if (opart-&gt;next == NULL) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                opart = opart-&gt;next;</span><br><span class="line">                oshm_zone = opart-&gt;elts;</span><br><span class="line">                n = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].shm.name.len != oshm_zone[n].shm.name.len) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ngx_strncmp(shm_zone[i].shm.name.data,</span><br><span class="line">                            oshm_zone[n].shm.name.data,</span><br><span class="line">                            shm_zone[i].shm.name.len)</span><br><span class="line">                != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].tag == oshm_zone[n].tag</span><br><span class="line">                &amp;&amp; shm_zone[i].shm.size == oshm_zone[n].shm.size</span><br><span class="line">                &amp;&amp; !shm_zone[i].noreuse)</span><br><span class="line">            &#123;</span><br><span class="line">                shm_zone[i].shm.addr = oshm_zone[n].shm.addr;</span><br><span class="line">#if (NGX_WIN32)</span><br><span class="line">                shm_zone[i].shm.handle = oshm_zone[n].shm.handle;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">                if (shm_zone[i].init(&amp;shm_zone[i], oshm_zone[n].data)</span><br><span class="line">                    != NGX_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    goto failed;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                goto shm_zone_found;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_shm_alloc(&amp;shm_zone[i].shm) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_init_zone_pool(cycle, &amp;shm_zone[i]) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (shm_zone[i].init(&amp;shm_zone[i], NULL) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    shm_zone_found:</span><br><span class="line"></span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* handle the listening sockets */</span><br><span class="line">    // 处理监听套接字。</span><br><span class="line">    </span><br><span class="line">    if (old_cycle-&gt;listening.nelts) &#123;</span><br><span class="line">        ls = old_cycle-&gt;listening.elts;</span><br><span class="line">        // 遍历每一个旧版cycle监听的套接字，设置remain为0，即默认关闭所有旧套接字。</span><br><span class="line">        for (i = 0; i &lt; old_cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">            ls[i].remain = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nls = cycle-&gt;listening.elts;</span><br><span class="line">        /* 遍历每个新cycle的监听套接字，和旧套接字进行比对，如果新监听的套接字中存在与旧套接字一样的，则不关闭对应的旧套接字。*/</span><br><span class="line">        for (n = 0; n &lt; cycle-&gt;listening.nelts; n++) &#123;</span><br><span class="line"></span><br><span class="line">            for (i = 0; i &lt; old_cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">                // 如果旧套接字设置了ignore，表示该套接字发生错误，不需要进行比对。</span><br><span class="line">                if (ls[i].ignore) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // 如果旧套接字的remain已经为1，表示已经有一个新套接字和当前套接字地址一致，不能关闭当前套接字，因此不需要再比对</span><br><span class="line">                if (ls[i].remain) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // 类型不一致，不用比对</span><br><span class="line">                if (ls[i].type != nls[n].type) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // 对比新旧套接字地址是否一致</span><br><span class="line">                if (ngx_cmp_sockaddr(nls[n].sockaddr, nls[n].socklen,</span><br><span class="line">                                     ls[i].sockaddr, ls[i].socklen, 1)</span><br><span class="line">                    == NGX_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    // 新套接字设置为旧套接字的描述符</span><br><span class="line">                    nls[n].fd = ls[i].fd;</span><br><span class="line">                    // previous设置为对应的旧套接字</span><br><span class="line">                    nls[n].previous = &amp;ls[i];</span><br><span class="line">                    // 记录需要继续维护旧套接字（不能close）</span><br><span class="line">                    ls[i].remain = 1;</span><br><span class="line">                    // 如果新的套接字的backlog和旧版的不一致，则将listen置1，告知后续需要再次执行listen函数，来变更backlog</span><br><span class="line">                    if (ls[i].backlog != nls[n].backlog) &#123;</span><br><span class="line">                        nls[n].listen = 1;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line"></span><br><span class="line">                    /*</span><br><span class="line">                     * FreeBSD, except the most recent versions,</span><br><span class="line">                     * could not remove accept filter</span><br><span class="line">                     */</span><br><span class="line">                    nls[n].deferred_accept = ls[i].deferred_accept;</span><br><span class="line"></span><br><span class="line">                    if (ls[i].accept_filter &amp;&amp; nls[n].accept_filter) &#123;</span><br><span class="line">                        if (ngx_strcmp(ls[i].accept_filter,</span><br><span class="line">                                       nls[n].accept_filter)</span><br><span class="line">                            != 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            nls[n].delete_deferred = 1;</span><br><span class="line">                            nls[n].add_deferred = 1;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; else if (ls[i].accept_filter) &#123;</span><br><span class="line">                        nls[n].delete_deferred = 1;</span><br><span class="line"></span><br><span class="line">                    &#125; else if (nls[n].accept_filter) &#123;</span><br><span class="line">                        nls[n].add_deferred = 1;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line"></span><br><span class="line">                    if (ls[i].deferred_accept &amp;&amp; !nls[n].deferred_accept) &#123;</span><br><span class="line">                        nls[n].delete_deferred = 1;</span><br><span class="line"></span><br><span class="line">                    &#125; else if (ls[i].deferred_accept != nls[n].deferred_accept)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nls[n].add_deferred = 1;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_REUSEPORT)</span><br><span class="line">                    // 如果新的套接字设置了复用端口，但老的未设置，则将add_reuseport置1，告知后续需要设置套接字复用端口。</span><br><span class="line">                    if (nls[n].reuseport &amp;&amp; !ls[i].reuseport) &#123;</span><br><span class="line">                        nls[n].add_reuseport = 1;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // 如果套接字不为-1，表示当前套接字有效，后续不需要关闭套接字</span><br><span class="line">            if (nls[n].fd == (ngx_socket_t) -1) &#123;</span><br><span class="line">                nls[n].open = 1;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">                if (nls[n].accept_filter) &#123;</span><br><span class="line">                    nls[n].add_deferred = 1;</span><br><span class="line">                &#125;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line">                if (nls[n].deferred_accept) &#123;</span><br><span class="line">                    nls[n].add_deferred = 1;</span><br><span class="line">                &#125;</span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 如果不存在旧的监听套接字，则设置每个待初始化的新套接字有效</span><br><span class="line">        ls = cycle-&gt;listening.elts;</span><br><span class="line">        for (i = 0; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">            ls[i].open = 1;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">            if (ls[i].accept_filter) &#123;</span><br><span class="line">                ls[i].add_deferred = 1;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line">            if (ls[i].deferred_accept) &#123;</span><br><span class="line">                ls[i].add_deferred = 1;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 处理监听套接字，打开并绑定,详见配置项解析中，监听端口的管理章节</span><br><span class="line">    if (ngx_open_listening_sockets(cycle) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line">    // 设置套接字属性</span><br><span class="line">    if (!ngx_test_config) &#123;</span><br><span class="line">        ngx_configure_listening_sockets(cycle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* commit the new cycle configuration */</span><br><span class="line">    // 设置日志的错误输出到标注错误输出上</span><br><span class="line">    if (!ngx_use_stderr) &#123;</span><br><span class="line">        (void) ngx_log_redirect_stderr(cycle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pool-&gt;log = cycle-&gt;log;</span><br><span class="line">    // 执行每个module的init_module函数</span><br><span class="line">    if (ngx_init_modules(cycle) != NGX_OK) &#123;</span><br><span class="line">        /* fatal */</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* close and delete stuff that lefts from an old cycle */</span><br><span class="line"></span><br><span class="line">    /* free the unnecessary shared memory */</span><br><span class="line">    // 释放不再使用的共享存储</span><br><span class="line">    opart = &amp;old_cycle-&gt;shared_memory.part;</span><br><span class="line">    oshm_zone = opart-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= opart-&gt;nelts) &#123;</span><br><span class="line">            if (opart-&gt;next == NULL) &#123;</span><br><span class="line">                goto old_shm_zone_done;</span><br><span class="line">            &#125;</span><br><span class="line">            opart = opart-&gt;next;</span><br><span class="line">            oshm_zone = opart-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        part = &amp;cycle-&gt;shared_memory.part;</span><br><span class="line">        shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">        for (n = 0; /* void */ ; n++) &#123;</span><br><span class="line"></span><br><span class="line">            if (n &gt;= part-&gt;nelts) &#123;</span><br><span class="line">                if (part-&gt;next == NULL) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                part = part-&gt;next;</span><br><span class="line">                shm_zone = part-&gt;elts;</span><br><span class="line">                n = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (oshm_zone[i].shm.name.len != shm_zone[n].shm.name.len) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ngx_strncmp(oshm_zone[i].shm.name.data,</span><br><span class="line">                            shm_zone[n].shm.name.data,</span><br><span class="line">                            oshm_zone[i].shm.name.len)</span><br><span class="line">                != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (oshm_zone[i].tag == shm_zone[n].tag</span><br><span class="line">                &amp;&amp; oshm_zone[i].shm.size == shm_zone[n].shm.size</span><br><span class="line">                &amp;&amp; !oshm_zone[i].noreuse)</span><br><span class="line">            &#123;</span><br><span class="line">                goto live_shm_zone;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_shm_free(&amp;oshm_zone[i].shm);</span><br><span class="line"></span><br><span class="line">    live_shm_zone:</span><br><span class="line"></span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">old_shm_zone_done:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* close the unnecessary listening sockets */</span><br><span class="line">    // 关闭不再监听的旧的监听套接字</span><br><span class="line">    ls = old_cycle-&gt;listening.elts;</span><br><span class="line">    for (i = 0; i &lt; old_cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        // 对于需要维护的，或者是-1的，不进行处理</span><br><span class="line">        if (ls[i].remain || ls[i].fd == (ngx_socket_t) -1) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_socket(ls[i].fd) == -1) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_socket_errno,</span><br><span class="line">                          ngx_close_socket_n &quot; listening socket on %V failed&quot;,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_UNIX_DOMAIN)</span><br><span class="line">        // 对应unix域的套接字，删除文件</span><br><span class="line">        if (ls[i].sockaddr-&gt;sa_family == AF_UNIX) &#123;</span><br><span class="line">            u_char  *name;</span><br><span class="line"></span><br><span class="line">            name = ls[i].addr_text.data + sizeof(&quot;unix:&quot;) - 1;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_WARN, cycle-&gt;log, 0,</span><br><span class="line">                          &quot;deleting socket %s&quot;, name);</span><br><span class="line"></span><br><span class="line">            if (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;log, ngx_socket_errno,</span><br><span class="line">                              ngx_delete_file_n &quot; %s failed&quot;, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* close the unnecessary open files */</span><br><span class="line">    // 关闭不再需要的文件</span><br><span class="line">    part = &amp;old_cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (file[i].fd == NGX_INVALID_FILE || file[i].fd == ngx_stderr) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          ngx_close_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(conf.temp_pool);</span><br><span class="line"></span><br><span class="line">    if (ngx_process == NGX_PROCESS_MASTER || ngx_is_init_cycle(old_cycle)) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_destroy_pool(old_cycle-&gt;pool);</span><br><span class="line">        cycle-&gt;old_cycle = NULL;</span><br><span class="line"></span><br><span class="line">        return cycle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 申请临时的内存池</span><br><span class="line">    if (ngx_temp_pool == NULL) &#123;</span><br><span class="line">        ngx_temp_pool = ngx_create_pool(128, cycle-&gt;log);</span><br><span class="line">        if (ngx_temp_pool == NULL) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;log, 0,</span><br><span class="line">                          &quot;could not create ngx_temp_pool&quot;);</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n = 10;</span><br><span class="line"></span><br><span class="line">        if (ngx_array_init(&amp;ngx_old_cycles, ngx_temp_pool, n,</span><br><span class="line">                           sizeof(ngx_cycle_t *))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ngx_memzero(ngx_old_cycles.elts, n * sizeof(ngx_cycle_t *));</span><br><span class="line">        // 设置定时清理事件</span><br><span class="line">        ngx_cleaner_event.handler = ngx_clean_old_cycles;</span><br><span class="line">        ngx_cleaner_event.log = cycle-&gt;log;</span><br><span class="line">        ngx_cleaner_event.data = &amp;dumb;</span><br><span class="line">        dumb.fd = (ngx_socket_t) -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_temp_pool-&gt;log = cycle-&gt;log;</span><br><span class="line">    // 将旧的cycle添加到全局变量ngx_old_cycles中</span><br><span class="line">    old = ngx_array_push(&amp;ngx_old_cycles);</span><br><span class="line">    if (old == NULL) &#123;</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line">    *old = old_cycle;</span><br><span class="line">    // 设置定时清理事件的时间</span><br><span class="line">    if (!ngx_cleaner_event.timer_set) &#123;</span><br><span class="line">        ngx_add_timer(&amp;ngx_cleaner_event, 30000);</span><br><span class="line">        ngx_cleaner_event.timer_set = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    // 返回新创建的cycle</span><br><span class="line">    return cycle;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    if (!ngx_is_init_cycle(old_cycle)) &#123;</span><br><span class="line">        old_ccf = (ngx_core_conf_t *) ngx_get_conf(old_cycle-&gt;conf_ctx,</span><br><span class="line">                                                   ngx_core_module);</span><br><span class="line">        if (old_ccf-&gt;environment) &#123;</span><br><span class="line">            environ = old_ccf-&gt;environment;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* rollback the new cycle configuration */</span><br><span class="line"></span><br><span class="line">    part = &amp;cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (file[i].fd == NGX_INVALID_FILE || file[i].fd == ngx_stderr) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          ngx_close_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* free the newly created shared memory */</span><br><span class="line"></span><br><span class="line">    part = &amp;cycle-&gt;shared_memory.part;</span><br><span class="line">    shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            shm_zone = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (shm_zone[i].shm.addr == NULL) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        opart = &amp;old_cycle-&gt;shared_memory.part;</span><br><span class="line">        oshm_zone = opart-&gt;elts;</span><br><span class="line"></span><br><span class="line">        for (n = 0; /* void */ ; n++) &#123;</span><br><span class="line"></span><br><span class="line">            if (n &gt;= opart-&gt;nelts) &#123;</span><br><span class="line">                if (opart-&gt;next == NULL) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                opart = opart-&gt;next;</span><br><span class="line">                oshm_zone = opart-&gt;elts;</span><br><span class="line">                n = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].shm.name.len != oshm_zone[n].shm.name.len) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ngx_strncmp(shm_zone[i].shm.name.data,</span><br><span class="line">                            oshm_zone[n].shm.name.data,</span><br><span class="line">                            shm_zone[i].shm.name.len)</span><br><span class="line">                != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].tag == oshm_zone[n].tag</span><br><span class="line">                &amp;&amp; shm_zone[i].shm.size == oshm_zone[n].shm.size</span><br><span class="line">                &amp;&amp; !shm_zone[i].noreuse)</span><br><span class="line">            &#123;</span><br><span class="line">                goto old_shm_zone_found;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_shm_free(&amp;shm_zone[i].shm);</span><br><span class="line"></span><br><span class="line">    old_shm_zone_found:</span><br><span class="line"></span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ngx_test_config) &#123;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    for (i = 0; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        if (ls[i].fd == (ngx_socket_t) -1 || !ls[i].open) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_socket(ls[i].fd) == -1) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_socket_errno,</span><br><span class="line">                          ngx_close_socket_n &quot; %V failed&quot;,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line"></span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建管理目录"><a href="#创建管理目录" class="headerlink" title="创建管理目录"></a>创建管理目录</h4><p>ngx_create_paths。对于需要管理目录的配置，生成相应的目录，例如：http请求包体零时存放路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_body_temp_path dir-path [level1 [level2 [level3]]]</span><br></pre></td></tr></table></figure>
<h4 id="创建管理文件"><a href="#创建管理文件" class="headerlink" title="创建管理文件"></a>创建管理文件</h4><p>ngx_http_log_set_log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;access_log&quot;),</span><br><span class="line">  NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                    |NGX_HTTP_LMT_CONF|NGX_CONF_1MORE,</span><br><span class="line">  ngx_http_log_set_log,</span><br><span class="line">  NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">  0,</span><br><span class="line">  NULL &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="打开日志文件"><a href="#打开日志文件" class="headerlink" title="打开日志文件"></a>打开日志文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static ngx_command_t  ngx_errlog_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;error_log&quot;),</span><br><span class="line">      NGX_MAIN_CONF|NGX_CONF_1MORE,</span><br><span class="line">      ngx_error_log,</span><br><span class="line">      0,</span><br><span class="line">      0,</span><br><span class="line">      NULL &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="打开并设置监听地址"><a href="#打开并设置监听地址" class="headerlink" title="打开并设置监听地址"></a>打开并设置监听地址</h4><p>在看这部分之前，应该先查看配置项解析章节，至少需要查看其中的管理监听端口号部分。</p>
<h5 id="ngx-open-listening-sockets打开监听地址"><a href="#ngx-open-listening-sockets打开监听地址" class="headerlink" title="ngx_open_listening_sockets打开监听地址"></a>ngx_open_listening_sockets打开监听地址</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_open_listening_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>               reuseaddr;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, tries, failed;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>         err;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>        *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_socket_t</span>      s;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>  *ls;</span><br><span class="line"></span><br><span class="line">    reuseaddr = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">    failed = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> configurable try number */</span></span><br><span class="line">    <span class="comment">// 尝试重复执行5次</span></span><br><span class="line">    <span class="keyword">for</span> (tries = <span class="number">5</span>; tries; tries--) &#123;</span><br><span class="line">        failed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* for each listening socket */</span></span><br><span class="line"></span><br><span class="line">        ls = cycle-&gt;listening.elts;</span><br><span class="line">        <span class="comment">// 遍历每一个监听的listening</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">            <span class="comment">// 如果是ignore，则忽略</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].ignore) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">            <span class="comment">// 如果是add_reuseport则表示是一个旧的监听地址，需要增加reuseport属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].add_reuseport) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * to allow transition from a socket without SO_REUSEPORT</span></span><br><span class="line"><span class="comment">                 * to multiple sockets with SO_REUSEPORT, we have to set</span></span><br><span class="line"><span class="comment">                 * SO_REUSEPORT on the old socket before opening new ones</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span>  reuseport = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_REUSEPORT_LB</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT_LB,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT_LB) %V failed, "</span></span><br><span class="line">                                  <span class="string">"ignored"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                <span class="comment">// 设置地址的reuseport属性</span></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT) %V failed, ignored"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="comment">// 恢复为0，避免下次重复执行（由于整个大循环可能会执行多次）</span></span><br><span class="line">                ls[i].add_reuseport = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 如果套接字不为-1，则说明已经是已经打开的套接字（大循环可能执行多次）</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].fd != (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是继承而来的，则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].inherited) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* <span class="doctag">TODO:</span> close on exit */</span></span><br><span class="line">                <span class="comment">/* <span class="doctag">TODO:</span> nonblocking */</span></span><br><span class="line">                <span class="comment">/* <span class="doctag">TODO:</span> deferred accept */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建套接字</span></span><br><span class="line">            s = ngx_socket(ls[i].sockaddr-&gt;sa_family, ls[i].type, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (s == (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              ngx_socket_n <span class="string">" %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置套接字复用地址属性</span></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_REUSEADDR,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseaddr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_REUSEADDR) %V failed"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">            <span class="comment">// 如果用户设置了套接字的reuseport属性，则设置套接字的reuseport属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].reuseport &amp;&amp; !ngx_test_config) &#123;</span><br><span class="line">                <span class="keyword">int</span>  reuseport;</span><br><span class="line"></span><br><span class="line">                reuseport = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_REUSEPORT_LB</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_REUSEPORT_LB,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT_LB) %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                      ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                      &amp;ls[i].addr_text);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_REUSEPORT,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT) %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                      ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                      &amp;ls[i].addr_text);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6 &amp;&amp; defined IPV6_V6ONLY)</span></span><br><span class="line">            <span class="comment">// 设置套接字属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].sockaddr-&gt;sa_family == AF_INET6) &#123;</span><br><span class="line">                <span class="keyword">int</span>  ipv6only;</span><br><span class="line"></span><br><span class="line">                ipv6only = ls[i].ipv6only;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(s, IPPROTO_IPV6, IPV6_V6ONLY,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ipv6only, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(IPV6_V6ONLY) %V failed, ignored"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">/* <span class="doctag">TODO:</span> close on exit */</span></span><br><span class="line">            <span class="comment">// 如果选择的事件模块不是NGX_USE_IOCP_EVENT，则设置套接字为非阻塞的ioctl(s, FIONBIO, &amp;nb)</span></span><br><span class="line">            <span class="keyword">if</span> (!(ngx_event_flags &amp; NGX_USE_IOCP_EVENT)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_nonblocking(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_nonblocking_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                      ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                      &amp;ls[i].addr_text);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_CORE, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"bind() %V #%d "</span>, &amp;ls[i].addr_text, s);</span><br><span class="line">            <span class="comment">// 绑定套接字及其地址</span></span><br><span class="line">            <span class="keyword">if</span> (bind(s, ls[i].sockaddr, ls[i].socklen) == <span class="number">-1</span>) &#123;</span><br><span class="line">                err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE || !ngx_test_config) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, err,</span><br><span class="line">                                  <span class="string">"bind() to %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ngx_test_config) &#123;</span><br><span class="line">                    failed = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">            <span class="comment">// 如果是unix域套接字，则变更对应的文件属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].sockaddr-&gt;sa_family == AF_UNIX) &#123;</span><br><span class="line">                <span class="keyword">mode_t</span>   mode;</span><br><span class="line">                u_char  *name;</span><br><span class="line"></span><br><span class="line">                name = ls[i].addr_text.data + <span class="keyword">sizeof</span>(<span class="string">"unix:"</span>) - <span class="number">1</span>;</span><br><span class="line">                mode = (S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (chmod((<span class="keyword">char</span> *) name, mode) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                  <span class="string">"chmod() \"%s\" failed"</span>, name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                      ngx_delete_file_n <span class="string">" %s failed"</span>, name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ls[i].type != SOCK_STREAM) &#123;</span><br><span class="line">                ls[i].fd = s;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 开启监听</span></span><br><span class="line">            <span class="keyword">if</span> (listen(s, ls[i].backlog) == <span class="number">-1</span>) &#123;</span><br><span class="line">                err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * on OpenVZ after suspend/resume EADDRINUSE</span></span><br><span class="line"><span class="comment">                 * may be returned by listen() instead of bind(), see</span></span><br><span class="line"><span class="comment">                 * https://bugzilla.openvz.org/show_bug.cgi?id=2470</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE || !ngx_test_config) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, err,</span><br><span class="line">                                  <span class="string">"listen() to %V, backlog %d failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text, ls[i].backlog);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ngx_test_config) &#123;</span><br><span class="line">                    failed = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 标记已监听</span></span><br><span class="line">            ls[i].listen = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 设置描述符</span></span><br><span class="line">            ls[i].fd = s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有错误，则跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (!failed) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> delay configurable */</span></span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"try again to bind() after 500ms"</span>);</span><br><span class="line">        <span class="comment">// 如果有错，则500ms重试</span></span><br><span class="line">        ngx_msleep(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (failed) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"still could not bind()"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要着重关注一下reuseport属性。对于监听多个地址：不同ip+同一个port，如果未开启该属性时，会失败。例如如下配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8884</span> bind;</span><br><span class="line">        <span class="attribute">location</span> /L1 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8884</span>;</span><br><span class="line">        <span class="attribute">server_name</span> chst.bcc-bdbl.baidu.com;</span><br><span class="line">        <span class="attribute">location</span> /L2 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，对于127.0.0.1:8884这个地址，我们希望进行单独的监听（设置了bind），这时会先单独对该地址进行bind。而后，对于0.0.0.0:8884这个通配符地址来说，我们还要再执行一次bind。但由于未设置reuseport属性，监听0.0.0.0:8884将会出错。改成如下配置则可以正常监听：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8884</span> bind reuseport;</span><br><span class="line">        <span class="attribute">location</span> /L1 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8884</span> reuseport;</span><br><span class="line">        <span class="attribute">server_name</span> chst.bcc-bdbl.baidu.com;</span><br><span class="line">        <span class="attribute">location</span> /L2 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，两个地址都设置了reuseport属性，此时可以实现正常监听。由于对每个ip+port形式的地址，nginx维护一个ngx_http_listen_opt_t。因此两个listen都需要加上reuseport才行。注意如下配置也不会有问题：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8884</span>;</span><br><span class="line">        <span class="attribute">location</span> /L1 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8884</span>;</span><br><span class="line">        <span class="attribute">server_name</span> chst.bcc-bdbl.baidu.com;</span><br><span class="line">        <span class="attribute">location</span> /L2 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时由于第一个地址并未设置bind。此时不会单独对127.0.0.1:8884创建一个套接字。而是直接在0.0.0.0:8884这个通配符地址上进行监听。对于建立的连接，通过<code>getsockname</code>函数来发现绑定到套接字上的地址，以此来区分使用哪个虚拟服务。</p>
<h5 id="ngx-configure-listening-sockets设置套接字属性"><a href="#ngx-configure-listening-sockets设置套接字属性" class="headerlink" title="ngx_configure_listening_sockets设置套接字属性"></a>ngx_configure_listening_sockets设置套接字属性</h5><p>通过setsockopt函数对套接字进行设置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_configure_listening_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                        value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">accept_filter_arg</span>   <span class="title">af</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ls[i].<span class="built_in">log</span> = *ls[i].logp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].rcvbuf != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_RCVBUF,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].rcvbuf, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_RCVBUF, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].rcvbuf, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].sndbuf != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_SNDBUF,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].sndbuf, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_SNDBUF, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].sndbuf, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepalive) &#123;</span><br><span class="line">            value = (ls[i].keepalive == <span class="number">1</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_KEEPALIVE,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_KEEPALIVE, %d) %V failed, ignored"</span>,</span><br><span class="line">                              value, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KEEPALIVE_TUNABLE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepidle) &#123;</span><br><span class="line">            value = ls[i].keepidle;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_KEEPALIVE_FACTOR)</span></span><br><span class="line">            value *= NGX_KEEPALIVE_FACTOR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_KEEPIDLE,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_KEEPIDLE, %d) %V failed, ignored"</span>,</span><br><span class="line">                              value, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepintvl) &#123;</span><br><span class="line">            value = ls[i].keepintvl;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_KEEPALIVE_FACTOR)</span></span><br><span class="line">            value *= NGX_KEEPALIVE_FACTOR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_KEEPINTVL,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                             <span class="string">"setsockopt(TCP_KEEPINTVL, %d) %V failed, ignored"</span>,</span><br><span class="line">                             value, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepcnt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_KEEPCNT,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].keepcnt, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_KEEPCNT, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].keepcnt, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].setfib != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_SETFIB,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].setfib, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_SETFIB, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].setfib, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].fastopen != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_FASTOPEN,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].fastopen, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_FASTOPEN, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].fastopen, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> tcp_nodelay = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_NODELAY,</span><br><span class="line">                       (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;tcp_nodelay, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_NODELAY) %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].listen) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* change backlog via listen() */</span></span><br><span class="line">            <span class="comment">// 通过listen函数来重新设置backlog大小</span></span><br><span class="line">            <span class="keyword">if</span> (listen(ls[i].fd, ls[i].backlog) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"listen() to %V, backlog %d failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text, ls[i].backlog);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * setting deferred mode should be last operation on socket,</span></span><br><span class="line"><span class="comment">         * because code may prematurely continue cycle on failure</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_ACCEPTFILTER</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].delete_deferred) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_ACCEPTFILTER, <span class="literal">NULL</span>, <span class="number">0</span>)</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_ACCEPTFILTER, NULL) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ls[i].accept_filter) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"could not change the accept filter "</span></span><br><span class="line">                                  <span class="string">"to \"%s\" for %V, ignored"</span>,</span><br><span class="line">                                  ls[i].accept_filter, &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].deferred_accept = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].add_deferred) &#123;</span><br><span class="line">            ngx_memzero(&amp;af, <span class="keyword">sizeof</span>(struct accept_filter_arg));</span><br><span class="line">            (<span class="keyword">void</span>) ngx_cpystrn((u_char *) af.af_name,</span><br><span class="line">                               (u_char *) ls[i].accept_filter, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_ACCEPTFILTER,</span><br><span class="line">                           &amp;af, <span class="keyword">sizeof</span>(struct accept_filter_arg))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_ACCEPTFILTER, \"%s\") "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].accept_filter, &amp;ls[i].addr_text);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].deferred_accept = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TCP_DEFER_ACCEPT</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].add_deferred || ls[i].delete_deferred) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ls[i].add_deferred) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * There is no way to find out how long a connection was</span></span><br><span class="line"><span class="comment">                 * in queue (and a connection may bypass deferred queue at all</span></span><br><span class="line"><span class="comment">                 * if syncookies were used), hence we use 1 second timeout</span></span><br><span class="line"><span class="comment">                 * here.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_DEFER_ACCEPT,</span><br><span class="line">                           &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_DEFER_ACCEPT, %d) for %V failed, "</span></span><br><span class="line">                              <span class="string">"ignored"</span>,</span><br><span class="line">                              value, &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].add_deferred) &#123;</span><br><span class="line">            ls[i].deferred_accept = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NGX_HAVE_DEFERRED_ACCEPT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_IP_RECVDSTADDR)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].wildcard</span><br><span class="line">            &amp;&amp; ls[i].type == SOCK_DGRAM</span><br><span class="line">            &amp;&amp; ls[i].sockaddr-&gt;sa_family == AF_INET)</span><br><span class="line">        &#123;</span><br><span class="line">            value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_IP, IP_RECVDSTADDR,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(IP_RECVDSTADDR) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> (NGX_HAVE_IP_PKTINFO)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].wildcard</span><br><span class="line">            &amp;&amp; ls[i].type == SOCK_DGRAM</span><br><span class="line">            &amp;&amp; ls[i].sockaddr-&gt;sa_family == AF_INET)</span><br><span class="line">        &#123;</span><br><span class="line">            value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_IP, IP_PKTINFO,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(IP_PKTINFO) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6 &amp;&amp; NGX_HAVE_IPV6_RECVPKTINFO)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].wildcard</span><br><span class="line">            &amp;&amp; ls[i].type == SOCK_DGRAM</span><br><span class="line">            &amp;&amp; ls[i].sockaddr-&gt;sa_family == AF_INET6)</span><br><span class="line">        &#123;</span><br><span class="line">            value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_IPV6, IPV6_RECVPKTINFO,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(IPV6_RECVPKTINFO) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试配置的处理"><a href="#测试配置的处理" class="headerlink" title="测试配置的处理"></a>测试配置的处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">    <span class="comment">// 测试配置文件处理</span></span><br><span class="line">    <span class="comment">// 如果需要打印非error的日志</span></span><br><span class="line">    <span class="keyword">if</span> (!ngx_quiet_mode) &#123;</span><br><span class="line">        ngx_log_stderr(<span class="number">0</span>, <span class="string">"configuration file %s test is successful"</span>,</span><br><span class="line">                       cycle-&gt;conf_file.data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果需要将配置dump打印</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_dump_config) &#123;</span><br><span class="line">        cd = cycle-&gt;config_dump.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;config_dump.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">            ngx_write_stdout(<span class="string">"# configuration file "</span>);</span><br><span class="line">            (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, cd[i].name.data,</span><br><span class="line">                                cd[i].name.len);</span><br><span class="line">            ngx_write_stdout(<span class="string">":"</span> NGX_LINEFEED);</span><br><span class="line"></span><br><span class="line">            b = cd[i].buffer;</span><br><span class="line"></span><br><span class="line">            (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, b-&gt;pos, b-&gt;last - b-&gt;pos);</span><br><span class="line">            ngx_write_stdout(NGX_LINEFEED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送信号处理"><a href="#发送信号处理" class="headerlink" title="发送信号处理"></a>发送信号处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_signal) &#123;</span><br><span class="line">    <span class="comment">// 如果是向正在执行的nginx服务发送信号</span></span><br><span class="line">    <span class="keyword">return</span> ngx_signal_process(cycle, ngx_signal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_signal_process(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">char</span> *sig)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>           n;</span><br><span class="line">    <span class="keyword">ngx_pid_t</span>         pid;</span><br><span class="line">    <span class="keyword">ngx_file_t</span>        file;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line">    u_char            buf[NGX_INT64_LEN + <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"signal process started"</span>);</span><br><span class="line">    <span class="comment">// 获取解析到的pid文件</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;file, <span class="keyword">sizeof</span>(<span class="keyword">ngx_file_t</span>));</span><br><span class="line"></span><br><span class="line">    file.name = ccf-&gt;pid;</span><br><span class="line">    file.<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    file.fd = ngx_open_file(file.name.data, NGX_FILE_RDONLY,</span><br><span class="line">                            NGX_FILE_OPEN, NGX_FILE_DEFAULT_ACCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file.fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      ngx_open_file_n <span class="string">" \"%s\" failed"</span>, file.name.data);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取内容</span></span><br><span class="line">    n = ngx_read_file(&amp;file, buf, NGX_INT64_LEN + <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_close_file(file.fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      ngx_close_file_n <span class="string">" \"%s\" failed"</span>, file.name.data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去除末尾的\r,\n</span></span><br><span class="line">    <span class="keyword">while</span> (n-- &amp;&amp; (buf[n] == CR || buf[n] == LF)) &#123; <span class="comment">/* void */</span> &#125;</span><br><span class="line">    <span class="comment">// 获取进程id</span></span><br><span class="line">    pid = ngx_atoi(buf, ++n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == (<span class="keyword">ngx_pid_t</span>) NGX_ERROR) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"invalid PID number \"%*s\" in \"%s\""</span>,</span><br><span class="line">                      n, buf, file.name.data);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行发送信号</span></span><br><span class="line">    <span class="keyword">return</span> ngx_os_signal_process(cycle, sig, pid);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span>     signo;</span><br><span class="line">    <span class="keyword">char</span>   *signame;</span><br><span class="line">    <span class="keyword">char</span>   *name;</span><br><span class="line">    <span class="keyword">void</span>  (*handler)(<span class="keyword">int</span> signo, <span class="keyword">siginfo_t</span> *siginfo, <span class="keyword">void</span> *ucontext);</span><br><span class="line">&#125; <span class="keyword">ngx_signal_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_os_signal_process(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">char</span> *name, <span class="keyword">ngx_pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_signal_t</span>  *sig;</span><br><span class="line">    <span class="comment">// 遍历所有系统支持信号，找到发送的信号，向对应的进程发送信号。</span></span><br><span class="line">    <span class="keyword">for</span> (sig = signals; sig-&gt;signo != <span class="number">0</span>; sig++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_strcmp(name, sig-&gt;name) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (kill(pid, sig-&gt;signo) != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"kill(%P, %d) failed"</span>, pid, sig-&gt;signo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体对接收到信号的处理，后续介绍。</p>
<h3 id="判断运行方式"><a href="#判断运行方式" class="headerlink" title="判断运行方式"></a>判断运行方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 获取配置解析的ngx_core_module解析项</span><br><span class="line">ccf = (ngx_core_conf_t *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">// 如果设置了master，并且在此之前未设置其他运行方式（默认NGX_PROCESS_SINGLE 0），ngx_process为全局变量，初值为0</span><br><span class="line">if (ccf-&gt;master &amp;&amp; ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">    // 设置运行方式为mater-worker方式运行</span><br><span class="line">    ngx_process = NGX_PROCESS_MASTER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_init_signals(cycle-&gt;log) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    int     signo; // 信号</span><br><span class="line">    char   *signame; // 信号名</span><br><span class="line">    char   *name;</span><br><span class="line">    void  (*handler)(int signo, siginfo_t *siginfo, void *ucontext); // 处理函数</span><br><span class="line">&#125; ngx_signal_t;</span><br><span class="line"></span><br><span class="line">ngx_signal_t  signals[] = &#123;</span><br><span class="line">    &#123; ngx_signal_value(NGX_RECONFIGURE_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_RECONFIGURE_SIGNAL),</span><br><span class="line">      &quot;reload&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_REOPEN_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_REOPEN_SIGNAL),</span><br><span class="line">      &quot;reopen&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_NOACCEPT_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_NOACCEPT_SIGNAL),</span><br><span class="line">      &quot;&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_TERMINATE_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_TERMINATE_SIGNAL),</span><br><span class="line">      &quot;stop&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_SHUTDOWN_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_SHUTDOWN_SIGNAL),</span><br><span class="line">      &quot;quit&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_CHANGEBIN_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_CHANGEBIN_SIGNAL),</span><br><span class="line">      &quot;&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGALRM, &quot;SIGALRM&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGINT, &quot;SIGINT&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGIO, &quot;SIGIO&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGCHLD, &quot;SIGCHLD&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGSYS, &quot;SIGSYS, SIG_IGN&quot;, &quot;&quot;, NULL &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGPIPE, &quot;SIGPIPE, SIG_IGN&quot;, &quot;&quot;, NULL &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; 0, NULL, &quot;&quot;, NULL &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ngx_int_t</span><br><span class="line">ngx_init_signals(ngx_log_t *log)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_signal_t      *sig;</span><br><span class="line">    struct sigaction   sa;</span><br><span class="line">    // 其中signals为ngx_signal_t数组</span><br><span class="line">    for (sig = signals; sig-&gt;signo != 0; sig++) &#123;</span><br><span class="line">        ngx_memzero(&amp;sa, sizeof(struct sigaction));</span><br><span class="line"></span><br><span class="line">        if (sig-&gt;handler) &#123;</span><br><span class="line">            sa.sa_sigaction = sig-&gt;handler;</span><br><span class="line">            sa.sa_flags = SA_SIGINFO;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sa.sa_handler = SIG_IGN;</span><br><span class="line">        &#125;</span><br><span class="line">        // 注册信号处理函数</span><br><span class="line">        sigemptyset(&amp;sa.sa_mask);</span><br><span class="line">        if (sigaction(sig-&gt;signo, &amp;sa, NULL) == -1) &#123;</span><br><span class="line">#if (NGX_VALGRIND)</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, log, ngx_errno,</span><br><span class="line">                          &quot;sigaction(%s) failed, ignored&quot;, sig-&gt;signame);</span><br><span class="line">#else</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          &quot;sigaction(%s) failed&quot;, sig-&gt;signame);</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>信号处理相关内容可以查看如下文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E4%BF%A1%E5%8F%B7" target="_blank" rel="noopener">信号处理</a>。其中处理函数为空的函数，即表示不对信号做任何处理，即忽略。其他信号处理函数均为ngx_signal_handler。处理如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_signal_handler(<span class="keyword">int</span> signo, <span class="keyword">siginfo_t</span> *siginfo, <span class="keyword">void</span> *ucontext)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>            *action;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>        ignore;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>        err;</span><br><span class="line">    <span class="keyword">ngx_signal_t</span>    *sig;</span><br><span class="line"></span><br><span class="line">    ignore = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    err = ngx_errno;</span><br><span class="line">    <span class="comment">// 首先找到对应的信号，用于获取信号名记录log</span></span><br><span class="line">    <span class="keyword">for</span> (sig = signals; sig-&gt;signo != <span class="number">0</span>; sig++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sig-&gt;signo == signo) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 以线程安全的方式更新时间，具体参考时间章节介绍</span></span><br><span class="line">    ngx_time_sigsafe_update();</span><br><span class="line"></span><br><span class="line">    action = <span class="string">""</span>;</span><br><span class="line">    <span class="comment">// 在每个子进程中，都会先设置进行类型ngx_process</span></span><br><span class="line">    <span class="keyword">switch</span> (ngx_process) &#123;</span><br><span class="line">    <span class="comment">// master进程，或者单进程运行模式下处理</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_MASTER:</span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_SINGLE:</span><br><span class="line">        <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line">        <span class="comment">// 退出信号，设置ngx_quit为1</span></span><br><span class="line">        case ngx_signal_value(NGX_SHUTDOWN_SIGNAL):</span><br><span class="line">            ngx_quit = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", shutting down"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 终止信息。ngx_terminate设置为1</span></span><br><span class="line">        case ngx_signal_value(NGX_TERMINATE_SIGNAL):</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            ngx_terminate = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", exiting"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 停止接收连接信号，如果是守护进程方式运行，则将ngx_noaccept置1</span></span><br><span class="line">        case ngx_signal_value(NGX_NOACCEPT_SIGNAL):</span><br><span class="line">            <span class="keyword">if</span> (ngx_daemonized) &#123;</span><br><span class="line">                ngx_noaccept = <span class="number">1</span>;</span><br><span class="line">                action = <span class="string">", stop accepting connections"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新加载配置</span></span><br><span class="line">        case ngx_signal_value(NGX_RECONFIGURE_SIGNAL):</span><br><span class="line">            ngx_reconfigure = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", reconfiguring"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新打开日志文件</span></span><br><span class="line">        case ngx_signal_value(NGX_REOPEN_SIGNAL):</span><br><span class="line">            ngx_reopen = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", reopening logs"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 变更二进制文件，即不关机重启</span></span><br><span class="line">        case ngx_signal_value(NGX_CHANGEBIN_SIGNAL):</span><br><span class="line">            <span class="comment">/* 对应不关机升级来说，master进行会fork子进程，运行新的二进制文件。而后应该由用户向老的master进程发送终止解析，使旧版服务退出。原master退出来，新的mater进程将会被init进程接管，即此时新master进程的父进程id为init进程id：1。对于新进程来说，如果其父进程依旧为原来mater进程的子进程id时，说明原来master进程还未退出，此时会忽略该信号。对于老的master进程来说，如果ngx_new_binary大于0，表明新的二进制文件已经在运行了，此时也会忽略该信号。*/</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_getppid() == ngx_parent || ngx_new_binary &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Ignore the signal in the new binary if its parent is</span></span><br><span class="line"><span class="comment">                 * not changed, i.e. the old binary's process is still</span></span><br><span class="line"><span class="comment">                 * running.  Or ignore the signal in the old binary's</span></span><br><span class="line"><span class="comment">                 * process if the new binary's process is already running.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                action = <span class="string">", ignoring"</span>;</span><br><span class="line">                ignore = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置ngx_change_binary为1</span></span><br><span class="line">            ngx_change_binary = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", changing binary"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SIGALRM:</span><br><span class="line">            <span class="comment">// 时钟信号</span></span><br><span class="line">            ngx_sigalrm = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 异步io</span></span><br><span class="line">        <span class="keyword">case</span> SIGIO:</span><br><span class="line">            ngx_sigio = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 子进程退出或终止</span></span><br><span class="line">        <span class="keyword">case</span> SIGCHLD:</span><br><span class="line">            ngx_reap = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// worker和helper进程处理逻辑</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_WORKER:</span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_HELPER:</span><br><span class="line">        <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line">        <span class="comment">// 退出debug</span></span><br><span class="line">        case ngx_signal_value(NGX_NOACCEPT_SIGNAL):</span><br><span class="line">            <span class="keyword">if</span> (!ngx_daemonized) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ngx_debug_quit = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">/* fall through */</span></span><br><span class="line">        <span class="comment">// 关闭</span></span><br><span class="line">        case ngx_signal_value(NGX_SHUTDOWN_SIGNAL):</span><br><span class="line">            ngx_quit = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", shutting down"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 退出</span></span><br><span class="line">        case ngx_signal_value(NGX_TERMINATE_SIGNAL):</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            ngx_terminate = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", exiting"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新打开日志文件</span></span><br><span class="line">        case ngx_signal_value(NGX_REOPEN_SIGNAL):</span><br><span class="line">            ngx_reopen = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", reopening logs"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 忽略重新读取配置、变更二进制文件，异步io</span></span><br><span class="line">        case ngx_signal_value(NGX_RECONFIGURE_SIGNAL):</span><br><span class="line">        case ngx_signal_value(NGX_CHANGEBIN_SIGNAL):</span><br><span class="line">        <span class="keyword">case</span> SIGIO:</span><br><span class="line">            action = <span class="string">", ignoring"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录日志，根据是否能够明确信号来源进行划分。</span></span><br><span class="line">    <span class="keyword">if</span> (siginfo &amp;&amp; siginfo-&gt;si_pid) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"signal %d (%s) received from %P%s"</span>,</span><br><span class="line">                      signo, sig-&gt;signame, siginfo-&gt;si_pid, action);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"signal %d (%s) received%s"</span>,</span><br><span class="line">                      signo, sig-&gt;signame, action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ignore) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"the changing binary signal is ignored: "</span></span><br><span class="line">                      <span class="string">"you should shutdown or terminate "</span></span><br><span class="line">                      <span class="string">"before either old or new binary's process"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子进程终止，则执行如下处理</span></span><br><span class="line">    <span class="keyword">if</span> (signo == SIGCHLD) &#123;</span><br><span class="line">        ngx_process_get_status();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_set_errno(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应子进程退出时的处理如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_process_get_status(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>              status;</span><br><span class="line">    <span class="keyword">char</span>            *process;</span><br><span class="line">    <span class="keyword">ngx_pid_t</span>        pid;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>        err;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       one;</span><br><span class="line"></span><br><span class="line">    one = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 不阻塞的查看其子进程中哪个进程结束</span></span><br><span class="line">        pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG);</span><br><span class="line">        <span class="comment">// 如果没有终止进程，则返回</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果获取终止子进程失败</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            err = ngx_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EINTR) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ECHILD &amp;&amp; one) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Solaris always calls the signal handler for each exited process</span></span><br><span class="line"><span class="comment">             * despite waitpid() may be already called for this process.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * When several processes exit at the same time FreeBSD may</span></span><br><span class="line"><span class="comment">             * erroneously call the signal handler for exited process</span></span><br><span class="line"><span class="comment">             * despite waitpid() may be already called for this process.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ECHILD) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_INFO, ngx_cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                              <span class="string">"waitpid() failed"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"waitpid() failed"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 标注找到一个退出进程</span></span><br><span class="line">        one = <span class="number">1</span>;</span><br><span class="line">        process = <span class="string">"unknown process"</span>;</span><br><span class="line">        <span class="comment">// 遍历保存进程信息的ngx_processes数组，找到对应的元素，设置其状态，并设置其exited为1</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_last_process; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_processes[i].pid == pid) &#123;</span><br><span class="line">                ngx_processes[i].status = status;</span><br><span class="line">                ngx_processes[i].exited = <span class="number">1</span>;</span><br><span class="line">                process = ngx_processes[i].name;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进程异常终止，获取子进程终止的信号编号。</span></span><br><span class="line">        <span class="keyword">if</span> (WTERMSIG(status)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WCOREDUMP</span></span><br><span class="line">            <span class="comment">// 可以通过WCOREDUMP获取否生成了终止进程的core文件</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited on signal %d%s"</span>,</span><br><span class="line">                          process, pid, WTERMSIG(status),</span><br><span class="line">                          WCOREDUMP(status) ? <span class="string">" (core dumped)"</span> : <span class="string">""</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited on signal %d"</span>,</span><br><span class="line">                          process, pid, WTERMSIG(status));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited with code %d"</span>,</span><br><span class="line">                          process, pid, WEXITSTATUS(status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取子进程传递给exit或_exit参数的低八位,如果值为2，并且进程需要重启</span></span><br><span class="line">        <span class="keyword">if</span> (WEXITSTATUS(status) == <span class="number">2</span> &amp;&amp; ngx_processes[i].respawn) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited with fatal code %d "</span></span><br><span class="line">                          <span class="string">"and cannot be respawned"</span>,</span><br><span class="line">                          process, pid, WEXITSTATUS(status));</span><br><span class="line">            ngx_processes[i].respawn = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 释放终止进程所持有的锁</span></span><br><span class="line">        ngx_unlock_mutexes(pid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应进程终止相关处理，可参考如下文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener">进程控制</a>。</p>
<p>释放终止进程锁的函数逻辑如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_unlock_mutexes(<span class="keyword">ngx_pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_shm_zone_t</span>   *shm_zone;</span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>  *part;</span><br><span class="line">    <span class="keyword">ngx_slab_pool_t</span>  *sp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * unlock the accept mutex if the abnormally exited process</span></span><br><span class="line"><span class="comment">     * held it</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* 如果设置了进程间的负载均衡锁，则根据该进程是否拥有该锁，进行释放操作。注意ngx_accept_mutex也是使用mmap内存映射技术来生成的，因此所有进程共享。*/</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_accept_mutex_ptr) &#123;</span><br><span class="line">        (<span class="keyword">void</span>) ngx_shmtx_force_unlock(&amp;ngx_accept_mutex, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * unlock shared memory mutexes if held by the abnormally exited</span></span><br><span class="line"><span class="comment">     * process</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 释放共享内存的锁</span></span><br><span class="line">    part = (<span class="keyword">ngx_list_part_t</span> *) &amp;ngx_cycle-&gt;shared_memory.part;</span><br><span class="line">    shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; <span class="comment">/* void */</span> ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            <span class="keyword">if</span> (part-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            shm_zone = part-&gt;elts;</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp = (<span class="keyword">ngx_slab_pool_t</span> *) shm_zone[i].shm.addr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_shmtx_force_unlock(&amp;sp-&gt;mutex, pid)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"shared memory zone \"%V\" was locked by %P"</span>,</span><br><span class="line">                          &amp;shm_zone[i].shm.name, pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="变更运行状态为守护进程"><a href="#变更运行状态为守护进程" class="headerlink" title="变更运行状态为守护进程"></a>变更运行状态为守护进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 非继承而来，即正常启动，并且设置为守护进程运行模式（默认）</span><br><span class="line">if (!ngx_inherited &amp;&amp; ccf-&gt;daemon) &#123;</span><br><span class="line">    // 进程变更为守护进程模式</span><br><span class="line">    if (ngx_daemon(cycle-&gt;log) != NGX_OK) &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_daemonized = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (ngx_inherited) &#123;</span><br><span class="line">    ngx_daemonized = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx默认为以守护进程的模式运行。关于守护进程，详细信息可以参考如下文档，其实际方法也与其大致相同。<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B" target="_blank" rel="noopener">守护进程</a>。</p>
<h3 id="创建pid文件"><a href="#创建pid文件" class="headerlink" title="创建pid文件"></a>创建pid文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 对于非继承而来的进程，会创建pid文件，继承而来的进程，已经在init cycle中创建了，详情参考上文。</span><br><span class="line">if (ngx_create_pidfile(&amp;ccf-&gt;pid, cycle-&gt;log) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置运行方式"><a href="#设置运行方式" class="headerlink" title="设置运行方式"></a>设置运行方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">    ngx_single_process_cycle(cycle);</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">    ngx_master_process_cycle(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据是单进程模式运行还是master-workers方式执行对应的方法。这里我们只看master-worker方式运行。</p>
<h3 id="执行主体循环"><a href="#执行主体循环" class="headerlink" title="执行主体循环"></a>执行主体循环</h3><p>根据配置，选择运行方式，分别为单进程方式运行和master-workers方式运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">    ngx_single_process_cycle(cycle);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ngx_master_process_cycle(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体细节参考master进程和worker进程逻辑。</p>
<h1 id="master进程逻辑"><a href="#master进程逻辑" class="headerlink" title="master进程逻辑"></a>master进程逻辑</h1><h2 id="整体处理函数"><a href="#整体处理函数" class="headerlink" title="整体处理函数"></a>整体处理函数</h2><p>这里只介绍以master-worker形式运行的情况。其执行入口为如下函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_master_process_cycle(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>              *title;</span><br><span class="line">    u_char            *p;</span><br><span class="line">    <span class="keyword">size_t</span>             size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>          i;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         sigio;</span><br><span class="line">    <span class="keyword">sigset_t</span>           <span class="built_in">set</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span>   <span class="title">itv</span>;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         live;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>         delay;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>   *ccf;</span><br><span class="line"></span><br><span class="line">    sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGCHLD);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGALRM);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGIO);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGINT);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, ngx_signal_value(NGX_RECONFIGURE_SIGNAL));</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, ngx_signal_value(NGX_REOPEN_SIGNAL));</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, ngx_signal_value(NGX_NOACCEPT_SIGNAL));</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, ngx_signal_value(NGX_TERMINATE_SIGNAL));</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, ngx_signal_value(NGX_SHUTDOWN_SIGNAL));</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, ngx_signal_value(NGX_CHANGEBIN_SIGNAL));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 暂时屏蔽上述信号，使其处于未决状态</span></span><br><span class="line">    <span class="keyword">if</span> (sigprocmask(SIG_BLOCK, &amp;<span class="built_in">set</span>, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sigprocmask() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置set信号集为空</span></span><br><span class="line">    sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    size = <span class="keyword">sizeof</span>(master_process);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_argc; i++) &#123;</span><br><span class="line">        size += ngx_strlen(ngx_argv[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    title = ngx_pnalloc(cycle-&gt;pool, size);</span><br><span class="line">    <span class="keyword">if</span> (title == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* fatal */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    p = ngx_cpymem(title, master_process, <span class="keyword">sizeof</span>(master_process) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_argc; i++) &#123;</span><br><span class="line">        *p++ = <span class="string">' '</span>;</span><br><span class="line">        p = ngx_cpystrn(p, (u_char *) ngx_argv[i], size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过设置argv[0]的值来变更进程名，影响ps命令打印的进程名</span></span><br><span class="line">    ngx_setproctitle(title);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取配置解析后的ngx_core_conf_t结构体</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据设置的workers子进程数量，生成子进程。详见子进程处理逻辑部分</span></span><br><span class="line">    ngx_start_worker_processes(cycle, ccf-&gt;worker_processes,</span><br><span class="line">                               NGX_PROCESS_RESPAWN);</span><br><span class="line">    <span class="comment">// 运行cache管理进程（复制管理）</span></span><br><span class="line">    ngx_start_cache_manager_processes(cycle, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标记是否已经运行了一个新的二进制文件，如果是，则该值为新的二进制文件的pid</span></span><br><span class="line">    ngx_new_binary = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 收到强制关闭时延迟关闭时间</span></span><br><span class="line">    delay = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 在执行退出时，记录子进程关闭数量</span></span><br><span class="line">    sigio = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 是否还有存活的子进程</span></span><br><span class="line">    live = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// master主进程循环</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 如果delay不为0，表示接收到强制退出的指令</span></span><br><span class="line">        <span class="keyword">if</span> (delay) &#123;</span><br><span class="line">            <span class="comment">// 如果ngx_sigalrm不为0，表示之前的定时器已超时。则将delay乘以2，将sigio置为0（为了能够再次向子进程下发终止信号）</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_sigalrm) &#123;</span><br><span class="line">                sigio = <span class="number">0</span>;</span><br><span class="line">                delay *= <span class="number">2</span>;</span><br><span class="line">                ngx_sigalrm = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 打印日志</span></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"termination cycle: %M"</span>, delay);</span><br><span class="line">            <span class="comment">/* 使用setitime设置一个delay秒后的一个时钟信号，用来检测超时时间。（这里有个问题是，当设置了时钟信号，在时钟信号下发之前又接收到了其他信号，则会重新设置时钟信号,一般向子进程下发了退出信号后，再接收到的信号应该是SIGCHLD信号，即子进程退出信号）*/</span></span><br><span class="line">            itv.it_interval.tv_sec = <span class="number">0</span>;</span><br><span class="line">            itv.it_interval.tv_usec = <span class="number">0</span>;</span><br><span class="line">            itv.it_value.tv_sec = delay / <span class="number">1000</span>;</span><br><span class="line">            itv.it_value.tv_usec = (delay % <span class="number">1000</span> ) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setitimer(ITIMER_REAL, &amp;itv, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                              <span class="string">"setitimer() failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"sigsuspend"</span>);</span><br><span class="line">        <span class="comment">// 使用sigsuspend接收到之前被屏蔽的信号组中任意一个信号。</span></span><br><span class="line">        sigsuspend(&amp;<span class="built_in">set</span>);</span><br><span class="line">        <span class="comment">// 更新缓存的时间</span></span><br><span class="line">        ngx_time_update();</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"wake up, sigio %i"</span>, sigio);</span><br><span class="line">                       </span><br><span class="line">        <span class="comment">// 接收到子进程退出信号的处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_reap) &#123;</span><br><span class="line">            <span class="comment">// 恢复标识</span></span><br><span class="line">            ngx_reap = <span class="number">0</span>;</span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"reap children"</span>);</span><br><span class="line">            <span class="comment">// 根据退出原因进行相应的处理，具体下面介绍，返回的live为当前是否依然有子进程存活</span></span><br><span class="line">            live = ngx_reap_children(cycle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有子进程存活，且收到了强制退出或者优雅的方式退出，则执行master进程退出。</span></span><br><span class="line">        <span class="keyword">if</span> (!live &amp;&amp; (ngx_terminate || ngx_quit)) &#123;</span><br><span class="line">            ngx_master_process_exit(cycle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 强制退出信号，注意，这里处理时并未恢复ngx_terminate为0，并且只处理SIGCHLD信号</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_terminate) &#123;</span><br><span class="line">            <span class="comment">// 如果delay为0，表示刚接收到强制退出</span></span><br><span class="line">            <span class="keyword">if</span> (delay == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 设置延迟时间为50ms</span></span><br><span class="line">                delay = <span class="number">50</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* 如果sigio不为0，认为子进程数量减少了1，并继续等待其他信号。当收到不是子进程终止的信号是，sigio会变成0，或者超过了设置的等待时间时，sigio也会变成0.这是是为了方便执行后续的校验delay时间。*/</span></span><br><span class="line">            <span class="keyword">if</span> (sigio) &#123;</span><br><span class="line">                sigio--;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置sigio为子进程总数量+1.这样正常情况下，不需要重复下发关闭信号</span></span><br><span class="line">            sigio = ccf-&gt;worker_processes + <span class="number">2</span> <span class="comment">/* cache processes */</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果延迟关闭时间超过1000ms时，则执行强制kill命令，关闭子进程，具体逻辑下面会详细介绍</span></span><br><span class="line">            <span class="keyword">if</span> (delay &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                ngx_signal_worker_processes(cycle, SIGKILL);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则向子进程通过unix域套接字传递终止信息</span></span><br><span class="line">                ngx_signal_worker_processes(cycle,</span><br><span class="line">                                       ngx_signal_value(NGX_TERMINATE_SIGNAL));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 不再执行其他信号的处理逻辑</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果执行优雅的退出服务，则向子进程下发对应的SHUTDOWN信息。关闭监听端口。忽略后续处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_quit) &#123;</span><br><span class="line">            ngx_signal_worker_processes(cycle,</span><br><span class="line">                                        ngx_signal_value(NGX_SHUTDOWN_SIGNAL));</span><br><span class="line">            ngx_close_listening_sockets(cycle);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 收到重新读取配置信号</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_reconfigure) &#123;</span><br><span class="line">            <span class="comment">// 恢复表示</span></span><br><span class="line">            ngx_reconfigure = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* 已经执行了新的二进制文件的处理逻辑（由于在启动新的二进制文件前，会将旧的master进程的pid文件转移，因此正常来说，使用nginx命令是不会被旧进程接收到信号的，这应该是直接使用kill向旧进程下发的指令）。逻辑没太理解，只是又新增一批woker子进程和cache管理子进程，并设置ngx_noaccepting（表明当前依然在进行监听），忽略其余信号的处理*/</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_new_binary) &#123;</span><br><span class="line">                ngx_start_worker_processes(cycle, ccf-&gt;worker_processes,</span><br><span class="line">                                           NGX_PROCESS_RESPAWN);</span><br><span class="line">                ngx_start_cache_manager_processes(cycle, <span class="number">0</span>);</span><br><span class="line">                ngx_noaccepting = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"reconfiguring"</span>);</span><br><span class="line">            <span class="comment">// 重新执行初始化cycle，这里会重新读取配置。</span></span><br><span class="line">            cycle = ngx_init_cycle(cycle);</span><br><span class="line">            <span class="keyword">if</span> (cycle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                cycle = (<span class="keyword">ngx_cycle_t</span> *) ngx_cycle;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_cycle = cycle;</span><br><span class="line">            <span class="comment">// 获取新配置的核心配置信息</span></span><br><span class="line">            ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx,</span><br><span class="line">                                                   ngx_core_module);</span><br><span class="line">            <span class="comment">// 使用NGX_PROCESS_JUST_RESPAWN方式重新运行一批worker进程，用来区分旧进程，具体后续讲解</span></span><br><span class="line">            ngx_start_worker_processes(cycle, ccf-&gt;worker_processes,</span><br><span class="line">                                       NGX_PROCESS_JUST_RESPAWN);</span><br><span class="line">            <span class="comment">// 运行新的cache管理程序</span></span><br><span class="line">            ngx_start_cache_manager_processes(cycle, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* allow new processes to start */</span></span><br><span class="line">            <span class="comment">// 休眠一段时间，让子进程都启动起来</span></span><br><span class="line">            ngx_msleep(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">// 标识存在子进程存活</span></span><br><span class="line">            live = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 关闭旧进程</span></span><br><span class="line">            ngx_signal_worker_processes(cycle,</span><br><span class="line">                                        ngx_signal_value(NGX_SHUTDOWN_SIGNAL));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* restart并非一个指令触发的操作，而是执行新的二进制文件出现意外时的止损方案。在下发了执行新的二进制文件时，会创建一个子进程来运行新的二进制文件。但是如果新的二进制没办法正常运行，且我们下发了关闭当前matser的accept时，将导致没有worker进程能够正常运行。只是，在ngx_reap_children中，如果我们收到了新启动的运行新的二进制文件的进程意外退出，并且当前没有进程在接受请求，则会将ngx_restart设为1。此时执行的操作是，在当前版本的二进制程序中再次打开worker子进程和cache管理子进程。*/</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_restart) &#123;</span><br><span class="line">            ngx_restart = <span class="number">0</span>;</span><br><span class="line">            ngx_start_worker_processes(cycle, ccf-&gt;worker_processes,</span><br><span class="line">                                       NGX_PROCESS_RESPAWN);</span><br><span class="line">            ngx_start_cache_manager_processes(cycle, <span class="number">0</span>);</span><br><span class="line">            live = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重新打开日志文件处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_reopen) &#123;</span><br><span class="line">            ngx_reopen = <span class="number">0</span>;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"reopening logs"</span>);</span><br><span class="line">            <span class="comment">// 重新打开文件</span></span><br><span class="line">            ngx_reopen_files(cycle, ccf-&gt;user);</span><br><span class="line">            <span class="comment">// 向子进程传递重新打开文件信息</span></span><br><span class="line">            ngx_signal_worker_processes(cycle,</span><br><span class="line">                                        ngx_signal_value(NGX_REOPEN_SIGNAL));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 平滑升级，重新执行新的二进制文件，信号中获取的指令</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_change_binary) &#123;</span><br><span class="line">            ngx_change_binary = <span class="number">0</span>;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"changing binary"</span>);</span><br><span class="line">            <span class="comment">// 生成子进程，执行新的二进制文件</span></span><br><span class="line">            ngx_new_binary = ngx_exec_new_binary(cycle, ngx_argv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 停止接收链接，信号中获取的指令</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_noaccept) &#123;</span><br><span class="line">            ngx_noaccept = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 标识状态，当前不接收请求</span></span><br><span class="line">            ngx_noaccepting = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 向子进程下发指令</span></span><br><span class="line">            ngx_signal_worker_processes(cycle,</span><br><span class="line">                                        ngx_signal_value(NGX_SHUTDOWN_SIGNAL));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于循环中使用的信号相关变量，参考上文中的信号处理部分。</p>
<h2 id="启动worker子进程"><a href="#启动worker子进程" class="headerlink" title="启动worker子进程"></a>启动worker子进程</h2><h3 id="相关数据结构"><a href="#相关数据结构" class="headerlink" title="相关数据结构"></a>相关数据结构</h3><h4 id="进程信息ngx-process-t"><a href="#进程信息ngx-process-t" class="headerlink" title="进程信息ngx_process_t"></a>进程信息ngx_process_t</h4><p>ngx_process_t结构存储了进程的相关信息。其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进程执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_spawn_proc_pt)</span> <span class="params">(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 进程id，为-1表示该结构未绑定一个进程</span></span><br><span class="line">    <span class="keyword">ngx_pid_t</span>           pid;</span><br><span class="line">    <span class="comment">// 进程状态</span></span><br><span class="line">    <span class="keyword">int</span>                 status;</span><br><span class="line">    <span class="comment">// 用于数据传参的两个unix域套接字</span></span><br><span class="line">    <span class="keyword">ngx_socket_t</span>        channel[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// 进程绑定的处理函数，即fork创建进程后执行的重新</span></span><br><span class="line">    ngx_spawn_proc_pt   proc;</span><br><span class="line">    <span class="comment">// 对应的数据信息，基本与proc的内容一致</span></span><br><span class="line">    <span class="keyword">void</span>               *data;</span><br><span class="line">    <span class="comment">// 进程名称。操作系统中显示的进程名称与name相同</span></span><br><span class="line">    <span class="keyword">char</span>               *name;</span><br><span class="line">    <span class="comment">// 生成子进程</span></span><br><span class="line">    <span class="keyword">unsigned</span>            respawn:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 刚生成的子进程，与respawn区分，表示新旧子进程</span></span><br><span class="line">    <span class="keyword">unsigned</span>            just_spawn:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 父子进程分离，用于旧版本的master进程生成新的进程运行新的二进制文件。此时该标志位来标注是运行新的二进制文件的子进程</span></span><br><span class="line">    <span class="keyword">unsigned</span>            detached:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 进程正在退出</span></span><br><span class="line">    <span class="keyword">unsigned</span>            exiting:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 进程已退出</span></span><br><span class="line">    <span class="keyword">unsigned</span>            exited:<span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">ngx_process_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="进程间传递信息ngx-channel-t"><a href="#进程间传递信息ngx-channel-t" class="headerlink" title="进程间传递信息ngx_channel_t"></a>进程间传递信息ngx_channel_t</h4><p>ngx_channel_t结构用于进程间传递信息，包括直接传递unix域套接字。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 需要传递的指令，接收方根据该内容来决定对应的处理</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  command;</span><br><span class="line">    <span class="comment">// 标识数据来源。进程id为pid的进程传递的指令</span></span><br><span class="line">    <span class="keyword">ngx_pid_t</span>   pid;</span><br><span class="line">    <span class="comment">// 对应于全局变量ngx_processes数组中的下标，在传递描述符时有用，接收方需要通过该值设置对应数组元素</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>   slot;</span><br><span class="line">    <span class="comment">// 传递unix域描述符时为要传递的fd，否则为-1，仅仅只传递上述信息</span></span><br><span class="line">    <span class="keyword">ngx_fd_t</span>    fd;</span><br><span class="line">&#125; <span class="keyword">ngx_channel_t</span>;</span><br></pre></td></tr></table></figure>
<p>传递unix域套接字详见；<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E4%BC%A0%E9%80%81%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6" target="_blank" rel="noopener">传递文件描述符</a></p>
<h4 id="全局变量ngx-processes"><a href="#全局变量ngx-processes" class="headerlink" title="全局变量ngx_processes"></a>全局变量ngx_processes</h4><p>全局变量ngx_processes存储了每一个子进程当前状态。该数据会在master进程和各个子进程间进行维护（目前子进程只需要关注自己对应的一个元素）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_process_t</span>    ngx_processes[NGX_MAX_PROCESSES];</span><br></pre></td></tr></table></figure>
<h3 id="启动函数"><a href="#启动函数" class="headerlink" title="启动函数"></a>启动函数</h3><p>使用ngx_start_worker_processes函数来启动子进程。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// n为启动子进程数量。type为启动方式</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_start_worker_processes(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_int_t</span> n, <span class="keyword">ngx_int_t</span> type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>      i;</span><br><span class="line">    <span class="comment">// 初始化进程间传递信息的ngx_channel_t结构</span></span><br><span class="line">    <span class="keyword">ngx_channel_t</span>  ch;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"start worker processes"</span>);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>));</span><br><span class="line">    <span class="comment">// 对应指令为打开通道，即在子进程中增加该描述符。</span></span><br><span class="line">    ch.command = NGX_CMD_OPEN_CHANNEL;</span><br><span class="line">    <span class="comment">// 创建n个子进程</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_spawn_process(cycle, ngx_worker_process_cycle,</span><br><span class="line">                          (<span class="keyword">void</span> *) (<span class="keyword">intptr_t</span>) i, <span class="string">"worker process"</span>, type);</span><br><span class="line">        <span class="comment">/* 对ch赋值。其中ngx_process_slot为全局变量，表示上一步ngx_spawn_process创建子进程对应的进程信息存储在全局变量ngx_processes中的下标 */</span></span><br><span class="line">        ch.pid = ngx_processes[ngx_process_slot].pid;</span><br><span class="line">        ch.slot = ngx_process_slot;</span><br><span class="line">        ch.fd = ngx_processes[ngx_process_slot].channel[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// 向之前已经启动的进程传递用于与该循环创建的子进程进行信息传递的域套接字</span></span><br><span class="line">        ngx_pass_open_channel(cycle, &amp;ch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-spawn-process"><a href="#ngx-spawn-process" class="headerlink" title="ngx_spawn_process"></a>ngx_spawn_process</h4><p>这里ngx_spawn_process函数为创建子进程的统一处理函数。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* proc为子进程运行的函数。data为向子进程传递的额外参数信息，name为子进程名，即操作系统中显示的进程名，当respawn为负数时，表示启动的进程类型，用于控制创建何种进程 当是正数时，表示重启对应ngx_processes下标的进程*/</span></span><br><span class="line"><span class="keyword">ngx_pid_t</span></span><br><span class="line">ngx_spawn_process(<span class="keyword">ngx_cycle_t</span> *cycle, ngx_spawn_proc_pt proc, <span class="keyword">void</span> *data,</span><br><span class="line">    <span class="keyword">char</span> *name, <span class="keyword">ngx_int_t</span> respawn)</span><br><span class="line">&#123;</span><br><span class="line">    u_long     on;</span><br><span class="line">    <span class="keyword">ngx_pid_t</span>  pid;</span><br><span class="line">    <span class="comment">// 要操作的进程在ngx_processes中的下标</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  s;</span><br><span class="line">    <span class="comment">// 如果respawn大于0，则要操作的进程即为respawn</span></span><br><span class="line">    <span class="keyword">if</span> (respawn &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        s = respawn;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则在ngx_processes数组中找到第一个未被使用的元素</span></span><br><span class="line">        <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; ngx_last_process; s++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_processes[s].pid == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果超过了能够创建的最多的进程数量1024，则报错</span></span><br><span class="line">        <span class="keyword">if</span> (s == NGX_MAX_PROCESSES) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"no more than %d processes can be spawned"</span>,</span><br><span class="line">                          NGX_MAX_PROCESSES);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建的子进程不是父子进程分离新式的（父子进程分离式进程即创建的子进程运行新的二进制文件）</span></span><br><span class="line">    <span class="keyword">if</span> (respawn != NGX_PROCESS_DETACHED) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Solaris 9 still has no AF_LOCAL */</span></span><br><span class="line">        <span class="comment">// 生成用于进程间通讯的unix域套接字</span></span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, ngx_processes[s].channel) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"socketpair() failed while spawning \"%s\""</span>, name);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"channel %d:%d"</span>,</span><br><span class="line">                       ngx_processes[s].channel[<span class="number">0</span>],</span><br><span class="line">                       ngx_processes[s].channel[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">// 变更两个套接字属性都为非阻塞式，使用ioctl方法</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_nonblocking(ngx_processes[s].channel[<span class="number">0</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_nonblocking_n <span class="string">" failed while spawning \"%s\""</span>,</span><br><span class="line">                          name);</span><br><span class="line">            ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_nonblocking(ngx_processes[s].channel[<span class="number">1</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_nonblocking_n <span class="string">" failed while spawning \"%s\""</span>,</span><br><span class="line">                          name);</span><br><span class="line">            ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 设置第一个unix域套接字为异步io。可参考如下内容：http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%92%8C%E5%BC%82%E6%AD%A5I-O */</span></span><br><span class="line">        on = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(ngx_processes[s].channel[<span class="number">0</span>], FIOASYNC, &amp;on) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"ioctl(FIOASYNC) failed while spawning \"%s\""</span>, name);</span><br><span class="line">            ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fcntl(ngx_processes[s].channel[<span class="number">0</span>], F_SETOWN, ngx_pid) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"fcntl(F_SETOWN) failed while spawning \"%s\""</span>, name);</span><br><span class="line">            ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置套接字是执行时关闭。默认情况下，子进程中如果执行exec函数时，依然会继承父进程的套接字。的那个设置该值时，会在子进程执行exec时在子进程中关闭套接字。注意：如果只是fork创建子进程，但没有执行exec时，不会关闭。该方法主要作用在执行新的二进制文件时，避免继承原master进程的套接字。*/</span></span><br><span class="line">        <span class="keyword">if</span> (fcntl(ngx_processes[s].channel[<span class="number">0</span>], F_SETFD, FD_CLOEXEC) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"fcntl(FD_CLOEXEC) failed while spawning \"%s\""</span>,</span><br><span class="line">                           name);</span><br><span class="line">            ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fcntl(ngx_processes[s].channel[<span class="number">1</span>], F_SETFD, FD_CLOEXEC) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"fcntl(FD_CLOEXEC) failed while spawning \"%s\""</span>,</span><br><span class="line">                           name);</span><br><span class="line">            ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录当前将要创建的子进程使用的unix域套接字，后续使用</span></span><br><span class="line">        ngx_channel = ngx_processes[s].channel[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 对应执行新的二进制文件的子进程来说，不需要与旧的master进程进行通讯，因此并未使用</span></span><br><span class="line">        ngx_processes[s].channel[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">        ngx_processes[s].channel[<span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 记录当前操作子进程对应存储在ngx_processes的下标</span></span><br><span class="line">    ngx_process_slot = s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建子进程</span></span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (pid) &#123;</span><br><span class="line">    <span class="comment">// 创建失败的处理</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"fork() failed while spawning \"%s\""</span>, name);</span><br><span class="line">        ngx_close_channel(ngx_processes[s].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">    <span class="comment">// 子进程的处理。</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="comment">// 注意，这里ngx_parent使用的是旧master进程的pid。这时用于后续判断是否旧的master进程已退出</span></span><br><span class="line">        ngx_parent = ngx_pid;</span><br><span class="line">        <span class="comment">// 获取当前子进程的pid</span></span><br><span class="line">        ngx_pid = ngx_getpid();</span><br><span class="line">        <span class="comment">// 执行进程的处理函数，这里子进程一般就不会返回了。</span></span><br><span class="line">        proc(cycle, data);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 父进程的处理</span></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"start %s %P"</span>, name, pid);</span><br><span class="line">    <span class="comment">// 记录存储子进程的信息</span></span><br><span class="line">    ngx_processes[s].pid = pid;</span><br><span class="line">    <span class="comment">// 恢复子进程退出状态（如果是重启子进程的时候，原本的exited为1，这里恢复为0）</span></span><br><span class="line">    ngx_processes[s].exited = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果是用来重启子进程，则到这里就结束了</span></span><br><span class="line">    <span class="keyword">if</span> (respawn &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置对应的ngx_processes内容</span></span><br><span class="line">    ngx_processes[s].proc = proc;</span><br><span class="line">    ngx_processes[s].data = data;</span><br><span class="line">    ngx_processes[s].name = name;</span><br><span class="line">    ngx_processes[s].exiting = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 对应每一种启动的进程模式，设置对应的ngx_processes成员变量</span></span><br><span class="line">    <span class="keyword">switch</span> (respawn) &#123;</span><br><span class="line">    <span class="comment">// 子进程终止时，不需要重新生成，cache管理子进程使用</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_NORESPAWN:</span><br><span class="line">        ngx_processes[s].respawn = <span class="number">0</span>;</span><br><span class="line">        ngx_processes[s].just_spawn = <span class="number">0</span>;</span><br><span class="line">        ngx_processes[s].detached = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// 刚启动的进程，且进程退出不需要重启，区分新建进程。cache管理进程使用</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_JUST_SPAWN:</span><br><span class="line">        ngx_processes[s].respawn = <span class="number">0</span>;</span><br><span class="line">        ngx_processes[s].just_spawn = <span class="number">1</span>;</span><br><span class="line">        ngx_processes[s].detached = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// 子进程意外终止时，需要重新生成标识</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_RESPAWN:</span><br><span class="line">        ngx_processes[s].respawn = <span class="number">1</span>;</span><br><span class="line">        ngx_processes[s].just_spawn = <span class="number">0</span>;</span><br><span class="line">        ngx_processes[s].detached = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// 刚启动的子进程，通过RESPAWN与旧的进行进行区分，重读配置项时使用</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_JUST_RESPAWN:</span><br><span class="line">        ngx_processes[s].respawn = <span class="number">1</span>;</span><br><span class="line">        ngx_processes[s].just_spawn = <span class="number">1</span>;</span><br><span class="line">        ngx_processes[s].detached = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// 父子进程分离。运行新的二进制的子进程</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_DETACHED:</span><br><span class="line">        ngx_processes[s].respawn = <span class="number">0</span>;</span><br><span class="line">        ngx_processes[s].just_spawn = <span class="number">0</span>;</span><br><span class="line">        ngx_processes[s].detached = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 变更记录当前ngx_processes使用的数量</span></span><br><span class="line">    <span class="keyword">if</span> (s == ngx_last_process) &#123;</span><br><span class="line">        ngx_last_process++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回创建的子进程的id</span></span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="进程间通讯"><a href="#进程间通讯" class="headerlink" title="进程间通讯"></a>进程间通讯</h4><p>进程之间通过unix域套接字来传递信息。但在启动函数中有一个问题，即for循环中，在前面创建的子进程将无法拥有在后面创建的子进程的套接字。例如第一个进程（即在ngx_processes中下标为0的进程），将不会有第二个进程（即在ngx_processes中下标为0的进程）中的channel（两个unix域套接字，其中第一个用于其他进程向该进程发送信息，第二个用于进程本身接收信息）信息。这样将导致子进程之间无法直接进行通讯。</p>
<p>虽然目前nginx架构并未使用子进程之间进行通讯（都是matser与子进程进行通讯）。但为了后续的升级，nginx已经支持了子进程之间的通讯，其原理是通过unix域套接字传递文件描述符。具体原理可参考：<a href="http://www.yinkuiwang.cn/2019/12/18/unix高级编程/#传送文件描述符" target="_blank" rel="noopener">传递文件描述符</a>。</p>
<p>向之前创建的进程传递unix描述符函数逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_pass_open_channel(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_channel_t</span> *ch)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  i;</span><br><span class="line">    <span class="comment">// 遍历已经创建的进程</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_last_process; i++) &#123;</span><br><span class="line">         <span class="comment">// 不需要给自己传递，不需要给未使用的ngx_processes传递，不需要给未创建channel的传递（运行新的二进制文件的子进程）</span></span><br><span class="line">        <span class="keyword">if</span> (i == ngx_process_slot</span><br><span class="line">            || ngx_processes[i].pid == <span class="number">-1</span></span><br><span class="line">            || ngx_processes[i].channel[<span class="number">0</span>] == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug6(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"pass channel s:%i pid:%P fd:%d to s:%i pid:%P fd:%d"</span>,</span><br><span class="line">                      ch-&gt;slot, ch-&gt;pid, ch-&gt;fd,</span><br><span class="line">                      i, ngx_processes[i].pid,</span><br><span class="line">                      ngx_processes[i].channel[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> NGX_AGAIN */</span></span><br><span class="line">        <span class="comment">// 向指定的描述符ngx_processes[i].channel[0]中传递ch信息</span></span><br><span class="line">        ngx_write_channel(ngx_processes[i].channel[<span class="number">0</span>],</span><br><span class="line">                          ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>), cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-write-channel"><a href="#ngx-write-channel" class="headerlink" title="ngx_write_channel"></a>ngx_write_channel</h5><p>其中详细介绍一下向域套接字写数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_write_channel(<span class="keyword">ngx_socket_t</span> s, <span class="keyword">ngx_channel_t</span> *ch, <span class="keyword">size_t</span> size,</span><br><span class="line">    <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>             n;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>           err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span>        <span class="title">iov</span>[1];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span>       <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_MSGHDR_MSG_CONTROL)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span>  <span class="title">cm</span>;</span></span><br><span class="line">        <span class="keyword">char</span>            space[CMSG_SPACE(<span class="keyword">sizeof</span>(<span class="keyword">int</span>))];</span><br><span class="line">    &#125; cmsg;</span><br><span class="line">    <span class="comment">// ch-&gt;fd为-1，表示只是简单的数据传输，并不用传递文件描述符</span></span><br><span class="line">    <span class="keyword">if</span> (ch-&gt;fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        msg.msg_control = <span class="literal">NULL</span>;</span><br><span class="line">        msg.msg_controllen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 添加文件描述符到外代数据中</span></span><br><span class="line">        msg.msg_control = (<span class="keyword">caddr_t</span>) &amp;cmsg;</span><br><span class="line">        msg.msg_controllen = <span class="keyword">sizeof</span>(cmsg);</span><br><span class="line"></span><br><span class="line">        ngx_memzero(&amp;cmsg, <span class="keyword">sizeof</span>(cmsg));</span><br><span class="line"></span><br><span class="line">        cmsg.cm.cmsg_len = CMSG_LEN(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        cmsg.cm.cmsg_level = SOL_SOCKET;</span><br><span class="line">        cmsg.cm.cmsg_type = SCM_RIGHTS;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We have to use ngx_memcpy() instead of simple</span></span><br><span class="line"><span class="comment">         *   *(int *) CMSG_DATA(&amp;cmsg.cm) = ch-&gt;fd;</span></span><br><span class="line"><span class="comment">         * because some gcc 4.4 with -O2/3/s optimization issues the warning:</span></span><br><span class="line"><span class="comment">         *   dereferencing type-punned pointer will break strict-aliasing rules</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Fortunately, gcc with -O1 compiles this ngx_memcpy()</span></span><br><span class="line"><span class="comment">         * in the same simple assignment as in the code above</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        ngx_memcpy(CMSG_DATA(&amp;cmsg.cm), &amp;ch-&gt;fd, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg.msg_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ch-&gt;fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        msg.msg_accrights = <span class="literal">NULL</span>;</span><br><span class="line">        msg.msg_accrightslen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg.msg_accrights = (<span class="keyword">caddr_t</span>) &amp;ch-&gt;fd;</span><br><span class="line">        msg.msg_accrightslen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 添加数据内容</span></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = (<span class="keyword">char</span> *) ch;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = size;</span><br><span class="line"></span><br><span class="line">    msg.msg_name = <span class="literal">NULL</span>;</span><br><span class="line">    msg.msg_namelen = <span class="number">0</span>;</span><br><span class="line">    msg.msg_iov = iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 向套接字发送数据</span></span><br><span class="line">    n = sendmsg(s, &amp;msg, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        err = ngx_errno;</span><br><span class="line">        <span class="keyword">if</span> (err == NGX_EAGAIN) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, err, <span class="string">"sendmsg() failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体发送域套接字参考：<a href="http://www.yinkuiwang.cn/2019/12/18/unix高级编程/#传送文件描述符" target="_blank" rel="noopener">传递文件描述符</a>。</p>
<h2 id="启动cache管理子进程"><a href="#启动cache管理子进程" class="headerlink" title="启动cache管理子进程"></a>启动cache管理子进程</h2><p>暂时还未详细阅读，后续补充。</p>
<h2 id="设置时钟信号"><a href="#设置时钟信号" class="headerlink" title="设置时钟信号"></a>设置时钟信号</h2><p>对于设置时钟信号，参考<a href="https://blog.csdn.net/lixianlin/article/details/25604779" target="_blank" rel="noopener">https://blog.csdn.net/lixianlin/article/details/25604779</a></p>
<h2 id="子进程退出时处理"><a href="#子进程退出时处理" class="headerlink" title="子进程退出时处理"></a>子进程退出时处理</h2><p>当子进程退出时，将执行ngx_reap_children函数来进行检查。具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_uint_t</span></span><br><span class="line">ngx_reap_children(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         i, n;</span><br><span class="line">    <span class="comment">// 记录是否还有子进程存活</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        live;</span><br><span class="line">    <span class="keyword">ngx_channel_t</span>     ch;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>));</span><br><span class="line">    <span class="comment">// 向其余子进程传递信息指令：关闭通讯管道</span></span><br><span class="line">    ch.command = NGX_CMD_CLOSE_CHANNEL;</span><br><span class="line">    <span class="comment">// 不需要传递文件描述符</span></span><br><span class="line">    ch.fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    live = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历每个ngx_processes</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_last_process; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug7(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"child: %i %P e:%d t:%d d:%d r:%d j:%d"</span>,</span><br><span class="line">                       i,</span><br><span class="line">                       ngx_processes[i].pid,</span><br><span class="line">                       ngx_processes[i].exiting,</span><br><span class="line">                       ngx_processes[i].exited,</span><br><span class="line">                       ngx_processes[i].detached,</span><br><span class="line">                       ngx_processes[i].respawn,</span><br><span class="line">                       ngx_processes[i].just_spawn);</span><br><span class="line">        <span class="comment">// 跳过未使用的ngx_processes</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[i].pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于退出的进程的处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[i].exited) &#123;</span><br><span class="line">            <span class="comment">// 进程不是运行新的二进制文件的处理</span></span><br><span class="line">            <span class="keyword">if</span> (!ngx_processes[i].detached) &#123;</span><br><span class="line">                <span class="comment">// 关闭unix域套接字</span></span><br><span class="line">                ngx_close_channel(ngx_processes[i].channel, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">                ngx_processes[i].channel[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">                ngx_processes[i].channel[<span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                ch.pid = ngx_processes[i].pid;</span><br><span class="line">                ch.slot = i;</span><br><span class="line">                <span class="comment">// 向剩余存活的子进程传递关闭通讯通道的指令</span></span><br><span class="line">                <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; ngx_last_process; n++) &#123;</span><br><span class="line">                    <span class="comment">// 不需要关注退出的进程，未使用的ngx_processes和未打开channel的进程</span></span><br><span class="line">                    <span class="keyword">if</span> (ngx_processes[n].exited</span><br><span class="line">                        || ngx_processes[n].pid == <span class="number">-1</span></span><br><span class="line">                        || ngx_processes[n].channel[<span class="number">0</span>] == <span class="number">-1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ngx_log_debug3(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"pass close channel s:%i pid:%P to:%P"</span>,</span><br><span class="line">                                   ch.slot, ch.pid, ngx_processes[n].pid);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* <span class="doctag">TODO:</span> NGX_AGAIN */</span></span><br><span class="line"></span><br><span class="line">                    ngx_write_channel(ngx_processes[n].channel[<span class="number">0</span>],</span><br><span class="line">                                      &amp;ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>), cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 需要在终止后重启的子进程，并且当前未收到关闭服务指令，并且进程不是正在退出时的处理</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_processes[i].respawn</span><br><span class="line">                &amp;&amp; !ngx_processes[i].exiting</span><br><span class="line">                &amp;&amp; !ngx_terminate</span><br><span class="line">                &amp;&amp; !ngx_quit)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 重启子进程</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_spawn_process(cycle, ngx_processes[i].proc,</span><br><span class="line">                                      ngx_processes[i].data,</span><br><span class="line">                                      ngx_processes[i].name, i)</span><br><span class="line">                    == NGX_INVALID_PID)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"could not respawn %s"</span>,</span><br><span class="line">                                  ngx_processes[i].name);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 向其余子进程传递用于进程间通讯的域套接字</span></span><br><span class="line">                ch.command = NGX_CMD_OPEN_CHANNEL;</span><br><span class="line">                ch.pid = ngx_processes[ngx_process_slot].pid;</span><br><span class="line">                ch.slot = ngx_process_slot;</span><br><span class="line">                ch.fd = ngx_processes[ngx_process_slot].channel[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                ngx_pass_open_channel(cycle, &amp;ch);</span><br><span class="line">                <span class="comment">// 记录有进程存活</span></span><br><span class="line">                live = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 跳过后续处理</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果退出的进程是执行新的二进制文件的进程</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_processes[i].pid == ngx_new_binary) &#123;</span><br><span class="line"></span><br><span class="line">                ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx,</span><br><span class="line">                                                       ngx_core_module);</span><br><span class="line">                <span class="comment">// 恢复pid文件，具体参考下文的执行新的二进制文件</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_rename_file((<span class="keyword">char</span> *) ccf-&gt;oldpid.data,</span><br><span class="line">                                    (<span class="keyword">char</span> *) ccf-&gt;pid.data)</span><br><span class="line">                    == NGX_FILE_ERROR)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                  ngx_rename_file_n <span class="string">" %s back to %s failed "</span></span><br><span class="line">                                  <span class="string">"after the new binary process \"%s\" exited"</span>,</span><br><span class="line">                                  ccf-&gt;oldpid.data, ccf-&gt;pid.data, ngx_argv[<span class="number">0</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 设置运行新的二进制文件为0</span></span><br><span class="line">                ngx_new_binary = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 止损操作。如果当前已经设置了关闭监听，则设置ngx_restart为1，重新开启worker子进程和cache管理子进程。</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_noaccepting) &#123;</span><br><span class="line">                    ngx_restart = <span class="number">1</span>;</span><br><span class="line">                    ngx_noaccepting = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是最后一个进程，维护ngx_last_process数值</span></span><br><span class="line">            <span class="keyword">if</span> (i == ngx_last_process - <span class="number">1</span>) &#123;</span><br><span class="line">                ngx_last_process--;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则标记对应的ngx_processes未使用</span></span><br><span class="line">                ngx_processes[i].pid = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ngx_processes[i].exiting || !ngx_processes[i].detached) &#123;</span><br><span class="line">        <span class="comment">// 正在退出算是存活状态，并且不需要考虑运行新的二进制文件的子进程</span></span><br><span class="line">            live = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> live;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="退出master进程"><a href="#退出master进程" class="headerlink" title="退出master进程"></a>退出master进程</h2><p>如果是接收到退出信号，并且所有子进程已完成退出，则会执行master进程的退出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_master_process_exit(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  i;</span><br><span class="line">    <span class="comment">// 删除pid文件</span></span><br><span class="line">    ngx_delete_pidfile(cycle);</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"exit"</span>);</span><br><span class="line">    <span class="comment">// 执行每个modules的exit_master函数</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;exit_master) &#123;</span><br><span class="line">            cycle-&gt;modules[i]-&gt;exit_master(cycle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭监听端口</span></span><br><span class="line">    ngx_close_listening_sockets(cycle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Copy ngx_cycle-&gt;log related data to the special static exit cycle,</span></span><br><span class="line"><span class="comment">     * log, and log file structures enough to allow a signal handler to log.</span></span><br><span class="line"><span class="comment">     * The handler may be called when standard ngx_cycle-&gt;log allocated from</span></span><br><span class="line"><span class="comment">     * ngx_cycle-&gt;pool is already destroyed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ngx_exit_log = *ngx_log_get_file_log(ngx_cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    ngx_exit_log_file.fd = ngx_exit_log.file-&gt;fd;</span><br><span class="line">    ngx_exit_log.file = &amp;ngx_exit_log_file;</span><br><span class="line">    ngx_exit_log.next = <span class="literal">NULL</span>;</span><br><span class="line">    ngx_exit_log.writer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    ngx_exit_cycle.<span class="built_in">log</span> = &amp;ngx_exit_log;</span><br><span class="line">    ngx_exit_cycle.files = ngx_cycle-&gt;files;</span><br><span class="line">    ngx_exit_cycle.files_n = ngx_cycle-&gt;files_n;</span><br><span class="line">    ngx_cycle = &amp;ngx_exit_cycle;</span><br><span class="line">    <span class="comment">// 销毁内存池</span></span><br><span class="line">    ngx_destroy_pool(cycle-&gt;pool);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除pid文件"><a href="#删除pid文件" class="headerlink" title="删除pid文件"></a>删除pid文件</h3><p>会根据是否运行新的二进制文件来删除对应的pid文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_delete_pidfile(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *name;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    <span class="comment">// 如果已经运行了新的二进制文件，则删除旧的pid文件</span></span><br><span class="line">    name = ngx_new_binary ? ccf-&gt;oldpid.data : ccf-&gt;pid.data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      ngx_delete_file_n <span class="string">" \"%s\" failed"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="关闭监听套接字"><a href="#关闭监听套接字" class="headerlink" title="关闭监听套接字"></a>关闭监听套接字</h3><p>程序退出会关闭对套接字的监听。其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_close_listening_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line">    <span class="comment">// 如果使用的事件模块为NGX_USE_IOCP_EVENT，则直接结束</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_IOCP_EVENT) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_accept_mutex_held = <span class="number">0</span>;</span><br><span class="line">    ngx_use_accept_mutex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="comment">// 遍历每一个监听套接字</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        c = ls[i].connection;</span><br><span class="line">        <span class="comment">// 存在连接时处理</span></span><br><span class="line">        <span class="keyword">if</span> (c) &#123;</span><br><span class="line">            <span class="comment">// 存在读事件时（监听依然存活）</span></span><br><span class="line">            <span class="keyword">if</span> (c-&gt;read-&gt;active) &#123;</span><br><span class="line">                <span class="comment">// 使用epoll，删除读事件</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * it seems that Linux-2.6.x OpenVZ sends events</span></span><br><span class="line"><span class="comment">                     * for closed shared listening sockets unless</span></span><br><span class="line"><span class="comment">                     * the events was explicitly deleted</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line"></span><br><span class="line">                    ngx_del_event(c-&gt;read, NGX_READ_EVENT, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 关闭读时间</span></span><br><span class="line">                    ngx_del_event(c-&gt;read, NGX_READ_EVENT, NGX_CLOSE_EVENT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 释放connection</span></span><br><span class="line">            ngx_free_connection(c);</span><br><span class="line"></span><br><span class="line">            c-&gt;fd = (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"close listening %V #%d "</span>, &amp;ls[i].addr_text, ls[i].fd);</span><br><span class="line">        <span class="comment">// 关闭套接字</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_close_socket(ls[i].fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          ngx_close_socket_n <span class="string">" %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">        <span class="comment">/* 删除域套接字创建的文件，只能单进程模式或者多进程模式的master进程来删除，并且当前没有新的二进制文件运行并且该域套接字不是继承而来或者不是新执行的二进制文件 */</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].sockaddr-&gt;sa_family == AF_UNIX</span><br><span class="line">            &amp;&amp; ngx_process &lt;= NGX_PROCESS_MASTER</span><br><span class="line">            &amp;&amp; ngx_new_binary == <span class="number">0</span></span><br><span class="line">            &amp;&amp; (!ls[i].inherited || ngx_getppid() != ngx_parent))</span><br><span class="line">        &#123;</span><br><span class="line">            u_char *name = ls[i].addr_text.data + <span class="keyword">sizeof</span>(<span class="string">"unix:"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              ngx_delete_file_n <span class="string">" %s failed"</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        ls[i].fd = (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;listening.nelts = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数用到了很多事件相关的处理，详细参考后面关于事件模块的介绍。</p>
<h2 id="向子进程下发指令"><a href="#向子进程下发指令" class="headerlink" title="向子进程下发指令"></a>向子进程下发指令</h2><p>master进程通过unix域套接字或者信号下发指令，函数为ngx_signal_worker_processes，其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_signal_worker_processes(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">int</span> signo)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>      i;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>      err;</span><br><span class="line">    <span class="keyword">ngx_channel_t</span>  ch;</span><br><span class="line">    <span class="comment">// 初始化传递信息的ch</span></span><br><span class="line">    ngx_memzero(&amp;ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_BROKEN_SCM_RIGHTS)</span></span><br><span class="line"></span><br><span class="line">    ch.command = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// 根据信号类型，决定传递的信号</span></span><br><span class="line">    <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line"></span><br><span class="line">    case ngx_signal_value(NGX_SHUTDOWN_SIGNAL):</span><br><span class="line">        ch.command = NGX_CMD_QUIT;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    case ngx_signal_value(NGX_TERMINATE_SIGNAL):</span><br><span class="line">        ch.command = NGX_CMD_TERMINATE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    case ngx_signal_value(NGX_REOPEN_SIGNAL):</span><br><span class="line">        ch.command = NGX_CMD_REOPEN;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ch.command = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// fd为-1，表示单纯传递数据</span></span><br><span class="line">    ch.fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历每一个ngx_processes</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_last_process; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug7(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"child: %i %P e:%d t:%d d:%d r:%d j:%d"</span>,</span><br><span class="line">                       i,</span><br><span class="line">                       ngx_processes[i].pid,</span><br><span class="line">                       ngx_processes[i].exiting,</span><br><span class="line">                       ngx_processes[i].exited,</span><br><span class="line">                       ngx_processes[i].detached,</span><br><span class="line">                       ngx_processes[i].respawn,</span><br><span class="line">                       ngx_processes[i].just_spawn);</span><br><span class="line">        <span class="comment">// 如果是运行新二进制重新的子进程，或者未使用的ngx_processes，则忽略</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[i].detached || ngx_processes[i].pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 如果是刚启动的进程，则将标识just_spawn置为0，跳过处理。这里是为了处理重读配置，先关闭旧的子进程，再将新的子进程设置为旧的子进程 */</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[i].just_spawn) &#123;</span><br><span class="line">            ngx_processes[i].just_spawn = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 如果进程正在退出，并且收到的信号是NGX_SHUTDOWN_SIGNAL，则跳过处理。对应优雅的关闭进程，可能会下发多次NGX_SHUTDOWN_SIGNAL信号。*/</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[i].exiting</span><br><span class="line">            &amp;&amp; signo == ngx_signal_value(NGX_SHUTDOWN_SIGNAL))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果设置了下发信息，则通过unix域套接字下发指令</span></span><br><span class="line">        <span class="keyword">if</span> (ch.command) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_write_channel(ngx_processes[i].channel[<span class="number">0</span>],</span><br><span class="line">                                  &amp;ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>), cycle-&gt;<span class="built_in">log</span>)</span><br><span class="line">                == NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用unix域套接字下发的指令，除了NGX_REOPEN_SIGNAL外，其余均是关闭子进程的，因此这里设置子进程正在关闭</span></span><br><span class="line">                <span class="keyword">if</span> (signo != ngx_signal_value(NGX_REOPEN_SIGNAL)) &#123;</span><br><span class="line">                    ngx_processes[i].exiting = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"kill (%P, %d)"</span>, ngx_processes[i].pid, signo);</span><br><span class="line">        <span class="comment">// 如果不是通过unix域套接字传递的信号，则使用kill下子进程下发信息</span></span><br><span class="line">        <span class="keyword">if</span> (kill(ngx_processes[i].pid, signo) == <span class="number">-1</span>) &#123;</span><br><span class="line">            err = ngx_errno;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"kill(%P, %d) failed"</span>, ngx_processes[i].pid, signo);</span><br><span class="line">            <span class="comment">// 如果是向不存在的进程下发信号，则设置对应的ngx_processes已经退出</span></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ESRCH) &#123;</span><br><span class="line">                ngx_processes[i].exited = <span class="number">1</span>;</span><br><span class="line">                ngx_processes[i].exiting = <span class="number">0</span>;</span><br><span class="line">                ngx_reap = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (signo != ngx_signal_value(NGX_REOPEN_SIGNAL)) &#123;</span><br><span class="line">            ngx_processes[i].exiting = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应kill函数，可参考文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%87%BD%E6%95%B0kill%E5%92%8Craise" target="_blank" rel="noopener">kill和raise</a>.</p>
<h2 id="执行新的二进制文件"><a href="#执行新的二进制文件" class="headerlink" title="执行新的二进制文件"></a>执行新的二进制文件</h2><p>执行新的二进制文件函数ngx_exec_new_binary。其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_pid_t</span></span><br><span class="line">ngx_exec_new_binary(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">char</span> *<span class="keyword">const</span> *argv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>             **env, *var;</span><br><span class="line">    u_char            *p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i, n;</span><br><span class="line">    <span class="keyword">ngx_pid_t</span>          pid;</span><br><span class="line">    <span class="keyword">ngx_exec_ctx_t</span>     ctx;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>   *ccf;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="comment">// ctx为执行新的二进制的传参</span></span><br><span class="line">    ngx_memzero(&amp;ctx, <span class="keyword">sizeof</span>(<span class="keyword">ngx_exec_ctx_t</span>));</span><br><span class="line">    <span class="comment">// 执行新的二进制文件的path</span></span><br><span class="line">    ctx.path = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 新的子进程的名字</span></span><br><span class="line">    ctx.name = <span class="string">"new binary process"</span>;</span><br><span class="line">    <span class="comment">// 命令行参数，与旧版的请求参数一致，这里传参使用的是ngx_argv，即之前存储的启动时参数</span></span><br><span class="line">    ctx.argv = argv;</span><br><span class="line">    <span class="comment">// n表示要额外申请的数组长度（除了目前已经在使用的长度外）</span></span><br><span class="line">    n = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 获取运行新的二进制文件时的环境变量表</span></span><br><span class="line">    env = ngx_set_environment(cycle, &amp;n);</span><br><span class="line">    <span class="keyword">if</span> (env == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将监听端口写入要执行的二进制文件的环境变量中，这里进行分配空间</span></span><br><span class="line">    var = ngx_alloc(<span class="keyword">sizeof</span>(NGINX_VAR)</span><br><span class="line">                    + cycle-&gt;listening.nelts * (NGX_INT32_LEN + <span class="number">1</span>) + <span class="number">2</span>,</span><br><span class="line">                    cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (var == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_free(env);</span><br><span class="line">        <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = ngx_cpymem(var, NGINX_VAR <span class="string">"="</span>, <span class="keyword">sizeof</span>(NGINX_VAR));</span><br><span class="line">    <span class="comment">// 遍历每一个监听端口，将端口写入环境变量</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        p = ngx_sprintf(p, <span class="string">"%ud;"</span>, ls[i].fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置字符串末尾</span></span><br><span class="line">    *p = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="comment">// 添加环境变量到环境变量表，这里的n已经在ngx_set_environment进行了变更，具体参考ngx_set_environment处理</span></span><br><span class="line">    env[n++] = var;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SETPROCTITLE_USES_ENV)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allocate the spare 300 bytes for the new binary process title */</span></span><br><span class="line">    <span class="comment">// 分配空间为新执行的二进制文件的title，这里不是很明白。监听端口变量和改变量是n为2的原因</span></span><br><span class="line">    env[n++] = <span class="string">"SPARE=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span><br><span class="line">               <span class="string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span><br><span class="line">               <span class="string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span><br><span class="line">               <span class="string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span><br><span class="line">               <span class="string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置环境的变量的末尾</span></span><br><span class="line">    env[n] = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">// config中增加--with-debug，增加运行时debug信息，打印环境变量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">char</span>  **e;</span><br><span class="line">    <span class="keyword">for</span> (e = env; *e; e++) &#123;</span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"env: %s"</span>, *e);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 添加环境变量</span></span><br><span class="line">    ctx.envp = (<span class="keyword">char</span> *<span class="keyword">const</span> *) env;</span><br><span class="line">    <span class="comment">// 通过ngx_core_module模块获取pid文件</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    <span class="comment">// 变更pid文件，在pid文件后面增加.oldbin后缀，来保证新二进制文件的正常启动</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_rename_file(ccf-&gt;pid.data, ccf-&gt;oldpid.data) == NGX_FILE_ERROR) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      ngx_rename_file_n <span class="string">" %s to %s failed "</span></span><br><span class="line">                      <span class="string">"before executing new binary process \"%s\""</span>,</span><br><span class="line">                      ccf-&gt;pid.data, ccf-&gt;oldpid.data, argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        ngx_free(env);</span><br><span class="line">        ngx_free(var);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_INVALID_PID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建新进程，运行新的二进制文件</span></span><br><span class="line">    pid = ngx_execute(cycle, &amp;ctx);</span><br><span class="line">    <span class="comment">// 运行失败，则恢复pid文件</span></span><br><span class="line">    <span class="keyword">if</span> (pid == NGX_INVALID_PID) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_rename_file(ccf-&gt;oldpid.data, ccf-&gt;pid.data)</span><br><span class="line">            == NGX_FILE_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_rename_file_n <span class="string">" %s back to %s failed after "</span></span><br><span class="line">                          <span class="string">"an attempt to execute new binary process \"%s\""</span>,</span><br><span class="line">                          ccf-&gt;oldpid.data, ccf-&gt;pid.data, argv[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放环境变量</span></span><br><span class="line">    ngx_free(env);</span><br><span class="line">    ngx_free(var);</span><br><span class="line">    <span class="comment">// 返回pid</span></span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="运行二进制文件"><a href="#运行二进制文件" class="headerlink" title="运行二进制文件"></a>运行二进制文件</h3><p>在ngx_execute函数中生成子进程并在子进程执行新的二进制文件。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_pid_t</span></span><br><span class="line">ngx_execute(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_exec_ctx_t</span> *ctx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里运行的ngx_spawn_process为NGX_PROCESS_DETACHED，即父子进程分离</span></span><br><span class="line">    <span class="keyword">return</span> ngx_spawn_process(cycle, ngx_execute_proc, ctx, ctx-&gt;name,</span><br><span class="line">                             NGX_PROCESS_DETACHED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>子进程执行的函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_execute_proc(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_exec_ctx_t</span>  *ctx = data;</span><br><span class="line">    <span class="comment">// 通过data获取执行文件的path，运行的argv和环境变量</span></span><br><span class="line">    <span class="keyword">if</span> (execve(ctx-&gt;path, ctx-&gt;argv, ctx-&gt;envp) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"execve() failed while executing %s \"%s\""</span>,</span><br><span class="line">                      ctx-&gt;name, ctx-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体execve执行函数可参考文档:<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%87%BD%E6%95%B0exec" target="_blank" rel="noopener">exec函数</a>。注意，这里第一个参数是path，即运行文件的路径，并不会如filename一样，在环境变量的PATH中进行查找。因此，如果运行的nginx是通过环境变量找到的时，例如将nginx可执行文件移动到/urs/bin目录下，在终端直接运行nginx生成的程序，如果要让其升级，一定会失败，即使第三个参数中存在PATH环境变量，这时由于第一个参数是path，并不会在环境变量中查找。因此运行nginx命令，一定要是完整的可执行文件路径。至于如何在第三个参数中增加PATH环境变量，下文详细介绍。</p>
<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><p>默认情况下，如果运行的exec系列函数没有环境变量这一参数时，新生成的子进程是直接继承父进程的环境变量表的。具体可参考如下文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E7%8E%AF%E5%A2%83%E8%A1%A8" target="_blank" rel="noopener">环境表</a>，<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" target="_blank" rel="noopener">环境变量</a>,<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%87%BD%E6%95%B0exec" target="_blank" rel="noopener">exec函数</a>。</p>
<p>但由于在平滑升级时，我们要向子进程传递正在监听的文件描述符，而传输的方式是通过环境变量进行传递。注意，对于监听的文件描述符，之前并未设置为EXCECLOSE即执行时关闭，因此fork后的子进程运行exec时依然继承父进程的套接字，这时通过getsockname和getsockopt即可获取套接字上对应监听的属性，就可以在子进程中继续监听了。</p>
<p>这样就实现了监听描述符之间的传递，但是这也带来了一下额外的问题，由于要通过环境变量来传递套接字，这将导致子进程无法天然的基础父进程中使用的环境变量，因此我们需要将当前nginx使用的环境变量一起传递给子进程。这一步操作在ngx_set_environment完成，其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 参数last用来区分使用创建，（当前）只有在创建子进程运行新的二进制文件时才会传递last为整数，其余均为NULL。last的大小表示除了当前进程需要使用的环境变量意外，需要额外申请的环境变量数组大小, 用于在返回后在环境变量中增加额外信息，如需要传递的套接字 */</span></span><br><span class="line"><span class="keyword">char</span> **</span><br><span class="line">ngx_set_environment(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_uint_t</span> *last)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                **p, **env;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>            *var;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            i, n;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>      *ccf;</span><br><span class="line">    <span class="keyword">ngx_pool_cleanup_t</span>   *cln;</span><br><span class="line">    <span class="comment">// 获取ngx_core_module模块对应的配置</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    <span class="comment">// 如果只是获取当前进程使用的环境变量，并且此前已经设置了environment变量，则直接返回即可</span></span><br><span class="line">    <span class="keyword">if</span> (last == <span class="literal">NULL</span> &amp;&amp; ccf-&gt;environment) &#123;</span><br><span class="line">        <span class="keyword">return</span> ccf-&gt;environment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取配置中使用到的环境变量</span></span><br><span class="line">    var = ccf-&gt;env.elts;</span><br><span class="line">    <span class="comment">/* 遍历每一个配置文件中需要使用的，或者设置的环境变量，查找是否存在时区变量，即TZ，如果不存在，则在ccf中增加时区变量，这时要保证新旧进程使用同一个时间 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ccf-&gt;env.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_strcmp(var[i].data, <span class="string">"TZ"</span>) == <span class="number">0</span></span><br><span class="line">            || ngx_strncmp(var[i].data, <span class="string">"TZ="</span>, <span class="number">3</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> tz_found;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var = ngx_array_push(&amp;ccf-&gt;env);</span><br><span class="line">    <span class="keyword">if</span> (var == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var-&gt;len = <span class="number">2</span>;</span><br><span class="line">    var-&gt;data = (u_char *) <span class="string">"TZ"</span>;</span><br><span class="line"></span><br><span class="line">    var = ccf-&gt;env.elts;</span><br><span class="line"></span><br><span class="line">tz_found:</span><br><span class="line">    <span class="comment">// 变量每一个配置中使用到的环境变量</span></span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ccf-&gt;env.nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 如果配置中设置了环境变量的值，则直接使用配置文件中设置的即可，并记录使用的环境变量+1，跳过后续处理</span></span><br><span class="line">        <span class="keyword">if</span> (var[i].data[var[i].len] == <span class="string">'='</span>) &#123;</span><br><span class="line">            n++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 如果配置文件中未设置要使用的环境变量的值，则从环境变量表中查找，是否有对应的环境变量值，如果存在，则表示要使用，并且需要传递给子进程，这里ngx_os_environ=environ */</span></span><br><span class="line">        <span class="keyword">for</span> (p = ngx_os_environ; *p; p++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(*p, var[i].data, var[i].len) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (*p)[var[i].len] == <span class="string">'='</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                n++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据last创建对应的存储环境变量的字符串数组,+1为表示环境变量最后一个元素为"\0",表示终止</span></span><br><span class="line">    <span class="keyword">if</span> (last) &#123;</span><br><span class="line">        env = ngx_alloc((*last + n + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *), cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (env == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置last到下一个该设置变量的数组下标，用于函数返回后的处理</span></span><br><span class="line">        *last = n;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 如果是单纯的获取当前使用到的环境变量，则有可能后续程序不会自动处理创建的env，因此在pool中注册销毁函数，保证在程序退出时，内存能够正常释放，具体可参考pool内存池设计 */</span></span><br><span class="line">        cln = ngx_pool_cleanup_add(cycle-&gt;pool, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (cln == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        env = ngx_alloc((n + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *), cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (env == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册的销毁函数。先判断对应的data（即env）,是否和environ一致，如果不是，则销毁env（因为environ程序本身会消除）</span></span><br><span class="line">        cln-&gt;handler = ngx_cleanup_environment;</span><br><span class="line">        cln-&gt;data = env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历每个配置文件中使用到的环境变量和当前进程的环境表，来设置env</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ccf-&gt;env.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var[i].data[var[i].len] == <span class="string">'='</span>) &#123;</span><br><span class="line">            env[n++] = (<span class="keyword">char</span> *) var[i].data;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (p = ngx_os_environ; *p; p++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(*p, var[i].data, var[i].len) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (*p)[var[i].len] == <span class="string">'='</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                env[n++] = *p;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 标识当前的末尾</span></span><br><span class="line">    env[n] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* 如果仅仅是获取目前进程中使用的环境变量，则设置ccf-&gt;environment，避免后续重复计算。设置environ，避免后续的多余计算（只保留了当前需要使用的部分，这样后续计算会少很多）*/</span></span><br><span class="line">    <span class="keyword">if</span> (last == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ccf-&gt;environment = env;</span><br><span class="line">        environ = env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置中环境变量的解析"><a href="#配置中环境变量的解析" class="headerlink" title="配置中环境变量的解析"></a>配置中环境变量的解析</h3><p>上述的程序中大量使用的ngx_core_module模块的ccf-&gt;env数据，这里有必要介绍一下环境变量配置的解析处理逻辑</p>
<p>环境变量的配置语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">env name</span><br><span class="line">env name=value</span><br><span class="line"></span><br><span class="line">eg：</span><br><span class="line">env = PATH</span><br><span class="line">env = PATH=/usr/bin</span><br></pre></td></tr></table></figure>
<p>对于只有name的情况，表示我们要使用name对应的系统环境变量，对应name和value组的情况，表示我们要设置的对应name的环境变量在运行时的值。env只是变更了环境变量，更改了运行时的环境变量，如果希望在处理时，将环境变量作为一个值使用，例如作为server_name使用，则还需要额外的模块进行处理（如perl和lua模块），这里不做详细介绍。</p>
<p>ngx_core_module模块如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_module_t</span>  ngx_core_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_core_module_ctx,                  <span class="comment">/* module context */</span></span><br><span class="line">    ngx_core_commands,                     <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_CORE_MODULE,                       <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init master */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init module */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_core_module_t</span>  ngx_core_module_ctx = &#123;</span><br><span class="line">    ngx_string(<span class="string">"core"</span>),</span><br><span class="line">    ngx_core_module_create_conf,</span><br><span class="line">    ngx_core_module_init_conf</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_core_commands[] = &#123;</span><br><span class="line">   ...</span><br><span class="line">    &#123; ngx_string(<span class="string">"env"</span>),</span><br><span class="line">      NGX_MAIN_CONF|NGX_DIRECT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_set_env,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中设置环境变量的函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_set_env(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>   *value, *var;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i;</span><br><span class="line">    <span class="comment">// 向存储配置中使用的环境的变量的env中添加元素</span></span><br><span class="line">    var = ngx_array_push(&amp;ccf-&gt;env);</span><br><span class="line">    <span class="keyword">if</span> (var == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取解析配置的参数</span></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// value内容</span></span><br><span class="line">    *var = value[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 遍历值，找到等号的位置。如果存在，则记录等号的下标为长度，否则就是实际长度值</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; value[<span class="number">1</span>].len; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value[<span class="number">1</span>].data[i] == <span class="string">'='</span>) &#123;</span><br><span class="line"></span><br><span class="line">            var-&gt;len = i;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个问题是，记录的环境变量值并非一定是完整的配置文件中设置的值。这是由于配置文件中env有两个作用，一个是设置环境变量，另一个是使用环境变量。当我们只是写明了环境变量的key，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env PATH</span><br></pre></td></tr></table></figure>
<p>表示，我们要使用系统的PATH环境变量，其值为系统定义的值。</p>
<p>当我们写明的是环境变量的key和值时，表明我们要使用的环境变量，并且设置其值。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env PATH=/usr/bin</span><br></pre></td></tr></table></figure>
<p>表明执行的二进制文件的PATH环境变量值为<code>/usr/bin</code>。</p>
<p>如何区分二者呢，nginx就通过查看设置的值是否存在<code>=</code>进行区分。同时，为了方便后续使用，将len设置为等号的位置用于区分是使用环境变量还是设置环境变量。直接判断data[len]是否等于<code>=</code>即可。</p>
<h1 id="worker进程逻辑"><a href="#worker进程逻辑" class="headerlink" title="worker进程逻辑"></a>worker进程逻辑</h1><p><code>ngx_master_process_cycle</code>函数会创建指定数量的的worker进程，每个进程执行的处理函数为ngx_worker_process_cycle，其执行逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data为对应worker进程的id。从0开始连续整数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_worker_process_cycle(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span> worker = (<span class="keyword">intptr_t</span>) data;</span><br><span class="line">    <span class="comment">// 标识进程为worker进程，并记录id</span></span><br><span class="line">    ngx_process = NGX_PROCESS_WORKER;</span><br><span class="line">    ngx_worker = worker;</span><br><span class="line">    <span class="comment">// 执行worker进程的初始化</span></span><br><span class="line">    ngx_worker_process_init(cycle, worker);</span><br><span class="line">    <span class="comment">// 设置进程的title。ps时显示的进程名</span></span><br><span class="line">    ngx_setproctitle(<span class="string">"worker process"</span>);</span><br><span class="line">    <span class="comment">// 执行worker进程主循环</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 已经收到父进程优雅退出信号</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_exiting) &#123;</span><br><span class="line">            <span class="comment">// 判断是否所有事件均为可忽略事件，如果是则终止进程</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_event_no_timers_left() == NGX_OK) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"exiting"</span>);</span><br><span class="line">                ngx_worker_process_exit(cycle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录日志</span></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"worker cycle"</span>);</span><br><span class="line">        <span class="comment">// 执行事件函数</span></span><br><span class="line">        ngx_process_events_and_timers(cycle);</span><br><span class="line">        <span class="comment">// 如果收到立即退出指令，则执行退出</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_terminate) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"exiting"</span>);</span><br><span class="line">            ngx_worker_process_exit(cycle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果收到优雅退出指令，相应处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_quit) &#123;</span><br><span class="line">            ngx_quit = <span class="number">0</span>;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"gracefully shutting down"</span>);</span><br><span class="line">            <span class="comment">// 设置进程名</span></span><br><span class="line">            ngx_setproctitle(<span class="string">"worker process is shutting down"</span>);</span><br><span class="line">            <span class="comment">// 如果ngx_exiting不为1，则执行如下操作，不再接受请求</span></span><br><span class="line">            <span class="keyword">if</span> (!ngx_exiting) &#123;</span><br><span class="line">                ngx_exiting = <span class="number">1</span>;</span><br><span class="line">                ngx_set_shutdown_timer(cycle);</span><br><span class="line">                ngx_close_listening_sockets(cycle);</span><br><span class="line">                ngx_close_idle_connections(cycle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果收到重新打开日志文件的指令，执行相应操作</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_reopen) &#123;</span><br><span class="line">            ngx_reopen = <span class="number">0</span>;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"reopening logs"</span>);</span><br><span class="line">            ngx_reopen_files(cycle, <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="work进程初始化"><a href="#work进程初始化" class="headerlink" title="work进程初始化"></a>work进程初始化</h2><p>执行worker循环之前，会先对worker进行初始化操作。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_worker_process_init(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_int_t</span> worker)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span>          <span class="built_in">set</span>;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         n;</span><br><span class="line">    <span class="keyword">ngx_time_t</span>       *tp;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_cpuset_t</span>     *cpu_affinity;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span>     <span class="title">rlmt</span>;</span></span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>  *ls;</span><br><span class="line">    <span class="comment">// 设置环境变量，参考master中的处理</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_set_environment(cycle, <span class="literal">NULL</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* fatal */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取核心模块</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果配置了进程优先级，则执行setpriority设置，具体可参考：http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (worker &gt;= <span class="number">0</span> &amp;&amp; ccf-&gt;priority != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (setpriority(PRIO_PROCESS, <span class="number">0</span>, ccf-&gt;priority) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"setpriority(%d) failed"</span>, ccf-&gt;priority);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果配置了最大打开描述符数量，则执行setrlimit设置,具体参考：</span></span><br><span class="line"><span class="comment">http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%87%BD%E6%95%B0setjmp%E5%92%8Clongjmp</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;rlimit_nofile != NGX_CONF_UNSET) &#123;</span><br><span class="line">        rlmt.rlim_cur = (<span class="keyword">rlim_t</span>) ccf-&gt;rlimit_nofile;</span><br><span class="line">        rlmt.rlim_max = (<span class="keyword">rlim_t</span>) ccf-&gt;rlimit_nofile;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlmt) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"setrlimit(RLIMIT_NOFILE, %i) failed"</span>,</span><br><span class="line">                          ccf-&gt;rlimit_nofile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果配置了最大允许的core文件程度，则设置该值</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;rlimit_core != NGX_CONF_UNSET) &#123;</span><br><span class="line">        rlmt.rlim_cur = (<span class="keyword">rlim_t</span>) ccf-&gt;rlimit_core;</span><br><span class="line">        rlmt.rlim_max = (<span class="keyword">rlim_t</span>) ccf-&gt;rlimit_core;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (setrlimit(RLIMIT_CORE, &amp;rlmt) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"setrlimit(RLIMIT_CORE, %O) failed"</span>,</span><br><span class="line">                          ccf-&gt;rlimit_core);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取进程的有效用户ID失败</span></span><br><span class="line">    <span class="keyword">if</span> (geteuid() == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// 设置进程的组ID</span></span><br><span class="line">        <span class="keyword">if</span> (setgid(ccf-&gt;group) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"setgid(%d) failed"</span>, ccf-&gt;group);</span><br><span class="line">            <span class="comment">/* fatal */</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置附属组ID</span></span><br><span class="line">        <span class="keyword">if</span> (initgroups(ccf-&gt;username, ccf-&gt;group) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"initgroups(%s, %d) failed"</span>,</span><br><span class="line">                          ccf-&gt;username, ccf-&gt;group);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_PR_SET_KEEPCAPS &amp;&amp; NGX_HAVE_CAPABILITIES)</span></span><br><span class="line">        <span class="keyword">if</span> (ccf-&gt;transparent &amp;&amp; ccf-&gt;user) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prctl(PR_SET_KEEPCAPS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                              <span class="string">"prctl(PR_SET_KEEPCAPS, 1) failed"</span>);</span><br><span class="line">                <span class="comment">/* fatal */</span></span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (setuid(ccf-&gt;user) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"setuid(%d) failed"</span>, ccf-&gt;user);</span><br><span class="line">            <span class="comment">/* fatal */</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_CAPABILITIES)</span></span><br><span class="line">        <span class="keyword">if</span> (ccf-&gt;transparent &amp;&amp; ccf-&gt;user) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> __<span class="title">user_cap_data_struct</span>    <span class="title">data</span>;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> __<span class="title">user_cap_header_struct</span>  <span class="title">header</span>;</span></span><br><span class="line"></span><br><span class="line">            ngx_memzero(&amp;header, <span class="keyword">sizeof</span>(struct __user_cap_header_struct));</span><br><span class="line">            ngx_memzero(&amp;data, <span class="keyword">sizeof</span>(struct __user_cap_data_struct));</span><br><span class="line"></span><br><span class="line">            header.version = _LINUX_CAPABILITY_VERSION_1;</span><br><span class="line">            data.effective = CAP_TO_MASK(CAP_NET_RAW);</span><br><span class="line">            data.permitted = data.effective;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (syscall(SYS_capset, &amp;header, &amp;data) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                              <span class="string">"capset() failed"</span>);</span><br><span class="line">                <span class="comment">/* fatal */</span></span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 绑定进程到指定的CPU上</span></span><br><span class="line">    <span class="keyword">if</span> (worker &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        cpu_affinity = ngx_get_cpu_affinity(worker);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cpu_affinity) &#123;</span><br><span class="line">            ngx_setaffinity(cpu_affinity, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_PR_SET_DUMPABLE)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allow coredump after setuid() in Linux 2.4.x */</span></span><br><span class="line">    <span class="comment">// 设置进程可以进行核心转存（即生成core文件）在收到应该执行核心转存的信号时。正常情况所有进程都是可以的，但是在重新设置了uid和gid之后，该位被清除，这里进行重新设置，具体可参考prctl的man手册</span></span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_DUMPABLE, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"prctl(PR_SET_DUMPABLE) failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 如果设置了工作目录（配置中working_directory），则变更工作目录</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;working_directory.len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chdir((<span class="keyword">char</span> *) ccf-&gt;working_directory.data) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"chdir(\"%s\") failed"</span>, ccf-&gt;working_directory.data);</span><br><span class="line">            <span class="comment">/* fatal */</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置接收所有信号（屏蔽信号集为空）</span></span><br><span class="line">    sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;<span class="built_in">set</span>, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sigprocmask() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取缓存中时间</span></span><br><span class="line">    tp = ngx_timeofday();</span><br><span class="line">    srandom(((<span class="keyword">unsigned</span>) ngx_pid &lt;&lt; <span class="number">16</span>) ^ tp-&gt;sec ^ tp-&gt;msec);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * disable deleting previous events for the listening sockets because</span></span><br><span class="line"><span class="comment">     * in the worker processes there are no events at all at this point</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// 将每一个监听连接的老版本设置为null（继承而来的，重新执行ngx_init_cycle会将之前的套接字设置为新的套接字中的previous）</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        ls[i].previous = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行每个模块的init_process函数。ngx_core_event_modules的init_module在这里执行，初始化事件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;init_process) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;init_process(cycle) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="comment">/* fatal */</span></span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 关闭其他进程中与master进行通讯的unix域套接字（仅保留当前自己进程的，通过ngx_process_slot来判断是否为自己使用的数组，改字段从master进程继承而来）*/</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; ngx_last_process; n++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[n].pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n == ngx_process_slot) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_processes[n].channel[<span class="number">1</span>] == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (close(ngx_processes[n].channel[<span class="number">1</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"close() channel failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭master的发送端套接字</span></span><br><span class="line">    <span class="keyword">if</span> (close(ngx_processes[ngx_process_slot].channel[<span class="number">0</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"close() channel failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_last_process = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加监听与master通讯管道事件</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_add_channel_event(cycle, ngx_channel, NGX_READ_EVENT,</span><br><span class="line">                              ngx_channel_handler)</span><br><span class="line">        == NGX_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* fatal */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="绑定进程到指定CPU"><a href="#绑定进程到指定CPU" class="headerlink" title="绑定进程到指定CPU"></a>绑定进程到指定CPU</h3><p>进程绑定 CPU 的好处：在多核 CPU 结构中，每个核心有各自的L1、L2缓存，而L3缓存是共用的。如果一个进程在核心间来回切换，各个核心的缓存命中率就会受到影响。相反如果进程不管如何调度，都始终可以在一个核心上执行，那么其数据的L1、L2 缓存的命中率可以显著提高。</p>
<p>所以，将进程与 CPU 进行绑定可以提高 CPU 缓存的命中率，从而提高性能。而进程与 CPU 绑定被称为：<code>CPU 亲和性</code>。</p>
<p>linux使用<code>sched_setaffinity</code>系统调用实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sched_setaffinity</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> cpusetsize, <span class="keyword">const</span> <span class="keyword">cpu_set_t</span> *mask)</span></span>;</span><br></pre></td></tr></table></figure>
<p>pid为要设置的进程id,如果是0，则是调用进程本身的进程id。</p>
<p>cpusetsize为mask参数的大小。</p>
<p>mask参数是一个位图，每个位对应一个CPU，当某个位置1时，指示进程绑定到对应CPU上运行，一个进程可以绑定多个CPU。</p>
<p>如下函数检查和设置mask：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  __cpu_mask __bits[__CPU_SETSIZE / __NCPUBITS];</span><br><span class="line">&#125; <span class="keyword">cpu_set_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化一个空的cpu_set_t</span></span><br><span class="line">CPU_ZERO(<span class="keyword">cpu_set_t</span> cpusetp);</span><br><span class="line"><span class="comment">// 设置cpu的位置1</span></span><br><span class="line">CPU_SET(<span class="keyword">int</span> cpu, <span class="keyword">cpu_set_t</span> cpusetp)</span><br><span class="line"><span class="comment">// 判断是否对应cpu位置1了</span></span><br><span class="line">CPU_ISSET(<span class="keyword">int</span> cpu, <span class="keyword">cpu_set_t</span> cpusetp)</span><br></pre></td></tr></table></figure>
<p>下面看一下nginx中设置进程绑定到cpu上。</p>
<h4 id="配置解析"><a href="#配置解析" class="headerlink" title="配置解析"></a>配置解析</h4><p>在ngx_core_module模块中进行解析。</p>
<p>通过配置<code>worker_cpu_affinity</code>来设置绑定关系。该值也可以是auto，其解析逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"worker_cpu_affinity"</span>),</span><br><span class="line">      NGX_MAIN_CONF|NGX_DIRECT_CONF|NGX_CONF_1MORE,</span><br><span class="line">      ngx_set_cpu_affinity,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_set_cpu_affinity(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_CPU_AFFINITY)</span></span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf = conf;</span><br><span class="line"></span><br><span class="line">    u_char            ch, *p;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, n;</span><br><span class="line">    <span class="keyword">ngx_cpuset_t</span>     *mask;</span><br><span class="line">    <span class="comment">// 重复设置</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;cpu_affinity) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配mask数组，数量是参数数量减一（减去worker_cpu_affinity）</span></span><br><span class="line">    mask = ngx_palloc(cf-&gt;pool, (cf-&gt;args-&gt;nelts - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">ngx_cpuset_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (mask == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置的cpu绑定数量</span></span><br><span class="line">    ccf-&gt;cpu_affinity_n = cf-&gt;args-&gt;nelts - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 每个cpu绑定的位图</span></span><br><span class="line">    ccf-&gt;cpu_affinity = mask;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 如果参数是auto</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">1</span>].data, <span class="string">"auto"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 参数大于三个，则错误</span></span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &gt; <span class="number">3</span>) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"invalid number of arguments in "</span></span><br><span class="line">                               <span class="string">"\"worker_cpu_affinity\" directive"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置auto标识</span></span><br><span class="line">        ccf-&gt;cpu_affinity_auto = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 设置mask0，为所有位均置1</span></span><br><span class="line">        CPU_ZERO(&amp;mask[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (<span class="keyword">ngx_uint_t</span>) ngx_min(ngx_ncpu, CPU_SETSIZE); i++) &#123;</span><br><span class="line">            CPU_SET(i, &amp;mask[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// n=2,通过下面的循环处理</span></span><br><span class="line">        n = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理绑定参数</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; n &lt; cf-&gt;args-&gt;nelts; n++) &#123;</span><br><span class="line">        <span class="comment">// 如果参数长度大于位图字段长度，则是错误</span></span><br><span class="line">        <span class="keyword">if</span> (value[n].len &gt; CPU_SETSIZE) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                         <span class="string">"\"worker_cpu_affinity\" supports up to %d CPUs only"</span>,</span><br><span class="line">                         CPU_SETSIZE);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置位图，反向遍历，进行绑定</span></span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">        CPU_ZERO(&amp;mask[n - <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (p = value[n].data + value[n].len - <span class="number">1</span>;</span><br><span class="line">             p &gt;= value[n].data;</span><br><span class="line">             p--)</span><br><span class="line">        &#123;</span><br><span class="line">            ch = *p;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'0'</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'1'</span>) &#123;</span><br><span class="line">                CPU_SET(i - <span class="number">1</span>, &amp;mask[n - <span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"invalid character \"%c\" in \"worker_cpu_affinity\""</span>,</span><br><span class="line">                          ch);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_WARN, cf, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"\"worker_cpu_affinity\" is not supported "</span></span><br><span class="line">                       <span class="string">"on this platform, ignored"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取进程绑定的cpu"><a href="#获取进程绑定的cpu" class="headerlink" title="获取进程绑定的cpu"></a>获取进程绑定的cpu</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_cpuset_t</span> *</span><br><span class="line">ngx_get_cpu_affinity(<span class="keyword">ngx_uint_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_CPU_AFFINITY)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, j;</span><br><span class="line">    <span class="keyword">ngx_cpuset_t</span>     *mask;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ngx_cpuset_t</span>  result;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(ngx_cycle-&gt;conf_ctx,</span><br><span class="line">                                           ngx_core_module);</span><br><span class="line">    <span class="comment">// 如果未设置cpu绑定，则不执行</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;cpu_affinity == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是自动绑定</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;cpu_affinity_auto) &#123;</span><br><span class="line">        <span class="comment">// 获取被全部置为的mask</span></span><br><span class="line">        mask = &amp;ccf-&gt;cpu_affinity[ccf-&gt;cpu_affinity_n - <span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 遍历找到n对应的cpu设置标志位</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, j = n; <span class="comment">/* void */</span> ; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (CPU_ISSET(i % CPU_SETSIZE, mask) &amp;&amp; j-- == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == CPU_SETSIZE &amp;&amp; j == n) &#123;</span><br><span class="line">                <span class="comment">/* empty mask */</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* void */</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CPU_ZERO(&amp;result);</span><br><span class="line">        CPU_SET(i % CPU_SETSIZE, &amp;result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &amp;result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果设置的绑定关系小于当前worker的变换，则直接返回即可</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;cpu_affinity_n &gt; n) &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;ccf-&gt;cpu_affinity[n];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则取最后一个设置的绑定关系</span></span><br><span class="line">    <span class="keyword">return</span> &amp;ccf-&gt;cpu_affinity[ccf-&gt;cpu_affinity_n - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置绑定"><a href="#设置绑定" class="headerlink" title="设置绑定"></a>设置绑定</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_setaffinity(<span class="keyword">ngx_cpuset_t</span> *cpu_affinity, <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  i;</span><br><span class="line">    <span class="comment">// 打印日志</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CPU_SETSIZE; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (CPU_ISSET(i, cpu_affinity)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"sched_setaffinity(): using cpu #%ui"</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行绑定</span></span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">cpu_set_t</span>), cpu_affinity) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sched_setaffinity() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="unix域套接字通信事件"><a href="#unix域套接字通信事件" class="headerlink" title="unix域套接字通信事件"></a>unix域套接字通信事件</h3><p>在执行初始化的最后，会将与其他进程交互的套接字事件添加进入事件监控中。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_add_channel_event(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_fd_t</span> fd, <span class="keyword">ngx_int_t</span> event,</span><br><span class="line">    ngx_event_handler_pt handler)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>       *ev, *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line">    <span class="comment">// 获取一个空闲连接</span></span><br><span class="line">    c = ngx_get_connection(fd, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;pool = cycle-&gt;pool;</span><br><span class="line"></span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line">    wev = c-&gt;write;</span><br><span class="line"></span><br><span class="line">    rev-&gt;<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line">    wev-&gt;<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">// 设置事件为unix域套接字</span></span><br><span class="line">    rev-&gt;channel = <span class="number">1</span>;</span><br><span class="line">    wev-&gt;channel = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 这里事件始终为读事件</span></span><br><span class="line">    ev = (event == NGX_READ_EVENT) ? rev : wev;</span><br><span class="line">    <span class="comment">// 设置事件处理函数</span></span><br><span class="line">    ev-&gt;handler = handler;</span><br><span class="line">    <span class="comment">// epoll事件驱动，将连接添加进入事件驱动中，其中ngx_add_conn就是epoll模块的ngx_epoll_add_connection</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_add_conn &amp;&amp; (ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_add_conn(c) == NGX_ERROR) &#123;</span><br><span class="line">            ngx_free_connection(c);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_add_event(ev, event, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">            ngx_free_connection(c);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-channel-handler可读事件触发时处理"><a href="#ngx-channel-handler可读事件触发时处理" class="headerlink" title="ngx_channel_handler可读事件触发时处理"></a>ngx_channel_handler可读事件触发时处理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_channel_handler(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>          n;</span><br><span class="line">    <span class="keyword">ngx_channel_t</span>      ch;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line">    <span class="comment">// 如果事件已经超时，则跳过处理</span></span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;timedout) &#123;</span><br><span class="line">        ev-&gt;timedout = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取事件对应连接，这里是已经恢复末尾为0的指针</span></span><br><span class="line">    c = ev-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"channel handler"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 从unix域套接字中读取内容，查看master处理对应函数</span></span><br><span class="line">        n = ngx_read_channel(c-&gt;fd, &amp;ch, <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>), ev-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"channel: %i"</span>, n);</span><br><span class="line">        <span class="comment">// 如果发送错误</span></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">            <span class="comment">// 使用epoll，则从事件驱动中删除</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) &#123;</span><br><span class="line">                ngx_del_conn(c, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* 关闭连接，并释放。这样将导致无法与master进程通过套接字通讯。这时如果master进程要关闭该worker进程，只能使用kill指令 */</span></span><br><span class="line">            ngx_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 非epoll处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_EVENTPORT_EVENT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_add_event(ev, NGX_READ_EVENT, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是NGX_AGAIN表示未读取完成，下一轮继续读取</span></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_AGAIN) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"channel command: %ui"</span>, ch.command);</span><br><span class="line">        <span class="comment">// 完成数据获取处理，判断传输指令</span></span><br><span class="line">        <span class="keyword">switch</span> (ch.command) &#123;</span><br><span class="line">        <span class="comment">// 优雅退出指令，quit置1</span></span><br><span class="line">        <span class="keyword">case</span> NGX_CMD_QUIT:</span><br><span class="line">            ngx_quit = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 强制退出指令</span></span><br><span class="line">        <span class="keyword">case</span> NGX_CMD_TERMINATE:</span><br><span class="line">            ngx_terminate = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新打开打开的文件</span></span><br><span class="line">        <span class="keyword">case</span> NGX_CMD_REOPEN:</span><br><span class="line">            ngx_reopen = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 打开其他进程的unix域套接字，传递文件描述符使用。详情查看master中进程间通讯</span></span><br><span class="line">        <span class="keyword">case</span> NGX_CMD_OPEN_CHANNEL:</span><br><span class="line"></span><br><span class="line">            ngx_log_debug3(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"get channel s:%i pid:%P fd:%d"</span>,</span><br><span class="line">                           ch.slot, ch.pid, ch.fd);</span><br><span class="line"></span><br><span class="line">            ngx_processes[ch.slot].pid = ch.pid;</span><br><span class="line">            ngx_processes[ch.slot].channel[<span class="number">0</span>] = ch.fd;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 关闭套接字</span></span><br><span class="line">        <span class="keyword">case</span> NGX_CMD_CLOSE_CHANNEL:</span><br><span class="line"></span><br><span class="line">            ngx_log_debug4(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"close channel s:%i pid:%P our:%P fd:%d"</span>,</span><br><span class="line">                           ch.slot, ch.pid, ngx_processes[ch.slot].pid,</span><br><span class="line">                           ngx_processes[ch.slot].channel[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (close(ngx_processes[ch.slot].channel[<span class="number">0</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                              <span class="string">"close() channel failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_processes[ch.slot].channel[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="读取unix域数据"><a href="#读取unix域数据" class="headerlink" title="读取unix域数据"></a>读取unix域数据</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_read_channel(<span class="keyword">ngx_socket_t</span> s, <span class="keyword">ngx_channel_t</span> *ch, <span class="keyword">size_t</span> size, <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>             n;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>           err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span>        <span class="title">iov</span>[1];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span>       <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_MSGHDR_MSG_CONTROL)</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span>  <span class="title">cm</span>;</span></span><br><span class="line">        <span class="keyword">char</span>            space[CMSG_SPACE(<span class="keyword">sizeof</span>(<span class="keyword">int</span>))];</span><br><span class="line">    &#125; cmsg;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">int</span>                 fd;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = (<span class="keyword">char</span> *) ch;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = size;</span><br><span class="line"></span><br><span class="line">    msg.msg_name = <span class="literal">NULL</span>;</span><br><span class="line">    msg.msg_namelen = <span class="number">0</span>;</span><br><span class="line">    msg.msg_iov = iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_MSGHDR_MSG_CONTROL)</span></span><br><span class="line">    msg.msg_control = (<span class="keyword">caddr_t</span>) &amp;cmsg;</span><br><span class="line">    msg.msg_controllen = <span class="keyword">sizeof</span>(cmsg);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    msg.msg_accrights = (<span class="keyword">caddr_t</span>) &amp;fd;</span><br><span class="line">    msg.msg_accrightslen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    n = recvmsg(s, &amp;msg, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        err = ngx_errno;</span><br><span class="line">        <span class="keyword">if</span> (err == NGX_EAGAIN) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, err, <span class="string">"recvmsg() failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_CORE, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"recvmsg() returned zero"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; <span class="keyword">sizeof</span>(<span class="keyword">ngx_channel_t</span>)) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"recvmsg() returned not enough data: %z"</span>, n);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_MSGHDR_MSG_CONTROL)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ch-&gt;command == NGX_CMD_OPEN_CHANNEL) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmsg.cm.cmsg_len &lt; (<span class="keyword">socklen_t</span>) CMSG_LEN(<span class="keyword">sizeof</span>(<span class="keyword">int</span>))) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"recvmsg() returned too small ancillary data"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmsg.cm.cmsg_level != SOL_SOCKET || cmsg.cm.cmsg_type != SCM_RIGHTS)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"recvmsg() returned invalid ancillary data "</span></span><br><span class="line">                          <span class="string">"level %d or type %d"</span>,</span><br><span class="line">                          cmsg.cm.cmsg_level, cmsg.cm.cmsg_type);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ch-&gt;fd = *(int *) CMSG_DATA(&amp;cmsg.cm); */</span></span><br><span class="line"></span><br><span class="line">        ngx_memcpy(&amp;ch-&gt;fd, CMSG_DATA(&amp;cmsg.cm), <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg.msg_flags &amp; (MSG_TRUNC|MSG_CTRUNC)) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"recvmsg() truncated data"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ch-&gt;command == NGX_CMD_OPEN_CHANNEL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.msg_accrightslen != <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"recvmsg() returned no ancillary data"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ch-&gt;fd = fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-worker-process-exit进程退出"><a href="#ngx-worker-process-exit进程退出" class="headerlink" title="ngx_worker_process_exit进程退出"></a>ngx_worker_process_exit进程退出</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_worker_process_exit(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line">    <span class="comment">// 执行每个模块的exit_process方法</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;exit_process) &#123;</span><br><span class="line">            cycle-&gt;modules[i]-&gt;exit_process(cycle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是优雅的关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_exiting) &#123;</span><br><span class="line">        c = cycle-&gt;connections;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;connection_n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c[i].fd != <span class="number">-1</span></span><br><span class="line">                &amp;&amp; c[i].read</span><br><span class="line">                &amp;&amp; !c[i].read-&gt;accept</span><br><span class="line">                &amp;&amp; !c[i].read-&gt;channel</span><br><span class="line">                &amp;&amp; !c[i].read-&gt;resolver)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"*%uA open socket #%d left in connection %ui"</span>,</span><br><span class="line">                              c[i].number, c[i].fd, i);</span><br><span class="line">                ngx_debug_quit = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_debug_quit) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"aborting"</span>);</span><br><span class="line">            ngx_debug_point();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Copy ngx_cycle-&gt;log related data to the special static exit cycle,</span></span><br><span class="line"><span class="comment">     * log, and log file structures enough to allow a signal handler to log.</span></span><br><span class="line"><span class="comment">     * The handler may be called when standard ngx_cycle-&gt;log allocated from</span></span><br><span class="line"><span class="comment">     * ngx_cycle-&gt;pool is already destroyed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_exit_log = *ngx_log_get_file_log(ngx_cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    ngx_exit_log_file.fd = ngx_exit_log.file-&gt;fd;</span><br><span class="line">    ngx_exit_log.file = &amp;ngx_exit_log_file;</span><br><span class="line">    ngx_exit_log.next = <span class="literal">NULL</span>;</span><br><span class="line">    ngx_exit_log.writer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    ngx_exit_cycle.<span class="built_in">log</span> = &amp;ngx_exit_log;</span><br><span class="line">    ngx_exit_cycle.files = ngx_cycle-&gt;files;</span><br><span class="line">    ngx_exit_cycle.files_n = ngx_cycle-&gt;files_n;</span><br><span class="line">    ngx_cycle = &amp;ngx_exit_cycle;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(cycle-&gt;pool);</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-set-shutdown-timer设置关机时间"><a href="#ngx-set-shutdown-timer设置关机时间" class="headerlink" title="ngx_set_shutdown_timer设置关机时间"></a>ngx_set_shutdown_timer设置关机时间</h2><p>当配置的show_down字段时，会在优雅的关机时增加一个超时时间，用于加快关机，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_set_shutdown_timer(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;shutdown_timeout) &#123;</span><br><span class="line">        ngx_shutdown_event.handler = ngx_shutdown_timer_handler;</span><br><span class="line">        ngx_shutdown_event.data = cycle;</span><br><span class="line">        ngx_shutdown_event.<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line">        ngx_shutdown_event.cancelable = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 将事件添加到时间驱动中</span></span><br><span class="line">        ngx_add_timer(&amp;ngx_shutdown_event, ccf-&gt;shutdown_timeout);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中handler处理函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_shutdown_timer_handler(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>       *cycle;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    cycle = ev-&gt;data;</span><br><span class="line"></span><br><span class="line">    c = cycle-&gt;connections;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;connection_n; i++) &#123;</span><br><span class="line">        <span class="comment">// 获取每一个普通的，非accept的和用于进程间通讯的连接</span></span><br><span class="line">        <span class="keyword">if</span> (c[i].fd == (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span></span><br><span class="line">            || c[i].read == <span class="literal">NULL</span></span><br><span class="line">            || c[i].read-&gt;accept</span><br><span class="line">            || c[i].read-&gt;channel</span><br><span class="line">            || c[i].read-&gt;resolver)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"*%uA shutdown timeout"</span>, c[i].number);</span><br><span class="line">        <span class="comment">// 将连接关闭</span></span><br><span class="line">        c[i].close = <span class="number">1</span>;</span><br><span class="line">        c[i].error = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 执行对应的读事件的处理函数，以加快关机</span></span><br><span class="line">        c[i].read-&gt;handler(c[i].read);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-close-listening-sockets关闭正在监听套接字"><a href="#ngx-close-listening-sockets关闭正在监听套接字" class="headerlink" title="ngx_close_listening_sockets关闭正在监听套接字"></a>ngx_close_listening_sockets关闭正在监听套接字</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_close_listening_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_IOCP_EVENT) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置负载均衡锁相关全局变量</span></span><br><span class="line">    ngx_accept_mutex_held = <span class="number">0</span>;</span><br><span class="line">    ngx_use_accept_mutex = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历每个连接</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        c = ls[i].connection;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (c) &#123;</span><br><span class="line">            <span class="comment">// 读事件为活跃状态</span></span><br><span class="line">            <span class="keyword">if</span> (c-&gt;read-&gt;active) &#123;</span><br><span class="line">                <span class="comment">// 从事件驱动中删除</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * it seems that Linux-2.6.x OpenVZ sends events</span></span><br><span class="line"><span class="comment">                     * for closed shared listening sockets unless</span></span><br><span class="line"><span class="comment">                     * the events was explicitly deleted</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">          </span><br><span class="line">                    ngx_del_event(c-&gt;read, NGX_READ_EVENT, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ngx_del_event(c-&gt;read, NGX_READ_EVENT, NGX_CLOSE_EVENT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 释放连接</span></span><br><span class="line">            ngx_free_connection(c);</span><br><span class="line">            <span class="comment">// 设置fd为-1</span></span><br><span class="line">            c-&gt;fd = (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_CORE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"close listening %V #%d "</span>, &amp;ls[i].addr_text, ls[i].fd);</span><br><span class="line">        <span class="comment">// 关闭套接字</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_close_socket(ls[i].fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          ngx_close_socket_n <span class="string">" %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">        <span class="comment">/* 如果是unix域套接字，并且是master进程或单进程模式运行，并且当前没有新的二进制文件被执行，并且不是继承而来的套接字或者是新运行的二进制程序,则删除对应的文件，这里复杂的判断是避免误删 */</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].sockaddr-&gt;sa_family == AF_UNIX</span><br><span class="line">            &amp;&amp; ngx_process &lt;= NGX_PROCESS_MASTER</span><br><span class="line">            &amp;&amp; ngx_new_binary == <span class="number">0</span></span><br><span class="line">            &amp;&amp; (!ls[i].inherited || ngx_getppid() != ngx_parent))</span><br><span class="line">        &#123;</span><br><span class="line">            u_char *name = ls[i].addr_text.data + <span class="keyword">sizeof</span>(<span class="string">"unix:"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              ngx_delete_file_n <span class="string">" %s failed"</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        ls[i].fd = (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;listening.nelts = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-close-idle-connections关闭空闲连接"><a href="#ngx-close-idle-connections关闭空闲连接" class="headerlink" title="ngx_close_idle_connections关闭空闲连接"></a>ngx_close_idle_connections关闭空闲连接</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_close_idle_connections(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = cycle-&gt;connections;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;connection_n; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* THREAD: lock */</span></span><br><span class="line">        <span class="comment">// 连接正在使用，并且是空闲的，则关闭连接，执行对应的读事件</span></span><br><span class="line">        <span class="keyword">if</span> (c[i].fd != (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span> &amp;&amp; c[i].idle) &#123;</span><br><span class="line">            c[i].close = <span class="number">1</span>;</span><br><span class="line">            c[i].read-&gt;handler(c[i].read);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-reopen-files重新打开日志文件"><a href="#ngx-reopen-files重新打开日志文件" class="headerlink" title="ngx_reopen_files重新打开日志文件"></a>ngx_reopen_files重新打开日志文件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_reopen_files(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_uid_t</span> user)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_fd_t</span>          fd;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>  *part;</span><br><span class="line">    <span class="keyword">ngx_open_file_t</span>  *file;</span><br><span class="line">    <span class="comment">// 打开的文件都会在open_files中存储</span></span><br><span class="line">    part = &amp;cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line">    <span class="comment">// 变量所有文件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; <span class="comment">/* void */</span> ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            <span class="keyword">if</span> (part-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file[i].name.len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果含义flush刷新操作，则执行对应函数</span></span><br><span class="line">        <span class="keyword">if</span> (file[i].flush) &#123;</span><br><span class="line">            file[i].flush(&amp;file[i], cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重新打开文件</span></span><br><span class="line">        fd = ngx_open_file(file[i].name.data, NGX_FILE_APPEND,</span><br><span class="line">                           NGX_FILE_CREATE_OR_OPEN, NGX_FILE_DEFAULT_ACCESS);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"reopen file \"%s\", old:%d new:%d"</span>,</span><br><span class="line">                       file[i].name.data, file[i].fd, fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_open_file_n <span class="string">" \"%s\" failed"</span>, file[i].name.data);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(NGX_WIN32)</span></span><br><span class="line">        <span class="comment">// 设置对应的文件属性</span></span><br><span class="line">        <span class="keyword">if</span> (user != (<span class="keyword">ngx_uid_t</span>) NGX_CONF_UNSET_UINT) &#123;</span><br><span class="line">            <span class="keyword">ngx_file_info_t</span>  fi;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_file_info(file[i].name.data, &amp;fi) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                              ngx_file_info_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                              file[i].name.data);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_file(fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                  ngx_close_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                                  file[i].name.data);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fi.st_uid != user) &#123;</span><br><span class="line">                <span class="keyword">if</span> (chown((<span class="keyword">const</span> <span class="keyword">char</span> *) file[i].name.data, user, <span class="number">-1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                  <span class="string">"chown(\"%s\", %d) failed"</span>,</span><br><span class="line">                                  file[i].name.data, user);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_file(fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                      ngx_close_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                                      file[i].name.data);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((fi.st_mode &amp; (S_IRUSR|S_IWUSR)) != (S_IRUSR|S_IWUSR)) &#123;</span><br><span class="line"></span><br><span class="line">                fi.st_mode |= (S_IRUSR|S_IWUSR);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (chmod((<span class="keyword">const</span> <span class="keyword">char</span> *) file[i].name.data, fi.st_mode) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                  <span class="string">"chmod() \"%s\" failed"</span>, file[i].name.data);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_file(fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                      ngx_close_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                                      file[i].name.data);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置执行时关闭</span></span><br><span class="line">        <span class="keyword">if</span> (fcntl(fd, F_SETFD, FD_CLOEXEC) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"fcntl(FD_CLOEXEC) \"%s\" failed"</span>,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_close_file(fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                              ngx_close_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                              file[i].name.data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 关闭原文件描述符</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_close_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 赋值新的文件描述符</span></span><br><span class="line">        file[i].fd = fd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重定向标准输出</span></span><br><span class="line">    (<span class="keyword">void</span>) ngx_log_redirect_stderr(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在使用open打开文件时，使用<code>O_APPEND</code>，保证多进程输入不会发送混乱。</p>
<p>在执行日志回滚时，应该先将旧文件移动到新的位置，在向master进程发送reopen信号。这时处理逻辑是，会先将缓冲区的内容写到旧的文件中。然后重新打开文件时发现文件不存在，新建文件，之后再关闭旧的文件描述符，之后使用新的文件描述符。</p>
<h2 id="ngx-process-events-and-timers事件处理"><a href="#ngx-process-events-and-timers事件处理" class="headerlink" title="ngx_process_events_and_timers事件处理"></a>ngx_process_events_and_timers事件处理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_process_events_and_timers(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  flags;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>  timer, delta;</span><br><span class="line">    <span class="comment">// 如果设置了时钟触发，则设置timer为未定义</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_timer_resolution) &#123;</span><br><span class="line">        timer = NGX_TIMER_INFINITE;</span><br><span class="line">        flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设置更新时间，并设置epoll_wait超时时间为最近一个事件将要触发的时间，具体查看事件章节定时器事件</span></span><br><span class="line">        timer = ngx_event_find_timer();</span><br><span class="line">        flags = NGX_UPDATE_TIME;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* handle signals from master in case of network inactivity */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timer == NGX_TIMER_INFINITE || timer &gt; <span class="number">500</span>) &#123;</span><br><span class="line">            timer = <span class="number">500</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果使用负载均衡锁</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_use_accept_mutex) &#123;</span><br><span class="line">        <span class="comment">/* 如果ngx_accept_disabled大于0，则表明当前进程较为繁忙，不再接收连接，并将ngx_accept_disabled减一，直到到非正数才获取连接</span></span><br><span class="line"><span class="comment">        初始化ngx_accept_disabled为0，每个连接事件发生时，处理函数中会根据当前连接数量重新对该值赋值。具体可以查看http处理</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_accept_disabled &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_accept_disabled--;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 尝试获取锁，并将监听连接的套接字添加到事件驱动中</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_trylock_accept_mutex(cycle) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果获取到了锁，则为了加快锁的释放，让其他进程能够获取到锁，所有事件触发函数放到post队列中，延后执行</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_accept_mutex_held) &#123;</span><br><span class="line">                flags |= NGX_POST_EVENTS;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则，如果时间是未定义的，则设置下一次epoll_wait的超时事件为获取负载均衡锁的最小间隔时间，保证下次尝试获取负载均衡锁与本次的时间间隔满足要求。</span></span><br><span class="line">                <span class="keyword">if</span> (timer == NGX_TIMER_INFINITE</span><br><span class="line">                    || timer &gt; ngx_accept_mutex_delay)</span><br><span class="line">                &#123;</span><br><span class="line">                    timer = ngx_accept_mutex_delay;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果ngx_posted_next_events队列不为空，则将ngx_posted_next_events队列数据添加到ngx_posted_events队列中</span></span><br><span class="line">    <span class="keyword">if</span> (!ngx_queue_empty(&amp;ngx_posted_next_events)) &#123;</span><br><span class="line">        ngx_event_move_posted_next(cycle);</span><br><span class="line">        timer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 记录当前缓存事件</span></span><br><span class="line">    delta = ngx_current_msec;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define ngx_process_events   ngx_event_actions.process_events</span></span><br><span class="line"><span class="comment">    执行事件模块处理，对应epoll模块的ngx_epoll_process_events方法</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    (<span class="keyword">void</span>) ngx_process_events(cycle, timer, flags);</span><br><span class="line">    <span class="comment">// 因为上一步可能会更新时间，判断时间差值</span></span><br><span class="line">    delta = ngx_current_msec - delta;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"timer delta: %M"</span>, delta);</span><br><span class="line">    <span class="comment">// 处理ngx_posted_accept_events队列事件，其中执行待连接请求</span></span><br><span class="line">    ngx_event_process_posted(cycle, &amp;ngx_posted_accept_events);</span><br><span class="line">    <span class="comment">// 如果持有负载均衡锁，则释放，这里并未将ngx_accept_mutex_held置0，而是在下次尝试获取锁时置0</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_accept_mutex_held) &#123;</span><br><span class="line">        ngx_shmtx_unlock(&amp;ngx_accept_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果时间发生变更，则执行事件红黑树中已经触发的所有事件，详情查看事件章节的定时器事件</span></span><br><span class="line">    <span class="keyword">if</span> (delta) &#123;</span><br><span class="line">        ngx_event_expire_timers();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行ngx_posted_events队列中事件</span></span><br><span class="line">    ngx_event_process_posted(cycle, &amp;ngx_posted_events);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>负载均衡主要通过原子变量<code>ngx_use_accept_mutex</code>和ngx_accept_disabled控制。ngx_accept_disabled是一个整数，初始化为0，每次新连接建立时会根据当前连接数量对该值赋值：<code>ngx_cycle-&gt;connection_n / 8 - ngx_cycle-&gt;free_connection_n</code>即所有连接数的百分之一减去当前空闲连接。当负载过高时，空闲连接将会减少，当八分之七的连接已经使用时，该值将变成正值，这时循环中将不再获取负载均衡锁，即不再建立新的连接，而是将该值减一，直到到0才继续接收连接。</p>
<h3 id="ngx-trylock-accept-mutex获取负载均衡锁"><a href="#ngx-trylock-accept-mutex获取负载均衡锁" class="headerlink" title="ngx_trylock_accept_mutex获取负载均衡锁"></a>ngx_trylock_accept_mutex获取负载均衡锁</h3><p>该方法会尝试获取负载均衡锁，并将监听套接字对应事件添加到事件驱动中。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_trylock_accept_mutex(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// 成功获取到负载均衡锁。具体逻辑查看锁机制</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_shmtx_trylock(&amp;ngx_accept_mutex)) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"accept mutex locked"</span>);</span><br><span class="line">        <span class="comment">// ngx_accept_events非epoll模块使用的变量，不用考虑，如果当前已经持有负载均衡锁，则直接返回成功</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_accept_mutex_held &amp;&amp; ngx_accept_events == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果之前没有获取到负载均衡锁，则将监听事件加入到epoll中，如果加入失败则释放锁</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_enable_accept_events(cycle) == NGX_ERROR) &#123;</span><br><span class="line">            ngx_shmtx_unlock(&amp;ngx_accept_mutex);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_accept_events = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 设置持有负载均衡锁</span></span><br><span class="line">        ngx_accept_mutex_held = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"accept mutex lock failed: %ui"</span>, ngx_accept_mutex_held);</span><br><span class="line">    <span class="comment">// 如果没有获取到负载均衡锁，但是记录已经获取到，则将不应该监听的套接字事件从epoll中删除，并表示未持有</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_accept_mutex_held) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_disable_accept_events(cycle, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_accept_mutex_held = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意在每次循环中，如果获取到负载均衡锁了，只会是否锁，并不会将监听事件从epoll中去除。只会在下一次循环中，未获取到负载均衡锁时才从中删除。这应该是处于效率考量的，如果其他进程负载都交高是，某一个负载较低的进程则很可能在多次循环中都能够获取到负载均衡锁，这时采用上述方法就不用每次都执行添加事件和删除事件了。</p>
<h3 id="ngx-enable-accept-events添加监听套接字对应事件到事件驱动模块"><a href="#ngx-enable-accept-events添加监听套接字对应事件到事件驱动模块" class="headerlink" title="ngx_enable_accept_events添加监听套接字对应事件到事件驱动模块"></a>ngx_enable_accept_events添加监听套接字对应事件到事件驱动模块</h3><p>注意不是所有监听套接字都需要使用该方法进行添加。对于不使用负载均衡锁来说，不用该方法。对应设置了端口可复用的套接字来说，会为每一个进程拷贝一份监听套接字，每个进程单独进行监听，操作系统提供负载均衡操作（具体查看事件模块的ngx_event_core_module模块和ngx_events_module模块的介绍）。</p>
<p>其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_enable_accept_events(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        c = ls[i].connection;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        对于支持端口复用的监听来说，如果不是为当前进程生成的ls，则对应的connection为空</span></span><br><span class="line"><span class="comment">        对于为当前进程创建的ls结构来说，其读事件已经被加入到事件驱动中，其active为true</span></span><br><span class="line"><span class="comment">        因此这里只是加入之前未被加入需要监听的套接字对应事件</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">NULL</span> || c-&gt;read-&gt;active) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_add_event(c-&gt;read, NGX_READ_EVENT, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-disable-accept-events从事件驱动中删除监听套接字对应事件"><a href="#ngx-disable-accept-events从事件驱动中删除监听套接字对应事件" class="headerlink" title="ngx_disable_accept_events从事件驱动中删除监听套接字对应事件"></a>ngx_disable_accept_events从事件驱动中删除监听套接字对应事件</h3><p>与添加一样，也是只能删除该删除的，对应端口复用的不能删除：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// all如果为1，则是删除所有时间</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_disable_accept_events(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_uint_t</span> all)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        c = ls[i].connection;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">NULL</span> || !c-&gt;read-&gt;active) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * do not disable accept on worker's own sockets</span></span><br><span class="line"><span class="comment">         * when disabling accept events due to accept mutex</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">         <span class="comment">// 如果是支持端口复用的，并且不是要删除所有事件，则跳过</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].reuseport &amp;&amp; !all) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_del_event(c-&gt;read, NGX_READ_EVENT, NGX_DISABLE_EVENT)</span><br><span class="line">            == NGX_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-event-process-posted执行post队列中时间"><a href="#ngx-event-process-posted执行post队列中时间" class="headerlink" title="ngx_event_process_posted执行post队列中时间"></a>ngx_event_process_posted执行post队列中时间</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_event_process_posted(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_queue_t</span> *posted)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *q;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>  *ev;</span><br><span class="line">    <span class="comment">// 变量每个posted队列</span></span><br><span class="line">    <span class="keyword">while</span> (!ngx_queue_empty(posted)) &#123;</span><br><span class="line">        <span class="comment">// 获取第一个元素</span></span><br><span class="line">        q = ngx_queue_head(posted);</span><br><span class="line">        <span class="comment">// 获取对应的事件</span></span><br><span class="line">        ev = ngx_queue_data(q, <span class="keyword">ngx_event_t</span>, <span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"posted event %p"</span>, ev);</span><br><span class="line">        <span class="comment">// 从队列中删除当前事件</span></span><br><span class="line">        ngx_delete_posted_event(ev);</span><br><span class="line">        <span class="comment">// 执行事件对应的处理函数</span></span><br><span class="line">        ev-&gt;handler(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="HTTP请求处理流程"><a href="#HTTP请求处理流程" class="headerlink" title="HTTP请求处理流程"></a>HTTP请求处理流程</h1><p>在worker进程启动时会调用事件核心模块，监听网络请求，在接收到请求和首先会执行<code>ngx_event_accept</code>监听事件回调方法。下面就按照该方法逐一讲解http处理流程。</p>
<h2 id="主要结构"><a href="#主要结构" class="headerlink" title="主要结构"></a>主要结构</h2><h3 id="ngx-http-request-t请求结构"><a href="#ngx-http-request-t请求结构" class="headerlink" title="ngx_http_request_t请求结构"></a>ngx_http_request_t请求结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_http_request_s &#123;</span><br><span class="line">    uint32_t                          signature;         /* &quot;HTTP&quot; */</span><br><span class="line">    // 请求对应的连接</span><br><span class="line">    ngx_connection_t                 *connection;</span><br><span class="line"> </span><br><span class="line">    // 指向存放所有http模块的上下文结构体的指针数组</span><br><span class="line">    void                            **ctx;</span><br><span class="line">    // 执行请求对应的存放main级别配置结构体的指针数组</span><br><span class="line">    void                            **main_conf;</span><br><span class="line">    // 执行请求对应存放srv级别配置结构体的指针数组</span><br><span class="line">    void                            **srv_conf;</span><br><span class="line">    // 执行请求对应存放loc_conf级别配置结构体的指针数组</span><br><span class="line">    void                            **loc_conf;</span><br><span class="line"></span><br><span class="line">    /* 在接收完http头部，第一次在业务上处理http请求时，http框架提供的方法是ngx_http_process_request方法。如果该方法无法一次完成请求处理，将会把控制权交到epoll事件驱动中，该请求再次被回调时，将通过ngx_http_request_handler方法来处理，该方法对可读事件的处理就是调用read_event_handler处理请求。 */</span><br><span class="line">    ngx_http_event_handler_pt         read_event_handler;</span><br><span class="line">    /* 与read_event_handler回调方法类似，如果ngx_http_request_handler方法判断为写事件，则调用该函数 */</span><br><span class="line">    ngx_http_event_handler_pt         write_event_handler;</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_CACHE)</span><br><span class="line">    ngx_http_cache_t                 *cache;</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    // upstream机制对应结构</span><br><span class="line">    ngx_http_upstream_t              *upstream;</span><br><span class="line">    ngx_array_t                      *upstream_states;</span><br><span class="line">                                         /* of ngx_http_upstream_state_t */</span><br><span class="line"></span><br><span class="line">    ngx_pool_t                       *pool;</span><br><span class="line">    // 接收http请求的内容缓冲区，主要用来接收http头部</span><br><span class="line">    ngx_buf_t                        *header_in;</span><br><span class="line"></span><br><span class="line">    // 存储解析http请求的内容</span><br><span class="line">    ngx_http_headers_in_t             headers_in;</span><br><span class="line">    // 发送http相应信息放到该结构中，由架构将该结构序列号http响应包发送给用户</span><br><span class="line">    ngx_http_headers_out_t            headers_out;</span><br><span class="line"></span><br><span class="line">    // 接收http请求包体的数据结构</span><br><span class="line">    ngx_http_request_body_t          *request_body;</span><br><span class="line"></span><br><span class="line">    // 延迟关闭连接的事件</span><br><span class="line">    time_t                            lingering_time;</span><br><span class="line">    // 请求初始化的事件戳，秒</span><br><span class="line">    time_t                            start_sec;</span><br><span class="line">    // 相对start_sec的毫秒偏移</span><br><span class="line">    ngx_msec_t                        start_msec;</span><br><span class="line"></span><br><span class="line">    // 下面9个均为http请求行解析出的信息</span><br><span class="line">    // 请求类型</span><br><span class="line">    ngx_uint_t                        method;</span><br><span class="line">    // http版本</span><br><span class="line">    ngx_uint_t                        http_version;</span><br><span class="line">    // 请求行信息</span><br><span class="line">    ngx_str_t                         request_line;</span><br><span class="line">    // 请求的uri,uri长度不包含args参数部分</span><br><span class="line">    ngx_str_t                         uri;</span><br><span class="line">    // 请求参数</span><br><span class="line">    ngx_str_t                         args;</span><br><span class="line">    // 请求的文件扩展名，如访问&quot;GET /a.txt HTTP/1.1&quot;时，exten为&#123;len:3,data:&quot;txt&quot;&#125;</span><br><span class="line">    ngx_str_t                         exten;</span><br><span class="line">    // 未解码的url原始请求，当uri为&quot;/a b&quot;时，unparsed_uri是&quot;/a%20b&quot;，空格字符做完编码后是%20</span><br><span class="line">    ngx_str_t                         unparsed_uri;</span><br><span class="line"></span><br><span class="line">    // 请求方式get，put等</span><br><span class="line">    ngx_str_t                         method_name;</span><br><span class="line">    // http协议版本，http_protocol指向http协议版本字符串起始地址，len成员为协议版本字符串长度</span><br><span class="line">    ngx_str_t                         http_protocol;</span><br><span class="line">    </span><br><span class="line">    ngx_str_t                         schema;</span><br><span class="line"></span><br><span class="line">    // 需要方法给客户端的http响应。out中保存着header_out中序列化后的表示http头部的TCP流。</span><br><span class="line">    ngx_chain_t                      *out;</span><br><span class="line">    // 当前请求有可能是用户发送的请求，也可能是派生出的子请求，main标识一系列相关的派生子请求的原始请求，一般通过判断main和当前请求地址是否一致来判断请求是否为用户发送的原始请求。</span><br><span class="line">    ngx_http_request_t               *main;</span><br><span class="line">    // 请求的父请求，父请求不一定是原始请求</span><br><span class="line">    ngx_http_request_t               *parent;</span><br><span class="line">    // 与subrequest相关的结构</span><br><span class="line">    ngx_http_postponed_request_t     *postponed;</span><br><span class="line">    ngx_http_post_subrequest_t       *post_subrequest;</span><br><span class="line">    // 所有子请求通过posted_requests单链表链接起来，通过调用ngx_http_run_posted_request方法来遍历单链表执行子请求。</span><br><span class="line">    ngx_http_posted_request_t        *posted_requests;</span><br><span class="line"></span><br><span class="line">    /* 全局的ngx_http_phase_engine_t结构体定义了一个ngx_http_phase_handler_t回调方法组成的数组，phase_handler与数组配合使用，表示请求下次应该执行以phase_handler为下标的回调方法 */</span><br><span class="line">    ngx_int_t                         phase_handler;</span><br><span class="line">    // 表示NGX_HTTP_CONFENT_PHASE阶段提供给HTTP模块处理请求的一种方式，content_handler指向HTTP模块实现的请求处理方法</span><br><span class="line">    ngx_http_handler_pt               content_handler;</span><br><span class="line">    /* NGX_HTTP_ACCESS_PHASE阶段判断用户是否具有访问权限时，通过access_code来传递http模块的handler回调方法返回值。0表示具有权限，否则不具有权限*/</span><br><span class="line">    ngx_uint_t                        access_code;</span><br><span class="line">    </span><br><span class="line">    // 请求对应的变量</span><br><span class="line">    ngx_http_variable_value_t        *variables;</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_uint_t                        ncaptures;</span><br><span class="line">    int                              *captures;</span><br><span class="line">    u_char                           *captures_data;</span><br><span class="line">#endif</span><br><span class="line">    // 请求速率限制</span><br><span class="line">    size_t                            limit_rate;</span><br><span class="line">    size_t                            limit_rate_after;</span><br><span class="line"></span><br><span class="line">    /* used to learn the Apache compatible response length without a header */</span><br><span class="line">    size_t                            header_size;</span><br><span class="line"></span><br><span class="line">    // 请求长度</span><br><span class="line">    off_t                             request_length;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                        err_status;</span><br><span class="line">    // 对应连接信息</span><br><span class="line">    ngx_http_connection_t            *http_connection;</span><br><span class="line">    ngx_http_v2_stream_t             *stream;</span><br><span class="line"></span><br><span class="line">    ngx_http_log_handler_pt           log_handler;</span><br><span class="line"></span><br><span class="line">    // 请求中打开的资源需要在结束时释放，需要把资源释放的方法定义到该成员中</span><br><span class="line">    ngx_http_cleanup_t               *cleanup;</span><br><span class="line"></span><br><span class="line">    /* 引用计数。使用subrequest时，依附在该请求上的子请求数目会返回到count上，每增加一个子请求，count计数就会加一，对应任意一个子请求派生的新的子请求，对应的main请求的count都要加一。避免count计数未清零前销毁请求。*/</span><br><span class="line">    unsigned                          count:16;</span><br><span class="line">    unsigned                          subrequests:8;</span><br><span class="line">    // 阻塞标志未，由aio使用</span><br><span class="line">    unsigned                          blocked:8;</span><br><span class="line">    </span><br><span class="line">    // 为1时表示当前请求正在使用异步IO请求</span><br><span class="line">    unsigned                          aio:1;</span><br><span class="line"></span><br><span class="line">    unsigned                          http_state:4;</span><br><span class="line"></span><br><span class="line">    // 标识uri中存在特殊字符</span><br><span class="line">    /* URI with &quot;/.&quot; and on Win32 with &quot;//&quot; */</span><br><span class="line">    unsigned                          complex_uri:1;</span><br><span class="line"></span><br><span class="line">    /* URI with &quot;%&quot; */</span><br><span class="line">    unsigned                          quoted_uri:1;</span><br><span class="line"></span><br><span class="line">    /* URI with &quot;+&quot; */</span><br><span class="line">    unsigned                          plus_in_uri:1;</span><br><span class="line"></span><br><span class="line">    /* URI with &quot; &quot; */</span><br><span class="line">    unsigned                          space_in_uri:1;</span><br><span class="line">    // 是否为无效的请求头</span><br><span class="line">    unsigned                          invalid_header:1;</span><br><span class="line">    </span><br><span class="line">    unsigned                          add_uri_to_alias:1;</span><br><span class="line">    unsigned                          valid_location:1;</span><br><span class="line">    unsigned                          valid_unparsed_uri:1;</span><br><span class="line">    // 为1表示uri发送过uri重写，在NGX_HTTP_POST_REWRITE_PHASE阶段会根据该值来决定是否重新执行rewrite阶段</span><br><span class="line">    unsigned                          uri_changed:1;</span><br><span class="line">    // 该值为uri重写次数，初始化为11，每次发送重写，在NGX_HTTP_POST_REWRITE_PHASE阶段将该值减一，如果减到0，依据需要进行uri重写，则认为配置的rewrite出现循环，报错</span><br><span class="line">    unsigned                          uri_changes:4;</span><br><span class="line">    // 表示请求体存储位置</span><br><span class="line">    // 将主体读取到单个内存缓冲区。 </span><br><span class="line">    unsigned                          request_body_in_single_buf:1;</span><br><span class="line">    // 始终将文本读取到文件中，即使放入内存缓冲区也是如此</span><br><span class="line">    unsigned                          request_body_in_file_only:1;</span><br><span class="line">    //  创建后不要立即取消链接文件。具有此标志的文件可以移动到另一个目录。</span><br><span class="line">    unsigned                          request_body_in_persistent_file:1;</span><br><span class="line">    // 请求完成时取消链接文件。当文件应该移动到另一个目录但由于某种原因未被移动时，这可能很有用。</span><br><span class="line">    unsigned                          request_body_in_clean_file:1;</span><br><span class="line">    // 通过用0660替换默认的0600访问掩码来启用对该文件的组访问。</span><br><span class="line">    unsigned                          request_body_file_group_access:1;</span><br><span class="line">    // - 记录文件错误的严重级别。</span><br><span class="line">    unsigned                          request_body_file_log_level:3;</span><br><span class="line">    // - 无缓冲地读取请求主体。</span><br><span class="line">    unsigned                          request_body_no_buffering:1;</span><br><span class="line"></span><br><span class="line">    unsigned                          subrequest_in_memory:1;</span><br><span class="line">    unsigned                          waited:1;</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_CACHE)</span><br><span class="line">    unsigned                          cached:1;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_GZIP)</span><br><span class="line">    unsigned                          gzip_tested:1;</span><br><span class="line">    unsigned                          gzip_ok:1;</span><br><span class="line">    unsigned                          gzip_vary:1;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    unsigned                          realloc_captures:1;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    unsigned                          proxy:1;</span><br><span class="line">    unsigned                          bypass_cache:1;</span><br><span class="line">    unsigned                          no_cache:1;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * instead of using the request context data in</span><br><span class="line">     * ngx_http_limit_conn_module and ngx_http_limit_req_module</span><br><span class="line">     * we use the bit fields in the request structure</span><br><span class="line">     */</span><br><span class="line">    unsigned                          limit_conn_status:2;</span><br><span class="line">    unsigned                          limit_req_status:3;</span><br><span class="line"></span><br><span class="line">    unsigned                          limit_rate_set:1;</span><br><span class="line">    unsigned                          limit_rate_after_set:1;</span><br><span class="line"></span><br><span class="line">#if 0</span><br><span class="line">    unsigned                          cacheable:1;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    unsigned                          pipeline:1;</span><br><span class="line">    unsigned                          chunked:1;</span><br><span class="line">    unsigned                          header_only:1;</span><br><span class="line">    unsigned                          expect_trailers:1;</span><br><span class="line">    // 请求是否为keepalive请求</span><br><span class="line">    unsigned                          keepalive:1;</span><br><span class="line">    // 延迟关闭标志。例如，在接收完HTTP头部时如果发现包体存在，该标志会设为1，如果放弃包体，则设为0</span><br><span class="line">    unsigned                          lingering_close:1;</span><br><span class="line">    // 放弃包体标识</span><br><span class="line">    unsigned                          discard_body:1;</span><br><span class="line">    unsigned                          reading_body:1;</span><br><span class="line">    // 为1时表示请求的状态是在做内部跳转</span><br><span class="line">    unsigned                          internal:1;</span><br><span class="line">    </span><br><span class="line">    unsigned                          error_page:1;</span><br><span class="line">    // 记录过滤阶段是否出错</span><br><span class="line">    unsigned                          filter_finalize:1;</span><br><span class="line">    unsigned                          post_action:1;</span><br><span class="line">    unsigned                          request_complete:1;</span><br><span class="line">    unsigned                          request_output:1;</span><br><span class="line">    // 为1时表示响应的header已发送</span><br><span class="line">    unsigned                          header_sent:1;</span><br><span class="line">    unsigned                          expect_tested:1;</span><br><span class="line">    unsigned                          root_tested:1;</span><br><span class="line">    unsigned                          done:1;</span><br><span class="line">    unsigned                          logged:1;</span><br><span class="line">    // 缓冲中是否有待发送内容的标志位</span><br><span class="line">    unsigned                          buffered:4;</span><br><span class="line"></span><br><span class="line">    unsigned                          main_filter_need_in_memory:1;</span><br><span class="line">    unsigned                          filter_need_in_memory:1;</span><br><span class="line">    unsigned                          filter_need_temporary:1;</span><br><span class="line">    unsigned                          preserve_body:1;</span><br><span class="line">    unsigned                          allow_ranges:1;</span><br><span class="line">    unsigned                          subrequest_ranges:1;</span><br><span class="line">    unsigned                          single_range:1;</span><br><span class="line">    unsigned                          disable_not_modified:1;</span><br><span class="line">    unsigned                          stat_reading:1;</span><br><span class="line">    unsigned                          stat_writing:1;</span><br><span class="line">    unsigned                          stat_processing:1;</span><br><span class="line"></span><br><span class="line">    unsigned                          background:1;</span><br><span class="line">    unsigned                          health_check:1;</span><br><span class="line"></span><br><span class="line">    /* used to parse HTTP headers */</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                        state;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                        header_hash;</span><br><span class="line">    ngx_uint_t                        lowcase_index;</span><br><span class="line">    u_char                            lowcase_header[NGX_HTTP_LC_HEADER_LEN];</span><br><span class="line"></span><br><span class="line">    u_char                           *header_name_start;</span><br><span class="line">    u_char                           *header_name_end;</span><br><span class="line">    u_char                           *header_start;</span><br><span class="line">    u_char                           *header_end;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * a memory that can be reused after parsing a request line</span><br><span class="line">     * via ngx_http_ephemeral_t</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    u_char                           *uri_start;</span><br><span class="line">    u_char                           *uri_end;</span><br><span class="line">    u_char                           *uri_ext;</span><br><span class="line">    u_char                           *args_start;</span><br><span class="line">    u_char                           *request_start;</span><br><span class="line">    u_char                           *request_end;</span><br><span class="line">    u_char                           *method_end;</span><br><span class="line">    u_char                           *schema_start;</span><br><span class="line">    u_char                           *schema_end;</span><br><span class="line">    u_char                           *host_start;</span><br><span class="line">    u_char                           *host_end;</span><br><span class="line">    u_char                           *port_start;</span><br><span class="line">    u_char                           *port_end;</span><br><span class="line"></span><br><span class="line">    unsigned                          http_minor:16;</span><br><span class="line">    unsigned                          http_major:16;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_event_accept(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">socklen_t</span>          socklen;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>          err;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>         *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         level;</span><br><span class="line">    <span class="keyword">ngx_socket_t</span>       s;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>       *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_sockaddr_t</span>     sa;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c, *lc;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>  *ecf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_ACCEPT4)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ngx_uint_t</span>  use_accept4 = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果超时，则将所有监听事件条件到epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;timedout) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_enable_accept_events((<span class="keyword">ngx_cycle_t</span> *) ngx_cycle) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ev-&gt;timedout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取事件模块相关配置</span></span><br><span class="line">    ecf = ngx_event_get_conf(ngx_cycle-&gt;conf_ctx, ngx_event_core_module);</span><br><span class="line">    <span class="comment">// 获取是否一次尽可能处理所有连接，对应事件配置的multi_accept</span></span><br><span class="line">    <span class="keyword">if</span> (!(ngx_event_flags &amp; NGX_USE_KQUEUE_EVENT)) &#123;</span><br><span class="line">        ev-&gt;available = ecf-&gt;multi_accept;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取事件对应的connnect结构</span></span><br><span class="line">    lc = ev-&gt;data;</span><br><span class="line">    <span class="comment">// 获取listen结构</span></span><br><span class="line">    ls = lc-&gt;listening;</span><br><span class="line">    ev-&gt;ready = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"accept on %V, ready: %d"</span>, &amp;ls-&gt;addr_text, ev-&gt;available);</span><br><span class="line">    <span class="comment">// 遍历该监听地址上的连接</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        socklen = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line"><span class="comment">// accept4相对于accept增加了一个参数，可以设置返回的套接字属性，这里如果使用accept4，则设置返回的套接字为非阻塞</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_ACCEPT4)</span></span><br><span class="line">        <span class="keyword">if</span> (use_accept4) &#123;</span><br><span class="line">            s = accept4(lc-&gt;fd, &amp;sa.sockaddr, &amp;socklen, SOCK_NONBLOCK);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            s = accept(lc-&gt;fd, &amp;sa.sockaddr, &amp;socklen);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        s = accept(lc-&gt;fd, &amp;sa.sockaddr, &amp;socklen);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果未成功获取到套接字</span></span><br><span class="line">        <span class="keyword">if</span> (s == (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取错误码</span></span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line">            <span class="comment">// 如果是重试，则说明accept还未准备好，直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EAGAIN) &#123;</span><br><span class="line">                ngx_log_debug0(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                               <span class="string">"accept() not ready"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置日志等级</span></span><br><span class="line">            level = NGX_LOG_ALERT;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ECONNABORTED) &#123;</span><br><span class="line">                level = NGX_LOG_ERR;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == NGX_EMFILE || err == NGX_ENFILE) &#123;</span><br><span class="line">                level = NGX_LOG_CRIT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_ACCEPT4)</span></span><br><span class="line">            ngx_log_error(level, ev-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          use_accept4 ? <span class="string">"accept4() failed"</span> : <span class="string">"accept() failed"</span>);</span><br><span class="line">            <span class="comment">// 如果不支持accept4</span></span><br><span class="line">            <span class="keyword">if</span> (use_accept4 &amp;&amp; err == NGX_ENOSYS) &#123;</span><br><span class="line">                use_accept4 = <span class="number">0</span>;</span><br><span class="line">                ngx_inherited_nonblocking = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            ngx_log_error(level, ev-&gt;<span class="built_in">log</span>, err, <span class="string">"accept() failed"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 软件导致的abort</span></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ECONNABORTED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_KQUEUE_EVENT) &#123;</span><br><span class="line">                    ev-&gt;available--;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ev-&gt;available) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果进程文件描述符超过最大限制</span></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EMFILE || err == NGX_ENFILE) &#123;</span><br><span class="line">                <span class="comment">// 删除epoll中所有监听的套接字</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_disable_accept_events((<span class="keyword">ngx_cycle_t</span> *) ngx_cycle, <span class="number">1</span>)</span><br><span class="line">                    != NGX_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 使用负载均衡锁</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_use_accept_mutex) &#123;</span><br><span class="line">                    <span class="comment">// 如果获取锁了，则释放</span></span><br><span class="line">                    <span class="keyword">if</span> (ngx_accept_mutex_held) &#123;</span><br><span class="line">                        ngx_shmtx_unlock(&amp;ngx_accept_mutex);</span><br><span class="line">                        ngx_accept_mutex_held = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 设置ngx_accept_disabled为1，表示暂时不再接收连接</span></span><br><span class="line">                    ngx_accept_disabled = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果未使用负载均衡锁，则将事件添加到定时器事件中，这是程序开始时，如果超时，则将监听连接套接字添加到epoll中</span></span><br><span class="line">                    ngx_add_timer(ev, ecf-&gt;accept_mutex_delay);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 未获得正确套接字直接返回</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_accepted, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 根据连接池使用数量来决定ngx_accept_disabled大小，提供负载均衡，详见woker进程处理</span></span><br><span class="line">        ngx_accept_disabled = ngx_cycle-&gt;connection_n / <span class="number">8</span></span><br><span class="line">                              - ngx_cycle-&gt;free_connection_n;</span><br><span class="line">        <span class="comment">// 从空闲连接中获取一个连接</span></span><br><span class="line">        c = ngx_get_connection(s, ev-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="comment">// 如果没有空闲连接池了，则关闭该连接</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              ngx_close_socket_n <span class="string">" failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置连接类型 </span></span><br><span class="line">        c-&gt;type = SOCK_STREAM;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_active, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 根据connection_pool_size配置的大小，设置为连接创建初始大小的内存池</span></span><br><span class="line">        c-&gt;pool = ngx_create_pool(ls-&gt;pool_size, ev-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_close_accepted_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 存储客户端连接信息</span></span><br><span class="line">        <span class="keyword">if</span> (socklen &gt; (<span class="keyword">socklen_t</span>) <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>)) &#123;</span><br><span class="line">            socklen = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c-&gt;sockaddr = ngx_palloc(c-&gt;pool, socklen);</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;sockaddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_close_accepted_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(c-&gt;sockaddr, &amp;sa, socklen);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> = ngx_palloc(c-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_log_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_close_accepted_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* set a blocking mode for iocp and non-blocking mode for others */</span></span><br><span class="line">        <span class="comment">// 如果未使用accept4，则手动设置套接字为非阻塞</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_inherited_nonblocking) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_IOCP_EVENT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_blocking(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_blocking_n <span class="string">" failed"</span>);</span><br><span class="line">                    ngx_close_accepted_connection(c);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(ngx_event_flags &amp; NGX_USE_IOCP_EVENT)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_nonblocking(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_nonblocking_n <span class="string">" failed"</span>);</span><br><span class="line">                    ngx_close_accepted_connection(c);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *<span class="built_in">log</span> = ls-&gt;<span class="built_in">log</span>;</span><br><span class="line">        <span class="comment">// 设置连接对应读写的方法</span></span><br><span class="line">        c-&gt;recv = ngx_recv;</span><br><span class="line">        c-&gt;send = ngx_send;</span><br><span class="line">        c-&gt;recv_chain = ngx_recv_chain;</span><br><span class="line">        c-&gt;send_chain = ngx_send_chain;</span><br><span class="line"></span><br><span class="line">        c-&gt;<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">        c-&gt;pool-&gt;<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">        c-&gt;socklen = socklen;</span><br><span class="line">        c-&gt;listening = ls;</span><br><span class="line">        <span class="comment">// 设置本地监听连接的地址</span></span><br><span class="line">        c-&gt;local_sockaddr = ls-&gt;sockaddr;</span><br><span class="line">        c-&gt;local_socklen = ls-&gt;socklen;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;sockaddr-&gt;sa_family == AF_UNIX) &#123;</span><br><span class="line">            c-&gt;tcp_nopush = NGX_TCP_NOPUSH_DISABLED;</span><br><span class="line">            c-&gt;tcp_nodelay = NGX_TCP_NODELAY_DISABLED;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SOLARIS)</span></span><br><span class="line">            <span class="comment">/* Solaris's sendfilev() supports AF_NCA, AF_INET, and AF_INET6 */</span></span><br><span class="line">            c-&gt;sendfile = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 设置写事件ready</span></span><br><span class="line">        rev = c-&gt;read;</span><br><span class="line">        wev = c-&gt;write;</span><br><span class="line"></span><br><span class="line">        wev-&gt;ready = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_IOCP_EVENT) &#123;</span><br><span class="line">            rev-&gt;ready = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果事件设置了deferred_accept，则表明请求已经到达（listen中设置属性，只有在连接到达才从accept返回，建立连接，完成三次握手不建立连接），则设置读事件已经ready</span></span><br><span class="line">        <span class="keyword">if</span> (ev-&gt;deferred_accept) &#123;</span><br><span class="line">            rev-&gt;ready = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE || NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">            rev-&gt;available = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rev-&gt;<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">        wev-&gt;<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * <span class="doctag">TODO:</span> MT: - ngx_atomic_fetch_add()</span></span><br><span class="line"><span class="comment">         *             or protection by critical section or light mutex</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">TODO:</span> MP: - allocated in a shared memory</span></span><br><span class="line"><span class="comment">         *           - ngx_atomic_fetch_add()</span></span><br><span class="line"><span class="comment">         *             or protection by critical section or light mutex</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 连接计数增加</span></span><br><span class="line">        c-&gt;number = ngx_atomic_fetch_add(ngx_connection_counter, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_handled, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储本地连接地址，将网络地址，转换为字符串形式地址</span></span><br><span class="line">        <span class="keyword">if</span> (ls-&gt;addr_ntop) &#123;</span><br><span class="line">            c-&gt;addr_text.data = ngx_pnalloc(c-&gt;pool, ls-&gt;addr_text_max_len);</span><br><span class="line">            <span class="keyword">if</span> (c-&gt;addr_text.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_close_accepted_connection(c);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            c-&gt;addr_text.len = ngx_sock_ntop(c-&gt;sockaddr, c-&gt;socklen,</span><br><span class="line">                                             c-&gt;addr_text.data,</span><br><span class="line">                                             ls-&gt;addr_text_max_len, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (c-&gt;addr_text.len == <span class="number">0</span>) &#123;</span><br><span class="line">                ngx_close_accepted_connection(c);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">ngx_str_t</span>  addr;</span><br><span class="line">        u_char     text[NGX_SOCKADDR_STRLEN];</span><br><span class="line"></span><br><span class="line">        ngx_debug_accepted_connection(ecf, c);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;log_level &amp; NGX_LOG_DEBUG_EVENT) &#123;</span><br><span class="line">            addr.data = text;</span><br><span class="line">            addr.len = ngx_sock_ntop(c-&gt;sockaddr, c-&gt;socklen, text,</span><br><span class="line">                                     NGX_SOCKADDR_STRLEN, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            ngx_log_debug3(NGX_LOG_DEBUG_EVENT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"*%uA accept: %V fd:%d"</span>, c-&gt;number, &amp;addr, s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// epoll不会处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_add_conn &amp;&amp; (ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_add_conn(c) == NGX_ERROR) &#123;</span><br><span class="line">                ngx_close_accepted_connection(c);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span>-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">log</span>-&gt;handler = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 执行监听套接字的处理函数</span></span><br><span class="line">        ls-&gt;handler(c);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_KQUEUE_EVENT) &#123;</span><br><span class="line">            ev-&gt;available--;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 如果是尽可能多的建立连接，则继续循环处理</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (ev-&gt;available);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据交互"><a href="#数据交互" class="headerlink" title="数据交互"></a>数据交互</h3><p>其中读取和写入函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_recv             ngx_io.recv</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_recv_chain       ngx_io.recv_chain</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_udp_recv         ngx_io.udp_recv</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_send             ngx_io.send</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_send_chain       ngx_io.send_chain</span></span><br></pre></td></tr></table></figure>
<p>其中<code>ngx_io</code>初始化在<code>ngx_epoll_init</code>方法中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_io = ngx_os_io;</span><br></pre></td></tr></table></figure>
<p>其中<code>ngx_os_io</code>定义如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ngx_recv_pt        recv;</span><br><span class="line">    ngx_recv_chain_pt  recv_chain;</span><br><span class="line">    ngx_recv_pt        udp_recv;</span><br><span class="line">    ngx_send_pt        send;</span><br><span class="line">    ngx_send_pt        udp_send;</span><br><span class="line">    ngx_send_chain_pt  udp_send_chain;</span><br><span class="line">    ngx_send_chain_pt  send_chain;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         flags;</span><br><span class="line">&#125; <span class="keyword">ngx_os_io_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_os_io_t</span> ngx_os_io = &#123;</span><br><span class="line">    ngx_unix_recv,</span><br><span class="line">    ngx_readv_chain,</span><br><span class="line">    ngx_udp_unix_recv,</span><br><span class="line">    ngx_unix_send,</span><br><span class="line">    ngx_udp_unix_send,</span><br><span class="line">    ngx_udp_unix_sendmsg_chain,</span><br><span class="line">    ngx_writev_chain,</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="接收数据ngx-unix-recv"><a href="#接收数据ngx-unix-recv" class="headerlink" title="接收数据ngx_unix_recv"></a>接收数据ngx_unix_recv</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// buf为接收数据的起始地址，size为最大长度</span></span><br><span class="line"><span class="keyword">ssize_t</span></span><br><span class="line">ngx_unix_recv(<span class="keyword">ngx_connection_t</span> *c, u_char *buf, <span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>       n;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>     err;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>  *rev;</span><br><span class="line"></span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line"><span class="comment">// 忽略</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">    <span class="comment">/* 事件的available为0表示还未准备好，为1表示为设置了deffered建立连接的事件，为-1表示从epoll中触发的事件，pending_eof表示事件是否终止 */</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) &#123;</span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"recv: eof:%d, avail:%d"</span>,</span><br><span class="line">                       rev-&gt;pending_eof, rev-&gt;available);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rev-&gt;available == <span class="number">0</span> &amp;&amp; !rev-&gt;pending_eof) &#123;</span><br><span class="line">            rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 从套接字中接收数据</span></span><br><span class="line">        n = recv(c-&gt;fd, buf, size, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"recv: fd:%d %z of %uz"</span>, c-&gt;fd, n, size);</span><br><span class="line">        <span class="comment">// 未接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">            rev-&gt;eof = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * on FreeBSD recv() may return 0 on closed socket</span></span><br><span class="line"><span class="comment">             * even if kqueue reported about available data</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_KQUEUE_EVENT) &#123;</span><br><span class="line">                rev-&gt;available = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_FIONREAD)</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (rev-&gt;available &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                rev-&gt;available -= n;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * negative rev-&gt;available means some additional bytes</span></span><br><span class="line"><span class="comment">                 * were received between kernel notification and recv(),</span></span><br><span class="line"><span class="comment">                 * and therefore ev-&gt;ready can be safely reset even for</span></span><br><span class="line"><span class="comment">                 * edge-triggered event methods</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">// 负 rev-&gt;available 意味着在内核通知和 recv() 之间收到了一些额外的字节，因此即使对于边缘触发的事件方法，ev-&gt;ready 也可以安全地重置</span></span><br><span class="line">                <span class="keyword">if</span> (rev-&gt;available &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    rev-&gt;available = <span class="number">0</span>;</span><br><span class="line">                    rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_debug1(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"recv: avail:%d"</span>, rev-&gt;available);</span><br><span class="line">            <span class="comment">// 如果返回的长度和设置的最大长度一致</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n == size) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                *#define ngx_socket_nread(s, n)  ioctl(s, FIONREAD, n)</span></span><br><span class="line"><span class="comment">                *获取缓冲区中字节长度，写到available中</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_socket_nread(c-&gt;fd, &amp;rev-&gt;available) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    n = ngx_connection_error(c, ngx_socket_errno,</span><br><span class="line">                                             ngx_socket_nread_n <span class="string">" failed"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_debug1(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"recv: avail:%d"</span>, rev-&gt;available);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">            <span class="comment">// 使用epoll，读取字节小于最大字节长度，且客户端未关闭连接，返回n</span></span><br><span class="line">            <span class="keyword">if</span> ((ngx_event_flags &amp; NGX_USE_EPOLL_EVENT)</span><br><span class="line">                &amp;&amp; ngx_use_epoll_rdhup)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; size) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!rev-&gt;pending_eof) &#123;</span><br><span class="line">                        rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    rev-&gt;available = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> n;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; size</span><br><span class="line">                &amp;&amp; !(ngx_event_flags &amp; NGX_USE_GREEDY_EVENT))</span><br><span class="line">            &#123;</span><br><span class="line">                rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则设置错误码</span></span><br><span class="line">        err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == NGX_EAGAIN || err == NGX_EINTR) &#123;</span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                           <span class="string">"recv() not ready"</span>);</span><br><span class="line">            n = NGX_AGAIN;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            n = ngx_connection_error(c, err, <span class="string">"recv() failed"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 如果是中断的系统调用，则重试</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (err == NGX_EINTR);</span><br><span class="line"></span><br><span class="line">    rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">        rev-&gt;error = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回读取字节数量</span></span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="连接处理"><a href="#连接处理" class="headerlink" title="连接处理"></a>连接处理</h2><h3 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h3><p>这里大部分数据结构都已经在解析配置中介绍过了，可以查看对应部分。这里还有一个结构为<code>ngx_http_connection_t</code>结构。</p>
<h4 id="ngx-http-connection-t"><a href="#ngx-http-connection-t" class="headerlink" title="ngx_http_connection_t"></a>ngx_http_connection_t</h4><p>定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 监听地址对应的服务信息。接收到请求后，就能知道客户端请求的地址，可以获取到对应的该结构</span><br><span class="line">    ngx_http_addr_conf_t             *addr_conf;</span><br><span class="line">    // 用户请求的服务对应的http配置，在接收到用户请求后，根据用户请求头来判断是在addr_conf中的哪个服务</span><br><span class="line">    ngx_http_conf_ctx_t              *conf_ctx;</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_SSL || NGX_COMPAT)</span><br><span class="line">    ngx_str_t                        *ssl_servername;</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_regex_t                 *ssl_servername_regex;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">    // 使用buf，配合free在请求行或者请求体过大时，按照large_client_header_buffers分配的空间，后续有详细介绍</span><br><span class="line">    ngx_chain_t                      *busy;</span><br><span class="line">    ngx_int_t                         nbusy;</span><br><span class="line">    // 空闲buf</span><br><span class="line">    ngx_chain_t                      *free;</span><br><span class="line">    // 协议标志位</span><br><span class="line">    unsigned                          ssl:1;</span><br><span class="line">    unsigned                          proxy_protocol:1;</span><br><span class="line">&#125; ngx_http_connection_t;</span><br></pre></td></tr></table></figure>
<h3 id="函数方法ngx-http-init-connection"><a href="#函数方法ngx-http-init-connection" class="headerlink" title="函数方法ngx_http_init_connection"></a>函数方法ngx_http_init_connection</h3><p>在建立连接后调用listen结构的handler方法进行处理。handler方法定义在<code>ngx_http_add_listening</code>方法中，具体参考配置解析中的监听端口部分。定义的函数为<code>ngx_http_init_connection</code>。具体方法逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_init_connection(<span class="keyword">ngx_connection_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>              i;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>            *rev;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>     *<span class="title">sin</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_port_t</span>        *port;</span><br><span class="line">    <span class="keyword">ngx_http_in_addr_t</span>     *addr;</span><br><span class="line">    <span class="keyword">ngx_http_log_ctx_t</span>     *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>  *hc;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span>    *<span class="title">sin6</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_in6_addr_t</span>    *addr6;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 构建ngx_http_connection_t</span></span><br><span class="line">    hc = ngx_pcalloc(c-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_connection_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (hc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    c-&gt;data = hc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* find the server configuration for the address:port */</span></span><br><span class="line">    <span class="comment">// 根据客户端请求的ip+port获取对应的ngx_http_in_addr_t</span></span><br><span class="line">    port = c-&gt;listening-&gt;servers;</span><br><span class="line">    <span class="comment">// 由于对于存在通配符形式的监听来说，一个port端口可能监听多个ip，如果port新式的地址存在多个，则需要查看请求的ip来确定ip+port形式的地址</span></span><br><span class="line">    <span class="keyword">if</span> (port-&gt;naddrs &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * there are several addresses on this port and one of them</span></span><br><span class="line"><span class="comment">         * is an "*:port" wildcard so getsockname() in ngx_http_server_addr()</span></span><br><span class="line"><span class="comment">         * is required to determine a server address</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 获取用户实际请求地址</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_connection_local_sockaddr(c, <span class="literal">NULL</span>, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据地址对hc-&gt;addr_conf赋值，即确定实际的请求ip+port</span></span><br><span class="line">        <span class="keyword">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            sin6 = (struct sockaddr_in6 *) c-&gt;local_sockaddr;</span><br><span class="line"></span><br><span class="line">            addr6 = port-&gt;addrs;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* the last address is "*" */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; port-&gt;naddrs - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_memcmp(&amp;addr6[i].addr6, &amp;sin6-&gt;sin6_addr, <span class="number">16</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            hc-&gt;addr_conf = &amp;addr6[i].conf;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            <span class="built_in">sin</span> = (struct sockaddr_in *) c-&gt;local_sockaddr;</span><br><span class="line"></span><br><span class="line">            addr = port-&gt;addrs;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* the last address is "*" */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; port-&gt;naddrs - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (addr[i].addr == <span class="built_in">sin</span>-&gt;sin_addr.s_addr) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            hc-&gt;addr_conf = &amp;addr[i].conf;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果port监听只有一个IP地址，则addr_conf则为对应的ip+port的地址</span></span><br><span class="line">        <span class="keyword">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HAVE_INET6)</span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            addr6 = port-&gt;addrs;</span><br><span class="line">            hc-&gt;addr_conf = &amp;addr6[<span class="number">0</span>].conf;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            addr = port-&gt;addrs;</span><br><span class="line">            hc-&gt;addr_conf = &amp;addr[<span class="number">0</span>].conf;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the default server configuration for the address:port */</span></span><br><span class="line">    <span class="comment">// 由于一个ip+port的地址下可能存在多个服务，这里先使用ip+port的默认服务对conf_ctx赋值，conf_ctx对应服务下的http配置</span></span><br><span class="line">    hc-&gt;conf_ctx = hc-&gt;addr_conf-&gt;default_server-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_palloc(c-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_log_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;connection = c;</span><br><span class="line">    ctx-&gt;request = <span class="literal">NULL</span>;</span><br><span class="line">    ctx-&gt;current_request = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;connection = c-&gt;number;</span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;handler = ngx_http_log_error;</span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;data = ctx;</span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"waiting for request"</span>;</span><br><span class="line"></span><br><span class="line">    c-&gt;log_error = NGX_ERROR_INFO;</span><br><span class="line">    <span class="comment">// 设置对应的读事件，等待请求</span></span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line">    rev-&gt;handler = ngx_http_wait_request_handler;</span><br><span class="line">    <span class="comment">// 写事件为无处理</span></span><br><span class="line">    c-&gt;write-&gt;handler = ngx_http_empty_handler;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">if</span> (hc-&gt;addr_conf-&gt;http2) &#123;</span><br><span class="line">        rev-&gt;handler = ngx_http_v2_init;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">ngx_http_ssl_srv_conf_t</span>  *sscf;</span><br><span class="line"></span><br><span class="line">    sscf = ngx_http_get_module_srv_conf(hc-&gt;conf_ctx, ngx_http_ssl_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sscf-&gt;enable || hc-&gt;addr_conf-&gt;ssl) &#123;</span><br><span class="line">        hc-&gt;ssl = <span class="number">1</span>;</span><br><span class="line">        c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"SSL handshaking"</span>;</span><br><span class="line">        rev-&gt;handler = ngx_http_ssl_handshake;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果IP+port的地址开启了proxy_protocol协议支持</span></span><br><span class="line">    <span class="keyword">if</span> (hc-&gt;addr_conf-&gt;proxy_protocol) &#123;</span><br><span class="line">        hc-&gt;proxy_protocol = <span class="number">1</span>;</span><br><span class="line">        c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading PROXY protocol"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果读事件已经准备完成，则直接执行处理函数，对于设置了deferred的地址来说，会直到用户请求下发才建立连接，此时读事件是已经ready的</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;ready) &#123;</span><br><span class="line">        <span class="comment">/* the deferred accept(), iocp */</span></span><br><span class="line">        <span class="comment">// 如果使用负载均衡锁，则应该加速锁的释放，将事件添加到post队列中</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_use_accept_mutex) &#123;</span><br><span class="line">            ngx_post_event(rev, &amp;ngx_posted_events);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rev-&gt;handler(rev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将事件添加到事件红黑树中，设置超时事件为设置的post_accept_timeout时间，即最大的连接后到请求下发之间的超时时间</span></span><br><span class="line">    ngx_add_timer(rev, c-&gt;listening-&gt;post_accept_timeout);</span><br><span class="line">    <span class="comment">// 设置连接为可复用的</span></span><br><span class="line">    ngx_reusable_connection(c, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 将事件添加进入epoll事件驱动中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取请求地址"><a href="#获取请求地址" class="headerlink" title="获取请求地址"></a>获取请求地址</h4><p>由于对应通配符监听来说，一个监听端口上可能监听了多个ip+port的地址，这时需要获取用户实际请求的ip地址，来获得对应的配置，函数方法为<code>ngx_connection_local_sockaddr</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_connection_local_sockaddr(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_str_t</span> *s,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> port)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">socklen_t</span>             len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            addr;</span><br><span class="line">    <span class="keyword">ngx_sockaddr_t</span>        sa;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>   *<span class="title">sin</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span>  *<span class="title">sin6</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    addr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 存在套接字地址</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;local_socklen) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            sin6 = (struct sockaddr_in6 *) c-&gt;local_sockaddr;</span><br><span class="line">            <span class="comment">// 判断是否为通配符地址，如果不为通配符地址，则addr不为0</span></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; addr == <span class="number">0</span> &amp;&amp; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">                addr |= sin6-&gt;sin6_addr.s6_addr[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">        <span class="keyword">case</span> AF_UNIX:</span><br><span class="line">            addr = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            <span class="built_in">sin</span> = (struct sockaddr_in *) c-&gt;local_sockaddr;</span><br><span class="line">            <span class="comment">// 如果为非通配符地址，则addr不为0</span></span><br><span class="line">            addr = <span class="built_in">sin</span>-&gt;sin_addr.s_addr;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果为通配符地址，则使用getsockname获取用户实际请求的套接字地址</span></span><br><span class="line">    <span class="keyword">if</span> (addr == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        len = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line">        <span class="comment">// 获取用户实际请求的套接字地址</span></span><br><span class="line">        <span class="keyword">if</span> (getsockname(c-&gt;fd, &amp;sa.sockaddr, &amp;len) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_connection_error(c, ngx_socket_errno, <span class="string">"getsockname() failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c-&gt;local_sockaddr = ngx_palloc(c-&gt;pool, len);</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;local_sockaddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(c-&gt;local_sockaddr, &amp;sa, len);</span><br><span class="line"></span><br><span class="line">        c-&gt;local_socklen = len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果需要获取点分十进制形式地址长读，则执行计算。</span></span><br><span class="line">    s-&gt;len = ngx_sock_ntop(c-&gt;local_sockaddr, c-&gt;local_socklen,</span><br><span class="line">                           s-&gt;data, s-&gt;len, port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于套接字地址相关信息，可以查看如下文章：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%AF%BB%E5%9D%80" target="_blank" rel="noopener">套接字地址</a>。</p>
<h2 id="ngx-http-wait-request-handler获取请求"><a href="#ngx-http-wait-request-handler获取请求" class="headerlink" title="ngx_http_wait_request_handler获取请求"></a>ngx_http_wait_request_handler获取请求</h2><h3 id="相关结构"><a href="#相关结构" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-proxy-protocol-s"><a href="#ngx-proxy-protocol-s" class="headerlink" title="ngx_proxy_protocol_s"></a>ngx_proxy_protocol_s</h4><p><code>ngx_proxy_protocol_s</code>结构用于存储<code>proxy_protocol</code>协议的相关信息。proxy protocol是HAProxy的作者Willy Tarreau于2010年开发和设计的一个Internet协议，通过为tcp添加一个很小的头信息，来方便的传递客户端信息（协议栈、源IP、目的IP、源端口、目的端口等)，在网络情况复杂又需要获取用户真实IP时非常有用。其本质是在三次握手结束后由代理在连接中插入了一个携带了原始连接四元组信息的数据包。</p>
<p>proxy protocol的接收端必须在接收到完整有效的 proxy protocol 头部后才能开始处理连接数据。因此对于服务器的同一个监听端口，不存在兼容带proxy protocol包的连接和不带proxy protocol包的连接。如果服务器接收到的第一个数据包不符合proxy protocol的格式，那么服务器会直接终止连接。</p>
<p>传输数据格式为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PROXY TCP4 202.112.144.236 10.210.12.10 5678 80\r\n</span><br><span class="line">PROXY TCP6 2001:da8:205::100 2400:89c0:2110:1::21 6324 80\r\n</span><br><span class="line">PROXY UKNOWN\r\n</span><br></pre></td></tr></table></figure>
<p>存储相应数据的结构为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_proxy_protocol_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>           src_addr;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>           dst_addr;</span><br><span class="line">    <span class="keyword">in_port_t</span>           src_port;</span><br><span class="line">    <span class="keyword">in_port_t</span>           dst_port;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h3><p>指向完成对连接的处理后，将会等待用户下发请求，对应事件处理函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_wait_request_handler(<span class="keyword">ngx_event_t</span> *rev)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                    *p;</span><br><span class="line">    <span class="keyword">size_t</span>                     size;</span><br><span class="line">    <span class="keyword">ssize_t</span>                    n;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>     *hc;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line">    c = rev-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http wait request handler"</span>);</span><br><span class="line">    <span class="comment">// 事件超时，表示事件超时，释放事件及连接</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, NGX_ETIMEDOUT, <span class="string">"client timed out"</span>);</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;close) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取ngx_http_connection_t结构</span></span><br><span class="line">    hc = c-&gt;data;</span><br><span class="line">    <span class="comment">// 获取对应的http核心配置</span></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(hc-&gt;conf_ctx, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 客户端请求头缓存默认大小</span></span><br><span class="line">    size = cscf-&gt;client_header_buffer_size;</span><br><span class="line">    <span class="comment">// 分配buf</span></span><br><span class="line">    b = c-&gt;buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        b = ngx_create_temp_buf(c-&gt;pool, size);</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c-&gt;buffer = b;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b-&gt;start == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        b-&gt;start = ngx_palloc(c-&gt;pool, size);</span><br><span class="line">        <span class="keyword">if</span> (b-&gt;start == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;pos = b-&gt;start;</span><br><span class="line">        b-&gt;last = b-&gt;start;</span><br><span class="line">        b-&gt;end = b-&gt;last + size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 接收用户请求，详见建立连接的介绍</span></span><br><span class="line">    n = c-&gt;recv(c, b-&gt;last, size);</span><br><span class="line">    <span class="comment">// 如果返回为再次请求，则说明客户还未传输请求</span></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_AGAIN) &#123;</span><br><span class="line">        <span class="comment">// 如果事件未被添加进入事件红黑树，则将其添加进红黑树，这里post_accept_timeout对应client_header_timeout配置</span></span><br><span class="line">        <span class="keyword">if</span> (!rev-&gt;timer_set) &#123;</span><br><span class="line">            ngx_add_timer(rev, c-&gt;listening-&gt;post_accept_timeout);</span><br><span class="line">            ngx_reusable_connection(c, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将事件添加到epoll事件驱动中</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We are trying to not hold c-&gt;buffer's memory for an idle connection.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 释放buf空间，减少内存使用，实际用户请求下发后再分配空间</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_pfree(c-&gt;pool, b-&gt;start) == NGX_OK) &#123;</span><br><span class="line">            b-&gt;start = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果接收信息错误，则关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未收到数据，关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client closed connection"</span>);</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算获取到的数据长度</span></span><br><span class="line">    b-&gt;last += n;</span><br><span class="line">    <span class="comment">// 如果连接支持proxy_protocol，则解析proxy_protocol协议传输信息</span></span><br><span class="line">    <span class="keyword">if</span> (hc-&gt;proxy_protocol) &#123;</span><br><span class="line">        hc-&gt;proxy_protocol = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        p = ngx_proxy_protocol_read(c, b-&gt;pos, b-&gt;last);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;pos = p;</span><br><span class="line">        <span class="comment">// 如果只有proxy_protocol协议信息而没有请求，则将读事件添加进入post事件中</span></span><br><span class="line">        <span class="keyword">if</span> (b-&gt;pos == b-&gt;last) &#123;</span><br><span class="line">            c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"waiting for request"</span>;</span><br><span class="line">            b-&gt;pos = b-&gt;start;</span><br><span class="line">            b-&gt;last = b-&gt;start;</span><br><span class="line">            ngx_post_event(rev, &amp;ngx_posted_events);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading client request line"</span>;</span><br><span class="line">    <span class="comment">// 设置连接为不可复用</span></span><br><span class="line">    ngx_reusable_connection(c, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建请求结构</span></span><br><span class="line">    c-&gt;data = ngx_http_create_request(c);</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置读事件为处理请求行，执行处理请求行</span></span><br><span class="line">    rev-&gt;handler = ngx_http_process_request_line;</span><br><span class="line">    ngx_http_process_request_line(rev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建请求结构"><a href="#创建请求结构" class="headerlink" title="创建请求结构"></a>创建请求结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_request_t</span> *</span><br><span class="line">ngx_http_create_request(<span class="keyword">ngx_connection_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>        *r;</span><br><span class="line">    <span class="keyword">ngx_http_log_ctx_t</span>        *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="comment">// 创建请求</span></span><br><span class="line">    r = ngx_http_alloc_request(c);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 连接上请求数量加一</span></span><br><span class="line">    c-&gt;requests++;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 设置日志信息</span></span><br><span class="line">    ngx_set_connection_log(c, clcf-&gt;error_log);</span><br><span class="line"></span><br><span class="line">    ctx = c-&gt;<span class="built_in">log</span>-&gt;data;</span><br><span class="line">    ctx-&gt;request = r;</span><br><span class="line">    ctx-&gt;current_request = r;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">    (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_reading, <span class="number">1</span>);</span><br><span class="line">    r-&gt;stat_reading = <span class="number">1</span>;</span><br><span class="line">    (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_requests, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_request_t</span> *</span><br><span class="line">ngx_http_alloc_request(<span class="keyword">ngx_connection_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>                 *pool;</span><br><span class="line">    <span class="keyword">ngx_time_t</span>                 *tp;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>         *r;</span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>      *hc;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>   *cscf;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    hc = c-&gt;data;</span><br><span class="line">    <span class="comment">// 获取http的核心模块解析结构</span></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(hc-&gt;conf_ctx, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 为请求分配缓存池，对应request_pool_size配置</span></span><br><span class="line">    pool = ngx_create_pool(cscf-&gt;request_pool_size, c-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配缓存池结构内存</span></span><br><span class="line">    r = ngx_pcalloc(pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_request_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;pool = pool;</span><br><span class="line">    <span class="comment">// 设置http_connectio对应hc</span></span><br><span class="line">    r-&gt;http_connection = hc;</span><br><span class="line">    r-&gt;signature = NGX_HTTP_MODULE;</span><br><span class="line">    r-&gt;connection = c;</span><br><span class="line">    <span class="comment">// 初始化配置项，这里只是临时初始化，使用默认的服务，后续接收请求后可能会进行变更</span></span><br><span class="line">    r-&gt;main_conf = hc-&gt;conf_ctx-&gt;main_conf;</span><br><span class="line">    r-&gt;srv_conf = hc-&gt;conf_ctx-&gt;srv_conf;</span><br><span class="line">    r-&gt;loc_conf = hc-&gt;conf_ctx-&gt;loc_conf;</span><br><span class="line">    <span class="comment">// 设置对应的读事假处理方法</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line">    <span class="comment">// 设置请求信息</span></span><br><span class="line">    r-&gt;header_in = hc-&gt;busy ? hc-&gt;busy-&gt;buf : c-&gt;buffer;</span><br><span class="line">    <span class="comment">// 初始化响应结构</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_list_init(&amp;r-&gt;headers_out.headers, r-&gt;pool, <span class="number">20</span>,</span><br><span class="line">                      <span class="keyword">sizeof</span>(<span class="keyword">ngx_table_elt_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(r-&gt;pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化响应结构</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_list_init(&amp;r-&gt;headers_out.trailers, r-&gt;pool, <span class="number">4</span>,</span><br><span class="line">                      <span class="keyword">sizeof</span>(<span class="keyword">ngx_table_elt_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(r-&gt;pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;ctx = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(r-&gt;pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 分配变量存储地址</span></span><br><span class="line">    r-&gt;variables = ngx_pcalloc(r-&gt;pool, cmcf-&gt;variables.nelts</span><br><span class="line">                                        * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_value_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;variables == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(r-&gt;pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;ssl) &#123;</span><br><span class="line">        r-&gt;main_filter_need_in_memory = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 对额外信息进行初始化</span></span><br><span class="line">    r-&gt;main = r;</span><br><span class="line">    r-&gt;count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    tp = ngx_timeofday();</span><br><span class="line">    r-&gt;start_sec = tp-&gt;sec;</span><br><span class="line">    r-&gt;start_msec = tp-&gt;msec;</span><br><span class="line"></span><br><span class="line">    r-&gt;method = NGX_HTTP_UNKNOWN;</span><br><span class="line">    r-&gt;http_version = NGX_HTTP_VERSION_10;</span><br><span class="line"></span><br><span class="line">    r-&gt;headers_in.content_length_n = <span class="number">-1</span>;</span><br><span class="line">    r-&gt;headers_in.keep_alive_n = <span class="number">-1</span>;</span><br><span class="line">    r-&gt;headers_out.content_length_n = <span class="number">-1</span>;</span><br><span class="line">    r-&gt;headers_out.last_modified_time = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;uri_changes = NGX_HTTP_MAX_URI_CHANGES + <span class="number">1</span>;</span><br><span class="line">    r-&gt;subrequests = NGX_HTTP_MAX_SUBREQUESTS + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;http_state = NGX_HTTP_READING_REQUEST_STATE;</span><br><span class="line"></span><br><span class="line">    r-&gt;log_handler = ngx_http_log_error_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理请求行"><a href="#处理请求行" class="headerlink" title="处理请求行"></a>处理请求行</h2><h3 id="相关结构-1"><a href="#相关结构-1" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-http-headers-in-t"><a href="#ngx-http-headers-in-t" class="headerlink" title="ngx_http_headers_in_t"></a>ngx_http_headers_in_t</h4><p><code>ngx_http_headers_in_t</code>结构存储解析后的请求头。定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 存储header的list，所有解析过的HTTP头部都在headers链表中</span></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                        headers;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 每个成员均为RFC2616规范中定义的http头部，实际指向headers链表中的成员，当为NULL时，表示还未解析到对应的头部</span></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *host;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *connection;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *if_modified_since;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *if_unmodified_since;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *if_match;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *if_none_match;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *user_agent;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *referer;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *content_length;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *content_range;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *content_type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *range;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *if_range;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *transfer_encoding;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *te;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *expect;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *upgrade;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_GZIP || NGX_HTTP_HEADERS)</span></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *accept_encoding;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *via;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *authorization;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *keep_alive;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_X_FORWARDED_FOR)</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                       x_forwarded_for;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_REALIP)</span></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *x_real_ip;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_HEADERS)</span></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *accept;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *accept_language;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_DAV)</span></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *depth;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *destination;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *overwrite;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *date;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         user;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         passwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                       cookies;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求行中如果存在host，则存储在server中</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         server;</span><br><span class="line">    <span class="comment">// 根据content_length计算出的HTTP包体大小</span></span><br><span class="line">    <span class="keyword">off_t</span>                             content_length_n;</span><br><span class="line">    <span class="keyword">time_t</span>                            keep_alive_n;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 连接类型</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          connection_type:<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          chunked:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 浏览器类型</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          msie:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          msie6:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          opera:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          gecko:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          chrome:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          safari:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          konqueror:<span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">ngx_http_headers_in_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="执行方法"><a href="#执行方法" class="headerlink" title="执行方法"></a>执行方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_process_request_line(<span class="keyword">ngx_event_t</span> *rev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>              n;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>            rc, rv;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>            host;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>    *c;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>  *r;</span><br><span class="line"></span><br><span class="line">    c = rev-&gt;data;</span><br><span class="line">    r = c-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, rev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http process request line"</span>);</span><br><span class="line">    <span class="comment">// 如果为已超时事件，则关闭请求，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, NGX_ETIMEDOUT, <span class="string">"client timed out"</span>);</span><br><span class="line">        c-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">        ngx_http_close_request(r, NGX_HTTP_REQUEST_TIME_OUT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = NGX_AGAIN;</span><br><span class="line">    <span class="comment">// 由于是数据流，因此要循环读取</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 如果是需要再次读取</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">            <span class="comment">// 执行读取请求头</span></span><br><span class="line">            n = ngx_http_read_request_header(r);</span><br><span class="line">            <span class="comment">// 如果返回是需要重复读取（还未下发请求），或者出现错误，则跳出循环</span></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_AGAIN || n == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对当前已经读取到的内容执行解析</span></span><br><span class="line">        rc = ngx_http_parse_request_line(r, r-&gt;header_in);</span><br><span class="line">        <span class="comment">// 完成解析的处理，即请求已经完全下发，并且解析正常</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            <span class="comment">// 设置请求头部相关信息</span></span><br><span class="line">            <span class="comment">/* the request line has been parsed successfully */</span></span><br><span class="line"></span><br><span class="line">            r-&gt;request_line.len = r-&gt;request_end - r-&gt;request_start;</span><br><span class="line">            r-&gt;request_line.data = r-&gt;request_start;</span><br><span class="line">            r-&gt;request_length = r-&gt;header_in-&gt;pos - r-&gt;request_start;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http request line: \"%V\""</span>, &amp;r-&gt;request_line);</span><br><span class="line"></span><br><span class="line">            r-&gt;method_name.len = r-&gt;method_end - r-&gt;request_start + <span class="number">1</span>;</span><br><span class="line">            r-&gt;method_name.data = r-&gt;request_line.data;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;http_protocol.data) &#123;</span><br><span class="line">                r-&gt;http_protocol.len = r-&gt;request_end - r-&gt;http_protocol.data;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析uri</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_process_request_uri(r) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;schema_end) &#123;</span><br><span class="line">                r-&gt;schema.len = r-&gt;schema_end - r-&gt;schema_start;</span><br><span class="line">                r-&gt;schema.data = r-&gt;schema_start;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析到了请求服务</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;host_end) &#123;</span><br><span class="line"></span><br><span class="line">                host.len = r-&gt;host_end - r-&gt;host_start;</span><br><span class="line">                host.data = r-&gt;host_start;</span><br><span class="line">                <span class="comment">// 规范请求的host名</span></span><br><span class="line">                rc = ngx_http_validate_host(&amp;host, r-&gt;pool, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// host名存在问题</span></span><br><span class="line">                <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"client sent invalid host in request line"</span>);</span><br><span class="line">                    ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">                    ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 根据请求的host获取对应的服务，有可能不是使用host获取到的，而是使用的默认server，详细信息查看ngx_http_set_virtual_server函数 </span></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_set_virtual_server(r, &amp;host) == NGX_ERROR) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果获取正常获取到server块</span></span><br><span class="line">                r-&gt;headers_in.server = host;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果http版本小于10，并且正确获取到了请求的服务，则执行对请求的处理</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;http_version &lt; NGX_HTTP_VERSION_10) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (r-&gt;headers_in.server.len == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; ngx_http_set_virtual_server(r, &amp;r-&gt;headers_in.server)</span><br><span class="line">                       == NGX_ERROR)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_http_process_request(r);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化请求头结构</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_list_init(&amp;r-&gt;headers_in.headers, r-&gt;pool, <span class="number">20</span>,</span><br><span class="line">                              <span class="keyword">sizeof</span>(<span class="keyword">ngx_table_elt_t</span>))</span><br><span class="line">                != NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading client request headers"</span>;</span><br><span class="line">            <span class="comment">// 解析请求头，设置读事件为处理请求头</span></span><br><span class="line">            rev-&gt;handler = ngx_http_process_request_headers;</span><br><span class="line">            ngx_http_process_request_headers(rev);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果返回不为again和ok，则说名存在错误</span></span><br><span class="line">        <span class="keyword">if</span> (rc != NGX_AGAIN) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* there was error while a request line parsing */</span></span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          ngx_http_client_errors[rc - NGX_HTTP_CLIENT_ERROR]);</span><br><span class="line">            <span class="comment">// http版本错误。执行终止请求</span></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_HTTP_PARSE_INVALID_VERSION) &#123;</span><br><span class="line">                ngx_http_finalize_request(r, NGX_HTTP_VERSION_NOT_SUPPORTED);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* NGX_AGAIN: a request line parsing is still incomplete */</span></span><br><span class="line">        <span class="comment">// 如果存储请求的buf已经用完，说明请求的长度过长，需要再分配空间</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;header_in-&gt;pos == r-&gt;header_in-&gt;end) &#123;</span><br><span class="line">            <span class="comment">// 再分配存储请求行的空间</span></span><br><span class="line">            rv = ngx_http_alloc_large_header_buffer(r, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 错误，则关闭请求</span></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_ERROR) &#123;</span><br><span class="line">                ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_DECLINED) &#123;</span><br><span class="line">                r-&gt;request_line.len = r-&gt;header_in-&gt;end - r-&gt;request_start;</span><br><span class="line">                r-&gt;request_line.data = r-&gt;request_start;</span><br><span class="line"></span><br><span class="line">                ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"client sent too long URI"</span>);</span><br><span class="line">                ngx_http_finalize_request(r, NGX_HTTP_REQUEST_URI_TOO_LARGE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行子请求的方法</span></span><br><span class="line">    ngx_http_run_posted_requests(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="关闭请求ngx-http-close-request"><a href="#关闭请求ngx-http-close-request" class="headerlink" title="关闭请求ngx_http_close_request"></a>关闭请求ngx_http_close_request</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_close_request(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line">    <span class="comment">// 获取用户下发的请求</span></span><br><span class="line">    r = r-&gt;main;</span><br><span class="line">    <span class="comment">// 获取请求对应连接</span></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http request count:%d blk:%d"</span>, r-&gt;count, r-&gt;blocked);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (r-&gt;count == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http request count is zero"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将count减小1</span></span><br><span class="line">    r-&gt;count--;</span><br><span class="line">    <span class="comment">// 如果还有count或者阻塞，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;count || r-&gt;blocked) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stream) &#123;</span><br><span class="line">        ngx_http_v2_close_stream(r-&gt;stream, rc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 释放请求</span></span><br><span class="line">    ngx_http_free_request(r, rc);</span><br><span class="line">    ngx_http_close_connection(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>释放关闭请求的逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_free_request(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>                *pool;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">linger</span>              <span class="title">linger</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_cleanup_t</span>        *cln;</span><br><span class="line">    <span class="keyword">ngx_http_log_ctx_t</span>        *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = r-&gt;connection-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http close request"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http request already closed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cln = r-&gt;cleanup;</span><br><span class="line">    r-&gt;cleanup = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 执行所有注册到cleanup上的销毁函数</span></span><br><span class="line">    <span class="keyword">while</span> (cln) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cln-&gt;handler) &#123;</span><br><span class="line">            cln-&gt;handler(cln-&gt;data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cln = cln-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stat_reading) &#123;</span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_reading, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stat_writing) &#123;</span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_writing, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc &gt; <span class="number">0</span> &amp;&amp; (r-&gt;headers_out.status == <span class="number">0</span> || r-&gt;connection-&gt;sent == <span class="number">0</span>)) &#123;</span><br><span class="line">        r-&gt;headers_out.status = rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;logged) &#123;</span><br><span class="line">        <span class="built_in">log</span>-&gt;action = <span class="string">"logging request"</span>;</span><br><span class="line"></span><br><span class="line">        ngx_http_log_request(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;action = <span class="string">"closing request"</span>;</span><br><span class="line">    <span class="comment">// 如果连接超时</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;connection-&gt;timedout) &#123;</span><br><span class="line">        clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">        <span class="comment">// 设置了reset_timedout_connection</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;reset_timedout_connection) &#123;</span><br><span class="line">            linger.l_onoff = <span class="number">1</span>;</span><br><span class="line">            linger.l_linger = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 如果还有为发送报文而套接字关闭时，延迟关闭</span></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(r-&gt;connection-&gt;fd, SOL_SOCKET, SO_LINGER,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;linger, <span class="keyword">sizeof</span>(struct linger)) == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_LINGER) failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the various request strings were allocated from r-&gt;pool */</span></span><br><span class="line">    ctx = <span class="built_in">log</span>-&gt;data;</span><br><span class="line">    ctx-&gt;request = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;request_line.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;connection-&gt;destroyed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Setting r-&gt;pool to NULL will increase probability to catch double close</span></span><br><span class="line"><span class="comment">     * of request since the request object is allocated from its own pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    pool = r-&gt;pool;</span><br><span class="line">    r-&gt;pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="读取请求行ngx-http-read-request-header"><a href="#读取请求行ngx-http-read-request-header" class="headerlink" title="读取请求行ngx_http_read_request_header"></a>读取请求行ngx_http_read_request_header</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span><br><span class="line">ngx_http_read_request_header(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>                    n;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>               *rev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line">    <span class="comment">// 如果header_in中还有未处理完成的字符，则直接返回</span></span><br><span class="line">    n = r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果读取是ready的，则调用事件的读取方法读取</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;ready) &#123;</span><br><span class="line">        n = c-&gt;recv(c, r-&gt;header_in-&gt;last,</span><br><span class="line">                    r-&gt;header_in-&gt;end - r-&gt;header_in-&gt;last);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则，表示还未准备好，需要下次轮询</span></span><br><span class="line">        n = NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果还未准备好</span></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_AGAIN) &#123;</span><br><span class="line">        <span class="comment">// 如果还未在事件红黑树中，则添加进入事件红黑树中，并设置超时时间，对应client_header_timeout配置</span></span><br><span class="line">        <span class="keyword">if</span> (!rev-&gt;timer_set) &#123;</span><br><span class="line">            cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">            ngx_add_timer(rev, cscf-&gt;client_header_timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将事件添加到epoll中</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client prematurely closed connection"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取出错</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span> || n == NGX_ERROR) &#123;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">        c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading client request headers"</span>;</span><br><span class="line">        <span class="comment">// 结束请求</span></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置读取到的位置</span></span><br><span class="line">    r-&gt;header_in-&gt;last += n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解析请求ngx-http-parse-request-line"><a href="#解析请求ngx-http-parse-request-line" class="headerlink" title="解析请求ngx_http_parse_request_line"></a>解析请求ngx_http_parse_request_line</h4><p>解析http请求头需要参考http请求协议查看，可以参考<a href="http://www.yinkuiwang.cn/2019/12/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E6%96%B9%E6%B3%95/#Web%E5%BA%94%E7%94%A8%E4%B8%8EHTTP%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">http协议</a>。</p>
<p>其中nginx支持了scheam url，对于schema url来说，传递的url字段为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">schema://host:port/uri</span><br><span class="line">// explame</span><br><span class="line">http://www.baidu.com:8000/test/index?params=test</span><br></pre></td></tr></table></figure>
<p>这里<code>shema</code>为Schema协议名称，<code>host</code>为地址，<code>port</code>为端口号，后面的为<code>uri</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_parse_request_line(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_buf_t</span> *b)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  c, ch, *p, *m;</span><br><span class="line">    <span class="comment">// 记录解析状态的状态码</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        sw_start = <span class="number">0</span>,</span><br><span class="line">        sw_method,</span><br><span class="line">        sw_spaces_before_uri,</span><br><span class="line">        sw_schema,</span><br><span class="line">        sw_schema_slash,</span><br><span class="line">        sw_schema_slash_slash,</span><br><span class="line">        sw_host_start,</span><br><span class="line">        sw_host,</span><br><span class="line">        sw_host_end,</span><br><span class="line">        sw_host_ip_literal,</span><br><span class="line">        sw_port,</span><br><span class="line">        sw_host_http_09,</span><br><span class="line">        sw_after_slash_in_uri,</span><br><span class="line">        sw_check_uri,</span><br><span class="line">        sw_check_uri_http_09,</span><br><span class="line">        sw_uri,</span><br><span class="line">        sw_http_09,</span><br><span class="line">        sw_http_H,</span><br><span class="line">        sw_http_HT,</span><br><span class="line">        sw_http_HTT,</span><br><span class="line">        sw_http_HTTP,</span><br><span class="line">        sw_first_major_digit,</span><br><span class="line">        sw_major_digit,</span><br><span class="line">        sw_first_minor_digit,</span><br><span class="line">        sw_minor_digit,</span><br><span class="line">        sw_spaces_after_digit,</span><br><span class="line">        sw_almost_done</span><br><span class="line">    &#125; state;</span><br><span class="line"></span><br><span class="line">    state = r-&gt;state;</span><br><span class="line">    <span class="comment">// 遍历recv到的数据</span></span><br><span class="line">    <span class="keyword">for</span> (p = b-&gt;pos; p &lt; b-&gt;last; p++) &#123;</span><br><span class="line">        ch = *p;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* HTTP methods: GET, HEAD, POST */</span></span><br><span class="line">        <span class="comment">// 开始</span></span><br><span class="line">        <span class="keyword">case</span> sw_start:</span><br><span class="line">            <span class="comment">// 设置请求开始</span></span><br><span class="line">            r-&gt;request_start = p;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (ch == CR || ch == LF) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 限制允许出现的字节</span></span><br><span class="line">            <span class="keyword">if</span> ((ch &lt; <span class="string">'A'</span> || ch &gt; <span class="string">'Z'</span>) &amp;&amp; ch != <span class="string">'_'</span> &amp;&amp; ch != <span class="string">'-'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_METHOD;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 转移到获取方法字段</span></span><br><span class="line">            state = sw_method;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> sw_method:</span><br><span class="line">            <span class="comment">// 直到获取到方法字段的结尾才进行处理</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span>) &#123;</span><br><span class="line">                <span class="comment">// 获取结束位置</span></span><br><span class="line">                r-&gt;method_end = p - <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 获取开始位置</span></span><br><span class="line">                m = r-&gt;request_start;</span><br><span class="line">                <span class="comment">// 根据字节匹配是何种方法</span></span><br><span class="line">                <span class="keyword">switch</span> (p - m) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">if</span> (ngx_str3_cmp(m, <span class="string">'G'</span>, <span class="string">'E'</span>, <span class="string">'T'</span>, <span class="string">' '</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_GET;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_str3_cmp(m, <span class="string">'P'</span>, <span class="string">'U'</span>, <span class="string">'T'</span>, <span class="string">' '</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_PUT;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    <span class="keyword">if</span> (m[<span class="number">1</span>] == <span class="string">'O'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ngx_str3Ocmp(m, <span class="string">'P'</span>, <span class="string">'O'</span>, <span class="string">'S'</span>, <span class="string">'T'</span>)) &#123;</span><br><span class="line">                            r-&gt;method = NGX_HTTP_POST;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ngx_str3Ocmp(m, <span class="string">'C'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Y'</span>)) &#123;</span><br><span class="line">                            r-&gt;method = NGX_HTTP_COPY;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ngx_str3Ocmp(m, <span class="string">'M'</span>, <span class="string">'O'</span>, <span class="string">'V'</span>, <span class="string">'E'</span>)) &#123;</span><br><span class="line">                            r-&gt;method = NGX_HTTP_MOVE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ngx_str3Ocmp(m, <span class="string">'L'</span>, <span class="string">'O'</span>, <span class="string">'C'</span>, <span class="string">'K'</span>)) &#123;</span><br><span class="line">                            r-&gt;method = NGX_HTTP_LOCK;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ngx_str4cmp(m, <span class="string">'H'</span>, <span class="string">'E'</span>, <span class="string">'A'</span>, <span class="string">'D'</span>)) &#123;</span><br><span class="line">                            r-&gt;method = NGX_HTTP_HEAD;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    <span class="keyword">if</span> (ngx_str5cmp(m, <span class="string">'M'</span>, <span class="string">'K'</span>, <span class="string">'C'</span>, <span class="string">'O'</span>, <span class="string">'L'</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_MKCOL;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_str5cmp(m, <span class="string">'P'</span>, <span class="string">'A'</span>, <span class="string">'T'</span>, <span class="string">'C'</span>, <span class="string">'H'</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_PATCH;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_str5cmp(m, <span class="string">'T'</span>, <span class="string">'R'</span>, <span class="string">'A'</span>, <span class="string">'C'</span>, <span class="string">'E'</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_TRACE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    <span class="keyword">if</span> (ngx_str6cmp(m, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'L'</span>, <span class="string">'E'</span>, <span class="string">'T'</span>, <span class="string">'E'</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_DELETE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_str6cmp(m, <span class="string">'U'</span>, <span class="string">'N'</span>, <span class="string">'L'</span>, <span class="string">'O'</span>, <span class="string">'C'</span>, <span class="string">'K'</span>)) &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_UNLOCK;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                    <span class="keyword">if</span> (ngx_str7_cmp(m, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'T'</span>, <span class="string">'I'</span>, <span class="string">'O'</span>, <span class="string">'N'</span>, <span class="string">'S'</span>, <span class="string">' '</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_OPTIONS;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                    <span class="keyword">if</span> (ngx_str8cmp(m, <span class="string">'P'</span>, <span class="string">'R'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'F'</span>, <span class="string">'I'</span>, <span class="string">'N'</span>, <span class="string">'D'</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_PROPFIND;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                    <span class="keyword">if</span> (ngx_str9cmp(m,</span><br><span class="line">                            <span class="string">'P'</span>, <span class="string">'R'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'P'</span>, <span class="string">'A'</span>, <span class="string">'T'</span>, <span class="string">'C'</span>, <span class="string">'H'</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        r-&gt;method = NGX_HTTP_PROPPATCH;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 状态变更为uri前的空格</span></span><br><span class="line">                state = sw_spaces_before_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 允许方法名中存在的字</span></span><br><span class="line">            <span class="keyword">if</span> ((ch &lt; <span class="string">'A'</span> || ch &gt; <span class="string">'Z'</span>) &amp;&amp; ch != <span class="string">'_'</span> &amp;&amp; ch != <span class="string">'-'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_METHOD;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* space* before URI */</span></span><br><span class="line">        <span class="comment">// 解析到uri前的空格</span></span><br><span class="line">        <span class="keyword">case</span> sw_spaces_before_uri:</span><br><span class="line">            <span class="comment">// 如果字节是 / 则表示发现了uri，记录开始，并转换状态为找到了uri开始的斜线</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'/'</span>) &#123;</span><br><span class="line">                r-&gt;uri_start = p;</span><br><span class="line">                state = sw_after_slash_in_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果不是斜线，则说明是schame，记录scheam开始的位置，并转换状态为scheam</span></span><br><span class="line">            c = (u_char) (ch | <span class="number">0x20</span>);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="string">'a'</span> &amp;&amp; c &lt;= <span class="string">'z'</span>) &#123;</span><br><span class="line">                r-&gt;schema_start = p;</span><br><span class="line">                state = sw_schema;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断是否存在不允许的字节</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 解析schema</span></span><br><span class="line">        <span class="keyword">case</span> sw_schema:</span><br><span class="line">            <span class="comment">// 限制schema允许出现的字符</span></span><br><span class="line">            c = (u_char) (ch | <span class="number">0x20</span>);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="string">'a'</span> &amp;&amp; c &lt;= <span class="string">'z'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) || ch == <span class="string">'+'</span> || ch == <span class="string">'-'</span> || ch == <span class="string">'.'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 找到:为schema的结束标识，转好到状态为需要找到shema后的斜线</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">':'</span>:</span><br><span class="line">                r-&gt;schema_end = p;</span><br><span class="line">                state = sw_schema_slash;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> sw_schema_slash:</span><br><span class="line">            <span class="comment">// 如果需要斜线，则必须出现斜线，否则错误</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                <span class="comment">// 转移状态为需要第二个斜线</span></span><br><span class="line">                state = sw_schema_slash_slash;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> sw_schema_slash_slash:</span><br><span class="line">            <span class="comment">// 找到第二个斜线，状态转换为主机开始</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                state = sw_host_start;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> sw_host_start:</span><br><span class="line">            <span class="comment">// 主机名的开始位置</span></span><br><span class="line">            r-&gt;host_start = p;</span><br><span class="line">            <span class="comment">// 如果以[开始，则转移到sw_host_ip_literal状态，获取主机IP</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'['</span>) &#123;</span><br><span class="line">                state = sw_host_ip_literal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置状态为获取主机，这里没有break，直接进入下一个</span></span><br><span class="line">            state = sw_host;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* fall through */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> sw_host:</span><br><span class="line">            <span class="comment">// 检查合法的字符，如果是合法字符，则直接跳出switch，否则紧接着检查是否为结束</span></span><br><span class="line">            c = (u_char) (ch | <span class="number">0x20</span>);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="string">'a'</span> &amp;&amp; c &lt;= <span class="string">'z'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) || ch == <span class="string">'.'</span> || ch == <span class="string">'-'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 这里也没有break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* fall through */</span></span><br><span class="line">        <span class="comment">// 如果上面一步未break，则正常应该是host终止了，下面进行检查是否正常</span></span><br><span class="line">        <span class="keyword">case</span> sw_host_end:</span><br><span class="line">            <span class="comment">// 记录终止</span></span><br><span class="line">            r-&gt;host_end = p;</span><br><span class="line">       </span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 如果是:,则是正常终止了，后面为端口号</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">':'</span>:</span><br><span class="line">                state = sw_port;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是/，也是正常终止了，后面为uri</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                r-&gt;uri_start = p;</span><br><span class="line">                state = sw_after_slash_in_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是空格，则说明uri为空，使用/作为uri，转换为检查http版本</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * use single "/" from request line to preserve pointers,</span></span><br><span class="line"><span class="comment">                 * if request line will be copied to large client buffer</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                r-&gt;uri_start = r-&gt;schema_end + <span class="number">1</span>;</span><br><span class="line">                r-&gt;uri_end = r-&gt;schema_end + <span class="number">2</span>;</span><br><span class="line">                state = sw_host_http_09;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 只允许上述三种字符</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 如果是ip形式host</span></span><br><span class="line">        <span class="keyword">case</span> sw_host_ip_literal:</span><br><span class="line">            <span class="comment">// 允许出现的字符，如果是允许出现的字符，则直接跳过</span></span><br><span class="line">            <span class="keyword">if</span> (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            c = (u_char) (ch | <span class="number">0x20</span>);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="string">'a'</span> &amp;&amp; c &lt;= <span class="string">'z'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">':'</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是]则表示主机结尾了，否则，对于break的字符，均为允许的字符</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">']'</span>:</span><br><span class="line">                state = sw_host_end;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'.'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'_'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'~'</span>:</span><br><span class="line">                <span class="comment">/* unreserved */</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'!'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'$'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&amp;'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'('</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">')'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">','</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">';'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'='</span>:</span><br><span class="line">                <span class="comment">/* sub-delims */</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 解析端口</span></span><br><span class="line">        <span class="keyword">case</span> sw_port:</span><br><span class="line">            <span class="comment">// 合法的端口字符</span></span><br><span class="line">            <span class="keyword">if</span> (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 不是合法的字符，则验证是否是端口后结束了</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 端口好结束，记录，开始解析uri</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                r-&gt;port_end = p;</span><br><span class="line">                r-&gt;uri_start = p;</span><br><span class="line">                state = sw_after_slash_in_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 空格表示uri为空</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                r-&gt;port_end = p;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * use single "/" from request line to preserve pointers,</span></span><br><span class="line"><span class="comment">                 * if request line will be copied to large client buffer</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                r-&gt;uri_start = r-&gt;schema_end + <span class="number">1</span>;</span><br><span class="line">                r-&gt;uri_end = r-&gt;schema_end + <span class="number">2</span>;</span><br><span class="line">                state = sw_host_http_09;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* space+ after "http://host[:port] " */</span></span><br><span class="line">        <span class="comment">// 解析http版本</span></span><br><span class="line">        <span class="keyword">case</span> sw_host_http_09:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="comment">// 找到定一个H，转换状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'H'</span>:</span><br><span class="line">                r-&gt;http_protocol.data = p;</span><br><span class="line">                state = sw_http_H;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check "/.", "//", "%", and "\" (Win32) in URI */</span></span><br><span class="line">        <span class="keyword">case</span> sw_after_slash_in_uri:</span><br><span class="line">            <span class="comment">// 合法字符</span></span><br><span class="line">            <span class="keyword">if</span> (usual[ch &gt;&gt; <span class="number">5</span>] &amp; (<span class="number">1U</span> &lt;&lt; (ch &amp; <span class="number">0x1f</span>))) &#123;</span><br><span class="line">                state = sw_check_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// uri结束，uri为/</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                state = sw_check_uri_http_09;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="comment">// 如果为/.，记录为复杂uri，转移状态待解析uri</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'.'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果为/%，记录为引用uri，转移状态待解析uri  </span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'%'</span>:</span><br><span class="line">                r-&gt;quoted_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果为//，记录为引用uri，转移状态待解析uri  </span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 如果是/?则后面是参数</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">                r-&gt;args_start = p + <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是/#，是复杂uri</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 是/+，表示为对应uri</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">                r-&gt;plus_in_uri = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">// 否则转移到检查uri</span></span><br><span class="line">                state = sw_check_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check "/", "%" and "\" (Win32) in URI */</span></span><br><span class="line">        <span class="keyword">case</span> sw_check_uri:</span><br><span class="line">            <span class="comment">// 合法字符</span></span><br><span class="line">            <span class="keyword">if</span> (usual[ch &gt;&gt; <span class="number">5</span>] &amp; (<span class="number">1U</span> &lt;&lt; (ch &amp; <span class="number">0x1f</span>))) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 与上面一致，进行处理，对于特殊字符</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">                <span class="keyword">if</span> (r-&gt;uri_ext == p) &#123;</span><br><span class="line">                    r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                    state = sw_uri;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>          </span></span><br><span class="line">                <span class="comment">// 记录扩展uri的起始位置置空</span></span><br><span class="line">                r-&gt;uri_ext = <span class="literal">NULL</span>;</span><br><span class="line">                state = sw_after_slash_in_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 记录扩展uri的起始位置</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'.'</span>:</span><br><span class="line">                r-&gt;uri_ext = p + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 解析uri结束</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                state = sw_check_uri_http_09;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// http9，头结束</span></span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_after_slash_in_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'%'</span>:</span><br><span class="line">                r-&gt;quoted_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">                r-&gt;args_start = p + <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">                r-&gt;plus_in_uri = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* space+ after URI */</span></span><br><span class="line">        <span class="keyword">case</span> sw_check_uri_http_09:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// http9没有后面的版本号</span></span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'H'</span>:</span><br><span class="line">                r-&gt;http_protocol.data = p;</span><br><span class="line">                state = sw_http_H;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                r-&gt;space_in_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_check_uri;</span><br><span class="line">                p--;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* URI */</span></span><br><span class="line">        <span class="comment">// 解析uri</span></span><br><span class="line">        <span class="keyword">case</span> sw_uri:</span><br><span class="line">            <span class="comment">// 合法字符且无特殊含义的字符</span></span><br><span class="line">            <span class="keyword">if</span> (usual[ch &gt;&gt; <span class="number">5</span>] &amp; (<span class="number">1U</span> &lt;&lt; (ch &amp; <span class="number">0x1f</span>))) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 结束，且http版本大于09</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                state = sw_http_09;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 结束</span></span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 完成解析</span></span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;uri_end = p;</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">                r-&gt;complex_uri = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* space+ after URI */</span></span><br><span class="line">        <span class="keyword">case</span> sw_http_09:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'H'</span>:</span><br><span class="line">                r-&gt;http_protocol.data = p;</span><br><span class="line">                state = sw_http_H;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                r-&gt;space_in_uri = <span class="number">1</span>;</span><br><span class="line">                state = sw_uri;</span><br><span class="line">                p--;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 找了http版本的H了</span></span><br><span class="line">        <span class="keyword">case</span> sw_http_H:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'T'</span>:</span><br><span class="line">                state = sw_http_HT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 找了http版本的HT了</span></span><br><span class="line">        <span class="keyword">case</span> sw_http_HT:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'T'</span>:</span><br><span class="line">                state = sw_http_HTT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 找了http版本的HTT了</span></span><br><span class="line">        <span class="keyword">case</span> sw_http_HTT:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'P'</span>:</span><br><span class="line">                state = sw_http_HTTP;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 找了http版本的HTTP了</span></span><br><span class="line">        <span class="keyword">case</span> sw_http_HTTP:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                state = sw_first_major_digit;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* first digit of major HTTP version */</span></span><br><span class="line">        <span class="keyword">case</span> sw_first_major_digit:</span><br><span class="line">            <span class="keyword">if</span> (ch &lt; <span class="string">'1'</span> || ch &gt; <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// http主版本</span></span><br><span class="line">            r-&gt;http_major = ch - <span class="string">'0'</span>;</span><br><span class="line">            <span class="comment">// 只支持0.*和1.*的http</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;http_major &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_VERSION;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 等待点</span></span><br><span class="line">            state = sw_major_digit;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* major HTTP version or dot */</span></span><br><span class="line">        <span class="keyword">case</span> sw_major_digit:</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'.'</span>) &#123;</span><br><span class="line">                state = sw_first_minor_digit;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch &lt; <span class="string">'0'</span> || ch &gt; <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">              </span><br><span class="line">            r-&gt;http_major = r-&gt;http_major * <span class="number">10</span> + (ch - <span class="string">'0'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;http_major &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_VERSION;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* first digit of minor HTTP version */</span></span><br><span class="line">        <span class="keyword">case</span> sw_first_minor_digit:</span><br><span class="line">            <span class="keyword">if</span> (ch &lt; <span class="string">'0'</span> || ch &gt; <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// http副版本号</span></span><br><span class="line">            r-&gt;http_minor = ch - <span class="string">'0'</span>;</span><br><span class="line">            state = sw_minor_digit;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* minor HTTP version or end of request line */</span></span><br><span class="line">        <span class="keyword">case</span> sw_minor_digit:</span><br><span class="line">            <span class="keyword">if</span> (ch == CR) &#123;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == LF) &#123;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span>) &#123;</span><br><span class="line">                state = sw_spaces_after_digit;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch &lt; <span class="string">'0'</span> || ch &gt; <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;http_minor &gt; <span class="number">99</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r-&gt;http_minor = r-&gt;http_minor * <span class="number">10</span> + (ch - <span class="string">'0'</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> sw_spaces_after_digit:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* end of request line */</span></span><br><span class="line">        <span class="keyword">case</span> sw_almost_done:</span><br><span class="line">            r-&gt;request_end = p - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b-&gt;pos = p;</span><br><span class="line">    r-&gt;state = state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 完成请求行解析</span></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    b-&gt;pos = p + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;request_end == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        r-&gt;request_end = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算版本号</span></span><br><span class="line">    r-&gt;http_version = r-&gt;http_major * <span class="number">1000</span> + r-&gt;http_minor;</span><br><span class="line">    r-&gt;state = sw_start;</span><br><span class="line">    <span class="comment">// 版本如果为9，则只允许get请求</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;http_version == <span class="number">9</span> &amp;&amp; r-&gt;method != NGX_HTTP_GET) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_09_METHOD;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解析uri-ngx-http-process-request-uri"><a href="#解析uri-ngx-http-process-request-uri" class="headerlink" title="解析uri ngx_http_process_request_uri"></a>解析uri ngx_http_process_request_uri</h4><p>解析uri主要是拆分参数和前面的uri，并对复杂uri进行处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">ngx_int_t</span><br><span class="line">ngx_http_process_request_uri(ngx_http_request_t *r)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_core_srv_conf_t  *cscf;</span><br><span class="line">    // 是否有参数</span><br><span class="line">    if (r-&gt;args_start) &#123;</span><br><span class="line">        r-&gt;uri.len = r-&gt;args_start - 1 - r-&gt;uri_start;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        r-&gt;uri.len = r-&gt;uri_end - r-&gt;uri_start;</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果为复杂uri，则执行相应操作</span><br><span class="line">    if (r-&gt;complex_uri || r-&gt;quoted_uri) &#123;</span><br><span class="line"></span><br><span class="line">        r-&gt;uri.data = ngx_pnalloc(r-&gt;pool, r-&gt;uri.len + 1);</span><br><span class="line">        if (r-&gt;uri.data == NULL) &#123;</span><br><span class="line">            ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">        // cscf-&gt;merge_slashes对应配置merge_slashes，默认为on，表示开启或者关闭将请求URI中相邻两个或更多斜线合并成一个的功能。</span><br><span class="line">        if (ngx_http_parse_complex_uri(r, cscf-&gt;merge_slashes) != NGX_OK) &#123;</span><br><span class="line">            r-&gt;uri.len = 0;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                          &quot;client sent invalid request&quot;);</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        r-&gt;uri.data = r-&gt;uri_start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;unparsed_uri.len = r-&gt;uri_end - r-&gt;uri_start;</span><br><span class="line">    r-&gt;unparsed_uri.data = r-&gt;uri_start;</span><br><span class="line"></span><br><span class="line">    r-&gt;valid_unparsed_uri = r-&gt;space_in_uri ? 0 : 1;</span><br><span class="line"></span><br><span class="line">    if (r-&gt;uri_ext) &#123;</span><br><span class="line">        if (r-&gt;args_start) &#123;</span><br><span class="line">            r-&gt;exten.len = r-&gt;args_start - 1 - r-&gt;uri_ext;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            r-&gt;exten.len = r-&gt;uri_end - r-&gt;uri_ext;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;exten.data = r-&gt;uri_ext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (r-&gt;args_start &amp;&amp; r-&gt;uri_end &gt; r-&gt;args_start) &#123;</span><br><span class="line">        r-&gt;args.len = r-&gt;uri_end - r-&gt;args_start;</span><br><span class="line">        r-&gt;args.data = r-&gt;args_start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_WIN32)</span><br><span class="line">    ...</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                   &quot;http uri: \&quot;%V\&quot;&quot;, &amp;r-&gt;uri);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                   &quot;http args: \&quot;%V\&quot;&quot;, &amp;r-&gt;args);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                   &quot;http exten: \&quot;%V\&quot;&quot;, &amp;r-&gt;exten);</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取请求的服务-ngx-http-set-virtual-server"><a href="#获取请求的服务-ngx-http-set-virtual-server" class="headerlink" title="获取请求的服务 ngx_http_set_virtual_server"></a>获取请求的服务 ngx_http_set_virtual_server</h4><p>通过host获取对应的服务：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_set_virtual_server(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_str_t</span> *host)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>     *hc;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">    cscf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    hc = r-&gt;http_connection;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME)</span></span><br><span class="line"></span><br><span class="line">    ...忽略</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 查找对应的服务</span></span><br><span class="line">    rc = ngx_http_find_virtual_server(r-&gt;connection,</span><br><span class="line">                                      hc-&gt;addr_conf-&gt;virtual_names,</span><br><span class="line">                                      host, r, &amp;cscf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME)</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置对应的srv和loc层级的配置，使用server层级的解析配置进行赋值，在确定location快后，使用location层级重新赋值</span></span><br><span class="line">    r-&gt;srv_conf = cscf-&gt;ctx-&gt;srv_conf;</span><br><span class="line">    r-&gt;loc_conf = cscf-&gt;ctx-&gt;loc_conf;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 设置对应服务的log</span></span><br><span class="line">    ngx_set_connection_log(r-&gt;connection, clcf-&gt;error_log);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据hostname查找服务的方式如下，参考解析配置相应部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_find_virtual_server(<span class="keyword">ngx_connection_t</span> *c,</span><br><span class="line">    <span class="keyword">ngx_http_virtual_names_t</span> *virtual_names, <span class="keyword">ngx_str_t</span> *host,</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_core_srv_conf_t</span> **cscfp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (virtual_names == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在hash的联合结构中查找，参考常用结构中hash部分的介绍。这里name只包含前置通配符，后置通配符和标志名</span></span><br><span class="line">    cscf = ngx_hash_find_combined(&amp;virtual_names-&gt;names,</span><br><span class="line">                                  ngx_hash_key(host-&gt;data, host-&gt;len),</span><br><span class="line">                                  host-&gt;data, host-&gt;len);</span><br><span class="line">    <span class="comment">// 如果查找到，则设置并返回</span></span><br><span class="line">    <span class="keyword">if</span> (cscf) &#123;</span><br><span class="line">        *cscfp = cscf;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">// 如果配置支持正则表达式，则遍历正则表达式查找对应服务</span></span><br><span class="line">    <span class="keyword">if</span> (host-&gt;len &amp;&amp; virtual_names-&gt;nregex) &#123;</span><br><span class="line">        <span class="keyword">ngx_int_t</span>                n;</span><br><span class="line">        <span class="keyword">ngx_uint_t</span>               i;</span><br><span class="line">        <span class="keyword">ngx_http_server_name_t</span>  *sn;</span><br><span class="line"></span><br><span class="line">        sn = virtual_names-&gt;regex;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME)</span></span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; virtual_names-&gt;nregex; i++) &#123;</span><br><span class="line"></span><br><span class="line">            n = ngx_http_regex_exec(r, sn[i].regex, host);</span><br><span class="line">            <span class="comment">// 不匹配，则继续查找</span></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_DECLINED) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 查找到则返回</span></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_OK) &#123;</span><br><span class="line">                *cscfp = sn[i].server;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则返回error</span></span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NGX_PCRE */</span></span></span><br><span class="line">    <span class="comment">// 返回未找到</span></span><br><span class="line">    <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="执行子请求方法ngx-http-run-posted-requests"><a href="#执行子请求方法ngx-http-run-posted-requests" class="headerlink" title="执行子请求方法ngx_http_run_posted_requests"></a>执行子请求方法ngx_http_run_posted_requests</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_run_posted_requests(<span class="keyword">ngx_connection_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>         *r;</span><br><span class="line">    <span class="keyword">ngx_http_posted_request_t</span>  *pr;</span><br><span class="line">    <span class="comment">// 遍历每个主请求的子请求，执行对应的write_event_handler处理方法</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;destroyed) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r = c-&gt;data;</span><br><span class="line">        pr = r-&gt;main-&gt;posted_requests;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        r-&gt;main-&gt;posted_requests = pr-&gt;next;</span><br><span class="line"></span><br><span class="line">        r = pr-&gt;request;</span><br><span class="line"></span><br><span class="line">        ngx_http_set_log_request(c-&gt;<span class="built_in">log</span>, r);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http posted request: \"%V?%V\""</span>, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line"></span><br><span class="line">        r-&gt;write_event_handler(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分配大请求内存ngx-http-alloc-large-header-buffer"><a href="#分配大请求内存ngx-http-alloc-large-header-buffer" class="headerlink" title="分配大请求内存ngx_http_alloc_large_header_buffer"></a>分配大请求内存ngx_http_alloc_large_header_buffer</h4><p>当原本申请的存储请求头的空间不够时，将调用该函数获取更大的空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_alloc_large_header_buffer(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> request_line)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                    *old, *<span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>               *cl;</span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>     *hc;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http alloc large header buffer"</span>);</span><br><span class="line">    <span class="comment">// 如果是请求行，并且state为0，即完成了解析，则直接返回，并设置buf全部可复用</span></span><br><span class="line">    <span class="keyword">if</span> (request_line &amp;&amp; r-&gt;state == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the client fills up the buffer with "\r\n" */</span></span><br><span class="line"></span><br><span class="line">        r-&gt;header_in-&gt;pos = r-&gt;header_in-&gt;start;</span><br><span class="line">        r-&gt;header_in-&gt;last = r-&gt;header_in-&gt;start;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取对应解析的内容，是请求行或者请求头</span></span><br><span class="line">    old = request_line ? r-&gt;request_start : r-&gt;header_name_start;</span><br><span class="line"></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果没有完成解析，并且对应的buf大小超过了设置的large_client_header_buffers的size，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;state != <span class="number">0</span></span><br><span class="line">        &amp;&amp; (<span class="keyword">size_t</span>) (r-&gt;header_in-&gt;pos - old)</span><br><span class="line">                                     &gt;= cscf-&gt;large_client_header_buffers.size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hc = r-&gt;http_connection;</span><br><span class="line">    <span class="comment">// 如果free还有未使用的buf</span></span><br><span class="line">    <span class="keyword">if</span> (hc-&gt;<span class="built_in">free</span>) &#123;</span><br><span class="line">        cl = hc-&gt;<span class="built_in">free</span>;</span><br><span class="line">        <span class="comment">// 将free向后移动一个</span></span><br><span class="line">        hc-&gt;<span class="built_in">free</span> = cl-&gt;next;</span><br><span class="line">        <span class="comment">// 设置buf为新的还未使用的buf</span></span><br><span class="line">        b = cl-&gt;buf;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http large header free: %p %uz"</span>,</span><br><span class="line">                       b-&gt;pos, b-&gt;end - b-&gt;last);</span><br><span class="line">    <span class="comment">// 如果创建的buf数量小于配置的限制</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hc-&gt;nbusy &lt; cscf-&gt;large_client_header_buffers.num) &#123;</span><br><span class="line">        <span class="comment">// 创建一个buf</span></span><br><span class="line">        b = ngx_create_temp_buf(r-&gt;connection-&gt;pool,</span><br><span class="line">                                cscf-&gt;large_client_header_buffers.size);</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个ngx_chain_t</span></span><br><span class="line">        cl = ngx_alloc_chain_link(r-&gt;connection-&gt;pool);</span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置对应的buf为刚才申请的buf</span></span><br><span class="line">        cl-&gt;buf = b;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http large header alloc: %p %uz"</span>,</span><br><span class="line">                       b-&gt;pos, b-&gt;end - b-&gt;last);</span><br><span class="line">    <span class="comment">// 如果超过限制，直接返回</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置ngx_chain_t的next</span></span><br><span class="line">    cl-&gt;next = hc-&gt;busy;</span><br><span class="line">    hc-&gt;busy = cl;</span><br><span class="line">    <span class="comment">// 设置使用buf数量</span></span><br><span class="line">    hc-&gt;nbusy++;</span><br><span class="line">    <span class="comment">// 如果state为0（这里只能是请求头，如果是请求行已经返回），说明一行请求头已经解析完成，不需要拷贝残缺的信息到新的空间上，因此直接返回即可</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;state == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * r-&gt;state == 0 means that a header line was parsed successfully</span></span><br><span class="line"><span class="comment">         * and we do not need to copy incomplete header line and</span></span><br><span class="line"><span class="comment">         * to relocate the parser header pointers</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        r-&gt;header_in = b;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http large header copy: %uz"</span>, r-&gt;header_in-&gt;pos - old);</span><br><span class="line">    <span class="comment">// 如果之前的残缺的请求长度大于新申请的buf的长度，则说明配置存在错误，或者请求过长，直接返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_in-&gt;pos - old &gt; b-&gt;end - b-&gt;start) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"too large header to copy"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> = b-&gt;start;</span><br><span class="line">    <span class="comment">// 将残缺的请求拷贝到新的buf中</span></span><br><span class="line">    ngx_memcpy(<span class="keyword">new</span>, old, r-&gt;header_in-&gt;pos - old);</span><br><span class="line">    <span class="comment">// 设置pos和last的位置</span></span><br><span class="line">    b-&gt;pos = <span class="keyword">new</span> + (r-&gt;header_in-&gt;pos - old);</span><br><span class="line">    b-&gt;last = <span class="keyword">new</span> + (r-&gt;header_in-&gt;pos - old);</span><br><span class="line">    <span class="comment">// 如果是请求行，则需要把已经解析出的部分，使用新的地址对其赋值</span></span><br><span class="line">    <span class="keyword">if</span> (request_line) &#123;</span><br><span class="line">        r-&gt;request_start = <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;request_end) &#123;</span><br><span class="line">            r-&gt;request_end = <span class="keyword">new</span> + (r-&gt;request_end - old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;method_end = <span class="keyword">new</span> + (r-&gt;method_end - old);</span><br><span class="line"></span><br><span class="line">        r-&gt;uri_start = <span class="keyword">new</span> + (r-&gt;uri_start - old);</span><br><span class="line">        r-&gt;uri_end = <span class="keyword">new</span> + (r-&gt;uri_end - old);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;schema_start) &#123;</span><br><span class="line">            r-&gt;schema_start = <span class="keyword">new</span> + (r-&gt;schema_start - old);</span><br><span class="line">            r-&gt;schema_end = <span class="keyword">new</span> + (r-&gt;schema_end - old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;host_start) &#123;</span><br><span class="line">            r-&gt;host_start = <span class="keyword">new</span> + (r-&gt;host_start - old);</span><br><span class="line">            <span class="keyword">if</span> (r-&gt;host_end) &#123;</span><br><span class="line">                r-&gt;host_end = <span class="keyword">new</span> + (r-&gt;host_end - old);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;port_start) &#123;</span><br><span class="line">            r-&gt;port_start = <span class="keyword">new</span> + (r-&gt;port_start - old);</span><br><span class="line">            r-&gt;port_end = <span class="keyword">new</span> + (r-&gt;port_end - old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;uri_ext) &#123;</span><br><span class="line">            r-&gt;uri_ext = <span class="keyword">new</span> + (r-&gt;uri_ext - old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;args_start) &#123;</span><br><span class="line">            r-&gt;args_start = <span class="keyword">new</span> + (r-&gt;args_start - old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;http_protocol.data) &#123;</span><br><span class="line">            r-&gt;http_protocol.data = <span class="keyword">new</span> + (r-&gt;http_protocol.data - old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r-&gt;header_name_start = <span class="keyword">new</span>;</span><br><span class="line">        r-&gt;header_name_end = <span class="keyword">new</span> + (r-&gt;header_name_end - old);</span><br><span class="line">        r-&gt;header_start = <span class="keyword">new</span> + (r-&gt;header_start - old);</span><br><span class="line">        r-&gt;header_end = <span class="keyword">new</span> + (r-&gt;header_end - old);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置新的存储接收信息的buf</span></span><br><span class="line">    r-&gt;header_in = b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理请求头ngx-http-process-request-headers"><a href="#处理请求头ngx-http-process-request-headers" class="headerlink" title="处理请求头ngx_http_process_request_headers"></a>处理请求头ngx_http_process_request_headers</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_process_request_headers(<span class="keyword">ngx_event_t</span> *rev)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                     *p;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ssize_t</span>                     n;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc, rv;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>            *h;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>           *c;</span><br><span class="line">    <span class="keyword">ngx_http_header_t</span>          *hh;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>         *r;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>   *cscf;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    c = rev-&gt;data;</span><br><span class="line">    r = c-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, rev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http process request header line"</span>);</span><br><span class="line">    <span class="comment">// 如果为超时事件，则关闭请求</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, NGX_ETIMEDOUT, <span class="string">"client timed out"</span>);</span><br><span class="line">        c-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">        ngx_http_close_request(r, NGX_HTTP_REQUEST_TIME_OUT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取核心配置</span></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    rc = NGX_AGAIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 接收并解析用户请求</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">            <span class="comment">// 如果buf已经使用完成，且还未完成解析，则需要再分配大空间的buf</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;header_in-&gt;pos == r-&gt;header_in-&gt;end) &#123;</span><br><span class="line"></span><br><span class="line">                rv = ngx_http_alloc_large_header_buffer(r, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rv == NGX_ERROR) &#123;</span><br><span class="line">                    ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果空间超限，报错</span></span><br><span class="line">                <span class="keyword">if</span> (rv == NGX_DECLINED) &#123;</span><br><span class="line">                    p = r-&gt;header_name_start;</span><br><span class="line"></span><br><span class="line">                    r-&gt;lingering_close = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                      <span class="string">"client sent too large request"</span>);</span><br><span class="line">                        ngx_http_finalize_request(r,</span><br><span class="line">                                            NGX_HTTP_REQUEST_HEADER_TOO_LARGE);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    len = r-&gt;header_in-&gt;end - p;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (len &gt; NGX_MAX_ERROR_STR - <span class="number">300</span>) &#123;</span><br><span class="line">                        len = NGX_MAX_ERROR_STR - <span class="number">300</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                <span class="string">"client sent too long header line: \"%*s...\""</span>,</span><br><span class="line">                                len, r-&gt;header_name_start);</span><br><span class="line"></span><br><span class="line">                    ngx_http_finalize_request(r,</span><br><span class="line">                                            NGX_HTTP_REQUEST_HEADER_TOO_LARGE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取请求头</span></span><br><span class="line">            n = ngx_http_read_request_header(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_AGAIN || n == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the host header could change the server configuration context */</span></span><br><span class="line">        cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">        <span class="comment">// 解析请求头，其中underscores_in_headers对应配置allow_underscores是否允许key中存在下划线，这里每次只解析一行</span></span><br><span class="line">        rc = ngx_http_parse_header_line(r, r-&gt;header_in,</span><br><span class="line">                                        cscf-&gt;underscores_in_headers);</span><br><span class="line">        <span class="comment">// 解析正确</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            <span class="comment">// 计算请求长度</span></span><br><span class="line">            r-&gt;request_length += r-&gt;header_in-&gt;pos - r-&gt;header_name_start;</span><br><span class="line">            <span class="comment">// 如果是无效的头部或者可忽略的头部，则记录</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;invalid_header &amp;&amp; cscf-&gt;ignore_invalid_headers) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* there was error while a header line parsing */</span></span><br><span class="line"></span><br><span class="line">                ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"client sent invalid header line: \"%*s\""</span>,</span><br><span class="line">                              r-&gt;header_end - r-&gt;header_name_start,</span><br><span class="line">                              r-&gt;header_name_start);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* a header line has been parsed successfully */</span></span><br><span class="line">            <span class="comment">// 将解析的头添加到headers_in的headers中</span></span><br><span class="line">            h = ngx_list_push(&amp;r-&gt;headers_in.headers);</span><br><span class="line">            <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置hash值，为在解析请求头时计算的值</span></span><br><span class="line">            h-&gt;hash = r-&gt;header_hash;</span><br><span class="line">            <span class="comment">// 设置key和value</span></span><br><span class="line">            h-&gt;key.len = r-&gt;header_name_end - r-&gt;header_name_start;</span><br><span class="line">            h-&gt;key.data = r-&gt;header_name_start;</span><br><span class="line">            h-&gt;key.data[h-&gt;key.len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">            h-&gt;value.len = r-&gt;header_end - r-&gt;header_start;</span><br><span class="line">            h-&gt;value.data = r-&gt;header_start;</span><br><span class="line">            h-&gt;value.data[h-&gt;value.len] = <span class="string">'\0'</span>;</span><br><span class="line">            <span class="comment">// 设置lowcase_key</span></span><br><span class="line">            h-&gt;lowcase_key = ngx_pnalloc(r-&gt;pool, h-&gt;key.len);</span><br><span class="line">            <span class="keyword">if</span> (h-&gt;lowcase_key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果长度和lowcase_index中使用的长度一样，则直接使用lowcase_header存储的小写字符赋值，否则调用对应函数处理</span></span><br><span class="line">            <span class="keyword">if</span> (h-&gt;key.len == r-&gt;lowcase_index) &#123;</span><br><span class="line">                ngx_memcpy(h-&gt;lowcase_key, r-&gt;lowcase_header, h-&gt;key.len);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ngx_strlow(h-&gt;lowcase_key, h-&gt;key.data, h-&gt;key.len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从headers_in_hash中查找对应的头。具体查看配置继续的http头初始化和hash结构</span></span><br><span class="line">            hh = ngx_hash_find(&amp;cmcf-&gt;headers_in_hash, h-&gt;hash,</span><br><span class="line">                               h-&gt;lowcase_key, h-&gt;key.len);</span><br><span class="line">            <span class="comment">// 如果找到了对应的头，并有对应的处理方法，则执行对应的处理方法，这一步会设置cookie，host，Keep-Alive，X-Forwarded-For，Connection</span></span><br><span class="line">            <span class="keyword">if</span> (hh &amp;&amp; hh-&gt;handler(r, h, hh-&gt;offset) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http header: \"%V: %V\""</span>,</span><br><span class="line">                           &amp;h-&gt;key, &amp;h-&gt;value);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果完成了请求头的解析</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_HTTP_PARSE_HEADER_DONE) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* a whole header has been parsed successfully */</span></span><br><span class="line"></span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http header done"</span>);</span><br><span class="line">            <span class="comment">// 计算长度</span></span><br><span class="line">            r-&gt;request_length += r-&gt;header_in-&gt;pos - r-&gt;header_name_start;</span><br><span class="line">            <span class="comment">// 记录状态</span></span><br><span class="line">            r-&gt;http_state = NGX_HTTP_PROCESS_REQUEST_STATE;</span><br><span class="line">            <span class="comment">// 处理请求头</span></span><br><span class="line">            rc = ngx_http_process_request_header(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            ngx_http_process_request(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// again表示一行还未接收完成</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* a header line parsing is still not complete */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* rc == NGX_HTTP_PARSE_INVALID_HEADER */</span></span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client sent invalid header line"</span>);</span><br><span class="line">        <span class="comment">// 否则执行终止请求</span></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行子请求的方法</span></span><br><span class="line">    ngx_http_run_posted_requests(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析请求头ngx-http-parse-header-line"><a href="#解析请求头ngx-http-parse-header-line" class="headerlink" title="解析请求头ngx_http_parse_header_line"></a>解析请求头ngx_http_parse_header_line</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_parse_header_line(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_buf_t</span> *b,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> allow_underscores)</span><br><span class="line">&#123;</span><br><span class="line">    u_char      c, ch, *p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  hash, i;</span><br><span class="line">    <span class="comment">// 状态变量</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        sw_start = <span class="number">0</span>,</span><br><span class="line">        sw_name,</span><br><span class="line">        sw_space_before_value,</span><br><span class="line">        sw_value,</span><br><span class="line">        sw_space_after_value,</span><br><span class="line">        sw_ignore_line,</span><br><span class="line">        sw_almost_done,</span><br><span class="line">        sw_header_almost_done</span><br><span class="line">    &#125; state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the last '\0' is not needed because string is zero terminated */</span></span><br><span class="line">    <span class="comment">// 大小写转换及允许字符</span></span><br><span class="line">    <span class="keyword">static</span> u_char  lowcase[] =</span><br><span class="line">        <span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0-\0\0"</span> <span class="string">"0123456789\0\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0abcdefghijklmnopqrstuvwxyz\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0abcdefghijklmnopqrstuvwxyz\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span></span><br><span class="line">        <span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>;</span><br><span class="line">    <span class="comment">// 获取状态和已计算的hash值</span></span><br><span class="line">    state = r-&gt;state;</span><br><span class="line">    hash = r-&gt;header_hash;</span><br><span class="line">    i = r-&gt;lowcase_index;</span><br><span class="line">    <span class="comment">// 变量接收到的数据</span></span><br><span class="line">    <span class="keyword">for</span> (p = b-&gt;pos; p &lt; b-&gt;last; p++) &#123;</span><br><span class="line">        ch = *p;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* first char */</span></span><br><span class="line">        <span class="comment">//状态为开始</span></span><br><span class="line">        <span class="keyword">case</span> sw_start:</span><br><span class="line">            <span class="comment">// 记录当前的变量名的开始位置</span></span><br><span class="line">            r-&gt;header_name_start = p;</span><br><span class="line">            r-&gt;invalid_header = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 判断直接</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 如果是CR '\r'则说明是最后一行，转移状态到sw_header_almost_done</span></span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                state = sw_header_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是LF \n，则是结束,完成解析</span></span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                <span class="keyword">goto</span> header_done;</span><br><span class="line">            <span class="comment">// 否则就是变量名</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                state = sw_name;</span><br><span class="line">                <span class="comment">// 进行字符转换，并确定是否为合法字符</span></span><br><span class="line">                c = lowcase[ch];</span><br><span class="line">                <span class="comment">// 如果为合法字符</span></span><br><span class="line">                <span class="keyword">if</span> (c) &#123;</span><br><span class="line">                    <span class="comment">// 计算hash值</span></span><br><span class="line">                    hash = ngx_hash(<span class="number">0</span>, c);</span><br><span class="line">                    <span class="comment">//在存储小写字符的位置上记录</span></span><br><span class="line">                    r-&gt;lowcase_header[<span class="number">0</span>] = c;</span><br><span class="line">                    <span class="comment">// i记录name的长度</span></span><br><span class="line">                    i = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 判断是否允许下划线</span></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'_'</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (allow_underscores) &#123;</span><br><span class="line">                        hash = ngx_hash(<span class="number">0</span>, ch);</span><br><span class="line">                        r-&gt;lowcase_header[<span class="number">0</span>] = ch;</span><br><span class="line">                        i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        hash = <span class="number">0</span>;</span><br><span class="line">                        i = <span class="number">0</span>;</span><br><span class="line">                        r-&gt;invalid_header = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 否则就是无效的请求头</span></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'\0'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hash = <span class="number">0</span>;</span><br><span class="line">                i = <span class="number">0</span>;</span><br><span class="line">                r-&gt;invalid_header = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* header name */</span></span><br><span class="line">        <span class="comment">// 解析变量名</span></span><br><span class="line">        <span class="keyword">case</span> sw_name:</span><br><span class="line">            <span class="comment">// 进行字符转换，并确定是否为合法字符</span></span><br><span class="line">            c = lowcase[ch];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c) &#123;</span><br><span class="line">                hash = ngx_hash(hash, c);</span><br><span class="line">                r-&gt;lowcase_header[i++] = c;</span><br><span class="line">                <span class="comment">// 这里i要和31进行取&amp;，确保i小于32，因为lowcase_header长度为32</span></span><br><span class="line">                i &amp;= (NGX_HTTP_LC_HEADER_LEN - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'_'</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (allow_underscores) &#123;</span><br><span class="line">                    hash = ngx_hash(hash, ch);</span><br><span class="line">                    r-&gt;lowcase_header[i++] = ch;</span><br><span class="line">                    i &amp;= (NGX_HTTP_LC_HEADER_LEN - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r-&gt;invalid_header = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是:，则表示变量名结束，转移状态为值前面的空间</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">':'</span>) &#123;</span><br><span class="line">                r-&gt;header_name_end = p;</span><br><span class="line">                state = sw_space_before_value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是 \r，则说明变量值为空，记录变量值，并转移状态为将要结束行解析</span></span><br><span class="line">            <span class="keyword">if</span> (ch == CR) &#123;</span><br><span class="line">                r-&gt;header_name_end = p;</span><br><span class="line">                r-&gt;header_start = p;</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是 \n，则说明变量值为空，记录变量值，结束行解析</span></span><br><span class="line">            <span class="keyword">if</span> (ch == LF) &#123;</span><br><span class="line">                r-&gt;header_name_end = p;</span><br><span class="line">                r-&gt;header_start = p;</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* IIS may send the duplicate "HTTP/1.1 ..." lines */</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'/'</span></span><br><span class="line">                &amp;&amp; r-&gt;upstream</span><br><span class="line">                &amp;&amp; p - r-&gt;header_name_start == <span class="number">4</span></span><br><span class="line">                &amp;&amp; ngx_strncmp(r-&gt;header_name_start, <span class="string">"HTTP"</span>, <span class="number">4</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                state = sw_ignore_line;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'\0'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r-&gt;invalid_header = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* space* before header value */</span></span><br><span class="line">        <span class="comment">// 值前面的空间</span></span><br><span class="line">        <span class="keyword">case</span> sw_space_before_value:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是 \r，则说明变量值为空，记录变量值，并转移状态为将要结束行解析</span></span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;header_start = p;</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是 \n，则说明变量值为空，记录变量值，结束行解析</span></span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;header_start = p;</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">            <span class="comment">// 其余情况说明有变量值，解析变量值</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                r-&gt;header_start = p;</span><br><span class="line">                state = sw_value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* header value */</span></span><br><span class="line">        <span class="comment">// 解析变量值</span></span><br><span class="line">        <span class="keyword">case</span> sw_value:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 如果是空格，则是变量值后的空间，转移状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                state = sw_space_after_value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是 \r，说明变量解析完成，并转移状态为将要结束行解析</span></span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 如果是 \n，说明变量解析完成，记录变量值，结束行解析</span></span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                r-&gt;header_end = p;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">            <span class="comment">// 其余情况都是正常值的字符</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* space* before end of header line */</span></span><br><span class="line">        <span class="comment">// 由于在变量值末尾的空格应该被忽略，但是变量值本身可能包含空格，因此在该状态下，能够转换到变量值的状态，这表示之前遇到的空格是值的一部分</span></span><br><span class="line">        <span class="keyword">case</span> sw_space_after_value:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                state = sw_value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ignore header line */</span></span><br><span class="line">        <span class="keyword">case</span> sw_ignore_line:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                state = sw_start;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* end of header line */</span></span><br><span class="line">        <span class="comment">// 将要完成行解析</span></span><br><span class="line">        <span class="keyword">case</span> sw_almost_done:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 完成行解析</span></span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 解析错误</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* end of header */</span></span><br><span class="line">        <span class="comment">// 将要完成头解析</span></span><br><span class="line">        <span class="keyword">case</span> sw_header_almost_done:</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 只允许是\n</span></span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                <span class="keyword">goto</span> header_done;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果未完成一行的解析，则记录解析状态</span></span><br><span class="line">    b-&gt;pos = p;</span><br><span class="line">    r-&gt;state = state;</span><br><span class="line">    r-&gt;header_hash = hash;</span><br><span class="line">    r-&gt;lowcase_index = i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line"><span class="comment">// 完成一行的解析</span></span><br><span class="line">done:</span><br><span class="line">    <span class="comment">// 记录解析到的位置</span></span><br><span class="line">    b-&gt;pos = p + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 记录下一次从开始状态进行解析</span></span><br><span class="line">    r-&gt;state = sw_start;</span><br><span class="line">    <span class="comment">// 记录hash值</span></span><br><span class="line">    r-&gt;header_hash = hash;</span><br><span class="line">    <span class="comment">// 记录key长度，该长度与31取&amp;,保证小于32</span></span><br><span class="line">    r-&gt;lowcase_index = i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"><span class="comment">// 完成header的整体解析</span></span><br><span class="line">header_done:</span><br><span class="line">    <span class="comment">// 记录解析到的位置</span></span><br><span class="line">    b-&gt;pos = p + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 记录下一次从开始状态进行解析</span></span><br><span class="line">    r-&gt;state = sw_start;</span><br><span class="line">    <span class="comment">// 返回完成整个http header的解析</span></span><br><span class="line">    <span class="keyword">return</span> NGX_HTTP_PARSE_HEADER_DONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="部分请求头处理函数"><a href="#部分请求头处理函数" class="headerlink" title="部分请求头处理函数"></a>部分请求头处理函数</h3><p>这里简单介绍一下请求头的处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        offset;</span><br><span class="line">    ngx_http_header_handler_pt        handler;</span><br><span class="line">&#125; <span class="keyword">ngx_http_header_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_http_header_t</span>  ngx_http_headers_in[] = &#123;</span><br><span class="line">    &#123; ngx_string(<span class="string">"Host"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, host),</span><br><span class="line">                 ngx_http_process_host &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Connection"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, connection),</span><br><span class="line">                 ngx_http_process_connection &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"If-Modified-Since"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, if_modified_since),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"If-Unmodified-Since"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, if_unmodified_since),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"If-Match"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, if_match),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"If-None-Match"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, if_none_match),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"User-Agent"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, user_agent),</span><br><span class="line">                 ngx_http_process_user_agent &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Referer"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, referer),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Content-Length"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, content_length),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Content-Range"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, content_range),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Content-Type"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, content_type),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Range"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, range),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"If-Range"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, if_range),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Transfer-Encoding"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, transfer_encoding),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"TE"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, te),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Expect"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, expect),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Upgrade"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, upgrade),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HTTP_GZIP || NGX_HTTP_HEADERS)</span><br><span class="line">    &#123; ngx_string(<span class="string">"Accept-Encoding"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, accept_encoding),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Via"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, via),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Authorization"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, authorization),</span><br><span class="line">                 ngx_http_process_unique_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Keep-Alive"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, keep_alive),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HTTP_X_FORWARDED_FOR)</span><br><span class="line">    &#123; ngx_string(<span class="string">"X-Forwarded-For"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, x_forwarded_for),</span><br><span class="line">                 ngx_http_process_multi_header_lines &#125;,</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HTTP_REALIP)</span><br><span class="line">    &#123; ngx_string(<span class="string">"X-Real-IP"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, x_real_ip),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HTTP_HEADERS)</span><br><span class="line">    &#123; ngx_string(<span class="string">"Accept"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, accept),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Accept-Language"</span>),</span><br><span class="line">                 offsetof(<span class="keyword">ngx_http_headers_in_t</span>, accept_language),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HTTP_DAV)</span><br><span class="line">    &#123; ngx_string(<span class="string">"Depth"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, depth),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Destination"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, destination),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Overwrite"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, overwrite),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Date"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, date),</span><br><span class="line">                 ngx_http_process_header_line &#125;,</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"Cookie"</span>), offsetof(<span class="keyword">ngx_http_headers_in_t</span>, cookies),</span><br><span class="line">                 ngx_http_process_multi_header_lines &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_null_string, <span class="number">0</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体调用解析的方式见配置解析中的介绍，这里主要介绍一些函数的处理逻辑。</p>
<h4 id="host处理方法ngx-http-process-host"><a href="#host处理方法ngx-http-process-host" class="headerlink" title="host处理方法ngx_http_process_host"></a>host处理方法ngx_http_process_host</h4><p><code>host</code>处理方法主要是解析是否为合法host，并根据host确定服务。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_process_host(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_table_elt_t</span> *h,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> offset)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  rc;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>  host;</span><br><span class="line">    <span class="comment">// 如果已经设置了host，则重复设置，报错</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.host) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client sent duplicate host header: \"%V: %V\", "</span></span><br><span class="line">                      <span class="string">"previous value: \"%V: %V\""</span>,</span><br><span class="line">                      &amp;h-&gt;key, &amp;h-&gt;value, &amp;r-&gt;headers_in.host-&gt;key,</span><br><span class="line">                      &amp;r-&gt;headers_in.host-&gt;value);</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置请求的host</span></span><br><span class="line">    r-&gt;headers_in.host = h;</span><br><span class="line"></span><br><span class="line">    host = h-&gt;value;</span><br><span class="line">    <span class="comment">// 解析是否为合法host</span></span><br><span class="line">    rc = ngx_http_validate_host(&amp;host, r-&gt;pool, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client sent invalid host header"</span>);</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        ngx_http_close_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求行中出现的host长度不为0，说明请求行中host合法，优先使用请求行中的host查找服务（之前已经查找过），这里就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.server.len) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据host查找对应的服务，设置配置</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_set_virtual_server(r, &amp;host) == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    r-&gt;headers_in.server = host;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Connection处理方法ngx-http-process-connection"><a href="#Connection处理方法ngx-http-process-connection" class="headerlink" title="Connection处理方法ngx_http_process_connection"></a>Connection处理方法ngx_http_process_connection</h4><p><code>connection</code>处理方法主要判断请求类型，分为<code>close</code>和<code>keep-alive</code>两种，分别表示请求相应后是否关闭连接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static ngx_int_t</span><br><span class="line">ngx_http_process_connection(ngx_http_request_t *r, ngx_table_elt_t *h,</span><br><span class="line">    ngx_uint_t offset)</span><br><span class="line">&#123;</span><br><span class="line">    // 连接类型为close</span><br><span class="line">    if (ngx_strcasestrn(h-&gt;value.data, &quot;close&quot;, 5 - 1)) &#123;</span><br><span class="line">        r-&gt;headers_in.connection_type = NGX_HTTP_CONNECTION_CLOSE;</span><br><span class="line">    // 连接类型为keep-alive</span><br><span class="line">    &#125; else if (ngx_strcasestrn(h-&gt;value.data, &quot;keep-alive&quot;, 10 - 1)) &#123;</span><br><span class="line">        r-&gt;headers_in.connection_type = NGX_HTTP_CONNECTION_KEEP_ALIVE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Content-Length-amp-Transfer-Encoding处理方法ngx-http-process-unique-header-line"><a href="#Content-Length-amp-Transfer-Encoding处理方法ngx-http-process-unique-header-line" class="headerlink" title="Content-Length&amp;Transfer-Encoding处理方法ngx_http_process_unique_header_line"></a>Content-Length&amp;Transfer-Encoding处理方法ngx_http_process_unique_header_line</h4><p>对应post请求来说，需要在接收完成请求头后告知服务器请求体数据长度，该值应该是精确的。如果该值大于实际长度时，服务器会陷入等待中，不会发送响应。当该值小于实际长度时，服务器将只读取到部分数据，如果这时使用了<code>keep-alive</code>形式连接，剩下的部分会在第二次请求中被读取到，导致下一次请求也失败。</p>
<p>但又是，我们可能没办法确定实际要发送的内容大小，这时就不能使用<code>Content-Length</code>头了，而应该使用<code>Transfer-Encoding:chunked</code>。数据以一系列分块的形式进行发送. <code>Content-Length</code> 首部在这种情况下不被发送. 在每一个分块的开头需要添加当前分块的长度, 以十六进制的形式表示，后面紧跟着 <code>\r\n</code> , 之后是分块本身, 后面也是<code>\r\n</code>. 终止块是一个常规的分块, 不同之处在于其长度为0.</p>
<p>处理方法<code>ngx_http_process_unique_header_line</code>是很多请求头的处理方法，只有有唯一值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_process_unique_header_line(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_table_elt_t</span> *h,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> offset)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>  **ph;</span><br><span class="line"></span><br><span class="line">    ph = (<span class="keyword">ngx_table_elt_t</span> **) ((<span class="keyword">char</span> *) &amp;r-&gt;headers_in + offset);</span><br><span class="line">    <span class="comment">// 未被设置时设置，否则说明请求错误</span></span><br><span class="line">    <span class="keyword">if</span> (*ph == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *ph = h;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"client sent duplicate header line: \"%V: %V\", "</span></span><br><span class="line">                  <span class="string">"previous value: \"%V: %V\""</span>,</span><br><span class="line">                  &amp;h-&gt;key, &amp;h-&gt;value, &amp;(*ph)-&gt;key, &amp;(*ph)-&gt;value);</span><br><span class="line"></span><br><span class="line">    ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="keep-alive处理方法ngx-http-process-header-line"><a href="#keep-alive处理方法ngx-http-process-header-line" class="headerlink" title="keep-alive处理方法ngx_http_process_header_line"></a>keep-alive处理方法ngx_http_process_header_line</h4><p><code>keep-alive</code>指示长连接相关属性，例如：<code>Keep-Alive: 100</code>表示这个TCP通道可以保持100s。<code>keep-alive</code>模式下客户端获取响应结束的方法与服务器获取请求体长度方法一致。如果是静态的响应数据，可以通过判断响应头部中的Content-Length 字段，判断数据达到这个大小就知道数据传输结束了。但是返回的数据是动态变化的，服务器不能第一时间知道数据长度，这样就没有 Content-Length 关键字了。这种情况下，服务器是分块传输数据的，<code>Transfer-Encoding：chunk</code>，这时候就要根据传输的数据块chunk来判断，数据传输结束的时候，最后的一个数据块chunk的长度是0。</p>
<p>HTTP的Keep-Alive与TCP的Keep Alive，有些不同，两者意图不一样。前者主要是 TCP连接复用，避免建立过多的TCP连接。而TCP的Keep Alive的意图是在于保持TCP连接的存活，就是发送心跳包。隔一段时间给连接对端发送一个探测包，如果收到对方回应的 ACK，则认为连接还是存活的，在超过一定重试次数之后还是没有收到对方的回应，则丢弃该 TCP 连接。</p>
<p>对于<code>ngx_http_process_header_line</code>处理方法也是十分通用的头处理逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_process_header_line(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_table_elt_t</span> *h,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> offset)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>  **ph;</span><br><span class="line"></span><br><span class="line">    ph = (<span class="keyword">ngx_table_elt_t</span> **) ((<span class="keyword">char</span> *) &amp;r-&gt;headers_in + offset);</span><br><span class="line">    <span class="comment">// 使用第一个获取到的请求头对应数据，如果存在重复，则丢弃后面的</span></span><br><span class="line">    <span class="keyword">if</span> (*ph == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *ph = h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="处理请求头ngx-http-process-request-header"><a href="#处理请求头ngx-http-process-request-header" class="headerlink" title="处理请求头ngx_http_process_request_header"></a>处理请求头ngx_http_process_request_header</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_process_request_header(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 没有查找到对应服务，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.server.len == <span class="number">0</span></span><br><span class="line">        &amp;&amp; ngx_http_set_virtual_server(r, &amp;r-&gt;headers_in.server)</span><br><span class="line">           == NGX_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果http版本大于1，且请求头中没有host，则请求错误</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.host == <span class="literal">NULL</span> &amp;&amp; r-&gt;http_version &gt; NGX_HTTP_VERSION_10) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"client sent HTTP/1.1 request without \"Host\" header"</span>);</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果请求头中存在请求体长度，则解析长度值</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.content_length) &#123;</span><br><span class="line">        r-&gt;headers_in.content_length_n =</span><br><span class="line">                            ngx_atoof(r-&gt;headers_in.content_length-&gt;value.data,</span><br><span class="line">                                      r-&gt;headers_in.content_length-&gt;value.len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_in.content_length_n == NGX_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"client sent invalid \"Content-Length\" header"</span>);</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_BAD_REQUEST);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求是trace方式，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;method == NGX_HTTP_TRACE) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client sent TRACE method"</span>);</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_NOT_ALLOWED);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果采用chunked分块传输请求体，则设置请求体长度为空，设置标识位</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.transfer_encoding) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_in.transfer_encoding-&gt;value.len == <span class="number">7</span></span><br><span class="line">            &amp;&amp; ngx_strncasecmp(r-&gt;headers_in.transfer_encoding-&gt;value.data,</span><br><span class="line">                               (u_char *) <span class="string">"chunked"</span>, <span class="number">7</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            r-&gt;headers_in.content_length = <span class="literal">NULL</span>;</span><br><span class="line">            r-&gt;headers_in.content_length_n = <span class="number">-1</span>;</span><br><span class="line">            r-&gt;headers_in.chunked = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"client sent unknown \"Transfer-Encoding\": \"%V\""</span>,</span><br><span class="line">                          &amp;r-&gt;headers_in.transfer_encoding-&gt;value);</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_NOT_IMPLEMENTED);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求类型为kep-alive，解析维持连接时间</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.connection_type == NGX_HTTP_CONNECTION_KEEP_ALIVE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_in.keep_alive) &#123;</span><br><span class="line">            r-&gt;headers_in.keep_alive_n =</span><br><span class="line">                            ngx_atotm(r-&gt;headers_in.keep_alive-&gt;value.data,</span><br><span class="line">                                      r-&gt;headers_in.keep_alive-&gt;value.len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="请求处理ngx-http-process-request"><a href="#请求处理ngx-http-process-request" class="headerlink" title="请求处理ngx_http_process_request"></a>请求处理ngx_http_process_request</h2><p>接收完请求头后进行请求处理，是nginx核心逻辑部分。执行方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_process_request(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* 如果读事件依然在定时器红黑树中，则从其中剔除。</span></span><br><span class="line"><span class="comment">    在定时器红黑树中主要监控是否结束请求头超时，超时会将请求关闭，则完成请求头的处理后应该从定时器红黑树中删除.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;read-&gt;timer_set) &#123;</span><br><span class="line">        ngx_del_timer(c-&gt;read);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置读写事件处理均为ngx_http_request_handler</span></span><br><span class="line">    c-&gt;read-&gt;handler = ngx_http_request_handler;</span><br><span class="line">    c-&gt;write-&gt;handler = ngx_http_request_handler;</span><br><span class="line">    <span class="comment">// 设置请求的读事件为ngx_http_block_reading，其逻辑对于使用epoll驱动来说，仅仅只有一个日志记录</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line"></span><br><span class="line">    ngx_http_handler(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于nginx基本都是非阻塞试函数，在完全请求解析前，每次调用请求解析函数无法立即完成处理，将会立即返回，在epoll事件启动中接收到读事件时，继续调用解析请求头的处理。这是对于读事件的处理，在解析请求头期间，写事件只是一个空函数，并无任何处理逻辑。</p>
<p>在接收完请求后，对应的读写事件就发生了变更，这里变成了<code>ngx_http_request_handler</code>方法，该函数主要是判断epoll返回的事件类型，来执行对应的请求的读事件处理和写事件处理。这里读事件只是一个空函数，在完成请求前不应该出现可读事件，即使出现，也不会做任何处理。写事件是每次epoll返回都会触发的事件，因此在结束请求前，每次都会执行对应请求的写事件。</p>
<p>写事件的处理会在<code>ngx_http_handler</code>根据当前请求类型来决定，处理方法如下：</p>
<h3 id="设置请求处理ngx-http-handler"><a href="#设置请求处理ngx-http-handler" class="headerlink" title="设置请求处理ngx_http_handler"></a>设置请求处理ngx_http_handler</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    r-&gt;connection-&gt;<span class="built_in">log</span>-&gt;action = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 如果请求不是内部请求，即是用户下发的请求</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;internal) &#123;</span><br><span class="line">        <span class="comment">// 设置请求类型</span></span><br><span class="line">        <span class="keyword">switch</span> (r-&gt;headers_in.connection_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            r-&gt;keepalive = (r-&gt;http_version &gt; NGX_HTTP_VERSION_10);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_CONNECTION_CLOSE:</span><br><span class="line">            r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_CONNECTION_KEEP_ALIVE:</span><br><span class="line">            r-&gt;keepalive = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果存在请求体，则设置延迟关闭</span></span><br><span class="line">        r-&gt;lingering_close = (r-&gt;headers_in.content_length_n &gt; <span class="number">0</span></span><br><span class="line">                              || r-&gt;headers_in.chunked);</span><br><span class="line">        <span class="comment">// 设置请求阶段为0</span></span><br><span class="line">        r-&gt;phase_handler = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则，设置请求阶段为NGX_HTTP_SERVER_REWRITE_PHASE阶段的第一个ngx_http_phase_handler_t处理方法在handlers中的下标，具体可以看配置解析相关章节</span></span><br><span class="line">        cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">        r-&gt;phase_handler = cmcf-&gt;phase_engine.server_rewrite_index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;valid_location = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_GZIP)</span></span><br><span class="line">    r-&gt;gzip_tested = <span class="number">0</span>;</span><br><span class="line">    r-&gt;gzip_ok = <span class="number">0</span>;</span><br><span class="line">    r-&gt;gzip_vary = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置请求读事件为执行请求阶段循环，并立即执行一次</span></span><br><span class="line">    r-&gt;write_event_handler = ngx_http_core_run_phases;</span><br><span class="line">    ngx_http_core_run_phases(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="核心处理循环ngx-http-core-run-phases"><a href="#核心处理循环ngx-http-core-run-phases" class="headerlink" title="核心处理循环ngx_http_core_run_phases"></a>核心处理循环ngx_http_core_run_phases</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_core_run_phases(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc;</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span>   *ph;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 获取执行函数列表</span></span><br><span class="line">    ph = cmcf-&gt;phase_engine.handlers;</span><br><span class="line">    <span class="comment">// 执行对应的check方法，这里并不一定是依次遍历每个执行方法，后续详细介绍</span></span><br><span class="line">    <span class="keyword">while</span> (ph[r-&gt;phase_handler].checker) &#123;</span><br><span class="line"></span><br><span class="line">        rc = ph[r-&gt;phase_handler].checker(r, &amp;ph[r-&gt;phase_handler]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看一下具体的读写事件的处理逻辑：</p>
<h3 id="epoll事件触发执行方法ngx-http-request-handler"><a href="#epoll事件触发执行方法ngx-http-request-handler" class="headerlink" title="epoll事件触发执行方法ngx_http_request_handler"></a>epoll事件触发执行方法ngx_http_request_handler</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_request_handler(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>    *c;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>  *r;</span><br><span class="line"></span><br><span class="line">    c = ev-&gt;data;</span><br><span class="line">    r = c-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_http_set_log_request(c-&gt;<span class="built_in">log</span>, r);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http run request: \"%V?%V\""</span>, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">    <span class="comment">// 当连接关闭时，将主请求的计数加一，这里目前不是很明白，后续subrequest中详细查看</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;close) &#123;</span><br><span class="line">        r-&gt;main-&gt;count++;</span><br><span class="line">        ngx_http_terminate_request(r, <span class="number">0</span>);</span><br><span class="line">        ngx_http_run_posted_requests(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;delayed &amp;&amp; ev-&gt;timedout) &#123;</span><br><span class="line">        ev-&gt;delayed = <span class="number">0</span>;</span><br><span class="line">        ev-&gt;timedout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果事件是写事件，则执行对应请求的写事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;write) &#123;</span><br><span class="line">        r-&gt;write_event_handler(r);</span><br><span class="line">    <span class="comment">// 否则执行读事件处理</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r-&gt;read_event_handler(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行所有子请求的处理</span></span><br><span class="line">    ngx_http_run_posted_requests(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="核心处理阶段"><a href="#核心处理阶段" class="headerlink" title="核心处理阶段"></a>核心处理阶段</h2><p>这里需要参考配置解析中关于处理阶段的处理。在处理方法是，会执行没一个阶段的<code>checker</code>方法。下表了列出了每个阶段的含义及<code>checker</code>方法，下面会详细介绍。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>阶段</th>
<th>含义</th>
<th><code>checker</code>方法</th>
<th>其他</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_HTTP_POST_READ_PHASE</code></td>
<td>收到完整的http头部后处理的阶段</td>
<td><code>ngx_http_core_generic_phase</code></td>
<td>允许用户增加处理函数</td>
</tr>
<tr>
<td><code>NGX_HTTP_SERVER_REWRITE_PHASE</code></td>
<td>重写uri阶段，这里是在执行uri查找对应的location之前的重写uri。比如在server层定义了一个<code>if</code>语句，根据指定的uri进行重写。</td>
<td><code>ngx_http_core_rewrite_phase</code></td>
<td>允许用户添加处理</td>
</tr>
<tr>
<td><code>NGX_HTTP_FIND_CONFIG_PHASE</code></td>
<td>依据uri查找对应location服务</td>
<td><code>ngx_http_core_find_config_phase</code></td>
<td>不允许用户自定义函数</td>
</tr>
<tr>
<td><code>NGX_HTTP_REWRITE_PHASE</code></td>
<td>在location中重写uri</td>
<td><code>ngx_http_core_rewrite_phase</code></td>
<td>允许用户自定义处理函数</td>
</tr>
<tr>
<td><code>NGX_HTTP_POST_REWRITE_PHASE</code></td>
<td>用于rewrite重新URI后，防止错误的配置导致死循环</td>
<td><code>ngx_http_core_post_rewrite_phase</code></td>
<td>仅在使用了location重写时才存在该阶段，且不允许用户添加处理方法。</td>
</tr>
<tr>
<td><code>NGX_HTTP_PREACCESS_PHASE</code></td>
<td>处理NGX_HTTP_ACCESS_PHASE阶段决定访问权限前，http模块可以介入的阶段</td>
<td><code>ngx_http_core_generic_phase</code></td>
<td>允许用户自定义处理方法。</td>
</tr>
<tr>
<td><code>NGX_HTTP_ACCESS_PHASE</code></td>
<td>让HTTP模块判断是否允许这个请求访问nginx服务</td>
<td><code>ngx_http_core_access_phase</code></td>
<td>允许用户自定义处理方法。</td>
</tr>
<tr>
<td><code>NGX_HTTP_POST_ACCESS_PHASE</code></td>
<td>如果http模块的handler处理函数返回不允许访问的错误码时，这里负责向用户发送拒绝服务的错误</td>
<td><code>ngx_http_core_post_access_phase</code></td>
<td>仅使用·了权限解析时才存在该步骤，且不允许用户自定义处理函数。</td>
</tr>
<tr>
<td><code>NGX_HTTP_PRECONTENT_PHASE</code></td>
<td>主要用于try_file</td>
<td><code>ngx_http_core_generic_phase</code></td>
<td>允许用户自定义处理函数</td>
</tr>
<tr>
<td><code>NGX_HTTP_CONTENT_PHASE</code></td>
<td>用于处理HTTP请求内容的阶段，是大部分http模块介入的阶段</td>
<td><code>ngx_http_core_content_phase</code></td>
<td>允许用户自定义处理函数。用户主要介入的处理阶段。</td>
</tr>
<tr>
<td><code>NGX_HTTP_LOG_PHASE</code></td>
<td>处理完成后记录日志的阶段</td>
<td><code>ngx_http_core_generic_phase</code></td>
<td>允许用户自定义处理函数。</td>
</tr>
</tbody>
</table>
</div>
<p>首先这里介绍一下多个阶段共用的<code>ngx_http_core_generic_phase</code>的check方法。</p>
<h3 id="ngx-http-core-generic-phase方法"><a href="#ngx-http-core-generic-phase方法" class="headerlink" title="ngx_http_core_generic_phase方法"></a>ngx_http_core_generic_phase方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_generic_phase(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  rc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * generic phase checker,</span></span><br><span class="line"><span class="comment">     * used by the post read and pre-access phases</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"generic phase: %ui"</span>, r-&gt;phase_handler);</span><br><span class="line">    <span class="comment">// 执行ngx_http_phase_handler_t对应的处理函数</span></span><br><span class="line">    rc = ph-&gt;handler(r);</span><br><span class="line">    <span class="comment">// 如果返回NGX_OK，则表示该阶段处理完成，设置下一次执行的为下一个阶段的函数</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">        r-&gt;phase_handler = ph-&gt;next;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果返回NGX_DECLINED，则表示该处理方法完成，按顺序执行后续方法</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        r-&gt;phase_handler++;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果返回NGX_AGAIN，表示该方法没有处理完成，存在阻塞，这时返回到ngx_http_core_run_phases函数时，会立即结束函数处理，等待事件触发，再处理。返回NGX_DONE表示处理请求完成。</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN || rc == NGX_DONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_ERROR || rc == NGX_HTTP_...  */</span></span><br><span class="line">    <span class="comment">// 如果出错，执行对应的处理</span></span><br><span class="line">    ngx_http_finalize_request(r, rc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应使用该方法作为checker的阶段来说，每个处理函数的方法值含义如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>返回值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_OK</code></td>
<td>执行下一个阶段的第一个handler处理方法，这意味着，即使当前阶段后续还有一些HTTP模块设置了handler处理方法，也不会被执行。</td>
</tr>
<tr>
<td><code>NGX_DECLINED</code></td>
<td>当前处理函数完成，执行下一个handler方法。</td>
</tr>
<tr>
<td>`NGX_AGAIN</td>
<td>NGX_DONE`</td>
<td>当前处理函数未完成，存在阻塞调用，将控制权交给事件模块，在下次事件模块触发时，再次调用该方法。</td>
</tr>
<tr>
<td>其他</td>
<td>出错，使用<code>ngx_http_finalize_request</code>结束请求。</td>
</tr>
</tbody>
</table>
</div>
<h2 id="NGX-HTTP-POST-READ-PHASE阶段"><a href="#NGX-HTTP-POST-READ-PHASE阶段" class="headerlink" title="NGX_HTTP_POST_READ_PHASE阶段"></a>NGX_HTTP_POST_READ_PHASE阶段</h2><p>完成请求解析后，首先执行的阶段，目前默认的nginx下不会使用该阶段。<code>checker</code>方法为<code>ngx_http_core_generic_phase</code>上文已详细介绍。官方模块的<code>ngx_http_realip_module</code>设置了该方法。这里不做详细介绍。</p>
<h2 id="NGX-HTTP-SERVER-REWRITE-PHASE阶段"><a href="#NGX-HTTP-SERVER-REWRITE-PHASE阶段" class="headerlink" title="NGX_HTTP_SERVER_REWRITE_PHASE阶段"></a>NGX_HTTP_SERVER_REWRITE_PHASE阶段</h2><p><code>NGX_HTTP_SERVER_REWRITE_PHASE</code>阶段主要由<code>ngx_http_rewrite_module</code>模块处理。</p>
<p>首先来看一下该阶段的checker方法。</p>
<h3 id="ngx-http-core-rewrite-phase方法"><a href="#ngx-http-core-rewrite-phase方法" class="headerlink" title="ngx_http_core_rewrite_phase方法"></a>ngx_http_core_rewrite_phase方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_rewrite_phase(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  rc;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"rewrite phase: %ui"</span>, r-&gt;phase_handler);</span><br><span class="line">    <span class="comment">// 执行处理方法</span></span><br><span class="line">    rc = ph-&gt;handler(r);</span><br><span class="line">    <span class="comment">// 如果返回执行下一个处理方法，则设置对应的phase_handler</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        r-&gt;phase_handler++;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* NGX_OK, NGX_AGAIN, NGX_ERROR, NGX_HTTP_...  */</span></span><br><span class="line">    <span class="comment">// 否则执行结束处理</span></span><br><span class="line">    ngx_http_finalize_request(r, rc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码可以看出，该阶段的处理函数方法值对应的含义为：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>返回值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_DECLINED</code></td>
<td>当前处理函数完成，处理下一个函数</td>
</tr>
<tr>
<td><code>NGX_DONE</code></td>
<td>当前处理函数未完成，存在阻塞调用，将控制权交给事件模块，在下次事件模块触发时，再次调用该方法。</td>
</tr>
<tr>
<td>其他</td>
<td>使用<code>ngx_http_finalize_request</code>结束请求</td>
</tr>
</tbody>
</table>
</div>
<p>这里的执行方法只有rewrite模块增加的处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_rewrite_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                     index;</span><br><span class="line">    ngx_http_script_code_pt       code;</span><br><span class="line">    <span class="keyword">ngx_http_script_engine_t</span>     *e;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>     *cscf;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>    *cmcf;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span>  *rlcf;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前层级下的 main数组中ngx_http_core_module配置</span></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 获取当前层级下的 srv数组中ngx_http_core_module配置</span></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 获取location_rewrite阶段的下标</span></span><br><span class="line">    index = cmcf-&gt;phase_engine.location_rewrite_index;</span><br><span class="line">    <span class="comment">// 如果当前处理阶段是location的重写，并且location层的loc_conf和server层的loc_conf一致。则跳过，server中没有location配置时，跳过该阶段</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;phase_handler == index &amp;&amp; r-&gt;loc_conf == cscf-&gt;ctx-&gt;loc_conf) &#123;</span><br><span class="line">        <span class="comment">/* skipping location rewrite phase for server null location */</span></span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取重写模块生成的结构</span></span><br><span class="line">    rlcf = ngx_http_get_module_loc_conf(r, ngx_http_rewrite_module);</span><br><span class="line">    <span class="comment">// 如果是空，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (rlcf-&gt;codes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配一个脚本引擎结构</span></span><br><span class="line">    e = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_engine_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配变量数组结构</span></span><br><span class="line">    e-&gt;sp = ngx_pcalloc(r-&gt;pool,</span><br><span class="line">                        rlcf-&gt;stack_size * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_value_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;sp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取执行数组的起始位置</span></span><br><span class="line">    e-&gt;ip = rlcf-&gt;codes-&gt;elts;</span><br><span class="line">    <span class="comment">// 设置请求</span></span><br><span class="line">    e-&gt;request = r;</span><br><span class="line">    e-&gt;quote = <span class="number">1</span>;</span><br><span class="line">    e-&gt;<span class="built_in">log</span> = rlcf-&gt;<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">// 默认处理完成执行下一阶段</span></span><br><span class="line">    e-&gt;status = NGX_DECLINED;</span><br><span class="line">    <span class="comment">// 依次执行codes数组中每个方法，直到null</span></span><br><span class="line">    <span class="keyword">while</span> (*(<span class="keyword">uintptr_t</span> *) e-&gt;ip) &#123;</span><br><span class="line">        code = *(ngx_http_script_code_pt *) e-&gt;ip;</span><br><span class="line">        code(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回状态</span></span><br><span class="line">    <span class="keyword">return</span> e-&gt;status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该部分需要配合rewrite模块的介绍查看。</p>
<p>需要注意的是，当前请求<code>r</code>中的<code>**main_conf</code>,<code>**srv_conf</code>,<code>**loc_conf</code>所处的层级与当前执行阶段一致。对应处于<code>server rewrite</code>阶段来说，这三个配置是<code>server</code>层级解析出的配置，因此执行的处理函数是server层级配置的<code>rewrite</code>模块相关配置方法。（在之前的处理中，通过Server name查找到的配置，赋值就是server层级，详见<code>ngx_http_set_virtual_server</code>函数）。对于<code>location rewrite</code>执行阶段来说，这三个配置是<code>location</code>层级解析出的配置，因此执行的处理函数是location层级配置的<code>rewrite</code>模块相关配置方法（在<code>NGX_HTTP_FIND_CONFIG_PHASE</code>阶段找到请求对应的location块后会重新对配置进行赋值，详见<code>ngx_http_update_location_config</code>方法）。</p>
<p>这里方法的值为<code>e-&gt;status</code>，因此如果配置了重定向时，该值会是重定向的返回码，这时会立即结束请求。在解析错误时，也需要设置<code>e-&gt;status</code>，以此来立即结束请求。</p>
<h2 id="NGX-HTTP-FIND-CONFIG-PHASE阶段"><a href="#NGX-HTTP-FIND-CONFIG-PHASE阶段" class="headerlink" title="NGX_HTTP_FIND_CONFIG_PHASE阶段"></a>NGX_HTTP_FIND_CONFIG_PHASE阶段</h2><p>该阶段checker方法为<code>ngx_http_core_find_config_phase</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_find_config_phase(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                    *p;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    r-&gt;content_handler = <span class="literal">NULL</span>;</span><br><span class="line">    r-&gt;uri_changed = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 根据uri查找匹配的location</span></span><br><span class="line">    rc = ngx_http_core_find_location(r);</span><br><span class="line">    <span class="comment">// 如果返回错误，则结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取location层级创建的ngx_http_core_loc_conf_t</span></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果请求不是内部的，但是该模块是内部可访问的则报错。请求是内部情况如下：</span></span><br><span class="line"><span class="comment">    ngx_http_rewrite_module模块中使用rewrite指令修改的请求。</span></span><br><span class="line"><span class="comment">    内部请求创建的子请求等</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;internal &amp;&amp; clcf-&gt;internal) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_NOT_FOUND);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"using configuration \"%s%V\""</span>,</span><br><span class="line">                   (clcf-&gt;noname ? <span class="string">"*"</span> : (clcf-&gt;exact_match ? <span class="string">"="</span> : <span class="string">""</span>)),</span><br><span class="line">                   &amp;clcf-&gt;name);</span><br><span class="line">    <span class="comment">// 根据获取的location，变更请求的相关参数</span></span><br><span class="line">    ngx_http_update_location_config(r);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http cl:%O max:%O"</span>,</span><br><span class="line">                   r-&gt;headers_in.content_length_n, clcf-&gt;client_max_body_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果请求的包体不为-1，并且不是要丢弃请求包体，并且设置了客户最大的请求包体，该值小于请求包体长度</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.content_length_n != <span class="number">-1</span></span><br><span class="line">        &amp;&amp; !r-&gt;discard_body</span><br><span class="line">        &amp;&amp; clcf-&gt;client_max_body_size</span><br><span class="line">        &amp;&amp; clcf-&gt;client_max_body_size &lt; r-&gt;headers_in.content_length_n)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"client intended to send too large body: %O bytes"</span>,</span><br><span class="line">                      r-&gt;headers_in.content_length_n);</span><br><span class="line"></span><br><span class="line">        r-&gt;expect_tested = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 接收请求头并丢弃</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_http_discard_request_body(r);</span><br><span class="line">        <span class="comment">// 结束请求</span></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_REQUEST_ENTITY_TOO_LARGE);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果返回done，这里只有精准匹配，获取前缀匹配能够返回该值</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line">        <span class="comment">// 清理返回的headers_out的location</span></span><br><span class="line">        ngx_http_clear_location(r);</span><br><span class="line">        <span class="comment">// 设置location</span></span><br><span class="line">        r-&gt;headers_out.location = ngx_list_push(&amp;r-&gt;headers_out.headers);</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_out.location == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置key为Location</span></span><br><span class="line">        r-&gt;headers_out.location-&gt;hash = <span class="number">1</span>;</span><br><span class="line">        ngx_str_set(&amp;r-&gt;headers_out.location-&gt;key, <span class="string">"Location"</span>);</span><br><span class="line">        <span class="comment">// 根据是否存在参数，设置location的value</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;args.len == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;headers_out.location-&gt;value = clcf-&gt;name;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            len = clcf-&gt;name.len + <span class="number">1</span> + r-&gt;args.len;</span><br><span class="line">            p = ngx_pnalloc(r-&gt;pool, len);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_http_clear_location(r);</span><br><span class="line">                ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r-&gt;headers_out.location-&gt;value.len = len;</span><br><span class="line">            r-&gt;headers_out.location-&gt;value.data = p;</span><br><span class="line"></span><br><span class="line">            p = ngx_cpymem(p, clcf-&gt;name.data, clcf-&gt;name.len);</span><br><span class="line">            *p++ = <span class="string">'?'</span>;</span><br><span class="line">            ngx_memcpy(p, r-&gt;args.data, r-&gt;args.len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重定向结束请求</span></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_MOVED_PERMANENTLY);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向后移动，执行下一个处理函数</span></span><br><span class="line">    r-&gt;phase_handler++;</span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码可以看出该阶段，查找location时返回值对应的含义如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>返回值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_ERROR</code></td>
<td>查找错误，结束请求</td>
</tr>
<tr>
<td><code>NGX_DONE</code></td>
<td>请求重定向，结束请求，向用户返回重定向</td>
</tr>
<tr>
<td>其他</td>
<td>完成当前处理函数，执行后面的处理函数</td>
</tr>
</tbody>
</table>
</div>
<h3 id="查找location方法ngx-http-core-find-location"><a href="#查找location方法ngx-http-core-find-location" class="headerlink" title="查找location方法ngx_http_core_find_location"></a>查找location方法ngx_http_core_find_location</h3><p>该函数负责通过uri查找location。其中返回值含义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * NGX_OK       - exact or regex match 精准匹配，或者正则匹配</span></span><br><span class="line"><span class="comment"> * NGX_DONE     - auto redirect 自动重定向</span></span><br><span class="line"><span class="comment"> * NGX_AGAIN    - inclusive match 前缀匹配</span></span><br><span class="line"><span class="comment"> * NGX_ERROR    - regex error 正则匹配错误</span></span><br><span class="line"><span class="comment"> * NGX_DECLINED - no match 无匹配</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>该部分需要节后配置解析一起查看。</p>
<p>执行逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_find_location(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *pclcf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 noregex;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf, **clcfp;</span><br><span class="line"></span><br><span class="line">    noregex = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取当前层级的ngx_http_core_loc_conf_t。当前层级可能是server层级和location层级（因为location层级可能包含location，这时有可能需要递归查找）</span></span><br><span class="line">    pclcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 先在精准匹配和前缀匹配值查找</span></span><br><span class="line">    rc = ngx_http_core_find_static_location(r, pclcf-&gt;static_locations);</span><br><span class="line">    <span class="comment">// 如果返回值为NGX_AGAIN，表示前缀匹配，这时需要进一步查找location下的location,使用最长匹配</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">        clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">        noregex = clcf-&gt;noregex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* look up nested locations */</span></span><br><span class="line">        <span class="comment">// 查找location下的location，如果当前location下没有location，将返回NGX_DECLINED</span></span><br><span class="line">        rc = ngx_http_core_find_location(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果找到的精准匹配，或者自动重定向，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK || rc == NGX_DONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_DECLINED or rc == NGX_AGAIN in nested location */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">// 查找正则匹配数组</span></span><br><span class="line">    <span class="keyword">if</span> (noregex == <span class="number">0</span> &amp;&amp; pclcf-&gt;regex_locations) &#123;</span><br><span class="line">        <span class="comment">// 遍历正则匹配数组</span></span><br><span class="line">        <span class="keyword">for</span> (clcfp = pclcf-&gt;regex_locations; *clcfp; clcfp++) &#123;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"test location: ~ \"%V\""</span>, &amp;(*clcfp)-&gt;name);</span><br><span class="line">            <span class="comment">// 执行正则匹配，这里可查看rewrite部分介绍的函数，这里会设置请求r中的captures，用于后续函数中使用正则捕获中的内容</span></span><br><span class="line">            n = ngx_http_regex_exec(r, (*clcfp)-&gt;regex, &amp;r-&gt;uri);</span><br><span class="line">            <span class="comment">// 如果正则匹配</span></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_OK) &#123;</span><br><span class="line">                <span class="comment">// 设置loc_conf</span></span><br><span class="line">                r-&gt;loc_conf = (*clcfp)-&gt;loc_conf;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* look up nested locations */</span></span><br><span class="line">                <span class="comment">// 查找该location下的location</span></span><br><span class="line">                rc = ngx_http_core_find_location(r);</span><br><span class="line">                <span class="comment">// 返回，如果出错，返回错误，否则返回正则匹配或精准匹配</span></span><br><span class="line">                <span class="keyword">return</span> (rc == NGX_ERROR) ? rc : NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果不匹配，则跳过，继续变量</span></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_DECLINED) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则返回错误</span></span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 返回之前设置的结果</span></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码可以看出，<code>location</code>匹配顺序为：精准匹配 &gt; 正则匹配 &gt; 前缀匹配</p>
<p>在精准匹配和前缀中查找的逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * NGX_OK       - exact match 精准匹配</span></span><br><span class="line"><span class="comment"> * NGX_DONE     - auto redirect 自动重定向</span></span><br><span class="line"><span class="comment"> * NGX_AGAIN    - inclusive match 前缀匹配</span></span><br><span class="line"><span class="comment"> * NGX_DECLINED - no match // 不匹配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_find_static_location(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span> *node)</span><br><span class="line">&#123;</span><br><span class="line">    u_char     *uri;</span><br><span class="line">    <span class="keyword">size_t</span>      len, n;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>   rc, rv;</span><br><span class="line"></span><br><span class="line">    len = r-&gt;uri.len;</span><br><span class="line">    uri = r-&gt;uri.data;</span><br><span class="line"></span><br><span class="line">    rv = NGX_DECLINED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 当node节点为空时，即没有精准匹配，或者前缀匹配时，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"test location: \"%*s\""</span>,</span><br><span class="line">                       (<span class="keyword">size_t</span>) node-&gt;len, node-&gt;name);</span><br><span class="line">        <span class="comment">// 长度使用uri长度和节点长度的较短者</span></span><br><span class="line">        n = (len &lt;= (<span class="keyword">size_t</span>) node-&gt;len) ? len : node-&gt;len;</span><br><span class="line">        <span class="comment">// 判断两者的给定长度部分字符串差值</span></span><br><span class="line">        rc = ngx_filename_cmp(uri, node-&gt;name, n);</span><br><span class="line">        <span class="comment">// 如果两者不一样大</span></span><br><span class="line">        <span class="keyword">if</span> (rc != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 根据大小决定继续在左子树还是右子树中查找</span></span><br><span class="line">            node = (rc &lt; <span class="number">0</span>) ? node-&gt;left : node-&gt;right;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果uri长度大于节点长度</span></span><br><span class="line">        <span class="keyword">if</span> (len &gt; (<span class="keyword">size_t</span>) node-&gt;len) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果节点为前缀匹配</span></span><br><span class="line">            <span class="keyword">if</span> (node-&gt;inclusive) &#123;</span><br><span class="line">                <span class="comment">// 向将请求的loc_conf指向当前节点的loc_conf，并设置返回值</span></span><br><span class="line">                r-&gt;loc_conf = node-&gt;inclusive-&gt;loc_conf;</span><br><span class="line">                rv = NGX_AGAIN;</span><br><span class="line">                <span class="comment">// 接下来从节点下的前缀列表中查找</span></span><br><span class="line">                node = node-&gt;tree;</span><br><span class="line">                <span class="comment">// 因为前缀列表中存储的name和len为相对与当前节点的偏移部分值，因此需要将uri也进行偏移</span></span><br><span class="line">                uri += n;</span><br><span class="line">                len -= n;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* exact only */</span></span><br><span class="line">            <span class="comment">// 如果当前节点只支持精准匹配，则需要接着查找右子树</span></span><br><span class="line">            node = node-&gt;right;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果uri长度和节点长度一致</span></span><br><span class="line">        <span class="keyword">if</span> (len == (<span class="keyword">size_t</span>) node-&gt;len) &#123;</span><br><span class="line">            <span class="comment">// 节点支持精准匹配，则设置loc_conf，并返回</span></span><br><span class="line">            <span class="keyword">if</span> (node-&gt;exact) &#123;</span><br><span class="line">                r-&gt;loc_conf = node-&gt;exact-&gt;loc_conf;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            <span class="comment">// 设置loc_conf，并返回查找到的结果为前缀匹配</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r-&gt;loc_conf = node-&gt;inclusive-&gt;loc_conf;</span><br><span class="line">                <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* len &lt; node-&gt;len */</span></span><br><span class="line">        <span class="comment">// 如果uri长度相对于节点长度大于1，并且节点设置了自动重定向，则设置loc_conf并返回。这里自动重定向在代理转发中会使用，后续详细介绍</span></span><br><span class="line">        <span class="keyword">if</span> (len + <span class="number">1</span> == (<span class="keyword">size_t</span>) node-&gt;len &amp;&amp; node-&gt;auto_redirect) &#123;</span><br><span class="line"></span><br><span class="line">            r-&gt;loc_conf = (node-&gt;exact) ? node-&gt;exact-&gt;loc_conf:</span><br><span class="line">                                          node-&gt;inclusive-&gt;loc_conf;</span><br><span class="line">            rv = NGX_DONE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node = node-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="更新请求ngx-http-update-location-config"><a href="#更新请求ngx-http-update-location-config" class="headerlink" title="更新请求ngx_http_update_location_config"></a>更新请求ngx_http_update_location_config</h3><p>该方法根据uri查找到的location配置，来更新对请求的限制。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_update_location_config(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="comment">// 获取location层级的ngx_http_core_loc_conf_t</span></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果配置了limit_except，则使用limit_except_loc_conf作为loc_conf</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;method &amp; clcf-&gt;limit_except) &#123;</span><br><span class="line">        r-&gt;loc_conf = clcf-&gt;limit_except_loc_conf;</span><br><span class="line">        clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求是用户请求，则设置log</span></span><br><span class="line">    <span class="keyword">if</span> (r == r-&gt;main) &#123;</span><br><span class="line">        ngx_set_connection_log(r-&gt;connection, clcf-&gt;error_log);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果设置了sendfile，并且系统支持sendfile，则设置标志位为1</span></span><br><span class="line"><span class="comment">    sendfule是linux支持的一个系统调用，在之前使用套接字传输文件内容时，需要使用read、write方法，首先从数据从内核态拷贝到用户态，再从用户态拷贝到内核态，这是十分耗时的，使用sendfile则避免来回拷贝，数据只在内核态传输。要使用sendfile，则配置：</span></span><br><span class="line"><span class="comment">    sendfile on</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((ngx_io.flags &amp; NGX_IO_SENDFILE) &amp;&amp; clcf-&gt;sendfile) &#123;</span><br><span class="line">        r-&gt;connection-&gt;sendfile = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r-&gt;connection-&gt;sendfile = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果设置了，用户post请求体只能存储在临时文件中</span></span><br><span class="line"><span class="comment">    配置为：client_body_in_file_only off|clean|on</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;client_body_in_file_only) &#123;</span><br><span class="line">        r-&gt;request_body_in_file_only = <span class="number">1</span>;</span><br><span class="line">        r-&gt;request_body_in_persistent_file = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 是否请求完成后就删除临时文件</span></span><br><span class="line">        r-&gt;request_body_in_clean_file =</span><br><span class="line">            clcf-&gt;client_body_in_file_only == NGX_HTTP_REQUEST_BODY_FILE_CLEAN;</span><br><span class="line">        r-&gt;request_body_file_log_level = NGX_LOG_NOTICE;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r-&gt;request_body_file_log_level = NGX_LOG_WARN;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    请求包体是否只存储在一个buf中</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    r-&gt;request_body_in_single_buf = clcf-&gt;client_body_in_single_buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果请求设置了长连接</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;keepalive) &#123;</span><br><span class="line">        <span class="comment">// 如果nginx设置的长连接超时时间为0，即不支持长连接</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;keepalive_timeout == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 如果设置长连接最大请求数量超过了设置值，则关闭长连接</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;connection-&gt;requests &gt;= clcf-&gt;keepalive_requests) &#123;</span><br><span class="line">            r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 下面为针对通顶浏览器处理</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;headers_in.msie6</span><br><span class="line">                   &amp;&amp; r-&gt;method == NGX_HTTP_POST</span><br><span class="line">                   &amp;&amp; (clcf-&gt;keepalive_disable</span><br><span class="line">                       &amp; NGX_HTTP_KEEPALIVE_DISABLE_MSIE6))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * MSIE may wait for some time if an response for</span></span><br><span class="line"><span class="comment">             * a POST request was sent over a keepalive connection</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;headers_in.safari</span><br><span class="line">                   &amp;&amp; (clcf-&gt;keepalive_disable</span><br><span class="line">                       &amp; NGX_HTTP_KEEPALIVE_DISABLE_SAFARI))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Safari may send a POST request to a closed keepalive</span></span><br><span class="line"><span class="comment">             * connection and may stall for some time, see</span></span><br><span class="line"><span class="comment">             *     https://bugs.webkit.org/show_bug.cgi?id=5760</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否开启tcp_nopush</span></span><br><span class="line">    <span class="keyword">if</span> (!clcf-&gt;tcp_nopush) &#123;</span><br><span class="line">        <span class="comment">/* disable TCP_NOPUSH/TCP_CORK use */</span></span><br><span class="line">        r-&gt;connection-&gt;tcp_nopush = NGX_TCP_NOPUSH_DISABLED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果location配置设置了handler，则设置连接的处理函数，使用见NGX_HTTP_CONTENT_PHASE阶段</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;handler) &#123;</span><br><span class="line">        r-&gt;content_handler = clcf-&gt;handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NGX-HTTP-REWRITE-PHASE阶段"><a href="#NGX-HTTP-REWRITE-PHASE阶段" class="headerlink" title="NGX_HTTP_REWRITE_PHASE阶段"></a>NGX_HTTP_REWRITE_PHASE阶段</h2><p>该阶段是在location中设置了重写时的处理。</p>
<p>其使用的checker方法和handler方法与NGX_HTTP_SERVER_REWRITE_PHASE阶段一致。这里需要注意的是，这时使用的配置是location层级的配置。</p>
<h2 id="NGX-HTTP-REWRITE-PHASE阶段-1"><a href="#NGX-HTTP-REWRITE-PHASE阶段-1" class="headerlink" title="NGX_HTTP_REWRITE_PHASE阶段"></a>NGX_HTTP_REWRITE_PHASE阶段</h2><p><code>NGX_HTTP_REWRITE_PHASE</code>阶段用于在location阶段后判断是否需要再次进行查找。</p>
<p>check方法为：<code>ngx_http_core_post_rewrite_phase</code>,逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_post_rewrite_phase(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"post rewrite phase: %ui"</span>, r-&gt;phase_handler);</span><br><span class="line">    <span class="comment">// 如果经过NGX_HTTP_REWRITE_PHASE阶段，没有发送uri变更，则继续执行下一个处理方法</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;uri_changed) &#123;</span><br><span class="line">        r-&gt;phase_handler++;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"uri changes: %d"</span>, r-&gt;uri_changes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * gcc before 3.3 compiles the broken code for</span></span><br><span class="line"><span class="comment">     *     if (r-&gt;uri_changes-- == 0)</span></span><br><span class="line"><span class="comment">     * if the r-&gt;uri_changes is defined as</span></span><br><span class="line"><span class="comment">     *     unsigned  uri_changes:4</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 否则，将uri变更次数减1，起始为11</span></span><br><span class="line">    r-&gt;uri_changes--;</span><br><span class="line">    <span class="comment">// 如果值到0了，则认为配置存在环，报错</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;uri_changes == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"rewrite or internal redirection cycle "</span></span><br><span class="line">                      <span class="string">"while processing \"%V\""</span>, &amp;r-&gt;uri);</span><br><span class="line">        <span class="comment">// 结束请求</span></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行下一阶段，这里的下一阶段是NGX_HTTP_REWRITE_PHASE阶段</span></span><br><span class="line">    r-&gt;phase_handler = ph-&gt;next;</span><br><span class="line">    <span class="comment">// 设置loc_conf为server层级的loc_conf，重新执行查找</span></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">    r-&gt;loc_conf = cscf-&gt;ctx-&gt;loc_conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NGX-HTTP-PREACCESS-PHASE"><a href="#NGX-HTTP-PREACCESS-PHASE" class="headerlink" title="NGX_HTTP_PREACCESS_PHASE"></a>NGX_HTTP_PREACCESS_PHASE</h2><p>该阶段一般针对当前请求进行限制。其处理checker为通用的<code>ngx_http_core_generic_phase</code>，方法这里不做详细介绍。其中执行的模块主要有<code>ngx_http_limit_conn_module</code>和<code>ngx_http_limit_req_module</code>模块，这里主要介绍一下<code>ngx_http_limit_req_module</code>模块的实现。</p>
<p>对于<code>ngx_http_limit_req_module</code>模块的具体实现和介绍，参考一些重要模块中对该模块的介绍。</p>
<h2 id="NGX-HTTP-ACCESS-PHASE阶段"><a href="#NGX-HTTP-ACCESS-PHASE阶段" class="headerlink" title="NGX_HTTP_ACCESS_PHASE阶段"></a>NGX_HTTP_ACCESS_PHASE阶段</h2><p>该阶段进行权限的校验。</p>
<p>checker丰富为：<code>ngx_http_core_access_phase</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_access_phase(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main) &#123;</span><br><span class="line">        r-&gt;phase_handler = ph-&gt;next;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"access phase: %ui"</span>, r-&gt;phase_handler);</span><br><span class="line">    <span class="comment">// 执行处理函数</span></span><br><span class="line">    rc = ph-&gt;handler(r);</span><br><span class="line">    <span class="comment">// 返回NGX_DECLINED，继续执行下一个处理函数</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        r-&gt;phase_handler++;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回NGX_AGAIN或者NGX_DONE说明当前处理未完成，存在阻塞，将控制权交还给epoll，下次事件到达时继续执行</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN || rc == NGX_DONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取访问控制限制类型</span></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// satisfy对应配置satisfy，取值为any或者all（默认），分别表示所有权限校验均通过才能执行该请求和任意一个权限校验通过即可执行该请求</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;satisfy == NGX_HTTP_SATISFY_ALL) &#123;</span><br><span class="line">        <span class="comment">// 如果是所有权限校验均通过，并且本次的校验通过，则执行下一个处理函数</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            r-&gt;phase_handler++;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 如果是任意一个校验通过即可，则</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果当前的校验通过</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            <span class="comment">// 设置access_code为0，表示通过校验</span></span><br><span class="line">            r-&gt;access_code = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;headers_out.www_authenticate) &#123;</span><br><span class="line">                r-&gt;headers_out.www_authenticate-&gt;hash = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 执行下一阶段的处理函数</span></span><br><span class="line">            r-&gt;phase_handler = ph-&gt;next;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果本次权限校验返回权限禁止或者未授权</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_HTTP_FORBIDDEN || rc == NGX_HTTP_UNAUTHORIZED) &#123;</span><br><span class="line">            <span class="comment">// 设置access_code为当前校验失败原因</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;access_code != NGX_HTTP_UNAUTHORIZED) &#123;</span><br><span class="line">                r-&gt;access_code = rc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 执行下一阶段</span></span><br><span class="line">            r-&gt;phase_handler++;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_ERROR || rc == NGX_HTTP_...  */</span></span><br><span class="line">    <span class="comment">// 如果出现为授权，且satisfy是all，判断是否需要进行延迟处理，当配置了auth_delay时，默认没有，直接关闭请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_HTTP_UNAUTHORIZED) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_core_auth_delay(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_finalize_request(r, rc);</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从中我们可以看出该阶段处理函数返回值对应的含义如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>返回值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_OK</code></td>
<td>如果设置satisfy为all，则按顺序执行下一个处理方法，如果设置satisfy为any则执行下一阶段的处理方法。</td>
</tr>
<tr>
<td><code>NGX_DECLINED</code></td>
<td>按顺序执行下一阶段的处理方法</td>
</tr>
<tr>
<td><code>NGX_AGAIN/NGX_DONE</code></td>
<td>当前的处理未完成，将控制权交还epoll，下次继续执行当前处理方法。</td>
</tr>
<tr>
<td><code>NGX_HTTP_FORBIDDEN/NGX_HTTP_UNAUTHORIZED</code></td>
<td>如果设置satisfy为all，结束请求，如果设置satisfy为any则设置access_code成员，并执行下一个处理方法。</td>
</tr>
<tr>
<td>其他、<code>NGX_ERROR</code></td>
<td>结束请求</td>
</tr>
</tbody>
</table>
</div>
<p>该阶段的模块主要包括<code>ngx_http_access_module</code>模块，<code>ngx_http_auth_basic_module</code>模块和<code>ngx_http_auth_request_module</code>模块。其中前两个模块较为简单，最后一个模块涉及subrequest（后续会详细介绍），因此这里都不做详细介绍。这里只简单介绍一下使用。</p>
<h3 id="ngx-http-access-module"><a href="#ngx-http-access-module" class="headerlink" title="ngx_http_access_module"></a>ngx_http_access_module</h3><p>该模块通过简单的配置来限制请求来源的ip。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    deny  192.168.1.1;</span><br><span class="line">    allow 192.168.1.0/24;</span><br><span class="line">    allow 10.1.1.0/16;</span><br><span class="line">    allow 2001:0db8::/32;</span><br><span class="line">    deny  all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-auth-basic-module"><a href="#ngx-http-auth-basic-module" class="headerlink" title="ngx_http_auth_basic_module"></a>ngx_http_auth_basic_module</h3><p>ngx_http_auth_basic_module 模块允许通过使用“HTTP 基本身份验证”协议验证用户名和密码来限制对资源的访问。</p>
<h3 id="ngx-http-auth-request-module"><a href="#ngx-http-auth-request-module" class="headerlink" title="ngx_http_auth_request_module"></a>ngx_http_auth_request_module</h3><p>ngx_http_auth_request_module 模块根据子请求的结果实现客户端授权。 如果子请求返回 2xx 响应码，则允许访问。 如果返回 401 或 403，则访问被拒绝并返回相应的错误代码。 子请求返回的任何其他响应代码都被视为错误。</p>
<h2 id="NGX-HTTP-POST-ACCESS-PHASE阶段"><a href="#NGX-HTTP-POST-ACCESS-PHASE阶段" class="headerlink" title="NGX_HTTP_POST_ACCESS_PHASE阶段"></a>NGX_HTTP_POST_ACCESS_PHASE阶段</h2><p>该阶段对NGX_HTTP_ACCESS_PHASE阶段的结果进行处理。不允许用户插入处理函数。checker方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_post_access_phase(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  access_code;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"post access phase: %ui"</span>, r-&gt;phase_handler);</span><br><span class="line">    <span class="comment">// 获取NGX_HTTP_ACCESS_PHASE返回的权限code</span></span><br><span class="line">    access_code = r-&gt;access_code;</span><br><span class="line">    <span class="comment">// 不为0，表示无权限</span></span><br><span class="line">    <span class="keyword">if</span> (access_code) &#123;</span><br><span class="line">        r-&gt;access_code = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (access_code == NGX_HTTP_FORBIDDEN) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"access forbidden by rule"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> (access_code == NGX_HTTP_UNAUTHORIZED) &#123;</span><br><span class="line">            <span class="keyword">return</span> ngx_http_core_auth_delay(r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_finalize_request(r, access_code);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 有权限时执行后续处理。</span></span><br><span class="line">    r-&gt;phase_handler++;</span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NGX-HTTP-PRECONTENT-PHASE阶段"><a href="#NGX-HTTP-PRECONTENT-PHASE阶段" class="headerlink" title="NGX_HTTP_PRECONTENT_PHASE阶段"></a>NGX_HTTP_PRECONTENT_PHASE阶段</h2><p>该阶段以前主要是<code>try_files</code>的处理，现在在次基础上增加了<code>ngx_http_mirror_module</code>模块，其checker方法为通用的<code>ngx_http_core_generic_phase</code>方法。对应try_file的处理也相对简单，这里也不做详细介绍。</p>
<h2 id="NGX-HTTP-CONTENT-PHASE阶段"><a href="#NGX-HTTP-CONTENT-PHASE阶段" class="headerlink" title="NGX_HTTP_CONTENT_PHASE阶段"></a>NGX_HTTP_CONTENT_PHASE阶段</h2><p>该阶段为核心http处理阶段，该阶段允许用户重新定义nginx服务的行为，是大部分模块介入的阶段。其checker方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_content_phase(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>     root;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  rc;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>  path;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果请求设置了content_handler方法，则直接执行该方法，结束请求</span></span><br><span class="line"><span class="comment">    该方法为location层级的ngx_http_core_loc_conf_t结构的handler方法</span></span><br><span class="line"><span class="comment">    NGX_HTTP_FIND_CONFIG_PHASE阶段根据查找到的location层级配置对其赋值</span></span><br><span class="line"><span class="comment">    因此模块要想直接介入处理，可以在解析配置时设置对应location下的handler方法。</span></span><br><span class="line"><span class="comment">    后续详细介绍的代理转发模块就是直接介入该阶段</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;content_handler) &#123;</span><br><span class="line">        r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line">        ngx_http_finalize_request(r, r-&gt;content_handler(r));</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"content phase: %ui"</span>, r-&gt;phase_handler);</span><br><span class="line">    <span class="comment">// 如果未设置handler方法，则执行默认的架构处理逻辑</span></span><br><span class="line">    rc = ph-&gt;handler(r);</span><br><span class="line">    <span class="comment">// 如果返回不为NGX_DECLINED，则结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc != NGX_DECLINED) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, rc);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_DECLINED */</span></span><br><span class="line">    <span class="comment">// 返回是NGX_DECLINED是，判断后续还是否有处理函数，有的化就进入下一个方法的处理</span></span><br><span class="line">    ph++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ph-&gt;checker) &#123;</span><br><span class="line">        r-&gt;phase_handler++;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* no content handler was found */</span></span><br><span class="line">    <span class="comment">// 结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;uri.data[r-&gt;uri.len - <span class="number">1</span>] == <span class="string">'/'</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_map_uri_to_path(r, &amp;path, &amp;root, <span class="number">0</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"directory index of \"%s\" is forbidden"</span>, path.data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_FORBIDDEN);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"no handler found"</span>);</span><br><span class="line"></span><br><span class="line">    ngx_http_finalize_request(r, NGX_HTTP_NOT_FOUND);</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面展示了为何自定义模块可以直接介入该模块的处理方法。对于模块直接通过handler方式介入，后续会在代理转发中详细介绍，这里先简单看一下结构自定义的一些处理逻辑，表示在没有handler处理情况下的一些默认处理。</p>
<p>这里简单介绍一下<code>ngx_http_static_module</code>模块，看一下架构自定义的处理函数，并引出如何向客户端返回结果，为下一章节做一个铺垫。</p>
<h3 id="ngx-http-static-module模块"><a href="#ngx-http-static-module模块" class="headerlink" title="ngx_http_static_module模块"></a>ngx_http_static_module模块</h3><p>模块的作用就是读取磁盘上的静态文件，并把文件内容作为产生的输出。其实现为，根据用户的uri和nginx运行目录，查找是否有对应的文件，如果有，则向用户返回对应的文件，如果是一个目录，则交给<code>ngx_http_autoindex_handler</code>模块处理（也是该阶段的默认处理逻辑）可以列出这个目录的文件，或者是ngx_http_index_handler如果请求的路径下面有个默认的index文件，直接返回index文件的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static ngx_http_module_t  ngx_http_static_module_ctx = &#123;</span><br><span class="line">    NULL,                                  /* preconfiguration */</span><br><span class="line">    ngx_http_static_init,                  /* postconfiguration */</span><br><span class="line"></span><br><span class="line">    NULL,                                  /* create main configuration */</span><br><span class="line">    NULL,                                  /* init main configuration */</span><br><span class="line"></span><br><span class="line">    NULL,                                  /* create server configuration */</span><br><span class="line">    NULL,                                  /* merge server configuration */</span><br><span class="line"></span><br><span class="line">    NULL,                                  /* create location configuration */</span><br><span class="line">    NULL                                   /* merge location configuration */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ngx_module_t  ngx_http_static_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_http_static_module_ctx,           /* module context */</span><br><span class="line">    NULL,                                  /* module directives */</span><br><span class="line">    NGX_HTTP_MODULE,                       /* module type */</span><br><span class="line">    NULL,                                  /* init master */</span><br><span class="line">    NULL,                                  /* init module */</span><br><span class="line">    NULL,                                  /* init process */</span><br><span class="line">    NULL,                                  /* init thread */</span><br><span class="line">    NULL,                                  /* exit thread */</span><br><span class="line">    NULL,                                  /* exit process */</span><br><span class="line">    NULL,                                  /* exit master */</span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>该模块的处理相当简单，甚至没有comands配置。其postconfiguration方法也十分简单，功能只有一个，就是将<code>ngx_http_static_handler</code>方法添加到<code>NGX_HTTP_CONTENT_PHASE</code>阶段的处理函数数组中。</p>
<h4 id="ngx-http-static-handler方法"><a href="#ngx-http-static-handler方法" class="headerlink" title="ngx_http_static_handler方法"></a>ngx_http_static_handler方法</h4><p>这里仅简单介绍处理方法，详细细节可查看对应源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_static_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                    *last, *location;</span><br><span class="line">    <span class="keyword">size_t</span>                     root, len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  path;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 level;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                out;</span><br><span class="line">    <span class="keyword">ngx_open_file_info_t</span>       of;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="comment">// 如果请求不是get、head或者post，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!(r-&gt;method &amp; (NGX_HTTP_GET|NGX_HTTP_HEAD|NGX_HTTP_POST))) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_NOT_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果uri是目录，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;uri.data[r-&gt;uri.len - <span class="number">1</span>] == <span class="string">'/'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = r-&gt;connection-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ngx_http_map_uri_to_path() allocates memory for terminating '\0'</span></span><br><span class="line"><span class="comment">     * so we do not need to reserve memory for '/' for possible redirect</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 使用uri拼接root，构建文件名</span></span><br><span class="line">    last = ngx_http_map_uri_to_path(r, &amp;path, &amp;root, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (last == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    path.len = last - path.data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http filename: \"%s\""</span>, path.data);</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 分配文件结构</span></span><br><span class="line">    ngx_memzero(&amp;of, <span class="keyword">sizeof</span>(<span class="keyword">ngx_open_file_info_t</span>));</span><br><span class="line"></span><br><span class="line">    of.read_ahead = clcf-&gt;read_ahead;</span><br><span class="line">    of.directio = clcf-&gt;directio;</span><br><span class="line">    of.valid = clcf-&gt;open_file_cache_valid;</span><br><span class="line">    of.min_uses = clcf-&gt;open_file_cache_min_uses;</span><br><span class="line">    of.errors = clcf-&gt;open_file_cache_errors;</span><br><span class="line">    of.events = clcf-&gt;open_file_cache_events;</span><br><span class="line">    <span class="comment">// 检查是否为软链，并查看是否允许软链，即disable_symlinks配置限制</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_set_disable_symlinks(r, clcf, &amp;path, &amp;of) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_open_cached_file(clcf-&gt;open_file_cache, &amp;path, &amp;of, r-&gt;pool)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">// 错误处理</span></span><br><span class="line">        <span class="keyword">switch</span> (of.err) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> NGX_ENOENT:</span><br><span class="line">        <span class="keyword">case</span> NGX_ENOTDIR:</span><br><span class="line">        <span class="keyword">case</span> NGX_ENAMETOOLONG:</span><br><span class="line"></span><br><span class="line">            level = NGX_LOG_ERR;</span><br><span class="line">            rc = NGX_HTTP_NOT_FOUND;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> NGX_EACCES:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_OPENAT)</span></span><br><span class="line">        <span class="keyword">case</span> NGX_EMLINK:</span><br><span class="line">        <span class="keyword">case</span> NGX_ELOOP:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            level = NGX_LOG_ERR;</span><br><span class="line">            rc = NGX_HTTP_FORBIDDEN;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">            level = NGX_LOG_CRIT;</span><br><span class="line">            rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc != NGX_HTTP_NOT_FOUND || clcf-&gt;log_not_found) &#123;</span><br><span class="line">            ngx_log_error(level, <span class="built_in">log</span>, of.err,</span><br><span class="line">                          <span class="string">"%s \"%s\" failed"</span>, of.failed, path.data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;root_tested = !r-&gt;error_page;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http static fd: %d"</span>, of.fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是目录返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (of.is_dir) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http dir"</span>);</span><br><span class="line"></span><br><span class="line">        ngx_http_clear_location(r);</span><br><span class="line"></span><br><span class="line">        r-&gt;headers_out.location = ngx_list_push(&amp;r-&gt;headers_out.headers);</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_out.location == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = r-&gt;uri.len + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!clcf-&gt;alias &amp;&amp; r-&gt;args.len == <span class="number">0</span>) &#123;</span><br><span class="line">            location = path.data + root;</span><br><span class="line"></span><br><span class="line">            *last = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (r-&gt;args.len) &#123;</span><br><span class="line">                len += r-&gt;args.len + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            location = ngx_pnalloc(r-&gt;pool, len);</span><br><span class="line">            <span class="keyword">if</span> (location == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_http_clear_location(r);</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            last = ngx_copy(location, r-&gt;uri.data, r-&gt;uri.len);</span><br><span class="line"></span><br><span class="line">            *last = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;args.len) &#123;</span><br><span class="line">                *++last = <span class="string">'?'</span>;</span><br><span class="line">                ngx_memcpy(++last, r-&gt;args.data, r-&gt;args.len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;headers_out.location-&gt;hash = <span class="number">1</span>;</span><br><span class="line">        ngx_str_set(&amp;r-&gt;headers_out.location-&gt;key, <span class="string">"Location"</span>);</span><br><span class="line">        r-&gt;headers_out.location-&gt;value.len = len;</span><br><span class="line">        r-&gt;headers_out.location-&gt;value.data = location;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_MOVED_PERMANENTLY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(NGX_WIN32) <span class="comment">/* the not regular files are probably Unix specific */</span></span></span><br><span class="line">    <span class="comment">// 不是文件，报错</span></span><br><span class="line">    <span class="keyword">if</span> (!of.is_file) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"\"%s\" is not a regular file"</span>, path.data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// post请求报错</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;method == NGX_HTTP_POST) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_NOT_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 丢弃请求体</span></span><br><span class="line">    rc = ngx_http_discard_request_body(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;action = <span class="string">"sending response to client"</span>;</span><br><span class="line">    <span class="comment">// 设置响应头</span></span><br><span class="line">    r-&gt;headers_out.status = NGX_HTTP_OK;</span><br><span class="line">    r-&gt;headers_out.content_length_n = of.size;</span><br><span class="line">    r-&gt;headers_out.last_modified_time = of.mtime;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ngx_http_set_etag(r) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_set_content_type(r) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main &amp;&amp; of.size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_send_header(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;allow_ranges = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* we need to allocate all before the header would be sent */</span></span><br><span class="line">    <span class="comment">// 创建存储响应体的buf结构</span></span><br><span class="line">    b = ngx_calloc_buf(r-&gt;pool);</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b-&gt;file = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_file_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (b-&gt;file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送响应头</span></span><br><span class="line">    rc = ngx_http_send_header(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK || r-&gt;header_only) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置发送响应体的buf</span></span><br><span class="line">    b-&gt;file_pos = <span class="number">0</span>;</span><br><span class="line">    b-&gt;file_last = of.size;</span><br><span class="line"></span><br><span class="line">    b-&gt;in_file = b-&gt;file_last ? <span class="number">1</span>: <span class="number">0</span>;</span><br><span class="line">    b-&gt;last_buf = (r == r-&gt;main) ? <span class="number">1</span>: <span class="number">0</span>;</span><br><span class="line">    b-&gt;last_in_chain = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    b-&gt;file-&gt;fd = of.fd;</span><br><span class="line">    b-&gt;file-&gt;name = path;</span><br><span class="line">    b-&gt;file-&gt;<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    b-&gt;file-&gt;directio = of.is_directio;</span><br><span class="line"></span><br><span class="line">    out.buf = b;</span><br><span class="line">    out.next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 发送响应体</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_output_filter(r, &amp;out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NGX-HTTP-LOG-PHASE阶段"><a href="#NGX-HTTP-LOG-PHASE阶段" class="headerlink" title="NGX_HTTP_LOG_PHASE阶段"></a>NGX_HTTP_LOG_PHASE阶段</h2><p>该阶段赋值写日志，这里不做详细介绍。需要注意的是，无论请求在合阶段结束，正常都会在结束时执行该阶段的处理函数。</p>
<h2 id="发送响应"><a href="#发送响应" class="headerlink" title="发送响应"></a>发送响应</h2><h3 id="相关结构-2"><a href="#相关结构-2" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-http-headers-out-t响应头"><a href="#ngx-http-headers-out-t响应头" class="headerlink" title="ngx_http_headers_out_t响应头"></a>ngx_http_headers_out_t响应头</h4><p><code>ngx_http_headers_out_t</code>结构存储了响应头信息，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 待发送的http头部链表，与headers_in的headers类似</span></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                        headers;</span><br><span class="line">    <span class="keyword">ngx_list_t</span>                        trailers;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 响应状态码</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        status;</span><br><span class="line">    <span class="comment">// 响应行， 如 "HTTP/1.1 201 CREATED"</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         status_line;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下面成员均为RFC1616规范中对应的HTTP响应头部，设置后ngx_http_header_filter_module过滤模块可以把他们加到待发送的网络包中</span></span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *server;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *date;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *content_length;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *content_encoding;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *location;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *refresh;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *last_modified;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *content_range;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *accept_ranges;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *www_authenticate;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *expires;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>                  *etag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                        *override_charset;</span><br><span class="line">    <span class="comment">// 可以调用ngx_http_set_content_type来设置content_type头部，该方法根据URI中的扩展名和mime.type来设置content_type</span></span><br><span class="line">    <span class="keyword">size_t</span>                            content_type_len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         content_type;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         charset;</span><br><span class="line">    u_char                           *content_type_lowcase;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        content_type_hash;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                       cache_control;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>                       link;</span><br><span class="line">    <span class="comment">// 这里设置了响应长度后，不用再次到ngx_table_elt_t *content_length中设置响应长度</span></span><br><span class="line">    <span class="keyword">off_t</span>                             content_length_n;</span><br><span class="line">    <span class="keyword">off_t</span>                             content_offset;</span><br><span class="line">    <span class="keyword">time_t</span>                            date_time;</span><br><span class="line">    <span class="keyword">time_t</span>                            last_modified_time;</span><br><span class="line">&#125; <span class="keyword">ngx_http_headers_out_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="发送响应头ngx-http-send-header"><a href="#发送响应头ngx-http-send-header" class="headerlink" title="发送响应头ngx_http_send_header"></a>发送响应头ngx_http_send_header</h3><p>函数执行逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_send_header(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果是post_action则直接返回，可查看post_action配置详细了解使用</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;post_action) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果请求头已经发送，则报错返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_sent) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"header already sent"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求存在错误，则设置请求头</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;err_status) &#123;</span><br><span class="line">        r-&gt;headers_out.status = r-&gt;err_status;</span><br><span class="line">        r-&gt;headers_out.status_line.len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行发送响应头的过滤模块</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_top_header_filter(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送响应体ngx-http-output-filter"><a href="#发送响应体ngx-http-output-filter" class="headerlink" title="发送响应体ngx_http_output_filter"></a>发送响应体ngx_http_output_filter</h3><p>该函数用来发送响应体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_output_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>          rc;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http output filter \"%V?%V\""</span>, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">    <span class="comment">// 执行发送响应体过滤方法</span></span><br><span class="line">    rc = ngx_http_top_body_filter(r, in);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="comment">/* NGX_ERROR may be returned by any filter */</span></span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送响应过滤模块"><a href="#发送响应过滤模块" class="headerlink" title="发送响应过滤模块"></a>发送响应过滤模块</h3><p>对于发送响应来说，分为发送响应头和响应体，这两个发送响应模块均支持用户自定义处理逻辑，对于定义的处理逻辑来说，使用<code>ngx_http_top_header_filter</code>和<code>ngx_http_next_header_filter</code>来串联响应头发送链表，使用<code>ngx_http_top_body_filter</code>和<code>ngx_http_next_body_filter</code>串联请求体发送响应链表。</p>
<p>过滤模块的处理函数定义为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef char *(*ngx_conf_post_handler_pt) (ngx_conf_t *cf,</span><br><span class="line">    void *data, void *conf);</span><br></pre></td></tr></table></figure>
<p>任意一个模块想要介入请求头或请求体的处理，只需要踏进如下函数即可（以ngx_http_gzip_filter_module模块举例）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_output_header_filter_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意，这里的chain是要传输的数据，对应chain为空，表示传输未完成但没有新增加的数据需要传输，这一点很关键，</span></span><br><span class="line"><span class="comment">由于写响应体的过滤函数可能会被执行多次，该值会被大部分阶段用于判断是否需要介入处理</span></span><br><span class="line"><span class="comment">后续会详细介绍</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_output_body_filter_pt)</span></span></span><br><span class="line"><span class="function">    <span class="params">(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *chain)</span></span>;</span><br><span class="line"></span><br><span class="line">ngx_http_output_header_filter_pt  ngx_http_top_header_filter;</span><br><span class="line">ngx_http_output_body_filter_pt    ngx_http_top_body_filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ngx_http_output_header_filter_pt  ngx_http_next_header_filter;</span><br><span class="line"><span class="keyword">static</span> ngx_http_output_body_filter_pt    ngx_http_next_body_filter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">该函数为模块ctx的postconfiguration函数</span></span><br><span class="line"><span class="comment">其中ngx_http_gzip_header_filter，和ngx_http_gzip_body_filter均为该模块定义的处理函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_gzip_filter_init(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_next_header_filter = ngx_http_top_header_filter;</span><br><span class="line">    ngx_http_top_header_filter = ngx_http_gzip_header_filter;</span><br><span class="line"></span><br><span class="line">    ngx_http_next_body_filter = ngx_http_top_body_filter;</span><br><span class="line">    ngx_http_top_body_filter = ngx_http_gzip_body_filter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_gzip_header_filter(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...</span></span><br><span class="line"><span class="comment">    该模块定义的处理逻辑</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// 执行ngx_http_next_header_filter模块方法</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_next_header_filter(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_gzip_body_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...</span></span><br><span class="line"><span class="comment">    该模块自定义处理方法</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">        <span class="comment">// 执行ngx_http_next_body_filter方法</span></span><br><span class="line">        rc = ngx_http_next_body_filter(r, ctx-&gt;out);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    模块自定义处理方法</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码可以看出nginx如果将各个模块的响应头filter函数和响应体filter串联起来。</p>
<p>其中<code>ngx_http_top_header_filter</code>和<code>ngx_http_top_body_filter</code>模块存储了当前设置的响应头和响应体处理函数，<code>ngx_http_next_header_filter</code>和<code>ngx_http_next_body_filter</code>是作用域为文件作用域的static函数值。当该模块希望在处理响应头和响应体之前先按照该模块进行处理，则向让<code>ngx_http_next_header_filter</code>和<code>ngx_http_next_body_filter</code>存储之前旧的处理方法，再设置<code>ngx_http_top_header_filter</code>和<code>ngx_http_top_body_filter</code>为本模块的新的处理方法。在执行本模块的逻辑之后，执行<code>ngx_http_next_header_filter</code>和<code>ngx_http_next_body_filter</code>方法，即原来的<code>ngx_http_top_header_filter</code>和<code>ngx_http_top_body_filter</code>方法。这样就成功将本模块的处理方法加到了处理序列的头部。</p>
<p>通过这种方式，将所有希望对响应头和响应体执行处理的方法进行串联。因此这时处理的顺序就十分重要，每个模块的添加阶段都是在ctx的postconfiguration方法中，并且每个模块总是将本模块的处理方法添加到序列的头部，因此处理顺序与每个模块执行postconfiguration方法的顺序相反：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&amp;ngx_http_write_filter_module,</span><br><span class="line">&amp;ngx_http_header_filter_module,</span><br><span class="line">&amp;ngx_http_chunked_filter_module,</span><br><span class="line">&amp;ngx_http_range_header_filter_module,</span><br><span class="line">&amp;ngx_http_gzip_filter_module,</span><br><span class="line">&amp;ngx_http_postpone_filter_module,</span><br><span class="line">&amp;ngx_http_ssi_filter_module,</span><br><span class="line">&amp;ngx_http_charset_filter_module,</span><br><span class="line">&amp;ngx_http_userid_filter_module,</span><br><span class="line">&amp;ngx_http_headers_filter_module,</span><br><span class="line">&amp;ngx_http_copy_filter_module,</span><br><span class="line">&amp;ngx_http_range_body_filter_module,</span><br><span class="line">&amp;ngx_http_not_modified_filter_module,</span><br></pre></td></tr></table></figure>
<p>上述为官方定义的响应filter处理模块及其顺序，因此实际执行的顺序与上述顺序相反。</p>
<p>这里比较典型的，常用的模块是<code>ngx_http_headers_filter_module</code>模块和<code>ngx_http_gzip_filter_module</code>模块。</p>
<p><code>ngx_http_headers_filter_module</code>模块支持通过配置<code>add_header</code>参数。来增加响应头，例如支持跨域配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;  </span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line">    add_header Access-Control-Allow-Methods &apos;GET, POST, OPTIONS&apos;;</span><br><span class="line">    add_header Access-Control-Allow-Headers &apos;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&apos;;</span><br><span class="line"></span><br><span class="line">    if ($request_method = &apos;OPTIONS&apos;) &#123;</span><br><span class="line">        return 204;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ngx_http_gzip_filter_module</code>模块用来对响应进行gzip压缩。要使用gzip压缩时，首先会在header方法中增加响应头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Encoding:gzip</span><br></pre></td></tr></table></figure>
<p>在下发响应体时，会按照设置的<code>gzip</code>进行压缩。</p>
<p>其中<code>ngx_http_write_filter_module</code>和<code>ngx_http_header_filter_module</code>分别定义了最后的响应体处理函数和响应头处理函数，后续会专门进行详细讲解。其中定义的发送响应头和响应体函数分别为：<code>ngx_http_write_filter</code>和<code>ngx_http_header_filter</code>，其<code>ngx_http_write_filter</code>为实际传输数据的处理方法，<code>ngx_http_header_filter</code>方法在完成请求头的拼接序列化后，也会调用<code>ngx_http_write_filter</code>方法。</p>
<p>这里有一个是否重要的需要注意的点，即nginx是全异步多阶段处理模式，因此在发送响应时也是不允许阻塞的。在发送响应头时，是不能存在阻塞的函数的，即下发的过程中，每个处理函数应该都不能是阻塞的，直到最终执行数据发送阶段即<code>ngx_http_write_filter</code>函数阶段。对于只有响应只有响应头来说，如果在该阶段存在阻塞，则会设置请求的写事件为<code>ngx_http_write</code>方法，调用事件驱动来进行后续的数据发送。</p>
<p>对于存在响应体的响应来说，如果发送响应头时执行的<code>ngx_http_write_filter</code>方法是阻塞的，则会将未传输的数据添加到请求的<code>out</code>结构中，后续发送响应体时，会向out中再添加数据，并将写事件添加到事件模块中，通过事件发送响应。</p>
<p>需要着重注意的是，发送请求响应的filter链表会执行多次，因此需要每个函数自己来实现避免重复执行。</p>
<p>发送请求响应filter被执行多次的原因主要有如下原因：</p>
<ol>
<li>仅需要发送响应头，但响应头未一次下发完全，此时会将请求的写事件设置为<code>ngx_http_writer</code>方法，该方法被执行时将调用<code>ngx_http_output_filter</code>方法，执行发送响应头请求链路，但这时其实是没有新数据增加的，只需要吧out链表中未传输的数据发送出去即可，所以方法中的参数in为null。所有这时避免重复执行的方式有两种：1）通过查看是否响应只有请求头，即header_only是否为1。2）通过查看in参数是否为空，为空表示没有新要增加的传输数据需要处理。</li>
<li>在需要发送响应体时，响应体在第一次调用<code>ngx_http_output_filter</code>时已经处理完成了，要全部在参数in包含的链表中了，但是并没有一次完成传输的发送。这时会将请求的写事件设置为<code>ngx_http_writer</code>方法，该方法被执行时将调用<code>ngx_http_output_filter</code>方法，执行发送响应头请求链路，但这时其实是没有新数据增加的，只需要吧out链表中未传输的数据发送出去即可，所以方法中的参数in为null。这时避免重复执行的方式为：判断in是否为空，因为在<code>ngx_http_writer</code>方法中执行的<code>ngx_http_output_filter</code>方法，in参数均为空。</li>
<li>在需要发送响应体时，响应头并不是通过一次调用<code>ngx_http_output_filter</code>就完成了所有数据的处理，需要调用多次<code>ngx_http_output_filter</code>方法，逐步完成响应的下发。每一次执行<code>ngx_http_output_filter</code>后并不会将<code>ngx_http_writer</code>设置请求的写事件处理，而是将模块本身的处理函数设置为写事件的处理方法，该方法会重复调用<code>ngx_http_output_filter</code>方法来下发需要处理的数据，直到下发的数据完成，再调用<code>ngx_http_finalize_request</code>方法将<code>ngx_http_writer</code>方法设置为写事件的处理方法（这时就可以通过in来避免重复处理了）。在重复调用<code>ngx_http_output_filter</code>方法增加需要传输的数据的时候处理逻辑需要区分模块来判断。对于只应该执行一次处理的模块，可以通过in中最后一个buf中的last_buf来进行判断，该值表示是需要发送的最后一部分数据，那在次之前就可以不进行任何处理，直到最后一部分数据的到来，比如<code>ngx_http_headers_filter_module</code>模块的<code>ngx_http_trailers_filter</code>响应体过滤函数，其处理逻辑即是这样，该模块的方法是在发送响应的最后增加用户指定的内容（<code>add_trailer</code>配置），当日这是应该只能执行一次的方法，这时通过判断last_buf来决定是否需要进行增加响应返回的数据。对于响应整体都需要做操作时，则有更独特的处理逻辑，以<code>ngx_http_gzip_filter_module</code>模块来说，该模块的响应头过滤函数工作是将响应体进行gzip压缩，这时需要对响应体整体进行压缩的，但是不应该在每次有新数据到来时就进行压缩，而是在数据的量级达到指定的大小时再进行压缩，这样该函数并不会直接对<code>ngx_http_output_filter</code>下发的数据立即处理，而是先缓存到该阶段，等积累到指定的大小时，再进行压缩，向之后的请求体过滤函数进行下发。（这时响应方式往往以chunked方式传输）</li>
</ol>
<h3 id="响应头发送ngx-http-header-filter"><a href="#响应头发送ngx-http-header-filter" class="headerlink" title="响应头发送ngx_http_header_filter"></a>响应头发送ngx_http_header_filter</h3><p>在响应头通过响应头fiter链表构建完成后，最终会通过<code>ngx_http_header_filter</code>方法向用户下发响应(<code>ngx_http_header_filter_module</code>模块负责)，其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_str_t</span> ngx_http_status_lines[] = &#123;</span><br><span class="line"></span><br><span class="line">    ngx_string(<span class="string">"200 OK"</span>),</span><br><span class="line">    ngx_string(<span class="string">"201 Created"</span>),</span><br><span class="line">    ngx_string(<span class="string">"202 Accepted"</span>),</span><br><span class="line">    ngx_null_string,  <span class="comment">/* "203 Non-Authoritative Information" */</span></span><br><span class="line">    ngx_string(<span class="string">"204 No Content"</span>),</span><br><span class="line">    ngx_null_string,  <span class="comment">/* "205 Reset Content" */</span></span><br><span class="line">    ngx_string(<span class="string">"206 Partial Content"</span>)</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_header_filter(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                    *p;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  host, *status_line;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 status, i, port;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                out;</span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>           *part;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>           *header;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line">    u_char                     addr[NGX_SOCKADDR_STRLEN];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果响应已经处理过了，直接跳过</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_sent) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 标注响应头已经处理（这里发送并不是已经完成了发送）</span></span><br><span class="line">    r-&gt;header_sent = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 主请求才能处理请求</span></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 请求http版本校验</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;http_version &lt; NGX_HTTP_VERSION_10) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是head请求，则设置只有响应头</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;method == NGX_HTTP_HEAD) &#123;</span><br><span class="line">        r-&gt;header_only = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置响应头last_modified_time</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.last_modified_time != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_out.status != NGX_HTTP_OK <span class="comment">// 200</span></span><br><span class="line">            &amp;&amp; r-&gt;headers_out.status != NGX_HTTP_PARTIAL_CONTENT <span class="comment">// 206</span></span><br><span class="line">            &amp;&amp; r-&gt;headers_out.status != NGX_HTTP_NOT_MODIFIED) <span class="comment">// 304</span></span><br><span class="line">        &#123;</span><br><span class="line">            r-&gt;headers_out.last_modified_time = <span class="number">-1</span>;</span><br><span class="line">            r-&gt;headers_out.last_modified = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算请求头长度</span></span><br><span class="line">    len = <span class="keyword">sizeof</span>(<span class="string">"HTTP/1.x "</span>) - <span class="number">1</span> + <span class="keyword">sizeof</span>(CRLF) - <span class="number">1</span></span><br><span class="line">          <span class="comment">/* the end of the header */</span></span><br><span class="line">          + <span class="keyword">sizeof</span>(CRLF) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* status line */</span></span><br><span class="line">    <span class="comment">// 如果之前的fiter处理已经设置了状态行，则直接计算，否则返回头设置请求行</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.status_line.len) &#123;</span><br><span class="line">        len += r-&gt;headers_out.status_line.len;</span><br><span class="line">        status_line = &amp;r-&gt;headers_out.status_line;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">        status = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取响应状态</span></span><br><span class="line">        status = r-&gt;headers_out.status;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status &gt;= NGX_HTTP_OK <span class="comment">// 200</span></span><br><span class="line">            &amp;&amp; status &lt; NGX_HTTP_LAST_2XX) <span class="comment">// 207 请求已成功处理，返回了多个状态的XML消息</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 2XX */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (status == NGX_HTTP_NO_CONTENT) &#123; <span class="comment">// 204 没有响应体</span></span><br><span class="line">                r-&gt;header_only = <span class="number">1</span>;</span><br><span class="line">                ngx_str_null(&amp;r-&gt;headers_out.content_type);</span><br><span class="line">                r-&gt;headers_out.last_modified_time = <span class="number">-1</span>;</span><br><span class="line">                r-&gt;headers_out.last_modified = <span class="literal">NULL</span>;</span><br><span class="line">                r-&gt;headers_out.content_length = <span class="literal">NULL</span>;</span><br><span class="line">                r-&gt;headers_out.content_length_n = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            status -= NGX_HTTP_OK;</span><br><span class="line">            status_line = &amp;ngx_http_status_lines[status]; <span class="comment">// 从ngx_http_status_lines数组中获取响应行</span></span><br><span class="line">            len += ngx_http_status_lines[status].len;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 响应为3XX</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status &gt;= NGX_HTTP_MOVED_PERMANENTLY <span class="comment">// 301</span></span><br><span class="line">                   &amp;&amp; status &lt; NGX_HTTP_LAST_3XX) <span class="comment">// 309</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 3XX */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (status == NGX_HTTP_NOT_MODIFIED) &#123; <span class="comment">// 304 未改变，设置只需返回响应头</span></span><br><span class="line">                r-&gt;header_only = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取响应行</span></span><br><span class="line">            status = status - NGX_HTTP_MOVED_PERMANENTLY + NGX_HTTP_OFF_3XX;</span><br><span class="line">            status_line = &amp;ngx_http_status_lines[status];</span><br><span class="line">            len += ngx_http_status_lines[status].len;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4xx响应处理</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status &gt;= NGX_HTTP_BAD_REQUEST <span class="comment">// 400</span></span><br><span class="line">                   &amp;&amp; status &lt; NGX_HTTP_LAST_4XX) <span class="comment">// 430</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 4XX */</span></span><br><span class="line">            status = status - NGX_HTTP_BAD_REQUEST</span><br><span class="line">                            + NGX_HTTP_OFF_4XX;</span><br><span class="line"></span><br><span class="line">            status_line = &amp;ngx_http_status_lines[status];</span><br><span class="line">            len += ngx_http_status_lines[status].len;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5xx响应</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status &gt;= NGX_HTTP_INTERNAL_SERVER_ERROR</span><br><span class="line">                   &amp;&amp; status &lt; NGX_HTTP_LAST_5XX)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 5XX */</span></span><br><span class="line">            status = status - NGX_HTTP_INTERNAL_SERVER_ERROR</span><br><span class="line">                            + NGX_HTTP_OFF_5XX;</span><br><span class="line"></span><br><span class="line">            status_line = &amp;ngx_http_status_lines[status];</span><br><span class="line">            len += ngx_http_status_lines[status].len;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            len += NGX_INT_T_LEN + <span class="number">1</span> <span class="comment">/* SP */</span>;</span><br><span class="line">            status_line = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status_line &amp;&amp; status_line-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">            status = r-&gt;headers_out.status;</span><br><span class="line">            len += NGX_INT_T_LEN + <span class="number">1</span> <span class="comment">/* SP */</span>;</span><br><span class="line">            status_line = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取http core模块location配置ngx_http_core_loc_conf_t</span></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 设置返回的server响应头，并计算长度</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.server == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;server_tokens == NGX_HTTP_SERVER_TOKENS_ON) &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(ngx_http_server_full_string) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clcf-&gt;server_tokens == NGX_HTTP_SERVER_TOKENS_BUILD) &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(ngx_http_server_build_string) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(ngx_http_server_string) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置响应data头长度</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.date == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Date: Mon, 28 Sep 1970 06:00:00 GMT"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取响应的content_type头长度</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_type.len) &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Content-Type: "</span>) - <span class="number">1</span></span><br><span class="line">               + r-&gt;headers_out.content_type.len + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_out.content_type_len == r-&gt;headers_out.content_type.len</span><br><span class="line">            &amp;&amp; r-&gt;headers_out.charset.len)</span><br><span class="line">        &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(<span class="string">"; charset="</span>) - <span class="number">1</span> + r-&gt;headers_out.charset.len;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取响应头content_length长度</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_length == <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; r-&gt;headers_out.content_length_n &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Content-Length: "</span>) - <span class="number">1</span> + NGX_OFF_T_LEN + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取响应Last-Modified长度</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.last_modified == <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; r-&gt;headers_out.last_modified_time != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Last-Modified: Mon, 28 Sep 1970 06:00:00 GMT"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取请求的连接</span></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果响应为重定向，并且重定向只设置了uri，并没有设置请求的host</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.location</span><br><span class="line">        &amp;&amp; r-&gt;headers_out.location-&gt;value.len</span><br><span class="line">        &amp;&amp; r-&gt;headers_out.location-&gt;value.data[<span class="number">0</span>] == <span class="string">'/'</span></span><br><span class="line">        &amp;&amp; clcf-&gt;absolute_redirect)  <span class="comment">// nginx发起的重定向是相对的,absolute_redirect配置</span></span><br><span class="line">    &#123;</span><br><span class="line">        r-&gt;headers_out.location-&gt;hash = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 指令指定的首要虚拟主机名用于发起的绝对重定向，server_name_in_redirect配置，使用server层级的host</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;server_name_in_redirect) &#123; </span><br><span class="line">            cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">            host = cscf-&gt;server_name;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果请求头中包含server，使用该hoast</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;headers_in.server.len) &#123;</span><br><span class="line">            host = r-&gt;headers_in.server;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 使用连接地址，通过getsockname获取host</span></span><br><span class="line">            host.len = NGX_SOCKADDR_STRLEN;</span><br><span class="line">            host.data = addr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_connection_local_sockaddr(c, &amp;host, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取端口号</span></span><br><span class="line">        port = ngx_inet_get_port(c-&gt;local_sockaddr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加Location部分请求头</span></span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Location: https://"</span>) - <span class="number">1</span></span><br><span class="line">               + host.len</span><br><span class="line">               + r-&gt;headers_out.location-&gt;value.len + <span class="number">2</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// nginx发起绝对重定向（absolute_redirect on）时指定端口,port_in_redirect配置，如果重定向需要请求头，则添加对应长度</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;port_in_redirect) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">            <span class="keyword">if</span> (c-&gt;ssl)</span><br><span class="line">                port = (port == <span class="number">443</span>) ? <span class="number">0</span> : port;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">                port = (port == <span class="number">80</span>) ? <span class="number">0</span> : port;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            port = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (port) &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设置host为空</span></span><br><span class="line">        ngx_str_null(&amp;host);</span><br><span class="line">        port = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果响应为chunked模式发送，则设置相应的请求头</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;chunked) &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Transfer-Encoding: chunked"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果响应为101，服务切换，则设置响应请求头</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.status == NGX_HTTP_SWITCHING_PROTOCOLS) &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Connection: upgrade"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 如果需要keepalive，则设置对应请求头，请求是否需要保持keepalive，由之前的阶段决定</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;keepalive) &#123;</span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Connection: keep-alive"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * MSIE and Opera ignore the "Keep-Alive: timeout=&lt;N&gt;" header.</span></span><br><span class="line"><span class="comment">         * MSIE keeps the connection alive for about 60-65 seconds.</span></span><br><span class="line"><span class="comment">         * Opera keeps the connection alive very long.</span></span><br><span class="line"><span class="comment">         * Mozilla keeps the connection alive for N plus about 1-10 seconds.</span></span><br><span class="line"><span class="comment">         * Konqueror keeps the connection alive for about N seconds.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 如果需要添加keepalive_header响应头</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;keepalive_header) &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(<span class="string">"Keep-Alive: timeout="</span>) - <span class="number">1</span> + NGX_TIME_T_LEN + <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则关闭连接</span></span><br><span class="line">        len += <span class="keyword">sizeof</span>(<span class="string">"Connection: close"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_GZIP)</span></span><br><span class="line">    <span class="comment">// 如果设置了gzip_vary，增加响应头</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;gzip_vary) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;gzip_vary) &#123;</span><br><span class="line">            len += <span class="keyword">sizeof</span>(<span class="string">"Vary: Accept-Encoding"</span> CRLF) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r-&gt;gzip_vary = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 遍历没有header，获取每个响应头的长度</span></span><br><span class="line">    part = &amp;r-&gt;headers_out.headers.part;</span><br><span class="line">    header = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; <span class="comment">/* void */</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            <span class="keyword">if</span> (part-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            header = part-&gt;elts;</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (header[i].hash == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len += header[i].key.len + <span class="keyword">sizeof</span>(<span class="string">": "</span>) - <span class="number">1</span> + header[i].value.len</span><br><span class="line">               + <span class="keyword">sizeof</span>(CRLF) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按照之前生成的len，分配一个buf</span></span><br><span class="line">    b = ngx_create_temp_buf(r-&gt;pool, len);</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 与计算长度时类似，对buf赋值</span></span><br><span class="line">    <span class="comment">/* "HTTP/1.x " */</span></span><br><span class="line">    b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"HTTP/1.1 "</span>, <span class="keyword">sizeof</span>(<span class="string">"HTTP/1.x "</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* status line */</span></span><br><span class="line">    <span class="keyword">if</span> (status_line) &#123;</span><br><span class="line">        b-&gt;last = ngx_copy(b-&gt;last, status_line-&gt;data, status_line-&gt;len);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        b-&gt;last = ngx_sprintf(b-&gt;last, <span class="string">"%03ui "</span>, status);</span><br><span class="line">    &#125;</span><br><span class="line">    *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.server == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;server_tokens == NGX_HTTP_SERVER_TOKENS_ON) &#123;</span><br><span class="line">            p = ngx_http_server_full_string;</span><br><span class="line">            len = <span class="keyword">sizeof</span>(ngx_http_server_full_string) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clcf-&gt;server_tokens == NGX_HTTP_SERVER_TOKENS_BUILD) &#123;</span><br><span class="line">            p = ngx_http_server_build_string;</span><br><span class="line">            len = <span class="keyword">sizeof</span>(ngx_http_server_build_string) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p = ngx_http_server_string;</span><br><span class="line">            len = <span class="keyword">sizeof</span>(ngx_http_server_string) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, p, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.date == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Date: "</span>, <span class="keyword">sizeof</span>(<span class="string">"Date: "</span>) - <span class="number">1</span>);</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, ngx_cached_http_time.data,</span><br><span class="line">                             ngx_cached_http_time.len);</span><br><span class="line"></span><br><span class="line">        *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_type.len) &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Content-Type: "</span>,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Content-Type: "</span>) - <span class="number">1</span>);</span><br><span class="line">        p = b-&gt;last;</span><br><span class="line">        b-&gt;last = ngx_copy(b-&gt;last, r-&gt;headers_out.content_type.data,</span><br><span class="line">                           r-&gt;headers_out.content_type.len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_out.content_type_len == r-&gt;headers_out.content_type.len</span><br><span class="line">            &amp;&amp; r-&gt;headers_out.charset.len)</span><br><span class="line">        &#123;</span><br><span class="line">            b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"; charset="</span>,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(<span class="string">"; charset="</span>) - <span class="number">1</span>);</span><br><span class="line">            b-&gt;last = ngx_copy(b-&gt;last, r-&gt;headers_out.charset.data,</span><br><span class="line">                               r-&gt;headers_out.charset.len);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update r-&gt;headers_out.content_type for possible logging */</span></span><br><span class="line"></span><br><span class="line">            r-&gt;headers_out.content_type.len = b-&gt;last - p;</span><br><span class="line">            r-&gt;headers_out.content_type.data = p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_length == <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; r-&gt;headers_out.content_length_n &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        b-&gt;last = ngx_sprintf(b-&gt;last, <span class="string">"Content-Length: %O"</span> CRLF,</span><br><span class="line">                              r-&gt;headers_out.content_length_n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.last_modified == <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; r-&gt;headers_out.last_modified_time != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Last-Modified: "</span>,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Last-Modified: "</span>) - <span class="number">1</span>);</span><br><span class="line">        b-&gt;last = ngx_http_time(b-&gt;last, r-&gt;headers_out.last_modified_time);</span><br><span class="line"></span><br><span class="line">        *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host.data) &#123;</span><br><span class="line"></span><br><span class="line">        p = b-&gt;last + <span class="keyword">sizeof</span>(<span class="string">"Location: "</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Location: http"</span>,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Location: http"</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;ssl) &#123;</span><br><span class="line">            *b-&gt;last++ =<span class="string">'s'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        *b-&gt;last++ = <span class="string">':'</span>; *b-&gt;last++ = <span class="string">'/'</span>; *b-&gt;last++ = <span class="string">'/'</span>;</span><br><span class="line">        b-&gt;last = ngx_copy(b-&gt;last, host.data, host.len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (port) &#123;</span><br><span class="line">            b-&gt;last = ngx_sprintf(b-&gt;last, <span class="string">":%ui"</span>, port);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;last = ngx_copy(b-&gt;last, r-&gt;headers_out.location-&gt;value.data,</span><br><span class="line">                           r-&gt;headers_out.location-&gt;value.len);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update r-&gt;headers_out.location-&gt;value for possible logging */</span></span><br><span class="line"></span><br><span class="line">        r-&gt;headers_out.location-&gt;value.len = b-&gt;last - p;</span><br><span class="line">        r-&gt;headers_out.location-&gt;value.data = p;</span><br><span class="line">        ngx_str_set(&amp;r-&gt;headers_out.location-&gt;key, <span class="string">"Location"</span>);</span><br><span class="line"></span><br><span class="line">        *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;chunked) &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Transfer-Encoding: chunked"</span> CRLF,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Transfer-Encoding: chunked"</span> CRLF) - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.status == NGX_HTTP_SWITCHING_PROTOCOLS) &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Connection: upgrade"</span> CRLF,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Connection: upgrade"</span> CRLF) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;keepalive) &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Connection: keep-alive"</span> CRLF,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Connection: keep-alive"</span> CRLF) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;keepalive_header) &#123;</span><br><span class="line">            b-&gt;last = ngx_sprintf(b-&gt;last, <span class="string">"Keep-Alive: timeout=%T"</span> CRLF,</span><br><span class="line">                                  clcf-&gt;keepalive_header);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Connection: close"</span> CRLF,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Connection: close"</span> CRLF) - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_GZIP)</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;gzip_vary) &#123;</span><br><span class="line">        b-&gt;last = ngx_cpymem(b-&gt;last, <span class="string">"Vary: Accept-Encoding"</span> CRLF,</span><br><span class="line">                             <span class="keyword">sizeof</span>(<span class="string">"Vary: Accept-Encoding"</span> CRLF) - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    part = &amp;r-&gt;headers_out.headers.part;</span><br><span class="line">    header = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; <span class="comment">/* void */</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            <span class="keyword">if</span> (part-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            header = part-&gt;elts;</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (header[i].hash == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;last = ngx_copy(b-&gt;last, header[i].key.data, header[i].key.len);</span><br><span class="line">        *b-&gt;last++ = <span class="string">':'</span>; *b-&gt;last++ = <span class="string">' '</span>;</span><br><span class="line"></span><br><span class="line">        b-&gt;last = ngx_copy(b-&gt;last, header[i].value.data, header[i].value.len);</span><br><span class="line">        *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"%*s"</span>, (<span class="keyword">size_t</span>) (b-&gt;last - b-&gt;pos), b-&gt;pos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the end of HTTP header */</span></span><br><span class="line">    *b-&gt;last++ = CR; *b-&gt;last++ = LF;</span><br><span class="line">    <span class="comment">// 设置响应头长度</span></span><br><span class="line">    r-&gt;header_size = b-&gt;last - b-&gt;pos;</span><br><span class="line">    <span class="comment">// 如果只需要发送响应头，设置该buf为最后一个buf</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_only) &#123;</span><br><span class="line">        b-&gt;last_buf = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    out.buf = b;</span><br><span class="line">    out.next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 调用ngx_http_write_filter向用户下发响应</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_write_filter(r, &amp;out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数主要是按照之前构建的响应头拼接返回的数据。</p>
<h3 id="响应体发送ngx-http-write-filter"><a href="#响应体发送ngx-http-write-filter" class="headerlink" title="响应体发送ngx_http_write_filter"></a>响应体发送ngx_http_write_filter</h3><p>其实说是响应体发送并不完成准确，因为响应头也会使用该方法发送数据。该方法由<code>ngx_http_write_filter_module</code>模块负责，其处理逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取需要传输数据字节</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_buf_size(b)                                                      \</span></span><br><span class="line">    (ngx_buf_in_memory(b) ? (<span class="keyword">off_t</span>) ((b)-&gt;last - (b)-&gt;pos):                  \</span><br><span class="line">                            ((b)-&gt;file_last - (b)-&gt;file_pos))</span><br><span class="line"><span class="comment">// 判断是否为特殊buf，特殊buf包括：需要flush的|最后一个buf|需要sync同步方式的buf                       </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_buf_special(b)                                                   \</span></span><br><span class="line">    (((b)-&gt;flush || (b)-&gt;last_buf || (b)-&gt;sync)                              \</span><br><span class="line">     &amp;&amp; !ngx_buf_in_memory(b) &amp;&amp; !(b)-&gt;in_file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_write_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">off_t</span>                      size, sent, nsent, limit;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 last, flush, sync;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                 delay;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>               *cl, *ln, **ll, *chain;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;error) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">    flush = <span class="number">0</span>;</span><br><span class="line">    sync = <span class="number">0</span>;</span><br><span class="line">    last = <span class="number">0</span>;</span><br><span class="line">    ll = &amp;r-&gt;out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* find the size, the flush point and the last link of the saved chain */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    r-&gt;out表示缓存的未发送的buf数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> (cl = r-&gt;out; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">        ll = &amp;cl-&gt;next;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug7(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"write old buf t:%d f:%d %p, pos %p, size: %z "</span></span><br><span class="line">                       <span class="string">"file: %O, size: %O"</span>,</span><br><span class="line">                       cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,</span><br><span class="line">                       cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,</span><br><span class="line">                       cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,</span><br><span class="line">                       cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                       cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果buf块数据带发送的为0，并且不是特殊buf（只有特殊buf允许在buf不为0时，还在out数组中）</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_buf_size(cl-&gt;buf) == <span class="number">0</span> &amp;&amp; !ngx_buf_special(cl-&gt;buf)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"zero size buf in writer "</span></span><br><span class="line">                          <span class="string">"t:%d r:%d f:%d %p %p-%p %p %O-%O"</span>,</span><br><span class="line">                          cl-&gt;buf-&gt;temporary,</span><br><span class="line">                          cl-&gt;buf-&gt;recycled,</span><br><span class="line">                          cl-&gt;buf-&gt;in_file,</span><br><span class="line">                          cl-&gt;buf-&gt;start,</span><br><span class="line">                          cl-&gt;buf-&gt;pos,</span><br><span class="line">                          cl-&gt;buf-&gt;last,</span><br><span class="line">                          cl-&gt;buf-&gt;file,</span><br><span class="line">                          cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                          cl-&gt;buf-&gt;file_last);</span><br><span class="line">            <span class="comment">// 发送信号，返回eror</span></span><br><span class="line">            ngx_debug_point();</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果buf小于0，报错</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_buf_size(cl-&gt;buf) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"negative size buf in writer "</span></span><br><span class="line">                          <span class="string">"t:%d r:%d f:%d %p %p-%p %p %O-%O"</span>,</span><br><span class="line">                          cl-&gt;buf-&gt;temporary,</span><br><span class="line">                          cl-&gt;buf-&gt;recycled,</span><br><span class="line">                          cl-&gt;buf-&gt;in_file,</span><br><span class="line">                          cl-&gt;buf-&gt;start,</span><br><span class="line">                          cl-&gt;buf-&gt;pos,</span><br><span class="line">                          cl-&gt;buf-&gt;last,</span><br><span class="line">                          cl-&gt;buf-&gt;file,</span><br><span class="line">                          cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                          cl-&gt;buf-&gt;file_last);</span><br><span class="line"></span><br><span class="line">            ngx_debug_point();</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算待发送数据数量</span></span><br><span class="line">        size += ngx_buf_size(cl-&gt;buf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果buf需要flush或者是可复用的（需要立即发送，不然会被复用），设置需要flush</span></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;flush || cl-&gt;buf-&gt;recycled) &#123;</span><br><span class="line">            flush = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果buf是同步的，设置syn</span></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;sync) &#123;</span><br><span class="line">            sync = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是最后一块buf，设置last</span></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;last_buf) &#123;</span><br><span class="line">            last = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add the new chain to the existent one */</span></span><br><span class="line">    <span class="comment">// 遍历新的带发送的buf，将其添加到out后面</span></span><br><span class="line">    <span class="keyword">for</span> (ln = in; ln; ln = ln-&gt;next) &#123;</span><br><span class="line">        cl = ngx_alloc_chain_link(r-&gt;pool);</span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cl-&gt;buf = ln-&gt;buf;</span><br><span class="line">        *ll = cl;</span><br><span class="line">        ll = &amp;cl-&gt;next;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug7(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"write new buf t:%d f:%d %p, pos %p, size: %z "</span></span><br><span class="line">                       <span class="string">"file: %O, size: %O"</span>,</span><br><span class="line">                       cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,</span><br><span class="line">                       cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,</span><br><span class="line">                       cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,</span><br><span class="line">                       cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                       cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);</span><br><span class="line">        <span class="comment">// 与out一样，判断是否数据错误</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_buf_size(cl-&gt;buf) == <span class="number">0</span> &amp;&amp; !ngx_buf_special(cl-&gt;buf)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"zero size buf in writer "</span></span><br><span class="line">                          <span class="string">"t:%d r:%d f:%d %p %p-%p %p %O-%O"</span>,</span><br><span class="line">                          cl-&gt;buf-&gt;temporary,</span><br><span class="line">                          cl-&gt;buf-&gt;recycled,</span><br><span class="line">                          cl-&gt;buf-&gt;in_file,</span><br><span class="line">                          cl-&gt;buf-&gt;start,</span><br><span class="line">                          cl-&gt;buf-&gt;pos,</span><br><span class="line">                          cl-&gt;buf-&gt;last,</span><br><span class="line">                          cl-&gt;buf-&gt;file,</span><br><span class="line">                          cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                          cl-&gt;buf-&gt;file_last);</span><br><span class="line"></span><br><span class="line">            ngx_debug_point();</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_buf_size(cl-&gt;buf) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"negative size buf in writer "</span></span><br><span class="line">                          <span class="string">"t:%d r:%d f:%d %p %p-%p %p %O-%O"</span>,</span><br><span class="line">                          cl-&gt;buf-&gt;temporary,</span><br><span class="line">                          cl-&gt;buf-&gt;recycled,</span><br><span class="line">                          cl-&gt;buf-&gt;in_file,</span><br><span class="line">                          cl-&gt;buf-&gt;start,</span><br><span class="line">                          cl-&gt;buf-&gt;pos,</span><br><span class="line">                          cl-&gt;buf-&gt;last,</span><br><span class="line">                          cl-&gt;buf-&gt;file,</span><br><span class="line">                          cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                          cl-&gt;buf-&gt;file_last);</span><br><span class="line"></span><br><span class="line">            ngx_debug_point();</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size += ngx_buf_size(cl-&gt;buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;flush || cl-&gt;buf-&gt;recycled) &#123;</span><br><span class="line">            flush = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;sync) &#123;</span><br><span class="line">            sync = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;last_buf) &#123;</span><br><span class="line">            last = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *ll = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug3(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http write filter: l:%ui f:%ui s:%O"</span>, last, flush, size);</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * avoid the output if there are no last buf, no flush point,</span></span><br><span class="line"><span class="comment">     * there are the incoming bufs and the size of all bufs</span></span><br><span class="line"><span class="comment">     * is smaller than "postpone_output" directive</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果不是最后的buf，或者需要flush，并且in不为空，但总的siez小于postpone_output时，直接返回</span></span><br><span class="line"><span class="comment">    postpone_output可配置</span></span><br><span class="line"><span class="comment">    避免太小的块发送</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!last &amp;&amp; !flush &amp;&amp; in &amp;&amp; size &lt; (<span class="keyword">off_t</span>) clcf-&gt;postpone_output) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果写事件需要delayed，设置buffered标志位</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;write-&gt;delayed) &#123;</span><br><span class="line">        c-&gt;buffered |= NGX_HTTP_WRITE_BUFFERED;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    如果buffer总大小为0，而且当前连接之前没有由于底层发送接口的原因延迟，则检查是否有特殊标记 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span></span><br><span class="line">        &amp;&amp; !(c-&gt;buffered &amp; NGX_LOWLEVEL_BUFFERED)</span><br><span class="line">        &amp;&amp; !(last &amp;&amp; c-&gt;need_last_buf))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果有last，flush，syn任意一个条件满足</span></span><br><span class="line">        <span class="keyword">if</span> (last || flush || sync) &#123;</span><br><span class="line">            <span class="comment">// 清空out数组</span></span><br><span class="line">            <span class="keyword">for</span> (cl = r-&gt;out; cl; <span class="comment">/* void */</span>) &#123;</span><br><span class="line">                ln = cl;</span><br><span class="line">                cl = cl-&gt;next;</span><br><span class="line">                ngx_free_chain(r-&gt;pool, ln);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r-&gt;out = <span class="literal">NULL</span>;</span><br><span class="line">            c-&gt;buffered &amp;= ~NGX_HTTP_WRITE_BUFFERED;</span><br><span class="line">            <span class="comment">// 返回ok</span></span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则报错，返回</span></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"the http output chain is empty"</span>);</span><br><span class="line"></span><br><span class="line">        ngx_debug_point();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算限速相关内容，避免后续重复计算，增加limit_rate_set位</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;limit_rate_set) &#123;</span><br><span class="line">        r-&gt;limit_rate = ngx_http_complex_value_size(r, clcf-&gt;limit_rate, <span class="number">0</span>);</span><br><span class="line">        r-&gt;limit_rate_set = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果需要限速，则获取本次最多下发的数据数量</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;limit_rate) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r-&gt;limit_rate_after_set) &#123;</span><br><span class="line">            r-&gt;limit_rate_after = ngx_http_complex_value_size(r,</span><br><span class="line">                                                    clcf-&gt;limit_rate_after, <span class="number">0</span>);</span><br><span class="line">            r-&gt;limit_rate_after_set = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        limit = (<span class="keyword">off_t</span>) r-&gt;limit_rate * (ngx_time() - r-&gt;start_sec + <span class="number">1</span>)</span><br><span class="line">                - (c-&gt;sent - r-&gt;limit_rate_after);</span><br><span class="line">        <span class="comment">// 如果允许下发数量为0，则添加写事件到定时器红黑树中，并设置等待标识</span></span><br><span class="line">        <span class="keyword">if</span> (limit &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            c-&gt;write-&gt;delayed = <span class="number">1</span>;</span><br><span class="line">            delay = (<span class="keyword">ngx_msec_t</span>) (- limit * <span class="number">1000</span> / r-&gt;limit_rate + <span class="number">1</span>);</span><br><span class="line">            ngx_add_timer(c-&gt;write, delay);</span><br><span class="line"></span><br><span class="line">            c-&gt;buffered |= NGX_HTTP_WRITE_BUFFERED;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果设置了最大发送chunk，判断是否需要重新设置limit</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;sendfile_max_chunk</span><br><span class="line">            &amp;&amp; (<span class="keyword">off_t</span>) clcf-&gt;sendfile_max_chunk &lt; limit)</span><br><span class="line">        &#123;</span><br><span class="line">            limit = clcf-&gt;sendfile_max_chunk;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则最大发送数量为sendfile_max_chunk值</span></span><br><span class="line">        limit = clcf-&gt;sendfile_max_chunk;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录已经发送字节数量</span></span><br><span class="line">    sent = c-&gt;sent;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http write filter limit %O"</span>, limit);</span><br><span class="line">    <span class="comment">// 执行send_chain下发响应，这里的函数区分平台不一致，linux下在epoll模块的epoll init中设置，为ngx_writev_chain函数</span></span><br><span class="line">    chain = c-&gt;send_chain(c, r-&gt;out, limit);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http write filter %p"</span>, chain);</span><br><span class="line">    <span class="comment">// 如果错误，则返回</span></span><br><span class="line">    <span class="keyword">if</span> (chain == NGX_CHAIN_ERROR) &#123;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据实际下发的字节数量，设置限速</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;limit_rate) &#123;</span><br><span class="line"></span><br><span class="line">        nsent = c-&gt;sent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;limit_rate_after) &#123;</span><br><span class="line"></span><br><span class="line">            sent -= r-&gt;limit_rate_after;</span><br><span class="line">            <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                sent = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            nsent -= r-&gt;limit_rate_after;</span><br><span class="line">            <span class="keyword">if</span> (nsent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                nsent = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        delay = (<span class="keyword">ngx_msec_t</span>) ((nsent - sent) * <span class="number">1000</span> / r-&gt;limit_rate);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            limit = <span class="number">0</span>;</span><br><span class="line">            c-&gt;write-&gt;delayed = <span class="number">1</span>;</span><br><span class="line">            ngx_add_timer(c-&gt;write, delay);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果下发的数量剩余小于2 * ngx_pagesize，避免过快再次发送，增加1ms延时</span></span><br><span class="line">    <span class="keyword">if</span> (limit</span><br><span class="line">        &amp;&amp; c-&gt;write-&gt;ready</span><br><span class="line">        &amp;&amp; c-&gt;sent - sent &gt;= limit - (<span class="keyword">off_t</span>) (<span class="number">2</span> * ngx_pagesize))</span><br><span class="line">    &#123;</span><br><span class="line">        c-&gt;write-&gt;delayed = <span class="number">1</span>;</span><br><span class="line">        ngx_add_timer(c-&gt;write, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 清空已经下发的out结构中的链表元素</span></span><br><span class="line">    <span class="keyword">for</span> (cl = r-&gt;out; cl &amp;&amp; cl != chain; <span class="comment">/* void */</span>) &#123;</span><br><span class="line">        ln = cl;</span><br><span class="line">        cl = cl-&gt;next;</span><br><span class="line">        ngx_free_chain(r-&gt;pool, ln);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;out = chain;</span><br><span class="line">    <span class="comment">// 如果数据还未发送完，则设置标志，返回</span></span><br><span class="line">    <span class="keyword">if</span> (chain) &#123;</span><br><span class="line">        c-&gt;buffered |= NGX_HTTP_WRITE_BUFFERED;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果发送完全了，则设置标志</span></span><br><span class="line">    c-&gt;buffered &amp;= ~NGX_HTTP_WRITE_BUFFERED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果由于底层发送接口导致数据未发送完全，且当前请求没有其他数据需要发送，</span></span><br><span class="line"><span class="comment">       此时要返回NGX_AGAIN，表示还有数据未发送 */</span></span><br><span class="line">    <span class="keyword">if</span> ((c-&gt;buffered &amp; NGX_LOWLEVEL_BUFFERED) &amp;&amp; r-&gt;postponed == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面大致分析了请求发送的过程，该函数返回值有三种：</p>
<ol>
<li><code>NGX_AGAIN</code>当前下发到该函数的数据还未发送完全，需要后续再次调用该函数下发数据。</li>
<li><code>NGX_OK</code>当前下发到该函数的数据已经完成了发送，但需注意，这里的完成发送并非是说向用户发送的数据一定全部发送完成了，只是到该函数的数据已经发送完成了，如果当前到达该函数的数据只是要发送数据的一部分，后续部分还需要调用该函数来进行数据的下发。</li>
<li><code>NGX_ERROR</code>发送数据出错。</li>
</ol>
<h4 id="ngx-writer-chain方法"><a href="#ngx-writer-chain方法" class="headerlink" title="ngx_writer_chain方法"></a>ngx_writer_chain方法</h4><p>在linux下，上述函数中执行的<code>send_chain</code>为ngx_writev_chain函数，其实现细节如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_chain_t</span> *</span><br><span class="line">ngx_writev_chain(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_chain_t</span> *in, <span class="keyword">off_t</span> limit)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>        n, sent;</span><br><span class="line">    <span class="keyword">off_t</span>          send, prev_send;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>   *cl;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>   *wev;</span><br><span class="line">    <span class="keyword">ngx_iovec_t</span>    vec;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span>   <span class="title">iovs</span>[<span class="title">NGX_IOVS_PREALLOCATE</span>];</span></span><br><span class="line"></span><br><span class="line">    wev = c-&gt;write;</span><br><span class="line">    <span class="comment">// 如果写事件尚未ready，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!wev-&gt;ready) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the maximum limit size is the maximum size_t value - the page size */</span></span><br><span class="line">    <span class="comment">// 限制一次最多下发数据数量</span></span><br><span class="line">    <span class="keyword">if</span> (limit == <span class="number">0</span> || limit &gt; (<span class="keyword">off_t</span>) (NGX_MAX_SIZE_T_VALUE - ngx_pagesize)) &#123;</span><br><span class="line">        limit = NGX_MAX_SIZE_T_VALUE - ngx_pagesize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    send = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vec.iovs = iovs;</span><br><span class="line">    vec.nalloc = NGX_IOVS_PREALLOCATE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        prev_send = send;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* create the iovec and coalesce the neighbouring bufs */</span></span><br><span class="line">        <span class="comment">// 将in链表中的数据填充到vec中，返回到第一个尚未填充的ngx_chain_t结构</span></span><br><span class="line">        cl = ngx_output_chain_to_iovec(&amp;vec, in, limit - send, c-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl == NGX_CHAIN_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CHAIN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cl &amp;&amp; cl-&gt;buf-&gt;in_file) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"file buf in writev "</span></span><br><span class="line">                          <span class="string">"t:%d r:%d f:%d %p %p-%p %p %O-%O"</span>,</span><br><span class="line">                          cl-&gt;buf-&gt;temporary,</span><br><span class="line">                          cl-&gt;buf-&gt;recycled,</span><br><span class="line">                          cl-&gt;buf-&gt;in_file,</span><br><span class="line">                          cl-&gt;buf-&gt;start,</span><br><span class="line">                          cl-&gt;buf-&gt;pos,</span><br><span class="line">                          cl-&gt;buf-&gt;last,</span><br><span class="line">                          cl-&gt;buf-&gt;file,</span><br><span class="line">                          cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                          cl-&gt;buf-&gt;file_last);</span><br><span class="line"></span><br><span class="line">            ngx_debug_point();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_CHAIN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录需要发送的字节数量</span></span><br><span class="line">        send += vec.size;</span><br><span class="line">        <span class="comment">// 调用writev方法下发数据</span></span><br><span class="line">        n = ngx_writev(c, &amp;vec);</span><br><span class="line">        <span class="comment">// 出错返回</span></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CHAIN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录实际发送的字节数</span></span><br><span class="line">        sent = (n == NGX_AGAIN) ? <span class="number">0</span> : n;</span><br><span class="line">        <span class="comment">// sent增加实际发送的字节数</span></span><br><span class="line">        c-&gt;sent += sent;</span><br><span class="line">        <span class="comment">// 按照实际发送的字节数更新当前发送到了哪个ngx_chain_t结构，并返回</span></span><br><span class="line">        in = ngx_chain_update_sent(in, sent);</span><br><span class="line">        <span class="comment">// 如果希望发送的数量和实际发送的数量不一致，设置写事件未ready</span></span><br><span class="line">        <span class="keyword">if</span> (send - prev_send != sent) &#123;</span><br><span class="line">            wev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果发送数量超过了limit或者已经发送完了，则返回</span></span><br><span class="line">        <span class="keyword">if</span> (send &gt;= limit || in == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于<code>writev</code>的使用可以参考如下文档：<a href="https://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%87%BD%E6%95%B0readv%E5%92%8Cwritev" target="_blank" rel="noopener">writev</a>。</p>
<h3 id="ngx-http-writer方法"><a href="#ngx-http-writer方法" class="headerlink" title="ngx_http_writer方法"></a>ngx_http_writer方法</h3><p>在上文已经介绍过，在最终下发数据时，如果没有一次下发成功，将会设置写事件的处理函数为<code>ngx_http_writer</code>方法（一般是在<code>ngx_http_finalize_request</code>中设置），来继续进行数据的下发，这里详细介绍该方法的执行逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_writer(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>               *wev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    wev = c-&gt;write;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, wev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http writer handler: \"%V?%V\""</span>, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r-&gt;main, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果请求已超时，则直接结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (wev-&gt;timedout) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, NGX_ETIMEDOUT,</span><br><span class="line">                      <span class="string">"client timed out"</span>);</span><br><span class="line">        c-&gt;timedout = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_REQUEST_TIME_OUT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果写事件被delayed（限速）</span></span><br><span class="line">    <span class="keyword">if</span> (wev-&gt;delayed || r-&gt;aio) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, wev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http writer delayed"</span>);</span><br><span class="line">        <span class="comment">// 如果不是被延迟了，设置发送超时时间,send_timeout配置</span></span><br><span class="line">        <span class="keyword">if</span> (!wev-&gt;delayed) &#123;</span><br><span class="line">            ngx_add_timer(wev, clcf-&gt;send_timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置写事件</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_write_event(wev, clcf-&gt;send_lowat) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行响应体下发fiter链表。这里就是之前说的为何需要响应头控制避免重复执行</span></span><br><span class="line">    rc = ngx_http_output_filter(r, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug3(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http writer output filter: %i, \"%V?%V\""</span>,</span><br><span class="line">                   rc, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">    <span class="comment">// 如果返回错误，则结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, rc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果buffered不为0，表示数据未完全发送</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;buffered || r-&gt;postponed || (r == r-&gt;main &amp;&amp; c-&gt;buffered)) &#123;</span><br><span class="line">        <span class="comment">// 如果不是被delay，则条件send_timeout超时事件</span></span><br><span class="line">        <span class="keyword">if</span> (!wev-&gt;delayed) &#123;</span><br><span class="line">            ngx_add_timer(wev, clcf-&gt;send_timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置写事件</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_write_event(wev, clcf-&gt;send_lowat) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, wev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http writer done: \"%V?%V\""</span>, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">    <span class="comment">// 如果数据已经发送完全，则设置写处理函数为空方法</span></span><br><span class="line">    r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line">    <span class="comment">// 结束请求</span></span><br><span class="line">    ngx_http_finalize_request(r, rc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="请求体处理"><a href="#请求体处理" class="headerlink" title="请求体处理"></a>请求体处理</h2><p>对于post请求来说，nginx需要处理其请求体。请求体处理有两种方式，直接丢弃请求体和接收并执行相关操作。选择何种方式来处理请求体往往由模块本身决定。</p>
<p>接收包体时，为防止请求被其他相关操作终止，应当将请求的count加1。再完成接收时，将计数减1。对应丢弃请求体来说，加减均由架构函数完成，对应接收请求来说，加架构完成了，减需要自定义的回调函数来完成。</p>
<p>下面这里对两种方式进行介绍。</p>
<h3 id="相关结构-3"><a href="#相关结构-3" class="headerlink" title="相关结构"></a>相关结构</h3><p>用于处理请求体的相关结构为<code>ngx_http_request_body_t</code>.</p>
<h4 id="ngx-http-request-body-t"><a href="#ngx-http-request-body-t" class="headerlink" title="ngx_http_request_body_t"></a>ngx_http_request_body_t</h4><p>其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_chunked_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>           state;</span><br><span class="line">    <span class="keyword">off_t</span>                size;</span><br><span class="line">    <span class="keyword">off_t</span>                length;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_http_client_body_handler_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 存放http包体的临时文件</span></span><br><span class="line">    <span class="keyword">ngx_temp_file_t</span>                  *temp_file;</span><br><span class="line">    <span class="comment">// 接收包体的缓冲区链表，当包体全部存放缓冲区时，如果一块无法存储下，则需要使用缓冲区链表来存储</span></span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                      *bufs;</span><br><span class="line">    <span class="comment">// 接收包体的缓冲区链表</span></span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                        *buf;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    根据content-length头部和已接收的包体长度，计算出还需要接收的包体长度。</span></span><br><span class="line"><span class="comment">    chunked下该值为已接收请求长度到最大允许的长度large_client_header_buffers直接差值，用于判断是否超限</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">off_t</span>                             rest;</span><br><span class="line">    <span class="keyword">off_t</span>                             received;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                      *<span class="built_in">free</span>;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                      *busy;</span><br><span class="line">    <span class="comment">// 存储接收chunked请求时，接收状态</span></span><br><span class="line">    <span class="keyword">ngx_http_chunked_t</span>               *chunked;</span><br><span class="line">    <span class="comment">// 接收完成后的回调方法</span></span><br><span class="line">    ngx_http_client_body_handler_pt   post_handler;</span><br><span class="line">&#125; <span class="keyword">ngx_http_request_body_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="接收请求体ngx-http-read-client-request-body"><a href="#接收请求体ngx-http-read-client-request-body" class="headerlink" title="接收请求体ngx_http_read_client_request_body"></a>接收请求体ngx_http_read_client_request_body</h3><p>接收客户端请求通过<code>ngx_http_read_client_request_body</code>方法实现，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数post_handler为接受完成请求头后处理函数</span></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_read_client_request_body(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    ngx_http_client_body_handler_pt post_handler)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                     preread;</span><br><span class="line">    <span class="keyword">ssize_t</span>                    size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                out;</span><br><span class="line">    <span class="keyword">ngx_http_request_body_t</span>   *rb;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="comment">// 主请求上引用计数+1</span></span><br><span class="line">    r-&gt;main-&gt;count++;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    请求不是主请求，或者已经接收了请求体，或者需要丢弃请求体</span></span><br><span class="line"><span class="comment">    设置请求体没有buf存储，直接执行回调函数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main || r-&gt;request_body || r-&gt;discard_body) &#123;</span><br><span class="line">        r-&gt;request_body_no_buffering = <span class="number">0</span>;</span><br><span class="line">        post_handler(r);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Expect 是一个请求消息头，包含一个期望条件，表示服务器只有在满足此期望条件的情况下才能妥善地处理请求。</span></span><br><span class="line"><span class="comment">    规范中只规定了一个期望条件，即 Expect: 100-continue, 对此服务器可以做出如下回应：</span></span><br><span class="line"><span class="comment">    100 如果消息头中的期望条件可以得到满足，使得请求可以顺利进行的话，</span></span><br><span class="line"><span class="comment">    417 (Expectation Failed) 如果服务器不能满足期望条件的话；也可以是其他任意表示客户端错误的状态码（4xx）。</span></span><br><span class="line"><span class="comment">    这里进行判断，是否请求头包含该值，如果是，并且值为100-continue，则发送HTTP/1.1 100 Continue响应</span></span><br><span class="line"><span class="comment">    使用r-&gt;expect_tested记录是否发送过该值</span></span><br><span class="line"><span class="comment">    并且这次发送不会结果事件驱动的处理，nginx任务数据过少，正常情况下都应该能够立即发送完成。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_test_expect(r) != NGX_OK) &#123;</span><br><span class="line">        rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为请求分配一个ngx_http_request_body_t结构</span></span><br><span class="line">    rb = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_request_body_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (rb == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * set by ngx_pcalloc():</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     rb-&gt;bufs = NULL;</span></span><br><span class="line"><span class="comment">     *     rb-&gt;buf = NULL;</span></span><br><span class="line"><span class="comment">     *     rb-&gt;free = NULL;</span></span><br><span class="line"><span class="comment">     *     rb-&gt;busy = NULL;</span></span><br><span class="line"><span class="comment">     *     rb-&gt;chunked = NULL;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 设置还需要的字节为-1</span></span><br><span class="line">    rb-&gt;rest = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 设置回调方法</span></span><br><span class="line">    rb-&gt;post_handler = post_handler;</span><br><span class="line"></span><br><span class="line">    r-&gt;request_body = rb;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果请求未设置请求体长度，并且非chunked的请求，则直接执行回调方法</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.content_length_n &lt; <span class="number">0</span> &amp;&amp; !r-&gt;headers_in.chunked) &#123;</span><br><span class="line">        r-&gt;request_body_no_buffering = <span class="number">0</span>;</span><br><span class="line">        post_handler(r);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stream) &#123;</span><br><span class="line">        rc = ngx_http_v2_read_request_body(r);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查看是否响应头中还有部分数据，如果存在部分数据，就应该是请求体的数据</span></span><br><span class="line">    preread = r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 已经接收到部分请求体了</span></span><br><span class="line">    <span class="keyword">if</span> (preread) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* there is the pre-read part of the request body */</span></span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http client request body preread %uz"</span>, preread);</span><br><span class="line">        <span class="comment">// 设置buf</span></span><br><span class="line">        out.buf = r-&gt;header_in;</span><br><span class="line">        out.next = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 执行请求体处理方法，该方法对请求体执行过滤，和响应头和响应体一样，可以由模块定义过滤方法</span></span><br><span class="line">        rc = ngx_http_request_body_filter(r, &amp;out);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        增加请求长度，其中r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos为解析后，请求头中剩余未解析的长度</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        r-&gt;request_length += preread - (r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果非chunked请求，并且剩余需要的字节数小于header_in中剩余数据，说明header_in结构就完成存储了请求体</span></span><br><span class="line">        <span class="keyword">if</span> (!r-&gt;headers_in.chunked</span><br><span class="line">            &amp;&amp; rb-&gt;rest &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; rb-&gt;rest &lt;= (<span class="keyword">off_t</span>) (r-&gt;header_in-&gt;end - r-&gt;header_in-&gt;last))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* the whole request body may be placed in r-&gt;header_in */</span></span><br><span class="line">            <span class="comment">// 参加buf，并设置相关数据信息</span></span><br><span class="line">            b = ngx_calloc_buf(r-&gt;pool);</span><br><span class="line">            <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            b-&gt;temporary = <span class="number">1</span>;</span><br><span class="line">            b-&gt;start = r-&gt;header_in-&gt;pos;</span><br><span class="line">            b-&gt;pos = r-&gt;header_in-&gt;pos;</span><br><span class="line">            b-&gt;last = r-&gt;header_in-&gt;last;</span><br><span class="line">            b-&gt;end = r-&gt;header_in-&gt;end;</span><br><span class="line"></span><br><span class="line">            rb-&gt;buf = b;</span><br><span class="line"></span><br><span class="line">            r-&gt;read_event_handler = ngx_http_read_client_request_body_handler;</span><br><span class="line">            r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line"></span><br><span class="line">            rc = ngx_http_do_read_client_request_body(r);</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* set rb-&gt;rest */</span></span><br><span class="line">        <span class="comment">// 无数据时，仅会设置rb-&gt;rest</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_request_body_filter(r, <span class="literal">NULL</span>) != NGX_OK) &#123;</span><br><span class="line">            rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果rest为0，说明请求体已完成读取，执行回调方法</span></span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;rest == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* the whole request body was pre-read */</span></span><br><span class="line">        r-&gt;request_body_no_buffering = <span class="number">0</span>;</span><br><span class="line">        post_handler(r);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出错</span></span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;rest &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"negative request body rest"</span>);</span><br><span class="line">        rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    获取客户端请求体默认存储buf大小</span></span><br><span class="line"><span class="comment">    如果请求主体大于缓冲区，则将整个主体或仅其一部分写入临时文件。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    </span><br><span class="line">    size = clcf-&gt;client_body_buffer_size;</span><br><span class="line">    size += size &gt;&gt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> honor r-&gt;request_body_in_single_buf */</span></span><br><span class="line">    <span class="comment">// 尽可能保证请求体存在一个buf中</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;headers_in.chunked &amp;&amp; rb-&gt;rest &lt; size) &#123;</span><br><span class="line">        size = (<span class="keyword">ssize_t</span>) rb-&gt;rest;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;request_body_in_single_buf) &#123;</span><br><span class="line">            size += preread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        size = clcf-&gt;client_body_buffer_size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rb-&gt;buf = ngx_create_temp_buf(r-&gt;pool, size);</span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rc = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置请求读事件处理函数，写事件处理函数</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_read_client_request_body_handler;</span><br><span class="line">    r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line">    <span class="comment">// 执行执行一次请求体读取解析</span></span><br><span class="line">    rc = ngx_http_do_read_client_request_body(r);</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    <span class="comment">// 如果对请求体不需要缓存，即对每部分数据读取到后都立即执行处理</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;request_body_no_buffering</span><br><span class="line">        &amp;&amp; (rc == NGX_OK || rc == NGX_AGAIN))</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">// 请求完成</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            r-&gt;request_body_no_buffering = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 未完成，设置reading_body，表示还有数据需要读取</span></span><br><span class="line">            <span class="comment">/* rc == NGX_AGAIN */</span></span><br><span class="line">            r-&gt;reading_body = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置读事件为空</span></span><br><span class="line">        r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line">        <span class="comment">// 执行回调方法</span></span><br><span class="line">        post_handler(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">        r-&gt;main-&gt;count--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-request-body-filter"><a href="#ngx-http-request-body-filter" class="headerlink" title="ngx_http_request_body_filter"></a>ngx_http_request_body_filter</h4><p><code>ngx_http_request_body_filter</code>函数执行接收到的请求体处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_request_body_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 判断请求类型，决定处理方式</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.chunked) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_request_body_chunked_filter(r, in);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_request_body_length_filter(r, in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-request-body-chunked-filter"><a href="#ngx-http-request-body-chunked-filter" class="headerlink" title="ngx_http_request_body_chunked_filter"></a>ngx_http_request_body_chunked_filter</h4><p><code>ngx_http_request_body_chunked_filter</code>为chunked方式下对请求内容的处理。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_request_body_chunked_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                     size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>               *cl, *out, *tl, **ll;</span><br><span class="line">    <span class="keyword">ngx_http_request_body_t</span>   *rb;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line"></span><br><span class="line">    rb = r-&gt;request_body;</span><br><span class="line">    <span class="comment">// 如果未设置rest</span></span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;rest == <span class="number">-1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http request body chunked filter"</span>);</span><br><span class="line">        <span class="comment">// 构建chunked结构，用于存储解析chunked状态</span></span><br><span class="line">        rb-&gt;chunked = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_chunked_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (rb-&gt;chunked == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">        r-&gt;headers_in.content_length_n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 设置请求体最大buf大小</span></span><br><span class="line">        rb-&gt;rest = cscf-&gt;large_client_header_buffers.size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    out = <span class="literal">NULL</span>;</span><br><span class="line">    ll = &amp;out;</span><br><span class="line">    <span class="comment">// 遍历每个buf链表</span></span><br><span class="line">    <span class="keyword">for</span> (cl = in; cl; cl = cl-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">        b = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug7(NGX_LOG_DEBUG_EVENT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http body chunked buf "</span></span><br><span class="line">                           <span class="string">"t:%d f:%d %p, pos %p, size: %z file: %O, size: %O"</span>,</span><br><span class="line">                           cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,</span><br><span class="line">                           cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,</span><br><span class="line">                           cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,</span><br><span class="line">                           cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                           cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);</span><br><span class="line">            <span class="comment">// 解析chunked数据</span></span><br><span class="line">            rc = ngx_http_parse_chunked(r, cl-&gt;buf, rb-&gt;chunked);</span><br><span class="line">            <span class="comment">// 如果完成一个chunked的解析</span></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* a chunk has been parsed successfully */</span></span><br><span class="line"></span><br><span class="line">                clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">                <span class="comment">// 如果请求体过大，则报错返回</span></span><br><span class="line">                <span class="keyword">if</span> (clcf-&gt;client_max_body_size</span><br><span class="line">                    &amp;&amp; clcf-&gt;client_max_body_size</span><br><span class="line">                       - r-&gt;headers_in.content_length_n &lt; rb-&gt;chunked-&gt;size)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"client intended to send too large chunked "</span></span><br><span class="line">                                  <span class="string">"body: %O+%O bytes"</span>,</span><br><span class="line">                                  r-&gt;headers_in.content_length_n,</span><br><span class="line">                                  rb-&gt;chunked-&gt;size);</span><br><span class="line"></span><br><span class="line">                    r-&gt;lingering_close = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_HTTP_REQUEST_ENTITY_TOO_LARGE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 设置buf，将其添加到out链表中</span></span><br><span class="line">                <span class="keyword">if</span> (b</span><br><span class="line">                    &amp;&amp; rb-&gt;chunked-&gt;size &lt;= <span class="number">128</span></span><br><span class="line">                    &amp;&amp; cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos &gt;= rb-&gt;chunked-&gt;size)</span><br><span class="line">                &#123;</span><br><span class="line">                    r-&gt;headers_in.content_length_n += rb-&gt;chunked-&gt;size;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (rb-&gt;chunked-&gt;size &lt; <span class="number">8</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">while</span> (rb-&gt;chunked-&gt;size) &#123;</span><br><span class="line">                            *b-&gt;last++ = *cl-&gt;buf-&gt;pos++;</span><br><span class="line">                            rb-&gt;chunked-&gt;size--;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ngx_memmove(b-&gt;last, cl-&gt;buf-&gt;pos, rb-&gt;chunked-&gt;size);</span><br><span class="line">                        b-&gt;last += rb-&gt;chunked-&gt;size;</span><br><span class="line">                        cl-&gt;buf-&gt;pos += rb-&gt;chunked-&gt;size;</span><br><span class="line">                        rb-&gt;chunked-&gt;size = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                tl = ngx_chain_get_free_buf(r-&gt;pool, &amp;rb-&gt;<span class="built_in">free</span>);</span><br><span class="line">                <span class="keyword">if</span> (tl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                b = tl-&gt;buf;</span><br><span class="line"></span><br><span class="line">                ngx_memzero(b, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line"></span><br><span class="line">                b-&gt;temporary = <span class="number">1</span>;</span><br><span class="line">                b-&gt;tag = (<span class="keyword">ngx_buf_tag_t</span>) &amp;ngx_http_read_client_request_body;</span><br><span class="line">                b-&gt;start = cl-&gt;buf-&gt;pos;</span><br><span class="line">                b-&gt;pos = cl-&gt;buf-&gt;pos;</span><br><span class="line">                b-&gt;last = cl-&gt;buf-&gt;last;</span><br><span class="line">                b-&gt;end = cl-&gt;buf-&gt;end;</span><br><span class="line">                b-&gt;flush = r-&gt;request_body_no_buffering;</span><br><span class="line"></span><br><span class="line">                *ll = tl;</span><br><span class="line">                ll = &amp;tl-&gt;next;</span><br><span class="line"></span><br><span class="line">                size = cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">off_t</span>) size &gt; rb-&gt;chunked-&gt;size) &#123;</span><br><span class="line">                    cl-&gt;buf-&gt;pos += (<span class="keyword">size_t</span>) rb-&gt;chunked-&gt;size;</span><br><span class="line">                    r-&gt;headers_in.content_length_n += rb-&gt;chunked-&gt;size;</span><br><span class="line">                    rb-&gt;chunked-&gt;size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    rb-&gt;chunked-&gt;size -= size;</span><br><span class="line">                    r-&gt;headers_in.content_length_n += size;</span><br><span class="line">                    cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;last;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                b-&gt;last = cl-&gt;buf-&gt;pos;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果解析完成</span></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* a whole response has been parsed successfully */</span></span><br><span class="line">                <span class="comment">// 设置rest为0，表示不需要数据了</span></span><br><span class="line">                rb-&gt;rest = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 创建buf，标识为最后一个buf，加到out中</span></span><br><span class="line">                tl = ngx_chain_get_free_buf(r-&gt;pool, &amp;rb-&gt;<span class="built_in">free</span>);</span><br><span class="line">                <span class="keyword">if</span> (tl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                b = tl-&gt;buf;</span><br><span class="line"></span><br><span class="line">                ngx_memzero(b, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line"></span><br><span class="line">                b-&gt;last_buf = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                *ll = tl;</span><br><span class="line">                ll = &amp;tl-&gt;next;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* set rb-&gt;rest, amount of data we want to see next time */</span></span><br><span class="line"></span><br><span class="line">                cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">                rb-&gt;rest = ngx_max(rb-&gt;chunked-&gt;length,</span><br><span class="line">                               (<span class="keyword">off_t</span>) cscf-&gt;large_client_header_buffers.size);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* invalid */</span></span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"client sent invalid chunked body"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_BAD_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行ngx_http_top_request_body_filter过滤</span></span><br><span class="line">    rc = ngx_http_top_request_body_filter(r, out);</span><br><span class="line">    <span class="comment">// 更新buf链表</span></span><br><span class="line">    ngx_chain_update_chains(r-&gt;pool, &amp;rb-&gt;<span class="built_in">free</span>, &amp;rb-&gt;busy, &amp;out,</span><br><span class="line">                            (<span class="keyword">ngx_buf_tag_t</span>) &amp;ngx_http_read_client_request_body);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-request-body-length-filter"><a href="#ngx-http-request-body-length-filter" class="headerlink" title="ngx_http_request_body_length_filter"></a>ngx_http_request_body_length_filter</h4><p>该函数执行非chunked请求的请求体过滤函数。逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_request_body_length_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                     size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>               *cl, *tl, *out, **ll;</span><br><span class="line">    <span class="keyword">ngx_http_request_body_t</span>   *rb;</span><br><span class="line"></span><br><span class="line">    rb = r-&gt;request_body;</span><br><span class="line">    <span class="comment">// 如果rest还未设置，则设置为对应请求头中长度</span></span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;rest == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http request body content length filter"</span>);</span><br><span class="line"></span><br><span class="line">        rb-&gt;rest = r-&gt;headers_in.content_length_n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    out = <span class="literal">NULL</span>;</span><br><span class="line">    ll = &amp;out;</span><br><span class="line">    <span class="comment">// 遍历每一个inbuf</span></span><br><span class="line">    <span class="keyword">for</span> (cl = in; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">        <span class="comment">// 如果rest为0，表示完成了请求体的接收，跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (rb-&gt;rest == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从rb的free中获取一个空闲的buf</span></span><br><span class="line">        tl = ngx_chain_get_free_buf(r-&gt;pool, &amp;rb-&gt;<span class="built_in">free</span>);</span><br><span class="line">        <span class="keyword">if</span> (tl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b = tl-&gt;buf;</span><br><span class="line">        </span><br><span class="line">        ngx_memzero(b, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line">        <span class="comment">// 设置buf熟悉</span></span><br><span class="line">        b-&gt;temporary = <span class="number">1</span>;</span><br><span class="line">        b-&gt;tag = (<span class="keyword">ngx_buf_tag_t</span>) &amp;ngx_http_read_client_request_body;</span><br><span class="line">        <span class="comment">// 设置buf需要处理字段为当前in中buf字段</span></span><br><span class="line">        b-&gt;start = cl-&gt;buf-&gt;pos;</span><br><span class="line">        b-&gt;pos = cl-&gt;buf-&gt;pos;</span><br><span class="line">        b-&gt;last = cl-&gt;buf-&gt;last;</span><br><span class="line">        b-&gt;end = cl-&gt;buf-&gt;end;</span><br><span class="line">        <span class="comment">// 判断是否需要flush，request_body_no_buffering表示是否需要将请求写到文件中1表示不需要，0表示需要</span></span><br><span class="line">        b-&gt;flush = r-&gt;request_body_no_buffering;</span><br><span class="line">        <span class="comment">// 获取字段长度</span></span><br><span class="line">        size = cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos;</span><br><span class="line">        <span class="comment">// 如果长度小于需要剩余的字段，则更新rest，并设置cl全部已处理</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">off_t</span>) size &lt; rb-&gt;rest) &#123;</span><br><span class="line">            cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;last;</span><br><span class="line">            rb-&gt;rest -= size;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则，更新buf到对应结尾位置</span></span><br><span class="line">            cl-&gt;buf-&gt;pos += (<span class="keyword">size_t</span>) rb-&gt;rest;</span><br><span class="line">            <span class="comment">// 设置rest</span></span><br><span class="line">            rb-&gt;rest = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 设置buf的last为结尾位置</span></span><br><span class="line">            b-&gt;last = cl-&gt;buf-&gt;pos;</span><br><span class="line">            <span class="comment">// 设置是最后一个buf</span></span><br><span class="line">            b-&gt;last_buf = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将其添加到out链表中</span></span><br><span class="line">        *ll = tl;</span><br><span class="line">        ll = &amp;tl-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行ngx_http_top_request_body_filter过滤函数</span></span><br><span class="line">    rc = ngx_http_top_request_body_filter(r, out);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新链表</span></span><br><span class="line">    ngx_chain_update_chains(r-&gt;pool, &amp;rb-&gt;<span class="built_in">free</span>, &amp;rb-&gt;busy, &amp;out,</span><br><span class="line">                            (<span class="keyword">ngx_buf_tag_t</span>) &amp;ngx_http_read_client_request_body);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>request_body_no_buffering标志启用读取请求主体的非缓冲模式。 在这种模式下，在调用ngx_http_read_client_request_body之后，bufs链可能仅保留正文的一部分。 要阅读下一部分，需调用ngx_http_read_unbuffered_request_body函数。 返回值NGX_AGAIN和请求标志reading_body表示有更多数据可用。 如果在调用此函数后bufs为NULL，那么此刻没有任何可读的内容。 请求回调read_event_handler将在请求主体的下一部分可用时被调用。</p>
<h4 id="ngx-http-top-request-body-filter"><a href="#ngx-http-top-request-body-filter" class="headerlink" title="ngx_http_top_request_body_filter"></a>ngx_http_top_request_body_filter</h4><p><code>ngx_http_top_request_body_filter</code>方法与请求体和请求头过滤函数类似，可以通过每个模块设置next来串联成一个链表，目前该模块就只有一个函数<code>ngx_http_request_body_save_filter</code>，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_request_body_save_filter(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_chain_t</span> *in)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>               *cl;</span><br><span class="line">    <span class="keyword">ngx_http_request_body_t</span>   *rb;</span><br><span class="line"></span><br><span class="line">    rb = r-&gt;request_body;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 遍历，记录日志</span></span><br><span class="line">    <span class="keyword">for</span> (cl = in; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">        ngx_log_debug7(NGX_LOG_DEBUG_EVENT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http body new buf t:%d f:%d %p, pos %p, size: %z "</span></span><br><span class="line">                       <span class="string">"file: %O, size: %O"</span>,</span><br><span class="line">                       cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,</span><br><span class="line">                       cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,</span><br><span class="line">                       cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,</span><br><span class="line">                       cl-&gt;buf-&gt;file_pos,</span><br><span class="line">                       cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> coalesce neighbouring buffers */</span></span><br><span class="line">    <span class="comment">// 将in数组追加到rb-bufs后，这里不是简单拼接，而是为每一个元素生成一个ngx_chain_t结构，不过其中的buf依然是以前的buf</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_chain_add_copy(r-&gt;pool, &amp;rb-&gt;bufs, in) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果不需要写入，则结束，否则执行写入临时文件逻辑，这里暂时不做介绍。</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;request_body_no_buffering) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;rest &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rb-&gt;buf &amp;&amp; rb-&gt;buf-&gt;last == rb-&gt;buf-&gt;end</span><br><span class="line">            &amp;&amp; ngx_http_write_request_body(r) != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rb-&gt;rest == 0 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rb-&gt;temp_file || r-&gt;request_body_in_file_only) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_write_request_body(r) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rb-&gt;temp_file-&gt;file.offset != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            cl = ngx_chain_get_free_buf(r-&gt;pool, &amp;rb-&gt;<span class="built_in">free</span>);</span><br><span class="line">            <span class="keyword">if</span> (cl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            b = cl-&gt;buf;</span><br><span class="line"></span><br><span class="line">            ngx_memzero(b, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line"></span><br><span class="line">            b-&gt;in_file = <span class="number">1</span>;</span><br><span class="line">            b-&gt;file_last = rb-&gt;temp_file-&gt;file.offset;</span><br><span class="line">            b-&gt;file = &amp;rb-&gt;temp_file-&gt;file;</span><br><span class="line"></span><br><span class="line">            rb-&gt;bufs = cl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-chain-update-chains"><a href="#ngx-chain-update-chains" class="headerlink" title="ngx_chain_update_chains"></a>ngx_chain_update_chains</h4><p>`该·函数更新链表，释放已经添加到rb-&gt;bufs中的链表，用于后续再次接收数据。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_chain_update_chains(<span class="keyword">ngx_pool_t</span> *p, <span class="keyword">ngx_chain_t</span> **<span class="built_in">free</span>, <span class="keyword">ngx_chain_t</span> **busy,</span><br><span class="line">    <span class="keyword">ngx_chain_t</span> **out, <span class="keyword">ngx_buf_tag_t</span> tag)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>  *cl;</span><br><span class="line">    <span class="comment">// 将out加到busy队列中</span></span><br><span class="line">    <span class="keyword">if</span> (*out) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*busy == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            *busy = *out;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (cl = *busy; cl-&gt;next; cl = cl-&gt;next) &#123; <span class="comment">/* void */</span> &#125;</span><br><span class="line"></span><br><span class="line">            cl-&gt;next = *out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *out = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 删除busy队列中已经处理完成的元素，将其添加到free队列中,保留未处理完成的buf</span></span><br><span class="line">    <span class="keyword">while</span> (*busy) &#123;</span><br><span class="line">        cl = *busy;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_buf_size(cl-&gt;buf) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl-&gt;buf-&gt;tag != tag) &#123;</span><br><span class="line">            *busy = cl-&gt;next;</span><br><span class="line">            ngx_free_chain(p, cl);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;start;</span><br><span class="line">        cl-&gt;buf-&gt;last = cl-&gt;buf-&gt;start;</span><br><span class="line"></span><br><span class="line">        *busy = cl-&gt;next;</span><br><span class="line">        cl-&gt;next = *<span class="built_in">free</span>;</span><br><span class="line">        *<span class="built_in">free</span> = cl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-do-read-client-request-body"><a href="#ngx-http-do-read-client-request-body" class="headerlink" title="ngx_http_do_read_client_request_body"></a>ngx_http_do_read_client_request_body</h4><p>该方法执行请求体解析，并且是读请求体时的事件循环，逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_do_read_client_request_body(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">off_t</span>                      rest;</span><br><span class="line">    <span class="keyword">size_t</span>                     size;</span><br><span class="line">    <span class="keyword">ssize_t</span>                    n;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                out;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_request_body_t</span>   *rb;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    rb = r-&gt;request_body;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http read client request body"</span>);</span><br><span class="line">    <span class="comment">// 循环读取请求体</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">            <span class="comment">// 如果buf已经使用完</span></span><br><span class="line">            <span class="keyword">if</span> (rb-&gt;buf-&gt;last == rb-&gt;buf-&gt;end) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* update chains */</span></span><br><span class="line">                <span class="comment">// 更新空闲链表</span></span><br><span class="line">                rc = ngx_http_request_body_filter(r, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> rc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 更新完成后，正常busy应该是空的，在request_body_no_buffering模式下不为空</span></span><br><span class="line">                <span class="keyword">if</span> (rb-&gt;busy != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    request_body_no_buffering不缓存请求体情况下，</span></span><br><span class="line"><span class="comment">                    对于每次读取到的数据，应该由调用方决定如何使用，此时应该直接返回读取到的数据</span></span><br><span class="line"><span class="comment">                    非request_body_no_buffering下，会缓存请求体，最终使用post_handler处理</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    <span class="keyword">if</span> (r-&gt;request_body_no_buffering) &#123;</span><br><span class="line">                        <span class="comment">// 如果设置了读取事件，则删除</span></span><br><span class="line">                        <span class="keyword">if</span> (c-&gt;read-&gt;timer_set) &#123;</span><br><span class="line">                            ngx_del_timer(c-&gt;read);</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 确保读事件在epoll中</span></span><br><span class="line">                        <span class="keyword">if</span> (ngx_handle_read_event(c-&gt;read, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 非request_body_no_buffering模式下，busy为空则是错误</span></span><br><span class="line">                    <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 重新使用buf空间（对应缓存请求体模式时，实际数据已经写入了文件中）</span></span><br><span class="line">                rb-&gt;buf-&gt;pos = rb-&gt;buf-&gt;start;</span><br><span class="line">                rb-&gt;buf-&gt;last = rb-&gt;buf-&gt;start;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取需要读取数据大小</span></span><br><span class="line">            size = rb-&gt;buf-&gt;end - rb-&gt;buf-&gt;last;</span><br><span class="line">            rest = rb-&gt;rest - (rb-&gt;buf-&gt;last - rb-&gt;buf-&gt;pos);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">off_t</span>) size &gt; rest) &#123;</span><br><span class="line">                size = (<span class="keyword">size_t</span>) rest;</span><br><span class="line">            &#125;</span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 接收数据，并设置c-&gt;read-&gt;ready值，参考ngx_unix_recv方法</span></span><br><span class="line">            n = c-&gt;recv(c, rb-&gt;buf-&gt;last, size);</span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http client request body recv %z"</span>, n);</span><br><span class="line">            <span class="comment">// 返回again</span></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_AGAIN) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"client prematurely closed connection"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回错误</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span> || n == NGX_ERROR) &#123;</span><br><span class="line">                c-&gt;error = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_BAD_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置buf使用到的位置</span></span><br><span class="line">            rb-&gt;buf-&gt;last += n;</span><br><span class="line">            <span class="comment">// 增加请求体长度</span></span><br><span class="line">            r-&gt;request_length += n;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* pass buffer to request body filter chain */</span></span><br><span class="line">            <span class="comment">// 执行请求体过滤方法</span></span><br><span class="line">            out.buf = rb-&gt;buf;</span><br><span class="line">            out.next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            rc = ngx_http_request_body_filter(r, &amp;out);</span><br><span class="line">            <span class="comment">// 不是ok，直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> rc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取请求体完成</span></span><br><span class="line">            <span class="keyword">if</span> (rb-&gt;rest == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rb-&gt;buf-&gt;last &lt; rb-&gt;buf-&gt;end) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http client request body rest %O"</span>, rb-&gt;rest);</span><br><span class="line">        <span class="comment">// 获取到了完整请求体</span></span><br><span class="line">        <span class="keyword">if</span> (rb-&gt;rest == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果读取未准备好，则返回</span></span><br><span class="line">        <span class="keyword">if</span> (!c-&gt;read-&gt;ready) &#123;</span><br><span class="line">            <span class="comment">// 添加读取请求体超时时间</span></span><br><span class="line">            <span class="comment">// 超时仅针对两次连续读取操作之间的一段时间设置，而不是针对整个请求正文的传输。</span></span><br><span class="line">            clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">            ngx_add_timer(c-&gt;read, clcf-&gt;client_body_timeout);</span><br><span class="line">            <span class="comment">// 确保读事件在epoll中</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_handle_read_event(c-&gt;read, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回again，表示未完成</span></span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求中存在部分pipelined请求，则执行对应的存储buf的拷贝，这里不详细介绍，结束请求部分会详细介绍pipelined请求</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_copy_pipelined_header(r, rb-&gt;buf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果依然存在读事件在红黑树中，则删除</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;read-&gt;timer_set) &#123;</span><br><span class="line">        ngx_del_timer(c-&gt;read);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 非请求体无缓存模式，即请求体缓存模式下，执行post_handler方法，非缓存模式下应当有调用方决定执行逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;request_body_no_buffering) &#123;</span><br><span class="line">        r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line">        rb-&gt;post_handler(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-read-client-request-body-handler"><a href="#ngx-http-read-client-request-body-handler" class="headerlink" title="ngx_http_read_client_request_body_handler"></a>ngx_http_read_client_request_body_handler</h4><p><code>ngx_http_read_client_request_body_handler</code>方法是无法一次就完整读取请求体时设置的请求读事件方法，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_read_client_request_body_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>  rc;</span><br><span class="line">    <span class="comment">// 如果读事件超时，使用408返回码结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;connection-&gt;read-&gt;timedout) &#123;</span><br><span class="line">        r-&gt;connection-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_REQUEST_TIME_OUT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行读取函数</span></span><br><span class="line">    rc = ngx_http_do_read_client_request_body(r);</span><br><span class="line">    <span class="comment">// 如果返回错误 &gt;= 300,则直接结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, rc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-discard-request-body丢弃请求体"><a href="#ngx-http-discard-request-body丢弃请求体" class="headerlink" title="ngx_http_discard_request_body丢弃请求体"></a>ngx_http_discard_request_body丢弃请求体</h3><p>除了需要接收请求体外，可以选择直接丢弃请求体，丢弃不是意味着不接受，而是接收后不做任何处理，直接丢弃。如果不接收请求体，将导致和客户端的连接异常。<code>ngx_http_discard_request_body</code>方法用来接收请求体，其逻辑相比于接收请求体的<code>ngx_http_read_client_request_body</code>方法更简单一些：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_discard_request_body(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>       size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>     rc;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>  *rev;</span><br><span class="line">    <span class="comment">// 如果不是主请求，或者已经完成了请求体丢弃，或者已经设置了接收请求体，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main || r-&gt;discard_body || r-&gt;request_body) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stream) &#123;</span><br><span class="line">        r-&gt;stream-&gt;skip_data = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 和接收请求体时一样，判断expect</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_test_expect(r) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rev = r-&gt;connection-&gt;read;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, rev-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http set discard body"</span>);</span><br><span class="line">    <span class="comment">// 如果设置了读事件超时，则删除</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timer_set) &#123;</span><br><span class="line">        ngx_del_timer(rev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 请求体长度小于0，并且是非chunked请求，则立即返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.content_length_n &lt;= <span class="number">0</span> &amp;&amp; !r-&gt;headers_in.chunked) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果请求头中存在部分请求体，或者是chunked请求，执行丢弃请求体过滤函数，</span></span><br><span class="line"><span class="comment">    该函数主要用于判断是否结束和是否出错</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (size || r-&gt;headers_in.chunked) &#123;</span><br><span class="line">        rc = ngx_http_discard_request_body_filter(r, r-&gt;header_in);</span><br><span class="line">        <span class="comment">// 出错直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> rc;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_in.content_length_n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取请求体，直接丢弃（不做任何处理）</span></span><br><span class="line">    rc = ngx_http_read_discarded_request_body(r);</span><br><span class="line">    <span class="comment">// 成功，直接返回，并不用延迟关闭</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">        r-&gt;lingering_close = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出错，立即返回</span></span><br><span class="line">    <span class="keyword">if</span> (rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_AGAIN */</span></span><br><span class="line">    <span class="comment">// 如果未读取完全，则设置请求的读取事件，该事件重复执行ngx_http_read_discarded_request_body方法</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_discarded_request_body_handler;</span><br><span class="line">    <span class="comment">// 确保读事件在epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// count自增1，避免该请求下的其余请求关闭该请求</span></span><br><span class="line">    r-&gt;count++;</span><br><span class="line">    <span class="comment">// 设置正在执行丢弃请求体</span></span><br><span class="line">    r-&gt;discard_body = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里整体执行逻辑与接收请求体类似，例如<code>ngx_http_read_discarded_request_body</code>对应接收请求体的<code>ngx_http_do_read_client_request_body</code>，<code>ngx_http_discarded_request_body_handler</code>对应<code>ngx_http_read_client_request_body_handler</code>方法，这里不做详细介绍。</p>
<h2 id="结束请求ngx-http-finalize-request"><a href="#结束请求ngx-http-finalize-request" class="headerlink" title="结束请求ngx_http_finalize_request"></a>结束请求ngx_http_finalize_request</h2><p>前文很多地方使用了该方法，作为响应结束，这里详细讲解该函数执行逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_finalize_request(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>        *pr;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug5(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http finalize request: %i, \"%V?%V\" a:%d, c:%d"</span>,</span><br><span class="line">                   rc, &amp;r-&gt;uri, &amp;r-&gt;args, r == c-&gt;data, r-&gt;main-&gt;count);</span><br><span class="line">    <span class="comment">// 如果返回完成，则调用ngx_http_finalize_connection结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line">        ngx_http_finalize_connection(r);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果返回ok，但过滤链表执行出错了，则记录连接error</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK &amp;&amp; r-&gt;filter_finalize) &#123;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    如果响应为NGX_DECLINED，设置content_handler为空，，然后继续执行后续的处理阶段</span></span><br><span class="line"><span class="comment">    这里可以在NGX_HTTP_CONTENT_PHASE阶段模块实现的函数返回后，设置继续处理后续阶段</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        r-&gt;content_handler = <span class="literal">NULL</span>;</span><br><span class="line">        r-&gt;write_event_handler = ngx_http_core_run_phases;</span><br><span class="line">        ngx_http_core_run_phases(r);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 前不是主请求，并且请求存在子请求，则执行子请求的处理函数</span></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main &amp;&amp; r-&gt;post_subrequest) &#123;</span><br><span class="line">        rc = r-&gt;post_subrequest-&gt;handler(r, r-&gt;post_subrequest-&gt;data, rc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果前一个返回为error，或者，返回为408（超时）|499（客户端已关闭）|出错</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR</span><br><span class="line">        || rc == NGX_HTTP_REQUEST_TIME_OUT</span><br><span class="line">        || rc == NGX_HTTP_CLIENT_CLOSED_REQUEST</span><br><span class="line">        || c-&gt;error)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 执行请求的post action,如果成功，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_post_action(r) == NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 结束请求</span></span><br><span class="line">        ngx_http_terminate_request(r, rc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (rc &gt;= NGX_HTTP_SPECIAL_RESPONSE <span class="comment">// 300 </span></span><br><span class="line">        || rc == NGX_HTTP_CREATED <span class="comment">// 201 成功请求并创建了资源，通常为post请求。</span></span><br><span class="line">        || rc == NGX_HTTP_NO_CONTENT) <span class="comment">// 204 无内容</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// rc为444，无响应，设置连接超时，结束请求</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_HTTP_CLOSE) &#123;</span><br><span class="line">            c-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">            ngx_http_terminate_request(r, rc);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果连接为主请求，从事件红黑树中删除读写事件</span></span><br><span class="line">        <span class="keyword">if</span> (r == r-&gt;main) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c-&gt;read-&gt;timer_set) &#123;</span><br><span class="line">                ngx_del_timer(c-&gt;read);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c-&gt;write-&gt;timer_set) &#123;</span><br><span class="line">                ngx_del_timer(c-&gt;write);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置连接的读写事件为ngx_http_request_handler，仅在epoll事件驱动中触发事件时执行</span></span><br><span class="line">        c-&gt;read-&gt;handler = ngx_http_request_handler;</span><br><span class="line">        c-&gt;write-&gt;handler = ngx_http_request_handler;</span><br><span class="line">        <span class="comment">// 执行ngx_http_special_response_handler并结束请求</span></span><br><span class="line">        ngx_http_finalize_request(r, ngx_http_special_response_handler(r, rc));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果请求不是主请求</span></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main) &#123;</span><br><span class="line">        <span class="comment">// 如果请求中还有数据未发送，参考ngx_http_writer_filter函数，或者还有子请求</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;buffered || r-&gt;postponed) &#123;</span><br><span class="line">            <span class="comment">// 设置写事件为ngx_http_writer</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_set_write_handler(r) != NGX_OK) &#123;</span><br><span class="line">                ngx_http_terminate_request(r, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取请求的父请求</span></span><br><span class="line">        pr = r-&gt;parent;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        该子请求已经处理完毕，如果它拥有发送数据的权利，则将权利移交给父请求</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (r == c-&gt;data || r-&gt;background) &#123;</span><br><span class="line">            <span class="comment">// 记录log</span></span><br><span class="line">            <span class="keyword">if</span> (!r-&gt;logged) &#123;</span><br><span class="line"></span><br><span class="line">                clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (clcf-&gt;log_subrequest) &#123;</span><br><span class="line">                    ngx_http_log_request(r);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                r-&gt;logged = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"subrequest: \"%V?%V\" logged again"</span>,</span><br><span class="line">                              &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置请求完成</span></span><br><span class="line">            r-&gt;done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;background) &#123;</span><br><span class="line">                ngx_http_finalize_connection(r);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 主请求数量减1</span></span><br><span class="line">            r-&gt;main-&gt;count--;</span><br><span class="line">            <span class="comment">/* 如果该子请求不是提前完成，则从父请求的postponed链表中删除 */</span></span><br><span class="line">            <span class="keyword">if</span> (pr-&gt;postponed &amp;&amp; pr-&gt;postponed-&gt;request == r) &#123;</span><br><span class="line">                pr-&gt;postponed = pr-&gt;postponed-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* 将发送权利移交给父请求，父请求下次执行的时候会发送它的postponed链表中可以</span></span><br><span class="line"><span class="comment">               发送的数据节点，或者将发送权利移交给它的下一个子请求 */</span></span><br><span class="line">            c-&gt;data = pr;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http finalize non-active request: \"%V?%V\""</span>,</span><br><span class="line">                           &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">            到这里其实表明该子请求提前执行完成，而且它没有产生任何数据，则它下次再次获得</span></span><br><span class="line"><span class="comment">            执行机会时，将会执行ngx_http_request_finalzier函数，它实际上是执行</span></span><br><span class="line"><span class="comment">            ngx_http_finalzie_request（r,0），也就是什么都不干，直到轮到它发送数据时，</span></span><br><span class="line"><span class="comment">            ngx_http_finalzie_request函数会将它从父请求的postponed链表中删除 </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            r-&gt;write_event_handler = ngx_http_request_finalizer;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;waited) &#123;</span><br><span class="line">                r-&gt;done = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 将父请求加入posted_request队尾，获得一次运行机会 */</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_post_request(pr, <span class="literal">NULL</span>) != NGX_OK) &#123;</span><br><span class="line">            r-&gt;main-&gt;count++;</span><br><span class="line">            ngx_http_terminate_request(r, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http wake parent request: \"%V?%V\""</span>,</span><br><span class="line">                       &amp;pr-&gt;uri, &amp;pr-&gt;args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    这里是处理主请求结束的逻辑，如果主请求有未发送的数据或者未处理的子请求，</span></span><br><span class="line"><span class="comment">    则给主请求添加写事件，并设置合适的write event hander，</span></span><br><span class="line"><span class="comment">    以便下次写事件来的时候继续处理 </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;buffered || c-&gt;buffered || r-&gt;postponed) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_set_write_handler(r) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_terminate_request(r, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != c-&gt;data) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"http finalize non-active request: \"%V?%V\""</span>,</span><br><span class="line">                      &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 请求完成</span></span><br><span class="line">    r-&gt;done = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置请求的读写事件均为空</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line">    r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line">    <span class="comment">// 如果没有post_action请求，则记录请求完成</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;post_action) &#123;</span><br><span class="line">        r-&gt;request_complete = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行post_action请求</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_post_action(r) == NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从事件红黑树中删除读写事件</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;read-&gt;timer_set) &#123;</span><br><span class="line">        ngx_del_timer(c-&gt;read);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;write-&gt;timer_set) &#123;</span><br><span class="line">        c-&gt;write-&gt;delayed = <span class="number">0</span>;</span><br><span class="line">        ngx_del_timer(c-&gt;write);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果客户端关闭连接，直接关闭请求</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;read-&gt;eof) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则执行结束连接</span></span><br><span class="line">    ngx_http_finalize_connection(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述内容中存在大量子请求相关信息，具体会在代理转发中详细介绍。</p>
<h3 id="ngx-http-finalize-connection"><a href="#ngx-http-finalize-connection" class="headerlink" title="ngx_http_finalize_connection"></a>ngx_http_finalize_connection</h3><p>该函数为请求结束，对连接进行处理，主要包括是否需要保持连接，以及对请求体的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_finalize_connection(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stream) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果主请求不为1</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;main-&gt;count != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果需要丢弃请求体</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;discard_body) &#123;</span><br><span class="line">            <span class="comment">// 设置请求读事件处理函数为丢弃请求体</span></span><br><span class="line">            r-&gt;read_event_handler = ngx_http_discarded_request_body_handler;</span><br><span class="line">            <span class="comment">// 增加到事件红黑树中，超时事件为lingering_timeout配置</span></span><br><span class="line">            ngx_add_timer(r-&gt;connection-&gt;read, clcf-&gt;lingering_timeout);</span><br><span class="line">            <span class="comment">// 设置延迟关闭时间</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;lingering_time == <span class="number">0</span>) &#123;</span><br><span class="line">                r-&gt;lingering_time = ngx_time()</span><br><span class="line">                                      + (<span class="keyword">time_t</span>) (clcf-&gt;lingering_time / <span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行关闭请求，并返回</span></span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取主请求</span></span><br><span class="line">    r = r-&gt;main;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果正在读取请求体，则设置keepalive为0</span></span><br><span class="line"><span class="comment">    （这里设置keepalive是在请求完全结束时设置，</span></span><br><span class="line"><span class="comment">    如果还在读取请求头，则不应该进行该设置，因此将该值置0）</span></span><br><span class="line"><span class="comment">    设置需要延迟关闭</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;reading_body) &#123;</span><br><span class="line">        r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">        r-&gt;lingering_close = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果未收到需要关机信号，并且需要keepalive，则设置长连接</span></span><br><span class="line">    <span class="keyword">if</span> (!ngx_terminate</span><br><span class="line">         &amp;&amp; !ngx_exiting</span><br><span class="line">         &amp;&amp; r-&gt;keepalive</span><br><span class="line">         &amp;&amp; clcf-&gt;keepalive_timeout &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_http_set_keepalive(r);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要延迟关闭时，设置延迟关闭，并返回</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;lingering_close == NGX_HTTP_LINGERING_ALWAYS</span><br><span class="line">        || (clcf-&gt;lingering_close == NGX_HTTP_LINGERING_ON</span><br><span class="line">            &amp;&amp; (r-&gt;lingering_close</span><br><span class="line">                || r-&gt;header_in-&gt;pos &lt; r-&gt;header_in-&gt;last</span><br><span class="line">                || r-&gt;connection-&gt;read-&gt;ready)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设置延迟关闭，先关闭套接字的写端</span></span><br><span class="line"><span class="comment">        设置读事件处理函数为ngx_http_lingering_close_handler</span></span><br><span class="line"><span class="comment">        设置写事件为空</span></span><br><span class="line"><span class="comment">        ngx_http_lingering_close_handler函数读取套接字，直到结束或者超过延迟关闭事件</span></span><br><span class="line"><span class="comment">        完成读取后调用ngx_http_close_request关闭请求</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        ngx_http_set_lingering_close(r);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则，结束请求</span></span><br><span class="line">    ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-discarded-request-body-handler"><a href="#ngx-http-discarded-request-body-handler" class="headerlink" title="ngx_http_discarded_request_body_handler"></a>ngx_http_discarded_request_body_handler</h4><p>该事件处理丢失请求体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_discarded_request_body_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                 timer;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>               *rev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line">    <span class="comment">// 如果超时，则直接结束返回</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line">        c-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果设置了lingering_time，则比较超时时间是否达到，达到直接结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;lingering_time) &#123;</span><br><span class="line">        timer = (<span class="keyword">ngx_msec_t</span>) r-&gt;lingering_time - (<span class="keyword">ngx_msec_t</span>) ngx_time();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">ngx_msec_int_t</span>) timer &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;discard_body = <span class="number">0</span>;</span><br><span class="line">            r-&gt;lingering_close = <span class="number">0</span>;</span><br><span class="line">            ngx_http_finalize_request(r, NGX_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        timer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行读取响应体并丢弃</span></span><br><span class="line">    rc = ngx_http_read_discarded_request_body(r);</span><br><span class="line">    <span class="comment">// 返回ok，表示完成，调用ngx_http_finalize_request结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">        r-&gt;discard_body = <span class="number">0</span>; <span class="comment">// 不需要再读取请求体了</span></span><br><span class="line">        r-&gt;lingering_close = <span class="number">0</span>;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_DONE);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果返回大于30x，则直接出错结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_AGAIN */</span></span><br><span class="line">    <span class="comment">// 将读事件添加到epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果设置了lingering_time，并且未超时，则计算新的超时时间，添加到红黑树中</span></span><br><span class="line">    <span class="keyword">if</span> (timer) &#123;</span><br><span class="line"></span><br><span class="line">        clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">        timer *= <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timer &gt; clcf-&gt;lingering_timeout) &#123;</span><br><span class="line">            timer = clcf-&gt;lingering_timeout;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_add_timer(rev, timer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-set-keepalive"><a href="#ngx-http-set-keepalive" class="headerlink" title="ngx_http_set_keepalive"></a>ngx_http_set_keepalive</h4><p>如果请求是长连接，并且nginx支持长连接，且未达到长连接超时条件，则设置连接为长连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_set_keepalive(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                        tcp_nodelay;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                 *b, *f;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>               *cl, *ln;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>               *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>     *hc;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"set http keepalive handler"</span>);</span><br><span class="line">    <span class="comment">// 如果正在接收响应体，并丢弃响应体</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;discard_body) &#123;</span><br><span class="line">        <span class="comment">// 设置写事件为空</span></span><br><span class="line">        r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line">        <span class="comment">// 设置读取响应体超时时间</span></span><br><span class="line">        r-&gt;lingering_time = ngx_time() + (<span class="keyword">time_t</span>) (clcf-&gt;lingering_time / <span class="number">1000</span>);</span><br><span class="line">        ngx_add_timer(rev, clcf-&gt;lingering_timeout);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"closing request"</span>;</span><br><span class="line">    <span class="comment">// 获取请求对应的信息</span></span><br><span class="line">    hc = r-&gt;http_connection;</span><br><span class="line">    <span class="comment">// 获取存储请求的缓冲区</span></span><br><span class="line">    b = r-&gt;header_in;</span><br><span class="line">    <span class="comment">// 如果buf中存在未处理的数据，表示是存在另一个请求，即pipelined请求</span></span><br><span class="line">    <span class="keyword">if</span> (b-&gt;pos &lt; b-&gt;last) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the pipelined request */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果header_in使用的buf不是连接的buffer</span></span><br><span class="line"><span class="comment">        （当请求头使用的buffer过大时，将分配额外的空间，这时使用的buffer就不是连接对应的buffer了）</span></span><br><span class="line"><span class="comment">        则使用的是http_connection中对应的buf</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (b != c-&gt;buffer) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * If the large header buffers were allocated while the previous</span></span><br><span class="line"><span class="comment">             * request processing then we do not use c-&gt;buffer for</span></span><br><span class="line"><span class="comment">             * the pipelined request (see ngx_http_create_request()).</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * Now we would move the large header buffers to the free list.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">// 回收之前未使用的buf</span></span><br><span class="line">            <span class="keyword">for</span> (cl = hc-&gt;busy; cl; <span class="comment">/* void */</span>) &#123;</span><br><span class="line">                ln = cl;</span><br><span class="line">                cl = cl-&gt;next;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ln-&gt;buf == b) &#123;</span><br><span class="line">                    ngx_free_chain(c-&gt;pool, ln);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                f = ln-&gt;buf;</span><br><span class="line">                f-&gt;pos = f-&gt;start;</span><br><span class="line">                f-&gt;last = f-&gt;start;</span><br><span class="line"></span><br><span class="line">                ln-&gt;next = hc-&gt;<span class="built_in">free</span>;</span><br><span class="line">                hc-&gt;<span class="built_in">free</span> = ln;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建一下新的ngx_chain_t</span></span><br><span class="line">            cl = ngx_alloc_chain_link(c-&gt;pool);</span><br><span class="line">            <span class="keyword">if</span> (cl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置对应的buf</span></span><br><span class="line">            cl-&gt;buf = b;</span><br><span class="line">            cl-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">            </span><br><span class="line">            hc-&gt;busy = cl;</span><br><span class="line">            hc-&gt;nbusy = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* guard against recursive call from ngx_http_finalize_connection() */</span></span><br><span class="line">    <span class="comment">// 为防止造成ngx_http_finalize_connection()递归调用，设置keepalive为0</span></span><br><span class="line">    r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 释放请求</span></span><br><span class="line">    ngx_http_free_request(r, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// data绑定到hc上</span></span><br><span class="line">    c-&gt;data = hc;</span><br><span class="line">    <span class="comment">// 添加读事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置写事件为空方法</span></span><br><span class="line">    wev = c-&gt;write;</span><br><span class="line">    wev-&gt;handler = ngx_http_empty_handler;</span><br><span class="line">    <span class="comment">// 如果存在新的请求</span></span><br><span class="line">    <span class="keyword">if</span> (b-&gt;pos &lt; b-&gt;last) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"pipelined request"</span>);</span><br><span class="line"></span><br><span class="line">        c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading client pipelined request line"</span>;</span><br><span class="line">        <span class="comment">// 新建一个请求</span></span><br><span class="line">        r = ngx_http_create_request(c);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置请求为pipeline的</span></span><br><span class="line">        r-&gt;pipeline = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        c-&gt;data = r;</span><br><span class="line"></span><br><span class="line">        c-&gt;sent = <span class="number">0</span>;</span><br><span class="line">        c-&gt;destroyed = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 如果读事件在事件红黑树中，则从中删除</span></span><br><span class="line">        <span class="keyword">if</span> (rev-&gt;timer_set) &#123;</span><br><span class="line">            ngx_del_timer(rev);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置读事件处理函数为读取请求行，执行新的请求处理，添加到全局变量ngx_posted_events，在worker主循环中进行处理</span></span><br><span class="line">        rev-&gt;handler = ngx_http_process_request_line;</span><br><span class="line">        ngx_post_event(rev, &amp;ngx_posted_events);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * To keep a memory footprint as small as possible for an idle keepalive</span></span><br><span class="line"><span class="comment">     * connection we try to free c-&gt;buffer's memory if it was allocated outside</span></span><br><span class="line"><span class="comment">     * the c-&gt;pool.  The large header buffers are always allocated outside the</span></span><br><span class="line"><span class="comment">     * c-&gt;pool and are freed too.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 释放buffer空间，保证空闲的连接占用空间尽可能小</span></span><br><span class="line">    b = c-&gt;buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_pfree(c-&gt;pool, b-&gt;start) == NGX_OK) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the special note for ngx_http_keepalive_handler() that</span></span><br><span class="line"><span class="comment">         * c-&gt;buffer's memory was freed</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        b-&gt;pos = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        b-&gt;pos = b-&gt;start;</span><br><span class="line">        b-&gt;last = b-&gt;start;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"hc free: %p"</span>,</span><br><span class="line">                   hc-&gt;<span class="built_in">free</span>);</span><br><span class="line">    <span class="comment">// 释放hc空间</span></span><br><span class="line">    <span class="keyword">if</span> (hc-&gt;<span class="built_in">free</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (cl = hc-&gt;<span class="built_in">free</span>; cl; <span class="comment">/* void */</span>) &#123;</span><br><span class="line">            ln = cl;</span><br><span class="line">            cl = cl-&gt;next;</span><br><span class="line">            ngx_pfree(c-&gt;pool, ln-&gt;buf-&gt;start);</span><br><span class="line">            ngx_free_chain(c-&gt;pool, ln);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hc-&gt;<span class="built_in">free</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"hc busy: %p %i"</span>,</span><br><span class="line">                   hc-&gt;busy, hc-&gt;nbusy);</span><br><span class="line">    <span class="comment">// 释放hc的busy空间</span></span><br><span class="line">    <span class="keyword">if</span> (hc-&gt;busy) &#123;</span><br><span class="line">        <span class="keyword">for</span> (cl = hc-&gt;busy; cl; <span class="comment">/* void */</span>) &#123;</span><br><span class="line">            ln = cl;</span><br><span class="line">            cl = cl-&gt;next;</span><br><span class="line">            ngx_pfree(c-&gt;pool, ln-&gt;buf-&gt;start);</span><br><span class="line">            ngx_free_chain(c-&gt;pool, ln);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hc-&gt;busy = <span class="literal">NULL</span>;</span><br><span class="line">        hc-&gt;nbusy = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;ssl) &#123;</span><br><span class="line">        ngx_ssl_free_buffer(c);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置读事件处理函数为ngx_http_keepalive_handler</span></span><br><span class="line">    rev-&gt;handler = ngx_http_keepalive_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wev-&gt;active &amp;&amp; (ngx_event_flags &amp; NGX_USE_LEVEL_EVENT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_del_event(wev, NGX_WRITE_EVENT, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"keepalive"</span>;</span><br><span class="line">    <span class="comment">// 如果连接支持tcp_nopush，设置对应的连接套接字熟悉</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;tcp_nopush == NGX_TCP_NOPUSH_SET) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_tcp_push(c-&gt;fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_connection_error(c, ngx_socket_errno, ngx_tcp_push_n <span class="string">" failed"</span>);</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c-&gt;tcp_nopush = NGX_TCP_NOPUSH_UNSET;</span><br><span class="line">        tcp_nodelay = ngx_tcp_nodelay_and_tcp_nopush ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tcp_nodelay = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_nodelay &amp;&amp; clcf-&gt;tcp_nodelay &amp;&amp; ngx_tcp_nodelay(c) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">/* if ngx_http_request_t was freed then we need some other place */</span></span><br><span class="line">    r-&gt;http_state = NGX_HTTP_KEEPALIVE_STATE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 标注事件是空闲的，并且是可复用的</span></span><br><span class="line">    c-&gt;idle = <span class="number">1</span>;</span><br><span class="line">    ngx_reusable_connection(c, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 添加对应的keepalive超时时间到红黑树中</span></span><br><span class="line">    ngx_add_timer(rev, clcf-&gt;keepalive_timeout);</span><br><span class="line">    <span class="comment">// 如果读事件是ready，则添加到ngx_posted_events队列中，在worker循环中立即执行</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;ready) &#123;</span><br><span class="line">        ngx_post_event(rev, &amp;ngx_posted_events);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-keepalive-handler处理函数"><a href="#ngx-http-keepalive-handler处理函数" class="headerlink" title="ngx_http_keepalive_handler处理函数"></a>ngx_http_keepalive_handler处理函数</h4><p>连接处于<code>keepalive</code>时，对应的读事件处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_keepalive_handler(<span class="keyword">ngx_event_t</span> *rev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>             size;</span><br><span class="line">    <span class="keyword">ssize_t</span>            n;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>         *b;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = rev-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http keepalive handler"</span>);</span><br><span class="line">    <span class="comment">// 如果事件超时，或者客户端主动关闭连了，则直接关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout || c-&gt;close) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取对应buf</span></span><br><span class="line">    b = c-&gt;buffer;</span><br><span class="line">    <span class="comment">// 获取对应需要处理的数据</span></span><br><span class="line">    size = b-&gt;end - b-&gt;start;</span><br><span class="line">    <span class="comment">// 如果pos为空，表示buf被回收了，则重新创建buf</span></span><br><span class="line">    <span class="keyword">if</span> (b-&gt;pos == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The c-&gt;buffer's memory was freed by ngx_http_set_keepalive().</span></span><br><span class="line"><span class="comment">         * However, the c-&gt;buffer-&gt;start and c-&gt;buffer-&gt;end were not changed</span></span><br><span class="line"><span class="comment">         * to keep the buffer size.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        b-&gt;pos = ngx_palloc(c-&gt;pool, size);</span><br><span class="line">        <span class="keyword">if</span> (b-&gt;pos == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;start = b-&gt;pos;</span><br><span class="line">        b-&gt;last = b-&gt;pos;</span><br><span class="line">        b-&gt;end = b-&gt;pos + size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * MSIE closes a keepalive connection with RST flag</span></span><br><span class="line"><span class="comment">     * so we ignore ECONNRESET here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    c-&gt;log_error = NGX_ERROR_IGNORE_ECONNRESET;</span><br><span class="line">    ngx_set_socket_errno(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 接收请求</span></span><br><span class="line">    n = c-&gt;recv(c, b-&gt;last, size);</span><br><span class="line">    c-&gt;log_error = NGX_ERROR_INFO;</span><br><span class="line">    <span class="comment">// 请求返回NGX_AGAIN，则设置读事件到epoll中，并清空buf</span></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_AGAIN) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_connection(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Like ngx_http_set_keepalive() we are trying to not hold</span></span><br><span class="line"><span class="comment">         * c-&gt;buffer's memory for a keepalive connection.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_pfree(c-&gt;pool, b-&gt;start) == NGX_OK) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * the special note that c-&gt;buffer's memory was freed</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            b-&gt;pos = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出错</span></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;handler = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                      <span class="string">"client %V closed keepalive connection"</span>, &amp;c-&gt;addr_text);</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 成功读取到数据，设置连接为非空闲状态</span></span><br><span class="line">    b-&gt;last += n;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;handler = ngx_http_log_error;</span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading client request line"</span>;</span><br><span class="line"></span><br><span class="line">    c-&gt;idle = <span class="number">0</span>;</span><br><span class="line">    ngx_reusable_connection(c, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建请求</span></span><br><span class="line">    c-&gt;data = ngx_http_create_request(c);</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_close_connection(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;sent = <span class="number">0</span>;</span><br><span class="line">    c-&gt;destroyed = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 将keepalive超时事件从时间红黑树中删除</span></span><br><span class="line">    ngx_del_timer(rev);</span><br><span class="line">    <span class="comment">// 设置处理函数为处理请求行</span></span><br><span class="line">    rev-&gt;handler = ngx_http_process_request_line;</span><br><span class="line">    <span class="comment">// 立即执行</span></span><br><span class="line">    ngx_http_process_request_line(rev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-set-lingering-close"><a href="#ngx-http-set-lingering-close" class="headerlink" title="ngx_http_set_lingering_close"></a>ngx_http_set_lingering_close</h4><p>对应需要延迟关闭的请求，执行该方法，设置延迟关闭。延迟关闭主要是防止客户端还有下发的数据，而nginx直接关闭套接字，导致向客户端下发的数据没有成功传输完成。参考上面关于延迟关闭配置的解释。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_set_lingering_close(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>               *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line">    <span class="comment">// 设置度事件为延迟关闭处理</span></span><br><span class="line">    rev-&gt;handler = ngx_http_lingering_close_handler;</span><br><span class="line">    <span class="comment">// 计算最晚关闭事件，根据当前时间和lingering_time配置，这里计算单位是s</span></span><br><span class="line">    r-&gt;lingering_time = ngx_time() + (<span class="keyword">time_t</span>) (clcf-&gt;lingering_time / <span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 将读事件添加到事件处理红黑树中，按照lingering_timeout配置</span></span><br><span class="line">    ngx_add_timer(rev, clcf-&gt;lingering_timeout);</span><br><span class="line">    <span class="comment">// 将读事件处理添加到epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置写事件处理为空方法</span></span><br><span class="line">    wev = c-&gt;write;</span><br><span class="line">    wev-&gt;handler = ngx_http_empty_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wev-&gt;active &amp;&amp; (ngx_event_flags &amp; NGX_USE_LEVEL_EVENT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_del_event(wev, NGX_WRITE_EVENT, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭套接字的写端</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_shutdown_socket(c-&gt;fd, NGX_WRITE_SHUTDOWN) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_connection_error(c, ngx_socket_errno,</span><br><span class="line">                             ngx_shutdown_socket_n <span class="string">" failed"</span>);</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果读事件已准备就绪则立即执行。</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;ready) &#123;</span><br><span class="line">        ngx_http_lingering_close_handler(rev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-lingering-close-handler"><a href="#ngx-http-lingering-close-handler" class="headerlink" title="ngx_http_lingering_close_handler"></a>ngx_http_lingering_close_handler</h4><p>延迟关闭时读事件的处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_lingering_close_handler(<span class="keyword">ngx_event_t</span> *rev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>                    n;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                 timer;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>        *r;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    u_char                     buffer[NGX_HTTP_LINGERING_BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line">    c = rev-&gt;data;</span><br><span class="line">    r = c-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http lingering close handler"</span>);</span><br><span class="line">    <span class="comment">// 如果读事件已超时，则直接关闭请求</span></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 是否超过最长延迟关闭时间</span></span><br><span class="line">    timer = (<span class="keyword">ngx_msec_t</span>) r-&gt;lingering_time - (<span class="keyword">ngx_msec_t</span>) ngx_time();</span><br><span class="line">    <span class="comment">// 如果超过最长延迟关闭时间，则直接关闭请求</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">ngx_msec_int_t</span>) timer &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 读取数据</span></span><br><span class="line">        n = c-&gt;recv(c, buffer, NGX_HTTP_LINGERING_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"lingering read: %z"</span>, n);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_AGAIN) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果出错，或者读取到的数据长度为0，关闭请求</span></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_ERROR || n == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 如果读事件始终处于ready状态</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (rev-&gt;ready);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 确保读事件在epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 获取下一次触发延迟的时间，比较当前时间举例最大延迟时间的长度和lingering_timeout值，取较小者</span></span><br><span class="line">    timer *= <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timer &gt; clcf-&gt;lingering_timeout) &#123;</span><br><span class="line">        timer = clcf-&gt;lingering_timeout;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 条件读事件到事件处理红黑树中</span></span><br><span class="line">    ngx_add_timer(rev, timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-close-request"><a href="#ngx-http-close-request" class="headerlink" title="ngx_http_close_request"></a>ngx_http_close_request</h3><p>该请求关闭当前连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_close_request(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    r = r-&gt;main;</span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http request count:%d blk:%d"</span>, r-&gt;count, r-&gt;blocked);</span><br><span class="line">    <span class="comment">// 如果请求上count为0，表示已经关闭了</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;count == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http request count is zero"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将请求减1</span></span><br><span class="line">    r-&gt;count--;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果还存在子请求，或者还有阻塞的调用方法，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;count || r-&gt;blocked) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;stream) &#123;</span><br><span class="line">        ngx_http_v2_close_stream(r-&gt;stream, rc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 释放请求</span></span><br><span class="line">    ngx_http_free_request(r, rc);</span><br><span class="line">    <span class="comment">// 关闭连接，调用ngx_close_connect关闭连接，销毁内存池</span></span><br><span class="line">    ngx_http_close_connection(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-free-request释放请求"><a href="#ngx-http-free-request释放请求" class="headerlink" title="ngx_http_free_request释放请求"></a>ngx_http_free_request释放请求</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_free_request(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>                *pool;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">linger</span>              <span class="title">linger</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_cleanup_t</span>        *cln;</span><br><span class="line">    <span class="keyword">ngx_http_log_ctx_t</span>        *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = r-&gt;connection-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http close request"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http request already closed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cln = r-&gt;cleanup;</span><br><span class="line">    r-&gt;cleanup = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 执行清理函数列表</span></span><br><span class="line">    <span class="keyword">while</span> (cln) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cln-&gt;handler) &#123;</span><br><span class="line">            cln-&gt;handler(cln-&gt;data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cln = cln-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置响应的返回</span></span><br><span class="line">    <span class="keyword">if</span> (rc &gt; <span class="number">0</span> &amp;&amp; (r-&gt;headers_out.status == <span class="number">0</span> || r-&gt;connection-&gt;sent == <span class="number">0</span>)) &#123;</span><br><span class="line">        r-&gt;headers_out.status = rc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果还未写log，则执行写log，这里写log为执行NGX_HTTP_LOG_PHASE阶段的处理函数</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;logged) &#123;</span><br><span class="line">        <span class="built_in">log</span>-&gt;action = <span class="string">"logging request"</span>;</span><br><span class="line"></span><br><span class="line">        ngx_http_log_request(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;action = <span class="string">"closing request"</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果是连接超时导致的关闭，并且设置了reset_timedout_connection快速关闭，则设置套接字选项</span></span><br><span class="line"><span class="comment">    可参考配置中快速close部分解释</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;connection-&gt;timedout) &#123;</span><br><span class="line">        clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;reset_timedout_connection) &#123;</span><br><span class="line">            linger.l_onoff = <span class="number">1</span>;</span><br><span class="line">            linger.l_linger = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(r-&gt;connection-&gt;fd, SOL_SOCKET, SO_LINGER,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;linger, <span class="keyword">sizeof</span>(struct linger)) == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_LINGER) failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the various request strings were allocated from r-&gt;pool */</span></span><br><span class="line">    ctx = <span class="built_in">log</span>-&gt;data;</span><br><span class="line">    ctx-&gt;request = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;request_line.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;connection-&gt;destroyed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Setting r-&gt;pool to NULL will increase probability to catch double close</span></span><br><span class="line"><span class="comment">     * of request since the request object is allocated from its own pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    pool = r-&gt;pool;</span><br><span class="line">    r-&gt;pool = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 销毁请求的内存池</span></span><br><span class="line">    ngx_destroy_pool(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-terminate-request"><a href="#ngx-http-terminate-request" class="headerlink" title="ngx_http_terminate_request"></a>ngx_http_terminate_request</h3><p>在请求出现错误，或者客户端主动关闭时，会执行该函数立即关闭请求。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_posted_request_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>               *request;</span><br><span class="line">    <span class="keyword">ngx_http_posted_request_t</span>        *next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_posted_request_t</span>         terminal_posted_request;</span><br><span class="line">&#125; <span class="keyword">ngx_http_ephemeral_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_terminate_request(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_cleanup_t</span>    *cln;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>    *mr;</span><br><span class="line">    <span class="keyword">ngx_http_ephemeral_t</span>  *e;</span><br><span class="line">    <span class="comment">// 获取主请求</span></span><br><span class="line">    mr = r-&gt;main;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http terminate request count:%d"</span>, mr-&gt;count);</span><br><span class="line">    <span class="comment">// 设置响应头</span></span><br><span class="line">    <span class="keyword">if</span> (rc &gt; <span class="number">0</span> &amp;&amp; (mr-&gt;headers_out.status == <span class="number">0</span> || mr-&gt;connection-&gt;sent == <span class="number">0</span>)) &#123;</span><br><span class="line">        mr-&gt;headers_out.status = rc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行主请求的清理函数</span></span><br><span class="line">    cln = mr-&gt;cleanup;</span><br><span class="line">    mr-&gt;cleanup = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (cln) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cln-&gt;handler) &#123;</span><br><span class="line">            cln-&gt;handler(cln-&gt;data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cln = cln-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http terminate cleanup count:%d blk:%d"</span>,</span><br><span class="line">                   mr-&gt;count, mr-&gt;blocked);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果设置了写事件</span></span><br><span class="line">    <span class="keyword">if</span> (mr-&gt;write_event_handler) &#123;</span><br><span class="line">        <span class="comment">// 如果存在阻塞</span></span><br><span class="line">        <span class="keyword">if</span> (mr-&gt;blocked) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            设置连接发送错误，并设置写事件为ngx_http_request_finalizer</span></span><br><span class="line"><span class="comment">            ngx_http_request_finalizer只执行ngx_http_finalize_request方法和写日志</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            r-&gt;connection-&gt;error = <span class="number">1</span>;</span><br><span class="line">            r-&gt;write_event_handler = ngx_http_request_finalizer;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        #define ngx_http_ephemeral(r)  (void *) (&amp;r-&gt;uri_start)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        e = ngx_http_ephemeral(mr);</span><br><span class="line">        <span class="comment">// 设置posted_requests为空</span></span><br><span class="line">        mr-&gt;posted_requests = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设置写事件为ngx_http_terminate_handler</span></span><br><span class="line"><span class="comment">        ngx_http_terminate_handler方法将请求的count置1，执行ngx_http_close_request</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        mr-&gt;write_event_handler = ngx_http_terminate_handler;</span><br><span class="line">        <span class="comment">// 将请求自身添加到其posted_requests中，不是很理解原因</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_http_post_request(mr, &amp;e-&gt;terminal_posted_request);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭请求</span></span><br><span class="line">    ngx_http_close_request(mr, rc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-set-write-handler"><a href="#ngx-http-set-write-handler" class="headerlink" title="ngx_http_set_write_handler"></a>ngx_http_set_write_handler</h3><p>在结束请求时，如果还有别的阻塞数据还未传输完成，则通过该函数设置对应的写事件处理，确保数据都正常传输到客户端，执行逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_set_write_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>               *wev;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    r-&gt;http_state = NGX_HTTP_WRITING_REQUEST_STATE;</span><br><span class="line">    <span class="comment">// 如果还处于需要丢失请求体状态，则设置读函数为丢失请求体处理函数，否则处理函数为检查是否客户端主动关闭</span></span><br><span class="line">    r-&gt;read_event_handler = r-&gt;discard_body ?</span><br><span class="line">                                ngx_http_discarded_request_body_handler:</span><br><span class="line">                                ngx_http_test_reading;</span><br><span class="line">    <span class="comment">// 设置写事件为ngx_http_writer</span></span><br><span class="line">    r-&gt;write_event_handler = ngx_http_writer;</span><br><span class="line"></span><br><span class="line">    wev = r-&gt;connection-&gt;write;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (wev-&gt;ready &amp;&amp; wev-&gt;delayed) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置发送超时时间</span></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="keyword">if</span> (!wev-&gt;delayed) &#123;</span><br><span class="line">        ngx_add_timer(wev, clcf-&gt;send_timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 确保写事件在epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_write_event(wev, clcf-&gt;send_lowat) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-special-response-handler"><a href="#ngx-http-special-response-handler" class="headerlink" title="ngx_http_special_response_handler"></a>ngx_http_special_response_handler</h3><p>对于需要返回特殊响应的请求，通过该函数做最后的响应。包括响应大于等于301，或者为201或204的响应。处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_special_response_handler(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_int_t</span> error)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i, err;</span><br><span class="line">    <span class="keyword">ngx_http_err_page_t</span>       *err_page;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http special response: %i, \"%V?%V\""</span>,</span><br><span class="line">                   error, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line"></span><br><span class="line">    r-&gt;err_status = error;</span><br><span class="line">    <span class="comment">// 如果响应保持长连接，判断是否允许</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;keepalive) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_BAD_REQUEST: <span class="comment">// 400  异常请求</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_REQUEST_ENTITY_TOO_LARGE: <span class="comment">// 413 post请求体过大</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_REQUEST_URI_TOO_LARGE: <span class="comment">// 414 请求的uri过大</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_TO_HTTPS: <span class="comment">// 497 需要从http转到https</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTPS_CERT_ERROR: <span class="comment">//495 SSL证书错误</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTPS_NO_CERT: <span class="comment">// 496 无证书</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_INTERNAL_SERVER_ERROR: <span class="comment">// 500 服务器内部错误</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_NOT_IMPLEMENTED: <span class="comment">// 501 服务器无法识别的请求</span></span><br><span class="line">                r-&gt;keepalive = <span class="number">0</span>; <span class="comment">// 上述情况下，关闭长连接</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;lingering_close) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_BAD_REQUEST: <span class="comment">// 400 </span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_TO_HTTPS: <span class="comment">// 497</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTPS_CERT_ERROR: <span class="comment">// 495</span></span><br><span class="line">            <span class="keyword">case</span> NGX_HTTPS_NO_CERT: <span class="comment">// 496</span></span><br><span class="line">                r-&gt;lingering_close = <span class="number">0</span>; <span class="comment">// 上述情况下关闭延迟关闭</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;headers_out.content_type.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果请求还未结果error_page处理，并且配置了error_page，并且还有rewrite的次数，执行error_page匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;error_page &amp;&amp; clcf-&gt;error_pages &amp;&amp; r-&gt;uri_changes != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果不支持error_page进行重定向，设置已经执行过error_page</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;recursive_error_pages == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;error_page = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err_page = clcf-&gt;error_pages-&gt;elts;</span><br><span class="line">        <span class="comment">// 执行匹配，如果err page配置的错误码和error一致，则执行对应的处理，结束</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; clcf-&gt;error_pages-&gt;nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err_page[i].status == error) &#123;</span><br><span class="line">                <span class="keyword">return</span> ngx_http_send_error_page(r, &amp;err_page[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;expect_tested = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 丢弃请求体，如果存在的化</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_discard_request_body(r) != NGX_OK) &#123;</span><br><span class="line">        r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    启用了为微软浏览器发出刷新而不是重定向</span></span><br><span class="line"><span class="comment">    请求缺失为微软浏览器</span></span><br><span class="line"><span class="comment">    需要执行临时重定向或永久重定向</span></span><br><span class="line"><span class="comment">    满足以上提交时，向客户端发送刷新的响应</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;msie_refresh</span><br><span class="line">        &amp;&amp; r-&gt;headers_in.msie</span><br><span class="line">        &amp;&amp; (error == NGX_HTTP_MOVED_PERMANENTLY</span><br><span class="line">            || error == NGX_HTTP_MOVED_TEMPORARILY))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_send_refresh(r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行错误码的映射</span></span><br><span class="line">    <span class="keyword">if</span> (error == NGX_HTTP_CREATED) &#123;</span><br><span class="line">        <span class="comment">/* 201 */</span></span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == NGX_HTTP_NO_CONTENT) &#123;</span><br><span class="line">        <span class="comment">/* 204 */</span></span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error &gt;= NGX_HTTP_MOVED_PERMANENTLY</span><br><span class="line">               &amp;&amp; error &lt; NGX_HTTP_LAST_3XX)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 3XX */</span></span><br><span class="line">        err = error - NGX_HTTP_MOVED_PERMANENTLY + NGX_HTTP_OFF_3XX;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error &gt;= NGX_HTTP_BAD_REQUEST</span><br><span class="line">               &amp;&amp; error &lt; NGX_HTTP_LAST_4XX)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 4XX */</span></span><br><span class="line">        err = error - NGX_HTTP_BAD_REQUEST + NGX_HTTP_OFF_4XX;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error &gt;= NGX_HTTP_NGINX_CODES</span><br><span class="line">               &amp;&amp; error &lt; NGX_HTTP_LAST_5XX)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 49X, 5XX */</span></span><br><span class="line">        err = error - NGX_HTTP_NGINX_CODES + NGX_HTTP_OFF_5XX;</span><br><span class="line">        <span class="keyword">switch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_TO_HTTPS:</span><br><span class="line">            <span class="keyword">case</span> NGX_HTTPS_CERT_ERROR:</span><br><span class="line">            <span class="keyword">case</span> NGX_HTTPS_NO_CERT:</span><br><span class="line">            <span class="keyword">case</span> NGX_HTTP_REQUEST_HEADER_TOO_LARGE:</span><br><span class="line">                r-&gt;err_status = NGX_HTTP_BAD_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* unknown code, zero body */</span></span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送特殊响应</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_send_special_response(r, clcf, err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-send-error-page"><a href="#ngx-http-send-error-page" class="headerlink" title="ngx_http_send_error_page"></a>ngx_http_send_error_page</h4><p>按照err page配置发送响应。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_send_error_page(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_err_page_t</span> *err_page)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  overwrite;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  uri, args;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>           *location;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    overwrite = err_page-&gt;overwrite;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (overwrite &amp;&amp; overwrite != NGX_HTTP_OK) &#123;</span><br><span class="line">        r-&gt;expect_tested = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (overwrite &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        r-&gt;err_status = overwrite;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// err_page配置支持添加变量，因此需要进行变量编译</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_complex_value(r, &amp;err_page-&gt;value, &amp;uri) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果生成的uri开头为/，则是执行内部重定向</span></span><br><span class="line">    <span class="keyword">if</span> (uri.len &amp;&amp; uri.data[<span class="number">0</span>] == <span class="string">'/'</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err_page-&gt;value.lengths) &#123;</span><br><span class="line">            ngx_http_split_args(r, &amp;uri, &amp;args);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            args = err_page-&gt;args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;method != NGX_HTTP_HEAD) &#123;</span><br><span class="line">            r-&gt;method = NGX_HTTP_GET;</span><br><span class="line">            r-&gt;method_name = ngx_http_core_get_method;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ngx_http_internal_redirect(r, &amp;uri, &amp;args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果uri开头为@,则匹配内部命名location</span></span><br><span class="line">    <span class="keyword">if</span> (uri.len &amp;&amp; uri.data[<span class="number">0</span>] == <span class="string">'@'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_named_location(r, &amp;uri);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果都不是，则应当执行重定向，并且重定向是指定的链接</span></span><br><span class="line">    r-&gt;expect_tested = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 丢弃请求体</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_discard_request_body(r) != NGX_OK) &#123;</span><br><span class="line">        r-&gt;keepalive = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建location头</span></span><br><span class="line">    location = ngx_list_push(&amp;r-&gt;headers_out.headers);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (location == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置状态为临时重定向，overwrite为err page我重新的响应值</span></span><br><span class="line">    <span class="keyword">if</span> (overwrite != NGX_HTTP_MOVED_PERMANENTLY</span><br><span class="line">        &amp;&amp; overwrite != NGX_HTTP_MOVED_TEMPORARILY</span><br><span class="line">        &amp;&amp; overwrite != NGX_HTTP_SEE_OTHER</span><br><span class="line">        &amp;&amp; overwrite != NGX_HTTP_TEMPORARY_REDIRECT</span><br><span class="line">        &amp;&amp; overwrite != NGX_HTTP_PERMANENT_REDIRECT)</span><br><span class="line">    &#123;</span><br><span class="line">        r-&gt;err_status = NGX_HTTP_MOVED_TEMPORARILY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location-&gt;hash = <span class="number">1</span>;</span><br><span class="line">    ngx_str_set(&amp;location-&gt;key, <span class="string">"Location"</span>);</span><br><span class="line">    location-&gt;value = uri;</span><br><span class="line"></span><br><span class="line">    ngx_http_clear_location(r);</span><br><span class="line"></span><br><span class="line">    r-&gt;headers_out.location = location;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果是微软浏览器，发送刷新响应，而不是重定向</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;msie_refresh &amp;&amp; r-&gt;headers_in.msie) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_send_refresh(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送特殊响应</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_send_special_response(r, clcf, r-&gt;err_status</span><br><span class="line">                                                   - NGX_HTTP_MOVED_PERMANENTLY</span><br><span class="line">                                                   + NGX_HTTP_OFF_3XX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-internal-redirect内部重定向"><a href="#ngx-http-internal-redirect内部重定向" class="headerlink" title="ngx_http_internal_redirect内部重定向"></a>ngx_http_internal_redirect内部重定向</h4><p>该函数执行内部重定向，逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_internal_redirect(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_str_t</span> *uri, <span class="keyword">ngx_str_t</span> *args)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line">    <span class="comment">// 重定向时，将uri_changes减1</span></span><br><span class="line">    r-&gt;uri_changes--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;uri_changes == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"rewrite or internal redirection cycle "</span></span><br><span class="line">                      <span class="string">"while internally redirecting to \"%V\""</span>, uri);</span><br><span class="line"></span><br><span class="line">        r-&gt;main-&gt;count++;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置uri</span></span><br><span class="line">    r-&gt;uri = *uri;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args) &#123;</span><br><span class="line">        r-&gt;args = *args;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_str_null(&amp;r-&gt;args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"internal redirect: \"%V?%V\""</span>, uri, &amp;r-&gt;args);</span><br><span class="line"></span><br><span class="line">    ngx_http_set_exten(r);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* clear the modules contexts */</span></span><br><span class="line">    ngx_memzero(r-&gt;ctx, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="comment">// 将请求的loc_conf恢复成server层级的loc_conf</span></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">    r-&gt;loc_conf = cscf-&gt;ctx-&gt;loc_conf;</span><br><span class="line">    <span class="comment">// 按照新的uri，更新请求</span></span><br><span class="line">    ngx_http_update_location_config(r);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line">    r-&gt;cache = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置请求为内部请求</span></span><br><span class="line">    r-&gt;internal = <span class="number">1</span>;</span><br><span class="line">    r-&gt;valid_unparsed_uri = <span class="number">0</span>;</span><br><span class="line">    r-&gt;add_uri_to_alias = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 将主请求count增加</span></span><br><span class="line">    r-&gt;main-&gt;count++;</span><br><span class="line">    <span class="comment">// 执行http处理，这里会从server_rewrite_index阶段执行请求主循环</span></span><br><span class="line">    ngx_http_handler(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-named-location内部命名location"><a href="#ngx-http-named-location内部命名location" class="headerlink" title="ngx_http_named_location内部命名location"></a>ngx_http_named_location内部命名location</h4><p>该函数用于执行nginx内部的location重定向，即包含@符号的location配置。逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_named_location(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_str_t</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>    *cscf;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   **clcfp;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>   *cmcf;</span><br><span class="line">    </span><br><span class="line">    r-&gt;main-&gt;count++;</span><br><span class="line">    r-&gt;uri_changes--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;uri_changes == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"rewrite or internal redirection cycle "</span></span><br><span class="line">                      <span class="string">"while redirect to named location \"%V\""</span>, name);</span><br><span class="line"></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;uri.len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"empty URI in redirect to named location \"%V\""</span>, name);</span><br><span class="line"></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果server层级存在named_locations，则进行匹配查找</span></span><br><span class="line">    <span class="keyword">if</span> (cscf-&gt;named_locations) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (clcfp = cscf-&gt;named_locations; *clcfp; clcfp++) &#123;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"test location: \"%V\""</span>, &amp;(*clcfp)-&gt;name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;len != (*clcfp)-&gt;name.len</span><br><span class="line">                || ngx_strncmp(name-&gt;data, (*clcfp)-&gt;name.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"using location: %V \"%V?%V\""</span>,</span><br><span class="line">                           name, &amp;r-&gt;uri, &amp;r-&gt;args);</span><br><span class="line">            <span class="comment">// 查找到后，更新请求为内部请求，设置对应的loc_conf，并更新请求</span></span><br><span class="line">            r-&gt;internal = <span class="number">1</span>;</span><br><span class="line">            r-&gt;content_handler = <span class="literal">NULL</span>;</span><br><span class="line">            r-&gt;uri_changed = <span class="number">0</span>;</span><br><span class="line">            r-&gt;loc_conf = (*clcfp)-&gt;loc_conf;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* clear the modules contexts */</span></span><br><span class="line">            ngx_memzero(r-&gt;ctx, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line"></span><br><span class="line">            ngx_http_update_location_config(r);</span><br><span class="line"></span><br><span class="line">            cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">            <span class="comment">// 设置执行阶段为location_rewrite_index</span></span><br><span class="line">            r-&gt;phase_handler = cmcf-&gt;phase_engine.location_rewrite_index;</span><br><span class="line">            <span class="comment">// 设置请求写事件方法为执行核心请求阶段</span></span><br><span class="line">            r-&gt;write_event_handler = ngx_http_core_run_phases;</span><br><span class="line">            <span class="comment">// 立即允许</span></span><br><span class="line">            ngx_http_core_run_phases(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有匹配的内部location</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"could not find named location \"%V\""</span>, name);</span><br><span class="line">    <span class="comment">// 以内部错误结束请求</span></span><br><span class="line">    ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-send-refresh"><a href="#ngx-http-send-refresh" class="headerlink" title="ngx_http_send_refresh"></a>ngx_http_send_refresh</h4><p>对应微软浏览器，需要将重定向设置为刷新响应。逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> u_char ngx_http_msie_refresh_head[] =</span><br><span class="line"><span class="string">"&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\"Refresh\" content=\"0; URL="</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> u_char ngx_http_msie_refresh_tail[] =</span><br><span class="line"><span class="string">"\"&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"</span> CRLF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_send_refresh(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    u_char       *p, *location;</span><br><span class="line">    <span class="keyword">size_t</span>        len, size;</span><br><span class="line">    <span class="keyword">uintptr_t</span>     escape;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>     rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>    *b;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>   out;</span><br><span class="line"></span><br><span class="line">    len = r-&gt;headers_out.location-&gt;value.len;</span><br><span class="line">    location = r-&gt;headers_out.location-&gt;value.data;</span><br><span class="line"></span><br><span class="line">    escape = <span class="number">2</span> * ngx_escape_uri(<span class="literal">NULL</span>, location, len, NGX_ESCAPE_REFRESH);</span><br><span class="line">    <span class="comment">// 获取响应体大小</span></span><br><span class="line">    size = <span class="keyword">sizeof</span>(ngx_http_msie_refresh_head) - <span class="number">1</span></span><br><span class="line">           + escape + len</span><br><span class="line">           + <span class="keyword">sizeof</span>(ngx_http_msie_refresh_tail) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;err_status = NGX_HTTP_OK;</span><br><span class="line">    <span class="comment">// 设置响应类型长度</span></span><br><span class="line">    r-&gt;headers_out.content_type_len = <span class="keyword">sizeof</span>(<span class="string">"text/html"</span>) - <span class="number">1</span>;</span><br><span class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"text/html"</span>);</span><br><span class="line">    r-&gt;headers_out.content_type_lowcase = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;headers_out.location-&gt;hash = <span class="number">0</span>;</span><br><span class="line">    r-&gt;headers_out.location = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 设置响应长度</span></span><br><span class="line">    r-&gt;headers_out.content_length_n = size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_length) &#123;</span><br><span class="line">        r-&gt;headers_out.content_length-&gt;hash = <span class="number">0</span>;</span><br><span class="line">        r-&gt;headers_out.content_length = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 清理相关的响应头</span></span><br><span class="line">    ngx_http_clear_accept_ranges(r);</span><br><span class="line">    ngx_http_clear_last_modified(r);</span><br><span class="line">    ngx_http_clear_etag(r);</span><br><span class="line">    <span class="comment">// 发送响应头</span></span><br><span class="line">    rc = ngx_http_send_header(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || r-&gt;header_only) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建buf，存储响应体，并构建响应体</span></span><br><span class="line">    b = ngx_create_temp_buf(r-&gt;pool, size);</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = ngx_cpymem(b-&gt;pos, ngx_http_msie_refresh_head,</span><br><span class="line">                   <span class="keyword">sizeof</span>(ngx_http_msie_refresh_head) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (escape == <span class="number">0</span>) &#123;</span><br><span class="line">        p = ngx_cpymem(p, location, len);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p = (u_char *) ngx_escape_uri(p, location, len, NGX_ESCAPE_REFRESH);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b-&gt;last = ngx_cpymem(p, ngx_http_msie_refresh_tail,</span><br><span class="line">                         <span class="keyword">sizeof</span>(ngx_http_msie_refresh_tail) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    b-&gt;last_buf = (r == r-&gt;main) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    b-&gt;last_in_chain = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    out.buf = b;</span><br><span class="line">    out.next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 发送响应体</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_output_filter(r, &amp;out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-send-special-response发送特殊响应"><a href="#ngx-http-send-special-response发送特殊响应" class="headerlink" title="ngx_http_send_special_response发送特殊响应"></a>ngx_http_send_special_response发送特殊响应</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_send_special_response(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *clcf, <span class="keyword">ngx_uint_t</span> err)</span><br><span class="line">&#123;</span><br><span class="line">    u_char       *tail;</span><br><span class="line">    <span class="keyword">size_t</span>        len;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>     rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>    *b;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>    msie_padding;</span><br><span class="line">    <span class="keyword">ngx_chain_t</span>   out[<span class="number">3</span>];</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    server_tokens配置出错时响应体中包含的nginx是否包含版本信息</span></span><br><span class="line"><span class="comment">    就是我们在浏览页面，出错可能就只看到最中间有一个nginx或者nginx+版本和一写错误信息</span></span><br><span class="line"><span class="comment">    这可以配置是否包含版本，不同情况下返回的长度不一致</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;server_tokens == NGX_HTTP_SERVER_TOKENS_ON) &#123;</span><br><span class="line">        len = <span class="keyword">sizeof</span>(ngx_http_error_full_tail) - <span class="number">1</span>;</span><br><span class="line">        tail = ngx_http_error_full_tail;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clcf-&gt;server_tokens == NGX_HTTP_SERVER_TOKENS_BUILD) &#123;</span><br><span class="line">        len = <span class="keyword">sizeof</span>(ngx_http_error_build_tail) - <span class="number">1</span>;</span><br><span class="line">        tail = ngx_http_error_build_tail;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        len = <span class="keyword">sizeof</span>(ngx_http_error_tail) - <span class="number">1</span>;</span><br><span class="line">        tail = ngx_http_error_tail;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    msie_padding启用或禁用向状态大于 400 的 MSIE 客户端的响应添加注释以将响应大小增加到 512 字节。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    msie_padding = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    对应特殊错误的响应，nginx都会配置默认的错误页面（如果需要的话）</span></span><br><span class="line"><span class="comment">    static ngx_str_t ngx_http_error_pages[] = &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ngx_null_string,                     /* 201, 204 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_HTTP_LAST_2XX  202</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_HTTP_OFF_3XX   (NGX_HTTP_LAST_2XX - 201)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ngx_null_string, */</span>               <span class="comment">/* 300 */</span></span><br><span class="line">    ngx_string(ngx_http_error_301_page),</span><br><span class="line">    ngx_string(ngx_http_error_302_page),</span><br><span class="line">    ngx_string(ngx_http_error_303_page),</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ngx_http_error_301_page[] =</span><br><span class="line"><span class="string">"&lt;html&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;body&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;"</span> CRLF</span><br><span class="line">;</span><br><span class="line">    */</span><br><span class="line">    <span class="keyword">if</span> (ngx_http_error_pages[err].len) &#123;</span><br><span class="line">        <span class="comment">// 获取响应头长度</span></span><br><span class="line">        r-&gt;headers_out.content_length_n = ngx_http_error_pages[err].len + len;</span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;msie_padding</span><br><span class="line">            &amp;&amp; (r-&gt;headers_in.msie || r-&gt;headers_in.chrome)</span><br><span class="line">            &amp;&amp; r-&gt;http_version &gt;= NGX_HTTP_VERSION_10</span><br><span class="line">            &amp;&amp; err &gt;= NGX_HTTP_OFF_4XX)</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">// 需要进行填充是，增加长度</span></span><br><span class="line">            r-&gt;headers_out.content_length_n +=</span><br><span class="line">                                         <span class="keyword">sizeof</span>(ngx_http_msie_padding) - <span class="number">1</span>;</span><br><span class="line">            msie_padding = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;headers_out.content_type_len = <span class="keyword">sizeof</span>(<span class="string">"text/html"</span>) - <span class="number">1</span>;</span><br><span class="line">        ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"text/html"</span>);</span><br><span class="line">        r-&gt;headers_out.content_type_lowcase = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果没有响应体，则对应长度为0</span></span><br><span class="line">        r-&gt;headers_out.content_length_n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 置空content_length，避免重复发送</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_length) &#123;</span><br><span class="line">        r-&gt;headers_out.content_length-&gt;hash = <span class="number">0</span>;</span><br><span class="line">        r-&gt;headers_out.content_length = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清空部分响应头</span></span><br><span class="line">    ngx_http_clear_accept_ranges(r);</span><br><span class="line">    ngx_http_clear_last_modified(r);</span><br><span class="line">    ngx_http_clear_etag(r);</span><br><span class="line">    <span class="comment">// 发送响应头</span></span><br><span class="line">    rc = ngx_http_send_header(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || r-&gt;header_only) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果响应体为空，则下发一个空的buf，到ngx_http_output_filter方法，告知发送数据已处理完毕</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_error_pages[err].len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_send_special(r, NGX_HTTP_LAST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    构建响应体</span></span><br><span class="line"><span class="comment">    buf0存储error_pages信息</span></span><br><span class="line"><span class="comment">    buf1存储nginx版本信息，即tail</span></span><br><span class="line"><span class="comment">    buf2存储扩展数据的mapping信息（如果有的化）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    b = ngx_calloc_buf(r-&gt;pool);</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b-&gt;memory = <span class="number">1</span>;</span><br><span class="line">    b-&gt;pos = ngx_http_error_pages[err].data;</span><br><span class="line">    b-&gt;last = ngx_http_error_pages[err].data + ngx_http_error_pages[err].len;</span><br><span class="line"></span><br><span class="line">    out[<span class="number">0</span>].buf = b;</span><br><span class="line">    out[<span class="number">0</span>].next = &amp;out[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    b = ngx_calloc_buf(r-&gt;pool);</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b-&gt;memory = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    b-&gt;pos = tail;</span><br><span class="line">    b-&gt;last = tail + len;</span><br><span class="line"></span><br><span class="line">    out[<span class="number">1</span>].buf = b;</span><br><span class="line">    out[<span class="number">1</span>].next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msie_padding) &#123;</span><br><span class="line">        b = ngx_calloc_buf(r-&gt;pool);</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        b-&gt;memory = <span class="number">1</span>;</span><br><span class="line">        b-&gt;pos = ngx_http_msie_padding;</span><br><span class="line">        b-&gt;last = ngx_http_msie_padding + <span class="keyword">sizeof</span>(ngx_http_msie_padding) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        out[<span class="number">1</span>].next = &amp;out[<span class="number">2</span>];</span><br><span class="line">        out[<span class="number">2</span>].buf = b;</span><br><span class="line">        out[<span class="number">2</span>].next = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r == r-&gt;main) &#123;</span><br><span class="line">        b-&gt;last_buf = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b-&gt;last_in_chain = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 执行响应体下发</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_output_filter(r, &amp;out[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-post-action"><a href="#ngx-http-post-action" class="headerlink" title="ngx_http_post_action"></a>ngx_http_post_action</h3><p>post_action配置一般用于统计等信息，即作用是在请求完成之后执行另一个请求。例如配置如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name _;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /sites/<span class="keyword">default</span>;</span><br><span class="line">        post_action @add</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location @add &#123;</span><br><span class="line">    		proxy_pass http:<span class="comment">//backend/add</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时，在请求完成<code>/</code>后，会立即执行<code>@add</code>的请求。其实现逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_post_action(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    </span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果配置了post_action</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;post_action.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果请求已经执行过了post_action，并且达到了uri_change最大限制次数，则直接通过</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;post_action &amp;&amp; r-&gt;uri_changes == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"post action: \"%V\""</span>, &amp;clcf-&gt;post_action);</span><br><span class="line">    </span><br><span class="line">    r-&gt;main-&gt;count--;</span><br><span class="line"></span><br><span class="line">    r-&gt;http_version = NGX_HTTP_VERSION_9;</span><br><span class="line">    r-&gt;header_only = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 记录post_action已经执行</span></span><br><span class="line">    r-&gt;post_action = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置请求的读事件为空函数</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line">    <span class="comment">// 按照post_action配置选择执行的location，下面两个方法前文都有介绍</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;post_action.data[<span class="number">0</span>] == <span class="string">'/'</span>) &#123;</span><br><span class="line">        ngx_http_internal_redirect(r, &amp;clcf-&gt;post_action, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_http_named_location(r, &amp;clcf-&gt;post_action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="解析配置"><a href="#解析配置" class="headerlink" title="解析配置"></a>解析配置</h1><h2 id="初始化核心模块"><a href="#初始化核心模块" class="headerlink" title="初始化核心模块"></a>初始化核心模块</h2><p>执行核心模块的ctx-&gt;create_conf方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_conf) &#123;</span><br><span class="line">        rv = <span class="keyword">module</span>-&gt;create_conf(cycle);</span><br><span class="line">        <span class="keyword">if</span> (rv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_destroy_pool(pool);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index] = rv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，http核心模块的ctx为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_str_t             name;</span><br><span class="line">    void               *(*create_conf)(ngx_cycle_t *cycle);</span><br><span class="line">    char               *(*init_conf)(ngx_cycle_t *cycle, void *conf);</span><br><span class="line">&#125; ngx_core_module_t;</span><br></pre></td></tr></table></figure>
<p>该步骤主要是分配配置存储空间，并为核心模块关注的全局配置赋初值。需要执行的有</p>
<p>ngx_core_module：其返回为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_flag_t                daemon;</span><br><span class="line">    ngx_flag_t                master;</span><br><span class="line"></span><br><span class="line">    ngx_msec_t                timer_resolution;</span><br><span class="line">    ngx_msec_t                shutdown_timeout;</span><br><span class="line"></span><br><span class="line">    ngx_int_t                 worker_processes;</span><br><span class="line">    ngx_int_t                 debug_points;</span><br><span class="line"></span><br><span class="line">    ngx_int_t                 rlimit_nofile;</span><br><span class="line">    off_t                     rlimit_core;</span><br><span class="line"></span><br><span class="line">    int                       priority;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                cpu_affinity_auto;</span><br><span class="line">    ngx_uint_t                cpu_affinity_n;</span><br><span class="line">    ngx_cpuset_t             *cpu_affinity;</span><br><span class="line"></span><br><span class="line">    char                     *username;</span><br><span class="line">    ngx_uid_t                 user;</span><br><span class="line">    ngx_gid_t                 group;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                 working_directory;</span><br><span class="line">    ngx_str_t                 lock_file;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                 pid;</span><br><span class="line">    ngx_str_t                 oldpid;</span><br><span class="line"></span><br><span class="line">    ngx_array_t               env;</span><br><span class="line">    char                    **environment;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                transparent;  /* unsigned  transparent:1; */</span><br><span class="line">&#125; ngx_core_conf_t;</span><br></pre></td></tr></table></figure>
<p>ngx_regex_module_ctx，其返回为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_flag_t  pcre_jit;</span><br><span class="line">&#125; ngx_regex_conf_t;</span><br></pre></td></tr></table></figure>
<h2 id="配置及参数解析"><a href="#配置及参数解析" class="headerlink" title="配置及参数解析"></a>配置及参数解析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    ngx_memzero(&amp;conf, <span class="keyword">sizeof</span>(<span class="keyword">ngx_conf_t</span>));</span><br><span class="line">    <span class="comment">/* STUB: init array ? */</span></span><br><span class="line">    conf.args = ngx_array_create(pool, <span class="number">10</span>, <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (conf.args == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conf.temp_pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, <span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (conf.temp_pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    conf.ctx = cycle-&gt;conf_ctx;</span><br><span class="line">    conf.cycle = cycle;</span><br><span class="line">    conf.pool = pool;</span><br><span class="line">    conf.<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    conf.module_type = NGX_CORE_MODULE;</span><br><span class="line">    conf.cmd_type = NGX_MAIN_CONF;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="built_in">log</span>-&gt;log_level = NGX_LOG_DEBUG_ALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 解析启动参数 -g</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_param(&amp;conf) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_parse(&amp;conf, &amp;cycle-&gt;conf_file) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="相关结构-4"><a href="#相关结构-4" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-conf-t结构"><a href="#ngx-conf-t结构" class="headerlink" title="ngx_conf_t结构"></a>ngx_conf_t结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ngx_conf_s &#123;</span><br><span class="line">    <span class="keyword">char</span>                 *name;</span><br><span class="line">    <span class="comment">// 词法解析后，解析出的值</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>          *args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>          *cycle;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>           *pool;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>           *temp_pool;</span><br><span class="line">    <span class="keyword">ngx_conf_file_t</span>      *conf_file;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>            *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>                 *ctx;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            module_type;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            cmd_type;</span><br><span class="line"></span><br><span class="line">    ngx_conf_handler_pt   handler;</span><br><span class="line">    <span class="keyword">void</span>                 *handler_conf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *(*ngx_conf_handler_pt)(<span class="keyword">ngx_conf_t</span> *cf,</span><br><span class="line">    <span class="keyword">ngx_command_t</span> *dummy, <span class="keyword">void</span> *conf);</span><br></pre></td></tr></table></figure>
<p>ngx_conf_param函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">ngx_conf_param(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>             *rv;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>        *param;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>         b;</span><br><span class="line">    <span class="keyword">ngx_conf_file_t</span>   conf_file;</span><br><span class="line"></span><br><span class="line">    param = &amp;cf-&gt;cycle-&gt;conf_param;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (param-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;conf_file, <span class="keyword">sizeof</span>(<span class="keyword">ngx_conf_file_t</span>));</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;b, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line"></span><br><span class="line">    b.start = param-&gt;data;</span><br><span class="line">    b.pos = param-&gt;data;</span><br><span class="line">    b.last = param-&gt;data + param-&gt;len;</span><br><span class="line">    b.end = b.last;</span><br><span class="line">    b.temporary = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    conf_file.file.fd = NGX_INVALID_FILE;</span><br><span class="line">    conf_file.file.name.data = <span class="literal">NULL</span>;</span><br><span class="line">    conf_file.line = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cf-&gt;conf_file = &amp;conf_file;</span><br><span class="line">    cf-&gt;conf_file-&gt;buffer = &amp;b;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    cf-&gt;conf_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-conf-file-t结构"><a href="#ngx-conf-file-t结构" class="headerlink" title="ngx_conf_file_t结构"></a>ngx_conf_file_t结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_file_t</span>            file;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>            *buffer;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>            *dump;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            line;</span><br><span class="line">&#125; <span class="keyword">ngx_conf_file_t</span>;</span><br></pre></td></tr></table></figure>
<p>执行的ngx_conf_parse函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">ngx_conf_parse(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *filename)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>             *rv;</span><br><span class="line">    <span class="keyword">ngx_fd_t</span>          fd;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>         buf;</span><br><span class="line">    <span class="keyword">ngx_conf_file_t</span>  *prev, conf_file;</span><br><span class="line">    <span class="comment">// 解析方式：解析文件、解析块配置（如server、location）、解析参数（-g参数）</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        parse_file = <span class="number">0</span>,</span><br><span class="line">        parse_block,</span><br><span class="line">        parse_param</span><br><span class="line">    &#125; type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">    fd = NGX_INVALID_FILE;</span><br><span class="line">    prev = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filename) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* open configuration file */</span></span><br><span class="line">        <span class="comment">// 打开配置文件</span></span><br><span class="line">        fd = ngx_open_file(filename-&gt;data, NGX_FILE_RDONLY, NGX_FILE_OPEN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, ngx_errno,</span><br><span class="line">                               ngx_open_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                               filename-&gt;data);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 存储原来的conf_file</span></span><br><span class="line">        prev = cf-&gt;conf_file;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file = &amp;conf_file;</span><br><span class="line">        <span class="comment">// 获取文件信息</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_fd_info(fd, &amp;cf-&gt;conf_file-&gt;file.info) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_fd_info_n <span class="string">" \"%s\" failed"</span>, filename-&gt;data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file-&gt;buffer = &amp;buf;</span><br><span class="line"></span><br><span class="line">        buf.start = ngx_alloc(NGX_CONF_BUFFER, cf-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (buf.start == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf.pos = buf.start;</span><br><span class="line">        buf.last = buf.start;</span><br><span class="line">        buf.end = buf.last + NGX_CONF_BUFFER;</span><br><span class="line">        buf.temporary = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file-&gt;file.fd = fd;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.name.len = filename-&gt;len;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.name.data = filename-&gt;data;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.offset = <span class="number">0</span>;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.<span class="built_in">log</span> = cf-&gt;<span class="built_in">log</span>;</span><br><span class="line">        cf-&gt;conf_file-&gt;line = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        type = parse_file;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_dump_config</span><br><span class="line">#<span class="keyword">if</span> (NGX_DEBUG)</span><br><span class="line">            || <span class="number">1</span></span><br><span class="line">#endif</span><br><span class="line">           )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 需要dump配置时，增加配置到config_dump_rbtree和config_dump</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_conf_add_dump(cf, filename) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cf-&gt;conf_file-&gt;dump = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;conf_file-&gt;file.fd != NGX_INVALID_FILE) &#123;</span><br><span class="line"></span><br><span class="line">        type = parse_block;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        type = parse_param;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 词法解析，解析配置或参数,返回解析结构状态或错误</span></span><br><span class="line">        rc = ngx_conf_read_token(cf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ngx_conf_read_token() may return</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *    NGX_ERROR             there is error</span></span><br><span class="line"><span class="comment">         *    NGX_OK                the token terminated by ";" was found</span></span><br><span class="line"><span class="comment">         *    NGX_CONF_BLOCK_START  the token terminated by "&#123;" was found</span></span><br><span class="line"><span class="comment">         *    NGX_CONF_BLOCK_DONE   the "&#125;" was found</span></span><br><span class="line"><span class="comment">         *    NGX_CONF_FILE_DONE    the configuration file is done</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面三个faild表示解析类型和词法解析结果不匹配，返回错误</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_CONF_BLOCK_DONE) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type != parse_block) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"unexpected \"&#125;\""</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_CONF_FILE_DONE) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == parse_block) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"unexpected end of file, expecting \"&#125;\""</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_CONF_BLOCK_START) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == parse_param) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"block directives are not supported "</span></span><br><span class="line">                                   <span class="string">"in -g option"</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* rc == NGX_OK || rc == NGX_CONF_BLOCK_START */</span></span><br><span class="line">        <span class="comment">// 如果解析的模块自定义了解析后处理方法</span></span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;handler) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * the custom handler, i.e., that is used in the http's</span></span><br><span class="line"><span class="comment">             * "types &#123; ... &#125;" directive</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_CONF_BLOCK_START) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"unexpected \"&#123;\""</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 模块自定义处理函数，例如ngx_http_core_commands中typescommends中自定义的ngx_http_core_types函数。</span></span><br><span class="line">            rv = (*cf-&gt;handler)(cf, <span class="literal">NULL</span>, cf-&gt;handler_conf);</span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"%s"</span>, rv);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认处理逻辑</span></span><br><span class="line">        rc = ngx_conf_handler(cf, rc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    rc = NGX_ERROR;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;conf_file-&gt;buffer-&gt;start) &#123;</span><br><span class="line">            ngx_free(cf-&gt;conf_file-&gt;buffer-&gt;start);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_close_file(fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cf-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_close_file_n <span class="string">" %s failed"</span>,</span><br><span class="line">                          filename-&gt;data);</span><br><span class="line">            rc = NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file = prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="词法解析（ngx-conf-read-token）"><a href="#词法解析（ngx-conf-read-token）" class="headerlink" title="词法解析（ngx_conf_read_token）"></a>词法解析（ngx_conf_read_token）</h3><p>ngx_conf_read_token函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_conf_read_token(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    u_char      *start, ch, *src, *dst;</span><br><span class="line">    <span class="keyword">off_t</span>        file_size;</span><br><span class="line">    <span class="keyword">size_t</span>       len;</span><br><span class="line">    <span class="keyword">ssize_t</span>      n, size;</span><br><span class="line">    <span class="comment">// 记录当前状态：分别表示：查找到解析块、需要一个分割符、需要解析下一个语句、注释、变量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   found, need_space, last_space, sharp_comment, variable;</span><br><span class="line">    <span class="comment">// 转义、单引号、双引号、起始行</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   quoted, s_quoted, d_quoted, start_line;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>   *word;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>   *b, *dump;</span><br><span class="line"></span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    need_space = <span class="number">0</span>;</span><br><span class="line">    last_space = <span class="number">1</span>;</span><br><span class="line">    sharp_comment = <span class="number">0</span>;</span><br><span class="line">    variable = <span class="number">0</span>;</span><br><span class="line">    quoted = <span class="number">0</span>;</span><br><span class="line">    s_quoted = <span class="number">0</span>;</span><br><span class="line">    d_quoted = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cf-&gt;args-&gt;nelts = <span class="number">0</span>;</span><br><span class="line">    b = cf-&gt;conf_file-&gt;buffer;</span><br><span class="line">    dump = cf-&gt;conf_file-&gt;dump;</span><br><span class="line">    start = b-&gt;pos;</span><br><span class="line">    start_line = cf-&gt;conf_file-&gt;line;</span><br><span class="line"></span><br><span class="line">    file_size = ngx_file_size(&amp;cf-&gt;conf_file-&gt;file.info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 当前内存中的数据已经解析结束</span></span><br><span class="line">        <span class="keyword">if</span> (b-&gt;pos &gt;= b-&gt;last) &#123;</span><br><span class="line">            <span class="comment">// 文件已经解析完成（如果是非文件，则都为0）</span></span><br><span class="line">            <span class="keyword">if</span> (cf-&gt;conf_file-&gt;file.offset &gt;= file_size) &#123;</span><br><span class="line">                <span class="comment">// 如果解析出了值或者状态不是要查找下一个解析块（但文件已经解析完了），则报错</span></span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &gt; <span class="number">0</span> || !last_space) &#123;</span><br><span class="line">                    <span class="comment">// 解析的是参数-g时的报错</span></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;conf_file-&gt;file.fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">                        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                           <span class="string">"unexpected end of parameter, "</span></span><br><span class="line">                                           <span class="string">"expecting \";\""</span>);</span><br><span class="line">                        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"unexpected end of file, "</span></span><br><span class="line">                                  <span class="string">"expecting \";\" or \"&#125;\""</span>);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果没有错误，则返回配置解析完成</span></span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_FILE_DONE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// start为执行该函数时的b-&gt;pos</span></span><br><span class="line">            len = b-&gt;pos - start;</span><br><span class="line">            <span class="comment">// 如果解析到长度大于NGX_CONF_BUFFER时，还未完成一个语句的解析，则是参数过长，报错</span></span><br><span class="line">            <span class="keyword">if</span> (len == NGX_CONF_BUFFER) &#123;</span><br><span class="line">                cf-&gt;conf_file-&gt;line = start_line;</span><br><span class="line">                <span class="comment">// 当前状态为找到一个双引号</span></span><br><span class="line">                <span class="keyword">if</span> (d_quoted) &#123;</span><br><span class="line">                    ch = <span class="string">'"'</span>;</span><br><span class="line">                <span class="comment">// 当前状态为找到一个单引号</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_quoted) &#123;</span><br><span class="line">                    ch = <span class="string">'\''</span>;</span><br><span class="line">                <span class="comment">// 否则直接报错，告知出错的起始位置</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                       <span class="string">"too long parameter \"%*s...\" started"</span>,</span><br><span class="line">                                       <span class="number">10</span>, start);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 报错，并告知可能缺少单引号或双引号</span></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"too long parameter, probably "</span></span><br><span class="line">                                   <span class="string">"missing terminating \"%c\" character"</span>, ch);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果存在已分析语句，但未完成（未return），则将分析开始到当前这部分值，拷贝到b-&gt;start上，以进行继续分析</span></span><br><span class="line">            <span class="keyword">if</span> (len) &#123;</span><br><span class="line">                ngx_memmove(b-&gt;start, start, len);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 计算文件中未读取的大小</span></span><br><span class="line">            size = (<span class="keyword">ssize_t</span>) (file_size - cf-&gt;conf_file-&gt;file.offset);</span><br><span class="line">            <span class="comment">// 如果文件剩余大小大于当前buf中还剩余的空间（b-&gt;end - (b-&gt;start + len)），则减少读取数量</span></span><br><span class="line">            <span class="keyword">if</span> (size &gt; b-&gt;end - (b-&gt;start + len)) &#123;</span><br><span class="line">                size = b-&gt;end - (b-&gt;start + len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从文件中读取数据</span></span><br><span class="line">            n = ngx_read_file(&amp;cf-&gt;conf_file-&gt;file, b-&gt;start + len, size,</span><br><span class="line">                              cf-&gt;conf_file-&gt;file.offset);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n != size) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   ngx_read_file_n <span class="string">" returned "</span></span><br><span class="line">                                   <span class="string">"only %z bytes instead of %z"</span>,</span><br><span class="line">                                   n, size);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 继续解析的起始位置</span></span><br><span class="line">            b-&gt;pos = b-&gt;start + len;</span><br><span class="line">            b-&gt;last = b-&gt;pos + n;</span><br><span class="line">            start = b-&gt;start;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dump) &#123;</span><br><span class="line">                dump-&gt;last = ngx_cpymem(dump-&gt;last, b-&gt;pos, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 读取当前pos的字符，并将pos后移</span></span><br><span class="line">        ch = *b-&gt;pos++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// #define LF     (u_char) '\n'</span></span><br><span class="line">        <span class="comment">// 如果字符为换行</span></span><br><span class="line">        <span class="keyword">if</span> (ch == LF) &#123;</span><br><span class="line">            cf-&gt;conf_file-&gt;line++;</span><br><span class="line">            <span class="comment">// 如果当前解析处于注释，则删除注释</span></span><br><span class="line">            <span class="keyword">if</span> (sharp_comment) &#123;</span><br><span class="line">                sharp_comment = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前解析处于注释内，直接跳过</span></span><br><span class="line">        <span class="keyword">if</span> (sharp_comment) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前在专业状态，则转义结束，并结束转义状态</span></span><br><span class="line">        <span class="keyword">if</span> (quoted) &#123;</span><br><span class="line">            quoted = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果需要一个分隔符</span></span><br><span class="line">        <span class="keyword">if</span> (need_space) &#123;</span><br><span class="line">        <span class="comment">// #define LF     (u_char) '\n'</span></span><br><span class="line">        <span class="comment">// #define CR     (u_char) '\r'</span></span><br><span class="line">        <span class="comment">// 如果是如下分隔符，则需要解析下一个语句，且不再需要分隔符</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span> || ch == <span class="string">'\t'</span> || ch == CR || ch == LF) &#123;</span><br><span class="line">                last_space = <span class="number">1</span>;</span><br><span class="line">                need_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果解析到分号，则表示当前语句解析结束，返回ok</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">';'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果解析到&#123;则表示将要解析块配置</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_BLOCK_START;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析到)，则需要解析下一个语句，并且不需要</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">')'</span>) &#123;</span><br><span class="line">                last_space = <span class="number">1</span>;</span><br><span class="line">                need_space = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 否则报错</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"unexpected \"%c\""</span>, ch);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果需要解析下一个语句</span></span><br><span class="line">        <span class="keyword">if</span> (last_space) &#123;</span><br><span class="line">            <span class="comment">// start为当前字符的地址</span></span><br><span class="line">            start = b-&gt;pos - <span class="number">1</span>;</span><br><span class="line">            start_line = cf-&gt;conf_file-&gt;line;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span> || ch == <span class="string">'\t'</span> || ch == CR || ch == LF) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据ch判断</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 如果是分号或&#123;，如果解析出的语句为0，则表示配置错误。如果是&#123;则表示后续要解析语法快。</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">';'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#123;'</span>:</span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts == <span class="number">0</span>) &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                       <span class="string">"unexpected \"%c\""</span>, ch);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_BLOCK_START;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            <span class="comment">// 如果是&#125;，则判断解析出的语句是否为0，不为0则表示，应该要进行解析，但读取到结束，表示配置错误。否则返回块结束解析完成</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#125;'</span>:</span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts != <span class="number">0</span>) &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                       <span class="string">"unexpected \"&#125;\""</span>);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_BLOCK_DONE;</span><br><span class="line">            <span class="comment">// 如果是#，则表示为注释</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">                sharp_comment = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是转义，则记录转义状态，并进行当前语句解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">                quoted = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是双引号，则起始位置应该不包括引号本身，并标识需要下一个双引号，并进行当前语句的解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'"'</span>:</span><br><span class="line">                start++;</span><br><span class="line">                d_quoted = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是单引号，则起始位置应该不包括引号本身，并标识需要下一个单引号，并进行当前语句的解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">                start++;</span><br><span class="line">                s_quoted = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是$,则表示要解析变量，并进行当前语句的解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'$'</span>:</span><br><span class="line">                variable = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 默认进入当前语句的解析</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果正处于解析当前语句时</span></span><br><span class="line">            <span class="comment">// 如果要解析变量，并且ch为&#123;,即$&#123;&#125;情况，则直接continue</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span> &amp;&amp; variable) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// variable标识置为0</span></span><br><span class="line">            variable = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'\\'</span>) &#123;</span><br><span class="line">                quoted = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'$'</span>) &#123;</span><br><span class="line">                variable = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果需要双引号，并且ch是双引号，则不再需要双引号，并需要分隔符，并找到一个词</span></span><br><span class="line">            <span class="keyword">if</span> (d_quoted) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'"'</span>) &#123;</span><br><span class="line">                    d_quoted = <span class="number">0</span>;</span><br><span class="line">                    need_space = <span class="number">1</span>;</span><br><span class="line">                    found = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果需要单引号，并且ch是单引号，则不再需要单引号，并需要分隔符，并找到一个词</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_quoted) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'\''</span>) &#123;</span><br><span class="line">                    s_quoted = <span class="number">0</span>;</span><br><span class="line">                    need_space = <span class="number">1</span>;</span><br><span class="line">                    found = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 如果是下列字符，则表示需要解析下一个词，并且标识当前查找到一个词</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">' '</span> || ch == <span class="string">'\t'</span> || ch == CR || ch == LF</span><br><span class="line">                       || ch == <span class="string">';'</span> || ch == <span class="string">'&#123;'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                last_space = <span class="number">1</span>;</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查找到一个词，增加到args中</span></span><br><span class="line">            <span class="keyword">if</span> (found) &#123;</span><br><span class="line">                <span class="comment">//向args添加，并分配空间</span></span><br><span class="line">                word = ngx_array_push(cf-&gt;args);</span><br><span class="line">                <span class="keyword">if</span> (word == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                word-&gt;data = ngx_pnalloc(cf-&gt;pool, b-&gt;pos - <span class="number">1</span> - start + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (word-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (dst = word-&gt;data, src = start, len = <span class="number">0</span>;</span><br><span class="line">                     src &lt; b-&gt;pos - <span class="number">1</span>;</span><br><span class="line">                     len++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (*src == <span class="string">'\\'</span>) &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (src[<span class="number">1</span>]) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'"'</span>:</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">                            src++;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                            *dst++ = <span class="string">'\t'</span>;</span><br><span class="line">                            src += <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">                            *dst++ = <span class="string">'\r'</span>;</span><br><span class="line">                            src += <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'n'</span>:</span><br><span class="line">                            *dst++ = <span class="string">'\n'</span>;</span><br><span class="line">                            src += <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    *dst++ = *src++;</span><br><span class="line">                &#125;</span><br><span class="line">                *dst = <span class="string">'\0'</span>;</span><br><span class="line">                word-&gt;len = len;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">';'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_BLOCK_START;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                found = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="默认处理（ngx-conf-handler）"><a href="#默认处理（ngx-conf-handler）" class="headerlink" title="默认处理（ngx_conf_handler）"></a>默认处理（ngx_conf_handler）</h3><p>ngx_conf_handler函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_conf_handler(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_int_t</span> last)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>           *rv;</span><br><span class="line">    <span class="keyword">void</span>           *conf, **confp;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>      i, found;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>      *name;</span><br><span class="line">    <span class="keyword">ngx_command_t</span>  *cmd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取词法解析后的第一个词</span></span><br><span class="line">    name = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历所有modules</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="comment">// 取modules下的commands</span></span><br><span class="line">        cmd = cf-&gt;cycle-&gt;modules[i]-&gt;commands;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历commands列表</span></span><br><span class="line">        <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; cmd-&gt;name.len; cmd++) &#123;</span><br><span class="line">            <span class="comment">// 判断该commands是否是该配置对应的模块，通过比较长度和值</span></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;len != cmd-&gt;name.len) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strcmp(name-&gt;data, cmd-&gt;name.data) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 找到对于的commends的标识</span></span><br><span class="line">            found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果该modules类型不是核心模块，或者该模块不是当前解析所关注的模块时，跳过该模块</span></span><br><span class="line">            <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_CONF_MODULE</span><br><span class="line">                &amp;&amp; cf-&gt;cycle-&gt;modules[i]-&gt;type != cf-&gt;module_type)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* is the directive's location right ? */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果commands的类型和当前解析的块不一致时，跳过。对于commands的类型详见设置配置项解析方式</span></span><br><span class="line">            <span class="keyword">if</span> (!(cmd-&gt;type &amp; cf-&gt;cmd_type)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果commends不是需要进行块解析，并且词法解析返回结果不是ok时，错误</span></span><br><span class="line">            <span class="keyword">if</span> (!(cmd-&gt;type &amp; NGX_CONF_BLOCK) &amp;&amp; last != NGX_OK) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"directive \"%s\" is not terminated by \";\""</span>,</span><br><span class="line">                                  name-&gt;data);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果commends是需要进行块解析，但词法解析返回结果不是NGX_CONF_BLOCK_START时，错误</span></span><br><span class="line">            <span class="keyword">if</span> ((cmd-&gt;type &amp; NGX_CONF_BLOCK) &amp;&amp; last != NGX_CONF_BLOCK_START) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"directive \"%s\" has no opening \"&#123;\""</span>,</span><br><span class="line">                                   name-&gt;data);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* is the directive's argument count right ? */</span></span><br><span class="line">            <span class="comment">// 根据commends所需配置项参数数量和词法解析出的数量，进行正确性校验</span></span><br><span class="line">            <span class="keyword">if</span> (!(cmd-&gt;type &amp; NGX_CONF_ANY)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_FLAG) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts != <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">goto</span> invalid;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_1MORE) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">goto</span> invalid;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_2MORE) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                        <span class="keyword">goto</span> invalid;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &gt; NGX_CONF_MAX_ARGS) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(cmd-&gt;type &amp; argument_number[cf-&gt;args-&gt;nelts - <span class="number">1</span>]))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set up the directive's configuration context */</span></span><br><span class="line"></span><br><span class="line">            conf = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">// commends需要解析的内容为全局配置（&#123;&#125;外）</span></span><br><span class="line">            <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_DIRECT_CONF) &#123;</span><br><span class="line">                conf = ((<span class="keyword">void</span> **) cf-&gt;ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;index];</span><br><span class="line">            <span class="comment">// commends需要解析的内容为NGX_MAIN_CONF，这只在核心模块进行处理，核心模块管理其下的所有模块，如ngx_http_module模块，管理所有的http模块。对于cmd-&gt;type解释详见下一节</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_MAIN_CONF) &#123;</span><br><span class="line">                conf = &amp;(((<span class="keyword">void</span> **) cf-&gt;ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;index]);</span><br><span class="line">            <span class="comment">// 对于非上述两种情况，此时cf-&gt;ctx与cycle的ctx_conf不是一个纬度了，而是由NGX_MAIN_CONF模块创建的配置数字，cmd-&gt;conf是改模块在其核心模块创建的配置中的偏移。如果http模块创建的ngx_http_conf_ctx_t，其中包含main_conf、srv_conf、loc_conf，此时的cmd-&gt;conf表示是这三个中的哪一个。</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;ctx) &#123;</span><br><span class="line">                confp = *(<span class="keyword">void</span> **) ((<span class="keyword">char</span> *) cf-&gt;ctx + cmd-&gt;conf);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (confp) &#123;</span><br><span class="line">                    conf = confp[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用模块的set函数</span></span><br><span class="line">            rv = cmd-&gt;<span class="built_in">set</span>(cf, cmd, conf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"\"%s\" directive %s"</span>, name-&gt;data, rv);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (found) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"\"%s\" directive is not allowed here"</span>, name-&gt;data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"unknown directive \"%s\""</span>, name-&gt;data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">invalid:</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"invalid number of arguments in \"%s\" directive"</span>,</span><br><span class="line">                       name-&gt;data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码，可以看出来，cycle中的ctx_conf中，并不是每个模块都有一个对应的<code>ctx_conf[modules[i]-&gt;index]</code>。一般都是核心模块会存在一个对应的配置。核心模块下的<code>ctx_conf[modules[i]-&gt;index]</code>配置，会分配好其管理的每个子模块的存储空间。查找子模块时，通过其所属的核心模块的配置地址，再通过模块的ctx_index查找到对应配置。（具体查找方式较为复杂，详见http模块解析）。</p>
<h3 id="设置配置项解析方式（ngx-commend-S）"><a href="#设置配置项解析方式（ngx-commend-S）" class="headerlink" title="设置配置项解析方式（ngx_commend_S）"></a>设置配置项解析方式（ngx_commend_S）</h3><p>下面介绍读取配置时是如何使用ngx_commend_s的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_command_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>             name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            type;</span><br><span class="line">    <span class="keyword">char</span>               *(*<span class="built_in">set</span>)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf);</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            conf;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            offset;</span><br><span class="line">    <span class="keyword">void</span>                 *post;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-str-t-name"><a href="#ngx-str-t-name" class="headerlink" title="ngx_str_t  name"></a>ngx_str_t  name</h4><p>配置名称，和解析出的名称做比较，确定是否是该模块关注的配置。</p>
<h4 id="ngx-uint-t-type"><a href="#ngx-uint-t-type" class="headerlink" title="ngx_uint_t type"></a>ngx_uint_t type</h4><p>type决定配置项可以在哪些块出现（如http、server、location、if、upstream），以及可以携带参数类型和个数。下表列出了可以的取值。可同时取多个值，通过$ \vert $连接。</p>
<table>
  <tr>
    <td>type类型</td>
    <td>type取值</td>
    <td>含义</td>
  </tr>
  <tr>
    <td rowspan="2">处理配置项时获取当前配置块的方式</td>
    <td>NGX_DIRECT_CONF</td>
    <td>一般由NGX_CORE_MODULE类型的核心模块使用，仅与下面的NGX_MAIN_CONF同时设置，表示模块需要解析不属于任何{}内的全局配置项。它实际上会指定set方法里的第三个参数conf的值，使之指向每个模块解析全局配置项的配置结构体</td>
  </tr>
  <tr>
    <td>NGX_ANY_CONF</td>
    <td>当前未使用</td>
  </tr>
  <tr>
    <td rowspan="12">配置项可以在哪些{}配置块中出现</td>
    <td>NGX_MAIN_CONF</td>
    <td>配置项可以出现在全局配置中，即不属于任何{}配置块</td>
  </tr>
  <tr>
    <td>NGX_EVENT_CONF</td>
    <td>配置项可以出现在events{}块内</td>
  </tr>
  <tr>
    <td>NGX_MAIL_MAIN_CONF</td>
    <td>配置项可以出现在mail{}块或imap{}内</td>
  </tr>
  <tr>
    <td>NGX_MAIL_SRV_CONF</td>
    <td>配置项可以出现在server{}块内，但server{}必须在mail{}块或imap{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_MAIN_CONF</td>
    <td>配置项可以出现在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_SRV_CONF</td>
    <td>配置项可以出现在server{}块内，但server{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_SRV_CONF</td>
    <td>配置项可以出现在server{}块内，但server{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_LOC_CONF</td>
    <td>配置项可以出现在location{}块内，但location{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_UPS_CONF</td>
    <td>配置项可以出现在upstream{}块内，但upstream{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_SIF_CONF</td>
    <td>配置项可以出现在server{}块内的if{}中，目前仅rewrite模块使用。if必须属于http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_LIF_CONF</td>
    <td>配置项可以出现在loc{}块内的if{}中，目前仅rewrite模块使用。if必须属于http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_LMT_CONF</td>
    <td>配置项可以出现在limit_except{}内。limit_except必须属于http{}内</td>
  </tr>
  <tr>
    <td rowspan="13">配置项参数限制</td>
    <td>NGX_CONF_NOARGS</td>
    <td>配置项不携带任何参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE1</td>
    <td>配置项必须携带1个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE2</td>
    <td>配置项必须携带2个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE3</td>
    <td>配置项必须携带3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE4</td>
    <td>配置项必须携带4个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE5</td>
    <td>配置项必须携带5个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE6</td>
    <td>配置项必须携带6个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE7</td>
    <td>配置项必须携带7个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE12</td>
    <td>配置项必须携带1~2个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE13</td>
    <td>配置项必须携带1~3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE23</td>
    <td>配置项必须携带2~3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE123</td>
    <td>配置项必须携带1~3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE1234</td>
    <td>配置项必须携带1~4个参数</td>
  </tr>
  <tr>
    <td rowspan="7">限制配置项后参数出现形式</td>
    <td>NGX_CONF_ARGS_NUMBER</td>
    <td>目前未使用，无意义</td>
  </tr>
  <tr>
    <td>NGX_CONF_BLOCK</td>
    <td>配置项定义了一种新的{}块。例如http、server、location等配置，其type必须为NGX_CONF_BLOCK</td>
  </tr>
  <tr>
    <td>NGX_CONF_ANY</td>
    <td>不验证配置项携带参数个数</td>
  </tr>
  <tr>
    <td>NGX_CONF_FLAG</td>
    <td>配置项携带参数只能是1个，并且参数只能是on/off</td>
  </tr>
  <tr>
    <td>NGX_CONF_1MORE</td>
    <td>配置项携带参数必须超过1个</td>
  </tr>
  <tr>
    <td>NGX_CONF_2MORE</td>
    <td>配置项携带参数必须超过2个</td>
  </tr>
  <tr>
    <td>NGX_CONF_MULTI</td>
    <td>表示当前配置项可以出现在任意块中</td>
  </tr>
</table>

<p> 如果HTTP模块中定义的配置项在nginx.conf配置文件中实际出现的位置和参数格式与type意义不符，那么Nginx启动报错。</p>
<p>每个进程都有一个唯一的ngx_cycle_t核心结构体，其成员conf_ctx维护所有模块配置结构决定配置项可以在哪些块出现决定配置项可以在哪些块出现体。其类型是void<strong><strong>。conf_ctx意义为首先指向一个成员皆为指针的数组，其中每个成员指针又指向另外一个成员皆为指针的数组，第二个子数组中的成员指针才会指向个模块生成的配置结构体。这是为了事件模块、http模块、mail模块而设计的。而NGX_CORE_MODULE类型的核心模块解析配置项时，配置项一定是全局的，不会从属任何{}配置块，其不需要这种双数组设计。解析标识为NGX_DIRECT_CONF类型的配置项时，会将void</strong></strong>转换为void**。</p>
<h4 id="char-set-ngx-conf-t-cf-ngx-command-t-cmd-void-conf"><a href="#char-set-ngx-conf-t-cf-ngx-command-t-cmd-void-conf" class="headerlink" title="char(set)(ngx_conf_t cf, ngx_command_t cmd, void *conf)"></a>char(set)(ngx_conf_t <em>cf, ngx_command_t</em> cmd, void *conf)</h4><p><code>set</code>回调方法，使用位置在ngx_conf_handler中已展现。对于set方法，我们即可以实现一个回调方法来处理，也可以使用Nginx预设的14个解析配置项方法。预设方法如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>预设方法名</th>
<th>行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_conf_set_flag_slot</td>
<td>如果nginx.conf文件中某个配置项的参数是on或off（打开或关闭），而且在Nginx模块的代码中使用ngx_flag_t变量来保存这个配置项的参数，就可以将set回调方法设为ngx_conf_set_flag_slot。当nginx.conf文件中参数是on时，代码中的ngx_flag_t类型变量设为1，参数off时为0.</td>
</tr>
<tr>
<td>ngx_conf_set_str_slot</td>
<td>如果配置项后只有一个参数，同时在代码中我们希望用ngx_str_t类型变量来报错这个配置项的参数，则可以使用ngx_conf_set_str_slot方法</td>
</tr>
<tr>
<td>ngx_conf_set_str_array_slot</td>
<td>如果配置项会出现多次，每个配置项后面跟着1个参数，而程序中使用一个ngx_array_t动态数组来存储所有参数，且数组中的每个参数都使用ngx_str_t来存储，可以设置该方法。</td>
</tr>
<tr>
<td>ngx_conf_set_keyval_slot</td>
<td>与ngx_conf_set_str_array_slot类似，也是使用ngx_array_t动态数组来存储所有参数。只是每个配置项的参数不再是1个，而必须是2个，且以配置项名 关键字 值的形式出现在nginx.conf中，同时改方法把这些配置项转化为数组，其中每个元素都存储这key/value对。</td>
</tr>
<tr>
<td>ngx_conf_set_num_slot</td>
<td>配置项后必须携带1个参数，且只能是数字，存储这个参数的变量必须是整数</td>
</tr>
<tr>
<td>ngx_conf_set_size_slot</td>
<td>配置项后必须携带1个参数，表示空间大小，可以是一个数字，此时表示字节数（Byte）。如果后面跟着K或k，表示kilobyte，1kb=1024B,如果后面更早m或M，就表示Megabyte，1MB=1024KB。该函数解析后，都转换成byte。</td>
</tr>
<tr>
<td>ngx_conf_set_off_slot</td>
<td>配置项后必须携带1个参数，表示空间上的偏移，可以是一个数字，此时表示字节数（Byte）。如果后面跟着K或k，表示kilobyte，1kb=1024B,如果后面更早m或M，就表示Megabyte，1MB=1024KB。还可以是g或G。该函数解析后，都转换成byte。</td>
</tr>
<tr>
<td>ngx_conf_set_msec_slot</td>
<td>配置项后必须携带1个参数，表示时间。无单位表示秒。m表示分钟。h表示小时。d表示天。w表示周。m表示月（30天）。y表示年。解析后转化为毫秒的单位</td>
</tr>
<tr>
<td>ngx_conf_set_sec_slot</td>
<td>与ngx_conf_set_msec_slot类似，不过解析后转化为秒</td>
</tr>
<tr>
<td>ngx_conf_set_bufs_slot</td>
<td>配置项后必须携带2个参数。第一个参数是数字，第二个参数表示空间大小。例如”gzip-buffers 4 8k”（通常用来表示有多少个ngx_buf_t缓冲区）。第一个不可带单位。第二个为存储大小。该配置对应Nginx最常用的多缓冲区的解决方案（如接收对端发来的TCP流）</td>
</tr>
<tr>
<td>ngx_conf_set_enum_slot</td>
<td>配置项后必须携带1个参数，其取值范围是我们设定好的字符串之一。</td>
</tr>
<tr>
<td>ngx_conf_set_bitmask_slot</td>
<td>与ngx_conf_set_enum_slot类似。</td>
</tr>
<tr>
<td>ngx_conf_set_access_slot</td>
<td>这个方法用于设置目录或者文件的读写权限。配置项后可以携带1~3个参数，可以是如下形式：user:rw group:rw all:rw。其意义与Linux上文件或目录的权限一致，但user/group/all后面权限只可以设置rw，或者r</td>
</tr>
<tr>
<td>ngx_conf_set_path_slot</td>
<td>用于设置路径，配置项后面必须携带1个参数，表示一个有意义的路径。该方法会把参数转化为ngx_path_t结构</td>
</tr>
</tbody>
</table>
</div>
<h4 id="ngx-uint-t-conf"><a href="#ngx-uint-t-conf" class="headerlink" title="ngx_uint_t conf"></a>ngx_uint_t conf</h4><p>conf用于指示配置项所处内存的相对偏移位置，仅在type中没有设置NGX_DIRECT_CONF和NGX_MAIN_CONF时才会生效。对于HTTP模块，conf是必须要设置的，其取值范围如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>conf在HTTP模块的取值</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>NGX_HTTP_MAIN_CONF_OFFSET</td>
<td>使用create_main_conf方法产生的结构体来存储解析出的配置项参数</td>
</tr>
<tr>
<td>NGX_HTTP_SRV_CONF_OFFSET</td>
<td>使用create_srv_conf方法产生的结构体来存储解析出的配置项参数</td>
</tr>
<tr>
<td>NGX_HTTP_LOC_CONF_OFFSET</td>
<td>使用create_loc_conf方法产生的结构体来存储解析出的配置项参数</td>
</tr>
</tbody>
</table>
</div>
<p>HTTP框架可以使用预设的14种方法自动地将解析出的配置项写入HTTP模块代码定义的结构体中，但HTTP模块中可能会定义3个结 构体，分别用于存储main、srv、loc级别的配置项(对应于create_main_conf、 create_srv_conf、create_loc_conf方法创建的结构体)，而HTTP框架自动解析时需要知道应把解析出的配置项值写入哪个结构体中，这将由conf成员完成。</p>
<p>对conf的设置是与ngx_http_module_t实现的回调方法相关的。 如果用于存储这个配置项的数据结构是由create_main_conf回调方法完成的，那么必须把conf 设置为NGX_HTTP_MAIN_CONF_OFFSET。同样，如果这个配置项所属的数据结构是由 create_srv_conf回调方法完成的，那么必须把conf设置为NGX_HTTP_SRV_CONF_OFFSET。 可如果create_loc_conf负责生成存储这个配置项的数据结构，就得将conf设置为 NGX_HTTP_LOC_CONF_OFFSET。</p>
<p>目前，功能较为简单的HTTP模块都只实现了create_loc_conf回调方法，对于http{}、 server{}块内出现的同名配置项，都是并入某个location{}内create_loc_conf方法产生的结构体 中的。当我们希望同时出现在http{}、server{}、 location{}块的同名配置项，在HTTP模块的代码中保存于不同的变量中时，就需要实现 create_main_conf方法、create_srv_conf方法产生新的结构体，从而以不同的结构体独立保存 不同级别的配置项，而不是全部合并到某个location下create_loc_conf方法生成的结构体中。</p>
<h4 id="ngx-uint-t-offset"><a href="#ngx-uint-t-offset" class="headerlink" title="ngx_uint_t offset"></a>ngx_uint_t offset</h4><p>offset表示当前配置项在整个存储配置项的结构体中的偏移位置(以字节(Byte)为单位)。在使用Nginx预设的解析配置项方法时，就必须指定offset，这 样Nginx首先通过conf成员找到应该用哪个结构体来存放，然后通过offset成员找到这个结构 体中的相应成员，以便存放该配置。如果是自定义的专用配置项解析方法(只解析某一个配 置项)，则可以不设置offset的值。其设置方式主要方式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(type,member)(size_t)&amp;(((type*)0)-&gt;member)</span></span><br></pre></td></tr></table></figure>
<h4 id="void-post"><a href="#void-post" class="headerlink" title="void *post"></a>void *post</h4><p>post指针有许多用处，其使用方式是在调用set方法内调用。</p>
<p>如果自定义了配置项的回调方法，那么post指针的用途完全由用户来定义。如果不使用 它，那么随意设为NULL即可。如果想将一些数据结构或者方法的指针传过来，那么使用post 也可以。</p>
<p>如果使用Nginx预设的配置项解析方法，就需要根据这些预设方法来决定post的使用方 式。表4-4说明了post相对于14个预设方法的用途。</p>
<table>
  <tr>
    <td>pos使用方法</td>
    <td>适用的预设配置项解析方法</td>
  </tr>
  <tr>
    <td rowspan="9">可以选择是否实现。如果设置NULL，则表示不实现，否则必须实现为指向ngx_conf_post_t结构的指针。ngx_conf_post_t中包含一个方法指针，表示在解析当前配置项完毕后，需要回调这个方法</td>
    <td>ngx_conf_set_flag_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_str_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_str_array_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_keyval_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_num_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_size_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_off_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_msec_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_sec_slot</td>
  </tr>
  <tr>
    <td>指向ngx_conf_enum_t数组，表示当前配置项的参数必须设置为ngx_conf_enum_t规定的值（类似枚举）。必须定义</td>
    <td>ngx_conf_set_enum_slot</td>
  </tr>
  <tr>
    <td>指向ngx_conf_bitmask_t数组，表示当前配置项的参数必须设置为ngx_conf_bitmask_t规定的值（类似枚举）。必须定义</td>
    <td>ngx_conf_set_enum_slot</td>
  </tr>
  <tr>
    <td rowspan="3">无任何用处</td>
    <td>ngx_conf_set_buffs_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_path_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_access_slot</td>
  </tr>
</table>

<p>有9个预设方法在使用post是可以设置为ngx_conf_post_t结构体来使用，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">char</span> <span class="params">(ngx_conf_post_handler_pt)</span> <span class="params">(<span class="keyword">ngx_conf_t</span> cf, <span class="keyword">void</span> data, <span class="keyword">void</span> *conf)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  ngx_conf_post_handler_pt post_handler;</span><br><span class="line">&#125; <span class="keyword">ngx_conf_post_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="预设配置项处理方法工作原理"><a href="#预设配置项处理方法工作原理" class="headerlink" title="预设配置项处理方法工作原理"></a>预设配置项处理方法工作原理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">ngx_conf_set_num_slot(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// conf为存储参数的结构体指针。该结构体是每个模块自定义的。</span></span><br><span class="line">    <span class="keyword">char</span>  *p = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>        *np;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_conf_post_t</span>  *post;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据ngx_command_t中offset偏移量，可以找到结构体中成员</span></span><br><span class="line">    np = (<span class="keyword">ngx_int_t</span> *) (p + cmd-&gt;offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*np != NGX_CONF_UNSET) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// value将指向配置项的参数</span></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 将字符串的参数转换为整数，并设置到create_loc_conf等方法生成的结构体的相关成员上</span></span><br><span class="line">    *np = ngx_atoi(value[<span class="number">1</span>].data, value[<span class="number">1</span>].len);</span><br><span class="line">    <span class="keyword">if</span> (*np == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"invalid number"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果ngx_command_t中post已经实现，那么还需要调用post-&gt;post_handler方法。目前Nginx官方模块未使用</span></span><br><span class="line">    <span class="keyword">if</span> (cmd-&gt;post) &#123;</span><br><span class="line">        post = cmd-&gt;post;</span><br><span class="line">        <span class="keyword">return</span> post-&gt;post_handler(cf, post, np);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="http模块配置解析"><a href="#http模块配置解析" class="headerlink" title="http模块配置解析"></a>http模块配置解析</h2><p><a href="https://imgtu.com/i/RcHHKK" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/02/RcHHKK.png" alt="RcHHKK.png"></a></p>
<p>在默认的处理函数<code>ngx_conf_handler</code>中，会会调用核心模块的commands数组的每个元素的set方法。对于http来说，核心模块为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_http_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http"</span>),</span><br><span class="line">      NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span><br><span class="line">      ngx_http_block,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_core_module_t</span>  ngx_http_module_ctx = &#123;</span><br><span class="line">    ngx_string(<span class="string">"http"</span>),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_module_t</span>  ngx_http_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_http_module_ctx,                  <span class="comment">/* module context */</span></span><br><span class="line">    ngx_http_commands,                     <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_CORE_MODULE,                       <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init master */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init module */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="http层set函数"><a href="#http层set函数" class="headerlink" title="http层set函数"></a>http层set函数</h3><p>执行set方法即执行ngx_http_block函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_block(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                        *rv;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   mi, m, s;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                   pcf;</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span>           *<span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>         *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>   **cscfp;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>   *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">ngx_http_conf_ctx_t</span> **) conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the main http context */</span></span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">ngx_http_conf_ctx_t</span> **) conf = ctx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* count the number of the http modules and set up their indices */</span></span><br><span class="line">    <span class="comment">// 获取http模块数量，并设置其ctx_index</span></span><br><span class="line">    ngx_http_max_module = ngx_count_modules(cf-&gt;cycle, NGX_HTTP_MODULE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the http main_conf context, it is the same in the all http contexts */</span></span><br><span class="line">    <span class="comment">// 初始化ctx</span></span><br><span class="line">    ctx-&gt;main_conf = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;main_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the http null srv_conf context, it is used to merge</span></span><br><span class="line"><span class="comment">     * the server&#123;&#125;s' srv_conf's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;srv_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the http null loc_conf context, it is used to merge</span></span><br><span class="line"><span class="comment">     * the server&#123;&#125;s' loc_conf's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * create the main_conf's, the null srv_conf's, and the null loc_conf's</span></span><br><span class="line"><span class="comment">     * of the all http modules</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 执行每个http模块的create_main_conf、create_srv_conf、create_loc_conf方法，其返回为每个模块在对于块下用于存储解析结果的结构体</span></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">        mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_main_conf) &#123;</span><br><span class="line">            ctx-&gt;main_conf[mi] = <span class="keyword">module</span>-&gt;create_main_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;main_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_srv_conf) &#123;</span><br><span class="line">            ctx-&gt;srv_conf[mi] = <span class="keyword">module</span>-&gt;create_srv_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;srv_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_loc_conf) &#123;</span><br><span class="line">            ctx-&gt;loc_conf[mi] = <span class="keyword">module</span>-&gt;create_loc_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;loc_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pcf = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    <span class="comment">// 执行每个模块的preconfiguration方法，增加变量。</span></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;preconfiguration) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;preconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* parse inside the http&#123;&#125; block */</span></span><br><span class="line">    <span class="comment">// 解析http块下配置</span></span><br><span class="line">    cf-&gt;module_type = NGX_HTTP_MODULE;</span><br><span class="line">    cf-&gt;cmd_type = NGX_HTTP_MAIN_CONF;</span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * init http&#123;&#125; main_conf's, merge the server&#123;&#125;s' srv_conf's</span></span><br><span class="line"><span class="comment">     * and its location&#123;&#125;s' loc_conf's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 解析后合并及其他操作，下一章节介绍</span></span><br><span class="line">    cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    cscfp = cmcf-&gt;servers.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">        mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* init http&#123;&#125; main_conf's */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;init_main_conf) &#123;</span><br><span class="line">            rv = <span class="keyword">module</span>-&gt;init_main_conf(cf, ctx-&gt;main_conf[mi]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rv = ngx_http_merge_servers(cf, cmcf, <span class="keyword">module</span>, mi);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create location trees */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_locations(cf, cscfp[s], clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_phases(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_headers_in_hash(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_variables_init_vars(cf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * http&#123;&#125;'s cf-&gt;ctx was needed while the configuration merging</span></span><br><span class="line"><span class="comment">     * and in postconfiguration process</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_phase_handlers(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* optimize the lists of ports, addresses and server names */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_optimize_servers(cf, cmcf, cmcf-&gt;ports) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-conf-ctx-t"><a href="#ngx-http-conf-ctx-t" class="headerlink" title="ngx_http_conf_ctx_t"></a>ngx_http_conf_ctx_t</h4><p>上面代码中ngx_http_conf_ctx_t类定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    void        **main_conf;</span><br><span class="line">    void        **srv_conf;</span><br><span class="line">    void        **loc_conf;</span><br><span class="line">&#125; ngx_http_conf_ctx_t;</span><br></pre></td></tr></table></figure>
<p>分别用来存储main、server、loc块下配置。</p>
<h4 id="ngx-http-core-module模块生成的三个结构"><a href="#ngx-http-core-module模块生成的三个结构" class="headerlink" title="ngx_http_core_module模块生成的三个结构"></a>ngx_http_core_module模块生成的三个结构</h4><p>在执行create_main_conf、create_srv_conf、create_loc_conf时，会生成三个结构体，其中ngx_http_core_module是http的核心模块。其生成的三个结构体如下：</p>
<h5 id="ngx-http-core-main-conf-t"><a href="#ngx-http-core-main-conf-t" class="headerlink" title="ngx_http_core_main_conf_t"></a>ngx_http_core_main_conf_t</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_array_t                servers;         /* ngx_http_core_srv_conf_t */</span><br><span class="line"></span><br><span class="line">    ngx_http_phase_engine_t    phase_engine;</span><br><span class="line"></span><br><span class="line">    ngx_hash_t                 headers_in_hash;</span><br><span class="line"></span><br><span class="line">    ngx_hash_t                 variables_hash;</span><br><span class="line"></span><br><span class="line">    ngx_array_t                variables;         /* ngx_http_variable_t */</span><br><span class="line">    ngx_array_t                prefix_variables;  /* ngx_http_variable_t */</span><br><span class="line">    ngx_uint_t                 ncaptures;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                 server_names_hash_max_size;</span><br><span class="line">    ngx_uint_t                 server_names_hash_bucket_size;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                 variables_hash_max_size;</span><br><span class="line">    ngx_uint_t                 variables_hash_bucket_size;</span><br><span class="line"></span><br><span class="line">    ngx_hash_keys_arrays_t    *variables_keys;</span><br><span class="line"></span><br><span class="line">    ngx_array_t               *ports;</span><br><span class="line"></span><br><span class="line">    ngx_http_phase_t           phases[NGX_HTTP_LOG_PHASE + 1];</span><br><span class="line">&#125; ngx_http_core_main_conf_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-core-srv-conf-t"><a href="#ngx-http-core-srv-conf-t" class="headerlink" title="ngx_http_core_srv_conf_t"></a>ngx_http_core_srv_conf_t</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    /* array of the ngx_http_server_name_t, &quot;server_name&quot; directive */</span><br><span class="line">    ngx_array_t                 server_names;</span><br><span class="line"></span><br><span class="line">    /* server ctx */</span><br><span class="line">    ngx_http_conf_ctx_t        *ctx;</span><br><span class="line"></span><br><span class="line">    u_char                     *file_name;</span><br><span class="line">    ngx_uint_t                  line;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                   server_name;</span><br><span class="line"></span><br><span class="line">    size_t                      connection_pool_size;</span><br><span class="line">    size_t                      request_pool_size;</span><br><span class="line">    size_t                      client_header_buffer_size;</span><br><span class="line"></span><br><span class="line">    ngx_bufs_t                  large_client_header_buffers;</span><br><span class="line"></span><br><span class="line">    ngx_msec_t                  client_header_timeout;</span><br><span class="line"></span><br><span class="line">    ngx_flag_t                  ignore_invalid_headers;</span><br><span class="line">    ngx_flag_t                  merge_slashes;</span><br><span class="line">    ngx_flag_t                  underscores_in_headers;</span><br><span class="line"></span><br><span class="line">    unsigned                    listen:1; // 配置中是否设置了监听</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    unsigned                    captures:1;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_http_core_loc_conf_t  **named_locations;</span><br><span class="line">&#125; ngx_http_core_srv_conf_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-core-loc-conf-s"><a href="#ngx-http-core-loc-conf-s" class="headerlink" title="ngx_http_core_loc_conf_s"></a>ngx_http_core_loc_conf_s</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_http_core_loc_conf_s &#123;</span><br><span class="line">    ngx_str_t     name;          /* location name */</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_regex_t  *regex;</span><br><span class="line">#endif</span><br><span class="line">    // nginx将if语句和limit_except也看作为ngx_http_core_loc_conf_s，这里标识其类型为非location块的</span><br><span class="line">    unsigned      noname:1;   /* &quot;if () &#123;&#125;&quot; block or limit_except */ </span><br><span class="line">    unsigned      lmt_excpt:1;</span><br><span class="line">    // 以’@’开头的，如location @test &#123;&#125;</span><br><span class="line">    unsigned      named:1;</span><br><span class="line">    // 类似 location = / &#123;&#125;，所谓准确匹配。</span><br><span class="line">    unsigned      exact_match:1;</span><br><span class="line">    // 没有正则，指类似location ^~ /a &#123; ... &#125; 的location。</span><br><span class="line">    unsigned      noregex:1;</span><br><span class="line"></span><br><span class="line">    unsigned      auto_redirect:1;</span><br><span class="line">#if (NGX_HTTP_GZIP)</span><br><span class="line">    unsigned      gzip_disable_msie6:2;</span><br><span class="line">    unsigned      gzip_disable_degradation:2;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_http_location_tree_node_t   *static_locations;</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_core_loc_conf_t       **regex_locations;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    /* pointer to the modules&apos; loc_conf */</span><br><span class="line">    void        **loc_conf;</span><br><span class="line"></span><br><span class="line">    uint32_t      limit_except;</span><br><span class="line">    void        **limit_except_loc_conf;</span><br><span class="line"></span><br><span class="line">    ngx_http_handler_pt  handler;</span><br><span class="line"></span><br><span class="line">    /* location name length for inclusive location with inherited alias */</span><br><span class="line">    size_t        alias;</span><br><span class="line">    ngx_str_t     root;                    /* root, alias */</span><br><span class="line">    ngx_str_t     post_action;</span><br><span class="line"></span><br><span class="line">    ngx_array_t  *root_lengths;</span><br><span class="line">    ngx_array_t  *root_values;</span><br><span class="line"></span><br><span class="line">    ngx_array_t  *types;</span><br><span class="line">    ngx_hash_t    types_hash;</span><br><span class="line">    ngx_str_t     default_type;</span><br><span class="line"></span><br><span class="line">    off_t         client_max_body_size;    /* client_max_body_size */</span><br><span class="line">    off_t         directio;                /* directio */</span><br><span class="line">    off_t         directio_alignment;      /* directio_alignment */</span><br><span class="line"></span><br><span class="line">    size_t        client_body_buffer_size; /* client_body_buffer_size */</span><br><span class="line">    size_t        send_lowat;              /* send_lowat */</span><br><span class="line">    size_t        postpone_output;         /* postpone_output */</span><br><span class="line">    size_t        sendfile_max_chunk;      /* sendfile_max_chunk */</span><br><span class="line">    size_t        read_ahead;              /* read_ahead */</span><br><span class="line">    size_t        subrequest_output_buffer_size;</span><br><span class="line">                                           /* subrequest_output_buffer_size */</span><br><span class="line"></span><br><span class="line">    ngx_http_complex_value_t  *limit_rate; /* limit_rate */</span><br><span class="line">    ngx_http_complex_value_t  *limit_rate_after; /* limit_rate_after */</span><br><span class="line"></span><br><span class="line">    ngx_msec_t    client_body_timeout;     /* client_body_timeout */</span><br><span class="line">    ngx_msec_t    send_timeout;            /* send_timeout */</span><br><span class="line">    ngx_msec_t    keepalive_timeout;       /* keepalive_timeout */</span><br><span class="line">    ngx_msec_t    lingering_time;          /* lingering_time */</span><br><span class="line">    ngx_msec_t    lingering_timeout;       /* lingering_timeout */</span><br><span class="line">    ngx_msec_t    resolver_timeout;        /* resolver_timeout */</span><br><span class="line">    ngx_msec_t    auth_delay;              /* auth_delay */</span><br><span class="line"></span><br><span class="line">    ngx_resolver_t  *resolver;             /* resolver */</span><br><span class="line"></span><br><span class="line">    time_t        keepalive_header;        /* keepalive_timeout */</span><br><span class="line"></span><br><span class="line">    ngx_uint_t    keepalive_requests;      /* keepalive_requests */</span><br><span class="line">    ngx_uint_t    keepalive_disable;       /* keepalive_disable */</span><br><span class="line">    ngx_uint_t    satisfy;                 /* satisfy */</span><br><span class="line">    ngx_uint_t    lingering_close;         /* lingering_close */</span><br><span class="line">    ngx_uint_t    if_modified_since;       /* if_modified_since */</span><br><span class="line">    ngx_uint_t    max_ranges;              /* max_ranges */</span><br><span class="line">    ngx_uint_t    client_body_in_file_only; /* client_body_in_file_only */</span><br><span class="line"></span><br><span class="line">    ngx_flag_t    client_body_in_single_buffer;</span><br><span class="line">                                           /* client_body_in_singe_buffer */</span><br><span class="line">    ngx_flag_t    internal;                /* internal */</span><br><span class="line">    ngx_flag_t    sendfile;                /* sendfile */</span><br><span class="line">    ngx_flag_t    aio;                     /* aio */</span><br><span class="line">    ngx_flag_t    aio_write;               /* aio_write */</span><br><span class="line">    ngx_flag_t    tcp_nopush;              /* tcp_nopush */</span><br><span class="line">    ngx_flag_t    tcp_nodelay;             /* tcp_nodelay */</span><br><span class="line">    ngx_flag_t    reset_timedout_connection; /* reset_timedout_connection */</span><br><span class="line">    ngx_flag_t    absolute_redirect;       /* absolute_redirect */</span><br><span class="line">    ngx_flag_t    server_name_in_redirect; /* server_name_in_redirect */</span><br><span class="line">    ngx_flag_t    port_in_redirect;        /* port_in_redirect */</span><br><span class="line">    ngx_flag_t    msie_padding;            /* msie_padding */</span><br><span class="line">    ngx_flag_t    msie_refresh;            /* msie_refresh */</span><br><span class="line">    ngx_flag_t    log_not_found;           /* log_not_found */</span><br><span class="line">    ngx_flag_t    log_subrequest;          /* log_subrequest */</span><br><span class="line">    ngx_flag_t    recursive_error_pages;   /* recursive_error_pages */</span><br><span class="line">    ngx_uint_t    server_tokens;           /* server_tokens */</span><br><span class="line">    ngx_flag_t    chunked_transfer_encoding; /* chunked_transfer_encoding */</span><br><span class="line">    ngx_flag_t    etag;                    /* etag */</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_GZIP)</span><br><span class="line">    ngx_flag_t    gzip_vary;               /* gzip_vary */</span><br><span class="line"></span><br><span class="line">    ngx_uint_t    gzip_http_version;       /* gzip_http_version */</span><br><span class="line">    ngx_uint_t    gzip_proxied;            /* gzip_proxied */</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_array_t  *gzip_disable;            /* gzip_disable */</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_THREADS || NGX_COMPAT)</span><br><span class="line">    ngx_thread_pool_t         *thread_pool;</span><br><span class="line">    ngx_http_complex_value_t  *thread_pool_value;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_OPENAT)</span><br><span class="line">    ngx_uint_t    disable_symlinks;        /* disable_symlinks */</span><br><span class="line">    ngx_http_complex_value_t  *disable_symlinks_from;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_array_t  *error_pages;             /* error_page */</span><br><span class="line"></span><br><span class="line">    ngx_path_t   *client_body_temp_path;   /* client_body_temp_path */</span><br><span class="line"></span><br><span class="line">    ngx_open_file_cache_t  *open_file_cache;</span><br><span class="line">    time_t        open_file_cache_valid;</span><br><span class="line">    ngx_uint_t    open_file_cache_min_uses;</span><br><span class="line">    ngx_flag_t    open_file_cache_errors;</span><br><span class="line">    ngx_flag_t    open_file_cache_events;</span><br><span class="line"></span><br><span class="line">    ngx_log_t    *error_log;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t    types_hash_max_size;</span><br><span class="line">    ngx_uint_t    types_hash_bucket_size;</span><br><span class="line"></span><br><span class="line">    ngx_queue_t  *locations;</span><br><span class="line"></span><br><span class="line">#if 0</span><br><span class="line">    ngx_http_core_loc_conf_t  *prev_location;</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在处理http块内main配置时，对每个http模块创建了三个结构体，这是为了把同时出现在http、server、location块中相同的配置进行合并而准备的。例如，有一个与server相关的配置（例如负责指定每个TCP连接池大小的connection_pool_size配置项）同时出现在http和server中，那么对其感兴趣的http模块有权决定srv结构内成员究竟是以main级别的为准还是已srv的为准。对loc级别的配置也是如此，loc级别的需要http下创建的loc和server创建的loc和loc级别本身创建的loc三者共同决定。因此main级别的配置会被创建1次（在解析http时创建），server级别的配置会被创建2次（解析http块一次和解析server块一次），loc级别配置会被创建三次（解析http块一次、解析server块一次和解析loc块一次）。具体配置在内存中结构之后会详细解释。</p>
<p>在创建配置后，就会继续解析配置，此时，遇到的第一个http模块就是ngx_http_core_module。从上述代码可以看出来，nginx配置项解析采用的是深度优先搜索模式，其解析的顺序是十分重要的，一定要先解析核心模块，再解析每类模块在该模块下的代理（如http模块的代理为ngx_http_core_module），之后才能再解析该类模块下其他模块。</p>
<h4 id="http级配置解析内存结构"><a href="#http级配置解析内存结构" class="headerlink" title="http级配置解析内存结构"></a>http级配置解析内存结构</h4><p><a href="https://imgtu.com/i/RW0I2j" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/04/RW0I2j.png" alt="RW0I2j.png"></a></p>
<p><center>图10-1</center><br>ngx_http_core_module是第一个http模块，其ctx_index为0，因此，数组中第一个指针指向ngx_http_core_module生成的三个结构体。要由ngx_cycle_t获得main级别配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_http_get_module_main_conf(r, module)                             \</span><br><span class="line">    (r)-&gt;main_conf[module.ctx_index]</span><br></pre></td></tr></table></figure>
<h3 id="server级别set函数"><a href="#server级别set函数" class="headerlink" title="server级别set函数"></a>server级别set函数</h3><p>在http中，接着执行解析函数时，当解析到server配置时，首先会遇到ngx_http_core_module核心模块的commands中的server。如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"server"</span>),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span><br><span class="line">      ngx_http_core_server,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>其函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_core_server(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *dummy)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                        *rv;</span><br><span class="line">    <span class="keyword">void</span>                        *mconf;</span><br><span class="line">    <span class="keyword">size_t</span>                       len;</span><br><span class="line">    u_char                      *p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   i;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                   pcf;</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span>           *<span class="keyword">module</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>          *<span class="title">sin</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>         *ctx, *http_ctx;</span><br><span class="line">    <span class="keyword">ngx_http_listen_opt_t</span>        lsopt;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>    *cscf, **cscfp;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>   *cmcf;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里的ctx为http块解析时生成的ngx_http_conf_ctx_t，具体可看http的set代码。</span></span><br><span class="line">    http_ctx = cf-&gt;ctx;</span><br><span class="line">    <span class="comment">// 由于server块中不含main层级的配置项，因此其main_conf执行http层生成的main_conf即可</span></span><br><span class="line">    ctx-&gt;main_conf = http_ctx-&gt;main_conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the server&#123;&#125;'s srv_conf */</span></span><br><span class="line">    <span class="comment">// 创建server和location块的存储结构</span></span><br><span class="line">    ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;srv_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the server&#123;&#125;'s loc_conf */</span></span><br><span class="line"></span><br><span class="line">    ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_srv_conf) &#123;</span><br><span class="line">            mconf = <span class="keyword">module</span>-&gt;create_srv_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (mconf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctx-&gt;srv_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] = mconf;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_loc_conf) &#123;</span><br><span class="line">            mconf = <span class="keyword">module</span>-&gt;create_loc_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (mconf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctx-&gt;loc_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] = mconf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the server configuration context */</span></span><br><span class="line">    <span class="comment">// 使用server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t的ctx来存储server块生成的配置内存结构</span></span><br><span class="line">    cscf = ctx-&gt;srv_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    cscf-&gt;ctx = ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取main层ngx_http_core_module块生成的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// 将server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t添加到main层ngx_http_core_module块生成的ngx_http_core_main_conf_t的server中，使用该方式将main层的配置内存结构和server层配置内存结构串联起来。</span></span><br><span class="line">    cscfp = ngx_array_push(&amp;cmcf-&gt;servers);</span><br><span class="line">    <span class="keyword">if</span> (cscfp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *cscfp = cscf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* parse inside server&#123;&#125; */</span></span><br><span class="line">    <span class="comment">// 继续解析server块。</span></span><br><span class="line">    pcf = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    cf-&gt;cmd_type = NGX_HTTP_SRV_CONF;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line">    <span class="comment">// 如果正常解析，但并未设置监听，则使用默认监听（root 80， user 8000）。具体可以看下一部分的管理监听端口章节</span></span><br><span class="line">    <span class="keyword">if</span> (rv == NGX_CONF_OK &amp;&amp; !cscf-&gt;listen) &#123;</span><br><span class="line">        ngx_memzero(&amp;lsopt, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_listen_opt_t</span>));</span><br><span class="line"></span><br><span class="line">        p = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(struct sockaddr_in));</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lsopt.sockaddr = (struct sockaddr *) p;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sin</span> = (struct sockaddr_in *) p;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_family = AF_INET;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_port = htons(<span class="number">80</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_port = htons((getuid() == <span class="number">0</span>) ? <span class="number">80</span> : <span class="number">8000</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">        lsopt.socklen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line"></span><br><span class="line">        lsopt.backlog = NGX_LISTEN_BACKLOG;</span><br><span class="line">        lsopt.rcvbuf = <span class="number">-1</span>;</span><br><span class="line">        lsopt.sndbuf = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">        lsopt.setfib = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">        lsopt.fastopen = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        lsopt.wildcard = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        len = NGX_INET_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(cf-&gt;pool, len);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lsopt.addr_text.data = p;</span><br><span class="line">        lsopt.addr_text.len = ngx_sock_ntop(lsopt.sockaddr, lsopt.socklen, p,</span><br><span class="line">                                            len, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_add_listen(cf, cscf, &amp;lsopt) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="server级配置解析内存结构"><a href="#server级配置解析内存结构" class="headerlink" title="server级配置解析内存结构"></a>server级配置解析内存结构</h4><p><a href="https://imgtu.com/i/R5gtCn" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/05/R5gtCn.png" alt="R5gtCn.png"></a></p>
<p><center>图10-3</center><br>解析每一个server块时都会创建一个新的 ngx_http_conf_ctx_t结构体，其中的main_conf将指向http块下main_conf指针数组，而srv_conf和 loc_conf数组则都会重新分配，它们的内容就是所有HTTP模块的create_srv_conf方法、 create_loc_conf方法创建的结构体指针。</p>
<p>http层的存储结构和server层存储关联方式为：将server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t添加到main层ngx_http_core_module块生成的ngx_http_core_main_conf_t的server中，其中server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t中的ctx指向server层生成的ngx_http_conf_ctx_t结构体。使用该方式将main层的配置内存结构和server层配置内存结构串联起来。</p>
<h3 id="管理监听端口号"><a href="#管理监听端口号" class="headerlink" title="管理监听端口号"></a>管理监听端口号</h3><p>nginx配置，使用listen来设置监听端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen address:port [default(deprecated in 0.8.21) | default_server | [backlog=num | rcvbuf=size | sndbuf=size | accept_filter=filter | deferred | bind | ipv6only=[on|off] ssl | so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]]];</span><br><span class="line"></span><br><span class="line">#default </span><br><span class="line">listion 80;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>listen决定nginx服务监听端口。listen后可以加IP地址、端口号或者主机名。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen 127.0.0.1:8002;</span><br><span class="line">listen 127.0.0.1; //default port 80</span><br><span class="line">listen *:8000;</span><br></pre></td></tr></table></figure>
<p>地址后可以加其他参数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>将所在server块作为整个web服务的默认server块。当一个请求无法匹配配置文件中的所有主机域名时，就会选择默认虚拟主机。如果所有server都未指定，则默认选第一个。</td>
</tr>
<tr>
<td>backlog=num</td>
<td>TCP中backlog大小。（默认-1，无限制）在TCP建立三次连接时，进程还未监听句柄，此时backlog队列将会放置这些连接。如果backlog已满，还有客户端企图建立连接，则会失败。</td>
</tr>
<tr>
<td>rcvbuf=size</td>
<td>设置监听句柄的SO_RCVBUF参数。</td>
</tr>
<tr>
<td>sndbuf=size</td>
<td>设置监听句柄的SO_SNDBUF参数。</td>
</tr>
<tr>
<td>accept_filter</td>
<td>设置accept过滤，只对FreeBSD系统有用。</td>
</tr>
<tr>
<td>deferred</td>
<td>设置该参数时，若用户建立了TCP连接（三次握手），内核也不会对该连接调度worker进程来处理，只会在用户真正发送请求时才会分配worker进程。使用于大并发情况下。</td>
</tr>
<tr>
<td>bind</td>
<td>绑定当前端口/地址对，如127.0.0.1:8000。</td>
</tr>
<tr>
<td>ssl</td>
<td>在当前监听的端口上建立的连接必须基于SSL。</td>
</tr>
<tr>
<td>so_keepalive</td>
<td>当客户端与服务器端三次握手正式建立tcp以后，默认情况下，除非客户端或服务器端关闭上层socket，否则tcp会始终保持连接，如果这个时候网络断掉，这个链接就会变成一个死链接，会占用服务器资源。解决方式为：大多数的上游应用会通过心跳机制来检测对方是否存活，不存会则由上游应用程序关闭socket释放链接。对于tcp探活来说，存在三个参数：tcp_keepalive_time（tcp建立链接后指定时间无数据传输，则会发出探活数据包）、tcp_keepalive_probes（发出探活数据包次数）、tcp_keepalive_intvl（探活数据包之间间隔时间）so_keepalive<code>=</code>on 表示开启tcp探活，并且使用系统内核的参数。so_keepalive=30m::10 表示开启tcp探活，30分钟后伍数据会发送探活包，时间间隔使用系统默认的，发送10次探活包。</td>
</tr>
<tr>
<td>fastopen</td>
<td>number，HTTP 处于保持连接（keepalive）状态时，允许不经过三次握手的 TCP 连接的队列的最大数</td>
</tr>
<tr>
<td>sentfib</td>
<td>number，为监听套接字设置关联路由表，仅在 FreeBSD 系统上有效</td>
</tr>
<tr>
<td>ipv6only</td>
<td>on，只接收 IPv6 连接或接收 IPv6 和 IPv4 连接</td>
</tr>
<tr>
<td>reuseport</td>
<td>默认情况下，所有的工作进程会共享一个 socket 去监听同一 IP 和端口的组合。该参数启用后，允许每个工作进程有独立的 socket 去监听同一 IP 和端口的组合，内核会对传人的连接进行负载均衡。</td>
</tr>
<tr>
<td>proxy_protocol</td>
<td>在指定监听端口上启用 proxy_protocol 协议支持</td>
</tr>
</tbody>
</table>
</div>
<p>解析时，其属于ngx_http_core_commands，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"listen"</span>),</span><br><span class="line">  NGX_HTTP_SRV_CONF|NGX_CONF_1MORE,</span><br><span class="line">  ngx_http_core_listen,</span><br><span class="line">  NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="对应相关数据结构"><a href="#对应相关数据结构" class="headerlink" title="对应相关数据结构"></a>对应相关数据结构</h4><h5 id="ngx-http-listen-opt-t"><a href="#ngx-http-listen-opt-t" class="headerlink" title="ngx_http_listen_opt_t"></a>ngx_http_listen_opt_t</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    struct sockaddr           *sockaddr; // 套接字地址</span><br><span class="line">    socklen_t                  socklen; // 套接字地址长度</span><br><span class="line">    ngx_str_t                  addr_text; // 配置中监听文本</span><br><span class="line"></span><br><span class="line">    unsigned                   set:1; // 用户是否进行了相关设置</span><br><span class="line">    unsigned                   default_server:1; // 是否为默认使用的server</span><br><span class="line">    unsigned                   bind:1; </span><br><span class="line">    unsigned                   wildcard:1; // 是否为通配符形式监听地址</span><br><span class="line">    unsigned                   ssl:1;</span><br><span class="line">    unsigned                   http2:1;</span><br><span class="line">#if (NGX_HAVE_INET6)</span><br><span class="line">    unsigned                   ipv6only:1;</span><br><span class="line">#endif</span><br><span class="line">    unsigned                   deferred_accept:1;</span><br><span class="line">    unsigned                   reuseport:1;</span><br><span class="line">    unsigned                   so_keepalive:2;</span><br><span class="line">    unsigned                   proxy_protocol:1;</span><br><span class="line"></span><br><span class="line">    int                        backlog; // 对应配置backlog</span><br><span class="line">    int                        rcvbuf; // 对应配置rcvbuf</span><br><span class="line">    int                        sndbuf;// 对应配置sndbuf</span><br><span class="line">#if (NGX_HAVE_SETFIB)</span><br><span class="line">    int                        setfib;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_TCP_FASTOPEN)</span><br><span class="line">    int                        fastopen;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_KEEPALIVE_TUNABLE)</span><br><span class="line">    int                        tcp_keepidle; // 建立链接后无数据传输超出该时间，进行数据探活</span><br><span class="line">    int                        tcp_keepintvl; // 探活包之间时间间隔</span><br><span class="line">    int                        tcp_keepcnt; // 探活次数</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">    char                      *accept_filter;</span><br><span class="line">#endif</span><br><span class="line">&#125; ngx_http_listen_opt_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-url-t"><a href="#ngx-url-t" class="headerlink" title="ngx_url_t"></a>ngx_url_t</h5><p>该结构是用于存储解析url后的结果信息的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_str_t                 url; // url</span><br><span class="line">    ngx_str_t                 host; // 主机名</span><br><span class="line">    ngx_str_t                 port_text; // 端口号对应文本</span><br><span class="line">    ngx_str_t                 uri; // uri</span><br><span class="line"></span><br><span class="line">    in_port_t                 port; // 端口号</span><br><span class="line">    in_port_t                 default_port; // 默认端口号</span><br><span class="line">    in_port_t                 last_port; // 当端口号是一个区间时，最后一个端口号</span><br><span class="line">    int                       family; // 协议族</span><br><span class="line"></span><br><span class="line">    unsigned                  listen:1; // 是否为监听</span><br><span class="line">    unsigned                  uri_part:1;</span><br><span class="line">    unsigned                  no_resolve:1; // 是否不解析主机（url中不一定是ip形式请求，可能是主机，如localhost）</span><br><span class="line"></span><br><span class="line">    unsigned                  no_port:1; // 是否用户未指名端口号</span><br><span class="line">    unsigned                  wildcard:1; // 是否监听地址为通配符形式</span><br><span class="line"></span><br><span class="line">    socklen_t                 socklen; // 套接字地址长度</span><br><span class="line">    ngx_sockaddr_t            sockaddr; // 套接字地址结构，其是临时变量，会将每一个sockaddr添加到addrs中</span><br><span class="line"></span><br><span class="line">    ngx_addr_t               *addrs; // 对应的监听地址</span><br><span class="line">    ngx_uint_t                naddrs; // 对应的监听地址数量</span><br><span class="line"></span><br><span class="line">    char                     *err; // 存储解析后错误信息</span><br><span class="line">&#125; ngx_url_t;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">    struct sockaddr          *sockaddr;</span><br><span class="line">    socklen_t                 socklen;</span><br><span class="line">    ngx_str_t                 name;</span><br><span class="line">&#125; ngx_addr_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-conf-port-t"><a href="#ngx-http-conf-port-t" class="headerlink" title="ngx_http_conf_port_t"></a>ngx_http_conf_port_t</h5><p>该类是记录端口号对应每一个地址的结构。（由于一个机器可能存在多个ip地址）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_int_t                  family;</span><br><span class="line">    in_port_t                  port;</span><br><span class="line">    ngx_array_t                addrs;     /* array of ngx_http_conf_addr_t */</span><br><span class="line">&#125; ngx_http_conf_port_t;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_core_main_conf_t中的ports参数的成员即是ngx_http_conf_port_t。</p>
<h5 id="ngx-http-conf-addr-t"><a href="#ngx-http-conf-addr-t" class="headerlink" title="ngx_http_conf_addr_t"></a>ngx_http_conf_addr_t</h5><p>由于一个端口，我们可以同时监听多个ip（一个机器可能存在多个ip地址）。nginx使用ngx_http_conf_addr_t结构来表示一个对应着具体地址的监听端口，因此一个ngx_http_conf_port_t可能对应多个ngx_http_conf_addr_t。具体结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 监听套接字对应的各种属性</span><br><span class="line">    ngx_http_listen_opt_t      opt;</span><br><span class="line">    // 下面三个散列表用于加速寻找对应监听端口上的新连接，确定到达使用哪个server&#123;&#125;虚拟主机下的配置来进行处理，散列表的值是ngx_http_core_srv_conf_t结构体</span><br><span class="line">    ngx_hash_t                 hash;</span><br><span class="line">    ngx_hash_wildcard_t       *wc_head; // 通配符前缀散列表</span><br><span class="line">    ngx_hash_wildcard_t       *wc_tail; // 通配符后置散列表</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_uint_t                 nregex; // regex数量</span><br><span class="line">    ngx_http_server_name_t    *regex; // 正则表达式匹配的虚拟主机</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    /* the default server configuration for this address:port */</span><br><span class="line">    ngx_http_core_srv_conf_t  *default_server; // 监听端口下默认的虚拟主机</span><br><span class="line">    ngx_array_t                servers;  /* array of ngx_http_core_srv_conf_t */</span><br><span class="line">&#125; ngx_http_conf_addr_t;</span><br></pre></td></tr></table></figure>
<h4 id="监听端口与server-虚拟主机间内存关系"><a href="#监听端口与server-虚拟主机间内存关系" class="headerlink" title="监听端口与server{}虚拟主机间内存关系"></a>监听端口与server{}虚拟主机间内存关系</h4><p>对于一个如下的配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> A;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">127</span>.<span class="number">0</span>,<span class="number">0</span>.<span class="number">1</span>:<span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">location</span> /L1 &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> B;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">173.39.160.51:8000</span>;</span><br><span class="line">    <span class="attribute">location</span> /L1&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://imgtu.com/i/fGIoYn" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/08/10/fGIoYn.png" alt="fGIoYn.png"></a></p>
<h4 id="set方法"><a href="#set方法" class="headerlink" title="set方法"></a>set方法</h4><h5 id="ngx-http-core-listen"><a href="#ngx-http-core-listen" class="headerlink" title="ngx_http_core_listen"></a>ngx_http_core_listen</h5><p>其中对应的ngx_http_core_listen方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line">static char *</span><br><span class="line">ngx_http_core_listen(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)</span><br><span class="line">&#123;</span><br><span class="line">    // server层级下的ngx_http_core_srv_conf_t</span><br><span class="line">    ngx_http_core_srv_conf_t *cscf = conf;</span><br><span class="line"></span><br><span class="line">    ngx_str_t              *value, size;</span><br><span class="line">    ngx_url_t               u;</span><br><span class="line">    ngx_uint_t              n;</span><br><span class="line">    ngx_http_listen_opt_t   lsopt;</span><br><span class="line"></span><br><span class="line">    cscf-&gt;listen = 1;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;u, sizeof(ngx_url_t));</span><br><span class="line">    // 对listen后的字符串进行解析，标识为监听，并设置默认端口</span><br><span class="line">    u.url = value[1];</span><br><span class="line">    u.listen = 1;</span><br><span class="line">    u.default_port = 80;</span><br><span class="line">    // 解析参数，解析完成后，u的addrs就存储这ip+port的地址对</span><br><span class="line">    if (ngx_parse_url(cf-&gt;pool, &amp;u) != NGX_OK) &#123;</span><br><span class="line">        if (u.err) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;%s in \&quot;%V\&quot; of the \&quot;listen\&quot; directive&quot;,</span><br><span class="line">                               u.err, &amp;u.url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析其余参数，先分配存储结构，并设置默认值</span><br><span class="line">    ngx_memzero(&amp;lsopt, sizeof(ngx_http_listen_opt_t));</span><br><span class="line"></span><br><span class="line">    lsopt.backlog = NGX_LISTEN_BACKLOG;</span><br><span class="line">    lsopt.rcvbuf = -1;</span><br><span class="line">    lsopt.sndbuf = -1;</span><br><span class="line">#if (NGX_HAVE_SETFIB)</span><br><span class="line">    lsopt.setfib = -1;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_TCP_FASTOPEN)</span><br><span class="line">    lsopt.fastopen = -1;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_INET6)</span><br><span class="line">    lsopt.ipv6only = 1;</span><br><span class="line">#endif</span><br><span class="line">    // 从第二个参数开始进行解析</span><br><span class="line">    for (n = 2; n &lt; cf-&gt;args-&gt;nelts; n++) &#123;</span><br><span class="line">        // 设置了default_server，则将default_server置1</span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;default_server&quot;) == 0</span><br><span class="line">            || ngx_strcmp(value[n].data, &quot;default&quot;) == 0)</span><br><span class="line">        &#123;</span><br><span class="line">            lsopt.default_server = 1;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;bind&quot;) == 0) &#123;</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_SETFIB)</span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;setfib=&quot;, 7) == 0) &#123;</span><br><span class="line">            lsopt.setfib = ngx_atoi(value[n].data + 7, value[n].len - 7);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.setfib == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid setfib \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_TCP_FASTOPEN)</span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;fastopen=&quot;, 9) == 0) &#123;</span><br><span class="line">            lsopt.fastopen = ngx_atoi(value[n].data + 9, value[n].len - 9);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.fastopen == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid fastopen \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;backlog=&quot;, 8) == 0) &#123;</span><br><span class="line">            lsopt.backlog = ngx_atoi(value[n].data + 8, value[n].len - 8);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.backlog == NGX_ERROR || lsopt.backlog == 0) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid backlog \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;rcvbuf=&quot;, 7) == 0) &#123;</span><br><span class="line">            size.len = value[n].len - 7;</span><br><span class="line">            size.data = value[n].data + 7;</span><br><span class="line"></span><br><span class="line">            lsopt.rcvbuf = ngx_parse_size(&amp;size);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.rcvbuf == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid rcvbuf \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;sndbuf=&quot;, 7) == 0) &#123;</span><br><span class="line">            size.len = value[n].len - 7;</span><br><span class="line">            size.data = value[n].data + 7;</span><br><span class="line"></span><br><span class="line">            lsopt.sndbuf = ngx_parse_size(&amp;size);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.sndbuf == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid sndbuf \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;accept_filter=&quot;, 14) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">            lsopt.accept_filter = (char *) &amp;value[n].data[14];</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;accept filters \&quot;%V\&quot; are not supported &quot;</span><br><span class="line">                               &quot;on this platform, ignored&quot;,</span><br><span class="line">                               &amp;value[n]);</span><br><span class="line">#endif</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;deferred&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line">            lsopt.deferred_accept = 1;</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;the deferred accept is not supported &quot;</span><br><span class="line">                               &quot;on this platform, ignored&quot;);</span><br><span class="line">#endif</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;ipv6only=o&quot;, 10) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_INET6 &amp;&amp; defined IPV6_V6ONLY)</span><br><span class="line">            if (ngx_strcmp(&amp;value[n].data[10], &quot;n&quot;) == 0) &#123;</span><br><span class="line">                lsopt.ipv6only = 1;</span><br><span class="line"></span><br><span class="line">            &#125; else if (ngx_strcmp(&amp;value[n].data[10], &quot;ff&quot;) == 0) &#123;</span><br><span class="line">                lsopt.ipv6only = 0;</span><br><span class="line"></span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid ipv6only flags \&quot;%s\&quot;&quot;,</span><br><span class="line">                                   &amp;value[n].data[9]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;ipv6only is not supported &quot;</span><br><span class="line">                               &quot;on this platform&quot;);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;reuseport&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_REUSEPORT)</span><br><span class="line">            lsopt.reuseport = 1;</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;reuseport is not supported &quot;</span><br><span class="line">                               &quot;on this platform, ignored&quot;);</span><br><span class="line">#endif</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;ssl&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HTTP_SSL)</span><br><span class="line">            lsopt.ssl = 1;</span><br><span class="line">            continue;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;the \&quot;ssl\&quot; parameter requires &quot;</span><br><span class="line">                               &quot;ngx_http_ssl_module&quot;);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;http2&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HTTP_V2)</span><br><span class="line">            lsopt.http2 = 1;</span><br><span class="line">            continue;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;the \&quot;http2\&quot; parameter requires &quot;</span><br><span class="line">                               &quot;ngx_http_v2_module&quot;);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;spdy&quot;) == 0) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_WARN, cf, 0,</span><br><span class="line">                               &quot;invalid parameter \&quot;spdy\&quot;: &quot;</span><br><span class="line">                               &quot;ngx_http_spdy_module was superseded &quot;</span><br><span class="line">                               &quot;by ngx_http_v2_module&quot;);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;so_keepalive=&quot;, 13) == 0) &#123;</span><br><span class="line"></span><br><span class="line">            if (ngx_strcmp(&amp;value[n].data[13], &quot;on&quot;) == 0) &#123;</span><br><span class="line">                lsopt.so_keepalive = 1;</span><br><span class="line"></span><br><span class="line">            &#125; else if (ngx_strcmp(&amp;value[n].data[13], &quot;off&quot;) == 0) &#123;</span><br><span class="line">                lsopt.so_keepalive = 2;</span><br><span class="line"></span><br><span class="line">            &#125; else &#123;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_KEEPALIVE_TUNABLE)</span><br><span class="line">                u_char     *p, *end;</span><br><span class="line">                ngx_str_t   s;</span><br><span class="line"></span><br><span class="line">                end = value[n].data + value[n].len;</span><br><span class="line">                s.data = value[n].data + 13;</span><br><span class="line"></span><br><span class="line">                p = ngx_strlchr(s.data, end, &apos;:&apos;);</span><br><span class="line">                if (p == NULL) &#123;</span><br><span class="line">                    p = end;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (p &gt; s.data) &#123;</span><br><span class="line">                    s.len = p - s.data;</span><br><span class="line"></span><br><span class="line">                    lsopt.tcp_keepidle = ngx_parse_time(&amp;s, 1);</span><br><span class="line">                    if (lsopt.tcp_keepidle == (time_t) NGX_ERROR) &#123;</span><br><span class="line">                        goto invalid_so_keepalive;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                s.data = (p &lt; end) ? (p + 1) : end;</span><br><span class="line"></span><br><span class="line">                p = ngx_strlchr(s.data, end, &apos;:&apos;);</span><br><span class="line">                if (p == NULL) &#123;</span><br><span class="line">                    p = end;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (p &gt; s.data) &#123;</span><br><span class="line">                    s.len = p - s.data;</span><br><span class="line"></span><br><span class="line">                    lsopt.tcp_keepintvl = ngx_parse_time(&amp;s, 1);</span><br><span class="line">                    if (lsopt.tcp_keepintvl == (time_t) NGX_ERROR) &#123;</span><br><span class="line">                        goto invalid_so_keepalive;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                s.data = (p &lt; end) ? (p + 1) : end;</span><br><span class="line"></span><br><span class="line">                if (s.data &lt; end) &#123;</span><br><span class="line">                    s.len = end - s.data;</span><br><span class="line"></span><br><span class="line">                    lsopt.tcp_keepcnt = ngx_atoi(s.data, s.len);</span><br><span class="line">                    if (lsopt.tcp_keepcnt == NGX_ERROR) &#123;</span><br><span class="line">                        goto invalid_so_keepalive;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (lsopt.tcp_keepidle == 0 &amp;&amp; lsopt.tcp_keepintvl == 0</span><br><span class="line">                    &amp;&amp; lsopt.tcp_keepcnt == 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    goto invalid_so_keepalive;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                lsopt.so_keepalive = 1;</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;the \&quot;so_keepalive\&quot; parameter accepts &quot;</span><br><span class="line">                                   &quot;only \&quot;on\&quot; or \&quot;off\&quot; on this platform&quot;);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_KEEPALIVE_TUNABLE)</span><br><span class="line">        invalid_so_keepalive:</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;invalid so_keepalive value: \&quot;%s\&quot;&quot;,</span><br><span class="line">                               &amp;value[n].data[13]);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;proxy_protocol&quot;) == 0) &#123;</span><br><span class="line">            lsopt.proxy_protocol = 1;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                           &quot;invalid parameter \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">        return NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 对每一个解析出的地址，和配置的属性，使用ngx_http_add_listen方法添加ip+port形式的地址到main层级的ngx_http_core_main_conf_t的ports中</span><br><span class="line">    for (n = 0; n &lt; u.naddrs; n++) &#123;</span><br><span class="line">        lsopt.sockaddr = u.addrs[n].sockaddr;</span><br><span class="line">        lsopt.socklen = u.addrs[n].socklen;</span><br><span class="line">        lsopt.addr_text = u.addrs[n].name;</span><br><span class="line">        lsopt.wildcard = ngx_inet_wildcard(lsopt.sockaddr);</span><br><span class="line"></span><br><span class="line">        if (ngx_http_add_listen(cf, cscf, &amp;lsopt) != NGX_OK) &#123;</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要着重介绍一下bind标志位。bind表示是否一个ip+port的地址进行绑定。这样的目的是，如果在一个在同样的端口上，存在一个通配符形式地址（即任意ip地址）时。对于bind的地址来说，会先开启一个地址的监听，让bind的端口走单独的监听，其他未绑定的地址走通配符监听。这样主要是因为我们可能希望在该bind的地址上设置一些额外信息，如backlog、rcvbuf、sndbuf等内容。因此在设置这些额外参数时，就会默认将该地址设置为bind。当然也可以通过配置中直接设置bind的方式指明需要单独进行监听。</p>
<h5 id="解析url"><a href="#解析url" class="headerlink" title="解析url"></a>解析url</h5><h6 id="ngx-parse-url"><a href="#ngx-parse-url" class="headerlink" title="ngx_parse_url"></a>ngx_parse_url</h6><p>解析参数的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ngx_int_t</span><br><span class="line">ngx_parse_url(ngx_pool_t *pool, ngx_url_t *u)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  *p;</span><br><span class="line">    size_t   len;</span><br><span class="line"></span><br><span class="line">    p = u-&gt;url.data;</span><br><span class="line">    len = u-&gt;url.len;</span><br><span class="line"></span><br><span class="line">    if (len &gt;= 5 &amp;&amp; ngx_strncasecmp(p, (u_char *) &quot;unix:&quot;, 5) == 0) &#123;</span><br><span class="line">        return ngx_parse_unix_domain_url(pool, u);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (len &amp;&amp; p[0] == &apos;[&apos;) &#123;</span><br><span class="line">        return ngx_parse_inet6_url(pool, u);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ngx_parse_inet_url(pool, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用的是ngx_parse_inet_url函数。具体逻辑如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">static ngx_int_t</span><br><span class="line">ngx_parse_inet_url(ngx_pool_t *pool, ngx_url_t *u)</span><br><span class="line">&#123;</span><br><span class="line">    u_char              *host, *port, *last, *uri, *args, *dash;</span><br><span class="line">    size_t               len;</span><br><span class="line">    ngx_int_t            n;</span><br><span class="line">    struct sockaddr_in  *sin;</span><br><span class="line">    // 分配套接字地址</span><br><span class="line">    u-&gt;socklen = sizeof(struct sockaddr_in);</span><br><span class="line">    sin = (struct sockaddr_in *) &amp;u-&gt;sockaddr;</span><br><span class="line">    // 设置套接字族</span><br><span class="line">    sin-&gt;sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">    u-&gt;family = AF_INET;</span><br><span class="line"></span><br><span class="line">    host = u-&gt;url.data;</span><br><span class="line"></span><br><span class="line">    last = host + u-&gt;url.len;</span><br><span class="line">    // 查找设置的端口号起始地址。ngx_strlchr函数找到第一个指定的字符，并返回对应的指针。这里查找到:8000这种端口号</span><br><span class="line">    port = ngx_strlchr(host, last, &apos;:&apos;);</span><br><span class="line">    // 查找到uri起始地址</span><br><span class="line">    uri = ngx_strlchr(host, last, &apos;/&apos;);</span><br><span class="line">    // 查找参数的起始地址</span><br><span class="line">    args = ngx_strlchr(host, last, &apos;?&apos;);</span><br><span class="line">    // 如果存在参数，并且uri为空，或者参数的起始地址小于uri的起始地址，则将uri设置为参数的起始地址</span><br><span class="line">    if (args) &#123;</span><br><span class="line">        if (uri == NULL || args &lt; uri) &#123;</span><br><span class="line">            uri = args;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 存在uri</span><br><span class="line">    if (uri) &#123;</span><br><span class="line">        // 如果是在解析监听，则报错返回</span><br><span class="line">        if (u-&gt;listen || !u-&gt;uri_part) &#123;</span><br><span class="line">            u-&gt;err = &quot;invalid host&quot;;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        // uri长度为从末尾到uri起始地址</span><br><span class="line">        u-&gt;uri.len = last - uri;</span><br><span class="line">        u-&gt;uri.data = uri;</span><br><span class="line">        // 将last变更为uri地址</span><br><span class="line">        last = uri;</span><br><span class="line">        // 如果uri起始地址小于端口号起始地址，则说明不存在端口号</span><br><span class="line">        if (uri &lt; port) &#123;</span><br><span class="line">            port = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果查找到:80形式的端口号</span><br><span class="line">    if (port) &#123;</span><br><span class="line">        // 获取端口号起始地址</span><br><span class="line">        port++;</span><br><span class="line">        // 获取端口号长度</span><br><span class="line">        len = last - port;</span><br><span class="line">        // 如果在解析监听</span><br><span class="line">        if (u-&gt;listen) &#123;</span><br><span class="line">            // 查找监听端口是否为一个范围，即:8000-8100形式</span><br><span class="line">            dash = ngx_strlchr(port, last, &apos;-&apos;);</span><br><span class="line">            // 如果是范围</span><br><span class="line">            if (dash) &#123;</span><br><span class="line">                dash++;</span><br><span class="line">                // 解析末尾端口</span><br><span class="line">                n = ngx_atoi(dash, last - dash);</span><br><span class="line"></span><br><span class="line">                if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">                    u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line">                    return NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                u-&gt;last_port = (in_port_t) n;</span><br><span class="line">                // 变更长度为起始端口长度</span><br><span class="line">                len = dash - port - 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取端口（如果是监听，则是起始端口）</span><br><span class="line">        n = ngx_atoi(port, len);</span><br><span class="line"></span><br><span class="line">        if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">            u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        // 如果范围不合法，报错</span><br><span class="line">        if (u-&gt;last_port &amp;&amp; n &gt; u-&gt;last_port) &#123;</span><br><span class="line">            u-&gt;err = &quot;invalid port range&quot;;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        // 设置端口为n</span><br><span class="line">        u-&gt;port = (in_port_t) n;</span><br><span class="line">        sin-&gt;sin_port = htons((in_port_t) n);</span><br><span class="line">        // 设置端口对应的文本</span><br><span class="line">        u-&gt;port_text.len = last - port;</span><br><span class="line">        u-&gt;port_text.data = port;</span><br><span class="line"></span><br><span class="line">        last = port - 1;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //未解析到:8000形式端口</span><br><span class="line">        // 如果uri为空</span><br><span class="line">        if (uri == NULL) &#123;</span><br><span class="line">            // 如果是在解析监听</span><br><span class="line">            if (u-&gt;listen) &#123;</span><br><span class="line"></span><br><span class="line">                /* test value as port only */</span><br><span class="line">                // 认为整个文本全是端口，即listen 80；形式，并尝试解析</span><br><span class="line">                len = last - host;</span><br><span class="line">                // 查看是否为范围监听</span><br><span class="line">                dash = ngx_strlchr(host, last, &apos;-&apos;);</span><br><span class="line"></span><br><span class="line">                if (dash) &#123;</span><br><span class="line">                    dash++;</span><br><span class="line"></span><br><span class="line">                    n = ngx_atoi(dash, last - dash);</span><br><span class="line"></span><br><span class="line">                    if (n == NGX_ERROR) &#123;</span><br><span class="line">                        goto no_port;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">                        u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line"></span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        u-&gt;last_port = (in_port_t) n;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    len = dash - host - 1;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                n = ngx_atoi(host, len);</span><br><span class="line">                // 如果解析到端口</span><br><span class="line">                if (n != NGX_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">                    if (u-&gt;err) &#123;</span><br><span class="line">                        return NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">                        u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line">                        return NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (u-&gt;last_port &amp;&amp; n &gt; u-&gt;last_port) &#123;</span><br><span class="line">                        u-&gt;err = &quot;invalid port range&quot;;</span><br><span class="line">                        return NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    u-&gt;port = (in_port_t) n;</span><br><span class="line">                    sin-&gt;sin_port = htons((in_port_t) n);</span><br><span class="line">                    sin-&gt;sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">                    u-&gt;port_text.len = last - host;</span><br><span class="line">                    u-&gt;port_text.data = host;</span><br><span class="line">                    // 由于是listen未指定ip，因此机器所有ip均被监听，因此属于通配符形式监听</span><br><span class="line">                    u-&gt;wildcard = 1;</span><br><span class="line">                    // 添加监听端口到addrs中</span><br><span class="line">                    return ngx_inet_add_addr(pool, u, &amp;u-&gt;sockaddr.sockaddr,</span><br><span class="line">                                             u-&gt;socklen, 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">no_port:</span><br><span class="line">        // 未查找到端口号，即只有ip的情况，设置默认端口</span><br><span class="line">        u-&gt;err = NULL;</span><br><span class="line">        u-&gt;no_port = 1;</span><br><span class="line">        u-&gt;port = u-&gt;default_port;</span><br><span class="line">        sin-&gt;sin_port = htons(u-&gt;default_port);</span><br><span class="line">        u-&gt;last_port = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    // 只有主机名，或主机名+端口号形式的配置，才会执行如下处理</span><br><span class="line">    len = last - host;</span><br><span class="line">    // 如果没有主机，则报错</span><br><span class="line">    if (len == 0) &#123;</span><br><span class="line">        u-&gt;err = &quot;no host&quot;;</span><br><span class="line">        return NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;host.len = len;</span><br><span class="line">    u-&gt;host.data = host;</span><br><span class="line">    // 如果是解析监听，并且主机名是*，设置sin_addr.s_addr为INADDR_ANY，即监听所有ip，并设置wildcard为1</span><br><span class="line">    if (u-&gt;listen &amp;&amp; len == 1 &amp;&amp; *host == &apos;*&apos;) &#123;</span><br><span class="line">        sin-&gt;sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">        u-&gt;wildcard = 1;</span><br><span class="line">        return ngx_inet_add_addr(pool, u, &amp;u-&gt;sockaddr.sockaddr, u-&gt;socklen, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取主机ip，将127.0.0.1转换为int形式的地址</span><br><span class="line">    sin-&gt;sin_addr.s_addr = ngx_inet_addr(host, len);</span><br><span class="line">    // ip合法（如果主机名是域名，则返回就是INADDR_NONE）</span><br><span class="line">    if (sin-&gt;sin_addr.s_addr != INADDR_NONE) &#123;</span><br><span class="line">        // ip是INADDR_ANY，设置wildcard</span><br><span class="line">        if (sin-&gt;sin_addr.s_addr == INADDR_ANY) &#123;</span><br><span class="line">            u-&gt;wildcard = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // 添加地址到addrs</span><br><span class="line">        return ngx_inet_add_addr(pool, u, &amp;u-&gt;sockaddr.sockaddr, u-&gt;socklen, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果不解析主机名</span><br><span class="line">    if (u-&gt;no_resolve) &#123;</span><br><span class="line">        return NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    // 使用getaddrinfo函数解析域名，获取ip，并添加地址到u的addrs中</span><br><span class="line">    if (ngx_inet_resolve_host(pool, u) != NGX_OK) &#123;</span><br><span class="line">        return NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 根据域名解析出的地址，对u的相关参数进行赋值</span><br><span class="line">    u-&gt;family = u-&gt;addrs[0].sockaddr-&gt;sa_family;</span><br><span class="line">    u-&gt;socklen = u-&gt;addrs[0].socklen;</span><br><span class="line">    ngx_memcpy(&amp;u-&gt;sockaddr, u-&gt;addrs[0].sockaddr, u-&gt;addrs[0].socklen);</span><br><span class="line">    u-&gt;wildcard = ngx_inet_wildcard(&amp;u-&gt;sockaddr.sockaddr);</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-inet-add-addr"><a href="#ngx-inet-add-addr" class="headerlink" title="ngx_inet_add_addr"></a>ngx_inet_add_addr</h6><p>该方法用于将ngx_url_t解析出的地址添加到其addrs参数中。具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_inet_add_addr(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_url_t</span> *u, struct sockaddr *sockaddr,</span><br><span class="line">    <span class="keyword">socklen_t</span> socklen, <span class="keyword">ngx_uint_t</span> total)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *p;</span><br><span class="line">    <span class="keyword">size_t</span>            len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, nports;</span><br><span class="line">    <span class="keyword">ngx_addr_t</span>       *addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>  *<span class="title">sa</span>;</span></span><br><span class="line">    <span class="comment">// 如果是范围监听，则会有last_port</span></span><br><span class="line">    nports = u-&gt;last_port ? u-&gt;last_port - u-&gt;port + <span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 初始化addrs</span></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;addrs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        u-&gt;addrs = ngx_palloc(pool, total * nports * <span class="keyword">sizeof</span>(<span class="keyword">ngx_addr_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;addrs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对每一个监听端口进行处理</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nports; i++) &#123;</span><br><span class="line">        <span class="comment">// 初始化地址，并对地址中参数进行赋值</span></span><br><span class="line">        sa = ngx_pcalloc(pool, socklen);</span><br><span class="line">        <span class="keyword">if</span> (sa == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(sa, sockaddr, socklen);</span><br><span class="line"></span><br><span class="line">        ngx_inet_set_port(sa, u-&gt;port + i);</span><br><span class="line">        <span class="comment">// 根据不同协议族对地址赋值</span></span><br><span class="line">        <span class="keyword">switch</span> (sa-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            len = NGX_INET6_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">"[]:65536"</span>) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            len = NGX_INET_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(pool, len);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = ngx_sock_ntop(sa, socklen, p, len, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 添加地址到addrs中</span></span><br><span class="line">        addr = &amp;u-&gt;addrs[u-&gt;naddrs++];</span><br><span class="line"></span><br><span class="line">        addr-&gt;sockaddr = sa;</span><br><span class="line">        addr-&gt;socklen = socklen;</span><br><span class="line"></span><br><span class="line">        addr-&gt;name.len = len;</span><br><span class="line">        addr-&gt;name.data = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-inet-resolve-host"><a href="#ngx-inet-resolve-host" class="headerlink" title="ngx_inet_resolve_host"></a>ngx_inet_resolve_host</h6><p>该方法将域名解析为ip地址。使用的方法为getaddrinfo函数。具体可以参考<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%9C%B0%E5%9D%80%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener">地址查询</a></p>
<p>代码逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_inet_resolve_host(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_url_t</span> *u)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *host;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        n;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span>   <span class="title">hints</span>, *<span class="title">res</span>, *<span class="title">rp</span>;</span></span><br><span class="line"></span><br><span class="line">    host = ngx_alloc(u-&gt;host.len + <span class="number">1</span>, pool-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (host == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_cpystrn(host, u-&gt;host.data, u-&gt;host.len + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// hint来选择符合特定条件的地址</span></span><br><span class="line">    ngx_memzero(&amp;hints, <span class="keyword">sizeof</span>(struct addrinfo));</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> AI_ADDRCONFIG</span></span><br><span class="line">    hints.ai_flags = AI_ADDRCONFIG;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getaddrinfo((<span class="keyword">char</span> *) host, <span class="literal">NULL</span>, &amp;hints, &amp;res) != <span class="number">0</span>) &#123;</span><br><span class="line">        u-&gt;err = <span class="string">"host not found"</span>;</span><br><span class="line">        ngx_free(host);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_free(host);</span><br><span class="line">    <span class="comment">// 遍历获取到的每一个地址，查找ipv4或ipv6的地址数量</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>, rp = res; rp != <span class="literal">NULL</span>; rp = rp-&gt;ai_next) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (rp-&gt;ai_family) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AF_INET:</span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        u-&gt;err = <span class="string">"host not found"</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* MP: ngx_shared_palloc() */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (rp = res; rp != <span class="literal">NULL</span>; rp = rp-&gt;ai_next) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (rp-&gt;ai_family) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AF_INET:</span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将每一个ipv4或ipv6地址都添加到addrs中</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_inet_add_addr(pool, u, rp-&gt;ai_addr, rp-&gt;ai_addrlen, n)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里配置的主机可以任意配置，在设置监听时，如果解析出的ip地址不是机器表示的ip，则报错。</p>
<h5 id="添加监听地址到ports中"><a href="#添加监听地址到ports中" class="headerlink" title="添加监听地址到ports中"></a>添加监听地址到ports中</h5><h6 id="ngx-http-add-listen"><a href="#ngx-http-add-listen" class="headerlink" title="ngx_http_add_listen"></a>ngx_http_add_listen</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_listen(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_listen_opt_t</span> *lsopt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">in_port_t</span>                   p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>            *<span class="title">sa</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span>       *port;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取main级别下的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 创建ports空间</span></span><br><span class="line">    <span class="keyword">if</span> (cmcf-&gt;ports == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        cmcf-&gt;ports = ngx_array_create(cf-&gt;temp_pool, <span class="number">2</span>,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_port_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (cmcf-&gt;ports == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa = lsopt-&gt;sockaddr;</span><br><span class="line">    p = ngx_inet_get_port(sa);</span><br><span class="line">    <span class="comment">// 遍历每个port，查找是当前端口已存在</span></span><br><span class="line">    port = cmcf-&gt;ports-&gt;elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;ports-&gt;nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p != port[i].port || sa-&gt;sa_family != port[i].family) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a port is already in the port list */</span></span><br><span class="line">        <span class="comment">// 对于已存在的端口，执行如下函数来添加对应的addr</span></span><br><span class="line">        <span class="keyword">return</span> ngx_http_add_addresses(cf, cscf, &amp;port[i], lsopt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add a port to the port list */</span></span><br><span class="line">   <span class="comment">// 添加当前端口到ports中</span></span><br><span class="line">    port = ngx_array_push(cmcf-&gt;ports);</span><br><span class="line">    <span class="keyword">if</span> (port == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    port-&gt;family = sa-&gt;sa_family;</span><br><span class="line">    port-&gt;port = p;</span><br><span class="line">    port-&gt;addrs.elts = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 添加对应的addr</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_add_address(cf, cscf, port, lsopt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-address"><a href="#ngx-http-add-address" class="headerlink" title="ngx_http_add_address"></a>ngx_http_add_address</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_address(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span> *port, <span class="keyword">ngx_http_listen_opt_t</span> *lsopt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>  *addr;</span><br><span class="line">    <span class="comment">// 分配空间</span></span><br><span class="line">    <span class="keyword">if</span> (port-&gt;addrs.elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;port-&gt;addrs, cf-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_addr_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2 &amp;&amp; NGX_HTTP_SSL                                              \</span></span><br><span class="line">     &amp;&amp; !defined TLSEXT_TYPE_application_layer_protocol_negotiation           \</span><br><span class="line">     &amp;&amp; !defined TLSEXT_TYPE_next_proto_neg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lsopt-&gt;http2 &amp;&amp; lsopt-&gt;ssl) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_WARN, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"nginx was built with OpenSSL that lacks ALPN "</span></span><br><span class="line">                           <span class="string">"and NPN support, HTTP/2 is not enabled for %V"</span>,</span><br><span class="line">                           &amp;lsopt-&gt;addr_text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 添加addr</span></span><br><span class="line">    addr = ngx_array_push(&amp;port-&gt;addrs);</span><br><span class="line">    <span class="keyword">if</span> (addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置对应成员</span></span><br><span class="line">    addr-&gt;opt = *lsopt;</span><br><span class="line">    addr-&gt;hash.buckets = <span class="literal">NULL</span>;</span><br><span class="line">    addr-&gt;hash.size = <span class="number">0</span>;</span><br><span class="line">    addr-&gt;wc_head = <span class="literal">NULL</span>;</span><br><span class="line">    addr-&gt;wc_tail = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    addr-&gt;nregex = <span class="number">0</span>;</span><br><span class="line">    addr-&gt;regex = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    addr-&gt;default_server = cscf;</span><br><span class="line">    addr-&gt;servers.elts = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 绑定对应的server模块</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_add_server(cf, cscf, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="gx-http-add-server"><a href="#gx-http-add-server" class="headerlink" title="gx_http_add_server"></a>gx_http_add_server</h6><p>绑定ip+port形式的地址到对应的server块中。逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_server(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  **server;</span><br><span class="line">    <span class="comment">// 分配server空间</span></span><br><span class="line">    <span class="keyword">if</span> (addr-&gt;servers.elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;addr-&gt;servers, cf-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_core_srv_conf_t</span> *))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 查找当前地址中是否已经存在对该server服务的绑定关系，如果存在，则报错</span></span><br><span class="line">        server = addr-&gt;servers.elts;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; addr-&gt;servers.nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server[i] == cscf) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"a duplicate listen %V"</span>,</span><br><span class="line">                                   &amp;addr-&gt;opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在servers中添加对应的server配置块</span></span><br><span class="line">    server = ngx_array_push(&amp;addr-&gt;servers);</span><br><span class="line">    <span class="keyword">if</span> (server == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *server = cscf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-addresses"><a href="#ngx-http-add-addresses" class="headerlink" title="ngx_http_add_addresses"></a>ngx_http_add_addresses</h6><p>当监听端口（port形式的地址）已经存在一个ngx_http_conf_port_t结构时，这时添加一个addr（ip+port形式的地址）需要使用该方法。该方法会先对比是否已存在对应的ip+port形式的地址，再进行相应操作。具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_addresses(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span> *port, <span class="keyword">ngx_http_listen_opt_t</span> *lsopt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             i, default_server, proxy_protocol;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>  *addr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * we cannot compare whole sockaddr struct's as kernel</span></span><br><span class="line"><span class="comment">     * may fill some fields in inherited sockaddr struct's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    addr = port-&gt;addrs.elts;</span><br><span class="line">    <span class="comment">// 遍历addrs，查找是否已存在与当前ip+port对应的地址相同的地址</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; port-&gt;addrs.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_cmp_sockaddr(lsopt-&gt;sockaddr, lsopt-&gt;socklen,</span><br><span class="line">                             addr[i].opt.sockaddr,</span><br><span class="line">                             addr[i].opt.socklen, <span class="number">0</span>)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the address is already in the address list */</span></span><br><span class="line">        <span class="comment">// 当前地址已存在时进行如下处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在该地址中的server中增加对应的server服务</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_add_server(cf, cscf, &amp;addr[i]) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* preserve default_server bit during listen options overwriting */</span></span><br><span class="line">        <span class="comment">// 记录当前的opt是否设置了默认的服务</span></span><br><span class="line">        default_server = addr[i].opt.default_server;</span><br><span class="line"></span><br><span class="line">        proxy_protocol = lsopt-&gt;proxy_protocol || addr[i].opt.proxy_protocol;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        ssl = lsopt-&gt;ssl || addr[i].opt.ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">        http2 = lsopt-&gt;http2 || addr[i].opt.http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果当前地址进行了额外参数的设置，如rcvbuf=size | sndbuf=size，不包括default_server</span></span><br><span class="line">        <span class="keyword">if</span> (lsopt-&gt;<span class="built_in">set</span>) &#123;</span><br><span class="line">            <span class="comment">// 当前的opt也设置进行了相应的设置，这时会报错，因为使用opt中相应的参数对监听进行设置，但同一个ip+port组成的地址只能进行一次设置，这时所有服务对该地址进行监听时（如果有其他服务），则使用同样的设置。</span></span><br><span class="line">            <span class="keyword">if</span> (addr[i].opt.<span class="built_in">set</span>) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"duplicate listen options for %V"</span>,</span><br><span class="line">                                   &amp;addr[i].opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置地址的opt，对应于进行了额外设置的opt</span></span><br><span class="line">            addr[i].opt = *lsopt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check the duplicate "default" server for this address:port */</span></span><br><span class="line">        <span class="comment">// 如果当前解析出的listen设置为了默认的server服务</span></span><br><span class="line">        <span class="keyword">if</span> (lsopt-&gt;default_server) &#123;</span><br><span class="line">            <span class="comment">// 之前已经设置了默认的server服务，则报错</span></span><br><span class="line">            <span class="keyword">if</span> (default_server) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"a duplicate default server for %V"</span>,</span><br><span class="line">                                   &amp;addr[i].opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 标识已经设置了默认的服务</span></span><br><span class="line">            default_server = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 地址中default_server执行当前的server块</span></span><br><span class="line">            addr[i].default_server = cscf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录是否已经设置了默认的服务块</span></span><br><span class="line">        addr[i].opt.default_server = default_server;</span><br><span class="line">        addr[i].opt.proxy_protocol = proxy_protocol;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        addr[i].opt.ssl = ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">        addr[i].opt.http2 = http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add the address to the addresses list that bound to this port */</span></span><br><span class="line">    <span class="comment">// 未找到相同的地址，则在port中增加一个ip+port形式的地址</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_add_address(cf, cscf, port, lsopt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="server-name处理"><a href="#server-name处理" class="headerlink" title="server_name处理"></a>server_name处理</h4><p>快速查找请求对应的server块和server_name密切相关，这里先来看一下配置中server_name相应的处理。注意一个server块支持多个server_name，且server_name支持精确名，通配符和正则表达式。在未设置时，默认为空。</p>
<h5 id="相关数据结构-1"><a href="#相关数据结构-1" class="headerlink" title="相关数据结构"></a>相关数据结构</h5><h6 id="ngx-http-server-name-t"><a href="#ngx-http-server-name-t" class="headerlink" title="ngx_http_server_name_t"></a>ngx_http_server_name_t</h6><p>ngx_http_server_name_t结构用户存储服务名，并构建服务名到server的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_regex_t          *regex;</span><br><span class="line">#endif</span><br><span class="line">    ngx_http_core_srv_conf_t  *server;   /* virtual name server conf */</span><br><span class="line">    ngx_str_t                  name;</span><br><span class="line">&#125; ngx_http_server_name_t;</span><br></pre></td></tr></table></figure>
<h5 id="处理逻辑"><a href="#处理逻辑" class="headerlink" title="处理逻辑"></a>处理逻辑</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;server_name&quot;),</span><br><span class="line">  NGX_HTTP_SRV_CONF|NGX_CONF_1MORE,</span><br><span class="line">  ngx_http_core_server_name,</span><br><span class="line">  NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">  0,</span><br><span class="line">  NULL &#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">static char *</span><br><span class="line">ngx_http_core_server_name(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)</span><br><span class="line">&#123;</span><br><span class="line">    // 获取server层级下的ngx_http_core_srv_conf_t</span><br><span class="line">    ngx_http_core_srv_conf_t *cscf = conf;</span><br><span class="line"></span><br><span class="line">    u_char                   ch;</span><br><span class="line">    ngx_str_t               *value;</span><br><span class="line">    ngx_uint_t               i;</span><br><span class="line">    ngx_http_server_name_t  *sn;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    // 对于每一个server_name进行处理。</span><br><span class="line">    for (i = 1; i &lt; cf-&gt;args-&gt;nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ch = value[i].data[0];</span><br><span class="line">        // 检验配置语法准确性</span><br><span class="line">        if ((ch == &apos;*&apos; &amp;&amp; (value[i].len &lt; 3 || value[i].data[1] != &apos;.&apos;))</span><br><span class="line">            || (ch == &apos;.&apos; &amp;&amp; value[i].len &lt; 2))</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;server name \&quot;%V\&quot; is invalid&quot;, &amp;value[i]);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strchr(value[i].data, &apos;/&apos;)) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_WARN, cf, 0,</span><br><span class="line">                               &quot;server name \&quot;%V\&quot; has suspicious symbols&quot;,</span><br><span class="line">                               &amp;value[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        // 在ngx_http_core_srv_conf_t的server_names中增加元素</span><br><span class="line">        sn = ngx_array_push(&amp;cscf-&gt;server_names);</span><br><span class="line">        if (sn == NULL) &#123;</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">        sn-&gt;regex = NULL;</span><br><span class="line">#endif</span><br><span class="line">        sn-&gt;server = cscf;</span><br><span class="line">        // 对于服务名是hostname来说，使用之前获取到的hostname</span><br><span class="line">        if (ngx_strcasecmp(value[i].data, (u_char *) &quot;$hostname&quot;) == 0) &#123;</span><br><span class="line">            sn-&gt;name = cf-&gt;cycle-&gt;hostname;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sn-&gt;name = value[i];</span><br><span class="line">        &#125;</span><br><span class="line">        // 对应首字母为~的表达式来说，是使用正则匹配</span><br><span class="line">        if (value[i].data[0] != &apos;~&apos;) &#123;</span><br><span class="line">            ngx_strlow(sn-&gt;name.data, sn-&gt;name.data, sn-&gt;name.len);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">        &#123;</span><br><span class="line">        //构建正则匹配</span><br><span class="line">        u_char               *p;</span><br><span class="line">        ngx_regex_compile_t   rc;</span><br><span class="line">        u_char                errstr[NGX_MAX_CONF_ERRSTR];</span><br><span class="line"></span><br><span class="line">        if (value[i].len == 1) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;empty regex in server name \&quot;%V\&quot;&quot;, &amp;value[i]);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        value[i].len--;</span><br><span class="line">        value[i].data++;</span><br><span class="line"></span><br><span class="line">        ngx_memzero(&amp;rc, sizeof(ngx_regex_compile_t));</span><br><span class="line"></span><br><span class="line">        rc.pattern = value[i];</span><br><span class="line">        rc.err.len = NGX_MAX_CONF_ERRSTR;</span><br><span class="line">        rc.err.data = errstr;</span><br><span class="line"></span><br><span class="line">        for (p = value[i].data; p &lt; value[i].data + value[i].len; p++) &#123;</span><br><span class="line">            if (*p &gt;= &apos;A&apos; &amp;&amp; *p &lt;= &apos;Z&apos;) &#123;</span><br><span class="line">                rc.options = NGX_REGEX_CASELESS;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sn-&gt;regex = ngx_http_regex_compile(cf, &amp;rc);</span><br><span class="line">        if (sn-&gt;regex == NULL) &#123;</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sn-&gt;name = value[i];</span><br><span class="line">        cscf-&gt;captures = (rc.captures &gt; 0);</span><br><span class="line">        &#125;</span><br><span class="line">#else</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                           &quot;using regex \&quot;%V\&quot; &quot;</span><br><span class="line">                           &quot;requires PCRE library&quot;, &amp;value[i]);</span><br><span class="line"></span><br><span class="line">        return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，对应某个模块的serve_name未明确配置来说，其对应的ngx_http_core_srv_conf_t的server_names中将为空。</p>
<h4 id="server块的快速查找"><a href="#server块的快速查找" class="headerlink" title="server块的快速查找"></a>server块的快速查找</h4><h5 id="相关数据结构-2"><a href="#相关数据结构-2" class="headerlink" title="相关数据结构"></a>相关数据结构</h5><p>相关数据结构可以先不看，先看处理函数，当遇到对应结构时再查看。</p>
<h6 id="ngx-http-port-t"><a href="#ngx-http-port-t" class="headerlink" title="ngx_http_port_t"></a>ngx_http_port_t</h6><p>每个监听地址实际对应的地址数量和具体每个地址信息。由于含有通配符的地址，可能只需要进行一个监听，但对应多个地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    /* ngx_http_in_addr_t or ngx_http_in6_addr_t */</span><br><span class="line">    void                      *addrs; // 每个地址的详细信息，按协议区分</span><br><span class="line">    ngx_uint_t                 naddrs; // 地址数据</span><br><span class="line">&#125; ngx_http_port_t;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-listening-t"><a href="#ngx-listening-t" class="headerlink" title="ngx_listening_t"></a>ngx_listening_t</h6><p>前文已介绍过。</p>
<h6 id="ngx-http-in-addr-t"><a href="#ngx-http-in-addr-t" class="headerlink" title="ngx_http_in_addr_t"></a>ngx_http_in_addr_t</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    in_addr_t                  addr; // ipv4地址</span><br><span class="line">    ngx_http_addr_conf_t       conf; // 监听地址对应的详细信息</span><br><span class="line">&#125; ngx_http_in_addr_t;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-addr-conf-s"><a href="#ngx-http-addr-conf-s" class="headerlink" title="ngx_http_addr_conf_s"></a>ngx_http_addr_conf_s</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_http_addr_conf_s &#123;</span><br><span class="line">    /* the default server configuration for this address:port */</span><br><span class="line">    ngx_http_core_srv_conf_t  *default_server; // 监听地址对应的默认server</span><br><span class="line"></span><br><span class="line">    ngx_http_virtual_names_t  *virtual_names; // 监听地址对于的server集合</span><br><span class="line"></span><br><span class="line">    unsigned                   ssl:1;</span><br><span class="line">    unsigned                   http2:1;</span><br><span class="line">    unsigned                   proxy_protocol:1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-virtual-names-t"><a href="#ngx-http-virtual-names-t" class="headerlink" title="ngx_http_virtual_names_t"></a>ngx_http_virtual_names_t</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_hash_combined_t        names; // 存在server信息的hash结构，包含精准，前置通配符，后置通配符</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                 nregex; // 正则表达式server name数量</span><br><span class="line">    ngx_http_server_name_t    *regex; // 每一个正则表达式server name</span><br><span class="line">&#125; ngx_http_virtual_names_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-optimize-servers"><a href="#ngx-http-optimize-servers" class="headerlink" title="ngx_http_optimize_servers"></a>ngx_http_optimize_servers</h5><p>经过上述的set方法，已经构建了从main级别的ngx_http_core_main_conf_t成员ports（ngx_http_conf_port_t，port形式的地址）数组、到addrs（ngx_http_conf_addr_t，ip+port形式的地址）、再到servers（ngx_http_core_srv_conf_t，每一个虚拟server）数组的关系。但每次查找时，使用ip+port的地址，再查找对应的server是相对复杂的，如果有大量的server块，并且监听的是同一个ip+port形式的地址。这时逐个进行server_name和请求的host匹配是过于缓慢的。为了加速查找，这里在ip+port形式的地址中，增加了hash表。已加速查找。具体hash表的构建在http层set函数ngx_http_block的ngx_http_optimize_servers方法中。其逻辑如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* optimize the lists of ports, addresses and server names */</span><br><span class="line"></span><br><span class="line">if (ngx_http_optimize_servers(cf, cmcf, cmcf-&gt;ports) != NGX_OK) &#123;</span><br><span class="line">    return NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_optimize_servers(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf,</span><br><span class="line">    <span class="keyword">ngx_array_t</span> *ports)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             p, a;</span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span>  *port;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>  *addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ports == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每一个port地址下的ip+port地址</span></span><br><span class="line">    port = ports-&gt;elts;</span><br><span class="line">    <span class="keyword">for</span> (p = <span class="number">0</span>; p &lt; ports-&gt;nelts; p++) &#123;</span><br><span class="line">        <span class="comment">/* 对ip+port的地址进行排序，将通配符形式地址，即任意ip+port的排到最后（如果有，不需要考虑是否bind()ed，因为对应通配符的地址来说bind()无意义）。最开始是bind()ed的地址。中间是未bind()ed的地址。*/</span></span><br><span class="line">        ngx_sort(port[p].addrs.elts, (<span class="keyword">size_t</span>) port[p].addrs.nelts,</span><br><span class="line">                 <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_addr_t</span>), ngx_http_cmp_conf_addrs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * check whether all name-based servers have the same</span></span><br><span class="line"><span class="comment">         * configuration as a default server for given address:port</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 遍历ip+port地址</span></span><br><span class="line">        addr = port[p].addrs.elts;</span><br><span class="line">        <span class="keyword">for</span> (a = <span class="number">0</span>; a &lt; port[p].addrs.nelts; a++) &#123;</span><br><span class="line">            <span class="comment">// 如果ip+port地址下有多个server块，或者只有一个server块（会被设置为默认server块）存在正则匹配时</span></span><br><span class="line">            <span class="keyword">if</span> (addr[a].servers.nelts &gt; <span class="number">1</span></span><br><span class="line">#<span class="keyword">if</span> (NGX_PCRE)</span><br><span class="line">                || addr[a].default_server-&gt;captures</span><br><span class="line">#endif</span><br><span class="line">               )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建hash表，方便查找</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_server_names(cf, cmcf, &amp;addr[a]) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 构建需要进行监听的结构</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_listening(cf, &amp;port[p]) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-server-names"><a href="#ngx-http-server-names" class="headerlink" title="ngx_http_server_names"></a>ngx_http_server_names</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_server_names(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  n, s;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>             hash;</span><br><span class="line">    <span class="keyword">ngx_hash_keys_arrays_t</span>      ha;</span><br><span class="line">    <span class="keyword">ngx_http_server_name_t</span>     *name;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  **cscfp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  regex, i;</span><br><span class="line"></span><br><span class="line">    regex = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 分配构建hash表的ngx_hash_keys_arrays_t结构，具体可查看前文的正则表达式</span></span><br><span class="line">    ngx_memzero(&amp;ha, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_keys_arrays_t</span>));</span><br><span class="line"></span><br><span class="line">    ha.temp_pool = ngx_create_pool(NGX_DEFAULT_POOL_SIZE, cf-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (ha.temp_pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ha.pool = cf-&gt;pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_keys_array_init(&amp;ha, NGX_HASH_LARGE) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cscfp = addr-&gt;servers.elts;</span><br><span class="line">    <span class="comment">// 遍历ip+port地址下每一个server块的配置</span></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; addr-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        name = cscfp[s]-&gt;server_names.elts;</span><br><span class="line">        <span class="comment">/* 遍历每个seerver块下的server_names（ngx_http_server_name_t数组），注意，如果未显式配置server_name，则数组为空*/</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cscfp[s]-&gt;server_names.nelts; n++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">            <span class="comment">// 如果server_name为正则表达式,则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (name[n].regex) &#123;</span><br><span class="line">                regex++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 添加server_name到要构建的hash表的ngx_hash_keys_arrays_t结构中</span></span><br><span class="line">            rc = ngx_hash_add_key(&amp;ha, &amp;name[n].name, name[n].server,</span><br><span class="line">                                  NGX_HASH_WILDCARD_KEY);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"invalid server name or wildcard \"%V\" on %V"</span>,</span><br><span class="line">                              &amp;name[n].name, &amp;addr-&gt;opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_WARN, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"conflicting server name \"%V\" on %V, ignored"</span>,</span><br><span class="line">                              &amp;name[n].name, &amp;addr-&gt;opt.addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建hash表的hash函数，即相关配置，其中server_names_hash_max_size，和server_names_hash_bucket_size可配置</span></span><br><span class="line">    hash.key = ngx_hash_key_lc;</span><br><span class="line">    hash.max_size = cmcf-&gt;server_names_hash_max_size;</span><br><span class="line">    hash.bucket_size = cmcf-&gt;server_names_hash_bucket_size;</span><br><span class="line">    hash.name = <span class="string">"server_names_hash"</span>;</span><br><span class="line">    hash.pool = cf-&gt;pool;</span><br><span class="line">    <span class="comment">// 如果精确名数组不为空，则构建精确名hash表</span></span><br><span class="line">    <span class="keyword">if</span> (ha.keys.nelts) &#123;</span><br><span class="line">        hash.hash = &amp;addr-&gt;hash;</span><br><span class="line">        hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_hash_init(&amp;hash, ha.keys.elts, ha.keys.nelts) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构建前缀通配符</span></span><br><span class="line">    <span class="keyword">if</span> (ha.dns_wc_head.nelts) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_qsort(ha.dns_wc_head.elts, (<span class="keyword">size_t</span>) ha.dns_wc_head.nelts,</span><br><span class="line">                  <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>), ngx_http_cmp_dns_wildcards);</span><br><span class="line"></span><br><span class="line">        hash.hash = <span class="literal">NULL</span>;</span><br><span class="line">        hash.temp_pool = ha.temp_pool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_hash_wildcard_init(&amp;hash, ha.dns_wc_head.elts,</span><br><span class="line">                                   ha.dns_wc_head.nelts)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addr-&gt;wc_head = (<span class="keyword">ngx_hash_wildcard_t</span> *) hash.hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建后置通配符</span></span><br><span class="line">    <span class="keyword">if</span> (ha.dns_wc_tail.nelts) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_qsort(ha.dns_wc_tail.elts, (<span class="keyword">size_t</span>) ha.dns_wc_tail.nelts,</span><br><span class="line">                  <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>), ngx_http_cmp_dns_wildcards);</span><br><span class="line"></span><br><span class="line">        hash.hash = <span class="literal">NULL</span>;</span><br><span class="line">        hash.temp_pool = ha.temp_pool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_hash_wildcard_init(&amp;hash, ha.dns_wc_tail.elts,</span><br><span class="line">                                   ha.dns_wc_tail.nelts)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addr-&gt;wc_tail = (<span class="keyword">ngx_hash_wildcard_t</span> *) hash.hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(ha.temp_pool);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">// 如果存在通配符名，则在addr的regex中添加正则表达式server name</span></span><br><span class="line">    <span class="keyword">if</span> (regex == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addr-&gt;nregex = regex;</span><br><span class="line">    addr-&gt;regex = ngx_palloc(cf-&gt;pool, regex * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_server_name_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (addr-&gt;regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; addr-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        name = cscfp[s]-&gt;server_names.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cscfp[s]-&gt;server_names.nelts; n++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name[n].regex) &#123;</span><br><span class="line">                addr-&gt;regex[i++] = name[n];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(ha.temp_pool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-init-listening"><a href="#ngx-http-init-listening" class="headerlink" title="ngx_http_init_listening"></a>ngx_http_init_listening</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_listening(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_conf_port_t</span> *port)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i, last, bind_wildcard;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line">    <span class="keyword">ngx_http_port_t</span>           *hport;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>      *addr;</span><br><span class="line"></span><br><span class="line">    addr = port-&gt;addrs.elts;</span><br><span class="line">    last = port-&gt;addrs.nelts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If there is a binding to an "*:port" then we need to bind() to</span></span><br><span class="line"><span class="comment">     * the "*:port" only and ignore other implicit bindings.  The bindings</span></span><br><span class="line"><span class="comment">     * have been already sorted: explicit bindings are on the start, then</span></span><br><span class="line"><span class="comment">     * implicit bindings go, and wildcard binding is in the end.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">/* 对于一个port存在通配符形式地址来说，未bind()的ip+port不需要额外进行监听，只需要监听bind（）的地址。注意这里已经是排好序的ip+port形式的地址，其中bind()的在最前面（非通配符形式），其次是未bind（）地址，最后是通配符地址 */</span></span><br><span class="line">     <span class="comment">// 如果最后一个是通配符形式地址</span></span><br><span class="line">    <span class="keyword">if</span> (addr[last - <span class="number">1</span>].opt.wildcard) &#123;</span><br><span class="line">        <span class="comment">// 设置最后一个为bind的，保证最后所有地址均被监听</span></span><br><span class="line">        addr[last - <span class="number">1</span>].opt.bind = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 记录存在通配符形式地址</span></span><br><span class="line">        bind_wildcard = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 记录不存在通配符形式地址</span></span><br><span class="line">        bind_wildcard = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历每个地址</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; last) &#123;</span><br><span class="line">        <span class="comment">// 如果存在通配符形式地址，并且当前地址未绑定时，直接跳过，注意，最后一个地址已被强制设置为bind。</span></span><br><span class="line">        <span class="keyword">if</span> (bind_wildcard &amp;&amp; !addr[i].opt.bind) &#123;</span><br><span class="line">            <span class="comment">// 记录有多少个不需要单独进行监听的地址</span></span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于需要进行监听的地址，将其增加到listening队列中。</span></span><br><span class="line">        ls = ngx_http_add_listening(cf, &amp;addr[i]);</span><br><span class="line">        <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 由于将不需要单独监听的地址进行了合并，因此需要将每个地址中查找server块的hash表也进行统一管理。</span></span><br><span class="line">        hport = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_port_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (hport == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls-&gt;servers = hport;</span><br><span class="line">        <span class="comment">// 地址合并数量，除最后一个通配符（如果有的化）地址以外，其他需要单独监听的应该都是1</span></span><br><span class="line">        hport-&gt;naddrs = i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 根据协议进行分别处理</span></span><br><span class="line">        <span class="keyword">switch</span> (ls-&gt;sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            <span class="keyword">if</span> (ngx_http_add_addrs6(cf, hport, addr) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_add_addrs(cf, hport, addr) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理完成，将地址向前移。这是为了方便最后通配符形式的地址，进行统一处理</span></span><br><span class="line">        addr++;</span><br><span class="line">        <span class="comment">/* 处理完成，将总数量减一。这是由于对于需要单独监听的地址来说，记录合并数量的i并未增加，要保障遍历的正确性，需要对总数减一。*/</span></span><br><span class="line">        last--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-listening"><a href="#ngx-http-add-listening" class="headerlink" title="ngx_http_add_listening"></a>ngx_http_add_listening</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_listening_t</span> *</span><br><span class="line">ngx_http_add_listening(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line">    <span class="comment">// 将需要监听的地址增加到cycle的listening中，并对ngx_listening_t结构的参数赋默认初值</span></span><br><span class="line">    ls = ngx_create_listening(cf, addr-&gt;opt.sockaddr, addr-&gt;opt.socklen);</span><br><span class="line">    <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ls-&gt;addr_ntop = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置建立链接后处理函数，进一步解析见http的处理部分</span></span><br><span class="line">    ls-&gt;handler = ngx_http_init_connection;</span><br><span class="line"></span><br><span class="line">    cscf = addr-&gt;default_server;</span><br><span class="line">    ls-&gt;pool_size = cscf-&gt;connection_pool_size;</span><br><span class="line">    ls-&gt;post_accept_timeout = cscf-&gt;client_header_timeout;</span><br><span class="line"></span><br><span class="line">    clcf = cscf-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// 根据addr的opt对ls设置参数值。</span></span><br><span class="line">    ls-&gt;logp = clcf-&gt;error_log;</span><br><span class="line">    ls-&gt;<span class="built_in">log</span>.data = &amp;ls-&gt;addr_text;</span><br><span class="line">    ls-&gt;<span class="built_in">log</span>.handler = ngx_accept_log_error;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">ngx_iocp_conf_t</span>  *iocpcf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_get_conf(cf-&gt;cycle-&gt;conf_ctx, ngx_events_module)) &#123;</span><br><span class="line">        iocpcf = ngx_event_get_conf(cf-&gt;cycle-&gt;conf_ctx, ngx_iocp_module);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (iocpcf &amp;&amp; iocpcf-&gt;acceptex_read) &#123;</span><br><span class="line">        ls-&gt;post_accept_buffer_size = cscf-&gt;client_header_buffer_size;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ls-&gt;backlog = addr-&gt;opt.backlog;</span><br><span class="line">    ls-&gt;rcvbuf = addr-&gt;opt.rcvbuf;</span><br><span class="line">    ls-&gt;sndbuf = addr-&gt;opt.sndbuf;</span><br><span class="line"></span><br><span class="line">    ls-&gt;keepalive = addr-&gt;opt.so_keepalive;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KEEPALIVE_TUNABLE)</span></span><br><span class="line">    ls-&gt;keepidle = addr-&gt;opt.tcp_keepidle;</span><br><span class="line">    ls-&gt;keepintvl = addr-&gt;opt.tcp_keepintvl;</span><br><span class="line">    ls-&gt;keepcnt = addr-&gt;opt.tcp_keepcnt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    ls-&gt;accept_filter = addr-&gt;opt.accept_filter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span></span><br><span class="line">    ls-&gt;deferred_accept = addr-&gt;opt.deferred_accept;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">    ls-&gt;ipv6only = addr-&gt;opt.ipv6only;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">    ls-&gt;setfib = addr-&gt;opt.setfib;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">    ls-&gt;fastopen = addr-&gt;opt.fastopen;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">    ls-&gt;reuseport = addr-&gt;opt.reuseport;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-addrs"><a href="#ngx-http-add-addrs" class="headerlink" title="ngx_http_add_addrs"></a>ngx_http_add_addrs</h6><p>ipv4和ipv6对应的处理类似，这里以ipv4举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_addrs(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_port_t</span> *hport,</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_http_in_addr_t</span>        *addrs;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>        *<span class="title">sin</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_virtual_names_t</span>  *vn;</span><br><span class="line">    <span class="comment">// 根据需要进行地址合并监听的数量，来分配ngx_http_in_addr_t的数量</span></span><br><span class="line">    hport-&gt;addrs = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                               hport-&gt;naddrs * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_in_addr_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (hport-&gt;addrs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addrs = hport-&gt;addrs;</span><br><span class="line">    <span class="comment">// 遍历addr（即ip+port对应的地址结构ngx_http_conf_addr_t）对addrs赋值。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hport-&gt;naddrs; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sin</span> = (struct sockaddr_in *) addr[i].opt.sockaddr;</span><br><span class="line">        addrs[i].addr = <span class="built_in">sin</span>-&gt;sin_addr.s_addr;</span><br><span class="line">        <span class="comment">/* 设置默认server块。这里如果有两个监听同样的ip+port地址的server块，但都没有设置server_name，则第二个的服务永远不会被访问到 */</span></span><br><span class="line">        addrs[i].conf.default_server = addr[i].default_server;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        addrs[i].conf.ssl = addr[i].opt.ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">        addrs[i].conf.http2 = addr[i].opt.http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        addrs[i].conf.proxy_protocol = addr[i].opt.proxy_protocol;</span><br><span class="line">        <span class="comment">/* 如果ip+port地址下的server name未存在hash（三种）并且无正则表达式，则直接跳过。即此时所有server块，均无明确server name。 这时只能通过default_server进行服务服务，因此其他服务将无法访问到*/</span></span><br><span class="line">        <span class="keyword">if</span> (addr[i].hash.buckets == <span class="literal">NULL</span></span><br><span class="line">            &amp;&amp; (addr[i].wc_head == <span class="literal">NULL</span></span><br><span class="line">                || addr[i].wc_head-&gt;hash.buckets == <span class="literal">NULL</span>)</span><br><span class="line">            &amp;&amp; (addr[i].wc_tail == <span class="literal">NULL</span></span><br><span class="line">                || addr[i].wc_tail-&gt;hash.buckets == <span class="literal">NULL</span>)</span><br><span class="line">#<span class="keyword">if</span> (NGX_PCRE)</span><br><span class="line">            &amp;&amp; addr[i].nregex == <span class="number">0</span></span><br><span class="line">#endif</span><br><span class="line">            )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果上述有一个存在，则会构建一个ngx_http_virtual_names_t进行存储</span></span><br><span class="line">        vn = ngx_palloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_virtual_names_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (vn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addrs[i].conf.virtual_names = vn;</span><br><span class="line">        <span class="comment">// 存储hash表</span></span><br><span class="line">        vn-&gt;names.hash = addr[i].hash;</span><br><span class="line">        vn-&gt;names.wc_head = addr[i].wc_head;</span><br><span class="line">        vn-&gt;names.wc_tail = addr[i].wc_tail;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">        <span class="comment">// 存储正则表达式。</span></span><br><span class="line">        vn-&gt;nregex = addr[i].nregex;</span><br><span class="line">        vn-&gt;regex = addr[i].regex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="location层set函数"><a href="#location层set函数" class="headerlink" title="location层set函数"></a>location层set函数</h3><p>在server中，接着执行解析函数时，当解析到location配置时，首先会遇到ngx_http_core_module核心模块的commands中的location。如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"location"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_BLOCK|NGX_CONF_TAKE12,</span><br><span class="line">      ngx_http_core_location,</span><br><span class="line">      NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>其函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_core_location(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *dummy)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                      *rv;</span><br><span class="line">    u_char                    *mod;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 *value, *name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                 save;</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span>         *<span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>       *ctx, *pctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf, *pclcf;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里的ctx为server层创建的ngx_http_conf_ctx_t。由于loc层不会有main和server层的配置，因此这两部分指向server层创建的空间即可</span></span><br><span class="line">    pctx = cf-&gt;ctx;</span><br><span class="line">    ctx-&gt;main_conf = pctx-&gt;main_conf;</span><br><span class="line">    ctx-&gt;srv_conf = pctx-&gt;srv_conf;</span><br><span class="line">    <span class="comment">// 创建loc_conf存储空间</span></span><br><span class="line">    ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_loc_conf) &#123;</span><br><span class="line">            ctx-&gt;loc_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] =</span><br><span class="line">                                                   <span class="keyword">module</span>-&gt;create_loc_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;loc_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取loc层ngx_http_core_module创建的ngx_http_core_loc_conf_s</span></span><br><span class="line">    clcf = ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// loc层的ngx_http_core_loc_conf_s的loc_conf指向loc层创建的loc_conf</span></span><br><span class="line">    clcf-&gt;loc_conf = ctx-&gt;loc_conf;</span><br><span class="line">    <span class="comment">// 获取词法解析后的数量。这里value只会是2、3，由于location中的commands中的NGX_CONF_TAKE12限制。正常来说是3，详见location配置。2是由于中间的参数和后面的参数中间未添加空格导致。这里分别进行处理。</span></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 对解析参数进行处理，来对clcf赋值。只有~和~*时需要进行正则匹配，对于正则匹配的介绍，后续进行</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts == <span class="number">3</span>) &#123;</span><br><span class="line"></span><br><span class="line">        len = value[<span class="number">1</span>].len;</span><br><span class="line">        mod = value[<span class="number">1</span>].data;</span><br><span class="line">        name = &amp;value[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">1</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'='</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name = *name;</span><br><span class="line">            clcf-&gt;exact_match = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">2</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'^'</span> &amp;&amp; mod[<span class="number">1</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name = *name;</span><br><span class="line">            clcf-&gt;noregex = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">1</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">2</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'~'</span> &amp;&amp; mod[<span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">1</span>) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"invalid location modifier \"%V\""</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        name = &amp;value[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'='</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name.len = name-&gt;len - <span class="number">1</span>;</span><br><span class="line">            clcf-&gt;name.data = name-&gt;data + <span class="number">1</span>;</span><br><span class="line">            clcf-&gt;exact_match = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'^'</span> &amp;&amp; name-&gt;data[<span class="number">1</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name.len = name-&gt;len - <span class="number">2</span>;</span><br><span class="line">            clcf-&gt;name.data = name-&gt;data + <span class="number">2</span>;</span><br><span class="line">            clcf-&gt;noregex = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            name-&gt;len--;</span><br><span class="line">            name-&gt;data++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                name-&gt;len--;</span><br><span class="line">                name-&gt;data++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">1</span>) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name = *name;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'@'</span>) &#123;</span><br><span class="line">                clcf-&gt;named = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上一层（正常来说是server层，如果是location中嵌套location，则是当前location的上一层location）ngx_http_core_module创建的ngx_http_core_loc_conf_s</span></span><br><span class="line">    pclcf = pctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// 对于location块中嵌套location的处理</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cmd_type == NGX_HTTP_LOC_CONF) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* nested location */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        clcf-&gt;prev_location = pclcf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pclcf-&gt;exact_match) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"location \"%V\" cannot be inside "</span></span><br><span class="line">                               <span class="string">"the exact location \"%V\""</span>,</span><br><span class="line">                               &amp;clcf-&gt;name, &amp;pclcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pclcf-&gt;named) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"location \"%V\" cannot be inside "</span></span><br><span class="line">                               <span class="string">"the named location \"%V\""</span>,</span><br><span class="line">                               &amp;clcf-&gt;name, &amp;pclcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;named) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"named location \"%V\" can be "</span></span><br><span class="line">                               <span class="string">"on the server level only"</span>,</span><br><span class="line">                               &amp;clcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = pclcf-&gt;name.len;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;regex == <span class="literal">NULL</span></span><br><span class="line">            &amp;&amp; ngx_filename_cmp(clcf-&gt;name.data, pclcf-&gt;name.data, len) != <span class="number">0</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> (ngx_filename_cmp(clcf-&gt;name.data, pclcf-&gt;name.data, len) != <span class="number">0</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"location \"%V\" is outside location \"%V\""</span>,</span><br><span class="line">                               &amp;clcf-&gt;name, &amp;pclcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在上一层（正常来说是server层，如果是location中嵌套location，则是当前location的上一层location）ngx_http_core_module创建的ngx_http_core_loc_conf_s中的location变量里增加loc层创建的ngx_http_core_loc_conf_s，以此将server层和location层的解析关系进行连接。这里建立的是ngx_http_location_queue_t结构，其中存储了当前loc下的配置信息。</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_add_location(cf, &amp;pclcf-&gt;locations, clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续解析location层的配置</span></span><br><span class="line">    save = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    cf-&gt;cmd_type = NGX_HTTP_LOC_CONF;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    *cf = save;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="loc级配置解析内存结构"><a href="#loc级配置解析内存结构" class="headerlink" title="loc级配置解析内存结构"></a>loc级配置解析内存结构</h4><p><a href="https://imgtu.com/i/RI50gJ" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/06/RI50gJ.png" alt="RI50gJ.png"></a></p>
<p><center>图10-5</center><br>解析每一个location块时都会创建一个新的 ngx_http_conf_ctx_t结构体，其中的main_conf、srv_conf将指向http块下main_conf、srv_conf指针数组，loc_conf数组则都会重新分配，内容就是所有HTTP模块的create_loc_conf方法创建的结构体指针。</p>
<p>server层的存储结构和location层存储关联方式为：将location层ngx_http_core_module模块生成的ngx_http_core_loc_conf_s添加到server层ngx_http_core_module块生成的ngx_http_core_loc_conf_s的locations中，ngx_http_core_loc_conf_s的locations为一个队列，其元素为ngx_http_location_queue_t。定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// queue为双向队列容器，用于将ngx_http_location_queue_t链接起来</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                      <span class="built_in">queue</span>;</span><br><span class="line">    <span class="comment">// 如果location中的字符串可以精确匹配（包括正则表达式），exact指向对应的ngx_http_core_loc_conf_t结构体。否则为null</span></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *exact;</span><br><span class="line">    <span class="comment">// 如果location中的字符串无法精确匹配（包括了自定义的通配符），inclusive指向对应的ngx_http_core_loc_conf_t结构体。否则为null</span></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *inclusive;</span><br><span class="line">    <span class="comment">// 指向location名称</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                       *name;</span><br><span class="line">    u_char                          *file_name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       line;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                      <span class="built_in">list</span>;</span><br><span class="line">&#125; <span class="keyword">ngx_http_location_queue_t</span>;</span><br></pre></td></tr></table></figure>
<p>使用ngx_http_location_queue_t将server层配置与location层配置相关联，server层的ngx_http_core_loc_conf_s的locations存储了其下所有location块生成的ngx_http_location_queue_t。最终解析后结构可能如下：</p>
<p><a href="https://imgtu.com/i/R7D2DO" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/06/R7D2DO.png" alt="R7D2DO.png"></a></p>
<p>location本身是可以进行嵌套的，嵌套后结构也是可以按照上面的方式进行扩招，即上一层的ngx_http_core_loc_conf_s中的locations存储下一层的所有location解析。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    mytest_num 1;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name A;</span><br><span class="line">        listen 8000;</span><br><span class="line">        listen 80;</span><br><span class="line">        mytest_num 2;</span><br><span class="line">        location /L1 &#123;</span><br><span class="line">            mytest_num 3;</span><br><span class="line">            ...</span><br><span class="line">            location /L1/CL1 &#123;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其解析结果为：</p>
<p><a href="https://imgtu.com/i/R7DzPs" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/06/R7DzPs.png" alt="R7DzPs.png"></a></p>
<p>向locations中增加ngx_http_core_loc_conf_t的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_location(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> **locations,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *clcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *locations = ngx_palloc(cf-&gt;temp_pool,</span><br><span class="line">                                <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_location_queue_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (*locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_queue_init(*locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lq = ngx_palloc(cf-&gt;temp_pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_location_queue_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (lq == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;exact_match</span><br><span class="line">#<span class="keyword">if</span> (NGX_PCRE)</span><br><span class="line">        || clcf-&gt;regex</span><br><span class="line">#endif</span><br><span class="line">        || clcf-&gt;named || clcf-&gt;noname)</span><br><span class="line">    &#123;</span><br><span class="line">        lq-&gt;exact = clcf;</span><br><span class="line">        lq-&gt;inclusive = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// location ^~ 会使用包含匹配</span></span><br><span class="line">        lq-&gt;exact = <span class="literal">NULL</span>;</span><br><span class="line">        lq-&gt;inclusive = clcf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lq-&gt;name = &amp;clcf-&gt;name;</span><br><span class="line">    lq-&gt;file_name = cf-&gt;conf_file-&gt;file.name.data;</span><br><span class="line">    lq-&gt;line = cf-&gt;conf_file-&gt;line;</span><br><span class="line"></span><br><span class="line">    ngx_queue_init(&amp;lq-&gt;<span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line">    ngx_queue_insert_tail(*locations, &amp;lq-&gt;<span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码可以看出来，locations并非直接存储的ngx_http_location_queue_t。而是一个ngx_queue_t，即nginx自己实现的双向队列。这里存储的是ngx_http_location_queue_t结构中的queue队列，可以通过ngx_queue_t支持的操作，获取到对应的源数据。</p>
<h4 id="正则表达式解析"><a href="#正则表达式解析" class="headerlink" title="正则表达式解析"></a>正则表达式解析</h4><h2 id="配置项合并"><a href="#配置项合并" class="headerlink" title="配置项合并"></a>配置项合并</h2><p>合并配置项，主要是合并main层的srv_conf与server层的srv_conf合并，以及main层的loc_conf与server层的loc_conf和location层的loc_conf三者之间的合并。即如下图：</p>
<p><a href="https://imgtu.com/i/Rq8iGT" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/07/Rq8iGT.png" alt="Rq8iGT.png"></a></p>
<p>在http层解析完成配置后，就会进行配置项的合并：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取http级别ngx_http_core_module创建的http_ngx_core_main_conf_t</span></span><br><span class="line">cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">cscfp = cmcf-&gt;servers.elts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">    mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init http&#123;&#125; main_conf's */</span></span><br><span class="line">    <span class="comment">// 执行每个模块的init_main_conf方法，解析后，对main级别的main_conf进行进一步处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;init_main_conf) &#123;</span><br><span class="line">        rv = <span class="keyword">module</span>-&gt;init_main_conf(cf, ctx-&gt;main_conf[mi]);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 合并配置项</span></span><br><span class="line"></span><br><span class="line">    rv = ngx_http_merge_servers(cf, cmcf, <span class="keyword">module</span>, mi);</span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-merge-servers"><a href="#ngx-http-merge-servers" class="headerlink" title="ngx_http_merge_servers"></a>ngx_http_merge_servers</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_merge_servers(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf,</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span> *<span class="keyword">module</span>, <span class="keyword">ngx_uint_t</span> ctx_index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                        *rv;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   s;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>         *ctx, saved;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>   **cscfp;</span><br><span class="line">    <span class="comment">// 获取main级别ngx_http_core_module创建的http_ngx_core_main_conf_t的servers</span></span><br><span class="line">    cscfp = cmcf-&gt;servers.elts;</span><br><span class="line">    ctx = (<span class="keyword">ngx_http_conf_ctx_t</span> *) cf-&gt;ctx;</span><br><span class="line">    saved = *ctx;</span><br><span class="line">    rv = NGX_CONF_OK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* merge the server&#123;&#125;s' srv_conf's */</span></span><br><span class="line">        <span class="comment">// 使ctx-&gt;srv_conf变更为server层创建的ngx_http_conf_ctx_t的srv_conf</span></span><br><span class="line">        ctx-&gt;srv_conf = cscfp[s]-&gt;ctx-&gt;srv_conf;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;merge_srv_conf) &#123;</span><br><span class="line">            <span class="comment">// 调用模块的merge_srv_conf（如果有），合并main级别和server级别的srv_conf。参数中，前者为main级别下创建的srv_conf，后者为server级别创建的srv_conf，merger后，对后者进行变更（即server层）</span></span><br><span class="line">            rv = <span class="keyword">module</span>-&gt;merge_srv_conf(cf, saved.srv_conf[ctx_index],</span><br><span class="line">                                        cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;merge_loc_conf) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* merge the server&#123;&#125;'s loc_conf */</span></span><br><span class="line">            <span class="comment">// 使ctx-&gt;loc_conf变更为server层创建的ngx_http_conf_ctx_t的loc_conf</span></span><br><span class="line">            ctx-&gt;loc_conf = cscfp[s]-&gt;ctx-&gt;loc_conf;</span><br><span class="line">            <span class="comment">// 调用模块的merge_loc_conf（如果有），合并main级别和server级别的loc_conf。参数中，前者为main级别下创建的loc_conf，后者为server级别创建的loc_conf，merger后，对后者进行变更（即server层）</span></span><br><span class="line">            rv = <span class="keyword">module</span>-&gt;merge_loc_conf(cf, saved.loc_conf[ctx_index],</span><br><span class="line">                                        cscfp[s]-&gt;ctx-&gt;loc_conf[ctx_index]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* merge the locations&#123;&#125;' loc_conf's */</span></span><br><span class="line">            <span class="comment">// 获取server级别ngx_http_core_module创建的ngx_http_conf_ctx_t的loc_conf</span></span><br><span class="line">            clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">            <span class="comment">// 调用ngx_http_merge_locations模块，merge server层（已经和main层合并过）的loc_conf和location层的loc_conf，参数中，前者为server下的location块列表，后者为server层的loc_conf</span></span><br><span class="line">            rv = ngx_http_merge_locations(cf, clcf-&gt;locations,</span><br><span class="line">                                          cscfp[s]-&gt;ctx-&gt;loc_conf,</span><br><span class="line">                                          <span class="keyword">module</span>, ctx_index);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    *ctx = saved;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-merge-locations"><a href="#ngx-http-merge-locations" class="headerlink" title="ngx_http_merge_locations"></a>ngx_http_merge_locations</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_merge_locations(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> *locations,</span><br><span class="line">    <span class="keyword">void</span> **loc_conf, <span class="keyword">ngx_http_module_t</span> *<span class="keyword">module</span>, <span class="keyword">ngx_uint_t</span> ctx_index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                       *rv;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>        *ctx, saved;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上一层（无嵌套location时，为server层，在嵌套location时，为上一层location）的ngx_http_conf_ctx_t</span></span><br><span class="line">    ctx = (<span class="keyword">ngx_http_conf_ctx_t</span> *) cf-&gt;ctx;</span><br><span class="line">    saved = *ctx;</span><br><span class="line">    <span class="comment">// 循环server块下，每一个location块，将每一个location块中的ctx_index对应模块与server层的ctx_index进行合并</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_head(locations);</span><br><span class="line">         q != ngx_queue_sentinel(locations);</span><br><span class="line">         q = ngx_queue_next(q))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 由于ngx_queue_t是ngx_http_location_queue_t的第一个元素，因此可以直接转换。</span></span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">        <span class="comment">// 获取location块生成的ngx_http_core_loc_conf_t</span></span><br><span class="line">        clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;</span><br><span class="line">        <span class="comment">// 将ctx-&gt;loc_conf变更为下一层（无嵌套location时，为空，有嵌套location时，为为一层location）的ngx_http_conf_ctx_t中的loc_conf</span></span><br><span class="line">        ctx-&gt;loc_conf = clcf-&gt;loc_conf;</span><br><span class="line">        <span class="comment">// 调用模块的merge_loc_conf（如果有），合并server级别和location级别的loc_conf。参数中，前者为server级别下创建的loc_conf，后者为location级别创建的loc_conf，merger后，对后者进行变更（即location层）</span></span><br><span class="line">        rv = <span class="keyword">module</span>-&gt;merge_loc_conf(cf, loc_conf[ctx_index],</span><br><span class="line">                                    clcf-&gt;loc_conf[ctx_index]);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> rv;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于存在嵌套的location，循环调用ngx_http_merge_locations</span></span><br><span class="line">        rv = ngx_http_merge_locations(cf, clcf-&gt;locations, clcf-&gt;loc_conf,</span><br><span class="line">                                      <span class="keyword">module</span>, ctx_index);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> rv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *ctx = saved;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建location配置树"><a href="#创建location配置树" class="headerlink" title="创建location配置树"></a>创建location配置树</h2><p>当请求到达时，需要先找到对应的server模块，再根据请求的uri找到对应的location配置块。location存储在server层级创建的ngx_http_core_loc_conf_s的locations，使用双向链表存储，这时查找效率太慢，因此为了加速查询，构建一个快速查询的树结构。其代码在http层set函数ngx_http_block。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* create location trees */</span></span><br><span class="line"><span class="comment">// cmcf为http层创建的ngx_http_core_main_conf_t</span></span><br><span class="line"><span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line">    <span class="comment">// cscfp为http层创建的ngx_http_core_main_conf_t的servers，即server层创建的ngx_http_core_srv_conf_t列表</span></span><br><span class="line">    <span class="comment">// clcf为server层创建的ngx_http_core_loc_conf_t</span></span><br><span class="line">    clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">/* 按照类型排序location，排序完后的队列：  (exact_match 或 inclusive) (排序好的，如果某个exact_match名字和inclusive location相同，exact_match排在前面)</span></span><br><span class="line"><span class="comment">   |  regex（未排序）| named(排序好的)  |  noname（未排序）*/</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_locations(cf, cscfp[s], clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建location的静态树</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>locations排序和分隔ngx_http_init_locations：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_locations(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *pclcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   n;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                 *q, *locations, *named, tail;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>   *lq;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   **clcfp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   r;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                 *regex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取server层下包含所有location</span></span><br><span class="line">    locations = pclcf-&gt;locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用ngx_http_cmp_locations对location进行排序，排序结果为(exact_match 或 inclusive) (排序好的，如果某个exact_match名字和inclusive location相同，exact_match排在前面)|  regex（未排序）| named(排序好的)  |  noname（未排序）</span></span><br><span class="line">    ngx_queue_sort(locations, ngx_http_cmp_locations);</span><br><span class="line"></span><br><span class="line">    named = <span class="literal">NULL</span>;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    regex = <span class="literal">NULL</span>;</span><br><span class="line">    r = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取regex类型的location数量和与named的分隔位置，获取named类型的location数量和其与noname的分隔位置</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_head(locations);</span><br><span class="line">         q != ngx_queue_sentinel(locations);</span><br><span class="line">         q = ngx_queue_next(q))</span><br><span class="line">    &#123;</span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">        clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;</span><br><span class="line">        <span class="comment">// 递归的对location内包含的locations进行排序和切割</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_locations(cf, <span class="literal">NULL</span>, clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;regex) &#123;</span><br><span class="line">            r++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                regex = q;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;named) &#123;</span><br><span class="line">            n++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (named == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                named = q;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于noname类型的location，找到第一个，直接结束，if和limit_except</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;noname) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果未查找到双向队列的末尾，说明含有noname，直接将noname的数据切割掉。</span></span><br><span class="line">    <span class="keyword">if</span> (q != ngx_queue_sentinel(locations)) &#123;</span><br><span class="line">        ngx_queue_split(locations, q, &amp;tail);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果找到了named的location（@），则将named的部分切割出来，存储到server层创建的ngx_http_core_srv_conf_t的named_locations中</span></span><br><span class="line">    <span class="keyword">if</span> (named) &#123;</span><br><span class="line">        clcfp = ngx_palloc(cf-&gt;pool,</span><br><span class="line">                           (n + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_core_loc_conf_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (clcfp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cscf-&gt;named_locations = clcfp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (q = named;</span><br><span class="line">             q != ngx_queue_sentinel(locations);</span><br><span class="line">             q = ngx_queue_next(q))</span><br><span class="line">        &#123;</span><br><span class="line">            lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">            *(clcfp++) = lq-&gt;exact;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *clcfp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        ngx_queue_split(locations, named, &amp;tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">// 如果存在正则匹配的location，则将正则匹配的location切割出来，放到server层创建的ngx_http_core_loc_conf_t的regex_locations中</span></span><br><span class="line">    <span class="keyword">if</span> (regex) &#123;</span><br><span class="line"></span><br><span class="line">        clcfp = ngx_palloc(cf-&gt;pool,</span><br><span class="line">                           (r + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_core_loc_conf_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (clcfp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pclcf-&gt;regex_locations = clcfp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (q = regex;</span><br><span class="line">             q != ngx_queue_sentinel(locations);</span><br><span class="line">             q = ngx_queue_next(q))</span><br><span class="line">        &#123;</span><br><span class="line">            lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">            *(clcfp++) = lq-&gt;exact;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *clcfp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        ngx_queue_split(locations, regex, &amp;tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 至此server层创建的ngx_http_core_loc_conf_t的locations中只有排序好的exact_match 或 inclusive类型的location</span></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对exact_match 或 inclusive类型的location构建静态树：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_static_location_trees(<span class="keyword">ngx_conf_t</span> *cf,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *pclcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q, *locations;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq;</span><br><span class="line"></span><br><span class="line">    locations = pclcf-&gt;locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(locations)) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 递归的对location内包含location的情况进行处理。</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_head(locations);</span><br><span class="line">         q != ngx_queue_sentinel(locations);</span><br><span class="line">         q = ngx_queue_next(q))</span><br><span class="line">    &#123;</span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">        clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 该函数把同一层次里的名称相同的不同 location 合并在一起。</span></span><br><span class="line"><span class="comment">     * "名称相同，但又是不同的 location"?</span></span><br><span class="line"><span class="comment">     * 这主要是因为 location 有绝对匹配（对应 exact 字段）和包含匹配（也就是前缀</span></span><br><span class="line"><span class="comment">     * 匹配，以指定前缀开头的都匹配上，所以是包含匹配，对应 inclusive 字段）。若</span></span><br><span class="line"><span class="comment">     * 这两个 location 的名称相同（如都为 "/"），则可以把它们共用在一个队列节点里 */</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_join_exact_locations(cf, locations) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 递归每个location节点，得到当前节点的名字为其前缀的location的列表，保存在当前节点的list字段下 这里是将前缀匹配的location进行和其他的location合并，构建一个前缀匹配的list*/</span></span><br><span class="line">    ngx_http_create_locations_list(locations, ngx_queue_head(locations));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 递归建立location三叉排序树 */</span></span><br><span class="line">    pclcf-&gt;static_locations = ngx_http_create_locations_tree(cf, locations, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pclcf-&gt;static_locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>融合exact和inclusive类型的location代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_join_exact_locations(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> *locations)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q, *x;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq, *lx;</span><br><span class="line"></span><br><span class="line">    q = ngx_queue_head(locations);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (q != ngx_queue_last(locations)) &#123;</span><br><span class="line"></span><br><span class="line">        x = ngx_queue_next(q);</span><br><span class="line"></span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">        lx = (<span class="keyword">ngx_http_location_queue_t</span> *) x;</span><br><span class="line">        <span class="comment">// 前后两个一致，则将后面的inclusive赋值到前一个inclusive，将后一个删除</span></span><br><span class="line">        <span class="keyword">if</span> (lq-&gt;name-&gt;len == lx-&gt;name-&gt;len</span><br><span class="line">            &amp;&amp; ngx_filename_cmp(lq-&gt;name-&gt;data, lx-&gt;name-&gt;data, lx-&gt;name-&gt;len)</span><br><span class="line">               == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((lq-&gt;exact &amp;&amp; lx-&gt;exact) || (lq-&gt;inclusive &amp;&amp; lx-&gt;inclusive)) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"duplicate location \"%V\" in %s:%ui"</span>,</span><br><span class="line">                              lx-&gt;name, lx-&gt;file_name, lx-&gt;line);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lq-&gt;inclusive = lx-&gt;inclusive;</span><br><span class="line"></span><br><span class="line">            ngx_queue_remove(x);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        q = ngx_queue_next(q);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构架前缀列表ngx_http_create_locations_list：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_create_locations_list(<span class="keyword">ngx_queue_t</span> *locations, <span class="keyword">ngx_queue_t</span> *q)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                     *name;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *x, tail;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq, *lx;</span><br><span class="line">    <span class="comment">// 如果当前的location是locations列表中最后一个，直接结束</span></span><br><span class="line">    <span class="keyword">if</span> (q == ngx_queue_last(locations)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">    <span class="comment">// 如果当前的location不包含前缀类型的location，则接着向后处理</span></span><br><span class="line">    <span class="keyword">if</span> (lq-&gt;inclusive == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_create_locations_list(locations, ngx_queue_next(q));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前的location包含前缀类型的location，则构建前缀列表</span></span><br><span class="line">    len = lq-&gt;name-&gt;len;</span><br><span class="line">    name = lq-&gt;name-&gt;data;</span><br><span class="line">    <span class="comment">// 找到以当前的location的name作为前缀的所有location</span></span><br><span class="line">    <span class="keyword">for</span> (x = ngx_queue_next(q);</span><br><span class="line">         x != ngx_queue_sentinel(locations);</span><br><span class="line">         x = ngx_queue_next(x))</span><br><span class="line">    &#123;</span><br><span class="line">        lx = (<span class="keyword">ngx_http_location_queue_t</span> *) x;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len &gt; lx-&gt;name-&gt;len</span><br><span class="line">            || ngx_filename_cmp(name, lx-&gt;name-&gt;data, len) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    q = ngx_queue_next(q);</span><br><span class="line">    <span class="comment">// 如果没有以当前的location的name作为前缀的所有location，则接着处理后面的列表。</span></span><br><span class="line">    <span class="keyword">if</span> (q == x) &#123;</span><br><span class="line">        ngx_http_create_locations_list(locations, x);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以当前的location将locations切割成两部分</span></span><br><span class="line">    ngx_queue_split(locations, q, &amp;tail);</span><br><span class="line">    <span class="comment">// 将后半部分location列表添加到当前location对应的ngx_http_location_queue_t成员list上</span></span><br><span class="line">    ngx_queue_add(&amp;lq-&gt;<span class="built_in">list</span>, &amp;tail);</span><br><span class="line">    <span class="comment">// 如果后半部分全部是能够以当前的location的name作为前缀的location，则直接递归处理该后半部分的location即可</span></span><br><span class="line">    <span class="keyword">if</span> (x == ngx_queue_sentinel(locations)) &#123;</span><br><span class="line">        ngx_http_create_locations_list(&amp;lq-&gt;<span class="built_in">list</span>, ngx_queue_head(&amp;lq-&gt;<span class="built_in">list</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果后半部分只有部分是能够以当前的location的name作为前缀的location，将剩余的location重新拼接到locations列表中</span></span><br><span class="line">    ngx_queue_split(&amp;lq-&gt;<span class="built_in">list</span>, x, &amp;tail);</span><br><span class="line">    ngx_queue_add(locations, &amp;tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递归处理能够以当前的location的name作为前缀的location列表</span></span><br><span class="line">    ngx_http_create_locations_list(&amp;lq-&gt;<span class="built_in">list</span>, ngx_queue_head(&amp;lq-&gt;<span class="built_in">list</span>));</span><br><span class="line">    <span class="comment">// 接着处理之后的locations</span></span><br><span class="line">    ngx_http_create_locations_list(locations, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如，对于如下的location配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /abc</span><br><span class="line">location = /abc</span><br><span class="line">location = /bdf</span><br><span class="line">location = /bdf/hl</span><br><span class="line">location ^~ /efg</span><br><span class="line">location ^~ /efghjk</span><br><span class="line">location ^~ /efghjo</span><br><span class="line">location = /efghjk/npq</span><br><span class="line">location = /fgk</span><br></pre></td></tr></table></figure>
<p>则经过ngx_http_create_locations_list后，locations结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/abc ---&gt; /bef ---&gt; /bef/hl ---&gt; /efg ---&gt; /fgk</span><br><span class="line">                                  |</span><br><span class="line">                                 \|/</span><br><span class="line">                                 /efghjk ---&gt; /efghjo</span><br><span class="line">                                  |</span><br><span class="line">                                 \|/ </span><br><span class="line">                                 /efghjk/npq</span><br></pre></td></tr></table></figure>
<p>构建静态树ngx_http_create_locations_tree：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_location_tree_node_t</span> *</span><br><span class="line">ngx_http_create_locations_tree(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> *locations,</span><br><span class="line">    <span class="keyword">size_t</span> prefix)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                          len;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                    *q, tail;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>      *lq;</span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>  *node;</span><br><span class="line">    <span class="comment">// 获取locations中间的location</span></span><br><span class="line">    q = ngx_queue_middle(locations);</span><br><span class="line"></span><br><span class="line">    lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">    len = lq-&gt;name-&gt;len - prefix;</span><br><span class="line"></span><br><span class="line">    node = ngx_palloc(cf-&gt;pool,</span><br><span class="line">                      offsetof(<span class="keyword">ngx_http_location_tree_node_t</span>, name) + len);</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node-&gt;left = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;tree = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;exact = lq-&gt;exact;</span><br><span class="line">    node-&gt;inclusive = lq-&gt;inclusive;</span><br><span class="line"></span><br><span class="line">    node-&gt;auto_redirect = (u_char) ((lq-&gt;exact &amp;&amp; lq-&gt;exact-&gt;auto_redirect)</span><br><span class="line">                           || (lq-&gt;inclusive &amp;&amp; lq-&gt;inclusive-&gt;auto_redirect));</span><br><span class="line"></span><br><span class="line">    node-&gt;len = (u_char) len;</span><br><span class="line">    ngx_memcpy(node-&gt;name, &amp;lq-&gt;name-&gt;data[prefix], len);</span><br><span class="line">    <span class="comment">// 从中间切割locations</span></span><br><span class="line">    ngx_queue_split(locations, q, &amp;tail);</span><br><span class="line">    <span class="comment">// 如果切割后locations为空，则将该location下的list（前缀列表），递归改操作。</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(locations)) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ngx_queue_split() insures that if left part is empty,</span></span><br><span class="line"><span class="comment">         * then right one is empty too</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">goto</span> inclusive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 左子树执行构建</span></span><br><span class="line">    node-&gt;left = ngx_http_create_locations_tree(cf, locations, prefix);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;left == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_queue_remove(q);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(&amp;tail)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> inclusive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 右子树执行构建</span></span><br><span class="line">    node-&gt;right = ngx_http_create_locations_tree(cf, &amp;tail, prefix);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">inclusive:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(&amp;lq-&gt;<span class="built_in">list</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node-&gt;tree = ngx_http_create_locations_tree(cf, &amp;lq-&gt;<span class="built_in">list</span>, prefix + len);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;tree == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构建出的ngx_http_location_tree_node_t结构为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_location_tree_node_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>   *left; <span class="comment">// 左子树</span></span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>   *right; <span class="comment">// 右子树</span></span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>   *tree; <span class="comment">// 当前location对应的list(前缀匹配列表)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *exact; <span class="comment">// 如果location是精准匹配，则该值执行location层级下的ngx_http_core_loc_conf_t </span></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *inclusive;<span class="comment">// 如果location是前缀匹配，则该值执行location层级下的ngx_http_core_loc_conf_t</span></span><br><span class="line"></span><br><span class="line">    u_char                           auto_redirect;</span><br><span class="line">    <span class="comment">// 计算节点所处相对于上层节点偏移长度，例如该节点是，1234，上层节点是123，则这里长度为1</span></span><br><span class="line">    u_char                           len;</span><br><span class="line">    <span class="comment">// 这里只是有一个字符，但是通过C字符串通过末尾\0来确定实际name</span></span><br><span class="line">    u_char                           name[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="http头初始化"><a href="#http头初始化" class="headerlink" title="http头初始化"></a>http头初始化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_http_init_headers_in_hash(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    return NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于每一个http头会对应到一个结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        offset;</span><br><span class="line">    ngx_http_header_handler_pt        handler;</span><br><span class="line">&#125; <span class="keyword">ngx_http_header_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中handler为请求中存在该头时的处理函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_headers_in_hash(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>         headers_in;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>     *hk;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>     hash;</span><br><span class="line">    <span class="keyword">ngx_http_header_t</span>  *header;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;headers_in, cf-&gt;temp_pool, <span class="number">32</span>, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// nginx默认包含的一批http头部，并包含对其处理，即handler函数，如Host、Connection等</span></span><br><span class="line">    <span class="keyword">for</span> (header = ngx_http_headers_in; header-&gt;name.len; header++) &#123;</span><br><span class="line">        hk = ngx_array_push(&amp;headers_in);</span><br><span class="line">        <span class="keyword">if</span> (hk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hk-&gt;key = header-&gt;name;</span><br><span class="line">        hk-&gt;key_hash = ngx_hash_key_lc(header-&gt;name.data, header-&gt;name.len);</span><br><span class="line">        hk-&gt;value = header;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// http的请求头构成的hash结构，存储于main级别创建的ngx_http_core_main_conf_t的headers_in_hash</span></span><br><span class="line">    hash.hash = &amp;cmcf-&gt;headers_in_hash;</span><br><span class="line">    <span class="comment">// 构建hash转换的函数</span></span><br><span class="line">    hash.key = ngx_hash_key_lc;</span><br><span class="line">    <span class="comment">// 最大允许的桶数量</span></span><br><span class="line">    hash.max_size = <span class="number">512</span>;</span><br><span class="line">    <span class="comment">// 每个桶最大包含的字节数</span></span><br><span class="line">    hash.bucket_size = ngx_align(<span class="number">64</span>, ngx_cacheline_size);</span><br><span class="line">    <span class="comment">// hash表名，用户日志记录</span></span><br><span class="line">    hash.name = <span class="string">"headers_in_hash"</span>;</span><br><span class="line">    hash.pool = cf-&gt;pool;</span><br><span class="line">    hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 构建hash表，详见散列表</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_init(&amp;hash, headers_in.elts, headers_in.nelts) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理阶段"><a href="#处理阶段" class="headerlink" title="处理阶段"></a>处理阶段</h2><p>main级别创建的ngx_http_core_main_conf_t的phases字段管理http处理阶段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">ngx_http_phase_t</span>           phases[NGX_HTTP_LOG_PHASE + <span class="number">1</span>];</span><br><span class="line">&#125; <span class="keyword">ngx_http_core_main_conf_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                handlers;</span><br><span class="line">&#125; <span class="keyword">ngx_http_phase_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_handler_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r)</span></span>;</span><br></pre></td></tr></table></figure>
<p>每一个阶段对应一个函数列表，每个阶段执行时，依次执行。</p>
<p>存在如下阶段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">// 收到完整的http头部后处理的阶段</span></span><br><span class="line">    NGX_HTTP_POST_READ_PHASE = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在将请求的URI与location表达式匹配前，修改请求的URI（所谓重定向）是一个独立的http阶段</span></span><br><span class="line">    NGX_HTTP_SERVER_REWRITE_PHASE,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据请求的URI寻找匹配的location表达式，该阶段只能由ngx_http_core_module模块实现，不建议其他HTTP模块重新定义该阶段</span></span><br><span class="line">    NGX_HTTP_FIND_CONFIG_PHASE,</span><br><span class="line">    <span class="comment">// 在NGX_HTTP_FIND_CONFIG_PHASE阶段寻找到匹配的location之后再修改请求的URI</span></span><br><span class="line">    NGX_HTTP_REWRITE_PHASE,</span><br><span class="line">    <span class="comment">// 该阶段是用于rewrite重新URI后，防止错误的配置导致死循环。控制方式是检查rewrite次数，超过10次就认为是有死循环，该阶段就返回500，表示服务器内部错误</span></span><br><span class="line">    NGX_HTTP_POST_REWRITE_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理NGX_HTTP_ACCESS_PHASE阶段决定访问权限前，http模块可以介入的阶段</span></span><br><span class="line">    NGX_HTTP_PREACCESS_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让HTTP模块判断是否允许这个请求访问nginx服务</span></span><br><span class="line">    NGX_HTTP_ACCESS_PHASE,</span><br><span class="line">    <span class="comment">// 在NGX_HTTP_ACCESS_PHASE阶段，如果http模块的handler处理函数返回不允许访问的错误码时，这里负责向用户发送拒绝服务的错误</span></span><br><span class="line">    NGX_HTTP_POST_ACCESS_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    NGX_HTTP_PRECONTENT_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于处理HTTP请求内容的阶段，是大部分http模块介入的阶段</span></span><br><span class="line">    NGX_HTTP_CONTENT_PHASE,</span><br><span class="line">    <span class="comment">// 处理完成后记录日志的阶段</span></span><br><span class="line">    NGX_HTTP_LOG_PHASE</span><br><span class="line">&#125; ngx_http_phases;</span><br></pre></td></tr></table></figure>
<p>有些阶段是必须的，有些阶段是可选的。上述11个阶段中NGX_HTTP_FIND_CONFIG_PHASE、NGX_HTTP_POST_REWRITE_PHASE、NGX_HTTP_POST_ACCESS_PHASE三个阶段不允许http模块加入增加的ngx_http_handler_pt方法处理用户请求，其仅由http框架实现。</p>
<h3 id="初始化处理阶段"><a href="#初始化处理阶段" class="headerlink" title="初始化处理阶段"></a>初始化处理阶段</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化处理阶段</span></span><br><span class="line"><span class="keyword">if</span> (ngx_http_init_phases(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 每个模块在postconfiguration中可以在每个阶段中增加处理</span></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">....</span><br><span class="line">*cf = pcf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ngx_http_init_phase_handlers(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ngx_http_init_phases方法会初始化必须的处理阶段到main级别创建的ngx_http_core_main_conf_t中的phases中。其中phases是一个存储每个阶段处理函数的临时变量。处理方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_phases(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 阶段0</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_POST_READ_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段1</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_SERVER_REWRITE_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段3</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段5</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段6</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_ACCESS_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">2</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段8</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_PRECONTENT_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">2</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 阶段9</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_CONTENT_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">4</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 阶段10</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_LOG_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在http初始化过程中，任何HTTP模块都可以在postconfiguration中增加自定义的方法到phases中某个阶段的数组中。</p>
<p>例如：ngx_http_index_module模块的postconfiguration方法ngx_http_index_init会添加NGX_HTTP_CONTENT_PHASE阶段处理方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_index_init(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    h = ngx_array_push(&amp;cmcf-&gt;phases[NGX_HTTP_CONTENT_PHASE].handlers);</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *h = ngx_http_index_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的NGX_HTTP_CONTENT_PHASE由ngx_http_static_module模块添加。</p>
<h3 id="请求处理阶段"><a href="#请求处理阶段" class="headerlink" title="请求处理阶段"></a>请求处理阶段</h3><p>phases只是临时存储请求阶段，真正请求时，使用的是phase_engine字段。先看一下其结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">ngx_http_phase_engine_t</span>    phase_engine;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">ngx_http_core_main_conf_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span>  *handlers; <span class="comment">// 由ngx_http_phase_handler_t构成的数组首地址，表示一个请求可能经历的所有ngx_http_phase_handler_t处理方法</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 server_rewrite_index; <span class="comment">// 表示NGX_HTTP_SERVER_REWRITE_PHASE阶段的第一个ngx_http_phase_handler_t处理方法在handlers中的下标。用于执行任意http请求时，快速跳转到NGX_HTTP_SERVER_REWRITE_PHASE处理阶段</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 location_rewrite_index;<span class="comment">// 表示NGX_HTTP_REWRITE_PHASE阶段的第一个ngx_http_phase_handler_t处理方法在handlers中的下标。用于执行任意http请求时，快速跳转到NGX_HTTP_REWRITE_PHASE处理阶段</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_phase_engine_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_phase_handler_s</span>  <span class="title">ngx_http_phase_handler_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个http处理阶段的checker检查方法，仅由http框架实现，以控制http的处理流程</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_phase_handler_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_phase_handler_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 在处理到某一个http阶段时，框架会首先在checker方法已实现的基础上先调用checker方法来处理请求，而不会调用任何阶段的handler方法。只有在checker方法中才会调用handler方法。所有checker方法均通过ngx_http_core_module模块实现，普通http模块无法重新定义 */</span></span><br><span class="line">    ngx_http_phase_handler_pt  checker;</span><br><span class="line">    <span class="comment">/* 除ngx_http_core_module模块以外的模块，只能通过定义handler方法才能介入某一个http处理阶段的处理 */</span></span><br><span class="line">    ngx_http_handler_pt        handler;</span><br><span class="line">    <span class="comment">/* next使得处理阶段可以不按照handlers定义的数组顺序执行，即可以向前跳跃数个阶段，执行之前执行过的方法，也可以向后跳跃数个阶段。通常，next表示下一个处理阶段中第一个ngx_http_phase_handler_s下标，next是用来跳转处理的过程，如何使用取决于每个阶段的处理逻辑，大部分时候还都是按照顺序，依次执行，并不是都使用next进行跳转 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在经过初始化处理阶段后，就会执行ngx_http_init_phase_handlers方法来确定阶段执行顺序。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_phase_handlers(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   j;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="comment">// find_config_index表示NGX_HTTP_FIND_CONFIG_PHASE阶段对应的在handlers中的索引。use_rewrite, use_access表示，是否使用了NGX_HTTP_REWRITE_PHASE阶段和NGX_HTTP_ACCESS_PHASE阶段（默认使用）</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  find_config_index, use_rewrite, use_access;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span>   *ph;</span><br><span class="line">    ngx_http_phase_handler_pt   checker;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;phase_engine.server_rewrite_index = (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>;</span><br><span class="line">    cmcf-&gt;phase_engine.location_rewrite_index = (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>;</span><br><span class="line">    find_config_index = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 判断是否使用NGX_HTTP_REWRITE_PHASE阶段和NGX_HTTP_ACCESS_PHASE阶段</span></span><br><span class="line">    use_rewrite = cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers.nelts ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    use_access = cmcf-&gt;phases[NGX_HTTP_ACCESS_PHASE].handlers.nelts ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NGX_HTTP_FIND_CONFIG_PHASE阶段不允许用户自己添加处理函数，因此不会在phases中存在，因此要自己分配空间</span></span><br><span class="line">    <span class="comment">// 当使用NGX_HTTP_REWRITE_PHASE阶段和NGX_HTTP_ACCESS_PHASE阶段时，就会相应的增加NGX_HTTP_POST_REWRITE_PHASE阶段和NGX_HTTP_POST_ACCESS_PHASE阶段，这两个阶段也是不允许用户自己添加处理函数，因此不会在phases中存在，因此要自己分配空间。</span></span><br><span class="line">    n = <span class="number">1</span>                  <span class="comment">/* find config phase */</span></span><br><span class="line">        + use_rewrite      <span class="comment">/* post rewrite phase */</span></span><br><span class="line">        + use_access;      <span class="comment">/* post access phase */</span></span><br><span class="line">    <span class="comment">// 查找除了上面三个阶段以外，其他阶段总共有多少个处理函数</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) &#123;</span><br><span class="line">        n += cmcf-&gt;phases[i].handlers.nelts;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配空间</span></span><br><span class="line">    ph = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                     n * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_phase_handler_t</span>) + <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="keyword">if</span> (ph == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;phase_engine.handlers = ph;</span><br><span class="line">    <span class="comment">// n表示下一个要加入到phase_engine数组中元素的下标</span></span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历每个阶段进行处理</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) &#123;</span><br><span class="line">        h = cmcf-&gt;phases[i].handlers.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">        <span class="comment">// NGX_HTTP_SERVER_REWRITE_PHASE阶段，n即当前阶段的第一个ngx_http_phase_handler_s，因此phase_engine.server_rewrite_index指向该值</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_SERVER_REWRITE_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (cmcf-&gt;phase_engine.server_rewrite_index == (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                cmcf-&gt;phase_engine.server_rewrite_index = n;</span><br><span class="line">            &#125;</span><br><span class="line">            checker = ngx_http_core_rewrite_phase;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// NGX_HTTP_FIND_CONFIG_PHASE阶段，由于该阶段不允许用户自定义处理方法，因此直接指定checker方法，将本身添加到phase_engine队列中，忽略用户在phase中增加的处理函数，并使用find_config_index记录该阶段在phase_engine队列的下标，这里未设置next值，与checker函数本身有关，具体参加下一小节</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_FIND_CONFIG_PHASE:</span><br><span class="line">            find_config_index = n;</span><br><span class="line"></span><br><span class="line">            ph-&gt;checker = ngx_http_core_find_config_phase;</span><br><span class="line">            n++;</span><br><span class="line">            ph++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// NGX_HTTP_REWRITE_PHASE阶段，处理逻辑与NGX_HTTP_SERVER_REWRITE_PHASE类似</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_REWRITE_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (cmcf-&gt;phase_engine.location_rewrite_index == (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                cmcf-&gt;phase_engine.location_rewrite_index = n;</span><br><span class="line">            &#125;</span><br><span class="line">            checker = ngx_http_core_rewrite_phase;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// NGX_HTTP_POST_REWRITE_PHASE阶段，如果用户使用了NGX_HTTP_REWRITE_PHASE阶段，则需要增加该阶段，阶段处理结束后，执行NGX_HTTP_FIND_CONFIG_PHASE阶段，因此next使用之前存储的find_config_index值，且该阶段不允许用户自定义处理函数</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_POST_REWRITE_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (use_rewrite) &#123;</span><br><span class="line">                ph-&gt;checker = ngx_http_core_post_rewrite_phase;</span><br><span class="line">                ph-&gt;next = find_config_index;</span><br><span class="line">                n++;</span><br><span class="line">                ph++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* NGX_HTTP_ACCESS_PHASE阶段，这里在未将该阶段加入phase_engine时，就对n进行增加是和其下一阶段NGX_HTTP_POST_ACCESS_PHASE有关。当存在该阶段时，如果校验权限为无权限时，执行NGX_HTTP_POST_ACCESS_PHASE阶段，这时只需要依次执行phase_engine数组即可，当校验有权限时，则有可能（取决于是要全部校验通过，还是任意一个条件满足）直接跳转到NGX_HTTP_POST_ACCESS_PHASE后面的一个阶段。由于NGX_HTTP_POST_ACCESS_PHASE只会有一个元素，因此这里增加1后，执行的就是NGX_HTTP_POST_ACCESS_PHASE阶段后一个阶段的第一个处理元素。但这里我感觉有一个bug，就是在没有该阶段的时候，即用户未在该阶段注册函数时，就会导致NGX_HTTP_POST_ACCESS_PHASE后面阶段的next指向混乱，不知道是我哪里没看明白还是怎么回事。不过当前默认是存在该模块的（将框架里面的模块会向该模块增加处理函数）*/</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_ACCESS_PHASE:</span><br><span class="line">            checker = ngx_http_core_access_phase;</span><br><span class="line">            n++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 只有当存在NGX_HTTP_ACCESS_PHASE阶段时才会增加该阶段。由于在NGX_HTTP_ACCESS_PHASE阶段已经将n指向了该阶段后的一个阶段的第一个处理元素，因此其next直接使用n即可（正常来说，直接就返回了，也不会有后续处理了）。该阶段不允许用户增加处理函数。</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_POST_ACCESS_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (use_access) &#123;</span><br><span class="line">                ph-&gt;checker = ngx_http_core_post_access_phase;</span><br><span class="line">                ph-&gt;next = n;</span><br><span class="line">                ph++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// NGX_HTTP_CONTENT_PHASE阶段，不允许用户增加自定义处理函数</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_CONTENT_PHASE:</span><br><span class="line">            checker = ngx_http_core_content_phase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 默认处理模块</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            checker = ngx_http_core_generic_phase;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// n增加当前模块的处理函数数量，这时n就指向了下一个模块的第一个处理元素了（NGX_HTTP_ACCESS_PHASE阶段除外，其在之前先让那个n自增了1）</span></span><br><span class="line">        n += cmcf-&gt;phases[i].handlers.nelts;</span><br><span class="line">        <span class="comment">// 遍历当前阶段的handlers数组，增加phase_engine元素，每个元素的next都设置为下一个阶段的第一个处理函数。但这里赋值顺序和添加顺序是相反的，目前也不知道具体原因</span></span><br><span class="line">        <span class="keyword">for</span> (j = cmcf-&gt;phases[i].handlers.nelts - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            ph-&gt;checker = checker;</span><br><span class="line">            ph-&gt;handler = h[j];</span><br><span class="line">            ph-&gt;next = n;</span><br><span class="line">            ph++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="每个阶段的checker函数"><a href="#每个阶段的checker函数" class="headerlink" title="每个阶段的checker函数"></a>每个阶段的checker函数</h3><h2 id="核心模块收尾"><a href="#核心模块收尾" class="headerlink" title="核心模块收尾"></a>核心模块收尾</h2><p>在执行完子模块的解析后，会执行核心模块的ctx的init_conf方法。其执行顺序完成ngx_conf_parse函数后，其代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;init_conf) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;init_conf(cycle,</span><br><span class="line">                              cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index])</span><br><span class="line">            == NGX_CONF_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            environ = senv;</span><br><span class="line">            ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里执行核心模块的init_conf，对核心模块所关系的内容，根据之前的解析，进行完整的赋值。</p>
<p>因此各个模块到此，其解析过程为：</p>
<ol>
<li>首先执行核心模块的ctx成员的create_conf方法。</li>
<li>在每个核心模块中，执行其管理的模块的create_*_conf类（如create_conf,create_main_conf,preconfiguration）方法。</li>
<li>在每个核心模块中，执行其管理的模块的ini_*_conf类(如init_conf，init_main_conf，merge_srv_conf，merge_loc_conf)方法。</li>
<li>最后执行核心模块的ctx成员的create_conf方法。</li>
</ol>
<h1 id="事件模块"><a href="#事件模块" class="headerlink" title="事件模块"></a>事件模块</h1><h2 id="解析配置-1"><a href="#解析配置-1" class="headerlink" title="解析配置"></a>解析配置</h2><p>在linux下，默认的事件模块包含如下三部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_module_t</span> *ngx_modules[] = &#123;</span><br><span class="line">    ...</span><br><span class="line">    &amp;ngx_events_module, <span class="comment">// 核心模块，管理所有事件模块</span></span><br><span class="line">    &amp;ngx_event_core_module, <span class="comment">// 事件的核心模块</span></span><br><span class="line">    &amp;ngx_epoll_module, <span class="comment">// epoll模块</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-events-module模块"><a href="#ngx-events-module模块" class="headerlink" title="ngx_events_module模块"></a>ngx_events_module模块</h3><p>其内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_events_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"events"</span>),</span><br><span class="line">      NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span><br><span class="line">      ngx_events_block,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_core_module_t</span>  ngx_events_module_ctx = &#123;</span><br><span class="line">    ngx_string(<span class="string">"events"</span>),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    ngx_event_init_conf</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_module_t</span>  ngx_events_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_events_module_ctx,                <span class="comment">/* module context */</span></span><br><span class="line">    ngx_events_commands,                   <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_CORE_MODULE,                       <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init master */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init module */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其不存在module的create_conf方法。只存在init_conf方法。</p>
<p>因此其执行顺序为：ngx_events_commands指定的配置解析-&gt;init_conf。这两步均在init_cycle函数中执行。</p>
<h4 id="comands数组处理函数"><a href="#comands数组处理函数" class="headerlink" title="comands数组处理函数"></a>comands数组处理函数</h4><h5 id="envents：ngx-events-block"><a href="#envents：ngx-events-block" class="headerlink" title="envents：ngx_events_block"></a>envents：ngx_events_block</h5><p>执行模块的commands时执行函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_events_block(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                 *rv;</span><br><span class="line">    <span class="keyword">void</span>               ***ctx;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            i;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>            pcf;</span><br><span class="line">    <span class="keyword">ngx_event_module_t</span>   *m;</span><br><span class="line">    <span class="comment">// 如果配置不为空，说明已经被解析过，发送了重复配置</span></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">void</span> **) conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* count the number of the event modules and set up their indices */</span></span><br><span class="line">    <span class="comment">// 获取事件模块数量，并对事件模块的ctx_index赋值</span></span><br><span class="line">    ngx_event_max_module = ngx_count_modules(cf-&gt;cycle, NGX_EVENT_MODULE);</span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *ctx = ngx_pcalloc(cf-&gt;pool, ngx_event_max_module * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="keyword">if</span> (*ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">void</span> **) conf = ctx;</span><br><span class="line">    <span class="comment">// 执行每个事件模块的ctx的create_conf方法。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_EVENT_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m = cf-&gt;cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m-&gt;create_conf) &#123;</span><br><span class="line">            (*ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] =</span><br><span class="line">                                                     m-&gt;create_conf(cf-&gt;cycle);</span><br><span class="line">            <span class="keyword">if</span> ((*ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 变更cf，使其解析事件块配置</span></span><br><span class="line">    pcf = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    cf-&gt;module_type = NGX_EVENT_MODULE;</span><br><span class="line">    cf-&gt;cmd_type = NGX_EVENT_CONF;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> rv;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对于每个事件模块，执行其ctx的init_conf方法。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_EVENT_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m = cf-&gt;cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m-&gt;init_conf) &#123;</span><br><span class="line">            rv = m-&gt;init_conf(cf-&gt;cycle,</span><br><span class="line">                              (*ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> rv;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ctx的init-conf-ngx-event-init-conf"><a href="#ctx的init-conf-ngx-event-init-conf" class="headerlink" title="ctx的init_conf:ngx_event_init_conf"></a>ctx的init_conf:ngx_event_init_conf</h4><p>在执行完成所有事件配置解析后，会调用核心事件模块ngx_envents_module的init_conf方法，其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_event_init_conf(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>  *ls;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_get_conf(cycle-&gt;conf_ctx, ngx_events_module) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"no \"events\" section in configuration"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// connection_n为每个work进程允许同时处理的的最大连接数（下文会详细介绍），如果该值小于需要监听的套接字数量，则报错。</span></span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;connection_n &lt; cycle-&gt;listening.nelts + <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * there should be at least one connection for each listening</span></span><br><span class="line"><span class="comment">         * socket, plus an additional connection for channel</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"%ui worker_connections are not enough "</span></span><br><span class="line">                      <span class="string">"for %ui listening sockets"</span>,</span><br><span class="line">                      cycle-&gt;connection_n, cycle-&gt;listening.nelts);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">    <span class="comment">// 如果系统支持端口复用，则对配置了端口复用的套接字进行拷贝，为每个worker进程拷贝一份监听地址</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 如果未设置端口复用或者本身是复制的地址，则跳过</span></span><br><span class="line">        <span class="keyword">if</span> (!ls[i].reuseport || ls[i].worker != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将ls的地址复制worker子进程减一份（自身存在一份），复制后，每个复制的结构中worker不为0，因此在下次循环时直接跳过</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_clone_listening(cycle, &amp;ls[i]) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* cloning may change cycle-&gt;listening.elts */</span></span><br><span class="line">        <span class="comment">// 由于在array数组中添加元素，可能导致内存迁移（空间不够时，因此更新当前ls指向地址）</span></span><br><span class="line">        ls = cycle-&gt;listening.elts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>复制监听地址的逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_clone_listening(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_listening_t</span> *ls)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>         n;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   ols;</span><br><span class="line">    <span class="comment">// 如果监听地址未配置复用端口，或者本身就是复制的地址，则返回</span></span><br><span class="line">    <span class="keyword">if</span> (!ls-&gt;reuseport || ls-&gt;worker != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ols存储ls的内容（不是地址）</span></span><br><span class="line">    ols = *ls;</span><br><span class="line">   <span class="comment">// 获取worker进程数量</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    <span class="comment">// 从1开始遍历，创建worker进程数减一的复制量</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; ccf-&gt;worker_processes; n++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* create a socket for each worker process */</span></span><br><span class="line">        <span class="comment">// 向数组中添加元素</span></span><br><span class="line">        ls = ngx_array_push(&amp;cycle-&gt;listening);</span><br><span class="line">        <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置内容</span></span><br><span class="line">        *ls = ols;</span><br><span class="line">        <span class="comment">// 变更worker</span></span><br><span class="line">        ls-&gt;worker = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，执行核心module的init_conf在打开监听套接字之前，即克隆监听套接字也是在实际监听之前。</p>
<h3 id="ngx-event-core-module模块"><a href="#ngx-event-core-module模块" class="headerlink" title="ngx_event_core_module模块"></a>ngx_event_core_module模块</h3><p>ngx_event_core_module模块为事件模块的核心模块。其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_str_t</span>  event_core_name = ngx_string(<span class="string">"event_core"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_event_core_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"worker_connections"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_event_connections,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"use"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_event_use,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"multi_accept"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_FLAG,</span><br><span class="line">      ngx_conf_set_flag_slot,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      offsetof(<span class="keyword">ngx_event_conf_t</span>, multi_accept),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"accept_mutex"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_FLAG,</span><br><span class="line">      ngx_conf_set_flag_slot,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      offsetof(<span class="keyword">ngx_event_conf_t</span>, accept_mutex),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"accept_mutex_delay"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_conf_set_msec_slot,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      offsetof(<span class="keyword">ngx_event_conf_t</span>, accept_mutex_delay),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"debug_connection"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_event_debug_connection,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_event_module_t</span>  ngx_event_core_module_ctx = &#123;</span><br><span class="line">    &amp;event_core_name,</span><br><span class="line">    ngx_event_core_create_conf,            <span class="comment">/* create configuration */</span></span><br><span class="line">    ngx_event_core_init_conf,              <span class="comment">/* init configuration */</span></span><br><span class="line"></span><br><span class="line">    &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_module_t</span>  ngx_event_core_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_event_core_module_ctx,            <span class="comment">/* module context */</span></span><br><span class="line">    ngx_event_core_commands,               <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_EVENT_MODULE,                      <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init master */</span></span><br><span class="line">    ngx_event_module_init,                 <span class="comment">/* init module */</span></span><br><span class="line">    ngx_event_process_init,                <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="相关数据结构-3"><a href="#相关数据结构-3" class="headerlink" title="相关数据结构"></a>相关数据结构</h4><h5 id="ngx-event-module-t"><a href="#ngx-event-module-t" class="headerlink" title="ngx_event_module_t"></a>ngx_event_module_t</h5><p>ngx_event_module_t为事件模块（非核心模块）的ctx执行的结构体，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>              *name; <span class="comment">// 对应模块名称，用于根据配置查找</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>                 *(*create_conf)(<span class="keyword">ngx_cycle_t</span> *cycle); <span class="comment">// 模块的create_conf，创建存储在conf_ctx中的结构体</span></span><br><span class="line">    <span class="keyword">char</span>                 *(*init_conf)(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *conf); <span class="comment">// 对创建的结构体初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_event_actions_t</span>     actions; <span class="comment">// 存储事件对应处理函数的结构体</span></span><br><span class="line">&#125; <span class="keyword">ngx_event_module_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中ngx_event_actions_t定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 添加事件方法，负责将一个事件添加到系统提供的事件驱动机制（epoll，select，poll等）中。后续通过在事件发生时通过process_events获取事件 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*add)(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_int_t</span> event, <span class="keyword">ngx_uint_t</span> flags);</span><br><span class="line">    <span class="comment">/* 删除事件方法。将一个事件从系统提供的事件驱动机制中删除 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*del)(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_int_t</span> event, <span class="keyword">ngx_uint_t</span> flags);</span><br><span class="line">    <span class="comment">/* 启用一个事件，目前事件框架不会调用该函数，大部分事件驱动模块对该方法的实现与add一致 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*enable)(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_int_t</span> event, <span class="keyword">ngx_uint_t</span> flags);</span><br><span class="line">    <span class="comment">/* 禁用一个事件，目前事件框架不会调用该函数，大部分事件驱动模块对该方法的实现与delete一致 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*disable)(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_int_t</span> event, <span class="keyword">ngx_uint_t</span> flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 向事件驱动机制中添加一个新的连接，意味着该连接上的读写事件都添加到事件驱动机制中了 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*add_conn)(<span class="keyword">ngx_connection_t</span> *c);</span><br><span class="line">    <span class="comment">/* 向事件驱动机制中删除一个连接 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*del_conn)(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_uint_t</span> flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*notify)(ngx_event_handler_pt handler);</span><br><span class="line">    <span class="comment">/* 正常工作循环中，通过调用process_events方法来处理事件，其为处理、分发事件的核心 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*process_events)(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_msec_t</span> timer,</span><br><span class="line">                                 <span class="keyword">ngx_uint_t</span> flags);</span><br><span class="line">    <span class="comment">/* 初始化事件驱动模块的方法 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>  (*init)(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_msec_t</span> timer);</span><br><span class="line">    <span class="comment">/* 退出事件驱动模块前调用的方法 */</span></span><br><span class="line">    <span class="keyword">void</span>       (*done)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">&#125; <span class="keyword">ngx_event_actions_t</span>;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-event-conf-t"><a href="#ngx-event-conf-t" class="headerlink" title="ngx_event_conf_t"></a>ngx_event_conf_t</h5><p>该类为ngx_event_core_module在conf_ctx中构建的结构体，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 每个worker进程最大同时处理的链接数量，对应worker_connections配置</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>    connections;</span><br><span class="line">    <span class="comment">// 选择的事件驱动模块在所有事件模块中的序号，即ctx_index值，对应use配置</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>    use;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否批量建立新连接，当事件模块通知有新连接时，尽可能对本次调度中客户端发起的所有TCP请求都建立连接。对应multi_accept配置</span></span><br><span class="line">    <span class="keyword">ngx_flag_t</span>    multi_accept;</span><br><span class="line">    <span class="comment">//是否打开accept锁，对应accept_mutex配置</span></span><br><span class="line">    <span class="keyword">ngx_flag_t</span>    accept_mutex;</span><br><span class="line">    <span class="comment">// 使用accept锁时，间隔获取锁的时间间隔。及如果一次没有获取到锁，则最少等待指定的时间才能再次尝试获取锁。对应accept_mutex_delay配置</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>    accept_mutex_delay;</span><br><span class="line">    <span class="comment">// 所选用的事件驱动的名字，对应use配置</span></span><br><span class="line">    u_char       *name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">    <span class="comment">// 针对特定的IP地址或者CIDR地址的请求输出debug级别日志，其他请求依然使用error_log中配置的日志级别，对应debug_connection配置</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>   debug_connection;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">ngx_event_conf_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ctx的create-conf函数：ngx-event-core-create-conf"><a href="#ctx的create-conf函数：ngx-event-core-create-conf" class="headerlink" title="ctx的create_conf函数：ngx_event_core_create_conf"></a>ctx的create_conf函数：ngx_event_core_create_conf</h4><p>其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">ngx_event_core_create_conf(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>  *ecf;</span><br><span class="line">    <span class="comment">// 分配ngx_event_conf_t结构体空间</span></span><br><span class="line">    ecf = ngx_palloc(cycle-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_event_conf_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ecf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置初值为未定义</span></span><br><span class="line">    ecf-&gt;connections = NGX_CONF_UNSET_UINT;</span><br><span class="line">    ecf-&gt;use = NGX_CONF_UNSET_UINT;</span><br><span class="line">    ecf-&gt;multi_accept = NGX_CONF_UNSET;</span><br><span class="line">    ecf-&gt;accept_mutex = NGX_CONF_UNSET;</span><br><span class="line">    ecf-&gt;accept_mutex_delay = NGX_CONF_UNSET_MSEC;</span><br><span class="line">    ecf-&gt;name = (<span class="keyword">void</span> *) NGX_CONF_UNSET;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ecf-&gt;debug_connection, cycle-&gt;pool, <span class="number">4</span>,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_cidr_t</span>)) == NGX_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ecf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="comands中对应配置的处理"><a href="#comands中对应配置的处理" class="headerlink" title="comands中对应配置的处理"></a>comands中对应配置的处理</h4><p>这里只介绍非通用的方法，对于系统定义的一些通用解析配置方式，可参考配置解析一章中的详细说明。</p>
<h5 id="worker-connections配置解析方法"><a href="#worker-connections配置解析方法" class="headerlink" title="worker_connections配置解析方法"></a>worker_connections配置解析方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_event_connections(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>  *ecf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>  *value;</span><br><span class="line">    <span class="comment">// 如果已经定义过该值，则说明配置中重复定义了，返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (ecf-&gt;connections != NGX_CONF_UNSET_UINT) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取配置解析中的数组</span></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 设置对应的数量</span></span><br><span class="line">    ecf-&gt;connections = ngx_atoi(value[<span class="number">1</span>].data, value[<span class="number">1</span>].len);</span><br><span class="line">    <span class="keyword">if</span> (ecf-&gt;connections == (<span class="keyword">ngx_uint_t</span>) NGX_ERROR) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid number \"%V\""</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对全局的cycle中的connection_n进行设置</span></span><br><span class="line">    cf-&gt;cycle-&gt;connection_n = ecf-&gt;connections;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="use配置解析方法"><a href="#use配置解析方法" class="headerlink" title="use配置解析方法"></a>use配置解析方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_event_use(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>  *ecf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>             m;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>            *value;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>     *old_ecf;</span><br><span class="line">    <span class="keyword">ngx_event_module_t</span>   *<span class="keyword">module</span>;</span><br><span class="line">    <span class="comment">// 判断是否重复配置</span></span><br><span class="line">    <span class="keyword">if</span> (ecf-&gt;use != NGX_CONF_UNSET_UINT) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 获取旧版本的cycle中对应的ngx_event_core_module创建的ngx_event_conf_t</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;old_cycle-&gt;conf_ctx) &#123;</span><br><span class="line">        old_ecf = ngx_event_get_conf(cf-&gt;cycle-&gt;old_cycle-&gt;conf_ctx,</span><br><span class="line">                                     ngx_event_core_module);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        old_ecf = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有模块，找到事件模块的名字与use后配置一致的一个模块</span></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_EVENT_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;name-&gt;len == value[<span class="number">1</span>].len) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_strcmp(<span class="keyword">module</span>-&gt;name-&gt;data, value[<span class="number">1</span>].data) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 设置use为对应模块的ctx_index和name值</span></span><br><span class="line">                ecf-&gt;use = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line">                ecf-&gt;name = <span class="keyword">module</span>-&gt;name-&gt;data;</span><br><span class="line">                <span class="comment">// 如果老的事件模块和新的事件模块不一致，则报错（热加载配置时）</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_process == NGX_PROCESS_SINGLE</span><br><span class="line">                    &amp;&amp; old_ecf</span><br><span class="line">                    &amp;&amp; old_ecf-&gt;use != ecf-&gt;use)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"when the server runs without a master process "</span></span><br><span class="line">                               <span class="string">"the \"%V\" event type must be the same as "</span></span><br><span class="line">                               <span class="string">"in previous configuration - \"%s\" "</span></span><br><span class="line">                               <span class="string">"and it cannot be changed on the fly, "</span></span><br><span class="line">                               <span class="string">"to change it you need to stop server "</span></span><br><span class="line">                               <span class="string">"and start it again"</span>,</span><br><span class="line">                               &amp;value[<span class="number">1</span>], old_ecf-&gt;name);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"invalid event type \"%V\""</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// 如果没有找到对应的配置（可能系统不支持），则报错返回</span></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="debug-connections配置解析方法"><a href="#debug-connections配置解析方法" class="headerlink" title="debug_connections配置解析方法"></a>debug_connections配置解析方法</h5><h4 id="ctx的init-conf函数：ngx-event-core-init-conf"><a href="#ctx的init-conf函数：ngx-event-core-init-conf" class="headerlink" title="ctx的init_conf函数：ngx_event_core_init_conf"></a>ctx的init_conf函数：ngx_event_core_init_conf</h4><p>在执行完成commands方法后，会运行ctx的init_conf方法，对ngx_event_conf_t完成初始化。其方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_event_core_init_conf(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>  *ecf = conf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLL) &amp;&amp; !(NGX_TEST_BUILD_EPOLL)</span></span><br><span class="line">    <span class="keyword">int</span>                  fd;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>            i;</span><br><span class="line">    <span class="keyword">ngx_module_t</span>        *<span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">ngx_event_module_t</span>  *event_module;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLL) &amp;&amp; !(NGX_TEST_BUILD_EPOLL)</span></span><br><span class="line">    <span class="comment">// 尝试调用epoll事件驱动模块的create函数，验证是否可以使用epoll模块</span></span><br><span class="line">    fd = epoll_create(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        (<span class="keyword">void</span>) close(fd);</span><br><span class="line">        <span class="comment">// 设置模块为ngx_epoll_module</span></span><br><span class="line">        <span class="keyword">module</span> = &amp;ngx_epoll_module;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ngx_errno != NGX_ENOSYS) &#123;</span><br><span class="line">        <span class="keyword">module</span> = &amp;ngx_epoll_module;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEVPOLL) &amp;&amp; !(NGX_TEST_BUILD_DEVPOLL)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = &amp;ngx_devpoll_module;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = &amp;ngx_kqueue_module;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SELECT)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">module</span> = &amp;ngx_select_module;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 如果未找到事件驱动模块，则遍历所有事件驱动模块，找到第一个可用的事件驱动模块</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;type != NGX_EVENT_MODULE) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            event_module = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line">            <span class="comment">// 核心事件模块负责管理，不能作为事件驱动模块</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_strcmp(event_module-&gt;name-&gt;data, event_core_name.data) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">module</span> = cycle-&gt;modules[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有可用的，则报错</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"no events module found"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对ngx_event_conf_t中未在配置中设置的值设置初值</span></span><br><span class="line">    ngx_conf_init_uint_value(ecf-&gt;connections, DEFAULT_CONNECTIONS);</span><br><span class="line">    cycle-&gt;connection_n = ecf-&gt;connections;</span><br><span class="line"></span><br><span class="line">    ngx_conf_init_uint_value(ecf-&gt;use, <span class="keyword">module</span>-&gt;ctx_index);</span><br><span class="line"></span><br><span class="line">    event_module = <span class="keyword">module</span>-&gt;ctx;</span><br><span class="line">    ngx_conf_init_ptr_value(ecf-&gt;name, event_module-&gt;name-&gt;data);</span><br><span class="line"></span><br><span class="line">    ngx_conf_init_value(ecf-&gt;multi_accept, <span class="number">0</span>);</span><br><span class="line">    ngx_conf_init_value(ecf-&gt;accept_mutex, <span class="number">0</span>);</span><br><span class="line">    ngx_conf_init_msec_value(ecf-&gt;accept_mutex_delay, <span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="module的init-module方法"><a href="#module的init-module方法" class="headerlink" title="module的init_module方法"></a>module的init_module方法</h4><p>在执行完成配置解析后，在init_cycle初始化cycle的结尾（关闭无用资源前）会执行每个模块的init_module方法（在进入worker子进程前）。事件核心模块具有该方法，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_event_module_init(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>              ***cf;</span><br><span class="line">    u_char              *shared;</span><br><span class="line">    <span class="keyword">size_t</span>               size, cl;</span><br><span class="line">    <span class="keyword">ngx_shm_t</span>            shm;</span><br><span class="line">    <span class="keyword">ngx_time_t</span>          *tp;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>     *ccf;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>    *ecf;</span><br><span class="line">    <span class="comment">// 获取事件模块对应的ngx_core_conf_t</span></span><br><span class="line">    cf = ngx_get_conf(cycle-&gt;conf_ctx, ngx_events_module);</span><br><span class="line">    <span class="comment">// 获取实际使用的事件驱动模块</span></span><br><span class="line">    ecf = (*cf)[ngx_event_core_module.ctx_index];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ngx_test_config &amp;&amp; ngx_process &lt;= NGX_PROCESS_MASTER) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"using the \"%s\" event method"</span>, ecf-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    <span class="comment">// 设置调用gettimeofday()来更新缓存时钟的事件间隔，由timer_resolution配置项在核心模块解析</span></span><br><span class="line">    ngx_timer_resolution = ccf-&gt;timer_resolution;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(NGX_WIN32)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>      limit;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span>  <span class="title">rlmt</span>;</span></span><br><span class="line">    <span class="comment">// 获取进程允许创建的文件描述符数量</span></span><br><span class="line">    <span class="keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;rlmt) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"getrlimit(RLIMIT_NOFILE) failed, ignored"</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* ccf-&gt;rlimit_nofile是配置中指定的worker子进程打开文件描述符大小限制，可以通过setrlimit设置该值，如果每个子进程设置的能够同时处理的连接数量，大于进程限制的描述符数量或者配置的描述符数量，则记录一个错误 */</span></span><br><span class="line">        <span class="keyword">if</span> (ecf-&gt;connections &gt; (<span class="keyword">ngx_uint_t</span>) rlmt.rlim_cur</span><br><span class="line">            &amp;&amp; (ccf-&gt;rlimit_nofile == NGX_CONF_UNSET</span><br><span class="line">                || ecf-&gt;connections &gt; (<span class="keyword">ngx_uint_t</span>) ccf-&gt;rlimit_nofile))</span><br><span class="line">        &#123;</span><br><span class="line">            limit = (ccf-&gt;rlimit_nofile == NGX_CONF_UNSET) ?</span><br><span class="line">                         (<span class="keyword">ngx_int_t</span>) rlmt.rlim_cur : ccf-&gt;rlimit_nofile;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_WARN, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui worker_connections exceed "</span></span><br><span class="line">                          <span class="string">"open file resource limit: %i"</span>,</span><br><span class="line">                          ecf-&gt;connections, limit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !(NGX_WIN32) */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是非master-worker模式运行，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;master == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果已经设置了accept指针（进程间实现负载均衡的锁），则直接返回。（在重新加载配置文件时，直接返回）</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_accept_mutex_ptr) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* cl should be equal to or greater than cache line size */</span></span><br><span class="line">    <span class="comment">// 创建每个进程共用的变量，通过mmap（内存映射）创建公用空间</span></span><br><span class="line">    cl = <span class="number">128</span>;</span><br><span class="line">    <span class="comment">// 申请内存映射的空间大小</span></span><br><span class="line">    size = cl            <span class="comment">/* ngx_accept_mutex */</span> <span class="comment">// 负载均衡锁使用空间</span></span><br><span class="line">           + cl          <span class="comment">/* ngx_connection_counter */</span> <span class="comment">// 连接数量使用空间</span></span><br><span class="line">           + cl;         <span class="comment">/* ngx_temp_number */</span> <span class="comment">// temp number使用空间</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line"></span><br><span class="line">    size += cl           <span class="comment">/* ngx_stat_accepted */</span></span><br><span class="line">           + cl          <span class="comment">/* ngx_stat_handled */</span></span><br><span class="line">           + cl          <span class="comment">/* ngx_stat_requests */</span></span><br><span class="line">           + cl          <span class="comment">/* ngx_stat_active */</span></span><br><span class="line">           + cl          <span class="comment">/* ngx_stat_reading */</span></span><br><span class="line">           + cl          <span class="comment">/* ngx_stat_writing */</span></span><br><span class="line">           + cl;         <span class="comment">/* ngx_stat_waiting */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 初始化共享内存结构ngx_shm_t</span></span><br><span class="line">    shm.size = size;</span><br><span class="line">    ngx_str_set(&amp;shm.name, <span class="string">"nginx_shared_zone"</span>);</span><br><span class="line">    shm.<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">// 按照size分配内存映射区域，具体参考共享内存部分</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_shm_alloc(&amp;shm) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取分配的mmap地址</span></span><br><span class="line">    shared = shm.addr;</span><br><span class="line">    <span class="comment">// ngx_accept_mutex_ptr指向mmap分配的起始地址（使用第一个128空间）</span></span><br><span class="line">    ngx_accept_mutex_ptr = (<span class="keyword">ngx_atomic_t</span> *) shared;</span><br><span class="line">    <span class="comment">// 不使用信号量</span></span><br><span class="line">    ngx_accept_mutex.spin = (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 创建负载均衡锁，具体参考锁机制章节</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_shmtx_create(&amp;ngx_accept_mutex, (<span class="keyword">ngx_shmtx_sh_t</span> *) shared,</span><br><span class="line">                         cycle-&gt;lock_file.data)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ngx_connection_counter使用第二个mmap分配的128空间</span></span><br><span class="line">    ngx_connection_counter = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">1</span> * cl);</span><br><span class="line">    <span class="comment">// 设置值初始值为1</span></span><br><span class="line">    (<span class="keyword">void</span>) ngx_atomic_cmp_set(ngx_connection_counter, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"counter: %p, %uA"</span>,</span><br><span class="line">                   ngx_connection_counter, *ngx_connection_counter);</span><br><span class="line">    <span class="comment">// ngx_temp_number使用第三个mmap分配的128空间</span></span><br><span class="line">    ngx_temp_number = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">2</span> * cl);</span><br><span class="line">    <span class="comment">// 通过时间和pid设置ngx_random_number值</span></span><br><span class="line">    tp = ngx_timeofday();</span><br><span class="line"></span><br><span class="line">    ngx_random_number = (tp-&gt;msec &lt;&lt; <span class="number">16</span>) + ngx_pid;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line"></span><br><span class="line">    ngx_stat_accepted = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">3</span> * cl);</span><br><span class="line">    ngx_stat_handled = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">4</span> * cl);</span><br><span class="line">    ngx_stat_requests = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">5</span> * cl);</span><br><span class="line">    ngx_stat_active = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">6</span> * cl);</span><br><span class="line">    ngx_stat_reading = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">7</span> * cl);</span><br><span class="line">    ngx_stat_writing = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">8</span> * cl);</span><br><span class="line">    ngx_stat_waiting = (<span class="keyword">ngx_atomic_t</span> *) (shared + <span class="number">9</span> * cl);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于进程资源限制的内容可以查看如下文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%87%BD%E6%95%B0getrlimit%E5%92%8Csetrlimit" target="_blank" rel="noopener">进程资源信息</a>。</p>
<h4 id="module的init-process方法"><a href="#module的init-process方法" class="headerlink" title="module的init_process方法"></a>module的init_process方法</h4><p>在启动worker子进程后，会先执行相应的初始化工作，这时会调用所有模块的init_process方法。事件核心模块的该方法执行逻辑如下：这部分的代码涉及后续的内容较多，可以先查阅本章的事件处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_event_process_init(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>           m, i;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>         *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>     *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>    *c, *next, *old;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>     *ccf;</span><br><span class="line">    <span class="keyword">ngx_event_conf_t</span>    *ecf;</span><br><span class="line">    <span class="keyword">ngx_event_module_t</span>  *<span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    ecf = ngx_event_get_conf(cycle-&gt;conf_ctx, ngx_event_core_module);</span><br><span class="line">    <span class="comment">// 如果是master-workers模式运行，且子进程数量大于1，并且使用负载均衡锁，则对相应的全局变量赋值。</span></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;master &amp;&amp; ccf-&gt;worker_processes &gt; <span class="number">1</span> &amp;&amp; ecf-&gt;accept_mutex) &#123;</span><br><span class="line">        ngx_use_accept_mutex = <span class="number">1</span>;</span><br><span class="line">        ngx_accept_mutex_held = <span class="number">0</span>;</span><br><span class="line">        ngx_accept_mutex_delay = ecf-&gt;accept_mutex_delay;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_use_accept_mutex = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * disable accept mutex on win32 as it may cause deadlock if</span></span><br><span class="line"><span class="comment">     * grabbed by a process which can't accept connections</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_use_accept_mutex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 初始化全局变量,具体查看双向队列详细介绍</span></span><br><span class="line">    ngx_queue_init(&amp;ngx_posted_accept_events);</span><br><span class="line">    ngx_queue_init(&amp;ngx_posted_next_events);</span><br><span class="line">    ngx_queue_init(&amp;ngx_posted_events);</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ngx_int_t</span></span><br><span class="line"><span class="comment">ngx_event_timer_init(ngx_log_t *log)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    ngx_rbtree_init(&amp;ngx_event_timer_rbtree, &amp;ngx_event_timer_sentinel,</span></span><br><span class="line"><span class="comment">                    ngx_rbtree_insert_timer_value);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    return NGX_OK;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="comment">// 初始化全局变量ngx_event_timer_rbtree,具体参考对于红黑树的介绍</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_timer_init(cycle-&gt;<span class="built_in">log</span>) == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每一个事件模块，执行选择的事件驱动模块的ctx的actions.init方法来初始化事件驱动模块。具体执行逻辑下文讲解</span></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cycle-&gt;modules[m]-&gt;type != NGX_EVENT_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cycle-&gt;modules[m]-&gt;ctx_index != ecf-&gt;use) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;actions.init(cycle, ngx_timer_resolution) != NGX_OK) &#123;</span><br><span class="line">            <span class="comment">/* fatal */</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(NGX_WIN32)</span></span><br><span class="line">    <span class="comment">// ngx_event_flags为选择事件驱动的类型。这里如果设置了ngx_timer_resolution（即更新时间间隔），并且选择的事件驱动不是NGX_USE_TIMER_EVENT时,增加时钟信号处理</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_timer_resolution &amp;&amp; !(ngx_event_flags &amp; NGX_USE_TIMER_EVENT)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span>  <span class="title">sa</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span>  <span class="title">itv</span>;</span></span><br><span class="line"></span><br><span class="line">        ngx_memzero(&amp;sa, <span class="keyword">sizeof</span>(struct sigaction));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">static void</span></span><br><span class="line"><span class="comment">ngx_timer_signal_handler(int signo)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    ngx_event_timer_alarm = 1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#if 1</span></span><br><span class="line"><span class="comment">    ngx_log_debug0(NGX_LOG_DEBUG_EVENT, ngx_cycle-&gt;log, 0, "timer signal");</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 信号处理函数设置ngx_event_timer_alarm为1.</span></span><br><span class="line">        sa.sa_handler = ngx_timer_signal_handler;</span><br><span class="line">        sigemptyset(&amp;sa.sa_mask);</span><br><span class="line">        <span class="comment">// 设置信号处理函数</span></span><br><span class="line">        <span class="keyword">if</span> (sigaction(SIGALRM, &amp;sa, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"sigaction(SIGALRM) failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用setitimer定时触发时钟信号</span></span><br><span class="line">        itv.it_interval.tv_sec = ngx_timer_resolution / <span class="number">1000</span>;</span><br><span class="line">        itv.it_interval.tv_usec = (ngx_timer_resolution % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">        itv.it_value.tv_sec = ngx_timer_resolution / <span class="number">1000</span>;</span><br><span class="line">        itv.it_value.tv_usec = (ngx_timer_resolution % <span class="number">1000</span> ) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (setitimer(ITIMER_REAL, &amp;itv, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"setitimer() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// linux一般不会使用NGX_USE_FD_EVENT事件，这里不做介绍</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_FD_EVENT) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span>  <span class="title">rlmt</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;rlmt) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"getrlimit(RLIMIT_NOFILE) failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cycle-&gt;files_n = (<span class="keyword">ngx_uint_t</span>) rlmt.rlim_cur;</span><br><span class="line"></span><br><span class="line">        cycle-&gt;files = ngx_calloc(<span class="keyword">sizeof</span>(<span class="keyword">ngx_connection_t</span> *) * cycle-&gt;files_n,</span><br><span class="line">                                  cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (cycle-&gt;files == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_timer_resolution &amp;&amp; !(ngx_event_flags &amp; NGX_USE_TIMER_EVENT)) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_WARN, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"the \"timer_resolution\" directive is not supported "</span></span><br><span class="line">                      <span class="string">"with the configured event method, ignored"</span>);</span><br><span class="line">        ngx_timer_resolution = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 为加速，预先按照connection_n（进程最大同时处理链接数量）分配connections数组</span></span><br><span class="line">    cycle-&gt;connections =</span><br><span class="line">        ngx_alloc(<span class="keyword">sizeof</span>(<span class="keyword">ngx_connection_t</span>) * cycle-&gt;connection_n, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;connections == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c = cycle-&gt;connections;</span><br><span class="line">    <span class="comment">// 为加速，预先按照connection_n（进程最大同时处理链接数量）分配read_events数组，并设置初值</span></span><br><span class="line">    cycle-&gt;read_events = ngx_alloc(<span class="keyword">sizeof</span>(<span class="keyword">ngx_event_t</span>) * cycle-&gt;connection_n,</span><br><span class="line">                                   cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;read_events == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rev = cycle-&gt;read_events;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;connection_n; i++) &#123;</span><br><span class="line">        rev[i].closed = <span class="number">1</span>;</span><br><span class="line">        rev[i].instance = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 为加速，预先按照connection_n（进程最大同时处理链接数量）分配write_events数组，并设置初值</span></span><br><span class="line">    cycle-&gt;write_events = ngx_alloc(<span class="keyword">sizeof</span>(<span class="keyword">ngx_event_t</span>) * cycle-&gt;connection_n,</span><br><span class="line">                                    cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;write_events == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wev = cycle-&gt;write_events;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;connection_n; i++) &#123;</span><br><span class="line">        wev[i].closed = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = cycle-&gt;connection_n;</span><br><span class="line">    next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 从后向前遍历每一个cycle-&gt;connections，初始化data，并将其与对应的read_events和write_events绑定</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        i--;</span><br><span class="line"></span><br><span class="line">        c[i].data = next;</span><br><span class="line">        c[i].read = &amp;cycle-&gt;read_events[i];</span><br><span class="line">        c[i].write = &amp;cycle-&gt;write_events[i];</span><br><span class="line">        c[i].fd = (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        next = &amp;c[i];</span><br><span class="line">    &#125; <span class="keyword">while</span> (i);</span><br><span class="line">    <span class="comment">// 设置当前未使用connections的起始地址</span></span><br><span class="line">    cycle-&gt;free_connections = next;</span><br><span class="line">     <span class="comment">// 设置当前未使用connections的数量</span></span><br><span class="line">    cycle-&gt;free_connection_n = cycle-&gt;connection_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* for each listening socket */</span></span><br><span class="line">    <span class="comment">// 遍历每个监听端口，绑定一个connection</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">        <span class="comment">/* 如果监听地址设置了可复用端口号，并且其worker不是当前进程的编号时，则忽略（对应支持端口复用的地址，为每个进程设置了一个专门的ls）*/</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].reuseport &amp;&amp; ls[i].worker != ngx_worker) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 获取第一个未使用的connection，并将其绑定到该ls上，具体查看连接池的介绍</span></span><br><span class="line">        c = ngx_get_connection(ls[i].fd, cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置connection</span></span><br><span class="line">        c-&gt;type = ls[i].type;</span><br><span class="line">        c-&gt;<span class="built_in">log</span> = &amp;ls[i].<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">        c-&gt;listening = &amp;ls[i];</span><br><span class="line">        ls[i].connection = c;</span><br><span class="line">        <span class="comment">// 获取连接对应的读事件</span></span><br><span class="line">        rev = c-&gt;read;</span><br><span class="line"></span><br><span class="line">        rev-&gt;<span class="built_in">log</span> = c-&gt;<span class="built_in">log</span>;</span><br><span class="line">        <span class="comment">// 设置读事件为监听套接字</span></span><br><span class="line">        rev-&gt;accept = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT)</span></span><br><span class="line">        <span class="comment">// 设置deferred_accept，详见监听端口处理，用于加速用的配置。在TCP连接发送请求前，不为其建立connection结构</span></span><br><span class="line">        rev-&gt;deferred_accept = ls[i].deferred_accept;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果事件驱动不是NGX_USE_IOCP_EVENT</span></span><br><span class="line">        <span class="keyword">if</span> (!(ngx_event_flags &amp; NGX_USE_IOCP_EVENT)) &#123;</span><br><span class="line">            <span class="comment">// 如果ls是继承而来</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].previous) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * delete the old accept events that were bound to</span></span><br><span class="line"><span class="comment">                 * the old cycle read events array</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">// 获取旧版本的connection</span></span><br><span class="line">                old = ls[i].previous-&gt;connection;</span><br><span class="line">                <span class="comment">// 从事件模块中去除对应的读事件</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_del_event(old-&gt;read, NGX_READ_EVENT, NGX_CLOSE_EVENT)</span><br><span class="line">                    == NGX_ERROR)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                old-&gt;fd = (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_IOCP_EVENT) &#123;</span><br><span class="line">            <span class="keyword">ngx_iocp_conf_t</span>  *iocpcf;</span><br><span class="line"></span><br><span class="line">            rev-&gt;handler = ngx_event_acceptex;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_use_accept_mutex) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_add_event(rev, <span class="number">0</span>, NGX_IOCP_ACCEPT) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].<span class="built_in">log</span>.handler = ngx_acceptex_log_error;</span><br><span class="line"></span><br><span class="line">            iocpcf = ngx_event_get_conf(cycle-&gt;conf_ctx, ngx_iocp_module);</span><br><span class="line">            <span class="keyword">if</span> (ngx_event_post_acceptex(&amp;ls[i], iocpcf-&gt;post_acceptex)</span><br><span class="line">                == NGX_ERROR)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rev-&gt;handler = ngx_event_accept;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_use_accept_mutex) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_add_event(rev, NGX_READ_EVENT, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="comment">// 设置读事件的处理函数，根据类型确定。具体事件处理函数见下文</span></span><br><span class="line">        rev-&gt;handler = (c-&gt;type == SOCK_STREAM) ? ngx_event_accept</span><br><span class="line">                                                : ngx_event_recvmsg;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">        <span class="comment">/* 如果设置了端口号复用，则将读事件添加到事件驱动中，结束处理。对于支持端口号复用的监听地址来说，会为每一个进程设置一个监听的ls结构，每一个进程都会进行监听，由内核实现进程间的负载均衡，选择连接请求下发到哪个进程中，因此不需要考虑是否使用负载均衡锁，可以直接将事件添加到事件驱动中 */</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].reuseport) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_add_event(rev, NGX_READ_EVENT, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果使用负载均衡锁，则跳过处理,对于使用负载均衡锁的一般监听地址来说，不能直接使用事件驱动。使用负载均衡锁时，只有在获取到锁时，才能将该读事件添加到事件驱动中。具体后文会详细介绍</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_use_accept_mutex) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLEXCLUSIVE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ngx_event_flags &amp; NGX_USE_EPOLL_EVENT)</span><br><span class="line">            &amp;&amp; ccf-&gt;worker_processes &gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_add_event(rev, NGX_READ_EVENT, NGX_EXCLUSIVE_EVENT)</span><br><span class="line">                == NGX_ERROR)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 对于不使用负载均衡锁来说，可以直接将事件添加到事件驱动中</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_add_event(rev, NGX_READ_EVENT, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-epoll-module模块"><a href="#ngx-epoll-module模块" class="headerlink" title="ngx_epoll_module模块"></a>ngx_epoll_module模块</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_str_t</span>      epoll_name = ngx_string(<span class="string">"epoll"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_epoll_commands[] = &#123;</span><br><span class="line">    <span class="comment">// 调用epoll_wait函数时返回的最多事件数</span></span><br><span class="line">    &#123; ngx_string(<span class="string">"epoll_events"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_conf_set_num_slot,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      offsetof(<span class="keyword">ngx_epoll_conf_t</span>, events),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line">    <span class="comment">// 开启异步I/O并且使用io_setup系统调用初始化异步I/O上下文环境时，初始分配的异步i/O事件个数。后文详细介绍</span></span><br><span class="line">    &#123; ngx_string(<span class="string">"worker_aio_requests"</span>),</span><br><span class="line">      NGX_EVENT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_conf_set_num_slot,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      offsetof(<span class="keyword">ngx_epoll_conf_t</span>, aio_requests),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_event_module_t</span>  ngx_epoll_module_ctx = &#123;</span><br><span class="line">    &amp;epoll_name,</span><br><span class="line">    ngx_epoll_create_conf,               <span class="comment">/* create configuration */</span></span><br><span class="line">    ngx_epoll_init_conf,                 <span class="comment">/* init configuration */</span></span><br><span class="line">    <span class="comment">// 对于下面的函数，后续会详细介绍</span></span><br><span class="line">    &#123;</span><br><span class="line">        ngx_epoll_add_event,             <span class="comment">/* add an event */</span></span><br><span class="line">        ngx_epoll_del_event,             <span class="comment">/* delete an event */</span></span><br><span class="line">        ngx_epoll_add_event,             <span class="comment">/* enable an event */</span></span><br><span class="line">        ngx_epoll_del_event,             <span class="comment">/* disable an event */</span></span><br><span class="line">        ngx_epoll_add_connection,        <span class="comment">/* add an connection */</span></span><br><span class="line">        ngx_epoll_del_connection,        <span class="comment">/* delete an connection */</span></span><br><span class="line">#<span class="keyword">if</span> (NGX_HAVE_EVENTFD)</span><br><span class="line">        ngx_epoll_notify,                <span class="comment">/* trigger a notify */</span></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">        <span class="literal">NULL</span>,                            <span class="comment">/* trigger a notify */</span></span><br><span class="line">#endif</span><br><span class="line">        ngx_epoll_process_events,        <span class="comment">/* process the events */</span></span><br><span class="line">        ngx_epoll_init,                  <span class="comment">/* init the events */</span></span><br><span class="line">        ngx_epoll_done,                  <span class="comment">/* done the events */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_module_t</span>  ngx_epoll_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_epoll_module_ctx,               <span class="comment">/* module context */</span></span><br><span class="line">    ngx_epoll_commands,                  <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_EVENT_MODULE,                    <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* init master */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* init module */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="相关结构-5"><a href="#相关结构-5" class="headerlink" title="相关结构"></a>相关结构</h4><h5 id="ngx-epoll-conf-t"><a href="#ngx-epoll-conf-t" class="headerlink" title="ngx_epoll_conf_t"></a>ngx_epoll_conf_t</h5><p>该结构存储关于事件驱动和文件异步I/O的配置内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  events; <span class="comment">// 调用epoll_wait函数时返回的最多事件数</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  aio_requests;<span class="comment">// 开启异步I/O并且使用io_setup系统调用初始化异步I/O上下文环境时，初始分配的异步i/O事件个数。后文详细介绍</span></span><br><span class="line">&#125; <span class="keyword">ngx_epoll_conf_t</span>;</span><br></pre></td></tr></table></figure>
<p>对其设置较为简单，都是调用系统通过的解析方法，这里就不做过多介绍了。</p>
<h4 id="ctx的create-conf方法"><a href="#ctx的create-conf方法" class="headerlink" title="ctx的create_conf方法"></a>ctx的create_conf方法</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">ngx_epoll_create_conf(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_epoll_conf_t</span>  *epcf;</span><br><span class="line"></span><br><span class="line">    epcf = ngx_palloc(cycle-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_epoll_conf_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (epcf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    epcf-&gt;events = NGX_CONF_UNSET;</span><br><span class="line">    epcf-&gt;aio_requests = NGX_CONF_UNSET;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> epcf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ctx的init-conf方法"><a href="#ctx的init-conf方法" class="headerlink" title="ctx的init_conf方法"></a>ctx的init_conf方法</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_epoll_init_conf(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_epoll_conf_t</span> *epcf = conf;</span><br><span class="line"></span><br><span class="line">    ngx_conf_init_uint_value(epcf-&gt;events, <span class="number">512</span>);</span><br><span class="line">    ngx_conf_init_uint_value(epcf-&gt;aio_requests, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="系统接口"><a href="#系统接口" class="headerlink" title="系统接口"></a>系统接口</h2><p>事件处理主要涉及两个功能，一个是网络事件的epoll模块，一个是文件异步I/O模块。这里先对这两个功能在linux下如何使用进行介绍，再来看nginx如果使用。</p>
<h3 id="epoll事件驱动"><a href="#epoll事件驱动" class="headerlink" title="epoll事件驱动"></a>epoll事件驱动</h3><h4 id="epoll特点"><a href="#epoll特点" class="headerlink" title="epoll特点"></a>epoll特点</h4><p>讨论epoll事件驱动的特点，要先来讨论一下select和poll的问题。</p>
<ol>
<li>select由于传参是最大的套接字值，因此其限制监听的套接字数量。</li>
<li>select和poll在收集事件时，将所有连接的套接字传递给内核（大量内存负责），内核遍历寻找这些连接上是否存在未处理的事件（复杂度O(n)）。</li>
</ol>
<p>由于以上两个特性，导致select和poll事件驱动不适合处理高并发连接的情况。因此在2.6以后的linux内核支持了epoll事件驱动。很好的解决了上述问题。</p>
<p>对于第一个问题：用户态到内核态大量拷贝操作，epoll解决方式是：使用mmap内存映射，将内核态和用户态使用的内存统一，避免拷贝操作。</p>
<p>对于第二个问题：内核需要遍历所有连接，epoll解决方案是，对于每个连接，都会与设备（如网卡）驱动程序建立回调关系，即，相应的事件发送时会调用这里的回调方案。这个回调方法内核中叫做<code>ep_poll_callback</code>。回调方法会将触发的事件添加到一个链表中，在我们获取已经触发的事件时，直接返回链表即可，不用再进行遍历。</p>
<h4 id="epoll使用"><a href="#epoll使用" class="headerlink" title="epoll使用"></a>epoll使用</h4><p>epoll只提供了三个函数，让我们来进行事件处理。</p>
<h5 id="epoll-create"><a href="#epoll-create" class="headerlink" title="epoll_create"></a>epoll_create</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int epoll_create(int size);</span><br></pre></td></tr></table></figure>
<p>epoll_create返回一个句柄，之后epoll的使用都依赖该句柄来标识。size是告诉epoll所处理的大致事件数目。不再使用epoll时，需要调用close关闭这个句柄。size参数只是告诉内核这个epoll对象会处理的事件的大致数目，而不是能够处理的事件的最大个数。新版的Linux内核版本中size已无意义。</p>
<h5 id="epoll-ctl"><a href="#epoll-ctl" class="headerlink" title="epoll_ctl"></a>epoll_ctl</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event* event)</span></span>;</span><br></pre></td></tr></table></figure>
<p>epoll_ctl向epoll对象中添加、修改或者删除感兴趣的事件，成功返回0，否则返回-1，此时需要根据errno错误码判断错误类型。epoll_wait方法返回的事件必然是通过epoll_ctl添加到epoll中的。参数epfd是epoll_create创建的句柄。op对应操作类型，取值如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>op取值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>EPOLL_CLT_ADD</td>
<td>添加新的事件到epoll中</td>
</tr>
<tr>
<td>EPOLL_CLT_MOD</td>
<td>修改epoll中的事件</td>
</tr>
<tr>
<td>EPOLL_CLT_DEL</td>
<td>删除epoll中的事件</td>
</tr>
</tbody>
</table>
</div>
<p>第三个参数fd是待检测的连接套接字。</p>
<p>第四个参数告诉epoll对什么样的事件感兴趣，其使用的是epoll_event结构体。epoll_event定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line">  <span class="keyword">__uint32_t</span> events;</span><br><span class="line">  <span class="keyword">epoll_data_t</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中event表示感兴趣事件，取值如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>events取值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>EPOLLIN</td>
<td>表示对应的连接上有数据可读（TCP连接的远端主动关闭事件，也相当于可读事件，因为需要处理发送来的FIN包。对应监听端口，远端发送来连接请求，也是可读事件，之后调用accept）</td>
</tr>
<tr>
<td>EPOLLOUT</td>
<td>表示对应连接上可以写入数据发送（主动向上游服务器发起非阻塞的TCP连接，连接建立成功的事件相当于可写事件）</td>
</tr>
<tr>
<td>EPOLLRDHUP</td>
<td>表示TCP连接的远端关闭或者半关闭连接</td>
</tr>
<tr>
<td>EPOLLPRI</td>
<td>表示对应的连接上有紧急数据要读</td>
</tr>
<tr>
<td>EPOLLERR</td>
<td>表示对应的连接发生错误</td>
</tr>
<tr>
<td>EPOLLHUP</td>
<td>表示对应的连接被挂起</td>
</tr>
<tr>
<td>EPOLLET</td>
<td>表示将触发方式设置为边缘触发（ET），系统默认为水平触发（LT）</td>
</tr>
<tr>
<td>EPOLLONESHOT</td>
<td>表示对事件只处理一次，下次需要处理时需要重新加入epoll</td>
</tr>
</tbody>
</table>
</div>
<p>data成员是一个epoll_data联合，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">union</span> <span class="title">epoll_data</span>&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *ptr;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">uint32_t</span> u32;</span><br><span class="line">  <span class="keyword">uint64_t</span> u64;</span><br><span class="line">&#125; <span class="keyword">epoll_data_t</span></span><br></pre></td></tr></table></figure>
<p>可以看出，data成员与具体的使用方式有关。例如，ngx_epoll_module模块只使用了联合的ptr成员，作为指向ngx_connection_t连接的指针。</p>
<h5 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a>epoll_wait</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event *events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span></span><br></pre></td></tr></table></figure>
<p>收集epoll监控的事件中已经发生的事件，如果没有事件发生，则最多等待timeout秒返回。epoll_wait返回值表示当前发生的事件个数，如果返回0，表示本次调用中没有事件发生，如果返回-1，则表示错误，需要检查errno错误码来判断错误类型。第一个参数epfd为epoll的描述符。第二个参数events是分配好的epoll_event结构体数组，epoll将会把发生的事件复制到events数组中（events不能是空指针，内核只负责复制数据到events，不会帮助用户在用户态中分配内存。）第三个参数是maxevents表示本次可以返回的最大事件数目，通常maxevents参数与预分配的events数组的大小一致。timeout为-1表示一直阻塞，直到有事件触发。</p>
<h4 id="epoll原理"><a href="#epoll原理" class="headerlink" title="epoll原理"></a>epoll原理</h4><p>介绍完epoll如何使用，这里再简单介绍一下epoll的原理。</p>
<p>在调用epoll_create时，Linux内核会创建一个eventpoll的结构体，其中有两个成员与epoll的使用方式密切相关。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eventpoll</span> &#123;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 红黑树的根节点，这棵树存储着所有添加到epoll中的事件，即epoll监控的事件</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rb_tree</span> <span class="title">rbr</span>;</span></span><br><span class="line">  <span class="comment">// 双向链表rdllist报错着将要通过epoll_wait返回给用户的、满足条件的事件</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rdllist</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个epoll对象都有一个独立的eventpoll结构体，这个结构体会在内核空间中创造独立的内存，用于存储使用epoll_ctl方法向epoll对象中添加进来的事件。这些事件会被挂到rbr红黑树中，以支持快速的增加、删除、变更。rbr的红黑树和前文描述的nginx构建的红黑树类似。</p>
<p>所有添加到epoll中的事件都会与设备（如网卡）驱动程序建立回调关系，即相应事件发生时会调用这里的回调方法。这个回调方法在内核中叫做<code>ep_poll_callback</code>，它会把这样的事件放到rdllist双线链表中。rdllist双向链表与前文nginx创建的双向链表几乎一致。</p>
<p>在epoll中，对每个事件都会建立一个epitem结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epitem</span> &#123;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 红黑树节点，与ngx_rbtree_node_t红黑树节点类似</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rbn</span>;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 双向链表节点，与ngx_queue_t双向链表节点类似</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rdllink</span>;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 事件句柄等信息</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">epoll_filefd</span> <span class="title">ffd</span>;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行其所属eventpoll对象</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">eventpoll</span> *<span class="title">ep</span>;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 期待的事件类型</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>epitem包含每一个事件对应着的信息。</p>
<p>当调用epoll_wait检查是否有事件发生时，只是检查eventpoll对象中的rdllist双向链表是否有epitem元素而已。</p>
<p>epoll有两种工作模式：LT（水平触发）模式和ET（边缘触发）模式。默认情况下，epoll采用LT模式工作，这时可以处理阻塞和非阻塞套接字。而在epoll_ctl中的EPOLLET表明可以将一个事件改为ET模式，ET模式效率更高，其只能处理非阻塞套接字。ET模式和LT模式主要区别在于：当一个事件到来时，ET模式下从epoll_wait调用中获取到这个事件后，如果这次没有把事件对应的套接字缓冲区处理完，在这个套接字没有新的事件再次到来时，ET模式下无法再次从epoll_wait中获取到这个事件，而LT模式可以。因此在LT模式下开发基于epoll的应用要简单一些，不太容易出错，而在ET模式下事件发生时，如果没有彻底将缓冲区数据处理完全，会导致缓冲区中的用户请求得不到响应。默认情况下，nginx通过ET模式使用epoll。</p>
<h3 id="文件异步I-O"><a href="#文件异步I-O" class="headerlink" title="文件异步I/O"></a>文件异步I/O</h3><p>epoll解决了网络事件的事件驱动。这里介绍一下Linux内核2.6.2x之后版本中支持的文件异步I/O操作。这里提到的文件异步I/O不是glibc库提供的文件异步io。glibc提供的文件异步I/O是基于多线程实现的，不是真正意义的异步I/O。这里说的文件异步I/O是由Linux内核实现，只有在内核完成了磁盘操作，内核才会通知进程，进而使得磁盘文件的处理与网络事件一样高效。</p>
<p>使用Linux内核版本的文件异步I/O前提是内核版本必须支持文件异步I/O。这样的好处是，nginx把读文件的操作异步地提交给内核后，内核会通知I/O设备独立执行操作，这样nginx进程可以继续充分利用cpu。当大量读事件堆积到I/O设备的队列中时，将会发挥出内核中电梯算法的优势，从而降低随机读取磁盘扇区的成本。</p>
<p>Linux内核级别的文件异步I/O是不支持缓存操作的，即，即使要操作的文件快在Linux文件缓存中，也不会通过读取、更改缓存中的文件块来代替实际对磁盘的操作。使用文件异步I/O虽然从阻塞worker进程的角度来说有很大好转，但对单个请求来说，有可能降低处理速度的，因为原本可以从内存中快速获取的文件块在使用了文件异步I/O后必须通过磁盘获取。如果大部分用户请求对文件的操作都会落到文件缓存中，那么就不应该使用异步I/O。</p>
<p>目前nginx仅支持在读文件时使用异步I/O，因为在写入文件时，往往是写入内存中就立即返回，速度很快，使用异步I/O反而会速度下降。</p>
<p>nginx默认不使用文件异步I/O，要向使用，则在执行config时，增加参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-file-aio</span><br></pre></td></tr></table></figure>
<p>文件异步I/O使用方式与epoll基本一致，下面进行简单介绍。</p>
<h4 id="初始化文件异步I-O上下文"><a href="#初始化文件异步I-O上下文" class="headerlink" title="初始化文件异步I/O上下文"></a>初始化文件异步I/O上下文</h4><p>使用如下函数初始化文件异步I/O上下文：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_setup</span><span class="params">(<span class="keyword">unsigned</span> nr_events, <span class="keyword">aio_context_t</span> *ctxp)</span></span></span><br></pre></td></tr></table></figure>
<p><code>nr_events</code>表示需要初始化的异步I/O上下文可以处理的事件的最小个数，ctxp是文件异步I/O上下文描述符指针。执行成功后，ctxp就是分配的上下文描述符，这个异步I/O至少可以处理nr_events个事件，返回0表示成功。</p>
<p>该函数与epoll_create对应。</p>
<h4 id="向异步I-O上下文中增删文件操作事件"><a href="#向异步I-O上下文中增删文件操作事件" class="headerlink" title="向异步I/O上下文中增删文件操作事件"></a>向异步I/O上下文中增删文件操作事件</h4><p>下面两个函数向异步I/O中增加、删除事件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加事件,nr是一次提交事件的数量，cbp是提交事件数组的首地址。返回值表示成功提交的事件个数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_submit</span><span class="params">(<span class="keyword">aio_context_t</span> ctx, <span class="keyword">long</span> nr, struct iocb *cbp[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除事件， iocb是要取消的异步I/O操作，而result表示操作的结果。返回0表示成功</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_cancel</span><span class="params">(<span class="keyword">aio_context_t</span> ctx, struct iocb *iocb, struct io_event *result)</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中使用到的iocb定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> &#123;</span></span><br><span class="line">  <span class="comment">// 用于存储业务需要的指针。例如在nginx中，该字段通常存储这对应的ngx_event_t事件的指针，其与io_getevents返回的IO_event结构体中的data成员一致。</span></span><br><span class="line">  <span class="keyword">u_int64_t</span> aio_data;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 不需要设置</span></span><br><span class="line">  <span class="keyword">u_int32_t</span> PADDED(aio_key, aio_reserved1);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 操作码，其取值范围为io_icob_cmd_t中枚举命令</span></span><br><span class="line">  <span class="keyword">u_int32_t</span> aio_lio_opcode;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 请求优先级</span></span><br><span class="line">  <span class="keyword">int16_t</span> aio_reqprio;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 文件描述符</span></span><br><span class="line">  <span class="keyword">u_int32_t</span> aio_fildes;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 读写对应的用户态缓冲区</span></span><br><span class="line">  <span class="keyword">u_int64_t</span> aio_buf;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 读写操作的字节长度</span></span><br><span class="line">  <span class="keyword">u_int65_t</span> aio_nbytes;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 读写对应文件中的偏移</span></span><br><span class="line">  <span class="keyword">int64_t</span> aio_offset;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 保留字段</span></span><br><span class="line">  <span class="keyword">u_int64_t</span> aio_reserved2;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 表示可以设置为IOCB_FLAG_RESFD,它会告诉内核，当有异步I/O请求完成时使用eventfd进行通知，可与epoll配合使用。</span></span><br><span class="line">  <span class="keyword">u_int32_t</span> aio_flags;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 表示当使用了IOCB_FLAG_RESFD标志位时，用于进行事件通知的句柄</span></span><br><span class="line">  <span class="keyword">u_int32_t</span> aio_resfd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中aio_lio_opcode取值范围如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> io_iocb_cmd &#123;</span><br><span class="line">  <span class="comment">// 异步读操作</span></span><br><span class="line">  IO_CMD_PREAD = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 异步写操作</span></span><br><span class="line">  IO_CMD_PWRITE = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 强制同步</span></span><br><span class="line">  IO_CMD_FSYNC = <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 目前未使用</span></span><br><span class="line">  IO_CMD_FDSYNC = <span class="number">3</span>;</span><br><span class="line">  <span class="comment">// 目前未使用</span></span><br><span class="line">  IO_CMD_POLL = <span class="number">5</span>;</span><br><span class="line">  <span class="comment">// 不做任何事情</span></span><br><span class="line">  IO_CMD_NOOP = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx中仅使用了IO_CMD_PREAD。</p>
<p>对应io_event下面介绍。</p>
<h4 id="获取已完成事件"><a href="#获取已完成事件" class="headerlink" title="获取已完成事件"></a>获取已完成事件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_getevents</span><span class="params">(<span class="keyword">aio_context_t</span> ctx, <span class="keyword">long</span> min_nr, <span class="keyword">long</span> nr, struct io_event *events, struct timespec *timeout)</span></span>;</span><br></pre></td></tr></table></figure>
<p>从已完成文件异步I/O的操作队列中读取操作。min_nr是最小返回事件数量，nr表示最大返回事件数量，events是执行完成的事件数组。timeout是超时时间，即获取到min_nr事件前的等待事件。</p>
<p>这里使用到了io_event结构，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_event</span>&#123;</span></span><br><span class="line">  <span class="comment">// 对应提交事件时iocb结构的aio_data</span></span><br><span class="line">  <span class="keyword">uint64_t</span> data;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 指向提交事件时对应的iocb结构</span></span><br><span class="line">  <span class="keyword">uint64_t</span> obj;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 异步I/O请求结果。res大于或等于0表示成功，否则表示失败。</span></span><br><span class="line">  <span class="keyword">int64_t</span> res;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 保留字段</span></span><br><span class="line">  <span class="keyword">int64_t</span> res2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，根据获取到的io_event结构体数组，就可以获取已完成的异步I/O操作了。其中iocb和io_event可以传递指针，因此业务中数据结构、事件完成后的回调方法都在其中。</p>
<h4 id="关闭异步I-O上下文"><a href="#关闭异步I-O上下文" class="headerlink" title="关闭异步I/O上下文"></a>关闭异步I/O上下文</h4><p>进程退出时，需要关闭异步I/O上下文，方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_destroy</span><span class="params">(<span class="keyword">aio_context_t</span> ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<p>返回0表示成功。与epoll结束时close类似。</p>
<h3 id="系统事件模块eventfd"><a href="#系统事件模块eventfd" class="headerlink" title="系统事件模块eventfd"></a>系统事件模块eventfd</h3><p>在Linux系统中，eventfd是一个用来通知事件的文件描述符。可以使用eventfd来触发事件通知。在nginx中也会使用该方法，用于绑定消息通知和将文件异步I/O和epoll驱动。</p>
<h4 id="创建eventfd"><a href="#创建eventfd" class="headerlink" title="创建eventfd"></a>创建eventfd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">eventfd</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> initval, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<p>创建一个eventfd对象，或者说打开一个eventfd的文件，类似普通文件的open操作。</p>
<p>该对象是一个内核维护的无符号的64位整型计数器。初始化为initval的值。</p>
<p>flags可以以下三个标志位的OR结果：</p>
<ul>
<li>EFD_CLOEXEC：FD_CLOEXEC，简单说就是fork子进程时不继承，对于多线程的程序设上这个值不会有错的。</li>
<li>EFD_NONBLOCK：文件会被设置成O_NONBLOCK，一般要设置。</li>
<li>EFD_SEMAPHORE：（2.6.30以后支持）支持semophore语义的read，简单说就值递减1。</li>
</ul>
<p>对于eventfd就只是一个计数器，一般用于记录绑定到其上的事件触发数量。一般与epoll模块配合使用，后文会详细介绍nginx如果使用eventfd和epoll。</p>
<h4 id="读eventfd"><a href="#读eventfd" class="headerlink" title="读eventfd"></a>读eventfd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> efd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes)</span></span>;<span class="comment">// 或者int eventfd_read (int __fd, eventfd_t *__value);</span></span><br></pre></td></tr></table></figure>
<p>读取当前事件对应计数数值。在nginx中就是获取绑定到efd上的事件触发数量。这里如果eventfd计数不为0，并且未设置为EFD_SEMAPHORE则，计数清零，返回buf中存储计数数量，read返回读取字节数。如果eventfd计数不为0，并且设置了EFD_SEMAPHORE则，计数减一。如果eventfd为0，没有设置EFD_NONBLOCK，进程阻塞，直到计数不为0。如果eventfd为0，设置了EFD_NONBLOCK，则直接返回。</p>
<h4 id="写eventfd"><a href="#写eventfd" class="headerlink" title="写eventfd"></a>写eventfd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> efd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes)</span></span>;<span class="comment">// 或者int eventfd_write (int __fd, eventfd_t __value);</span></span><br></pre></td></tr></table></figure>
<p>这里的写并非直接设置eventfd值，而是对eventfd的引用计数进行增加。对于和epoll配合使用的eventfd，这一步一般不需要用户自己写入，而是在eventfd绑定的事件触发时由epoll自己写入。</p>
<h2 id="关键结构"><a href="#关键结构" class="headerlink" title="关键结构"></a>关键结构</h2><p>事件模块中存在一些关键结构，用于构建整个事件驱动的运行，这里进行详细介绍。</p>
<h3 id="ngx-event-s事件结构"><a href="#ngx-event-s事件结构" class="headerlink" title="ngx_event_s事件结构"></a>ngx_event_s事件结构</h3><p>ngx_event_s定义了事件，其内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_event_handler_pt)</span><span class="params">(<span class="keyword">ngx_event_t</span> *ev)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_event_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// 事件相关的对象，通常是执行ngx_connection_t连接对象，开启文件异步I/O时也可指向ngx_event_aio_t</span></span><br><span class="line">    <span class="keyword">void</span>            *data;</span><br><span class="line">    <span class="comment">/* 标志位，为1时说明事件是可写的。通常表示TCP连接目前处于可写状态 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         write:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标注位，为1时表示为此事件可以建立新的连接。通常只有ngx_cycle_t中的listening动态数组中才，每一个监听对象ngx_listening_t对应的读事件中的accept标志位才会是1 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         accept:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* used to detect the stale events in kqueue and epoll */</span></span><br><span class="line">    <span class="comment">/* 区分当前事件是否过期，仅仅给事件驱动模块使用，事件消费模块可不关心。设计原因为：开始处理前面的事件时，可能会关闭一些连接，而这些连接有可能影响还未处理的事件。这是通过该标志位来避免处理后续已经过期的事件 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         instance:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the event was passed or would be passed to a kernel;</span></span><br><span class="line"><span class="comment">     * in aio mode - operation was posted.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">/* 标志位，事件是否活跃 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         active:<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*标志位，只在kqueue和rtsig事件中国有效，事件禁止*/</span></span><br><span class="line">    <span class="keyword">unsigned</span>         disabled:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the ready event; in aio mode 0 means that no operation can be posted */</span></span><br><span class="line">    <span class="comment">/* 标志位，事件是否准备就绪，是否允许事件的消费模块处理该事件 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         ready:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 对epoll无意义 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         oneshot:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* aio operation is complete */</span></span><br><span class="line">    <span class="comment">/* 标志位，用于AIO事件处理 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         complete:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示要处理的字节流已结束 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         eof:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示事件处理过程中出现错误 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         error:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示事件已超时，用来提醒事件消费模块做超时处理 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         timedout:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示事件存在于定时器中 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         timer_set:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示要延迟处理该事件，用于限速功能 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         delayed:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，是否延迟建立TCP连接，即完成握手不建立连接，等到发送请求数据 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         deferred_accept:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the pending eof reported by kqueue, epoll or in aio chain operation */</span></span><br><span class="line">    <span class="comment">/* 标志位，等待字符流结束 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         pending_eof:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         posted:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示事件已关闭，epoll未使用 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         closed:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* to test on worker exit */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         channel:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>         resolver:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>         cancelable:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line">    <span class="keyword">unsigned</span>         kq_vnode:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the pending errno reported by kqueue */</span></span><br><span class="line">    <span class="keyword">int</span>              kq_errno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * kqueue only:</span></span><br><span class="line"><span class="comment">     *   accept:     number of sockets that wait to be accepted</span></span><br><span class="line"><span class="comment">     *   read:       bytes to read when event is ready</span></span><br><span class="line"><span class="comment">     *               or lowat when event is set with NGX_LOWAT_EVENT flag</span></span><br><span class="line"><span class="comment">     *   write:      available space in buffer when event is ready</span></span><br><span class="line"><span class="comment">     *               or lowat when event is set with NGX_LOWAT_EVENT flag</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * iocp: TODO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * otherwise:</span></span><br><span class="line"><span class="comment">     *   accept:     1 if accept many, 0 otherwise</span></span><br><span class="line"><span class="comment">     *   read:       bytes to read when event is ready, -1 if not known</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* 在epoll中表示一次尽可能多的建立连接，与multi_accept配置相关 */</span></span><br><span class="line">    <span class="keyword">int</span>              available;</span><br><span class="line">    <span class="comment">/* 事件对应的处理方法，每个事件消费模块会重新实现它 */</span></span><br><span class="line">    ngx_event_handler_pt  handler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_IOCP)</span></span><br><span class="line">    <span class="keyword">ngx_event_ovlp_t</span> ovlp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* epoll未使用 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       index;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">ngx_log_t</span>       *<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">/* 定时器节点，用于定时器红黑树中 */</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>   timer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the posted queue */</span></span><br><span class="line">    <span class="comment">/* 在post队列中的节点 */</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>      <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the threads support */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the event thread context, we store it here</span></span><br><span class="line"><span class="comment">     * if $(CC) does not understand __thread declaration</span></span><br><span class="line"><span class="comment">     * and pthread_getspecific() is too costly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>            *thr_ctx;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_EVENT_T_PADDING)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* event should not cross cache line in SMP */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>         padding[NGX_EVENT_T_PADDING];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-connection-t连接"><a href="#ngx-connection-t连接" class="headerlink" title="ngx_connection_t连接"></a>ngx_connection_t连接</h3><p>ngx_connection_t定义了连接，其内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_connection_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 连接未使用时，充当连接池中空闲链表的next指针。连接使用时，由其使用的模块决定，如在http中，data指向ngx_http_request_t结构 */</span></span><br><span class="line">    <span class="keyword">void</span>               *data;</span><br><span class="line">    <span class="comment">/* 对应的读事件 */</span></span><br><span class="line">    <span class="keyword">ngx_event_t</span>        *read;</span><br><span class="line">    <span class="comment">/* 对应的写事件 */</span></span><br><span class="line">    <span class="keyword">ngx_event_t</span>        *write;</span><br><span class="line">    <span class="comment">/* 对应的套接字 */</span></span><br><span class="line">    <span class="keyword">ngx_socket_t</span>        fd;</span><br><span class="line">    <span class="comment">/* 直接接收网络字符流的方法 */</span></span><br><span class="line">    ngx_recv_pt         recv;</span><br><span class="line">    <span class="comment">/* 直接发送网络字节流的方法 */</span></span><br><span class="line">    ngx_send_pt         send;</span><br><span class="line">    <span class="comment">/* 使用ngx_chain_t链表为参数接收网络字符流的方法 */</span></span><br><span class="line">    ngx_recv_chain_pt   recv_chain;</span><br><span class="line">    <span class="comment">/* 使用ngx_chain_t链表为参数接收网络字符流的方法 */</span></span><br><span class="line">    ngx_send_chain_pt   send_chain;</span><br><span class="line">    <span class="comment">/* 连接对应的监听对象，此链接由listening监听端口的事件建立 */</span></span><br><span class="line">    <span class="keyword">ngx_listening_t</span>    *listening;</span><br><span class="line">    <span class="comment">/* 连接上已经发送的字节数 */</span></span><br><span class="line">    <span class="keyword">off_t</span>               sent;</span><br><span class="line">    <span class="comment">/* 记录日志的log */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>          *<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">/* 连接池。一版在accept一个新连接时，创建一个内存池，连接结束时销毁。内存池大小由listening监听对象的pool_size成员决定 */</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>         *pool;</span><br><span class="line">    <span class="comment">/* 连接类型 */</span></span><br><span class="line">    <span class="keyword">int</span>                 type;</span><br><span class="line">    <span class="comment">/* 连接客户的地址信息 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>    *<span class="title">sockaddr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span>           socklen;</span><br><span class="line">    <span class="comment">/* 连接客户端字符串形式ip地址 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>           addr_text;</span><br><span class="line">    <span class="comment">/* 为代理连接进行的扩招 */</span></span><br><span class="line">    <span class="keyword">ngx_proxy_protocol_t</span>  *proxy_protocol;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SSL || NGX_COMPAT)</span></span><br><span class="line">    <span class="comment">/* ssl连接进行的扩展 */</span></span><br><span class="line">    <span class="keyword">ngx_ssl_connection_t</span>  *ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* udp连接进行的扩展 */</span></span><br><span class="line">    <span class="keyword">ngx_udp_connection_t</span>  *udp;</span><br><span class="line">    <span class="comment">/* 本机监听端口对应的sockaddr，即listening监听对象的sockaddr */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>    *<span class="title">local_sockaddr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span>           local_socklen;</span><br><span class="line">    <span class="comment">/* 用于接收、缓存客户端发送来的字节流，每个事件消费模块可自由决定从连接池中分配多大空间给buffer，例如http模块中，buffer大小取决于client_header_buffer_size配置 */</span></span><br><span class="line">    <span class="keyword">ngx_buf_t</span>          *buffer;</span><br><span class="line">    <span class="comment">/* 该字段将当前连接以双向链表元素的形式添加到ngx_cycle_t中reusable_connection_t双向链表中，表示可以重用的连接 */</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>         <span class="built_in">queue</span>;</span><br><span class="line">    <span class="comment">/* 连接使用次数， ngx_connection_t结构体每建立一条来自客户端的连接，或者向后端发起连接时，number都会加1*/</span></span><br><span class="line">    <span class="keyword">ngx_atomic_uint_t</span>   number;</span><br><span class="line">    <span class="comment">/* 处理的请求次数 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>          requests;</span><br><span class="line">    <span class="comment">/* 缓存中的业务类型 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            buffered:<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* 日志级别 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            log_error:<span class="number">3</span>;     <span class="comment">/* ngx_connection_log_error_e */</span></span><br><span class="line">    <span class="comment">/* 连接是否超时 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            timedout:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 连接是否发生错误 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            error:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 连接是否已销毁。值TCP连接是否已销毁，对应的套接字和内存池不可用了 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            destroyed:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 连接处于空闲状态，如keepalive请求中两次请求之间的状态 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            idle:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 连接是否可重用的，与queue配合使用 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            reusable:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 连接是否关闭 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            close:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            shared:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 为1表示正将文件中的数据发往连接的另一端 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            sendfile:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 标志位，1表示只有在连接套接字对应的发送缓冲区必须满足最低设置的大小阈值时，事件驱动模块才会分发该事件 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            sndlowat:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 如何使用TCP的nodelay属性，可取值：NGX_TCP_NODELAY_UNSET:0,NGX_TCP_NODELAY_SET:1,NGX_TCP_NODELAY_DISABLE:2 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            tcp_nodelay:<span class="number">2</span>;   <span class="comment">/* ngx_connection_tcp_nodelay_e */</span></span><br><span class="line">    <span class="comment">/* 如何使用TCP的nopush属性，可取值：NGX_TCP_NOPUSH_UNSET:0,NGX_TCP_NOPUSH_SET:1,NGX_TCP_NOPUSH_DISABLE:2 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            tcp_nopush:<span class="number">2</span>;    <span class="comment">/* ngx_connection_tcp_nopush_e */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>            need_last_buf:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_AIO_SENDFILE || NGX_COMPAT)</span></span><br><span class="line">    <span class="keyword">unsigned</span>            busy_count:<span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_THREADS || NGX_COMPAT)</span></span><br><span class="line">    <span class="keyword">ngx_thread_task_t</span>  *sendfile_task;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中接收发送字符流方法定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ssize_t</span> <span class="params">(*ngx_recv_pt)</span><span class="params">(<span class="keyword">ngx_connection_t</span> *c, u_char *buf, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ssize_t</span> <span class="params">(*ngx_recv_chain_pt)</span><span class="params">(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_chain_t</span> *in,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">off_t</span> limit)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ssize_t</span> <span class="params">(*ngx_send_pt)</span><span class="params">(<span class="keyword">ngx_connection_t</span> *c, u_char *buf, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">ngx_chain_t</span> *(*ngx_send_chain_pt)(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_chain_t</span> *in,</span><br><span class="line">    <span class="keyword">off_t</span> limit);</span><br></pre></td></tr></table></figure>
<h3 id="ngx-connection-t连接池"><a href="#ngx-connection-t连接池" class="headerlink" title="ngx_connection_t连接池"></a>ngx_connection_t连接池</h3><p>Nginx接受客户端连接时，所使用的ngx_connection_t结构体在启动阶段就域分配好的（详见ngx_event_core_module模块的init_process方法），使用时从连接池中获取即可。</p>
<p>连接池结构示意图：</p>
<p><a href="https://imgtu.com/i/5Mizo8" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/10/13/5Mizo8.png" alt="5Mizo8.png"></a></p>
<p>cycle中的connections和free_connections两个成员构成一个连接池，其中connections指向整个连接池数组的首部，free_connections指向第一个空闲的ngx_connection_t空闲连接。所有空闲连接通过ngx_connection_t的data成员作为next指针串联成一个单链表。当有用户发起连接时，就从free_connections指向的链表头部获取一个空闲连接，同时free_connections指向下一个空闲ngx_connection_t。归还连接时将对应的ngx_connection_t插入free_connections头部即可。</p>
<p>上图不止展示了连接池，同时还有事件池。Nginx认为每一个连接都至少需要一个读事件和写事件。有多少个连接就分配对应数量的读事件池和写事件池，并通过ngx_connection_t中的指针绑定对应的两个事件，ngx_event_t事件也存在指向ngx_connection_t的指针。这样将每个连接关联一个读事件和写事件。这一步也是在ngx_event_core_module模块的init_process方法进行设置的。</p>
<p>这里还有reusable_connections_queue可复用连接池，其是一个双向链表，其存在可以被复用的连接，当连接池剩余数量较少时，会优先释放可费用连接池中的连接，来进行建立新连接。</p>
<p>对于连接池，封装了如下方法。</p>
<h4 id="ngx-get-connection获取空闲事件"><a href="#ngx-get-connection获取空闲事件" class="headerlink" title="ngx_get_connection获取空闲事件"></a>ngx_get_connection获取空闲事件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_connection_t</span> *</span><br><span class="line">ngx_get_connection(<span class="keyword">ngx_socket_t</span> s, <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         instance;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>       *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* disable warning: Win32 SOCKET is u_int while UNIX socket is int */</span></span><br><span class="line">    <span class="comment">// epoll不使用files，这里不做接收</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_cycle-&gt;files &amp;&amp; (<span class="keyword">ngx_uint_t</span>) s &gt;= ngx_cycle-&gt;files_n) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"the new socket has number %d, "</span></span><br><span class="line">                      <span class="string">"but only %ui files are available"</span>,</span><br><span class="line">                      s, ngx_cycle-&gt;files_n);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 加速释放可复用连接，下文会详细介绍</span></span><br><span class="line">    ngx_drain_connections((<span class="keyword">ngx_cycle_t</span> *) ngx_cycle);</span><br><span class="line">    <span class="comment">// 获取当前的空闲连接</span></span><br><span class="line">    c = ngx_cycle-&gt;free_connections;</span><br><span class="line">    <span class="comment">// 如果没有空闲连接了，返回NULL</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"%ui worker_connections are not enough"</span>,</span><br><span class="line">                      ngx_cycle-&gt;connection_n);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 变更空闲连接池指针，后移一个</span></span><br><span class="line">    ngx_cycle-&gt;free_connections = c-&gt;data;</span><br><span class="line">    ngx_cycle-&gt;free_connection_n--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_cycle-&gt;files &amp;&amp; ngx_cycle-&gt;files[s] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_cycle-&gt;files[s] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 由于ngx_connection_t和ngx_event_t都已经在之前被使用过，因此要先清除已经使用的数据，重新赋值</span></span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line">    wev = c-&gt;write;</span><br><span class="line">    <span class="comment">// 清除connection数据</span></span><br><span class="line">    ngx_memzero(c, <span class="keyword">sizeof</span>(<span class="keyword">ngx_connection_t</span>));</span><br><span class="line">    <span class="comment">// 重新绑定事件</span></span><br><span class="line">    c-&gt;read = rev;</span><br><span class="line">    c-&gt;write = wev;</span><br><span class="line">    <span class="comment">// 设置描述符</span></span><br><span class="line">    c-&gt;fd = s;</span><br><span class="line">    c-&gt;<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    instance = rev-&gt;instance;</span><br><span class="line">    <span class="comment">// 清除数据</span></span><br><span class="line">    ngx_memzero(rev, <span class="keyword">sizeof</span>(<span class="keyword">ngx_event_t</span>));</span><br><span class="line">    ngx_memzero(wev, <span class="keyword">sizeof</span>(<span class="keyword">ngx_event_t</span>));</span><br><span class="line"></span><br><span class="line">    rev-&gt;instance = !instance;</span><br><span class="line">    wev-&gt;instance = !instance;</span><br><span class="line"></span><br><span class="line">    rev-&gt;index = NGX_INVALID_INDEX;</span><br><span class="line">    wev-&gt;index = NGX_INVALID_INDEX;</span><br><span class="line">    <span class="comment">// 绑定事件到连接</span></span><br><span class="line">    rev-&gt;data = c;</span><br><span class="line">    wev-&gt;data = c;</span><br><span class="line">    <span class="comment">// 设置写事件可写</span></span><br><span class="line">    wev-&gt;write = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-free-connection释放连接"><a href="#ngx-free-connection释放连接" class="headerlink" title="ngx_free_connection释放连接"></a>ngx_free_connection释放连接</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_free_connection(<span class="keyword">ngx_connection_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// c添加到free_connections链表的头部</span></span><br><span class="line">    c-&gt;data = ngx_cycle-&gt;free_connections;</span><br><span class="line">    ngx_cycle-&gt;free_connections = c;</span><br><span class="line">    ngx_cycle-&gt;free_connection_n++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_cycle-&gt;files &amp;&amp; ngx_cycle-&gt;files[c-&gt;fd] == c) &#123;</span><br><span class="line">        ngx_cycle-&gt;files[c-&gt;fd] = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-reusable-connection变更连接可复用性"><a href="#ngx-reusable-connection变更连接可复用性" class="headerlink" title="ngx_reusable_connection变更连接可复用性"></a>ngx_reusable_connection变更连接可复用性</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_reusable_connection(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_uint_t</span> reusable)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_CORE, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"reusable connection: %ui"</span>, reusable);</span><br><span class="line">    <span class="comment">// 如果连接原本是可复用的</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;reusable) &#123;</span><br><span class="line">        <span class="comment">// 从可复用双向队列中删除</span></span><br><span class="line">        ngx_queue_remove(&amp;c-&gt;<span class="built_in">queue</span>);</span><br><span class="line">        ngx_cycle-&gt;reusable_connections_n--;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_waiting, <span class="number">-1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重新设置可复用性</span></span><br><span class="line">    c-&gt;reusable = reusable;</span><br><span class="line">    <span class="comment">// 如果是可复用的</span></span><br><span class="line">    <span class="keyword">if</span> (reusable) &#123;</span><br><span class="line">        <span class="comment">/* need cast as ngx_cycle is volatile */</span></span><br><span class="line">        <span class="comment">// 将连接添加到reusable_connections_queue头部</span></span><br><span class="line">        ngx_queue_insert_head(</span><br><span class="line">            (<span class="keyword">ngx_queue_t</span> *) &amp;ngx_cycle-&gt;reusable_connections_queue, &amp;c-&gt;<span class="built_in">queue</span>);</span><br><span class="line">        ngx_cycle-&gt;reusable_connections_n++;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_STAT_STUB)</span></span><br><span class="line">        (<span class="keyword">void</span>) ngx_atomic_fetch_add(ngx_stat_waiting, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可能有个疑问，为啥要不考虑可复用性就先执行删除操作。个人理解这与其释放顺序有关，对于先加入的可复用连接，预期会是先释放的，因此这里重新设置可执行性时，相当于重新设置了舒服的优先顺序，因此即使可复用性是否变更，都要先执行删除操作。对于先加入的先删除，较为简单，添加的时候是向链表头部添加，删除的时候从链表的最后进行遍历。</p>
<h4 id="ngx-drain-connections加速释放可复用连接"><a href="#ngx-drain-connections加速释放可复用连接" class="headerlink" title="ngx_drain_connections加速释放可复用连接"></a>ngx_drain_connections加速释放可复用连接</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_drain_connections(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i, n;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>       *q;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line">    <span class="comment">// 如果还有充足的连接，或者可复用连接为0，则直接返回。</span></span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;free_connection_n &gt; cycle-&gt;connection_n / <span class="number">16</span></span><br><span class="line">        || cycle-&gt;reusable_connections_n == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 上一此加速释放连接事件与当前事件不一致。这里的时间是缓存中的事件，如果一致说明，还未触发缓存中事件的变更</span></span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;connections_reuse_time != ngx_time()) &#123;</span><br><span class="line">        cycle-&gt;connections_reuse_time = ngx_time();</span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_WARN, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"%ui worker_connections are not enough, "</span></span><br><span class="line">                      <span class="string">"reusing connections"</span>,</span><br><span class="line">                      cycle-&gt;connection_n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取要释放连接的个数，最少1个</span></span><br><span class="line">    n = ngx_max(ngx_min(<span class="number">32</span>, cycle-&gt;reusable_connections_n / <span class="number">8</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="comment">// 如果可复用连接已经为空，则break</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_queue_empty(&amp;cycle-&gt;reusable_connections_queue)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从双向链表的最后获取一个链表元素</span></span><br><span class="line">        q = ngx_queue_last(&amp;cycle-&gt;reusable_connections_queue);</span><br><span class="line">        <span class="comment">// 通过链表元素的地址，获取链接地址</span></span><br><span class="line">        c = ngx_queue_data(q, <span class="keyword">ngx_connection_t</span>, <span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_CORE, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"reusing connection"</span>);</span><br><span class="line">        <span class="comment">// 标志连接关闭</span></span><br><span class="line">        c-&gt;close = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 执行连接对应读事件的处理函数，注意，最终是否能够释放由对应的处理函数决定，即调用不一定保证一定能够释放当前连接</span></span><br><span class="line">        c-&gt;read-&gt;handler(c-&gt;read);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，这是静态方法，即是连接内部调用的方法。</p>
<h2 id="事件处理方法"><a href="#事件处理方法" class="headerlink" title="事件处理方法"></a>事件处理方法</h2><p>事件驱动，必然定义了很多对于事件的处理方法，这里进行详细介绍，主要包括epoll模块action中定义的一系列方法和一些主要的事件处理方法。</p>
<p>先来看一下epoll模块action定义的事件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static ngx_event_module_t  ngx_epoll_module_ctx = &#123;</span><br><span class="line">    &amp;epoll_name,</span><br><span class="line">    ngx_epoll_create_conf,               /* create configuration */</span><br><span class="line">    ngx_epoll_init_conf,                 /* init configuration */</span><br><span class="line">    // 对于下面的函数，后续会详细介绍</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_epoll_add_event,             /* add an event */</span><br><span class="line">        ngx_epoll_del_event,             /* delete an event */</span><br><span class="line">        ngx_epoll_add_event,             /* enable an event */</span><br><span class="line">        ngx_epoll_del_event,             /* disable an event */</span><br><span class="line">        ngx_epoll_add_connection,        /* add an connection */</span><br><span class="line">        ngx_epoll_del_connection,        /* delete an connection */</span><br><span class="line">#if (NGX_HAVE_EVENTFD)</span><br><span class="line">        ngx_epoll_notify,                /* trigger a notify */</span><br><span class="line">#else</span><br><span class="line">        NULL,                            /* trigger a notify */</span><br><span class="line">#endif</span><br><span class="line">        ngx_epoll_process_events,        /* process the events */</span><br><span class="line">        ngx_epoll_init,                  /* init the events */</span><br><span class="line">        ngx_epoll_done,                  /* done the events */</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-epoll-init初始化事件模块"><a href="#ngx-epoll-init初始化事件模块" class="headerlink" title="ngx_epoll_init初始化事件模块"></a>ngx_epoll_init初始化事件模块</h3><p>首先被调用的方法就是初始化事件模块，其处理过程在ngx_event_core_module的init_process方法中，即worker子进程刚启动后。其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_init(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_msec_t</span> timer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_epoll_conf_t</span>  *epcf;</span><br><span class="line">    <span class="comment">// 获取epoll事件模块创建的ngx_epoll_conf_t结构</span></span><br><span class="line">    epcf = ngx_event_get_conf(cycle-&gt;conf_ctx, ngx_epoll_module);</span><br><span class="line">    <span class="comment">// 如果epoll模块的描述符还未创建</span></span><br><span class="line">    <span class="keyword">if</span> (ep == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 执行构建</span></span><br><span class="line">        ep = epoll_create(cycle-&gt;connection_n / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ep == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"epoll_create() failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EVENTFD)</span></span><br><span class="line">        <span class="comment">// 初始化通知机制</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_epoll_notify_init(cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_epoll_module_ctx.actions.notify = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_FILE_AIO)</span></span><br><span class="line">        <span class="comment">// 初始化文件异步I/O</span></span><br><span class="line">        ngx_epoll_aio_init(cycle, epcf);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">        <span class="comment">// 测试事件能否监控客户端主动关闭连接</span></span><br><span class="line">        ngx_epoll_test_rdhup(cycle);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果用于事件返回时存储事件的数组小于配置中设置的每次返回的数量，则重新分配空间</span></span><br><span class="line">    <span class="keyword">if</span> (nevents &lt; epcf-&gt;events) &#123;</span><br><span class="line">        <span class="keyword">if</span> (event_list) &#123;</span><br><span class="line">            ngx_free(event_list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        event_list = ngx_alloc(<span class="keyword">sizeof</span>(struct epoll_event) * epcf-&gt;events,</span><br><span class="line">                               cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (event_list == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nevents = epcf-&gt;events;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对全局变量ngx_io和ngx_event_actions赋值，读写描述符操作</span></span><br><span class="line">    ngx_io = ngx_os_io;</span><br><span class="line">    </span><br><span class="line">    ngx_event_actions = ngx_epoll_module_ctx.actions;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_CLEAR_EVENT)</span></span><br><span class="line">    <span class="comment">// 设置事件flags</span></span><br><span class="line">    ngx_event_flags = NGX_USE_CLEAR_EVENT</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    ngx_event_flags = NGX_USE_LEVEL_EVENT</span><br><span class="line">#endif</span><br><span class="line">                      |NGX_USE_GREEDY_EVENT</span><br><span class="line">                      |NGX_USE_EPOLL_EVENT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-epoll-notify-init初始化消息提醒"><a href="#ngx-epoll-notify-init初始化消息提醒" class="headerlink" title="ngx_epoll_notify_init初始化消息提醒"></a>ngx_epoll_notify_init初始化消息提醒</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_notify_init(<span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>  <span class="title">ee</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取事件描述符</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SYS_EVENTFD_H)</span></span><br><span class="line">    notify_fd = eventfd(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    notify_fd = syscall(SYS_eventfd, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (notify_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_errno, <span class="string">"eventfd() failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"notify eventfd: %d"</span>, notify_fd);</span><br><span class="line">    <span class="comment">// 设置全局变量notify_event（ngx_event_t）</span></span><br><span class="line">    notify_event.handler = ngx_epoll_notify_handler;</span><br><span class="line">    notify_event.<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    notify_event.active = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置全局变量notify_conn（ngx_connection_t）</span></span><br><span class="line">    notify_conn.fd = notify_fd;</span><br><span class="line">    notify_conn.read = &amp;notify_event;</span><br><span class="line">    notify_conn.<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">// 设置epoll事件，监控可读，并且设置边缘触发</span></span><br><span class="line">    ee.events = EPOLLIN|EPOLLET;</span><br><span class="line">    ee.data.ptr = &amp;notify_conn;</span><br><span class="line">    <span class="comment">// 将消息提醒提交到全局的epoll事件监控中</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, EPOLL_CTL_ADD, notify_fd, &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_ctl(EPOLL_CTL_ADD, eventfd) failed"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (close(notify_fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                            <span class="string">"eventfd close() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="notify事件触发的处理方法"><a href="#notify事件触发的处理方法" class="headerlink" title="notify事件触发的处理方法"></a>notify事件触发的处理方法</h5><p>对于该事件的处理函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_epoll_notify_handler(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>               n;</span><br><span class="line">    <span class="keyword">uint64_t</span>              count;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>             err;</span><br><span class="line">    ngx_event_handler_pt  handler;</span><br><span class="line">    <span class="comment">// 如果连接使用已经超过最大值了，则清除eventfd中的计数，重新对index计数</span></span><br><span class="line">    <span class="keyword">if</span> (++ev-&gt;index == NGX_MAX_UINT32_VALUE) &#123;</span><br><span class="line">        ev-&gt;index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        n = read(notify_fd, &amp;count, <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>));</span><br><span class="line"></span><br><span class="line">        err = ngx_errno;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"read() eventfd %d: %z count:%uL"</span>, notify_fd, n, count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n != <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"read() eventfd %d failed"</span>, notify_fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行事件对应的函数</span></span><br><span class="line">    handler = ev-&gt;data;</span><br><span class="line">    handler(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于epoll使用的是边缘触发，因此不需要每次都执行read操作，因此这里只在必须使用的时候，才进行了read的调用。</p>
<h5 id="向notify中写入事件"><a href="#向notify中写入事件" class="headerlink" title="向notify中写入事件"></a>向notify中写入事件</h5><p>对应的，向notify_fd中写入事件的方法为：</p>
<p>ngx_epoll_module的action中的ngx_epoll_notify方法，其处理逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_notify(ngx_event_handler_pt handler)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">uint64_t</span> inc = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置消息处理函数</span></span><br><span class="line">    notify_event.data = handler;</span><br><span class="line">    <span class="comment">// 向notify_fd的计数器增加一个值，下次epoll_wait将会返回notify_fd对应的事件</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">size_t</span>) write(notify_fd, &amp;inc, <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)) != <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, notify_event.<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"write() to eventfd %d failed"</span>, notify_fd);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-epoll-aio-init初始化文件异步I-O"><a href="#ngx-epoll-aio-init初始化文件异步I-O" class="headerlink" title="ngx_epoll_aio_init初始化文件异步I/O"></a>ngx_epoll_aio_init初始化文件异步I/O</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_epoll_aio_init(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_epoll_conf_t</span> *epcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                 n;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>  <span class="title">ee</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化全局变量，ngx_eventfd事件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SYS_EVENTFD_H)</span></span><br><span class="line">    ngx_eventfd = eventfd(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    ngx_eventfd = syscall(SYS_eventfd, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 如果出错，表示不支持异步I/O</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_eventfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"eventfd() failed"</span>);</span><br><span class="line">        <span class="comment">// 设置异步I/O标志位为0</span></span><br><span class="line">        ngx_file_aio = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"eventfd: %d"</span>, ngx_eventfd);</span><br><span class="line"></span><br><span class="line">    n = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置事件描述符为非阻塞的</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(ngx_eventfd, FIONBIO, &amp;n) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"ioctl(eventfd, FIONBIO) failed"</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用配置中的aio_requests初始化文件I/O描述符全局变量ngx_aio_ctx</span></span><br><span class="line">    <span class="keyword">if</span> (io_setup(epcf-&gt;aio_requests, &amp;ngx_aio_ctx) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"io_setup() failed"</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置全局变量ngx_eventfd_event，用于异步I/O的读事件</span></span><br><span class="line">    ngx_eventfd_event.data = &amp;ngx_eventfd_conn;</span><br><span class="line">    <span class="comment">// 设置处理函数</span></span><br><span class="line">    ngx_eventfd_event.handler = ngx_epoll_eventfd_handler;</span><br><span class="line">    ngx_eventfd_event.<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line">    ngx_eventfd_event.active = <span class="number">1</span>;</span><br><span class="line">    ngx_eventfd_conn.fd = ngx_eventfd;</span><br><span class="line">    <span class="comment">// 绑定全局的ngx_eventfd_conn异步I/O的连接</span></span><br><span class="line">    ngx_eventfd_conn.read = &amp;ngx_eventfd_event;</span><br><span class="line">    ngx_eventfd_conn.<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">// 添加可读事件并设置边缘触发到全局事件驱动中</span></span><br><span class="line">    ee.events = EPOLLIN|EPOLLET;</span><br><span class="line">    ee.data.ptr = &amp;ngx_eventfd_conn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, EPOLL_CTL_ADD, ngx_eventfd, &amp;ee) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                  <span class="string">"epoll_ctl(EPOLL_CTL_ADD, eventfd) failed"</span>);</span><br><span class="line">    <span class="comment">// 如果没有成功添加文件异步I/O事件则销毁异步I/O描述符</span></span><br><span class="line">    <span class="keyword">if</span> (io_destroy(ngx_aio_ctx) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"io_destroy() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (close(ngx_eventfd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"eventfd close() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_eventfd = <span class="number">-1</span>;</span><br><span class="line">    ngx_aio_ctx = <span class="number">0</span>;</span><br><span class="line">    ngx_file_aio = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将系统的eventfd和文件异步I/O描述符和epoll三者进行关联。在epoll中监控系统eventfd（ngx_eventfd），在异步I/O中添加读取事件时，利用iocb中的aio_resfd（异步通知的fd）绑定到eventfd（ngx_eventfd）上。当异步I/O事件后，epoll_wait()将会返回eventfd（ngx_eventfd）对应的事件，并将eventfd（ngx_eventfd）计数加一，其中事件的ptr指针，指向ngx_eventfd_conn，执行ngx_eventfd_conn的read事件中的方法ngx_epoll_eventfd_handler。ngx_epoll_eventfd_handler方法将通过异步I/O描述符全局变量ngx_aio_ctx获取已完成的事件。</p>
<p>下面分别看一下如何条件异步I/O事件和处理异步I/O事件。</p>
<h5 id="增加异步I-O事件"><a href="#增加异步I-O事件" class="headerlink" title="增加异步I/O事件"></a>增加异步I/O事件</h5><p><code>ngx_file_aio_read</code>函数向ngx_aio_ctx描述符中条件异步I/O事件。</p>
<p>其中ngx_event_aio_t结构定义了添加异步I/O的相关结构，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_event_aio_s</span> &#123;</span>    <span class="keyword">void</span>                      *data;    <span class="comment">// 异步I/O事件完成后被调用的方法    ngx_event_handler_pt       handler;    ngx_file_t                *file;    ngx_fd_t                   fd;#if (NGX_HAVE_AIO_SENDFILE || NGX_COMPAT)    ssize_t                  (*preload_handler)(ngx_buf_t *file);#endif#if (NGX_HAVE_EVENTFD)    // 对应io_getevents返回的ngx_event_aio_t结构中的res，用于判断标志是否执行成功    int64_t                    res;#endif#if !(NGX_HAVE_EVENTFD) || (NGX_TEST_BUILD_EPOLL)    ngx_err_t                  err;    size_t                     nbytes;#endif    // 添加异步I/O事件的结构    ngx_aiocb_t                aiocb;    // 绑定的事件，用于完成异步I/O后执行相应操作    ngx_event_t                event;&#125;;</span></span><br></pre></td></tr></table></figure>
<p>对于文件来说，nginx定义了ngx_file_t结构，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">stat</span>              <span class="title">ngx_file_info_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_file_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// 文件描述符</span></span><br><span class="line">    <span class="keyword">ngx_fd_t</span>                   fd;</span><br><span class="line">    <span class="comment">// 文件名</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  name;</span><br><span class="line">    <span class="comment">// 文件信息</span></span><br><span class="line">    <span class="keyword">ngx_file_info_t</span>            info;</span><br><span class="line">    <span class="comment">// 游标偏移</span></span><br><span class="line">    <span class="keyword">off_t</span>                      offset;</span><br><span class="line">    <span class="keyword">off_t</span>                      sys_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_THREADS || NGX_COMPAT)</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                (*thread_handler)(<span class="keyword">ngx_thread_task_t</span> *task,</span><br><span class="line">                                               <span class="keyword">ngx_file_t</span> *file);</span><br><span class="line">    <span class="keyword">void</span>                      *thread_ctx;</span><br><span class="line">    <span class="keyword">ngx_thread_task_t</span>         *thread_task;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_FILE_AIO || NGX_COMPAT)</span></span><br><span class="line">    <span class="comment">// 异步I/O结构</span></span><br><span class="line">    <span class="keyword">ngx_event_aio_t</span>           *aio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                   valid_info:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                   directio:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体添加函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span></span><br><span class="line">ngx_file_aio_read(<span class="keyword">ngx_file_t</span> *file, u_char *buf, <span class="keyword">size_t</span> size, <span class="keyword">off_t</span> offset,</span><br><span class="line">    <span class="keyword">ngx_pool_t</span> *pool)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>         err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span>      *<span class="title">piocb</span>[1];</span></span><br><span class="line">    <span class="keyword">ngx_event_t</span>      *ev;</span><br><span class="line">    <span class="keyword">ngx_event_aio_t</span>  *aio;</span><br><span class="line">    <span class="comment">// 如果不支持异步I/O则使用线程读取的系统调用方式，这里不讨论</span></span><br><span class="line">    <span class="keyword">if</span> (!ngx_file_aio) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_read_file(file, buf, size, offset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果文件中的aio未设置，则初始化文件的aio</span></span><br><span class="line">    <span class="keyword">if</span> (file-&gt;aio == <span class="literal">NULL</span> &amp;&amp; ngx_file_aio_init(file, pool) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取文件绑定的aio</span></span><br><span class="line">    aio = file-&gt;aio;</span><br><span class="line">    <span class="comment">// 获取异步I/O对应的事件</span></span><br><span class="line">    ev = &amp;aio-&gt;event;</span><br><span class="line">    <span class="comment">// 如果事件是非可读的报错</span></span><br><span class="line">    <span class="keyword">if</span> (!ev-&gt;ready) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, file-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"second aio post for \"%V\""</span>, &amp;file-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug4(NGX_LOG_DEBUG_CORE, file-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"aio complete:%d @%O:%uz %V"</span>,</span><br><span class="line">                   ev-&gt;complete, offset, size, &amp;file-&gt;name);</span><br><span class="line">    <span class="comment">// 如果事件已经完成</span></span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;complete) &#123;</span><br><span class="line">        ev-&gt;active = <span class="number">0</span>;</span><br><span class="line">        ev-&gt;complete = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 如果事件完成，并且res（异步事件完成返回）正确，则设置errno为0，即无错误，返回</span></span><br><span class="line">        <span class="keyword">if</span> (aio-&gt;res &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_set_errno(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> aio-&gt;res;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则设置报错，返回error</span></span><br><span class="line">        ngx_set_errno(-aio-&gt;res);</span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, file-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"aio read \"%s\" failed"</span>, file-&gt;name.data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配aiocb空间</span></span><br><span class="line">    ngx_memzero(&amp;aio-&gt;aiocb, <span class="keyword">sizeof</span>(struct iocb));</span><br><span class="line">    <span class="comment">// 设置aiocb。绑定aio_data为事件ev</span></span><br><span class="line">    aio-&gt;aiocb.aio_data = (<span class="keyword">uint64_t</span>) (<span class="keyword">uintptr_t</span>) ev;</span><br><span class="line">    aio-&gt;aiocb.aio_lio_opcode = IOCB_CMD_PREAD;</span><br><span class="line">    aio-&gt;aiocb.aio_fildes = file-&gt;fd;</span><br><span class="line">    aio-&gt;aiocb.aio_buf = (<span class="keyword">uint64_t</span>) (<span class="keyword">uintptr_t</span>) buf;</span><br><span class="line">    aio-&gt;aiocb.aio_nbytes = size;</span><br><span class="line">    aio-&gt;aiocb.aio_offset = offset;</span><br><span class="line">    <span class="comment">// 设置异步读事件</span></span><br><span class="line">    aio-&gt;aiocb.aio_flags = IOCB_FLAG_RESFD;</span><br><span class="line">    <span class="comment">// 绑定事件完成的通知到全局变量ngx_eventfd</span></span><br><span class="line">    aio-&gt;aiocb.aio_resfd = ngx_eventfd;</span><br><span class="line">    <span class="comment">// 设置事件完成的执行函数</span></span><br><span class="line">    ev-&gt;handler = ngx_file_aio_event_handler;</span><br><span class="line"></span><br><span class="line">    piocb[<span class="number">0</span>] = &amp;aio-&gt;aiocb;</span><br><span class="line">    <span class="comment">// 向ngx_aio_ctx添加读事件</span></span><br><span class="line">    <span class="keyword">if</span> (io_submit(ngx_aio_ctx, <span class="number">1</span>, piocb) == <span class="number">1</span>) &#123;</span><br><span class="line">        ev-&gt;active = <span class="number">1</span>;</span><br><span class="line">        ev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">        ev-&gt;complete = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = ngx_errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == NGX_EAGAIN) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_read_file(file, buf, size, offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_CRIT, file-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                  <span class="string">"io_submit(\"%V\") failed"</span>, &amp;file-&gt;name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == NGX_ENOSYS) &#123;</span><br><span class="line">        ngx_file_aio = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> ngx_read_file(file, buf, size, offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里初始化aio方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ngx_int_t</span><br><span class="line">ngx_file_aio_init(ngx_file_t *file, ngx_pool_t *pool)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_event_aio_t  *aio;</span><br><span class="line">    // 分配内存</span><br><span class="line">    aio = ngx_pcalloc(pool, sizeof(ngx_event_aio_t));</span><br><span class="line">    if (aio == NULL) &#123;</span><br><span class="line">        return NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 绑定文件</span><br><span class="line">    aio-&gt;file = file;</span><br><span class="line">    aio-&gt;fd = file-&gt;fd;</span><br><span class="line">    // 绑定event的data为aio本身</span><br><span class="line">    aio-&gt;event.data = aio;</span><br><span class="line">    aio-&gt;event.ready = 1;</span><br><span class="line">    aio-&gt;event.log = file-&gt;log;</span><br><span class="line">    // 设置文件aio为aio</span><br><span class="line">    file-&gt;aio = aio;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，上述的处理中对ngx_event_aio_t结构的handler未进行处理，但该值是必须要有的，因为后续会使用（下一节介绍），这里对handler的赋值可能在执行ngx_file_aio_read前，即已经完成file中aio的分配，并设置了aio的handler。或者在函数返回后，设置file中的aio成员handler。因为在所有事件传递中都是传递的指针，因此在事件添加后再进行对aio的变更并不会有问题。</p>
<h5 id="epoll事件异步I-O返回的处理"><a href="#epoll事件异步I-O返回的处理" class="headerlink" title="epoll事件异步I/O返回的处理"></a>epoll事件异步I/O返回的处理</h5><p>在初始化aio时，设置的事件触发后的执行函数为ngx_epoll_eventfd_handler，其执行逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_epoll_eventfd_handler(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>               n, events;</span><br><span class="line">    <span class="keyword">long</span>              i;</span><br><span class="line">    <span class="keyword">uint64_t</span>          ready;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>         err;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>      *e;</span><br><span class="line">    <span class="keyword">ngx_event_aio_t</span>  *aio;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_event</span>   <span class="title">event</span>[64];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>   <span class="title">ts</span>;</span></span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"eventfd handler"</span>);</span><br><span class="line">    <span class="comment">// 从ngx_eventfd中读取异步I/O事件完成数量，存到ready中。</span></span><br><span class="line">    n = read(ngx_eventfd, &amp;ready, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    err = ngx_errno;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"eventfd: %d"</span>, n);</span><br><span class="line">    <span class="comment">// 如果读取到的字符数量不为8，则表示存在错误，进行错误处理</span></span><br><span class="line">    <span class="keyword">if</span> (n != <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EAGAIN) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, err, <span class="string">"read(eventfd) failed"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"read(eventfd) returned only %d bytes"</span>, n);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置io_getevents超时时间为0，即立即返回</span></span><br><span class="line">    ts.tv_sec = <span class="number">0</span>;</span><br><span class="line">    ts.tv_nsec = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果还有事件未处理完成</span></span><br><span class="line">    <span class="keyword">while</span> (ready) &#123;</span><br><span class="line">        <span class="comment">// 从ngx_aio_ctx获取已经完成的异步事件，最少返回1个，最多返回64个</span></span><br><span class="line">        events = io_getevents(ngx_aio_ctx, <span class="number">1</span>, <span class="number">64</span>, event, &amp;ts);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"io_getevents: %d"</span>, events);</span><br><span class="line">        <span class="comment">// 如果获取到事件大于0</span></span><br><span class="line">        <span class="keyword">if</span> (events &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 减去此次处理的事件</span></span><br><span class="line">            ready -= events;</span><br><span class="line">            <span class="comment">// 遍历每个事件</span></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; events; i++) &#123;</span><br><span class="line"></span><br><span class="line">                ngx_log_debug4(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"io_event: %XL %XL %L %L"</span>,</span><br><span class="line">                                event[i].data, event[i].obj,</span><br><span class="line">                                event[i].res, event[i].res2);</span><br><span class="line">                <span class="comment">// 获取事件对应的data数据，其中data为添加事件时aiocb.aio_data，即aiocb对应的事件。</span></span><br><span class="line">                e = (<span class="keyword">ngx_event_t</span> *) (<span class="keyword">uintptr_t</span>) event[i].data;</span><br><span class="line">                <span class="comment">// 设置异步事件为完成状态</span></span><br><span class="line">                e-&gt;complete = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 设置事件不活跃了</span></span><br><span class="line">                e-&gt;active = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 事件处于可处理状态</span></span><br><span class="line">                e-&gt;ready = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                aio = e-&gt;data;</span><br><span class="line">                <span class="comment">// 设置事件绑定的aiocb结构的res为事件返回的res，即是否成功（&gt;=0表示成功）</span></span><br><span class="line">                aio-&gt;res = event[i].res;</span><br><span class="line">                <span class="comment">// 向ngx_posted_events队列增加事件。后续执行事件e的handler方法</span></span><br><span class="line">                ngx_post_event(e, &amp;ngx_posted_events);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果获取到的事件数量为0，则直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (events == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果出错，则报错返回</span></span><br><span class="line">        <span class="comment">/* events == -1 */</span></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"io_getevents() failed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里虽然我们通过读取read(ngx_eventfd, &amp;ready, 8)获取已经准备完成的异步I/O事件数量，但实际处理的数量不一定就是ready中的值。有可能大于，有可能小于，有可能等于。</p>
<p>这是因为，在调用read后，循环执行的过程中，可能还有新的异步I/O事件完成，此时，在while循环中可能将新的完成事件也返回，这时，本轮就会处理比从read中读取的异步I/O完成的事件多的时间。同时这可能导致下一轮循环时，处理的事件少于从read中读取的数量，因此在上一轮已经处理了一部分了。</p>
<p>这里执行的事件处理函数为在添加异步I/O事件时，事件绑定的handler：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_file_aio_event_handler(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_aio_t</span>  *aio;</span><br><span class="line">    <span class="comment">// 获取事件指向的ngx_event_aio_t结构，这里是添加事件时的ngx_event_aio_t结构的ngx_aiocb_t成员aiocb</span></span><br><span class="line">    aio = ev-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_CORE, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"aio event handler fd:%d %V"</span>, aio-&gt;fd, &amp;aio-&gt;file-&gt;name);</span><br><span class="line">    <span class="comment">// 执行aiocb绑定的handler函数</span></span><br><span class="line">    aio-&gt;handler(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为最终会执行aiocb绑定的handler方法，因此上文说过在添加异步I/O一定要保证设置了handler方法。</p>
<h4 id="ngx-epoll-test-rdhup测试epoll监听事件"><a href="#ngx-epoll-test-rdhup测试epoll监听事件" class="headerlink" title="ngx_epoll_test_rdhup测试epoll监听事件"></a>ngx_epoll_test_rdhup测试epoll监听事件</h4><p>ngx_epoll_test_rdhup方法用来测试是否能够监听客户端主动关闭连接。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_epoll_test_rdhup(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                 s[<span class="number">2</span>], events;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>  <span class="title">ee</span>;</span></span><br><span class="line">    <span class="comment">// 建立一组unix域套接字</span></span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, s) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"socketpair() failed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 事件建库，边缘触发，可读（主动关闭连接其实属于可读）和主动关闭连接</span></span><br><span class="line">    ee.events = EPOLLET|EPOLLIN|EPOLLRDHUP;</span><br><span class="line">    <span class="comment">// 在第一个套接字中监听事件</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, EPOLL_CTL_ADD, s[<span class="number">0</span>], &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_ctl() failed"</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭第二个套接字</span></span><br><span class="line">    <span class="keyword">if</span> (close(s[<span class="number">1</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"close() failed"</span>);</span><br><span class="line">        s[<span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s[<span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 获取触发的事件</span></span><br><span class="line">    events = epoll_wait(ep, &amp;ee, <span class="number">1</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (events == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_wait() failed"</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果正常获取到事件</span></span><br><span class="line">    <span class="keyword">if</span> (events) &#123;</span><br><span class="line">        <span class="comment">// 是否存在建库主动关闭连接</span></span><br><span class="line">        ngx_use_epoll_rdhup = ee.events &amp; EPOLLRDHUP;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, NGX_ETIMEDOUT,</span><br><span class="line">                      <span class="string">"epoll_wait() timed out"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"testing the EPOLLRDHUP flag: %s"</span>,</span><br><span class="line">                   ngx_use_epoll_rdhup ? <span class="string">"success"</span> : <span class="string">"fail"</span>);</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s[<span class="number">1</span>] != <span class="number">-1</span> &amp;&amp; close(s[<span class="number">1</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"close() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (close(s[<span class="number">0</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"close() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-epoll-process-events事件处理"><a href="#ngx-epoll-process-events事件处理" class="headerlink" title="ngx_epoll_process_events事件处理"></a>ngx_epoll_process_events事件处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timer为调用epoll_wait等待时间，flags为按位的flags</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_process_events(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_msec_t</span> timer, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                events;</span><br><span class="line">    <span class="keyword">uint32_t</span>           revents;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>          instance, i;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         level;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>          err;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>       *rev, *wev;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>       *<span class="built_in">queue</span>;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* NGX_TIMER_INFINITE == INFTIM */</span></span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"epoll timer: %M"</span>, timer);</span><br><span class="line">    <span class="comment">// 获取触发事件</span></span><br><span class="line">    events = epoll_wait(ep, event_list, (<span class="keyword">int</span>) nevents, timer);</span><br><span class="line"></span><br><span class="line">    err = (events == <span class="number">-1</span>) ? ngx_errno : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果flags指示需要更新缓存中的时间，或者定义更新时间的信号已触发，则更新缓存中事件。时间相关内容在后续定时事件介绍</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_UPDATE_TIME || ngx_event_timer_alarm) &#123;</span><br><span class="line">        ngx_time_update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// 错误时记录日志</span></span><br><span class="line">        <span class="keyword">if</span> (err == NGX_EINTR) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_event_timer_alarm) &#123;</span><br><span class="line">                ngx_event_timer_alarm = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            level = NGX_LOG_INFO;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            level = NGX_LOG_ALERT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_error(level, cycle-&gt;<span class="built_in">log</span>, err, <span class="string">"epoll_wait() failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回事件数量为0</span></span><br><span class="line">    <span class="keyword">if</span> (events == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是非阻塞调用，返回0为正常</span></span><br><span class="line">        <span class="keyword">if</span> (timer != NGX_TIMER_INFINITE) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"epoll_wait() returned no events without timeout"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理每个事件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; events; i++) &#123;</span><br><span class="line">        <span class="comment">// 获取事件对应的ngx_connection_t结构</span></span><br><span class="line">        c = event_list[i].data.ptr;</span><br><span class="line">        <span class="comment">// 获取连接地址中存储的instance标志位</span></span><br><span class="line">        instance = (<span class="keyword">uintptr_t</span>) c &amp; <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 恢复正常的连接地址</span></span><br><span class="line">        c = (<span class="keyword">ngx_connection_t</span> *) ((<span class="keyword">uintptr_t</span>) c &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 获取连接对应的读事件</span></span><br><span class="line">        rev = c-&gt;read;</span><br><span class="line">        <span class="comment">// 如果连接对应的套接字已经被关闭或者为过期事件，则跳过执行</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;fd == <span class="number">-1</span> || rev-&gt;instance != instance) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * the stale event from a file descriptor</span></span><br><span class="line"><span class="comment">             * that was just closed in this iteration</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"epoll: stale event %p"</span>, c);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取触发事件类型</span></span><br><span class="line">        revents = event_list[i].events;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"epoll: fd:%d ev:%04XD d:%p"</span>,</span><br><span class="line">                       c-&gt;fd, revents, event_list[i].data.ptr);</span><br><span class="line">        <span class="comment">/* 如果对应的连接发送错误或者被挂起，则赋值事件为可读和可写，让对应的读事件和写事件来进行对错误和挂起进行响应,因此读写事件对应的处理函数，不能单纯只处理读写事件，需要判断是否发送错误 */</span></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; (EPOLLERR|EPOLLHUP)) &#123;</span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"epoll_wait() error on fd:%d ev:%04XD"</span>,</span><br><span class="line">                           c-&gt;fd, revents);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * if the error events were returned, add EPOLLIN and EPOLLOUT</span></span><br><span class="line"><span class="comment">             * to handle the events at least in one active handler</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            revents |= EPOLLIN|EPOLLOUT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; ~(EPOLLIN|EPOLLOUT|EPOLLERR|EPOLLHUP)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"strange epoll_wait() events fd:%d ev:%04XD"</span>,</span><br><span class="line">                          c-&gt;fd, revents);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 事件可读处理，需要读事件依然活跃</span></span><br><span class="line">        <span class="keyword">if</span> ((revents &amp; EPOLLIN) &amp;&amp; rev-&gt;active) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">            <span class="comment">// 如果客户端关闭连接，则标识位置1</span></span><br><span class="line">            <span class="keyword">if</span> (revents &amp; EPOLLRDHUP) &#123;</span><br><span class="line">                rev-&gt;pending_eof = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 准备处理的标志位置1</span></span><br><span class="line">            rev-&gt;ready = <span class="number">1</span>;</span><br><span class="line">            rev-&gt;available = <span class="number">-1</span>;</span><br><span class="line">            <span class="comment">// 如果flags标识位表明延后处理</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; NGX_POST_EVENTS) &#123;</span><br><span class="line">                <span class="comment">// 如果事件是监听连接事件，则加入ngx_posted_accept_events队列，否则加入ngx_posted_events队列</span></span><br><span class="line">                <span class="built_in">queue</span> = rev-&gt;accept ? &amp;ngx_posted_accept_events</span><br><span class="line">                                    : &amp;ngx_posted_events;</span><br><span class="line"></span><br><span class="line">                ngx_post_event(rev, <span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则立即执行</span></span><br><span class="line">                rev-&gt;handler(rev);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取写事件</span></span><br><span class="line">        wev = c-&gt;write;</span><br><span class="line">        <span class="comment">// 事件捕获为写事件，并且写事件活跃</span></span><br><span class="line">        <span class="keyword">if</span> ((revents &amp; EPOLLOUT) &amp;&amp; wev-&gt;active) &#123;</span><br><span class="line">            <span class="comment">// 如果写事件过期了，则跳过处理</span></span><br><span class="line">            <span class="keyword">if</span> (c-&gt;fd == <span class="number">-1</span> || wev-&gt;instance != instance) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * the stale event from a file descriptor</span></span><br><span class="line"><span class="comment">                 * that was just closed in this iteration</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"epoll: stale event %p"</span>, c);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            wev-&gt;ready = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_THREADS)</span></span><br><span class="line">            wev-&gt;complete = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">             <span class="comment">// 判断是否立即执行</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; NGX_POST_EVENTS) &#123;</span><br><span class="line">                ngx_post_event(wev, &amp;ngx_posted_events);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                wev-&gt;handler(wev);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两点需要详细进行介绍，一个是延迟处理，另一个是事件过期标志。</p>
<p>事件处理支持将每个触发的事件进行延后处理，其实现是一个双向链表，这里将要延后处理的事件添加到上线链表中，在执行完成<code>ngx_epoll_process_events</code>事件后，再依次执行添加进双向链表中的事件，执行每个的handler函数。</p>
<p><code>ngx_events_t</code>中存在一个<code>instance</code>成员用来和连接的地址的最后一位比对，判断是否为过期连接。一般我们在释放连接时，会将对应的fd置为-1。这样也可以作为事件过期标志，但是这无法解决所有问题。例如如下一个场景：有三个事件触发了，第一个事件处理中·关闭了一个连接，这个连接恰好对应第三个事件，这样的化，处理第三个事件就是过期事件了。第一个事件会可能会调用<code>ngx_free_connection</code>将fd置为-1，并将连接归还连接池中。但第二个事件建立一个新连接，会调用<code>ngx_get_connection</code>(查看连接池章节)从连接池中获取一个连接，这很可能会是我们上一个事件释放的连接。这时会重新对连接的fd赋值，此时只使用fd就无法判断过期状态了。</p>
<p>对于上述问题解决方案是，在<code>ngx_get_connection</code>中获取连接池时，会将连接对应读写事件的instance置反，这时就可以通过判断事件ptr指针的最后一位（利用指针最后两位一定为0，使用最后一位作为标志位）是否与事件的instance一致来判断是否为过期事件。正常情况下事件的instance和事件返回的ptr指针最后一位一致。</p>
<p>将事件的instance和事件的ptr指针设置为相同发生在添加事件时，下文会详细介绍。</p>
<p>因此整体流程是：添加事件时，连接绑定的事件的instance和事件返回的ptr指针（指向连接）的最后一位一致，之后释放连接，当再次使用连接时，将连接对应的读写事件结构的instance取反，此时事件的instance和ptr的最后一位不一致，用于判断为过期事件，最后再将事件添加到epoll驱动时，将监控事件的结构ptr（执行连接）的最后一位和连接绑定的事件的instance统一。</p>
<p>不失一般性，假设从开始将事件加入epoll时，ptr指针的最后一位和事件的instance都是0（也可以都是1，但要一致）开始，则这两个变量值的随事件流转变化可以表示为如下图形式：</p>
<p><a href="https://imgtu.com/i/5J4rrD" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/10/16/5J4rrD.png" alt="5J4rrD.png"></a></p>
<p>对于添加事件到epoll接下来详细介绍。</p>
<h3 id="ngx-epoll-add-event添加事件到epoll中"><a href="#ngx-epoll-add-event添加事件到epoll中" class="headerlink" title="ngx_epoll_add_event添加事件到epoll中"></a>ngx_epoll_add_event添加事件到epoll中</h3><p>该方法向epoll中添加监听事件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event表示是读事件还是写事件，flags标注关注的事件，即epoll_event结构的events</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_add_event(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_int_t</span> event, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                  op;</span><br><span class="line">    <span class="keyword">uint32_t</span>             events, prev;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>         *e;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>    *c;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>   <span class="title">ee</span>;</span></span><br><span class="line">    <span class="comment">// 获取事件对应的连接</span></span><br><span class="line">    c = ev-&gt;data;</span><br><span class="line"></span><br><span class="line">    events = (<span class="keyword">uint32_t</span>) event;</span><br><span class="line">    <span class="comment">/* 未避免同一个连接被加入两次到epoll中，在加入读事件或者写事件时，需要先判断另一个事件是否已经处于监听状态了 */</span></span><br><span class="line">    <span class="comment">// 读事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (event == NGX_READ_EVENT) &#123;</span><br><span class="line">        <span class="comment">// 获取读事件，并存储读事件监听的事件</span></span><br><span class="line">        e = c-&gt;write;</span><br><span class="line">        prev = EPOLLOUT;</span><br><span class="line"><span class="comment">// 不会执行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_READ_EVENT != EPOLLIN|EPOLLRDHUP)</span></span><br><span class="line">        events = EPOLLIN|EPOLLRDHUP;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 写事件处理</span></span><br><span class="line">        <span class="comment">// 获取读事件，记录读事件监听</span></span><br><span class="line">        e = c-&gt;read;</span><br><span class="line">        prev = EPOLLIN|EPOLLRDHUP;</span><br><span class="line"><span class="comment">// linux下不会执行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WRITE_EVENT != EPOLLOUT)</span></span><br><span class="line">        events = EPOLLOUT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果对应的另一个事件是活跃的，表示是只需要对事件进行变更，变更时要保留原本的监听事件</span></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;active) &#123;</span><br><span class="line">        op = EPOLL_CTL_MOD;</span><br><span class="line">        events |= prev;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则添加事件</span></span><br><span class="line">        op = EPOLL_CTL_ADD;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// linux不会执行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLEXCLUSIVE &amp;&amp; NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_EXCLUSIVE_EVENT) &#123;</span><br><span class="line">        events &amp;= ~EPOLLRDHUP;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置关注事件</span></span><br><span class="line">    ee.events = events | (<span class="keyword">uint32_t</span>) flags;</span><br><span class="line">    <span class="comment">// 设置执行连接的指针，并设置最后一位</span></span><br><span class="line">    ee.data.ptr = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) c | ev-&gt;instance);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug3(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"epoll add event: fd:%d op:%d ev:%08XD"</span>,</span><br><span class="line">                   c-&gt;fd, op, ee.events);</span><br><span class="line">    <span class="comment">// 添加事件</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, op, c-&gt;fd, &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_ctl(%d, %d) failed"</span>, op, c-&gt;fd);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置事件为活跃状态</span></span><br><span class="line">    ev-&gt;active = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ev-&gt;oneshot = (flags &amp; NGX_ONESHOT_EVENT) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-epoll-del-event从epoll中删除事件"><a href="#ngx-epoll-del-event从epoll中删除事件" class="headerlink" title="ngx_epoll_del_event从epoll中删除事件"></a>ngx_epoll_del_event从epoll中删除事件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_del_event(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_int_t</span> event, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                  op;</span><br><span class="line">    <span class="keyword">uint32_t</span>             prev;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>         *e;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>    *c;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>   <span class="title">ee</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * when the file descriptor is closed, the epoll automatically deletes</span></span><br><span class="line"><span class="comment">     * it from its queue, so we do not need to delete explicitly the event</span></span><br><span class="line"><span class="comment">     * before the closing the file descriptor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 如果是关闭事件，则直接将active置为0即可，即使事件触发，也不会做任何操作。同时，如果文件描述符被关闭，事件将不会再触发</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_CLOSE_EVENT) &#123;</span><br><span class="line">        ev-&gt;active = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取对应连接结构</span></span><br><span class="line">    c = ev-&gt;data;</span><br><span class="line">    <span class="comment">// 与添加事件时一致，删除事件时也需要先判断另一个事件是否在监听状态，如果是则只能变更监听事件</span></span><br><span class="line">    <span class="comment">// 写事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (event == NGX_READ_EVENT) &#123;</span><br><span class="line">        <span class="comment">// 获取对应读事件，并记录读事件监听标志</span></span><br><span class="line">        e = c-&gt;write;</span><br><span class="line">        prev = EPOLLOUT;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取对写事件，记录写事件监听标志</span></span><br><span class="line">        e = c-&gt;read;</span><br><span class="line">        prev = EPOLLIN|EPOLLRDHUP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果对应的另一个事件依然存活，则变更监听</span></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;active) &#123;</span><br><span class="line">        op = EPOLL_CTL_MOD;</span><br><span class="line">        ee.events = prev | (<span class="keyword">uint32_t</span>) flags;</span><br><span class="line">        ee.data.ptr = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) c | ev-&gt;instance);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则关闭监听</span></span><br><span class="line">        op = EPOLL_CTL_DEL;</span><br><span class="line">        ee.events = <span class="number">0</span>;</span><br><span class="line">        ee.data.ptr = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug3(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"epoll del event: fd:%d op:%d ev:%08XD"</span>,</span><br><span class="line">                   c-&gt;fd, op, ee.events);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, op, c-&gt;fd, &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ev-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_ctl(%d, %d) failed"</span>, op, c-&gt;fd);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置对应事件不再活跃</span></span><br><span class="line">    ev-&gt;active = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-epoll-add-connection"><a href="#ngx-epoll-add-connection" class="headerlink" title="ngx_epoll_add_connection"></a>ngx_epoll_add_connection</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_add_connection(<span class="keyword">ngx_connection_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>  <span class="title">ee</span>;</span></span><br><span class="line">    <span class="comment">// 设置监听可读、可写、客户端主动关闭，和边缘触发</span></span><br><span class="line">    ee.events = EPOLLIN|EPOLLOUT|EPOLLET|EPOLLRDHUP;</span><br><span class="line">    <span class="comment">// 设置过期指针</span></span><br><span class="line">    ee.data.ptr = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) c | c-&gt;read-&gt;instance);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"epoll add connection: fd:%d ev:%08XD"</span>, c-&gt;fd, ee.events);</span><br><span class="line">    <span class="comment">// 添加事件</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, EPOLL_CTL_ADD, c-&gt;fd, &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_ctl(EPOLL_CTL_ADD, %d) failed"</span>, c-&gt;fd);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置读写均活跃</span></span><br><span class="line">    c-&gt;read-&gt;active = <span class="number">1</span>;</span><br><span class="line">    c-&gt;write-&gt;active = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-epoll-del-connection客户端关闭连接"><a href="#ngx-epoll-del-connection客户端关闭连接" class="headerlink" title="ngx_epoll_del_connection客户端关闭连接"></a>ngx_epoll_del_connection客户端关闭连接</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_epoll_del_connection(<span class="keyword">ngx_connection_t</span> *c, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                 op;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>  <span class="title">ee</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * when the file descriptor is closed the epoll automatically deletes</span></span><br><span class="line"><span class="comment">     * it from its queue so we do not need to delete explicitly the event</span></span><br><span class="line"><span class="comment">     * before the closing the file descriptor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 如果是关闭事件，则设置读写均不再活跃即可</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_CLOSE_EVENT) &#123;</span><br><span class="line">        c-&gt;read-&gt;active = <span class="number">0</span>;</span><br><span class="line">        c-&gt;write-&gt;active = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"epoll del connection: fd:%d"</span>, c-&gt;fd);</span><br><span class="line">    <span class="comment">// 否则从epoll中删除事件</span></span><br><span class="line">    op = EPOLL_CTL_DEL;</span><br><span class="line">    ee.events = <span class="number">0</span>;</span><br><span class="line">    ee.data.ptr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, op, c-&gt;fd, &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll_ctl(%d, %d) failed"</span>, op, c-&gt;fd);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置读写均不再活跃</span></span><br><span class="line">    c-&gt;read-&gt;active = <span class="number">0</span>;</span><br><span class="line">    c-&gt;write-&gt;active = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ngx_epoll_add_connection</code>和<code>ngx_epoll_del_connection</code>与<code>ngx_epoll_add_event</code>和<code>ngx_epoll_del_event</code>区别是前两者是在连接纬度(包括读写两个事件)进行添加和删除事件，而后两者是在事件纬度（单独的读或者写事件纬度）进行添加或删除事件。</p>
<h3 id="ngx-epoll-done结束事件处理"><a href="#ngx-epoll-done结束事件处理" class="headerlink" title="ngx_epoll_done结束事件处理"></a>ngx_epoll_done结束事件处理</h3><p>在关闭nginx前，会释放epoll模块创建的资源，这时会执行该操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_epoll_done(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 关闭全局epoll事件描述符</span></span><br><span class="line">    <span class="keyword">if</span> (close(ep) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"epoll close() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ep = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EVENTFD)</span></span><br><span class="line">    <span class="comment">// 关闭全局消息提醒notify_fd事件描述符</span></span><br><span class="line">    <span class="keyword">if</span> (close(notify_fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"eventfd close() failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notify_fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_FILE_AIO)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_eventfd != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 关闭全局文件异步I/O ngx_aio_ctx 描述符</span></span><br><span class="line">        <span class="keyword">if</span> (io_destroy(ngx_aio_ctx) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"io_destroy() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (close(ngx_eventfd) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"eventfd close() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_eventfd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_aio_ctx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 舒服全局epoll_wait返回事件数组分配的地址</span></span><br><span class="line">    ngx_free(event_list);</span><br><span class="line"></span><br><span class="line">    event_list = <span class="literal">NULL</span>;</span><br><span class="line">    nevents = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定时器事件"><a href="#定时器事件" class="headerlink" title="定时器事件"></a>定时器事件</h2><p>上文介绍的所有模块都是基于I/O操作的事件驱动，这样并不能解决所有问题。这样做不到每个连接内的多阶段处理，因此nginx架构自身实现了基于事件的定时器事件。</p>
<p>定时器的实现是利用一颗以时间作为key的红黑树。在worker进程处理循环中，查找该树中已经触发超时的节点，执行对应的处理函数。因此时间控制就显得尤为重要。</p>
<h3 id="缓存时间管理"><a href="#缓存时间管理" class="headerlink" title="缓存时间管理"></a>缓存时间管理</h3><p>缓存时间在进程间是不共用的，也就是说，病危使用mmap内存映射将多个进程读写同一个地址的数据。每个worker要维护自己的时间缓存。</p>
<p>处于性能考虑，一般不会在每次需要使用时间时调用<code>gettimeofday</code>来更新时间，而是将时间缓存到一些全局变量中，在必要的时候再进行更新。</p>
<p>nginx缓存了如下关于时间的全局变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 时间戳，到秒</span></span><br><span class="line">    <span class="keyword">time_t</span>      sec;</span><br><span class="line">    <span class="comment">// mesc是相对sec的毫秒偏移</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  msec;</span><br><span class="line">    <span class="comment">// 时区</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>   gmtoff;</span><br><span class="line">&#125; <span class="keyword">ngx_time_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件戳,毫秒级别</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_msec_t</span>  ngx_current_msec;</span><br><span class="line"><span class="comment">// ngx_time_t结构形式的当前事件</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_time_t</span>  *ngx_cached_time;</span><br><span class="line"><span class="comment">// 用于记录error_log的当前时间字符串，格式类似于"1997/09/28 12:09:87"</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_str_t</span>    ngx_cached_err_log_time;</span><br><span class="line"><span class="comment">// 用于http相关的时间字符串，格式类似于 "Mon, 28 Sep 1970 09:00:00 GMT"</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_str_t</span>    ngx_cached_http_time;</span><br><span class="line"><span class="comment">// 用于记录HTTP日志的当前事件字符串，格式类似于："28/Sep/1979:12:00:00 +0600"</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_str_t</span>    ngx_cached_http_log_time;</span><br><span class="line"><span class="comment">// 以ISO 8601标准格式记录下的字符串形式当前事件</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_str_t</span>    ngx_cached_http_log_iso8601;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keyword">ngx_str_t</span>    ngx_cached_syslog_time;</span><br></pre></td></tr></table></figure>
<p>对于nginx自己定义的定时器事件来说，对于时间是十分敏感的，因此何时更新缓存的时间是是否重要的。</p>
<p>nginx更新缓存事件分为两种情况：</p>
<ol>
<li>配置了timer_resolution：如果配置中存在该配置，则会在每次worker进程的循环中，判断定时器是否已经触发，触发时进行时间更新。其中worker进程增加时钟信号在ngx_event_core_module模块的int_process方法中（详情可查看上文介绍），事件循环中，对应epoll_wait等待事件为-1，即直到等待有事件触发或者时钟信号触发时，就会更新时间。</li>
<li>当没有配置timer_resolution时，则每次worker进程循环的时候，都会执行事件更新。这时epoll_wait等待事件则取决于定时器事件中当前是否存在超时事件，如果存在，则时间为0，即不等待，直接返回，如果没有，则最多等待最近的一个事件所对应的事件。具体查看ngx_process_events_and_timers函数。</li>
</ol>
<h4 id="ngx-time-init初始化时间"><a href="#ngx-time-init初始化时间" class="headerlink" title="ngx_time_init初始化时间"></a>ngx_time_init初始化时间</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_time_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 分配缓存数据空间</span></span><br><span class="line">    ngx_cached_err_log_time.len = <span class="keyword">sizeof</span>(<span class="string">"1970/09/28 12:00:00"</span>) - <span class="number">1</span>;</span><br><span class="line">    ngx_cached_http_time.len = <span class="keyword">sizeof</span>(<span class="string">"Mon, 28 Sep 1970 06:00:00 GMT"</span>) - <span class="number">1</span>;</span><br><span class="line">    ngx_cached_http_log_time.len = <span class="keyword">sizeof</span>(<span class="string">"28/Sep/1970:12:00:00 +0600"</span>) - <span class="number">1</span>;</span><br><span class="line">    ngx_cached_http_log_iso8601.len = <span class="keyword">sizeof</span>(<span class="string">"1970-09-28T12:00:00+06:00"</span>) - <span class="number">1</span>;</span><br><span class="line">    ngx_cached_syslog_time.len = <span class="keyword">sizeof</span>(<span class="string">"Sep 28 12:00:00"</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// cached_time是一个数组，用于多线程的处理，防止在一个线程写数据。另一个线程读取导致的错误</span></span><br><span class="line">    ngx_cached_time = &amp;cached_time[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    ngx_time_update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-time-update更新时间"><a href="#ngx-time-update更新时间" class="headerlink" title="ngx_time_update更新时间"></a>ngx_time_update更新时间</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_time_update(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    u_char          *p0, *p1, *p2, *p3, *p4;</span><br><span class="line">    <span class="keyword">ngx_tm_t</span>         tm, gmt;</span><br><span class="line">    <span class="keyword">time_t</span>           sec;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       msec;</span><br><span class="line">    <span class="keyword">ngx_time_t</span>      *tp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>   <span class="title">tv</span>;</span></span><br><span class="line">    <span class="comment">// 多线程获取锁，不用考虑</span></span><br><span class="line">    <span class="keyword">if</span> (!ngx_trylock(&amp;ngx_time_lock)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define ngx_gettimeofday(tp)  (void) gettimeofday(tp, NULL);</span></span><br><span class="line"><span class="comment">    获取当前时间</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    ngx_gettimeofday(&amp;tv);</span><br><span class="line"></span><br><span class="line">    sec = tv.tv_sec;</span><br><span class="line">    msec = tv.tv_usec / <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">// 计算缓存的时间戳</span></span><br><span class="line">    ngx_current_msec = ngx_monotonic_time(sec, msec);</span><br><span class="line">    <span class="comment">// 获取线程对应的ngx_time_t</span></span><br><span class="line">    tp = &amp;cached_time[slot];</span><br><span class="line">    <span class="comment">// 如果秒纬度未变化，则不执行后续处理</span></span><br><span class="line">    <span class="keyword">if</span> (tp-&gt;sec == sec) &#123;</span><br><span class="line">        tp-&gt;msec = msec;</span><br><span class="line">        ngx_unlock(&amp;ngx_time_lock);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将写的数据后移一个slot</span></span><br><span class="line">    <span class="keyword">if</span> (slot == NGX_TIME_SLOTS - <span class="number">1</span>) &#123;</span><br><span class="line">        slot = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        slot++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tp = &amp;cached_time[slot];</span><br><span class="line"></span><br><span class="line">    tp-&gt;sec = sec;</span><br><span class="line">    tp-&gt;msec = msec;</span><br><span class="line">    <span class="comment">// 逐一处理每个缓存数据</span></span><br><span class="line">    ngx_gmtime(sec, &amp;gmt);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    p0 = &amp;cached_http_time[slot][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_sprintf(p0, <span class="string">"%s, %02d %s %4d %02d:%02d:%02d GMT"</span>,</span><br><span class="line">                       week[gmt.ngx_tm_wday], gmt.ngx_tm_mday,</span><br><span class="line">                       months[gmt.ngx_tm_mon - <span class="number">1</span>], gmt.ngx_tm_year,</span><br><span class="line">                       gmt.ngx_tm_hour, gmt.ngx_tm_min, gmt.ngx_tm_sec);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_GETTIMEZONE)</span></span><br><span class="line"></span><br><span class="line">    tp-&gt;gmtoff = ngx_gettimezone();</span><br><span class="line">    ngx_gmtime(sec + tp-&gt;gmtoff * <span class="number">60</span>, &amp;tm);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> (NGX_HAVE_GMTOFF)</span></span><br><span class="line"></span><br><span class="line">    ngx_localtime(sec, &amp;tm);</span><br><span class="line">    cached_gmtoff = (<span class="keyword">ngx_int_t</span>) (tm.ngx_tm_gmtoff / <span class="number">60</span>);</span><br><span class="line">    tp-&gt;gmtoff = cached_gmtoff;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    ngx_localtime(sec, &amp;tm);</span><br><span class="line">    cached_gmtoff = ngx_timezone(tm.ngx_tm_isdst);</span><br><span class="line">    tp-&gt;gmtoff = cached_gmtoff;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    p1 = &amp;cached_err_log_time[slot][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_sprintf(p1, <span class="string">"%4d/%02d/%02d %02d:%02d:%02d"</span>,</span><br><span class="line">                       tm.ngx_tm_year, tm.ngx_tm_mon,</span><br><span class="line">                       tm.ngx_tm_mday, tm.ngx_tm_hour,</span><br><span class="line">                       tm.ngx_tm_min, tm.ngx_tm_sec);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    p2 = &amp;cached_http_log_time[slot][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_sprintf(p2, <span class="string">"%02d/%s/%d:%02d:%02d:%02d %c%02i%02i"</span>,</span><br><span class="line">                       tm.ngx_tm_mday, months[tm.ngx_tm_mon - <span class="number">1</span>],</span><br><span class="line">                       tm.ngx_tm_year, tm.ngx_tm_hour,</span><br><span class="line">                       tm.ngx_tm_min, tm.ngx_tm_sec,</span><br><span class="line">                       tp-&gt;gmtoff &lt; <span class="number">0</span> ? <span class="string">'-'</span> : <span class="string">'+'</span>,</span><br><span class="line">                       ngx_abs(tp-&gt;gmtoff / <span class="number">60</span>), ngx_abs(tp-&gt;gmtoff % <span class="number">60</span>));</span><br><span class="line"></span><br><span class="line">    p3 = &amp;cached_http_log_iso8601[slot][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_sprintf(p3, <span class="string">"%4d-%02d-%02dT%02d:%02d:%02d%c%02i:%02i"</span>,</span><br><span class="line">                       tm.ngx_tm_year, tm.ngx_tm_mon,</span><br><span class="line">                       tm.ngx_tm_mday, tm.ngx_tm_hour,</span><br><span class="line">                       tm.ngx_tm_min, tm.ngx_tm_sec,</span><br><span class="line">                       tp-&gt;gmtoff &lt; <span class="number">0</span> ? <span class="string">'-'</span> : <span class="string">'+'</span>,</span><br><span class="line">                       ngx_abs(tp-&gt;gmtoff / <span class="number">60</span>), ngx_abs(tp-&gt;gmtoff % <span class="number">60</span>));</span><br><span class="line"></span><br><span class="line">    p4 = &amp;cached_syslog_time[slot][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_sprintf(p4, <span class="string">"%s %2d %02d:%02d:%02d"</span>,</span><br><span class="line">                       months[tm.ngx_tm_mon - <span class="number">1</span>], tm.ngx_tm_mday,</span><br><span class="line">                       tm.ngx_tm_hour, tm.ngx_tm_min, tm.ngx_tm_sec);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define ngx_memory_barrier()        __sync_synchronize()</span></span><br><span class="line"><span class="comment">    防止读操作混乱有关，它告诉编译器不要将其后面的语句进行优化，不要打乱其执行顺序,保证最后对全局的缓存时间赋值</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    ngx_memory_barrier();</span><br><span class="line"></span><br><span class="line">    ngx_cached_time = tp;</span><br><span class="line">    ngx_cached_http_time.data = p0;</span><br><span class="line">    ngx_cached_err_log_time.data = p1;</span><br><span class="line">    ngx_cached_http_log_time.data = p2;</span><br><span class="line">    ngx_cached_http_log_iso8601.data = p3;</span><br><span class="line">    ngx_cached_syslog_time.data = p4;</span><br><span class="line"></span><br><span class="line">    ngx_unlock(&amp;ngx_time_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里比较有趣的就是slot的使用。对于写操作，是使用锁进行更新，保证数据不会被损坏，对于读操作，是并未加锁的，直接从缓存中读取的。如果在读取的时候，有别的线程在写入，将会导致读取出的数据是被损坏的，这里使用一个数组来进行写进行规避。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#define NGX_TIME_SLOTS   64</span><br><span class="line"></span><br><span class="line">static ngx_uint_t        slot;</span><br><span class="line">static ngx_atomic_t      ngx_time_lock;</span><br><span class="line"></span><br><span class="line">volatile ngx_msec_t      ngx_current_msec;</span><br><span class="line">volatile ngx_time_t     *ngx_cached_time;</span><br><span class="line">volatile ngx_str_t       ngx_cached_err_log_time;</span><br><span class="line">volatile ngx_str_t       ngx_cached_http_time;</span><br><span class="line">volatile ngx_str_t       ngx_cached_http_log_time;</span><br><span class="line">volatile ngx_str_t       ngx_cached_http_log_iso8601;</span><br><span class="line">volatile ngx_str_t       ngx_cached_syslog_time;</span><br><span class="line"></span><br><span class="line">static ngx_time_t        cached_time[NGX_TIME_SLOTS];</span><br><span class="line">static u_char            cached_err_log_time[NGX_TIME_SLOTS]</span><br><span class="line">                                    [sizeof(&quot;1970/09/28 12:00:00&quot;)];</span><br><span class="line">static u_char            cached_http_time[NGX_TIME_SLOTS]</span><br><span class="line">                                    [sizeof(&quot;Mon, 28 Sep 1970 06:00:00 GMT&quot;)];</span><br><span class="line">static u_char            cached_http_log_time[NGX_TIME_SLOTS]</span><br><span class="line">                                    [sizeof(&quot;28/Sep/1970:12:00:00 +0600&quot;)];</span><br><span class="line">static u_char            cached_http_log_iso8601[NGX_TIME_SLOTS]</span><br><span class="line">                                    [sizeof(&quot;1970-09-28T12:00:00+06:00&quot;)];</span><br><span class="line">static u_char            cached_syslog_time[NGX_TIME_SLOTS]</span><br><span class="line">                                    [sizeof(&quot;Sep 28 12:00:00&quot;)];</span><br></pre></td></tr></table></figure>
<p>从上面的定义可以看出来，除了<code>ngx_current_msec</code>全局变量，其余每一个变量都有一个与之对应的64纬数组。<code>slot</code>变量记录了当前缓存中的全局变量的值是那个数组中存储的数据，每次更新的时候，都将slot增加1，这样保证更新的是缓存中的后一个数据，在更新完成后，统一将内容写入到全局变量中，以此来保证读操作时，不会有写线程来导致全局变量是被损坏的数据。</p>
<p>比如，在线程A在复制ngx_cached_http_time的data字段时（赋值了一半），这时被信号中断，或者别的线程重写了数据，如果没有slot，则复制过程中，后面地址的内容将会是错误数据，有了slot后，一般情况变更不会将原来地址的数据重写（除非一下有64个线程调用了时间更新），这样在一定程度上保证了读操作的安全性（不能完全避免）。目前未使用多线程，目前可以不用考虑。</p>
<h3 id="定时器方法"><a href="#定时器方法" class="headerlink" title="定时器方法"></a>定时器方法</h3><h4 id="ngx-event-timer-init初始化定时器红黑树"><a href="#ngx-event-timer-init初始化定时器红黑树" class="headerlink" title="ngx_event_timer_init初始化定时器红黑树"></a>ngx_event_timer_init初始化定时器红黑树</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_rbtree_t</span>              ngx_event_timer_rbtree;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_rbtree_node_t</span>  ngx_event_timer_sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_event_timer_init(<span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_rbtree_init(&amp;ngx_event_timer_rbtree, &amp;ngx_event_timer_sentinel,</span><br><span class="line">                    ngx_rbtree_insert_timer_value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>事件时间红黑树中会存在key一致的问题，但并未做任何处理，因为对其中的元素来说，我们并不会要精确获取哪一个，只是在时间触发时，执行对应元素的处理即可。</p>
<p>初始化红黑树详见红黑树的介绍。</p>
<h4 id="ngx-event-add-timer向事件树中增加元素"><a href="#ngx-event-add-timer向事件树中增加元素" class="headerlink" title="ngx_event_add_timer向事件树中增加元素"></a>ngx_event_add_timer向事件树中增加元素</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">void</span></span><br><span class="line">ngx_event_add_timer(<span class="keyword">ngx_event_t</span> *ev, <span class="keyword">ngx_msec_t</span> timer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>      key;</span><br><span class="line">    <span class="keyword">ngx_msec_int_t</span>  diff;</span><br><span class="line">    <span class="comment">// 元素key为当前时间+过期时间</span></span><br><span class="line">    key = ngx_current_msec + timer;</span><br><span class="line">    <span class="comment">// 如果事件已经被增加到时间树中</span></span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;timer_set) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Use a previous timer value if difference between it and a new</span></span><br><span class="line"><span class="comment">         * value is less than NGX_TIMER_LAZY_DELAY milliseconds: this allows</span></span><br><span class="line"><span class="comment">         * to minimize the rbtree operations for fast connections.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 获取本次添加和之前添加的时间差值</span></span><br><span class="line">        diff = (<span class="keyword">ngx_msec_int_t</span>) (key - ev-&gt;timer.key);</span><br><span class="line">        <span class="comment">// 差值（绝对值）小于300ms，则不再重复添加</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_abs(diff) &lt; NGX_TIMER_LAZY_DELAY) &#123;</span><br><span class="line">            ngx_log_debug3(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"event timer: %d, old: %M, new: %M"</span>,</span><br><span class="line">                            ngx_event_ident(ev-&gt;data), ev-&gt;timer.key, key);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        #define ngx_add_timer        ngx_event_add_timer</span></span><br><span class="line"><span class="comment">        #define ngx_del_timer        ngx_event_del_timer</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 将当前事件从红黑树中删除</span></span><br><span class="line">        ngx_del_timer(ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置事件key</span></span><br><span class="line">    ev-&gt;timer.key = key;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug3(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"event timer add: %d: %M:%M"</span>,</span><br><span class="line">                    ngx_event_ident(ev-&gt;data), timer, ev-&gt;timer.key);</span><br><span class="line">    <span class="comment">// 推荐奖进红黑树</span></span><br><span class="line">    ngx_rbtree_insert(&amp;ngx_event_timer_rbtree, &amp;ev-&gt;timer);</span><br><span class="line">    <span class="comment">// 设置已经在事件树中</span></span><br><span class="line">    ev-&gt;timer_set = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-event-del-timer从事件树中删除元素"><a href="#ngx-event-del-timer从事件树中删除元素" class="headerlink" title="ngx_event_del_timer从事件树中删除元素"></a>ngx_event_del_timer从事件树中删除元素</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">void</span></span><br><span class="line">ngx_event_del_timer(<span class="keyword">ngx_event_t</span> *ev)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"event timer del: %d: %M"</span>,</span><br><span class="line">                    ngx_event_ident(ev-&gt;data), ev-&gt;timer.key);</span><br><span class="line">    <span class="comment">// 红黑树中删除元素</span></span><br><span class="line">    ngx_rbtree_delete(&amp;ngx_event_timer_rbtree, &amp;ev-&gt;timer);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">    ev-&gt;timer.left = <span class="literal">NULL</span>;</span><br><span class="line">    ev-&gt;timer.right = <span class="literal">NULL</span>;</span><br><span class="line">    ev-&gt;timer.parent = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 设置为未添加状态</span></span><br><span class="line">    ev-&gt;timer_set = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-event-find-timer查找是否存在超时事件"><a href="#ngx-event-find-timer查找是否存在超时事件" class="headerlink" title="ngx_event_find_timer查找是否存在超时事件"></a>ngx_event_find_timer查找是否存在超时事件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_msec_t</span></span><br><span class="line">ngx_event_find_timer(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_msec_int_t</span>      timer;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  *node, *root, *sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_timer_rbtree.root == &amp;ngx_event_timer_sentinel) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_TIMER_INFINITE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root = ngx_event_timer_rbtree.root;</span><br><span class="line">    sentinel = ngx_event_timer_rbtree.sentinel;</span><br><span class="line">    <span class="comment">// 查找key最小的节点，即最先超时节点</span></span><br><span class="line">    node = ngx_rbtree_min(root, sentinel);</span><br><span class="line">    <span class="comment">// 对比和当前时间差距</span></span><br><span class="line">    timer = (<span class="keyword">ngx_msec_int_t</span>) (node-&gt;key - ngx_current_msec);</span><br><span class="line">    <span class="comment">// 返回是否超时，以及下一个将要超时的时间要等多久</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">ngx_msec_t</span>) (timer &gt; <span class="number">0</span> ? timer : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-event-expire-timers执行所有的超时事件"><a href="#ngx-event-expire-timers执行所有的超时事件" class="headerlink" title="ngx_event_expire_timers执行所有的超时事件"></a>ngx_event_expire_timers执行所有的超时事件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_event_expire_timers(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>        *ev;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  *node, *root, *sentinel;</span><br><span class="line"></span><br><span class="line">    sentinel = ngx_event_timer_rbtree.sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        root = ngx_event_timer_rbtree.root;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root == sentinel) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取最先超时的事件</span></span><br><span class="line">        node = ngx_rbtree_min(root, sentinel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* node-&gt;key &gt; ngx_current_msec */</span></span><br><span class="line">        <span class="comment">// 如果最新超时的事件未超时，则返回</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">ngx_msec_int_t</span>) (node-&gt;key - ngx_current_msec) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取对应的事件</span></span><br><span class="line">        ev = (<span class="keyword">ngx_event_t</span> *) ((<span class="keyword">char</span> *) node - offsetof(<span class="keyword">ngx_event_t</span>, timer));</span><br><span class="line"></span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_EVENT, ev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"event timer del: %d: %M"</span>,</span><br><span class="line">                       ngx_event_ident(ev-&gt;data), ev-&gt;timer.key);</span><br><span class="line">        <span class="comment">// 从事件树中删除</span></span><br><span class="line">        ngx_rbtree_delete(&amp;ngx_event_timer_rbtree, &amp;ev-&gt;timer);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">        ev-&gt;timer.left = <span class="literal">NULL</span>;</span><br><span class="line">        ev-&gt;timer.right = <span class="literal">NULL</span>;</span><br><span class="line">        ev-&gt;timer.parent = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 设置未在事件树中</span></span><br><span class="line">        ev-&gt;timer_set = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 设置事件为已超时</span></span><br><span class="line">        ev-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 执行事件的处理函数</span></span><br><span class="line">        ev-&gt;handler(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此事件一旦超时，将会执行处理函数，并从事件红黑树中删除。在nginx中，对于某些事件会同时添加到事件红黑树和epoll事件驱动模块中，例如，在建立连接后，接收请求有一个超时时间。因此向事件红黑树和epoll中均添加上对应等待请求的事件。如果在指定时间内还未收到请求，则事件红黑树中将执行超时处理，设置事件为超时事件，并执行相应的处理（关闭连接，从epoll中剔除事件）。如果在超时之前接收到了请求，则会先执行对应的处理，如果在指定时间内未完成获取请求头和解析，导致定时器红黑树中事件触发，依然会将事件移出，并关闭连接，如果在指定事件完成上述操作，则会将事件从定时器红黑树中移出。</p>
<h4 id="ngx-event-no-timers-left检查是否所有事件均可忽略"><a href="#ngx-event-no-timers-left检查是否所有事件均可忽略" class="headerlink" title="ngx_event_no_timers_left检查是否所有事件均可忽略"></a>ngx_event_no_timers_left检查是否所有事件均可忽略</h4><p>在worker进程退出时，会判断是否所有事件均可以忽略，如果是，则直接退出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_event_no_timers_left(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>        *ev;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>  *node, *root, *sentinel;</span><br><span class="line"></span><br><span class="line">    sentinel = ngx_event_timer_rbtree.sentinel;</span><br><span class="line">    root = ngx_event_timer_rbtree.root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root == sentinel) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从最先超时的节点遍历整棵树，查找是否存在不可忽略的事件</span></span><br><span class="line">    <span class="keyword">for</span> (node = ngx_rbtree_min(root, sentinel);</span><br><span class="line">         node;</span><br><span class="line">         node = ngx_rbtree_next(&amp;ngx_event_timer_rbtree, node))</span><br><span class="line">    &#123;</span><br><span class="line">        ev = (<span class="keyword">ngx_event_t</span> *) ((<span class="keyword">char</span> *) node - offsetof(<span class="keyword">ngx_event_t</span>, timer));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ev-&gt;cancelable) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* only cancelable timers left */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="一些重要的模块"><a href="#一些重要的模块" class="headerlink" title="一些重要的模块"></a>一些重要的模块</h1><h2 id="pcre正则"><a href="#pcre正则" class="headerlink" title="pcre正则"></a>pcre正则</h2><p>在nginx中使用pcre正则来解析配置并进行处理。PCRE是 <strong>‘Perl Compatible Regular Expressions’</strong>(Perl兼容的正则表达式）的缩写。PCRE库由一系列函数组成，实现了与Perl5相同的语法、语义的正则表达式匹配功能。</p>
<p>正则需要进行模式匹配，其中包含命名模式匹配和匿名模式匹配，以如下为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(?&lt;date&gt; (?&lt;year&gt;(\d\d)?\d\d) - (?&lt;month&gt;\d\d) - (?&lt;day&gt;\d\d) )</span><br></pre></td></tr></table></figure>
<p>这里存在5个匹配（包括匿名匹配和命名匹配）。其中<code>date</code>匹配<code>(?&lt;year&gt;(\d\d)?\d\d) - (?&lt;month&gt;\d\d) - (?&lt;day&gt;\d\d)</code>部分，<code>year</code>匹配<code>(\d\d)?\d\d</code>，<code>month</code>匹配<code>\d\d</code>，<code>day</code>匹配<code>\d\d</code>。还包含一个匿名匹配，即<code>year</code>后面的<code>(/d/d)</code>。</p>
<p><code>PCRE</code>允许使用命名捕获分组，也允许使用匿名捕获分组（即分组用数字来表示），其实命名捕获分组只是用来标识分组的另一种方式，命名捕获分组也会获得一个数字分组名称。<code>PCRE</code>提供了一些方法可以通过命名捕获分组的名称来快速获取捕获分组内容的函数，比如：<code>pcre_get_named_substring()</code> .<br>也可以通过以下步骤来获取捕获分组的信息：</p>
<ul>
<li><p>将命名捕获分组的名称转换为数字。</p>
</li>
<li><p>通过上一步的数字来获取分组的信息。<br>这里就牵涉到了一个 <code>name to number</code> 的转换过程，PCRE维护了一个 <code>name-to-number</code> 的<code>map</code>，我们可以根据这个<code>map</code>完成转换功能，这个<code>map</code>有以下三个属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PCRE_INFO_NAMECOUNT</span><br><span class="line">PCRE_INFO_NAMEENTRYSIZE</span><br><span class="line">PCRE_INFO_NAMETABLE</span><br></pre></td></tr></table></figure>
<p>这个<code>map</code>包含了若干个固定大小的记录，可以通过<code>PCRE_INFO_NAMECOUNT</code>参数来获取这个<code>map</code>的记录数量(其实就是命名捕获分组的数量)，通过<code>PCRE_INFO_NAMEENTRYSIZE</code>来获取每个记录的大小，这两种情况下，最后一个参数都是一个<code>int</code>类型的指针。其中每个每个记录的大小是由最长的捕获分组的名称来确立的。其中每个每个记录的大小是由最长的捕获分组的名称来确立的。这里的记录是说命名的大小。</p>
<p><code>PCRE_INFO_NAMETABLE</code> 返回一个指向这个<code>map</code>的第一条记录的指针（一个<code>char</code>类型的指针），每条记录的前两个字节是命名捕获分组所对应的数字分组值，剩下的内容是命名捕获分组的<code>name</code>，以<code>&#39;\0&#39;</code>结束。返回的<code>map</code>的顺序是命名捕获分组的字母顺序。</p>
<p>对于上述<code>date</code>的例子来说，map中存储数据内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00 01 d a t e 00 ??</span><br><span class="line">00 05 d a y 00 ?? ??</span><br><span class="line">00 04 m o n t h 00</span><br><span class="line">00 02 y e a r 00 ??</span><br></pre></td></tr></table></figure>
<p>其中<code>PCRE_INFO_NAMEENTRYSIZE</code>为8，因为最长的name是<code>moth</code>,加上前面两位表示对应的实际数字分组值，已经最后的<code>\0</code>，总共八位。对应长度小于8位的命名分组来说，超长的部分是未设置值的。在遍历map时，需要使用<code>PCRE_INFO_NAMEENTRYSIZE</code>作为偏移。</p>
</li>
</ul>
<p>这里主要介绍一下nginx中使用的pcre方法。</p>
<h3 id="pcre-compile"><a href="#pcre-compile" class="headerlink" title="pcre_compile()"></a>pcre_compile()</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pcre *<span class="title">pcre_compile</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pattern, <span class="keyword">int</span> options, <span class="keyword">const</span> <span class="keyword">char</span> **errptr, <span class="keyword">int</span> *erroffset, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *tableptr)</span></span></span><br></pre></td></tr></table></figure>
<p>功能： 将一个正则表达式编译成一个内部的<code>pcre</code>结构，在匹配多个字符串时，可以加速匹配。其中<code>pcre_compile2()</code>功能一样，只是缺少一个参数<code>errorcodeptr</code>。</p>
<p><code>pattern</code>为字符串，表示待编译的正则表达式。</p>
<p><code>options</code>为0或者其他可选的标志。</p>
<p><code>errptr</code>为返回的出错信息。</p>
<p><code>erroffset</code>为出错位置。</p>
<p><code>tableptr</code>指向一个字符数组的指针，可以设置为NULL。</p>
<h3 id="pcre-study-函数"><a href="#pcre-study-函数" class="headerlink" title="pcre_study()函数"></a>pcre_study()函数</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pcre_extra *<span class="title">pcre_study</span><span class="params">(<span class="keyword">const</span> pcre *code, <span class="keyword">int</span> options, <span class="keyword">const</span> <span class="keyword">char</span> **errptr)</span></span></span><br></pre></td></tr></table></figure>
<p>功能： 对编译的模式进行学习，提取可以加速匹配过程的信息。</p>
<p><code>code</code>为已编译的模式，即<code>pcre_compile</code>函数的输出。</p>
<p><code>options</code>为选项。目前只有一个options，即<code>PCRE_STUDY_JIT_COMPILE</code>表示如果可能，它会要求及时编译。</p>
<p><code>errpetr</code>为出错信息。</p>
<h3 id="pcre-exec-函数"><a href="#pcre-exec-函数" class="headerlink" title="pcre_exec()函数"></a>pcre_exec()函数</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pcre_exec</span><span class="params">(<span class="keyword">const</span> pcre *code, <span class="keyword">const</span> pcre_extra *extra, <span class="keyword">const</span> <span class="keyword">char</span> *subject, <span class="keyword">int</span> length, <span class="keyword">int</span> startoffset, <span class="keyword">int</span> options, <span class="keyword">int</span> *ovector, <span class="keyword">int</span> ovecsize)</span></span></span><br></pre></td></tr></table></figure>
<p>功能： 使用编译好的模式进行匹配，采用与<code>Perl</code>相似的算法。返回值大于0，表示匹配到的pattern个数； 否则表示出错信息。<code>NGX_REGEX_NO_MATCHED</code>表示不匹配（-1），其他负数表示错误。</p>
<p><code>code</code>为编译好的模式。</p>
<p><code>extra</code>为pcre_extra结构体，可以为null。</p>
<p><code>subject</code>为需要匹配的字符串。</p>
<p><code>length</code>为匹配字符串长度。</p>
<p><code>startoffset</code>为匹配的开始位置。</p>
<p><code>options</code>为选项位。</p>
<p><code>ovector</code>指向一个结果的整形数组。这里返回的是每个捕获相对于subject中的偏移，对于第$i$个捕获来说，其起始下标为$ovector[2<em>i]$，末尾下标为$ovector[2</em>i+1]$。其中$i$从0开始。</p>
<p><code>ovecsize</code>数组大小。</p>
<h3 id="pcre-fullinfo函数"><a href="#pcre-fullinfo函数" class="headerlink" title="pcre_fullinfo函数"></a>pcre_fullinfo函数</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pcre_fullinfo</span><span class="params">(<span class="keyword">const</span> pcre *code, <span class="keyword">const</span> pcre_extra *extra,<span class="keyword">int</span> what, <span class="keyword">void</span> *where)</span></span>;</span><br></pre></td></tr></table></figure>
<p>功能：返回一个被编译完成的pattern的相关信息。</p>
<p><code>code</code>为编译完成的pattern。</p>
<p><code>extra</code>为优化后的额外信息，可以为空。</p>
<p><code>what</code>为需要获取的信息类型。</p>
<p><code>where</code>返回对应的存放地址。</p>
<p>nginx中主要获取到如下信息：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>what</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PCRE_INFO_CAPTURECOUNT</code></td>
<td>捕获子模式的数量</td>
</tr>
<tr>
<td><code>PCRE_INFO_NAMECOUNT</code></td>
<td>命名子模式的数量</td>
</tr>
<tr>
<td><code>PCRE_INFO_NAMEENTRYSIZE</code></td>
<td>名称表条目的大小</td>
</tr>
<tr>
<td><code>PCRE_INFO_NAMETABLE</code></td>
<td>指向名称表的指针</td>
</tr>
<tr>
<td><code>PCRE_INFO_JIT</code></td>
<td>是否支持JIT</td>
</tr>
</tbody>
</table>
</div>
<h3 id="pcre-config函数"><a href="#pcre-config函数" class="headerlink" title="pcre_config函数"></a>pcre_config函数</h3><p>函数原型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int pcre_config(int what, void *where)</span><br></pre></td></tr></table></figure>
<p>功能： 查询当前PCRE版本中使用的选项信息。</p>
<ul>
<li>what: 选项名</li>
<li>where: 存储结果的位置</li>
</ul>
<h2 id="nginx中使用pcre"><a href="#nginx中使用pcre" class="headerlink" title="nginx中使用pcre"></a>nginx中使用pcre</h2><p><code>nginx</code>中使用正则主要通过<code>ngx_regex_module</code>模块处理，这里不详细介绍该模块的所有部分，只关注对正则的处理。</p>
<h3 id="相关结构-6"><a href="#相关结构-6" class="headerlink" title="相关结构"></a>相关结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    pcre        *code; <span class="comment">// 被编译后的正则字段</span></span><br><span class="line">    pcre_extra  *extra; <span class="comment">// 编译后执行study后的输出</span></span><br><span class="line">&#125; <span class="keyword">ngx_regex_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>     pattern; <span class="comment">// 被编译的字符串</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>   *pool;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>     options; <span class="comment">// 编译选项</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_regex_t</span>  *regex; <span class="comment">// 编译结果</span></span><br><span class="line">    <span class="keyword">int</span>           captures; <span class="comment">// 正则中需要捕获的数量，包括匿名和非匿名</span></span><br><span class="line">    <span class="keyword">int</span>           named_captures; <span class="comment">// 正则中命名捕获数量</span></span><br><span class="line">    <span class="keyword">int</span>           name_size; <span class="comment">// 命名捕获大小</span></span><br><span class="line">    u_char       *names; <span class="comment">// 命名捕获表</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>     err;</span><br><span class="line">&#125; <span class="keyword">ngx_regex_compile_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_regex_t</span>  *regex;</span><br><span class="line">    u_char       *name; <span class="comment">// 存储原始正则语句</span></span><br><span class="line">&#125; <span class="keyword">ngx_regex_elt_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-regex-compile编译正则"><a href="#ngx-regex-compile编译正则" class="headerlink" title="ngx_regex_compile编译正则"></a>ngx_regex_compile编译正则</h3><p><code>ngx_regex_compile</code>函数用来对正则进行编译并初始化对应的<code>ngx_regex_compile_t</code>结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_regex_compile(<span class="keyword">ngx_regex_compile_t</span> *rc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>               n, erroff;</span><br><span class="line">    <span class="keyword">char</span>             *p;</span><br><span class="line">    pcre             *re;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>       *errstr;</span><br><span class="line">    <span class="keyword">ngx_regex_elt_t</span>  *elt;</span><br><span class="line"></span><br><span class="line">    ngx_regex_malloc_init(rc-&gt;pool);</span><br><span class="line">    <span class="comment">// 编译正则</span></span><br><span class="line">    re = pcre_compile((<span class="keyword">const</span> <span class="keyword">char</span> *) rc-&gt;pattern.data, (<span class="keyword">int</span>) rc-&gt;options,</span><br><span class="line">                      &amp;errstr, &amp;erroff, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ensure that there is no current pool */</span></span><br><span class="line">    ngx_regex_malloc_done();</span><br><span class="line">    <span class="comment">// 如果返回为null，则是错误，输出日志</span></span><br><span class="line">    <span class="keyword">if</span> (re == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>) erroff == rc-&gt;pattern.len) &#123;</span><br><span class="line">           rc-&gt;err.len = ngx_snprintf(rc-&gt;err.data, rc-&gt;err.len,</span><br><span class="line">                              <span class="string">"pcre_compile() failed: %s in \"%V\""</span>,</span><br><span class="line">                               errstr, &amp;rc-&gt;pattern)</span><br><span class="line">                      - rc-&gt;err.data;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           rc-&gt;err.len = ngx_snprintf(rc-&gt;err.data, rc-&gt;err.len,</span><br><span class="line">                              <span class="string">"pcre_compile() failed: %s in \"%V\" at \"%s\""</span>,</span><br><span class="line">                               errstr, &amp;rc-&gt;pattern, rc-&gt;pattern.data + erroff)</span><br><span class="line">                      - rc-&gt;err.data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配对应的regex结构</span></span><br><span class="line">    rc-&gt;regex = ngx_pcalloc(rc-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_regex_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (rc-&gt;regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> nomem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc-&gt;regex-&gt;code = re;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* do not study at runtime */</span></span><br><span class="line">    <span class="comment">// 如果要使用study，则将该正则添加进入ngx_pcre_studies中，在解析完成配置后，执行ngx_regex_module模块的init module方法时执行study来进行优化</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_pcre_studies != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        elt = ngx_list_push(ngx_pcre_studies);</span><br><span class="line">        <span class="keyword">if</span> (elt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> nomem;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        elt-&gt;regex = rc-&gt;regex;</span><br><span class="line">        elt-&gt;name = rc-&gt;pattern.data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取匹配数量</span></span><br><span class="line">    n = pcre_fullinfo(re, <span class="literal">NULL</span>, PCRE_INFO_CAPTURECOUNT, &amp;rc-&gt;captures);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        p = <span class="string">"pcre_fullinfo(\"%V\", PCRE_INFO_CAPTURECOUNT) failed: %d"</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果匹配数量为0，不需要执行后续操作</span></span><br><span class="line">    <span class="keyword">if</span> (rc-&gt;captures == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取命名匹配数量</span></span><br><span class="line">    n = pcre_fullinfo(re, <span class="literal">NULL</span>, PCRE_INFO_NAMECOUNT, &amp;rc-&gt;named_captures);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        p = <span class="string">"pcre_fullinfo(\"%V\", PCRE_INFO_NAMECOUNT) failed: %d"</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果命名匹配为0，不需要执行后续操作</span></span><br><span class="line">    <span class="keyword">if</span> (rc-&gt;named_captures == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取命名匹配大小</span></span><br><span class="line">    n = pcre_fullinfo(re, <span class="literal">NULL</span>, PCRE_INFO_NAMEENTRYSIZE, &amp;rc-&gt;name_size);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        p = <span class="string">"pcre_fullinfo(\"%V\", PCRE_INFO_NAMEENTRYSIZE) failed: %d"</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取命名匹配表</span></span><br><span class="line">    n = pcre_fullinfo(re, <span class="literal">NULL</span>, PCRE_INFO_NAMETABLE, &amp;rc-&gt;names);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        p = <span class="string">"pcre_fullinfo(\"%V\", PCRE_INFO_NAMETABLE) failed: %d"</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    rc-&gt;err.len = ngx_snprintf(rc-&gt;err.data, rc-&gt;err.len, p, &amp;rc-&gt;pattern, n)</span><br><span class="line">                  - rc-&gt;err.data;</span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">nomem:</span><br><span class="line"></span><br><span class="line">    rc-&gt;err.len = ngx_snprintf(rc-&gt;err.data, rc-&gt;err.len,</span><br><span class="line">                               <span class="string">"regex \"%V\" compilation failed: no memory"</span>,</span><br><span class="line">                               &amp;rc-&gt;pattern)</span><br><span class="line">                  - rc-&gt;err.data;</span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-regex-exec执行匹配"><a href="#ngx-regex-exec执行匹配" class="headerlink" title="ngx_regex_exec执行匹配"></a>ngx_regex_exec执行匹配</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_regex_exec(re, s, captures, size)                                \</span><br><span class="line">    pcre_exec(re-&gt;code, re-&gt;extra, (const char *) (s)-&gt;data, (s)-&gt;len, 0, 0, \</span><br><span class="line">              captures, size)</span><br></pre></td></tr></table></figure>
<p>由于nginx中不需要额外指定其余参数，因此设置了一个宏定义来减少参数，执行匹配。</p>
<h3 id="ngx-regex-exec-array匹配正则数组"><a href="#ngx-regex-exec-array匹配正则数组" class="headerlink" title="ngx_regex_exec_array匹配正则数组"></a>ngx_regex_exec_array匹配正则数组</h3><p><code>ngx_regex_exec_array</code>函数查找一个字符串是否匹配一个正则数组中的任意一个：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a为ngx_regex_elt_t的数组</span></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_regex_exec_array(<span class="keyword">ngx_array_t</span> *a, <span class="keyword">ngx_str_t</span> *s, <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_regex_elt_t</span>  *re;</span><br><span class="line"></span><br><span class="line">    re = a-&gt;elts;</span><br><span class="line">    <span class="comment">// 遍历每一个被编译后的正则</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; a-&gt;nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 执行匹配</span></span><br><span class="line">        n = ngx_regex_exec(re[i].regex, s, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 不匹配</span></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_REGEX_NO_MATCHED) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 出错</span></span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          ngx_regex_exec_n <span class="string">" failed: %i on \"%V\" using \"%s\""</span>,</span><br><span class="line">                          n, s, re[i].name);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* match */</span></span><br><span class="line">        <span class="comment">// 匹配返回</span></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不匹配</span></span><br><span class="line">    <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="rewrite模块"><a href="#rewrite模块" class="headerlink" title="rewrite模块"></a>rewrite模块</h2><h3 id="配置解析-1"><a href="#配置解析-1" class="headerlink" title="配置解析"></a>配置解析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_http_rewrite_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"rewrite"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                       |NGX_CONF_TAKE23,</span><br><span class="line">      ngx_http_rewrite,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"return"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                       |NGX_CONF_TAKE12,</span><br><span class="line">      ngx_http_rewrite_return,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"break"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                       |NGX_CONF_NOARGS,</span><br><span class="line">      ngx_http_rewrite_break,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"if"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_BLOCK|NGX_CONF_1MORE,</span><br><span class="line">      ngx_http_rewrite_if,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"set"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                       |NGX_CONF_TAKE2,</span><br><span class="line">      ngx_http_rewrite_set,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"rewrite_log"</span>),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF</span><br><span class="line">                        |NGX_HTTP_LIF_CONF|NGX_CONF_FLAG,</span><br><span class="line">      ngx_conf_set_flag_slot,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_rewrite_loc_conf_t</span>, <span class="built_in">log</span>),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"uninitialized_variable_warn"</span>),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF</span><br><span class="line">                        |NGX_HTTP_LIF_CONF|NGX_CONF_FLAG,</span><br><span class="line">      ngx_conf_set_flag_slot,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_rewrite_loc_conf_t</span>, uninitialized_variable_warn),</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="相关结构-7"><a href="#相关结构-7" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-http-rewrite-loc-conf-t"><a href="#ngx-http-rewrite-loc-conf-t" class="headerlink" title="ngx_http_rewrite_loc_conf_t"></a>ngx_http_rewrite_loc_conf_t</h4><p>该结构为rewrite模块生成的loc下的配置数据，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// codes为执行方法的列表</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>  *codes;        <span class="comment">/* uintptr_t */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>    stack_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_flag_t</span>    <span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_flag_t</span>    uninitialized_variable_warn;</span><br><span class="line">&#125; <span class="keyword">ngx_http_rewrite_loc_conf_t</span>;</span><br></pre></td></tr></table></figure>
<p>codes数组设置比较独特。脚本指令都是实现了”接口ngx_http_script_code_pt”的各个不同的充当类的结构体，这些结构体可以是ngx_http_script_var_code_t、ngx_http_script_value_code_t等，其类型不同，占用的内存也不同，如何放入一个数组中呢（不是它们的指针）。通过如下三点做到：</p>
<ol>
<li><p>codes数组设计每个元素仅占用1字节大小，即不奢望一个数组元素能够存放表示一个脚本指令的结构体。</p>
</li>
<li><p>每次要将1个指令放入codes数组中时，将根据指令结构体的占用内存字节数N，在codes数组中分配N个元素存储这1个指令，再依次把指令结构体的内容都拷贝到这N个数组成员中。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void *</span><br><span class="line">ngx_http_script_start_code(ngx_pool_t *pool, ngx_array_t **codes, size_t size)</span><br><span class="line">&#123;</span><br><span class="line">    if (*codes == NULL) &#123;</span><br><span class="line">        *codes = ngx_array_create(pool, 256, 1);</span><br><span class="line">        if (*codes == NULL) &#123;</span><br><span class="line">            return NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ngx_array_push_n(*codes, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HTTP请求到来，脚本指令执行时，每执行完一个脚本指令的ngx_http_script_code_pt方法后，该方法必须主动告知所属指令结构体占用的内存数N，这样从当前指令所在codes数组索引加上N后就是下一条指令。</p>
</li>
</ol>
<h4 id="ngx-regex-compile-t"><a href="#ngx-regex-compile-t" class="headerlink" title="ngx_regex_compile_t"></a>ngx_regex_compile_t</h4><p><code>ngx_regex_compile_t</code>结构用于正则表达式的编译，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 待编译的正则表达式</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>     pattern;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>   *pool;</span><br><span class="line">    <span class="comment">// 编译选项，即pcre_compile中的选项</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>     options;</span><br><span class="line">    <span class="comment">// 编译完成的结果</span></span><br><span class="line">    <span class="keyword">ngx_regex_t</span>  *regex;</span><br><span class="line">    <span class="comment">// 编译的pattern中模式匹配（命名+匿名）数量</span></span><br><span class="line">    <span class="keyword">int</span>           captures;</span><br><span class="line">    <span class="comment">// 编译的pattern中命名模式匹配数量</span></span><br><span class="line">    <span class="keyword">int</span>           named_captures;</span><br><span class="line">    <span class="comment">// 编译的pattern中命名模式匹配大小</span></span><br><span class="line">    <span class="keyword">int</span>           name_size;</span><br><span class="line">    <span class="comment">// 编译的pattern中命名模式匹配table表</span></span><br><span class="line">    u_char       *names;</span><br><span class="line">    <span class="comment">// 错误信息</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>     err;</span><br><span class="line">&#125; <span class="keyword">ngx_regex_compile_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-regex-t"><a href="#ngx-http-regex-t" class="headerlink" title="ngx_http_regex_t"></a>ngx_http_regex_t</h4><p><code>ngx_http_regex_t</code>结构存储http模块使用正则的相关内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_regex_t</span>                  *regex; <span class="comment">// 正则编译后结构</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    ncaptures; <span class="comment">// 匹配数量</span></span><br><span class="line">    <span class="keyword">ngx_http_regex_variable_t</span>    *variables; <span class="comment">// 命名匹配变量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    nvariables; <span class="comment">// 命名匹配变量数量</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                     name; <span class="comment">// 正则字符串</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_regex_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-regex-variable-t"><a href="#ngx-http-regex-variable-t" class="headerlink" title="ngx_http_regex_variable_t"></a>ngx_http_regex_variable_t</h4><p>对于正则表达式中使用的命名匹配来说，nginx会将其增加到变量数组中，<code>ngx_http_regex_variable_t</code>结构存储了相关结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    capture; <span class="comment">// 存储其值在编译后返回的偏移数组中的位置，后续详细介绍</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                     index; <span class="comment">// 在变量中的index</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_regex_variable_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-script-engine-t"><a href="#ngx-http-script-engine-t" class="headerlink" title="ngx_http_script_engine_t"></a>ngx_http_script_engine_t</h4><p>同一段脚本被编译进nginx中，在不同请求中执行效果是不一样的，所以每个请求都必须有其独特的脚本执行上下文，或者称为脚本引擎。这由ngx_http_script_engine_t类充当：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 执行待执行的脚本指令</span><br><span class="line">    u_char                     *ip;</span><br><span class="line">    // 存储编译完成的值的空间</span><br><span class="line">    u_char                     *pos;</span><br><span class="line">    // 变量构成的栈</span><br><span class="line">    ngx_http_variable_value_t  *sp;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                   buf;</span><br><span class="line">    // 需要编译的字符串</span><br><span class="line">    ngx_str_t                   line;</span><br><span class="line"></span><br><span class="line">    /* the start of the rewritten arguments */</span><br><span class="line">    u_char                     *args;</span><br><span class="line"></span><br><span class="line">    unsigned                    flushed:1;</span><br><span class="line">    unsigned                    skip:1;</span><br><span class="line">    unsigned                    quote:1;</span><br><span class="line">    unsigned                    is_args:1;</span><br><span class="line">    unsigned                    log:1;</span><br><span class="line">    // 脚本执行状态</span><br><span class="line">    ngx_int_t                   status;</span><br><span class="line">    // 执行当前脚本引擎所属的HTTP请求</span><br><span class="line">    ngx_http_request_t         *request;</span><br><span class="line">&#125; ngx_http_script_engine_t;</span><br></pre></td></tr></table></figure>
<p>sp是一个栈，作为编译工具。大小默认为10.</p>
<p>ip可以理解为IP寄存器，指向下一行将要执行的代码。对于u_char*类型来说，其指向类型是不定的。其指向的一定是待执行的脚本指令。用面向对象的语言来说，其指向的是实现了ngx_http_script_code_pt接口的类。但C语言没有接口的概念，在C语言实现上述目的，通常会使用嵌套结构体的方法，比如表示接口的结构体A，要放在表示实现接口的类-结构体B的第一个位置。这样一个指向B的指针，也可以强制转换为A，再调用A的成员。ngx_http_script_code_pt是一个指针函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*ngx_http_script_code_pt) (ngx_http_script_engine_t *e);</span><br></pre></td></tr></table></figure>
<p>ngx_http_script_code_pt参数ngx_http_script_engine_t，其表示当前指令的脚本上下文。</p>
<h4 id="ngx-http-script-compile-t"><a href="#ngx-http-script-compile-t" class="headerlink" title="ngx_http_script_compile_t"></a>ngx_http_script_compile_t</h4><p><code>ngx_http_script_compile_t</code>结构用于执行脚本的解析编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_conf_t                 *cf; // 配置</span><br><span class="line">    ngx_str_t                  *source; // 需要compile的字符串</span><br><span class="line"></span><br><span class="line">    ngx_array_t               **flushes; // 该结构也用于正则匹配，该成员，构建为变量为$1,$2...这种时，存储每个变量对应于哪一个，构成一个数组</span><br><span class="line">    ngx_array_t               **lengths; //处理变量长度的处理子数组，需要执行ngx_http_script_code_pt构成的列表,这里是生成值时执行ngx_http_script_code_pt的列表</span><br><span class="line">    ngx_array_t               **values; // 处理变量内容的处理子数组，对应于rewrite模块的locations层级下的codes执行数组</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                  variables; // 值中含有变量的数量</span><br><span class="line">    ngx_uint_t                  ncaptures; // 当前处理时，出现的$n变量的最大值，如配置的最大为$3，那么ncaptures就等于3</span><br><span class="line">    </span><br><span class="line">    /*</span><br><span class="line">     * 以位移的形式保存$1,$2...$9等变量，即响应位置上置1来表示，主要的作用是为dup_capture准备，</span><br><span class="line">     * 正是由于这个mask的存在，才比较容易得到是否有重复的$n出现。</span><br><span class="line">     */</span><br><span class="line">    ngx_uint_t                  captures_mask;</span><br><span class="line">    ngx_uint_t                  size;</span><br><span class="line"></span><br><span class="line">    /* </span><br><span class="line">     * ngx_http_script_regex_code_t的结构</span><br><span class="line">     */</span><br><span class="line">    void                       *main;</span><br><span class="line"></span><br><span class="line">    unsigned                    compile_args:1; // 是否需要处理请求参数</span><br><span class="line">    unsigned                    complete_lengths:1; // 是否设置lengths数组的终止符，即NULL</span><br><span class="line">    unsigned                    complete_values:1; // 是否设置values数组的终止符</span><br><span class="line">    unsigned                    zero:1; // values数组运行时，得到的字符串是否追加&apos;\0&apos;结尾</span><br><span class="line">    unsigned                    conf_prefix:1; // 是否在生成的文件名前，追加路径前缀</span><br><span class="line">    unsigned                    root_prefix:1; // 同conf_prefix</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * 这个标记位主要在rewrite模块里使用，在ngx_http_rewrite中，</span><br><span class="line">     * if (sc.variables == 0 &amp;&amp; !sc.dup_capture) &#123;</span><br><span class="line">     *     regex-&gt;lengths = NULL;</span><br><span class="line">     * &#125;</span><br><span class="line">     * 没有重复的$n，那么regex-&gt;lengths被置为NULL，这个设置很关键，在函数</span><br><span class="line">     * ngx_http_script_regex_start_code中就是通过对regex-&gt;lengths的判断，来做不同的处理，</span><br><span class="line">     * 因为在没有重复的$n的时候，可以通过正则自身的captures机制来获取$n，一旦出现重复的，</span><br><span class="line">     * 那么pcre正则自身的captures并不能满足我们的要求，我们需要用自己handler来处理。</span><br><span class="line">     */</span><br><span class="line">    unsigned                    dup_capture:1;</span><br><span class="line">    unsigned                    args:1; // 待compile的字符串中是否发现了&apos;?&apos;</span><br><span class="line">&#125; ngx_http_script_compile_t;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-script-regex-code-t"><a href="#ngx-http-script-regex-code-t" class="headerlink" title="ngx_http_script_regex_code_t"></a>ngx_http_script_regex_code_t</h4><p><code>ngx_http_script_regex_code_t</code>用于存储rewrite中第一个正则表达式的相关信息及对应的处理方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    ngx_http_regex_t           *regex;</span><br><span class="line">    ngx_array_t                *lengths;</span><br><span class="line">    uintptr_t                   size;</span><br><span class="line">    uintptr_t                   status; // 执行rewrite后，返回时，返回的http状态码</span><br><span class="line">    uintptr_t                   next;</span><br><span class="line"></span><br><span class="line">    unsigned                    test:1;</span><br><span class="line">    unsigned                    negative_test:1;</span><br><span class="line">    unsigned                    uri:1;</span><br><span class="line">    // args表示是否在rewrite中用户自定义了相关参数</span><br><span class="line">    unsigned                    args:1;</span><br><span class="line"></span><br><span class="line">    /* add the r-&gt;args to the new arguments */</span><br><span class="line">    unsigned                    add_args:1;</span><br><span class="line">    // 是否为重定向</span><br><span class="line">    unsigned                    redirect:1;</span><br><span class="line">    // 是否执行完当前的函数，跳出循环，对应flag为break</span><br><span class="line">    unsigned                    break_cycle:1;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                   name;</span><br><span class="line">&#125; ngx_http_script_regex_code_t;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-script-regex-end-code-t"><a href="#ngx-http-script-regex-end-code-t" class="headerlink" title="ngx_http_script_regex_end_code_t"></a>ngx_http_script_regex_end_code_t</h4><p><code>ngx_http_script_regex_end_code_t</code>用于存储生成rewrite中第二个新的uri时需要的参数及方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                    uri:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    args:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add the r-&gt;args to the new arguments */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    add_args:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                    redirect:<span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_regex_end_code_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="create-location方法"><a href="#create-location方法" class="headerlink" title="create location方法"></a>create location方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">ngx_http_rewrite_create_loc_conf(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span>  *conf;</span><br><span class="line">    <span class="comment">// 生成配置结构</span></span><br><span class="line">    conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_rewrite_loc_conf_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化值为未定义</span></span><br><span class="line">    conf-&gt;stack_size = NGX_CONF_UNSET_UINT;</span><br><span class="line">    conf-&gt;<span class="built_in">log</span> = NGX_CONF_UNSET;</span><br><span class="line">    conf-&gt;uninitialized_variable_warn = NGX_CONF_UNSET;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="commands方法"><a href="#commands方法" class="headerlink" title="commands方法"></a>commands方法</h3><h4 id="rewrite配置"><a href="#rewrite配置" class="headerlink" title="rewrite配置"></a>rewrite配置</h4><p>语法：<code>rewrite regex replacement [flag];</code><br>        作用域：<code>server</code> 、<code>location</code>、<code>if</code><br>        功能：如果一个URI匹配指定的正则表达式regex，URI就按照 replacement 重写。</p>
<p>rewrite 按配置文件中出现的顺序执行。可以使用 flag 标志来终止指令的进一步处理。</p>
<p>如果 replacement 以 <code>http://</code> 、 <code>https://</code> 或 <code>$ scheme</code> 开始，将不再继续处理，这个重定向将返回给客户端。</p>
<p><strong><code>flag</code></strong> 有四种参数可以选择：</p>
<ol>
<li><p><strong><code>last</code></strong> 停止处理后续 rewrite 指令集，然后对当前重写的新 URI 在 rewrite 指令集上重新查找。</p>
</li>
<li><p><strong><code>break</code></strong> 停止处理后续 rewrite 指令集，并不再重新查找。一般break和代理转发进行配合使用，注意，如果没有break，则新生成的uri会重新执行NGX_HTTP_FIND_CONFIG_PHASE阶段，而使用了break，则不会再进行查找，例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ ^/test/(.*)$</span> &#123;</span><br><span class="line">       <span class="attribute">rewrite</span> /test/(.*) /test/index.php/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">       <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时会按照新生成的uri进行代理转发。</p>
</li>
<li><p><strong><code>redirect</code></strong> 如果 <code>replacement</code> 不是以 <code>http://</code> 或 <code>https://</code> 开始，返回 <code>302</code>临时重定向。</p>
</li>
<li><p><strong><code>permanent</code></strong> 返回 <code>301</code>永久重定向。</p>
</li>
</ol>
<p>rewrite对uri进行改写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;rewrite&quot;),</span><br><span class="line">     NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                      |NGX_CONF_TAKE23,</span><br><span class="line">     ngx_http_rewrite,</span><br><span class="line">     NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">     0,</span><br><span class="line">     NULL &#125;,</span><br></pre></td></tr></table></figure>
<p>其对应方法函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_rewrite(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span>  *lcf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         *value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                         last;</span><br><span class="line">    <span class="keyword">ngx_regex_compile_t</span>                rc;</span><br><span class="line">    ngx_http_script_code_pt           *code;</span><br><span class="line">    <span class="keyword">ngx_http_script_compile_t</span>          sc;</span><br><span class="line">    <span class="keyword">ngx_http_script_regex_code_t</span>      *regex;</span><br><span class="line">    <span class="keyword">ngx_http_script_regex_end_code_t</span>  *regex_end;</span><br><span class="line">    u_char                             errstr[NGX_MAX_CONF_ERRSTR];</span><br><span class="line">    <span class="comment">// 分配处理rewrite中value1，即正则语句的结构,这里存储的原理是存储的一个数组中</span></span><br><span class="line">    regex = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(regex, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_code_t</span>));</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 如果新的uri长度为0，则是配置错误</span></span><br><span class="line">    <span class="keyword">if</span> (value[<span class="number">2</span>].len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"empty replacement"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配进行正则解析的结构</span></span><br><span class="line">    ngx_memzero(&amp;rc, <span class="keyword">sizeof</span>(<span class="keyword">ngx_regex_compile_t</span>));</span><br><span class="line">    <span class="comment">// 设置对应的解析语句</span></span><br><span class="line">    rc.pattern = value[<span class="number">1</span>];</span><br><span class="line">    rc.err.len = NGX_MAX_CONF_ERRSTR;</span><br><span class="line">    rc.err.data = errstr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> NGX_REGEX_CASELESS */</span></span><br><span class="line">    <span class="comment">// 执行解析</span></span><br><span class="line">    regex-&gt;regex = ngx_http_regex_compile(cf, &amp;rc);</span><br><span class="line">    <span class="keyword">if</span> (regex-&gt;regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置对执行该rewrite方法的uri的处理，进行编译，确定是否请求的uri匹配正则表达式，函数参数为regex本身</span></span><br><span class="line">    regex-&gt;code = ngx_http_script_regex_start_code;</span><br><span class="line">    regex-&gt;uri = <span class="number">1</span>;</span><br><span class="line">    regex-&gt;name = value[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 如果value[2]最后存在?,说明需要元素的参数</span></span><br><span class="line">    <span class="keyword">if</span> (value[<span class="number">2</span>].data[value[<span class="number">2</span>].len - <span class="number">1</span>] == <span class="string">'?'</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the last "?" drops the original arguments */</span></span><br><span class="line">        value[<span class="number">2</span>].len--;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则标识需要增加参数</span></span><br><span class="line">        regex-&gt;add_args = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    last = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果转发到http或https，或者schema，则是临时重定向</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_strncmp(value[<span class="number">2</span>].data, <span class="string">"http://"</span>, <span class="keyword">sizeof</span>(<span class="string">"http://"</span>) - <span class="number">1</span>) == <span class="number">0</span></span><br><span class="line">        || ngx_strncmp(value[<span class="number">2</span>].data, <span class="string">"https://"</span>, <span class="keyword">sizeof</span>(<span class="string">"https://"</span>) - <span class="number">1</span>) == <span class="number">0</span></span><br><span class="line">        || ngx_strncmp(value[<span class="number">2</span>].data, <span class="string">"$scheme"</span>, <span class="keyword">sizeof</span>(<span class="string">"$scheme"</span>) - <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        regex-&gt;status = NGX_HTTP_MOVED_TEMPORARILY;</span><br><span class="line">        regex-&gt;redirect = <span class="number">1</span>;</span><br><span class="line">        last = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后的参数含义，设置对应参数</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">3</span>].data, <span class="string">"last"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            last = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">3</span>].data, <span class="string">"break"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            regex-&gt;break_cycle = <span class="number">1</span>;</span><br><span class="line">            last = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">3</span>].data, <span class="string">"redirect"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            regex-&gt;status = NGX_HTTP_MOVED_TEMPORARILY;</span><br><span class="line">            regex-&gt;redirect = <span class="number">1</span>;</span><br><span class="line">            last = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">3</span>].data, <span class="string">"permanent"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            regex-&gt;status = NGX_HTTP_MOVED_PERMANENTLY;</span><br><span class="line">            regex-&gt;redirect = <span class="number">1</span>;</span><br><span class="line">            last = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"invalid parameter \"%V\""</span>, &amp;value[<span class="number">3</span>]);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配编译value2的结构</span></span><br><span class="line">    ngx_memzero(&amp;sc, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_compile_t</span>));</span><br><span class="line">    <span class="comment">// 设置配置</span></span><br><span class="line">    sc.cf = cf;</span><br><span class="line">    <span class="comment">// 设置待解析参数</span></span><br><span class="line">    sc.source = &amp;value[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// ngx_http_script_compile_t中的lengths（计算生成的uri长度的方法数组）取ngx_http_script_regex_code_t中的lengths，这样就是直接在ngx_http_script_regex_code_t的lengths中追加处理方法，之后在执行ngx_http_script_regex_code_t的code函数时，使用lengths来计算需要分配存储新的uri的空间长度</span></span><br><span class="line">    sc.lengths = &amp;regex-&gt;lengths;</span><br><span class="line">    <span class="comment">// ngx_http_script_compile_t中的value是ngx_http_rewrite_loc_conf_t中的codes，即直接在ngx_http_rewrite_loc_conf_t中添加处理方法，这样在完成长度计算后，就会允许变量赋值的处理方法。</span></span><br><span class="line">    sc.values = &amp;lcf-&gt;codes;</span><br><span class="line">    <span class="comment">// 获取需要使用的变量数量，通过$字符</span></span><br><span class="line">    sc.variables = ngx_http_script_variables_count(&amp;value[<span class="number">2</span>]);</span><br><span class="line">    sc.main = regex;</span><br><span class="line">    sc.complete_lengths = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 记录是否需要编译参数，如果是重定向，则不需要编译参数</span></span><br><span class="line">    sc.compile_args = !regex-&gt;redirect;</span><br><span class="line">    <span class="comment">// 执行脚本编译，增加生成新的uri的各个子方法</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_script_compile(&amp;sc) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    regex = sc.main;</span><br><span class="line"></span><br><span class="line">    regex-&gt;size = sc.size;</span><br><span class="line">    regex-&gt;args = sc.args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sc.variables == <span class="number">0</span> &amp;&amp; !sc.dup_capture) &#123;</span><br><span class="line">        regex-&gt;lengths = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 增加在解析完成后获取到新的uri的处理方法</span></span><br><span class="line">    regex_end = ngx_http_script_add_code(lcf-&gt;codes,</span><br><span class="line">                                      <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_end_code_t</span>),</span><br><span class="line">                                      &amp;regex);</span><br><span class="line">    <span class="keyword">if</span> (regex_end == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 方法函数，函数执行的参数即为regex_end本身</span></span><br><span class="line">    regex_end-&gt;code = ngx_http_script_regex_end_code;</span><br><span class="line">    regex_end-&gt;uri = regex-&gt;uri;</span><br><span class="line">    regex_end-&gt;args = regex-&gt;args;</span><br><span class="line">    regex_end-&gt;add_args = regex-&gt;add_args;</span><br><span class="line">    regex_end-&gt;redirect = regex-&gt;redirect;</span><br><span class="line">    <span class="comment">// 如果是last的，则在末尾增加一个null，配合rewrit后的检查阶段，来选择是重新执行遍历，还是直接进行下一阶段</span></span><br><span class="line">    <span class="keyword">if</span> (last) &#123;</span><br><span class="line">        code = ngx_http_script_add_code(lcf-&gt;codes, <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>), &amp;regex);</span><br><span class="line">        <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *code = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果在正则编译时未匹配，则跳过该rewrite后续方法的处理，这里计算跳到的位置</span></span><br><span class="line">    regex-&gt;next = (u_char *) lcf-&gt;codes-&gt;elts + lcf-&gt;codes-&gt;nelts</span><br><span class="line">                                              - (u_char *) regex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-regex-compile"><a href="#ngx-http-regex-compile" class="headerlink" title="ngx_http_regex_compile"></a>ngx_http_regex_compile</h5><p>该方法对正则表达试进行编译。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_regex_t</span> *</span><br><span class="line">ngx_http_regex_compile(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_regex_compile_t</span> *rc)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                     *p;</span><br><span class="line">    <span class="keyword">size_t</span>                      size;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_regex_t</span>           *re;</span><br><span class="line">    <span class="keyword">ngx_http_regex_variable_t</span>  *rv;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    rc-&gt;pool = cf-&gt;pool;</span><br><span class="line">    <span class="comment">// 执行正则编译</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_regex_compile(rc) != NGX_OK) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"%V"</span>, &amp;rc-&gt;err);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    re = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_regex_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (re == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存储正则编译结果</span></span><br><span class="line">    re-&gt;regex = rc-&gt;regex;</span><br><span class="line">    <span class="comment">// 存储捕获变量数量</span></span><br><span class="line">    re-&gt;ncaptures = rc-&gt;captures;</span><br><span class="line">    <span class="comment">// 存储编译的正则语句</span></span><br><span class="line">    re-&gt;name = rc-&gt;pattern;</span><br><span class="line">    <span class="comment">// 获取main级别的ngx_http_core_module生成结构</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 设置捕获变量大小</span></span><br><span class="line">    cmcf-&gt;ncaptures = ngx_max(cmcf-&gt;ncaptures, re-&gt;ncaptures);</span><br><span class="line">    <span class="comment">// 获取命名捕获数量</span></span><br><span class="line">    n = (<span class="keyword">ngx_uint_t</span>) rc-&gt;named_captures;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> re;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配对应数量的正则变量结构</span></span><br><span class="line">    rv = ngx_palloc(rc-&gt;pool, n * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_regex_variable_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (rv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存储变量，记录变量数量</span></span><br><span class="line">    re-&gt;variables = rv;</span><br><span class="line">    re-&gt;nvariables = n;</span><br><span class="line">    <span class="comment">// 获取命名变量size，用于遍历name的table</span></span><br><span class="line">    size = rc-&gt;name_size;</span><br><span class="line">    p = rc-&gt;names;</span><br><span class="line">    <span class="comment">// 变量命名变量</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="comment">// 用于获取变量所在值其实地址的数组的下标。由于table中前两位存储了对应于数字捕获的值，因此先计算出其原始值，再将值乘以2，详见上文中pcre_exec函数</span></span><br><span class="line">        rv[i].capture = <span class="number">2</span> * ((p[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) + p[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">// 记录变量名</span></span><br><span class="line">        name.data = &amp;p[<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// 记录变量长度</span></span><br><span class="line">        name.len = ngx_strlen(name.data);</span><br><span class="line">       <span class="comment">// 条件可变变量，详解变量章节</span></span><br><span class="line">        v = ngx_http_add_variable(cf, &amp;name, NGX_HTTP_VAR_CHANGEABLE);</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取变量所在数组中的index</span></span><br><span class="line">        rv[i].index = ngx_http_get_variable_index(cf, &amp;name);</span><br><span class="line">        <span class="keyword">if</span> (rv[i].index == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置变量对应的处理函数，该函数不会获取值，仅设置not_found为1，即该变量只有rewrite模块使用</span></span><br><span class="line">        v-&gt;get_handler = ngx_http_variable_not_found;</span><br><span class="line">        <span class="comment">// 计算偏移，遍历下一个命名捕获</span></span><br><span class="line">        p += size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-script-regex-start-code"><a href="#ngx-http-script-regex-start-code" class="headerlink" title="ngx_http_script_regex_start_code"></a>ngx_http_script_regex_start_code</h5><p>该函数添加到了<code>ngx_http_rewrite_loc_conf_t</code>中的codes类的实际执行方法。该方法进行正则匹配，并进行相关设置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_regex_start_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                         len;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                      rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                     n;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>            *r;</span><br><span class="line">    <span class="keyword">ngx_http_script_engine_t</span>       le;</span><br><span class="line">    ngx_http_script_len_code_pt    lcode;</span><br><span class="line">    <span class="keyword">ngx_http_script_regex_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_regex_code_t</span> *) e-&gt;ip;</span><br><span class="line"></span><br><span class="line">    r = e-&gt;request;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script regex: \"%V\""</span>, &amp;code-&gt;name);</span><br><span class="line">    <span class="comment">// 获取要执行解析的uri，根据是否有uri，这里在rewrite中使用的是uri</span></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;uri) &#123;</span><br><span class="line">        e-&gt;line = r-&gt;uri;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        e-&gt;sp--;</span><br><span class="line">        e-&gt;line.len = e-&gt;sp-&gt;len;</span><br><span class="line">        e-&gt;line.data = e-&gt;sp-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行http正则解析</span></span><br><span class="line">    rc = ngx_http_regex_exec(r, code-&gt;regex, &amp;e-&gt;line);</span><br><span class="line">    <span class="comment">// 如果解析结果为不匹配</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e-&gt;<span class="built_in">log</span> || (r-&gt;connection-&gt;<span class="built_in">log</span>-&gt;log_level &amp; NGX_LOG_DEBUG_HTTP)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"\"%V\" does not match \"%V\""</span>,</span><br><span class="line">                          &amp;code-&gt;name, &amp;e-&gt;line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;ncaptures = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 测试？，</span></span><br><span class="line">        <span class="keyword">if</span> (code-&gt;test) &#123;</span><br><span class="line">            <span class="keyword">if</span> (code-&gt;negative_test) &#123;</span><br><span class="line">                e-&gt;sp-&gt;len = <span class="number">1</span>;</span><br><span class="line">                e-&gt;sp-&gt;data = (u_char *) <span class="string">"1"</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                e-&gt;sp-&gt;len = <span class="number">0</span>;</span><br><span class="line">                e-&gt;sp-&gt;data = (u_char *) <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e-&gt;sp++;</span><br><span class="line"></span><br><span class="line">            e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_code_t</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 跳过对该rewrite剩下的操作，next指向rewrite后的函数</span></span><br><span class="line">        e-&gt;ip += code-&gt;next;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析错误处理，设置status将会在该阶段立即结束请求</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">        e-&gt;status = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;<span class="built_in">log</span> || (r-&gt;connection-&gt;<span class="built_in">log</span>-&gt;log_level &amp; NGX_LOG_DEBUG_HTTP)) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"\"%V\" matches \"%V\""</span>, &amp;code-&gt;name, &amp;e-&gt;line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;test) &#123;</span><br><span class="line">        <span class="keyword">if</span> (code-&gt;negative_test) &#123;</span><br><span class="line">            e-&gt;sp-&gt;len = <span class="number">0</span>;</span><br><span class="line">            e-&gt;sp-&gt;data = (u_char *) <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            e-&gt;sp-&gt;len = <span class="number">1</span>;</span><br><span class="line">            e-&gt;sp-&gt;data = (u_char *) <span class="string">"1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        e-&gt;sp++;</span><br><span class="line"></span><br><span class="line">        e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_code_t</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果设置了返回状态码，即是重定向，则在e中设置对应的状态码，后续执行结束请求返回用户的状态码，设置返回状态码后会立即结束请求，返回响应</span></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;status) &#123;</span><br><span class="line">        e-&gt;status = code-&gt;status;</span><br><span class="line">        <span class="comment">// 只有在重定向时才应该有状态码，否则是错误</span></span><br><span class="line">        <span class="keyword">if</span> (!code-&gt;redirect) &#123;</span><br><span class="line">            e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是重写uri</span></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;uri) &#123;</span><br><span class="line">        <span class="comment">// 请求变成内部请求</span></span><br><span class="line">        r-&gt;internal = <span class="number">1</span>;</span><br><span class="line">        r-&gt;valid_unparsed_uri = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 如果是跳出循环，则设置获取有效的location为0</span></span><br><span class="line">        <span class="keyword">if</span> (code-&gt;break_cycle) &#123;</span><br><span class="line">            r-&gt;valid_location = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 设置uri发送变更为0，在NGX_HTTP_POST_REWRITE_PHASE阶段将根据该值，决定直接进行下一阶段</span></span><br><span class="line">            r-&gt;uri_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则uri发生变更，NGX_HTTP_POST_REWRITE_PHASE阶段根据该值，重新执行find_config_index阶段</span></span><br><span class="line">            r-&gt;uri_changed = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果计算新生成的uri长度的数组为null</span></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;lengths == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        e-&gt;buf.len = code-&gt;size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (code-&gt;uri) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r-&gt;ncaptures &amp;&amp; (r-&gt;quoted_uri || r-&gt;plus_in_uri)) &#123;</span><br><span class="line">                e-&gt;buf.len += <span class="number">2</span> * ngx_escape_uri(<span class="literal">NULL</span>, r-&gt;uri.data, r-&gt;uri.len,</span><br><span class="line">                                                 NGX_ESCAPE_ARGS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">2</span>; n &lt; r-&gt;ncaptures; n += <span class="number">2</span>) &#123;</span><br><span class="line">            e-&gt;buf.len += r-&gt;captures[n + <span class="number">1</span>] - r-&gt;captures[n];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 长度不为空的处理，依次调用长度的处理函数，累加获取到新的uri长度</span></span><br><span class="line">        ngx_memzero(&amp;le, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_engine_t</span>));</span><br><span class="line"></span><br><span class="line">        le.ip = code-&gt;lengths-&gt;elts;</span><br><span class="line">        le.line = e-&gt;line;</span><br><span class="line">        le.request = r;</span><br><span class="line">        le.quote = code-&gt;redirect;</span><br><span class="line"></span><br><span class="line">        len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (*(<span class="keyword">uintptr_t</span> *) le.ip) &#123;</span><br><span class="line">            lcode = *(ngx_http_script_len_code_pt *) le.ip;</span><br><span class="line">            len += lcode(&amp;le);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        e-&gt;buf.len = len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要增加参数，则buf中增加参数部分长度</span></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;add_args &amp;&amp; r-&gt;args.len) &#123;</span><br><span class="line">        e-&gt;buf.len += r-&gt;args.len + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配buf空间</span></span><br><span class="line">    e-&gt;buf.data = ngx_pnalloc(r-&gt;pool, e-&gt;buf.len);</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;buf.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">        e-&gt;status = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// quoto标识是否为重定向</span></span><br><span class="line">    e-&gt;quote = code-&gt;redirect;</span><br><span class="line">    <span class="comment">// 初始变量赋值起始地址</span></span><br><span class="line">    e-&gt;pos = e-&gt;buf.data;</span><br><span class="line">    <span class="comment">// 即ip向后移动，执行下一个处理类及其函数</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_code_t</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-regex-exec"><a href="#ngx-http-regex-exec" class="headerlink" title="ngx_http_regex_exec"></a>ngx_http_regex_exec</h6><p>执行http正则匹配：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_regex_exec(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_regex_t</span> *re, <span class="keyword">ngx_str_t</span> *s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc, index;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n, len;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *vv;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取核心模块</span></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 如果设置了捕获数量</span></span><br><span class="line">    <span class="keyword">if</span> (re-&gt;ncaptures) &#123;</span><br><span class="line">        <span class="comment">// 存储捕获偏移数组长度，该长度为所有模块中捕获长度最大值+1 再乘以3的结果，可看ngx_http_core_module模块的init方法。</span></span><br><span class="line">        len = cmcf-&gt;ncaptures;</span><br><span class="line">        <span class="comment">// 如果捕获数组为null，或者需要重新分配</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;captures == <span class="literal">NULL</span> || r-&gt;realloc_captures) &#123;</span><br><span class="line">            r-&gt;realloc_captures = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 分配地址空间</span></span><br><span class="line">            r-&gt;captures = ngx_palloc(r-&gt;pool, len * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            <span class="keyword">if</span> (r-&gt;captures == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行正则匹配</span></span><br><span class="line">    rc = ngx_regex_exec(re-&gt;regex, s, r-&gt;captures, len);</span><br><span class="line">    <span class="comment">// 不匹配</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_REGEX_NO_MATCHED) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出错</span></span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      ngx_regex_exec_n <span class="string">" failed: %i on \"%V\" using \"%V\""</span>,</span><br><span class="line">                      rc, s, &amp;re-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 变量每个命名命名捕获</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; re-&gt;nvariables; i++) &#123;</span><br><span class="line"></span><br><span class="line">        n = re-&gt;variables[i].capture;</span><br><span class="line">        index = re-&gt;variables[i].index;</span><br><span class="line">        vv = &amp;r-&gt;variables[index];</span><br><span class="line">        <span class="comment">// 对变量赋值</span></span><br><span class="line">        vv-&gt;len = r-&gt;captures[n + <span class="number">1</span>] - r-&gt;captures[n];</span><br><span class="line">        vv-&gt;valid = <span class="number">1</span>;</span><br><span class="line">        vv-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">        vv-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">        vv-&gt;data = &amp;s-&gt;data[r-&gt;captures[n]];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">        ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置请求的ncaptures长度为获取得到的捕获数组*2</span></span><br><span class="line">    r-&gt;ncaptures = rc * <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 捕获对应的值为进行正则匹配的字符串</span></span><br><span class="line">    r-&gt;captures_data = s-&gt;data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-script-compile"><a href="#ngx-http-script-compile" class="headerlink" title="ngx_http_script_compile"></a>ngx_http_script_compile</h5><p>该函数负责对新生成的uri的构建工作，对表达式进行解析，并在codes中增加响应的处理函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_compile(<span class="keyword">ngx_http_script_compile_t</span> *sc)</span><br><span class="line">&#123;</span><br><span class="line">    u_char       ch;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>    name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, bracket;</span><br><span class="line">    <span class="comment">// 初始化相关参数，负责根据先前解析的变量数量对values和lengths进行初始化</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_script_init_arrays(sc) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sc-&gt;source-&gt;len; <span class="comment">/* void */</span> ) &#123;</span><br><span class="line">        <span class="comment">// 记录命名变量的长度</span></span><br><span class="line">        name.len = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 如果为$,则表示是变量的开始位置</span></span><br><span class="line">        <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'$'</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果下一个是结尾，说明配置错误</span></span><br><span class="line">            <span class="keyword">if</span> (++i == sc-&gt;source-&gt;len) &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果指为1-9之间的数字</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] &gt;= <span class="string">'1'</span> &amp;&amp; sc-&gt;source-&gt;data[i] &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">                <span class="keyword">ngx_uint_t</span>  n;</span><br><span class="line">                <span class="comment">// 计算实际对应的捕获值数字</span></span><br><span class="line">                n = sc-&gt;source-&gt;data[i] - <span class="string">'0'</span>;</span><br><span class="line">                <span class="comment">// 如果该值在之前已经使用过，则记录dup_capture复用捕获为1</span></span><br><span class="line">                <span class="keyword">if</span> (sc-&gt;captures_mask &amp; ((<span class="keyword">ngx_uint_t</span>) <span class="number">1</span> &lt;&lt; n)) &#123;</span><br><span class="line">                    sc-&gt;dup_capture = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 记录该值被使用过</span></span><br><span class="line">                sc-&gt;captures_mask |= (<span class="keyword">ngx_uint_t</span>) <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">                <span class="comment">// 增加对应的处理函数，包含计算变量长度函数和变量值函数</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_script_add_capture_code(sc, n) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 向后移动i</span></span><br><span class="line">                i++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"using variable \"$%c\" requires "</span></span><br><span class="line">                                   <span class="string">"PCRE library"</span>, sc-&gt;source-&gt;data[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果值为&#123;,则记录获取到左括号</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                bracket = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 同样，如果立即结束了，则报错</span></span><br><span class="line">                <span class="keyword">if</span> (++i == sc-&gt;source-&gt;len) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 记录命名捕获的变量名</span></span><br><span class="line">                name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则，仅记录变量开始位置，即变量配置允许$name和$&#123;name&#125;两种</span></span><br><span class="line">                bracket = <span class="number">0</span>;</span><br><span class="line">                name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取变量名长度</span></span><br><span class="line">            <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; i &lt; sc-&gt;source-&gt;len; i++, name.len++) &#123;</span><br><span class="line">                ch = sc-&gt;source-&gt;data[i];</span><br><span class="line">                <span class="comment">// 获取右括号，并且之前有左括号，则找到变量名长度了</span></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#125;'</span> &amp;&amp; bracket) &#123;</span><br><span class="line">                    i++;</span><br><span class="line">                    bracket = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 允许的合法值</span></span><br><span class="line">                <span class="keyword">if</span> ((ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>)</span><br><span class="line">                    || (ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>)</span><br><span class="line">                    || (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>)</span><br><span class="line">                    || ch == <span class="string">'_'</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果只有左括号，在找到右括号前break，则配置错误</span></span><br><span class="line">            <span class="keyword">if</span> (bracket) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"the closing bracket in \"%V\" "</span></span><br><span class="line">                                   <span class="string">"variable is missing"</span>, &amp;name);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 长度为0，配置错误</span></span><br><span class="line">            <span class="keyword">if</span> (name.len == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 变量值加1</span></span><br><span class="line">            sc-&gt;variables++;</span><br><span class="line">            <span class="comment">// 增加对于命名变量的处理方法，包括计算程度和value</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_script_add_var_code(sc, &amp;name) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果是?则是变量的起始位置，即用户自定义了相关参数，如果设置了需要编译参数，则进行处理</span></span><br><span class="line"><span class="comment">        这里需要注意，其实后续的参数是通过剩余三种方式进行赋值的，常量拷贝，命名捕获和匿名捕获，这里只是将?本身剔除，用于在rewrite中包含用户新增参数的处理。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'?'</span> &amp;&amp; sc-&gt;compile_args) &#123;</span><br><span class="line">            sc-&gt;args = <span class="number">1</span>;</span><br><span class="line">            sc-&gt;compile_args = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 增加对变量的处理</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_script_add_args_code(sc) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 其他情况是简单的值拷贝，获取起始地址及其长度</span></span><br><span class="line">        name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; sc-&gt;source-&gt;len) &#123;</span><br><span class="line">            <span class="comment">// 知道$或?都是需要拷贝的值</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'$'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'?'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                sc-&gt;args = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sc-&gt;compile_args) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line">            name.len++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sc-&gt;size += name.len;</span><br><span class="line">        <span class="comment">// 增加简单的值拷贝处理函数</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_script_add_copy_code(sc, &amp;name, (i == sc-&gt;source-&gt;len))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 进行首位工作，主要包括对length中增加结尾，如果需要末尾增加\0,则增加对应的赋值处理，如果是获取文件，则根据相对目录，增加对最终的绝对路径的计算</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_script_done(sc);</span><br><span class="line"></span><br><span class="line">invalid_variable:</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>, <span class="string">"invalid variable name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-script-add-capture-code"><a href="#ngx-http-script-add-capture-code" class="headerlink" title="ngx_http_script_add_capture_code"></a>ngx_http_script_add_capture_code</h6><p>添加匿名捕获处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其中n为匿名捕获对应的数值</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_capture_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_uint_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_capture_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 向lengths中增加计算长度的处理</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_capture_code_t</span>),</span><br><span class="line">                                    <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 长度处理函数</span></span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                         ngx_http_script_copy_capture_len_code;</span><br><span class="line">    <span class="comment">// 该值为相对位置数组中的偏移</span></span><br><span class="line">    code-&gt;n = <span class="number">2</span> * n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向values中增加计算值的处理函数</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_capture_code_t</span>),</span><br><span class="line">                                    &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 函数逻辑</span></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_capture_code;</span><br><span class="line">    code-&gt;n = <span class="number">2</span> * n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sc-&gt;ncaptures &lt; n) &#123;</span><br><span class="line">        sc-&gt;ncaptures = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_copy_capture_code_t定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ngx_http_script_code_pt     code; <span class="comment">// 处理方法</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   n; <span class="comment">// 相对捕获数组的偏移</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_script_copy_capture_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中长度处理函数逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_capture_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                                  *cap;</span><br><span class="line">    u_char                               *p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                            n;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>                   *r;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_capture_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    r = e-&gt;request;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_capture_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip向后移动，用于下个计算</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_capture_code_t</span>);</span><br><span class="line">    <span class="comment">// 获取长度其实位置在数组中的偏移</span></span><br><span class="line">    n = code-&gt;n;</span><br><span class="line">    <span class="comment">// n应该小于捕获的最大长度</span></span><br><span class="line">    <span class="keyword">if</span> (n &lt; r-&gt;ncaptures) &#123;</span><br><span class="line">        <span class="comment">// 获取捕获的偏移数组</span></span><br><span class="line">        cap = r-&gt;captures;</span><br><span class="line">        <span class="comment">// 复杂uri处理</span></span><br><span class="line">        <span class="keyword">if</span> ((e-&gt;is_args || e-&gt;quote)</span><br><span class="line">            &amp;&amp; (e-&gt;request-&gt;quoted_uri || e-&gt;request-&gt;plus_in_uri))</span><br><span class="line">        &#123;</span><br><span class="line">            p = r-&gt;captures_data;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> cap[n + <span class="number">1</span>] - cap[n]</span><br><span class="line">                   + <span class="number">2</span> * ngx_escape_uri(<span class="literal">NULL</span>, &amp;p[cap[n]], cap[n + <span class="number">1</span>] - cap[n],</span><br><span class="line">                                        NGX_ESCAPE_ARGS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 计算长度</span></span><br><span class="line">            <span class="keyword">return</span> cap[n + <span class="number">1</span>] - cap[n];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的值处理逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_copy_capture_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                                  *cap;</span><br><span class="line">    u_char                               *p, *pos;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                            n;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>                   *r;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_capture_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    r = e-&gt;request;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_capture_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip向后移动，用于下个计算</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_capture_code_t</span>);</span><br><span class="line"></span><br><span class="line">    n = code-&gt;n;</span><br><span class="line"></span><br><span class="line">    pos = e-&gt;pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; r-&gt;ncaptures) &#123;</span><br><span class="line">        <span class="comment">// 获取数组</span></span><br><span class="line">        cap = r-&gt;captures;</span><br><span class="line">        p = r-&gt;captures_data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((e-&gt;is_args || e-&gt;quote)</span><br><span class="line">            &amp;&amp; (e-&gt;request-&gt;quoted_uri || e-&gt;request-&gt;plus_in_uri))</span><br><span class="line">        &#123;</span><br><span class="line">            e-&gt;pos = (u_char *) ngx_escape_uri(pos, &amp;p[cap[n]],</span><br><span class="line">                                               cap[n + <span class="number">1</span>] - cap[n],</span><br><span class="line">                                               NGX_ESCAPE_ARGS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 进行值拷贝，并将pos向后移动响应长度</span></span><br><span class="line">            e-&gt;pos = ngx_copy(pos, &amp;p[cap[n]], cap[n + <span class="number">1</span>] - cap[n]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script capture: \"%*s\""</span>, e-&gt;pos - pos, pos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-script-add-var-code"><a href="#ngx-http-script-add-var-code" class="headerlink" title="ngx_http_script_add_var_code"></a>ngx_http_script_add_var_code</h6><p>该方法增加命名捕获变量的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_var_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_str_t</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                    index, *p;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 获取变量对应的index，查看变量章节</span></span><br><span class="line">    index = ngx_http_get_variable_index(sc-&gt;cf, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向flushes中添加索引</span></span><br><span class="line">    <span class="keyword">if</span> (sc-&gt;flushes) &#123;</span><br><span class="line">        p = ngx_array_push(*sc-&gt;flushes);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *p = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 增加长度计算处理函数</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                             ngx_http_script_copy_var_len_code;</span><br><span class="line">    code-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line">    <span class="comment">// 增加值获取处理函数</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>),</span><br><span class="line">                                    &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_var_code;</span><br><span class="line">    code-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_var_code_t定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ngx_http_script_code_pt     code; <span class="comment">// 处理函数</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   index; <span class="comment">// 所在变量数组中的索引</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_script_var_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中计算长度函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_var_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>   *value;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// ip向后移动</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line">    <span class="comment">// 获取变量值</span></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;flushed) &#123;</span><br><span class="line">        value = ngx_http_get_indexed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value = ngx_http_get_flushed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回长度</span></span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; !value-&gt;not_found) &#123;</span><br><span class="line">        <span class="keyword">return</span> value-&gt;len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取值函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">oid</span><br><span class="line">ngx_http_script_copy_var_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                      *p;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>   *value;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 对ip进行偏移</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;skip) &#123;</span><br><span class="line">        <span class="comment">// 获取变量值</span></span><br><span class="line">        <span class="keyword">if</span> (e-&gt;flushed) &#123;</span><br><span class="line">            value = ngx_http_get_indexed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = ngx_http_get_flushed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 赋值，并移动pos</span></span><br><span class="line">        <span class="keyword">if</span> (value &amp;&amp; !value-&gt;not_found) &#123;</span><br><span class="line">            p = e-&gt;pos;</span><br><span class="line">            e-&gt;pos = ngx_copy(p, value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_HTTP,</span><br><span class="line">                           e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http script var: \"%*s\""</span>, e-&gt;pos - p, p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-script-add-copy-code"><a href="#ngx-http-script-add-copy-code" class="headerlink" title="ngx_http_script_add_copy_code"></a>ngx_http_script_add_copy_code</h6><p>该函数增加简单的值拷贝处理逻辑。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// last判断是否为值的末尾</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_copy_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_str_t</span> *value,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> last)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                       *p;</span><br><span class="line">    <span class="keyword">size_t</span>                        size, len, zero;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 如果要在文本末尾增加\0,并且到达了末尾，长度增加ngx_http_script_copy_len_code处理函数</span></span><br><span class="line">    zero = (sc-&gt;zero &amp;&amp; last);</span><br><span class="line">    len = value-&gt;len + zero;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_compile_t中的lengths增加</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                                 ngx_http_script_copy_len_code;</span><br><span class="line">    code-&gt;len = len;</span><br><span class="line">    <span class="comment">// 申请空间包括一个存储ngx_http_script_copy_code_t结构的空间，和存储常量值长度的空间，并进行了内存对齐</span></span><br><span class="line">    size = (<span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>) + len + <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>)</span><br><span class="line">            &amp; ~(<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在ngx_http_rewrite_loc_conf_t中的codes增加ngx_http_script_copy_code</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values, size, &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_code;</span><br><span class="line">    code-&gt;len = len;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_copy_code_t的后面增加对应的常量值。</span></span><br><span class="line">    p = ngx_cpymem((u_char *) code + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>),</span><br><span class="line">                   value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zero) &#123;</span><br><span class="line">        *p = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="comment">// zero变更为0，表示末尾已正常添加\0,后续不用再添加了</span></span><br><span class="line">        sc-&gt;zero = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_copy_code_t定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ngx_http_script_code_pt     code; <span class="comment">// 函数方法</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   len; <span class="comment">// 值长度，这里并没有直接存储值，而是在该结构后分配对应len空间，来存储值</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_script_copy_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>计算长度和获取值处理如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line">    </span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// ip指向下一个指令</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>);</span><br><span class="line">    <span class="comment">// 返回常量对应的长度</span></span><br><span class="line">    <span class="keyword">return</span> code-&gt;len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_copy_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                       *p;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_code_t</span> *) e-&gt;ip;</span><br><span class="line"></span><br><span class="line">    p = e-&gt;pos;</span><br><span class="line">    <span class="comment">// 把常量拷贝到pos中，将pos后移</span></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;skip) &#123;</span><br><span class="line">        e-&gt;pos = ngx_copy(p, e-&gt;ip + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>),</span><br><span class="line">                          code-&gt;len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法。这里和构建时一样，进行了内存对齐。</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>)</span><br><span class="line">          + ((code-&gt;len + <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>) &amp; ~(<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script copy: \"%*s\""</span>, e-&gt;pos - p, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-script-add-args-code"><a href="#ngx-http-script-add-args-code" class="headerlink" title="ngx_http_script_add_args_code"></a>ngx_http_script_add_args_code</h6><p><code>ngx_http_script_add_args_code</code>函数添加对参数的处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_args_code(<span class="keyword">ngx_http_script_compile_t</span> *sc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uintptr_t</span>   *code;</span><br><span class="line"></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths, <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *code = (<span class="keyword">uintptr_t</span>) ngx_http_script_mark_args_code;</span><br><span class="line"></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values, <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>), &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *code = (<span class="keyword">uintptr_t</span>) ngx_http_script_start_args_code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>计算长度和值的函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">size_t</span><br><span class="line">ngx_http_script_mark_args_code(ngx_http_script_engine_t *e)</span><br><span class="line">&#123;</span><br><span class="line">    e-&gt;is_args = 1;</span><br><span class="line">    e-&gt;ip += sizeof(uintptr_t);</span><br><span class="line"></span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void</span><br><span class="line">ngx_http_script_start_args_code(ngx_http_script_engine_t *e)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;log, 0,</span><br><span class="line">                   &quot;http script args&quot;);</span><br><span class="line"></span><br><span class="line">    e-&gt;is_args = 1;</span><br><span class="line">    e-&gt;args = e-&gt;pos;</span><br><span class="line">    e-&gt;ip += sizeof(uintptr_t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-script-add-code"><a href="#ngx-http-script-add-code" class="headerlink" title="ngx_http_script_add_code"></a>ngx_http_script_add_code</h5><p>该函数向codes数组中添加元素，但多了一个参数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_http_script_add_code(<span class="keyword">ngx_array_t</span> *codes, <span class="keyword">size_t</span> size, <span class="keyword">void</span> *code)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  *elts, **p;</span><br><span class="line">    <span class="keyword">void</span>    *<span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">    elts = codes-&gt;elts;</span><br><span class="line">    <span class="comment">// 向array中添加元素</span></span><br><span class="line">    <span class="keyword">new</span> = ngx_array_push_n(codes, size);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果存在code</span></span><br><span class="line">    <span class="keyword">if</span> (code) &#123;</span><br><span class="line">        <span class="comment">// 如果array数组发生了拷贝，即地址发生了偏移，则计算相关的偏移量，重新对code赋值，找到其所在的新地址</span></span><br><span class="line">        <span class="keyword">if</span> (elts != codes-&gt;elts) &#123;</span><br><span class="line">            p = code;</span><br><span class="line">            *p += (u_char *) codes-&gt;elts - elts;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该处理函数的code含义为，对于添加元素来说，当先前分配的地址不够直接添加时，会生成一个新的更大的地址，这时旧的code地址就无法继续使用了，但执行完该函数后，好需要继续使用code，这时就需要计算新的code所在地址，找到新的地址，继续使用。</p>
<h5 id="ngx-http-script-regex-end-code"><a href="#ngx-http-script-regex-end-code" class="headerlink" title="ngx_http_script_regex_end_code"></a>ngx_http_script_regex_end_code</h5><p><code>ngx_http_script_regex_end_code</code>函数对完成rewrite方法后进行处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_regex_end_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                            *dst, *src;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>                *r;</span><br><span class="line">    <span class="keyword">ngx_http_script_regex_end_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_regex_end_code_t</span> *) e-&gt;ip;</span><br><span class="line"></span><br><span class="line">    r = e-&gt;request;</span><br><span class="line"></span><br><span class="line">    e-&gt;quote = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script regex end"</span>);</span><br><span class="line">    <span class="comment">// 如果是rewrite是重定向</span></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;redirect) &#123;</span><br><span class="line">        <span class="comment">// 对新生成的uri进一步归一化，检查</span></span><br><span class="line">        dst = e-&gt;buf.data;</span><br><span class="line">        src = e-&gt;buf.data;</span><br><span class="line"></span><br><span class="line">        ngx_unescape_uri(&amp;dst, &amp;src, e-&gt;pos - e-&gt;buf.data,</span><br><span class="line">                         NGX_UNESCAPE_REDIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (src &lt; e-&gt;pos) &#123;</span><br><span class="line">            dst = ngx_movemem(dst, src, e-&gt;pos - src);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// pos存储新的uri</span></span><br><span class="line">        e-&gt;pos = dst;</span><br><span class="line">        <span class="comment">// 如果需要增加参数</span></span><br><span class="line">        <span class="keyword">if</span> (code-&gt;add_args &amp;&amp; r-&gt;args.len) &#123;</span><br><span class="line">             <span class="comment">// 如果用户原本已经有新增的参数，则将原参数拼接的方式是使用&amp;，否则使用?</span></span><br><span class="line">            *e-&gt;pos++ = (u_char) (code-&gt;args ? <span class="string">'&amp;'</span> : <span class="string">'?'</span>);</span><br><span class="line">            e-&gt;pos = ngx_copy(e-&gt;pos, r-&gt;args.data, r-&gt;args.len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录新的uri长度</span></span><br><span class="line">        e-&gt;buf.len = e-&gt;pos - e-&gt;buf.data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e-&gt;<span class="built_in">log</span> || (r-&gt;connection-&gt;<span class="built_in">log</span>-&gt;log_level &amp; NGX_LOG_DEBUG_HTTP)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"rewritten redirect: \"%V\""</span>, &amp;e-&gt;buf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        清理headers_out为空</span></span><br><span class="line"><span class="comment">        #define ngx_http_clear_location(r)                                            \</span></span><br><span class="line"><span class="comment">                                                                              \</span></span><br><span class="line"><span class="comment">        if (r-&gt;headers_out.location) &#123;                                            \</span></span><br><span class="line"><span class="comment">            r-&gt;headers_out.location-&gt;hash = 0;                                    \</span></span><br><span class="line"><span class="comment">            r-&gt;headers_out.location = NULL;                                       \</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        ngx_http_clear_location(r);</span><br><span class="line">        <span class="comment">// headers_out中增加一个Location头</span></span><br><span class="line">        r-&gt;headers_out.location = ngx_list_push(&amp;r-&gt;headers_out.headers);</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;headers_out.location == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">            e-&gt;status = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;headers_out.location-&gt;hash = <span class="number">1</span>;</span><br><span class="line">        ngx_str_set(&amp;r-&gt;headers_out.location-&gt;key, <span class="string">"Location"</span>);</span><br><span class="line">        <span class="comment">// 设置Location头值为新的uri，即重定向位置</span></span><br><span class="line">        r-&gt;headers_out.location-&gt;value = e-&gt;buf;</span><br><span class="line">        <span class="comment">// 向后移动ip指针，一般后面是null，结束当前rewrite阶段。</span></span><br><span class="line">        e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_end_code_t</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果需要处理参数，即rewrite后有新增加参数</span></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;args) &#123;</span><br><span class="line">        <span class="comment">// 计算uri长度</span></span><br><span class="line">        e-&gt;buf.len = e-&gt;args - e-&gt;buf.data;</span><br><span class="line">        <span class="comment">// 如果需要增加参数，并且原参数不为空，添加参数</span></span><br><span class="line">        <span class="keyword">if</span> (code-&gt;add_args &amp;&amp; r-&gt;args.len) &#123;</span><br><span class="line">            *e-&gt;pos++ = <span class="string">'&amp;'</span>;</span><br><span class="line">            e-&gt;pos = ngx_copy(e-&gt;pos, r-&gt;args.data, r-&gt;args.len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置参数长度和值</span></span><br><span class="line">        r-&gt;args.len = e-&gt;pos - e-&gt;args;</span><br><span class="line">        r-&gt;args.data = e-&gt;args;</span><br><span class="line"></span><br><span class="line">        e-&gt;args = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果不需要单独处理参数，则参数值不变</span></span><br><span class="line">        e-&gt;buf.len = e-&gt;pos - e-&gt;buf.data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!code-&gt;add_args) &#123;</span><br><span class="line">            r-&gt;args.len = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;<span class="built_in">log</span> || (r-&gt;connection-&gt;<span class="built_in">log</span>-&gt;log_level &amp; NGX_LOG_DEBUG_HTTP)) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"rewritten data: \"%V\", args: \"%V\""</span>,</span><br><span class="line">                      &amp;e-&gt;buf, &amp;r-&gt;args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (code-&gt;uri) &#123;</span><br><span class="line">        <span class="comment">// 新的uri为buf值</span></span><br><span class="line">        r-&gt;uri = e-&gt;buf;</span><br><span class="line">        <span class="comment">// 长度为0则报错</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;uri.len == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"the rewritten URI has a zero length"</span>);</span><br><span class="line">            e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">            e-&gt;status = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据新的uri设置exten值</span></span><br><span class="line">        ngx_http_set_exten(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向后移动ip，继续处理</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_regex_end_code_t</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="if-配置"><a href="#if-配置" class="headerlink" title="if 配置"></a>if 配置</h4><h3 id="merge-location方法"><a href="#merge-location方法" class="headerlink" title="merge location方法"></a>merge location方法</h3><p><code>ngx_http_rewrite_merge_loc_conf</code>为mergelocation方法。其执行逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_rewrite_merge_loc_conf(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">void</span> *parent, <span class="keyword">void</span> *child)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span> *prev = parent;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span> *conf = child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uintptr_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    ngx_conf_merge_value(conf-&gt;<span class="built_in">log</span>, prev-&gt;<span class="built_in">log</span>, <span class="number">0</span>);</span><br><span class="line">    ngx_conf_merge_value(conf-&gt;uninitialized_variable_warn,</span><br><span class="line">                         prev-&gt;uninitialized_variable_warn, <span class="number">1</span>);</span><br><span class="line">    ngx_conf_merge_uint_value(conf-&gt;stack_size, prev-&gt;stack_size, <span class="number">10</span>);</span><br><span class="line">    <span class="comment">// 如果子层级的codes为空，则不需要merge</span></span><br><span class="line">    <span class="keyword">if</span> (conf-&gt;codes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子层级和父层级codes一致，（if配置），则跳过merge</span></span><br><span class="line">    <span class="keyword">if</span> (conf-&gt;codes == prev-&gt;codes) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子层级增加一个null结尾</span></span><br><span class="line">    code = ngx_array_push_n(conf-&gt;codes, <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *code = (<span class="keyword">uintptr_t</span>) <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="postconfiguration方法"><a href="#postconfiguration方法" class="headerlink" title="postconfiguration方法"></a>postconfiguration方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_rewrite_init(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    h = ngx_array_push(&amp;cmcf-&gt;phases[NGX_HTTP_SERVER_REWRITE_PHASE].handlers);</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *h = ngx_http_rewrite_handler;</span><br><span class="line"></span><br><span class="line">    h = ngx_array_push(&amp;cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers);</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *h = ngx_http_rewrite_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>向<code>NGX_HTTP_SERVER_REWRITE_PHASE</code>和<code>NGX_HTTP_REWRITE_PHASE</code>阶段增加处理函数。</p>
<h2 id="ngx-http-limit-req-module"><a href="#ngx-http-limit-req-module" class="headerlink" title="ngx_http_limit_req_module"></a>ngx_http_limit_req_module</h2><p>该模块主要用于限流，在<code>NGX_HTTP_PREACCESS_PHASE</code>阶段执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">static ngx_command_t  ngx_http_limit_req_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;limit_req_zone&quot;),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_CONF_TAKE3,</span><br><span class="line">      ngx_http_limit_req_zone,</span><br><span class="line">      0,</span><br><span class="line">      0,</span><br><span class="line">      NULL &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;limit_req&quot;),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE123,</span><br><span class="line">      ngx_http_limit_req,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      0,</span><br><span class="line">      NULL &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;limit_req_log_level&quot;),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_conf_set_enum_slot,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      offsetof(ngx_http_limit_req_conf_t, limit_log_level),</span><br><span class="line">      &amp;ngx_http_limit_req_log_levels &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;limit_req_status&quot;),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_conf_set_num_slot,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      offsetof(ngx_http_limit_req_conf_t, status_code),</span><br><span class="line">      &amp;ngx_http_limit_req_status_bounds &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;limit_req_dry_run&quot;),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_FLAG,</span><br><span class="line">      ngx_conf_set_flag_slot,</span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">      offsetof(ngx_http_limit_req_conf_t, dry_run),</span><br><span class="line">      NULL &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static ngx_http_module_t  ngx_http_limit_req_module_ctx = &#123;</span><br><span class="line">    ngx_http_limit_req_add_variables,      /* preconfiguration */</span><br><span class="line">    ngx_http_limit_req_init,               /* postconfiguration */</span><br><span class="line"></span><br><span class="line">    NULL,                                  /* create main configuration */</span><br><span class="line">    NULL,                                  /* init main configuration */</span><br><span class="line"></span><br><span class="line">    NULL,                                  /* create server configuration */</span><br><span class="line">    NULL,                                  /* merge server configuration */</span><br><span class="line"></span><br><span class="line">    ngx_http_limit_req_create_conf,        /* create location configuration */</span><br><span class="line">    ngx_http_limit_req_merge_conf          /* merge location configuration */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ngx_module_t  ngx_http_limit_req_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_http_limit_req_module_ctx,        /* module context */</span><br><span class="line">    ngx_http_limit_req_commands,           /* module directives */</span><br><span class="line">    NGX_HTTP_MODULE,                       /* module type */</span><br><span class="line">    NULL,                                  /* init master */</span><br><span class="line">    NULL,                                  /* init module */</span><br><span class="line">    NULL,                                  /* init process */</span><br><span class="line">    NULL,                                  /* init thread */</span><br><span class="line">    NULL,                                  /* exit thread */</span><br><span class="line">    NULL,                                  /* exit process */</span><br><span class="line">    NULL,                                  /* exit master */</span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="相关结构-8"><a href="#相关结构-8" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-http-limit-req-conf-t"><a href="#ngx-http-limit-req-conf-t" class="headerlink" title="ngx_http_limit_req_conf_t"></a>ngx_http_limit_req_conf_t</h4><p>该结构为模块创建的location的配置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                  limits; <span class="comment">// 限制纬度和相关信息，存储的结构为ngx_http_limit_req_ctx_t</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   limit_log_level; <span class="comment">// 超过限制时log等级</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   delay_log_level; <span class="comment">// 延迟时log等级</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   status_code; <span class="comment">// 超过限制时的返回码</span></span><br><span class="line">    <span class="keyword">ngx_flag_t</span>                   dry_run; <span class="comment">// 是否为测试运行</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_limit_req_conf_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-ctx-t"><a href="#ngx-http-limit-req-ctx-t" class="headerlink" title="ngx_http_limit_req_ctx_t"></a>ngx_http_limit_req_ctx_t</h4><p>该结构为限制的详细信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_limit_req_shctx_t</span>  *sh; <span class="comment">// 限制对应的红黑树及，对应限制纬度来说，使用红黑树存储来加快查找</span></span><br><span class="line">    <span class="keyword">ngx_slab_pool_t</span>             *shpool; <span class="comment">// slab分配内存的结构</span></span><br><span class="line">    <span class="comment">/* integer value, 1 corresponds to 0.001 r/s */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   rate; <span class="comment">// 限制的速率</span></span><br><span class="line">    <span class="keyword">ngx_http_complex_value_t</span>     key; <span class="comment">// 限制的纬度，例如ip纬度，获取其他纬度，该方法用于结算请求的纬度</span></span><br><span class="line">    <span class="keyword">ngx_http_limit_req_node_t</span>   *node; <span class="comment">// 红黑树节点信息</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_limit_req_ctx_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-shctx-t"><a href="#ngx-http-limit-req-shctx-t" class="headerlink" title="ngx_http_limit_req_shctx_t"></a>ngx_http_limit_req_shctx_t</h4><p>对于限制来说，我们炫耀快速超找到某个限制是否对当前请求是否存在。使用红黑树存储信息来加速查找。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>                  rbtree; <span class="comment">// 红黑树阶段</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>             sentinel; <span class="comment">// 红黑树的哨兵节点</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                   <span class="built_in">queue</span>; <span class="comment">// 按照访问的先后顺序构建的队列，越近的访问在越前面，方便后续进行空间回收</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_limit_req_shctx_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-complex-value-t"><a href="#ngx-http-complex-value-t" class="headerlink" title="ngx_http_complex_value_t"></a>ngx_http_complex_value_t</h4><p>对于限制的纬度来说，允许用户任意进行设置，因此可能是一个复杂的变量值，因此需要一个结构承接对请求中该纬度的计算。结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   value; <span class="comment">// 存储计算出的值</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 *flushes; </span><br><span class="line">    <span class="keyword">void</span>                       *lengths; <span class="comment">// 获取值长度处理函数数组，参考rewrite部分</span></span><br><span class="line">    <span class="keyword">void</span>                       *values; <span class="comment">// 计算值部分处理函数数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">size_t</span>                  size;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125; <span class="keyword">ngx_http_complex_value_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-node-t"><a href="#ngx-http-limit-req-node-t" class="headerlink" title="ngx_http_limit_req_node_t"></a>ngx_http_limit_req_node_t</h4><p>该结构存储限制信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    u_char                       color;  <span class="comment">// 对应红黑树的color</span></span><br><span class="line">    u_char                       dummy;</span><br><span class="line">    u_short                      len; </span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                  <span class="built_in">queue</span>; <span class="comment">// 构成ngx_http_limit_req_shctx_t的队列元素</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                   last; <span class="comment">// 最后一次访问事件</span></span><br><span class="line">    <span class="comment">/* integer value, 1 corresponds to 0.001 r/s */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   excess; <span class="comment">// 超过rate的限制数量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   count; <span class="comment">// 当前对应的key，请求的数量</span></span><br><span class="line">    u_char                       data[<span class="number">1</span>]; <span class="comment">// 对应的key值</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_limit_req_node_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="create-location"><a href="#create-location" class="headerlink" title="create location"></a>create location</h3><p>create location函数为ngx_http_limit_req_create_conf，其执行逻辑为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static void *</span><br><span class="line">ngx_http_limit_req_create_conf(ngx_conf_t *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_limit_req_conf_t  *conf;</span><br><span class="line">    </span><br><span class="line">    // 生成配置</span><br><span class="line">    conf = ngx_pcalloc(cf-&gt;pool, sizeof(ngx_http_limit_req_conf_t));</span><br><span class="line">    if (conf == NULL) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * set by ngx_pcalloc():</span><br><span class="line">     *</span><br><span class="line">     *     conf-&gt;limits.elts = NULL;</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    conf-&gt;limit_log_level = NGX_CONF_UNSET_UINT;</span><br><span class="line">    conf-&gt;status_code = NGX_CONF_UNSET_UINT;</span><br><span class="line">    conf-&gt;dry_run = NGX_CONF_UNSET;</span><br><span class="line"></span><br><span class="line">    return conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="limit-req-zone配置"><a href="#limit-req-zone配置" class="headerlink" title="limit_req_zone配置"></a>limit_req_zone配置</h3><h4 id="语法及含义"><a href="#语法及含义" class="headerlink" title="语法及含义"></a>语法及含义</h4><p>配置语法为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">limit_req_zone</span> key zone=name:size rate=rate [sync];</span><br><span class="line"></span><br><span class="line">context</span><br><span class="line">http</span><br></pre></td></tr></table></figure>
<p>该配置设置一个监控纬度，其中key可以是文本，变量或者联合值，name表示监控的名字，用于在<code>limit_req</code>中使用。size为允许为该监控创建的共享内存大小，rate为每一个key，请求的出现的频率。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</span><br></pre></td></tr></table></figure>
<p>这里的key是请求的二进制地址，这里使用二进制地址而不是<code>remote_addr</code>是为了节省空间考虑的，对于ipv4来说，二进制地址占用4byte空间，对于ipv6来说，二进制地址占用16bytes空间。1M大概能够存储16000个地址信息（这里不止有地址，还包括其状态信息）。</p>
<p>如果区域存储耗尽，则删除最近最少使用的状态。 如果即使在此之后无法创建新状态，请求也会因错误而终止。</p>
<p>速率以每秒请求数 (r/s) 为单位指定。 如果需要每秒小于一个请求的速率，则以每分钟请求数 (r/m) 指定。 例如，每秒半请求为 30r/m。</p>
<p>sync 参数启用共享内存区域的同步。</p>
<h4 id="解析配置方法"><a href="#解析配置方法" class="headerlink" title="解析配置方法"></a>解析配置方法</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_limit_req_zone(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                            *p;</span><br><span class="line">    <span class="keyword">size_t</span>                             len;</span><br><span class="line">    <span class="keyword">ssize_t</span>                            size;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         *value, name, s;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                          rate, scale;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                         i;</span><br><span class="line">    <span class="keyword">ngx_shm_zone_t</span>                    *shm_zone;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>          *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_compile_complex_value_t</span>   ccv;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_limit_req_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化解析复杂变量的结构</span></span><br><span class="line">    ngx_memzero(&amp;ccv, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_compile_complex_value_t</span>));</span><br><span class="line"></span><br><span class="line">    ccv.cf = cf;</span><br><span class="line">    <span class="comment">// 解析第一个值，即指定的key</span></span><br><span class="line">    ccv.value = &amp;value[<span class="number">1</span>];</span><br><span class="line">    ccv.complex_value = &amp;ctx-&gt;key;</span><br><span class="line">    <span class="comment">// 执行解析</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">    rate = <span class="number">1</span>;</span><br><span class="line">    scale = <span class="number">1</span>;</span><br><span class="line">    name.len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历剩下的配置</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; cf-&gt;args-&gt;nelts; i++) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是zone</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strncmp(value[i].data, <span class="string">"zone="</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置name</span></span><br><span class="line">            name.data = value[i].data + <span class="number">5</span>;</span><br><span class="line">            <span class="comment">// 通过:获取name结尾</span></span><br><span class="line">            p = (u_char *) ngx_strchr(name.data, <span class="string">':'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"invalid zone size \"%V\""</span>, &amp;value[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            name.len = p - name.data;</span><br><span class="line">            <span class="comment">// 获取内存大小</span></span><br><span class="line">            s.data = p + <span class="number">1</span>;</span><br><span class="line">            s.len = value[i].data + value[i].len - s.data;</span><br><span class="line">            <span class="comment">// 解析大小</span></span><br><span class="line">            size = ngx_parse_size(&amp;s);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (size == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"invalid zone size \"%V\""</span>, &amp;value[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 过小则报错</span></span><br><span class="line">            <span class="keyword">if</span> (size &lt; (<span class="keyword">ssize_t</span>) (<span class="number">8</span> * ngx_pagesize)) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"zone \"%V\" is too small"</span>, &amp;value[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是速率</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strncmp(value[i].data, <span class="string">"rate="</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取速率值，即纬度（秒/分钟）</span></span><br><span class="line">            len = value[i].len;</span><br><span class="line">            p = value[i].data + len - <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(p, <span class="string">"r/s"</span>, <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                scale = <span class="number">1</span>;</span><br><span class="line">                len -= <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ngx_strncmp(p, <span class="string">"r/m"</span>, <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                scale = <span class="number">60</span>;</span><br><span class="line">                len -= <span class="number">3</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取速率</span></span><br><span class="line">            rate = ngx_atoi(value[i].data + <span class="number">5</span>, len - <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> (rate &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"invalid rate \"%V\""</span>, &amp;value[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid parameter \"%V\""</span>, &amp;value[i]);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name.len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"\"%V\" must have \"zone\" parameter"</span>,</span><br><span class="line">                           &amp;cmd-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算每秒请求数量，由于直接除以60可能导致结果为0，所有这里乘以了1000</span></span><br><span class="line">    ctx-&gt;rate = rate * <span class="number">1000</span> / scale;</span><br><span class="line">    <span class="comment">// 添加分配共享内存的结构到cycle中的shared_memory中，会先检查shared_memory是否已经存在，不存在时将添加一个，并且设置对应的参数</span></span><br><span class="line">    shm_zone = ngx_shared_memory_add(cf, &amp;name, size,</span><br><span class="line">                                     &amp;ngx_http_limit_req_module);</span><br><span class="line">    <span class="keyword">if</span> (shm_zone == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果data已经包含值了，说明在这之前已经存在，则报错</span></span><br><span class="line">    <span class="keyword">if</span> (shm_zone-&gt;data) &#123;</span><br><span class="line">        ctx = shm_zone-&gt;data;</span><br><span class="line"></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"%V \"%V\" is already bound to key \"%V\""</span>,</span><br><span class="line">                           &amp;cmd-&gt;name, &amp;name, &amp;ctx-&gt;key.value);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置创建共享内存的init方法，这将在解析完配置后，在init cycle中执行，可看相关章节</span></span><br><span class="line">    shm_zone-&gt;init = ngx_http_limit_req_init_zone;</span><br><span class="line">    <span class="comment">// 设置data为ngx_http_limit_req_ctx_t结构</span></span><br><span class="line">    shm_zone-&gt;data = ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="共享内存初始化"><a href="#共享内存初始化" class="headerlink" title="共享内存初始化"></a>共享内存初始化</h4><p>在执行该值前，会已经为<code>shm_zone-&gt;shm.addr</code>分配了对应size的内存映射(mmap),，可查看<code>ngx_init_cycle</code>函数（其中的<code>ngx_shm_alloc</code>，会按照shm的size分配大小）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_limit_req_init_zone(<span class="keyword">ngx_shm_zone_t</span> *shm_zone, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>  *octx = data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>  *ctx;</span><br><span class="line"></span><br><span class="line">    ctx = shm_zone-&gt;data;</span><br><span class="line">    <span class="comment">// 先查进行校验</span></span><br><span class="line">    <span class="keyword">if</span> (octx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;key.value.len != octx-&gt;key.value.len</span><br><span class="line">            || ngx_strncmp(ctx-&gt;key.value.data, octx-&gt;key.value.data,</span><br><span class="line">                           ctx-&gt;key.value.len)</span><br><span class="line">               != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, shm_zone-&gt;shm.<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"limit_req \"%V\" uses the \"%V\" key "</span></span><br><span class="line">                          <span class="string">"while previously it used the \"%V\" key"</span>,</span><br><span class="line">                          &amp;shm_zone-&gt;shm.name, &amp;ctx-&gt;key.value,</span><br><span class="line">                          &amp;octx-&gt;key.value);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx-&gt;sh = octx-&gt;sh;</span><br><span class="line">        ctx-&gt;shpool = octx-&gt;shpool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将mmap生成的内存作为这个slab内存结构</span></span><br><span class="line">    ctx-&gt;shpool = (<span class="keyword">ngx_slab_pool_t</span> *) shm_zone-&gt;shm.addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shm_zone-&gt;shm.exists) &#123;</span><br><span class="line">        ctx-&gt;sh = ctx-&gt;shpool-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从slab中分配sh</span></span><br><span class="line">    ctx-&gt;sh = ngx_slab_alloc(ctx-&gt;shpool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_limit_req_shctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;sh == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;shpool-&gt;data = ctx-&gt;sh;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化红黑树，红黑树增加方式较为简单，直接进行比较，不用判断是否存在data一致的节点，因为在增加前会先查找</span></span><br><span class="line">    ngx_rbtree_init(&amp;ctx-&gt;sh-&gt;rbtree, &amp;ctx-&gt;sh-&gt;sentinel,</span><br><span class="line">                    ngx_http_limit_req_rbtree_insert_value);</span><br><span class="line">    <span class="comment">// 初始化队列</span></span><br><span class="line">    ngx_queue_init(&amp;ctx-&gt;sh-&gt;<span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置log信息</span></span><br><span class="line">    len = <span class="keyword">sizeof</span>(<span class="string">" in limit_req zone \"\""</span>) + shm_zone-&gt;shm.name.len;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;shpool-&gt;log_ctx = ngx_slab_alloc(ctx-&gt;shpool, len);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;shpool-&gt;log_ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_sprintf(ctx-&gt;shpool-&gt;log_ctx, <span class="string">" in limit_req zone \"%V\"%Z"</span>,</span><br><span class="line">                &amp;shm_zone-&gt;shm.name);</span><br><span class="line"></span><br><span class="line">    ctx-&gt;shpool-&gt;log_nomem = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="limit-req配置"><a href="#limit-req配置" class="headerlink" title="limit_req配置"></a>limit_req配置</h3><h4 id="语法及含义-1"><a href="#语法及含义-1" class="headerlink" title="语法及含义"></a>语法及含义</h4><p>语法为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">limit_req zone=name [burst=number] [nodelay | delay=number];</span><br><span class="line"></span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<p>设置共享内存区域和请求的最大突发大小。 如果请求速率超过为区域配置的速率，则它们的处理将被延迟，以便以定义的速率处理请求。 过多的请求会被延迟，直到它们的数量超过最大突发大小，在这种情况下，请求会因错误而终止。 默认情况下，最大突发大小为零。 例如，指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location /search/ &#123;</span><br><span class="line">        limit_req zone=one burst=5;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>平均每秒允许不超过 1 个请求，突发不超过 5 个请求。超过5个的请求会直接丢弃。</p>
<p>如果不希望在请求受到限制时延迟过多的请求，则应使用参数 nodelay：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">limit_req zone=one burst=5 nodelay;</span><br></pre></td></tr></table></figure>
<p>delay 参数指定过多请求延迟的限制。 默认值为零，即所有过多的请求都被延迟。只有在设置了burst时才有意义，delay表示超过设置的速率，但没有超过burst的请求中，前k个会被立即处理，超过delay的数量才会被延迟处理。</p>
<p>可能有几个 limit_req 指令。 例如，以下配置将限制来自单个 IP 地址的请求的处理速率，同时限制虚拟服务器的请求处理速率：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;</span><br><span class="line">limit_req_zone $server_name zone=perserver:10m rate=10r/s;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    limit_req zone=perip burst=5 nodelay;</span><br><span class="line">    limit_req zone=perserver burst=10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置解析方法"><a href="#配置解析方法" class="headerlink" title="配置解析方法"></a>配置解析方法</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_limit_req(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_conf_t</span>  *lrcf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                    burst, delay;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   *value, s;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   i;</span><br><span class="line">    <span class="keyword">ngx_shm_zone_t</span>              *shm_zone;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_limit_t</span>  *limit, *limits;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    shm_zone = <span class="literal">NULL</span>;</span><br><span class="line">    burst = <span class="number">0</span>;</span><br><span class="line">    delay = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历参数</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; cf-&gt;args-&gt;nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 获取限制的纬度</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strncmp(value[i].data, <span class="string">"zone="</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            s.len = value[i].len - <span class="number">5</span>;</span><br><span class="line">            s.data = value[i].data + <span class="number">5</span>;</span><br><span class="line">            <span class="comment">// 添加共享内存，这里应该是已经在解析limit_req_zone中已经添加过了，直接返回对应的zone</span></span><br><span class="line">            shm_zone = ngx_shared_memory_add(cf, &amp;s, <span class="number">0</span>,</span><br><span class="line">                                             &amp;ngx_http_limit_req_module);</span><br><span class="line">            <span class="keyword">if</span> (shm_zone == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取突发流量的最大限制</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strncmp(value[i].data, <span class="string">"burst="</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            burst = ngx_atoi(value[i].data + <span class="number">6</span>, value[i].len - <span class="number">6</span>);</span><br><span class="line">            <span class="keyword">if</span> (burst &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"invalid burst value \"%V\""</span>, &amp;value[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取delay数量</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strncmp(value[i].data, <span class="string">"delay="</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            delay = ngx_atoi(value[i].data + <span class="number">6</span>, value[i].len - <span class="number">6</span>);</span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"invalid delay value \"%V\""</span>, &amp;value[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当是nodelay时，delay为无限大，即对所有在burst内的请求都不延迟处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strcmp(value[i].data, <span class="string">"nodelay"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            delay = NGX_MAX_INT_T_VALUE / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid parameter \"%V\""</span>, &amp;value[i]);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shm_zone == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"\"%V\" must have \"zone\" parameter"</span>,</span><br><span class="line">                           &amp;cmd-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在limits中添加一个限制</span></span><br><span class="line">    limits = lrcf-&gt;limits.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (limits == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;lrcf-&gt;limits, cf-&gt;pool, <span class="number">1</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_limit_req_limit_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查看是否已经使用了该限制</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; lrcf-&gt;limits.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shm_zone == limits[i].shm_zone) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    limit = ngx_array_push(&amp;lrcf-&gt;limits);</span><br><span class="line">    <span class="keyword">if</span> (limit == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置信息信息，其中burst和delay都乘以1000，因为rate也乘以了1000</span></span><br><span class="line">    limit-&gt;shm_zone = shm_zone;</span><br><span class="line">    limit-&gt;burst = burst * <span class="number">1000</span>;</span><br><span class="line">    limit-&gt;delay = delay * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><p>剩下的配置较为简单，这里进行简单介绍.</p>
<p><code>limit_req_log_level</code>该配置设置在由于超过burst限制时拒绝服务的log等级。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	limit_req_log_level info | notice | warn | error;</span><br><span class="line">Default:	</span><br><span class="line">limit_req_log_level error;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<p><code>limit_req_status</code>设置拒绝服务时返回的状态码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	limit_req_status code;</span><br><span class="line">Default:	</span><br><span class="line">limit_req_status 503;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<p><code>limit_req_dry_run</code>启用试运行模式。 在这种模式下，请求处理速率不受限制，但是在共享内存区域中，过度请求的数量照常计算。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	limit_req_dry_run on | off;</span><br><span class="line">Default:	</span><br><span class="line">limit_req_dry_run off;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<h3 id="merge-location方法-1"><a href="#merge-location方法-1" class="headerlink" title="merge location方法"></a>merge location方法</h3><p>merge方法较为简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static char *</span><br><span class="line">ngx_http_limit_req_merge_conf(ngx_conf_t *cf, void *parent, void *child)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_limit_req_conf_t *prev = parent;</span><br><span class="line">    ngx_http_limit_req_conf_t *conf = child;</span><br><span class="line"></span><br><span class="line">    if (conf-&gt;limits.elts == NULL) &#123;</span><br><span class="line">        conf-&gt;limits = prev-&gt;limits;</span><br><span class="line">    &#125;</span><br><span class="line">    // merge日志等级</span><br><span class="line">    ngx_conf_merge_uint_value(conf-&gt;limit_log_level, prev-&gt;limit_log_level,</span><br><span class="line">                              NGX_LOG_ERR);</span><br><span class="line"></span><br><span class="line">    conf-&gt;delay_log_level = (conf-&gt;limit_log_level == NGX_LOG_INFO) ?</span><br><span class="line">                                NGX_LOG_INFO : conf-&gt;limit_log_level + 1;</span><br><span class="line">    // merge返回的状态码</span><br><span class="line">    ngx_conf_merge_uint_value(conf-&gt;status_code, prev-&gt;status_code,</span><br><span class="line">                              NGX_HTTP_SERVICE_UNAVAILABLE);</span><br><span class="line">    // merge是否试运行</span><br><span class="line">    ngx_conf_merge_value(conf-&gt;dry_run, prev-&gt;dry_run, 0);</span><br><span class="line"></span><br><span class="line">    return NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="preconfiguration方法"><a href="#preconfiguration方法" class="headerlink" title="preconfiguration方法"></a>preconfiguration方法</h3><p>该方法添加一个变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">static ngx_http_variable_t  ngx_http_limit_req_vars[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;limit_req_status&quot;), NULL,</span><br><span class="line">      ngx_http_limit_req_status_variable, 0, NGX_HTTP_VAR_NOCACHEABLE, 0 &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_http_null_variable</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static ngx_int_t</span><br><span class="line">ngx_http_limit_req_add_variables(ngx_conf_t *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_variable_t  *var, *v;</span><br><span class="line"></span><br><span class="line">    for (v = ngx_http_limit_req_vars; v-&gt;name.len; v++) &#123;</span><br><span class="line">        var = ngx_http_add_variable(cf, &amp;v-&gt;name, v-&gt;flags);</span><br><span class="line">        if (var == NULL) &#123;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var-&gt;get_handler = v-&gt;get_handler;</span><br><span class="line">        var-&gt;data = v-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="postconfiguration方法-1"><a href="#postconfiguration方法-1" class="headerlink" title="postconfiguration方法"></a>postconfiguration方法</h3><p>该方法向<code>NGX_HTTP_PREACCESS_PHASE</code>阶段增加一个处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_limit_req_init(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    h = ngx_array_push(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers);</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *h = ngx_http_limit_req_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="处理函数ngx-http-limit-req-handler"><a href="#处理函数ngx-http-limit-req-handler" class="headerlink" title="处理函数ngx_http_limit_req_handler"></a>处理函数ngx_http_limit_req_handler</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_limit_req_handler(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span>                     hash;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                    key;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                    rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   n, excess;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                   delay;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>    *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_conf_t</span>   *lrcf;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_limit_t</span>  *limit, *limits;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果已经设置了limit_req_status，则执行下一个处理函数</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;main-&gt;limit_req_status) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取location层级的ngx_http_limit_req_limit_t</span></span><br><span class="line">    lrcf = ngx_http_get_module_loc_conf(r, ngx_http_limit_req_module);</span><br><span class="line">    limits = lrcf-&gt;limits.elts;</span><br><span class="line"></span><br><span class="line">    excess = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rc = NGX_DECLINED;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">    limit = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 遍历每一个限制纬度</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; lrcf-&gt;limits.nelts; n++) &#123;</span><br><span class="line">        <span class="comment">// 获取对应的限制纬度ngx_http_limit_req_ctx_t</span></span><br><span class="line">        limit = &amp;limits[n];</span><br><span class="line">        <span class="comment">// 获取限制纬度对应的</span></span><br><span class="line">        ctx = limit-&gt;shm_zone-&gt;data;</span><br><span class="line">        <span class="comment">// 获取请求对应该纬度的key，例如，获取二进制地址</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_complex_value(r, &amp;ctx-&gt;key, &amp;key) != NGX_OK) &#123;</span><br><span class="line">            <span class="comment">// 如果计算key错误，则拒绝请求，并将之前的zone中关于该次请求的记录删除</span></span><br><span class="line">            ngx_http_limit_req_unlock(limits, n);</span><br><span class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// key为0，则跳过</span></span><br><span class="line">        <span class="keyword">if</span> (key.len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// key过长，报错</span></span><br><span class="line">        <span class="keyword">if</span> (key.len &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"the value of the \"%V\" key "</span></span><br><span class="line">                          <span class="string">"is more than 65535 bytes: \"%V\""</span>,</span><br><span class="line">                          &amp;ctx-&gt;key.value, &amp;key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用crc32算法计算hash值</span></span><br><span class="line">        hash = ngx_crc32_short(key.data, key.len);</span><br><span class="line">        <span class="comment">// 将该zone结构整体锁住</span></span><br><span class="line">        ngx_shmtx_lock(&amp;ctx-&gt;shpool-&gt;mutex);</span><br><span class="line">        <span class="comment">// 查到对应的key在红黑树中的位置，如果没有，则新增</span></span><br><span class="line">        rc = ngx_http_limit_req_lookup(limit, hash, &amp;key, &amp;excess,</span><br><span class="line">                                       (n == lrcf-&gt;limits.nelts - <span class="number">1</span>));</span><br><span class="line">        <span class="comment">// 释放锁</span></span><br><span class="line">        ngx_shmtx_unlock(&amp;ctx-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug4(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"limit_req[%ui]: %i %ui.%03ui"</span>,</span><br><span class="line">                       n, rc, excess / <span class="number">1000</span>, excess % <span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 如果返回值不是NGX_AGAIN继续超找，则跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (rc != NGX_AGAIN) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果返回NGX_DECLINED，则执行该阶段下一个处理函数</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果返回NGX_BUSY，超过了最大限制，或者错误</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_BUSY || rc == NGX_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">            ngx_log_error(lrcf-&gt;limit_log_level, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"limiting requests%s, excess: %ui.%03ui by zone \"%V\""</span>,</span><br><span class="line">                        lrcf-&gt;dry_run ? <span class="string">", dry run"</span> : <span class="string">""</span>,</span><br><span class="line">                        excess / <span class="number">1000</span>, excess % <span class="number">1000</span>,</span><br><span class="line">                        &amp;limit-&gt;shm_zone-&gt;shm.name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除计算到的n个zone中关于该请求的值。</span></span><br><span class="line">        ngx_http_limit_req_unlock(limits, n);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lrcf-&gt;dry_run) &#123;</span><br><span class="line">            r-&gt;main-&gt;limit_req_status = NGX_HTTP_LIMIT_REQ_REJECTED_DRY_RUN;</span><br><span class="line">            <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        r-&gt;main-&gt;limit_req_status = NGX_HTTP_LIMIT_REQ_REJECTED;</span><br><span class="line">        <span class="comment">// 返回状态码</span></span><br><span class="line">        <span class="keyword">return</span> lrcf-&gt;status_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_AGAIN || rc == NGX_OK */</span></span><br><span class="line">    <span class="comment">// 如果返回NGX_AGAIN，则设置超过rate的请求数量为0</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">        excess = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算所有纬度下，该请求需要延迟的大小，返回最大值</span></span><br><span class="line">    delay = ngx_http_limit_req_account(limits, n, &amp;excess, &amp;limit);</span><br><span class="line">    <span class="comment">// 如果不需要延迟，则直接执行下一阶段</span></span><br><span class="line">    <span class="keyword">if</span> (!delay) &#123;</span><br><span class="line">        r-&gt;main-&gt;limit_req_status = NGX_HTTP_LIMIT_REQ_PASSED;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(lrcf-&gt;delay_log_level, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"delaying request%s, excess: %ui.%03ui, by zone \"%V\""</span>,</span><br><span class="line">                  lrcf-&gt;dry_run ? <span class="string">", dry run"</span> : <span class="string">""</span>,</span><br><span class="line">                  excess / <span class="number">1000</span>, excess % <span class="number">1000</span>, &amp;limit-&gt;shm_zone-&gt;shm.name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lrcf-&gt;dry_run) &#123;</span><br><span class="line">        r-&gt;main-&gt;limit_req_status = NGX_HTTP_LIMIT_REQ_DELAYED_DRY_RUN;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置为请求被delayed</span></span><br><span class="line">    r-&gt;main-&gt;limit_req_status = NGX_HTTP_LIMIT_REQ_DELAYED;</span><br><span class="line">    <span class="comment">// 由于请求被delay，所以客户端可能会关闭请求，设置对应的事件处理函数，将read事件添加到epoll中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(r-&gt;connection-&gt;read, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置请求对应的读写事件</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_test_reading;</span><br><span class="line">    r-&gt;write_event_handler = ngx_http_limit_req_delay;</span><br><span class="line">    <span class="comment">// 设置写事件被delayed中</span></span><br><span class="line">    r-&gt;connection-&gt;write-&gt;delayed = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 条件写事件到事件红黑树中</span></span><br><span class="line">    ngx_add_timer(r-&gt;connection-&gt;write, delay);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-complex-value计算请求在该zone的key"><a href="#ngx-http-complex-value计算请求在该zone的key" class="headerlink" title="ngx_http_complex_value计算请求在该zone的key"></a>ngx_http_complex_value计算请求在该zone的key</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_complex_value(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_complex_value_t</span> *val,</span><br><span class="line">    <span class="keyword">ngx_str_t</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                        len;</span><br><span class="line">    ngx_http_script_code_pt       code;</span><br><span class="line">    ngx_http_script_len_code_pt   lcode;</span><br><span class="line">    <span class="keyword">ngx_http_script_engine_t</span>      e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (val-&gt;lengths == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *value = val-&gt;value;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_script_flush_complex_value(r, val);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;e, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_engine_t</span>));</span><br><span class="line">    <span class="comment">// 遍历lengths获取key长度</span></span><br><span class="line">    e.ip = val-&gt;lengths;</span><br><span class="line">    e.request = r;</span><br><span class="line">    e.flushed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*(<span class="keyword">uintptr_t</span> *) e.ip) &#123;</span><br><span class="line">        lcode = *(ngx_http_script_len_code_pt *) e.ip;</span><br><span class="line">        len += lcode(&amp;e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value-&gt;len = len;</span><br><span class="line">    value-&gt;data = ngx_pnalloc(r-&gt;pool, len);</span><br><span class="line">    <span class="keyword">if</span> (value-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历values获取值</span></span><br><span class="line">    e.ip = val-&gt;values;</span><br><span class="line">    e.pos = value-&gt;data;</span><br><span class="line">    e.buf = *value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*(<span class="keyword">uintptr_t</span> *) e.ip) &#123;</span><br><span class="line">        code = *(ngx_http_script_code_pt *) e.ip;</span><br><span class="line">        code((<span class="keyword">ngx_http_script_engine_t</span> *) &amp;e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *value = e.buf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-unlock删除当前请求在前n个zone中的记录"><a href="#ngx-http-limit-req-unlock删除当前请求在前n个zone中的记录" class="headerlink" title="ngx_http_limit_req_unlock删除当前请求在前n个zone中的记录"></a>ngx_http_limit_req_unlock删除当前请求在前n个zone中的记录</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_limit_req_unlock(<span class="keyword">ngx_http_limit_req_limit_t</span> *limits, <span class="keyword">ngx_uint_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>  *ctx;</span><br><span class="line">    <span class="comment">// 遍历前n个zone</span></span><br><span class="line">    <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">        ctx = limits[n].shm_zone-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取锁</span></span><br><span class="line">        ngx_shmtx_lock(&amp;ctx-&gt;shpool-&gt;mutex);</span><br><span class="line">        <span class="comment">// 将该节点中count减去1</span></span><br><span class="line">        ctx-&gt;node-&gt;count--;</span><br><span class="line">        <span class="comment">// 释放锁</span></span><br><span class="line">        ngx_shmtx_unlock(&amp;ctx-&gt;shpool-&gt;mutex);</span><br><span class="line">        <span class="comment">// 设置当前为查询到节点</span></span><br><span class="line">        ctx-&gt;node = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-lookup查找节点"><a href="#ngx-http-limit-req-lookup查找节点" class="headerlink" title="ngx_http_limit_req_lookup查找节点"></a>ngx_http_limit_req_lookup查找节点</h4><p>该函数赋值查找节点，如果不存在，则新建节点。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">hash为计算出的hash值</span></span><br><span class="line"><span class="comment">key实际值</span></span><br><span class="line"><span class="comment">ep为超过zone限制的rate大小，account为是否是最后一个zone</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_limit_req_lookup(<span class="keyword">ngx_http_limit_req_limit_t</span> *limit, <span class="keyword">ngx_uint_t</span> hash,</span><br><span class="line">    <span class="keyword">ngx_str_t</span> *key, <span class="keyword">ngx_uint_t</span> *ep, <span class="keyword">ngx_uint_t</span> account)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                      size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc, excess;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                  now;</span><br><span class="line">    <span class="keyword">ngx_msec_int_t</span>              ms;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>          *node, *sentinel;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>   *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_node_t</span>  *lr;</span><br><span class="line">    <span class="comment">// 获取当前时间</span></span><br><span class="line">    now = ngx_current_msec;</span><br><span class="line"></span><br><span class="line">    ctx = limit-&gt;shm_zone-&gt;data;</span><br><span class="line">    <span class="comment">// 获取红黑树根节点</span></span><br><span class="line">    node = ctx-&gt;sh-&gt;rbtree.root;</span><br><span class="line">    <span class="comment">// 获取红黑树哨兵节点</span></span><br><span class="line">    sentinel = ctx-&gt;sh-&gt;rbtree.sentinel;</span><br><span class="line">    <span class="comment">// 红黑树超找</span></span><br><span class="line">    <span class="keyword">while</span> (node != sentinel) &#123;</span><br><span class="line">        <span class="comment">// 找左子树</span></span><br><span class="line">        <span class="keyword">if</span> (hash &lt; node-&gt;key) &#123;</span><br><span class="line">            node = node-&gt;left;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找右子树</span></span><br><span class="line">        <span class="keyword">if</span> (hash &gt; node-&gt;key) &#123;</span><br><span class="line">            node = node-&gt;right;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* hash == node-&gt;key */</span></span><br><span class="line">        <span class="comment">// 获取实际节点值</span></span><br><span class="line">        lr = (<span class="keyword">ngx_http_limit_req_node_t</span> *) &amp;node-&gt;color;</span><br><span class="line">        <span class="comment">// 计算是否key一致</span></span><br><span class="line">        rc = ngx_memn2cmp(key-&gt;data, lr-&gt;data, key-&gt;len, (<span class="keyword">size_t</span>) lr-&gt;len);</span><br><span class="line">        <span class="comment">// key一致的处理</span></span><br><span class="line">        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 先从队列移出</span></span><br><span class="line">            ngx_queue_remove(&amp;lr-&gt;<span class="built_in">queue</span>);</span><br><span class="line">            <span class="comment">// 再将节点加入队列头部，表示最近访问</span></span><br><span class="line">            ngx_queue_insert_head(&amp;ctx-&gt;sh-&gt;<span class="built_in">queue</span>, &amp;lr-&gt;<span class="built_in">queue</span>);</span><br><span class="line">            <span class="comment">// 计算时间差，这里的last为上次该key对应的请求的时间戳</span></span><br><span class="line">            ms = (<span class="keyword">ngx_msec_int_t</span>) (now - lr-&gt;last);</span><br><span class="line">            <span class="comment">// 如果差值小于1分钟，记录为1毫秒，这里未负值的原因是，多进程情况下可能别的进程在该进程之前获取到了该zone下该key的另一个请求的锁。一般情况下都应该是正数</span></span><br><span class="line">            <span class="keyword">if</span> (ms &lt; <span class="number">-60000</span>) &#123;</span><br><span class="line">                ms = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 如果二者差值小于1分钟，则任务两个请求同时到达，即不存在时间差</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ms &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ms = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 计算当前这个请求到了，导致该zone下该key超过限制rate的请求数量</span></span><br><span class="line">            excess = lr-&gt;excess - ctx-&gt;rate * ms / <span class="number">1000</span> + <span class="number">1000</span>;</span><br><span class="line">            <span class="comment">// 如果未超过，则是0</span></span><br><span class="line">            <span class="keyword">if</span> (excess &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                excess = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            *ep = excess;</span><br><span class="line">            <span class="comment">// 如果超出的数量已经超过了允许突发请求的最大值，则返回busy，拒绝请求</span></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">ngx_uint_t</span>) excess &gt; limit-&gt;burst) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            如果是最后一个zone，则设置其超过限制rate的数量，并且如果ms大于0，则设置最后一次请求达到事件，返回ok</span></span><br><span class="line"><span class="comment">            这里需要注意的是，为啥只有最后一个请求进行设置，并且没有将count++。</span></span><br><span class="line"><span class="comment">            首先看为啥最后一个请求设置了excess，这是因为在之后超找最大延迟时间时，有一个基准，即以最后一个zone需要延时的时间作为基准，来查看在最后一个zone之前的超时时间是否有超过该值的，并设置最大值作为请求的实际需要的延迟事件。</span></span><br><span class="line"><span class="comment">            再来看为啥不对count++：这是因为，请求速率限制其实是使用excess计算是否超限的，因此计算完成excess后就不需要关注实际count数量了，该值仅会用来作为空间回收时的参考，即该值不为0，表示对应的key上存在请求，不能进行空间回收，但对于最后一个zone来说，所有的cunt都是0，不存在该问题，并且这里已经完成了excess的计算，因此不必再进行+1的操作，后续计算前面zone的excess时也可以看出来，再完成了excess的计算后，就会将count--。</span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">            <span class="keyword">if</span> (account) &#123;</span><br><span class="line">                lr-&gt;excess = excess;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ms) &#123;</span><br><span class="line">                    lr-&gt;last = now;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 非最后一个zone，对count++</span></span><br><span class="line">            lr-&gt;count++;</span><br><span class="line"></span><br><span class="line">            ctx-&gt;node = lr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果对比key不一致，则继续查找左/右子树</span></span><br><span class="line">        node = (rc &lt; <span class="number">0</span>) ? node-&gt;left : node-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有超找到，则新增一个节点</span></span><br><span class="line">    *ep = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 计算占用空间大小</span></span><br><span class="line">    size = offsetof(<span class="keyword">ngx_rbtree_node_t</span>, color)</span><br><span class="line">           + offsetof(<span class="keyword">ngx_http_limit_req_node_t</span>, data)</span><br><span class="line">           + key-&gt;len;</span><br><span class="line">    <span class="comment">// 从队列中释放空闲空间</span></span><br><span class="line">    ngx_http_limit_req_expire(ctx, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 使用slab分配一个siez大小空间</span></span><br><span class="line">    node = ngx_slab_alloc_locked(ctx-&gt;shpool, size);</span><br><span class="line">    <span class="comment">// 如果返回为空，表示空间使用完全</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 强制是否空间</span></span><br><span class="line">        ngx_http_limit_req_expire(ctx, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 分配空间</span></span><br><span class="line">        node = ngx_slab_alloc_locked(ctx-&gt;shpool, size);</span><br><span class="line">        <span class="comment">// 如果依然没有空间，则返回错误</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"could not allocate node%s"</span>, ctx-&gt;shpool-&gt;log_ctx);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置key</span></span><br><span class="line">    node-&gt;key = hash;</span><br><span class="line">    <span class="comment">// 设置color为对应数据</span></span><br><span class="line">    lr = (<span class="keyword">ngx_http_limit_req_node_t</span> *) &amp;node-&gt;color;</span><br><span class="line">    <span class="comment">// 设置key长度</span></span><br><span class="line">    lr-&gt;len = (u_short) key-&gt;len;</span><br><span class="line">    <span class="comment">// 设置超限请求数量为0</span></span><br><span class="line">    lr-&gt;excess = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(lr-&gt;data, key-&gt;data, key-&gt;len);</span><br><span class="line">    <span class="comment">// 条件进入红黑树中</span></span><br><span class="line">    ngx_rbtree_insert(&amp;ctx-&gt;sh-&gt;rbtree, node);</span><br><span class="line">    <span class="comment">// 条件到队列头部</span></span><br><span class="line">    ngx_queue_insert_head(&amp;ctx-&gt;sh-&gt;<span class="built_in">queue</span>, &amp;lr-&gt;<span class="built_in">queue</span>);</span><br><span class="line">    <span class="comment">// 如果是最后一个，则设置事件和count，这里count不为1和上面的原因一致</span></span><br><span class="line">    <span class="keyword">if</span> (account) &#123;</span><br><span class="line">        lr-&gt;last = now;</span><br><span class="line">        lr-&gt;count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lr-&gt;last = <span class="number">0</span>;</span><br><span class="line">    lr-&gt;count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;node = lr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要专门介绍一个超过限制的计算，即代理的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">excess = lr-&gt;excess - ctx-&gt;rate * ms / 1000 + 1000;</span><br></pre></td></tr></table></figure>
<p>首先计算是累加的，即计算时使用节点之前的<code>lr-&gt;excess</code>进行累加，由于超额请求可能是负数，当是负数时，设置的excess为0。</p>
<p>后面的先看<code>ctx-&gt;rate * ms/ 1000</code>，其中<code>ctx-&gt;rate</code>为1000<em>允许速率（即 <code>k r/s</code>，每秒k个请求），<code>ms/1000</code>为距离上次请求的秒数，因此`ctx-&gt;rate </em> ms / 1000<code>为对应上次请求与该次请求的这段时间，允许的最大请求数量（再乘以1000），而这段时间的实际到底的请求数量为1个请求（这里为了和前面的1000平衡，因此后面也是1000），因此超过允许请求速率的请求数量为</code>1000- ctx-&gt;rate * ms / 1000`。这样便计算出了超过请求速率的请求数量（乘以1000）。</p>
<h4 id="ngx-http-limit-req-expire释放空闲空间"><a href="#ngx-http-limit-req-expire释放空闲空间" class="headerlink" title="ngx_http_limit_req_expire释放空闲空间"></a>ngx_http_limit_req_expire释放空闲空间</h4><p>该函数对长时间无请求的节点空间进行释放：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这里n=1表示删除一个或两个请求速率为0的节点</span></span><br><span class="line"><span class="comment">n=0表示强制删除一个最旧未访问的节点和一个或两个请求速率为0的节点</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_limit_req_expire(<span class="keyword">ngx_http_limit_req_ctx_t</span> *ctx, <span class="keyword">ngx_uint_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   excess;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                  now;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q;</span><br><span class="line">    <span class="keyword">ngx_msec_int_t</span>              ms;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>          *node;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_node_t</span>  *lr;</span><br><span class="line"></span><br><span class="line">    now = ngx_current_msec;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * n == 1 deletes one or two zero rate entries</span></span><br><span class="line"><span class="comment">     * n == 0 deletes oldest entry by force</span></span><br><span class="line"><span class="comment">     *        and one or two zero rate entries</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (n &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果队列为空，则直接返回。</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_queue_empty(&amp;ctx-&gt;sh-&gt;<span class="built_in">queue</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从队列中取出一个最老未服务的节点</span></span><br><span class="line">        q = ngx_queue_last(&amp;ctx-&gt;sh-&gt;<span class="built_in">queue</span>);</span><br><span class="line">        <span class="comment">// 获取节点对应的信息</span></span><br><span class="line">        lr = ngx_queue_data(q, <span class="keyword">ngx_http_limit_req_node_t</span>, <span class="built_in">queue</span>);</span><br><span class="line">        <span class="comment">// 如果最老的节点上还有正在访问的请求，则直接返回，不需要再进行查看了</span></span><br><span class="line">        <span class="keyword">if</span> (lr-&gt;count) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * There is not much sense in looking further,</span></span><br><span class="line"><span class="comment">             * because we bump nodes on the lookup stage.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将n增加</span></span><br><span class="line">        <span class="keyword">if</span> (n++ != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取当前时间与该节点最后一个请求的时间差值</span></span><br><span class="line">            ms = (<span class="keyword">ngx_msec_int_t</span>) (now - lr-&gt;last);</span><br><span class="line">            ms = ngx_abs(ms);</span><br><span class="line">            <span class="comment">// 如果查找小于1分钟，则也直接返回，即最旧的节点也很新，因此没有可以直接删除的节点</span></span><br><span class="line">            <span class="keyword">if</span> (ms &lt; <span class="number">60000</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 计算该节点超过限制速率的请求数量，这里后面未加1，表示这段时间，没有请求到达</span></span><br><span class="line">            excess = lr-&gt;excess - ctx-&gt;rate * ms / <span class="number">1000</span>;</span><br><span class="line">            <span class="comment">// 如果过去了ms毫秒后，该节点未收到请求但依然存在超限的请求，则直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (excess &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果节点足够旧，并且请求数量未超限，则直接删除节点</span></span><br><span class="line">        ngx_queue_remove(q);</span><br><span class="line"></span><br><span class="line">        node = (<span class="keyword">ngx_rbtree_node_t</span> *)</span><br><span class="line">                   ((u_char *) lr - offsetof(<span class="keyword">ngx_rbtree_node_t</span>, color));</span><br><span class="line">        <span class="comment">// 从红黑树中删除</span></span><br><span class="line">        ngx_rbtree_delete(&amp;ctx-&gt;sh-&gt;rbtree, node);</span><br><span class="line">        <span class="comment">// 释放节点空间</span></span><br><span class="line">        ngx_slab_free_locked(ctx-&gt;shpool, node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-account获取最大延迟处理时间"><a href="#ngx-http-limit-req-account获取最大延迟处理时间" class="headerlink" title="ngx_http_limit_req_account获取最大延迟处理时间"></a>ngx_http_limit_req_account获取最大延迟处理时间</h4><p>该函数遍历所有限制zone，判断是否需要对请求进行延迟处理，并获取延迟时间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">n为限制数量</span></span><br><span class="line"><span class="comment">ep为最后一个限制超过rate的请求数量</span></span><br><span class="line"><span class="comment">limit为最后一个限制结构</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_msec_t</span></span><br><span class="line">ngx_http_limit_req_account(<span class="keyword">ngx_http_limit_req_limit_t</span> *limits, <span class="keyword">ngx_uint_t</span> n,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> *ep, <span class="keyword">ngx_http_limit_req_limit_t</span> **limit)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   excess;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                  now, delay, max_delay;</span><br><span class="line">    <span class="keyword">ngx_msec_int_t</span>              ms;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_ctx_t</span>   *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_limit_req_node_t</span>  *lr;</span><br><span class="line"></span><br><span class="line">    excess = *ep;</span><br><span class="line">    <span class="comment">//验证请求是否超过最后一个限制zone设置的delay数量，并根据该值设置延时时间（如果未超过设置的delay数量，则不需要延迟）</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">ngx_uint_t</span>) excess &lt;= (*limit)-&gt;delay) &#123;</span><br><span class="line">        max_delay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx = (*limit)-&gt;shm_zone-&gt;data;</span><br><span class="line">        <span class="comment">//延迟时间设置</span></span><br><span class="line">        max_delay = (excess - (*limit)-&gt;delay) * <span class="number">1000</span> / ctx-&gt;rate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//遍历每一个限制</span></span><br><span class="line">    <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">        ctx = limits[n].shm_zone-&gt;data;</span><br><span class="line">        lr = ctx-&gt;node;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取限制的锁</span></span><br><span class="line">        ngx_shmtx_lock(&amp;ctx-&gt;shpool-&gt;mutex);</span><br><span class="line">        <span class="comment">//计算本次请求与上次请求的时间间隔</span></span><br><span class="line">        now = ngx_current_msec;</span><br><span class="line">        ms = (<span class="keyword">ngx_msec_int_t</span>) (now - lr-&gt;last);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ms &lt; <span class="number">-60000</span>) &#123;</span><br><span class="line">            ms = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ms &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ms = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//计算超过rate的请求数量</span></span><br><span class="line">        excess = lr-&gt;excess - ctx-&gt;rate * ms / <span class="number">1000</span> + <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (excess &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            excess = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ms) &#123;</span><br><span class="line">            lr-&gt;last = now;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置请求超过数量，并将请求数量减1</span></span><br><span class="line">        lr-&gt;excess = excess;</span><br><span class="line">        lr-&gt;count--;</span><br><span class="line">        <span class="comment">//释放锁</span></span><br><span class="line">        ngx_shmtx_unlock(&amp;ctx-&gt;shpool-&gt;mutex);</span><br><span class="line">        </span><br><span class="line">        ctx-&gt;node = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">//验证请求是否超过限制zone设置的delay数量，并根据该值设置延时时间（如果未超过设置的delay数量，则不需要延迟）</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">ngx_uint_t</span>) excess &lt;= limits[n].delay) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果超过delay限制，计算需要的延迟时间</span></span><br><span class="line">        delay = (excess - limits[n].delay) * <span class="number">1000</span> / ctx-&gt;rate;</span><br><span class="line">        <span class="comment">//更新max_delay</span></span><br><span class="line">        <span class="keyword">if</span> (delay &gt; max_delay) &#123;</span><br><span class="line">            max_delay = delay;</span><br><span class="line">            *ep = excess;</span><br><span class="line">            *limit = &amp;limits[n];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回需要的最大延迟时间</span></span><br><span class="line">    <span class="keyword">return</span> max_delay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里着重介绍一下请求延迟时间的计算：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delay = (excess - limits[n].delay) * 1000 / ctx-&gt;rate;</span><br></pre></td></tr></table></figure>
<p>其中excess为请求超过rate的数量，<code>excess - limits[n].delay</code>是请求超过delay限制的数量，可类比为距离，<code>ctx-&gt;rate</code>为请求限制速度，相除即得延迟时间，这里乘以1000，是因为ngix时间维度以毫秒为单位。</p>
<h4 id="ngx-http-test-reading延迟处理期间读事件处理"><a href="#ngx-http-test-reading延迟处理期间读事件处理" class="headerlink" title="ngx_http_test_reading延迟处理期间读事件处理"></a>ngx_http_test_reading延迟处理期间读事件处理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_test_reading(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                n;</span><br><span class="line">    <span class="keyword">char</span>               buf[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">ngx_err_t</span>          err;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>       *rev;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"http test reading"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line">   ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ngx_event_flags &amp; NGX_USE_EPOLL_EVENT) &amp;&amp; ngx_use_epoll_rdhup) &#123;</span><br><span class="line">        <span class="keyword">socklen_t</span>  len;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!rev-&gt;pending_eof) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rev-&gt;eof = <span class="number">1</span>;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">        len = <span class="keyword">sizeof</span>(<span class="keyword">ngx_err_t</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * BSDs and Linux return 0 and set a pending error in err</span></span><br><span class="line"><span class="comment">         * Solaris returns -1 and sets errno</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(c-&gt;fd, SOL_SOCKET, SO_ERROR, (<span class="keyword">void</span> *) &amp;err, &amp;len)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> closed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 从套接字中读取数据</span></span><br><span class="line">    n = recv(c-&gt;fd, buf, <span class="number">1</span>, MSG_PEEK);</span><br><span class="line">    <span class="comment">//如果获取数据为0，表示客户端已关闭，如果是-1，表示出错</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        rev-&gt;eof = <span class="number">1</span>;</span><br><span class="line">        c-&gt;error = <span class="number">1</span>;</span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> closed;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != NGX_EAGAIN) &#123;</span><br><span class="line">            rev-&gt;eof = <span class="number">1</span>;</span><br><span class="line">            c-&gt;error = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> closed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* aio does not call this handler */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ngx_event_flags &amp; NGX_USE_LEVEL_EVENT) &amp;&amp; rev-&gt;active) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_del_event(rev, NGX_READ_EVENT, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_close_request(r, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">closed:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        rev-&gt;error = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;ssl) &#123;</span><br><span class="line">        c-&gt;ssl-&gt;no_send_shutdown = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                  <span class="string">"client prematurely closed connection"</span>);</span><br><span class="line"></span><br><span class="line">    ngx_http_finalize_request(r, NGX_HTTP_CLIENT_CLOSED_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-limit-req-delay请求延时期间写事件处理"><a href="#ngx-http-limit-req-delay请求延时期间写事件处理" class="headerlink" title="ngx_http_limit_req_delay请求延时期间写事件处理"></a>ngx_http_limit_req_delay请求延时期间写事件处理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_limit_req_delay(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>  *wev;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"limit_req delay"</span>);</span><br><span class="line"></span><br><span class="line">    wev = r-&gt;connection-&gt;write;</span><br><span class="line">    <span class="comment">//如果写事件处于delay状态，将写事件加入epoll事件驱动模块中</span></span><br><span class="line">    <span class="keyword">if</span> (wev-&gt;delayed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_write_event(wev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将读事件加入epoll事件驱动模块中</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(r-&gt;connection-&gt;read, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置请求读写事件为继续执行剩余模块</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_block_reading;</span><br><span class="line">    r-&gt;write_event_handler = ngx_http_core_run_phases;</span><br><span class="line"></span><br><span class="line">    ngx_http_core_run_phases(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要参考<code>ngx_http_request_handler</code>处理函数，即写事件触发的处理函数。在写事件被触发时，仅有delayed是1，并且timeout为1时才会将delayed置为0。因此写事件同时被加入的事件红黑树中了，这时，在红黑树超时之前，epoll触发的写事件都不会设置请求为继续向下执行，在红黑树中的事件超时时，写事件的delayed将被设置为0，这时请求将会被向下继续执行，以此来达到限制请求处理的速率。</p>
<p>至此完成了<code>ngx_http_limit_req_module</code>模块的详细介绍。</p>
<h2 id="ngx-http-limit-conn-module模块"><a href="#ngx-http-limit-conn-module模块" class="headerlink" title="ngx_http_limit_conn_module模块"></a>ngx_http_limit_conn_module模块</h2><p>除了上述的模块限速以外，还有<code>ngx_http_limit_conn_module</code>限速模块，这里不详细对该模块的原理进行介绍。注意讲一下相关配置和大概的实现原理。ngx_http_limit_conn_module 模块用于限制每个定义的键的连接数，特别是来自单个 IP 地址的连接数。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="limit-conn-zone配置"><a href="#limit-conn-zone配置" class="headerlink" title="limit_conn_zone配置"></a>limit_conn_zone配置</h4><p>该配置与<code>limit_req_zone</code>配置类似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	limit_conn_zone key zone=name:size;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>
<p>设置限制纬度，和为限制分配的共享内存大小。</p>
<h4 id="limit-conn"><a href="#limit-conn" class="headerlink" title="limit_conn"></a>limit_conn</h4><p>限制纬度下，最大允许的连接数量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	limit_conn zone number;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>与<code>ngx_http_limit_req_module</code>模块类似，使用共享内存加锁来实现计数，不过区别是，一个请求会将记录的数组增加1，并注册一个cleanup函数，在结束请求时将计数减1，当减到0时就会清除该记录。</p>
<h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><p>在读取配置项的时候，会对变量进行初始化，包括nginx提供的内置变量和用户配置文件中的变量。</p>
<h2 id="相关结构-9"><a href="#相关结构-9" class="headerlink" title="相关结构"></a>相关结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数分别为请求r，表示变量值的v，以及一个可能使用到的参数data。</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_http_set_variable_pt)</span> <span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_get_variable_pt)</span> <span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_variable_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// 变量名</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                     name;   <span class="comment">/* must be first to build the hash */</span></span><br><span class="line">    <span class="comment">// 如果需要变量最初赋值时就进行变量值的设置，需要实现set_handler方法。内部变量允许在配置中以set的方式重新设置值时，可以实现该方法。</span></span><br><span class="line">    ngx_http_set_variable_pt      set_handler;</span><br><span class="line">    <span class="comment">// 获取变量值方法。nginx官方模块变量解析大都使用该方法。</span></span><br><span class="line">    ngx_http_get_variable_pt      get_handler;</span><br><span class="line">    <span class="comment">// 作为参数传递给get_handler，set_handler方法</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                     data;</span><br><span class="line">    <span class="comment">// 变量特性</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    flags;</span><br><span class="line">    <span class="comment">// 变量值在请求的缓存数组中索引</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    index;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 变量值是一段连续内存中的字符串，len表示长度</span></span><br><span class="line">    <span class="keyword">unsigned</span>    len:<span class="number">28</span>;</span><br><span class="line">    <span class="comment">// valid表示变量已解析过，数据可用</span></span><br><span class="line">    <span class="keyword">unsigned</span>    valid:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// no_cacheable为1表示变量值不可被缓存，和ngx_http_variable_s中的flag相关</span></span><br><span class="line">    <span class="keyword">unsigned</span>    no_cacheable:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// no_cacheable为1表示变量值解析过，但未找到相应的值</span></span><br><span class="line">    <span class="keyword">unsigned</span>    not_found:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// ngx_http_log_module模块使用，用于日志格式字符转义，其他模块忽略该字段</span></span><br><span class="line">    <span class="keyword">unsigned</span>    escape:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// data指向变量值起始地址</span></span><br><span class="line">    u_char     *data;</span><br><span class="line">&#125; <span class="keyword">ngx_variable_value_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_variable_s中的flag相关取值是如下值的1按位与：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_HTTP_VAR_CHANGEABLE   1</code></td>
<td>表示变量值可变，即对同一个请求来说，变量可以被反复修改其值。因此以上定义同一变量名与修改变量等价。</td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_NOCACHEABLE  2</code></td>
<td>不能缓存改变量的值，每次使用变量时都需要重新解析。有些请求的变量会在执行中随着url跳转等动作反复改变。如$uri，如果取上次缓存值，是无法知道是否正确的。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_NOHASH       8</code></td>
<td>不要将该变量hash到散列表。散列表需要消耗空间，如果某个模块设计了一个可选变量提供给其他模块使用，并且要求有其他模块使用该变量时必须索引化再使用（即不能调用ngx_http_get_variable方法获取），这样，这个变量就不用浪费散列表的空间了。</td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_WEAK         16</code></td>
<td>弱变量，对于set设置的变量都是弱变量，如果该变量是前缀变量，则会使用前缀变量的get_handler解析方法。</td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_PREFIX       32</code></td>
<td>前缀变量，如args_、cookie_、http_等，一般是nginx内置的一系列变量。</td>
</tr>
</tbody>
</table>
</div>
<h3 id="存储变量名的数据结构"><a href="#存储变量名的数据结构" class="headerlink" title="存储变量名的数据结构"></a>存储变量名的数据结构</h3><p>变量被存储在main级别下的ngx_http_core_main_conf_t中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    ngx_hash_t                 variables_hash; // 存储hash过的变量</span><br><span class="line"></span><br><span class="line">    ngx_array_t                variables;         /* ngx_http_variable_t */ // 存储索引过的变量。通过索引获取</span><br><span class="line">    ngx_array_t                prefix_variables;  /* ngx_http_variable_t */ // 前缀变量存储</span><br><span class="line"></span><br><span class="line">    ngx_hash_keys_arrays_t    *variables_keys;   // 构建过程中临时存储，用于方便构建hash表的，hash管理结构，用于构建variables_hash</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125; ngx_http_core_main_conf_t;</span><br></pre></td></tr></table></figure>
<p>对于一个变量，可能存在于多个结构中，即variables_hash或variables或prefix_variables中。这时一个变量可能存在多份ngx_http_variable_t结构，但是需要保证，每个的都要要相等的。保证相等的操作在ngx_http_variables_init_vars方法中完成。具体见下文。</p>
<h2 id="解析变量"><a href="#解析变量" class="headerlink" title="解析变量"></a>解析变量</h2><p>解析变量使用get_handler方法，其原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_get_variable_pt)</span> <span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中r和data是用来帮助生成变量值，而v是存放值的载体。结构体v已经分配好内存（调用get_handler的函数负责），分配好的内存不包括字符串变量值。可以使用请求r的内存池来分配新的内存放置变量值，这样请求结束，内存就被释放。参数v的data和len成员指向变量值字符串即完成解析。对于data参数来说，存在多种场景。</p>
<h3 id="data参数不起作用"><a href="#data参数不起作用" class="headerlink" title="data参数不起作用"></a>data参数不起作用</h3><p>如果只是生成一些和用户请求无关的变量值，例如时间、系统负载，那么使用各种方法获得变量后赋值给参数v的data和len即可。或者ngx_http_request_t *r中成员已经足够解析出变量值了，data参数不用也可以。</p>
<p>例如，HTTP架构提供的一个变量body_bytes_sent,表示一个请求的响应包体长度，常用在日志中，其解析方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_variable_t</span>  ngx_http_core_variables[] = &#123; </span><br><span class="line">    ...</span><br><span class="line">    &#123; ngx_string(<span class="string">"body_bytes_sent"</span>), <span class="literal">NULL</span>, ngx_http_variable_body_bytes_sent,</span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_body_bytes_sent(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">off_t</span>    sent;</span><br><span class="line">    u_char  *p;</span><br><span class="line">    <span class="comment">// 大小直接通过r就能获取到，不需要data，因此请求是data为0</span></span><br><span class="line">    sent = r-&gt;connection-&gt;sent - r-&gt;header_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        sent = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = ngx_pnalloc(r-&gt;pool, NGX_OFF_T_LEN);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;len = ngx_sprintf(p, <span class="string">"%O"</span>, sent) - p;</span><br><span class="line">    v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">    v-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">    v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">    v-&gt;data = p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="data参数作为指针"><a href="#data参数作为指针" class="headerlink" title="data参数作为指针"></a>data参数作为指针</h3><p>uintptr_t是一个可以放置指针的整型，所以，uintptr_t被设计为即可以用来做整型偏移，也可以做指针。</p>
<p>对于5类前缀字符串，如http_、args_等，实际每个这样的变量其解析方式都大同小异，遍历解析出来的r-&gt;headers_in.headers或者r-&gt;headers_in.headers数组，找到变量名再返回其值。为了设计更加通用，就使用data作为指针指向实际的变量名字符串。如下，当出现如http_这样的变量被模块使用时，就把data作为指针来保存实际的变量名字符串v[i].name（ngx_http_variables_init_vars初始化特殊变量时的代码段）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_strncmp(src[i].key.data, <span class="string">"HTTP_"</span>, <span class="keyword">sizeof</span>(<span class="string">"HTTP_"</span>) - <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    v[i].get_hander = ngx_http_variable_unknown_header_in;</span><br><span class="line">    v[i].data = (<span class="keyword">uintptr_t</span>)&amp;v[i].name;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>解析变量的方法get_hander将data转换为ngx_str_t*</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_unknown_header_in(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ngx_http_variable_unknown_header(v, (<span class="keyword">ngx_str_t</span> *) data,</span><br><span class="line">                                            &amp;r-&gt;headers_in.headers.part,</span><br><span class="line">                                            <span class="keyword">sizeof</span>(<span class="string">"http_"</span>) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ngx_http_variable_unknown_header遍历ngx_list_t链表类型的headers数组，找到符合变量名的头部后，将其值作为变量返回。</p>
<h3 id="data作为内存的相对偏移量"><a href="#data作为内存的相对偏移量" class="headerlink" title="data作为内存的相对偏移量"></a>data作为内存的相对偏移量</h3><p>很多时候，变量值很可能是原始HTTP字符流中的一部分连续字符串，如果能够复用，就不用再为变量分配，拷贝内存了。而且HTTP模块在使用get_handler时，HTTP框架可能在请求的自动解析过程中已经得到了需要的变量值。这就是data参数作为整数设计的目的。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;http_host&quot;), NULL, ngx_http_variable_header,</span><br><span class="line">      offsetof(ngx_http_request_t, headers_in.host), 0, 0 &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;http_user_agent&quot;), NULL, ngx_http_variable_header,</span><br><span class="line">      offsetof(ngx_http_request_t, headers_in.user_agent), 0, 0 &#125;,</span><br></pre></td></tr></table></figure>
<p>http_host变量对应于ngx_http_request_t结构体里的headers_in成员的host成员，http_user_agent变量对应ngx_http_request_t结构体里的headers_in成员的user_agent成员。对应的处理函数为ngx_http_variable_header：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_header(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_variable_value_t</span> *v,</span><br><span class="line">    <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>  *h;</span><br><span class="line">    <span class="comment">// 找到对应的内存地址</span></span><br><span class="line">    h = *(<span class="keyword">ngx_table_elt_t</span> **) ((<span class="keyword">char</span> *) r + data);</span><br><span class="line">    <span class="comment">// 赋值</span></span><br><span class="line">    <span class="keyword">if</span> (h) &#123;</span><br><span class="line">        v-&gt;len = h-&gt;value.len;</span><br><span class="line">        v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">        v-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">        v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">        v-&gt;data = h-&gt;value.data;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v-&gt;not_found = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查找变量"><a href="#查找变量" class="headerlink" title="查找变量"></a>查找变量</h2><h3 id="ngx-http-get-variable-index"><a href="#ngx-http-get-variable-index" class="headerlink" title="ngx_http_get_variable_index"></a>ngx_http_get_variable_index</h3><p>设置变量被索引，并获得索引号，这是使用ngx_http_get_indexed_variable、ngx_http_get_flushed_variable方法的前置条件。调用它意味着这个变量会被频繁的使用，希望Nginx处理这个变量时效率更加高，体现在：</p>
<ol>
<li>变量值可以被缓存，重复读取时不用每次都解析。</li>
<li>定义变量的解析方法时，可以通过索引直接查找到该方法进行解析，而不是通过操作散列表。</li>
<li>nginx在初始化http请求时，就需要为这个变量预分配好ngx_http_variable_value_t变量结构体。</li>
</ol>
<p>函数执行逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_get_variable_index(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid variable name \"$\""</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取main级别下的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line">    <span class="comment">// 在variables查找是否存在，如果还没有variables，则分配空间</span></span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;variables, cf-&gt;pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果查找到相同的变量（不区分大小写），则返回当前已经存在的变量的索引</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;variables.nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name-&gt;len != v[i].name.len</span><br><span class="line">                || ngx_strncasecmp(name-&gt;data, v[i].name.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果为查找到相同的变量，添加到variables，返回对于的索引。</span></span><br><span class="line">    v = ngx_array_push(&amp;cmcf-&gt;variables);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;name.len = name-&gt;len;</span><br><span class="line">    v-&gt;name.data = ngx_pnalloc(cf-&gt;pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (v-&gt;name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_strlow(v-&gt;name.data, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    v-&gt;set_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;get_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;data = <span class="number">0</span>;</span><br><span class="line">    v-&gt;flags = <span class="number">0</span>;</span><br><span class="line">    v-&gt;index = cmcf-&gt;variables.nelts - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v-&gt;index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-get-indexed-variable"><a href="#ngx-http-get-indexed-variable" class="headerlink" title="ngx_http_get_indexed_variable"></a>ngx_http_get_indexed_variable</h3><p>根据ngx_http_get_variable_index得到的索引号，获取被索引过的变量的值。若变量被解析过一次后，其值会被缓存，这样该方法再次调用会直接获取缓存过的值，而不是重新解析。该方法忽略NGX_HTTP_VAR_NOCACHEABLE标识。</p>
<p>其方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span> *</span><br><span class="line">ngx_http_get_indexed_variable(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_uint_t</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取这次请求分配的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmcf-&gt;variables.nelts &lt;= index) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"unknown variable index: %ui"</span>, index);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 变量被解析过，无论是否查找到值，都直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;variables[index].not_found || r-&gt;variables[index].valid) &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;r-&gt;variables[index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 防止循环死链，使用ngx_http_variable_depth记录，起始100</span></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_variable_depth == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cycle while evaluating variable \"%V\""</span>,</span><br><span class="line">                      &amp;v[index].name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_variable_depth--;</span><br><span class="line">    <span class="comment">// 执行变量的解析函数成功</span></span><br><span class="line">    <span class="keyword">if</span> (v[index].get_handler(r, &amp;r-&gt;variables[index], v[index].data)</span><br><span class="line">        == NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_http_variable_depth++;</span><br><span class="line">        <span class="comment">// 如果变量是不允许缓存，则增加标志</span></span><br><span class="line">        <span class="keyword">if</span> (v[index].flags &amp; NGX_HTTP_VAR_NOCACHEABLE) &#123;</span><br><span class="line">            r-&gt;variables[index].no_cacheable = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回数据</span></span><br><span class="line">        <span class="keyword">return</span> &amp;r-&gt;variables[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_variable_depth++;</span><br><span class="line">    <span class="comment">// 解析未查找数据，记录状态</span></span><br><span class="line">    r-&gt;variables[index].valid = <span class="number">0</span>;</span><br><span class="line">    r-&gt;variables[index].not_found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-get-flushed-variable"><a href="#ngx-http-get-flushed-variable" class="headerlink" title="ngx_http_get_flushed_variable"></a>ngx_http_get_flushed_variable</h3><p>该方法与ngx_http_get_indexed_variable类似，不过其不忽略NGX_HTTP_VAR_NOCACHEABLE标识。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span> *</span><br><span class="line">ngx_http_get_flushed_variable(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_uint_t</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *v;</span><br><span class="line"></span><br><span class="line">    v = &amp;r-&gt;variables[index];</span><br><span class="line">    <span class="comment">// 如果变量被解析过</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;valid || v-&gt;not_found) &#123;</span><br><span class="line">        <span class="comment">// 如果变量可以被缓存，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!v-&gt;no_cacheable) &#123;</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则，表示变量未被解析过</span></span><br><span class="line">        v-&gt;valid = <span class="number">0</span>;</span><br><span class="line">        v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行解析</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_get_indexed_variable(r, index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-get-value"><a href="#ngx-http-get-value" class="headerlink" title="ngx_http_get_value"></a>ngx_http_get_value</h3><p>根据变量名称，从hash过的散列表中找到对应的变量，并调用其解析方法，获得值，这里不存在缓存变量值的可能。同时前缀变量也可以从该方法中获取解析值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span> *</span><br><span class="line">ngx_http_get_variable(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_str_t</span> *name, <span class="keyword">ngx_uint_t</span> key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *vv;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 在散列表中查找对于的变量</span></span><br><span class="line">    v = ngx_hash_find(&amp;cmcf-&gt;variables_hash, key, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v) &#123;</span><br><span class="line">        <span class="comment">// 如果变量被找到，并且已经被索引，则优先使用索引列表里面的值</span></span><br><span class="line">        <span class="keyword">if</span> (v-&gt;flags &amp; NGX_HTTP_VAR_INDEXED) &#123;</span><br><span class="line">            <span class="keyword">return</span> ngx_http_get_flushed_variable(r, v-&gt;index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_variable_depth == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"cycle while evaluating variable \"%V\""</span>, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_variable_depth--;</span><br><span class="line"></span><br><span class="line">        vv = ngx_palloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_value_t</span>));</span><br><span class="line">        <span class="comment">// 调用变量的解析方法</span></span><br><span class="line">        <span class="keyword">if</span> (vv &amp;&amp; v-&gt;get_handler(r, vv, v-&gt;data) == NGX_OK) &#123;</span><br><span class="line">            ngx_http_variable_depth++;</span><br><span class="line">            <span class="keyword">return</span> vv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_variable_depth++;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vv = ngx_palloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_value_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (vv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 在前缀变量中查找</span></span><br><span class="line">    v = cmcf-&gt;prefix_variables.elts;</span><br><span class="line">    n = cmcf-&gt;prefix_variables.nelts;</span><br><span class="line">    <span class="comment">// 找到最长匹配的一个变量（这里只有5个http_,arg_,cookie_,sent_trailer_,sent_http_）</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;prefix_variables.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len &gt;= v[i].name.len &amp;&amp; name-&gt;len &gt; len</span><br><span class="line">            &amp;&amp; ngx_strncmp(name-&gt;data, v[i].name.data, v[i].name.len) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            len = v[i].name.len;</span><br><span class="line">            n = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用对应的解析方法</span></span><br><span class="line">    <span class="keyword">if</span> (n != cmcf-&gt;prefix_variables.nelts) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v[n].get_handler(r, vv, (<span class="keyword">uintptr_t</span>) name) == NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> vv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未查到</span></span><br><span class="line">    vv-&gt;not_found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="添加系统变量"><a href="#添加系统变量" class="headerlink" title="添加系统变量"></a>添加系统变量</h2><p>内部变量会在系统初始化是定义。赋值是在需要使用该变量时才赋值，而不是请求到达后就优先赋值。查找变量的方式为根据索引找到系统中相应的变量或者通过hash表来进行查找。</p>
<p>系统变量定义都是在执行模块的<code>proconfiguration</code>阶段。该方法添加变量到main级别创建的ngx_http_core_main_conf_t的variables_keys（散列表）或prefix_variables（数组）中。例如，对于核心模块ngx_http_core_module对应的方法ngx_http_core_preconfiguration：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_preconfiguration(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ngx_http_variables_add_core_vars(cf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variables_add_core_vars(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *cv, *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取main级别创建的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 分配variables_keys内存</span></span><br><span class="line">    cmcf-&gt;variables_keys = ngx_pcalloc(cf-&gt;temp_pool,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_keys_arrays_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (cmcf-&gt;variables_keys == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;variables_keys-&gt;pool = cf-&gt;pool;</span><br><span class="line">    cmcf-&gt;variables_keys-&gt;temp_pool = cf-&gt;pool;</span><br><span class="line">    <span class="comment">// 初始化散列表管理结构ngx_hash_keys_arrays_t</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_keys_array_init(cmcf-&gt;variables_keys, NGX_HASH_SMALL)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化前缀变量的列表</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;prefix_variables, cf-&gt;pool, <span class="number">8</span>,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每一个nginx预设的系统变量，将其添加到对应的结构中（前缀列表或者散列表管理结构）.ngx_http_core_variables包含了大量nginx预设变量，如http_host、http_cookie、cookie_</span></span><br><span class="line">    <span class="keyword">for</span> (cv = ngx_http_core_variables; cv-&gt;name.len; cv++) &#123;</span><br><span class="line">        v = ngx_http_add_variable(cf, &amp;cv-&gt;name, cv-&gt;flags);</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *v = *cv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//部分ngx_http_core_variables</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_variable_t</span>  ngx_http_core_variables[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http_host"</span>), <span class="literal">NULL</span>, ngx_http_variable_header,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, headers_in.host), <span class="number">0</span>, <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http_user_agent"</span>), <span class="literal">NULL</span>, ngx_http_variable_header,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, headers_in.user_agent), <span class="number">0</span>, <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http_referer"</span>), <span class="literal">NULL</span>, ngx_http_variable_header,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, headers_in.referer), <span class="number">0</span>, <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-add-variable"><a href="#ngx-http-add-variable" class="headerlink" title="ngx_http_add_variable"></a>ngx_http_add_variable</h3><p>其中ngx_http_add_variable函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_t</span> *</span><br><span class="line">ngx_http_add_variable(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *name, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// name为变量名称，flags为ngx_http_variable_s中的flag。返回值为已经准备好的ngx_http_variable_t。这时需要在返回值在添加解析方法set/get_handler,h和data。</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>             *key;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid variable name \"$\""</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是前缀变量，则使用ngx_http_add_prefix_variable添加</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_HTTP_VAR_PREFIX) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_add_prefix_variable(cf, name, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    key = cmcf-&gt;variables_keys-&gt;keys.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;variables_keys-&gt;keys.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len != key[i].key.len</span><br><span class="line">            || ngx_strncasecmp(name-&gt;data, key[i].key.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v = key[i].value;</span><br><span class="line">        <span class="comment">// 如果变量是不可变更的，并且现在已经存在该变量，即出现重复添加，则报错</span></span><br><span class="line">        <span class="keyword">if</span> (!(v-&gt;flags &amp; NGX_HTTP_VAR_CHANGEABLE)) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"the duplicate \"%V\" variable"</span>, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; NGX_HTTP_VAR_WEAK)) &#123;</span><br><span class="line">            v-&gt;flags &amp;= ~NGX_HTTP_VAR_WEAK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配空间，赋值</span></span><br><span class="line">    v = ngx_palloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;name.len = name-&gt;len;</span><br><span class="line">    v-&gt;name.data = ngx_pnalloc(cf-&gt;pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (v-&gt;name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用小写存储变量名</span></span><br><span class="line">    ngx_strlow(v-&gt;name.data, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    v-&gt;set_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;get_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;data = <span class="number">0</span>;</span><br><span class="line">    v-&gt;flags = flags;</span><br><span class="line">    v-&gt;index = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 将变量添加到variables_keys散列表中,散列表添加元素见上文,这里添加的变量是不带通配符的变量，这里增加的变量也不允许重复</span></span><br><span class="line">    rc = ngx_hash_add_key(cmcf-&gt;variables_keys, &amp;v-&gt;name, v, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"conflicting variable name \"%V\""</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_add_prefix_variable如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_variable_t</span> *</span><br><span class="line">ngx_http_add_prefix_variable(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *name, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    v = cmcf-&gt;prefix_variables.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;prefix_variables.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len != v[i].name.len</span><br><span class="line">            || ngx_strncasecmp(name-&gt;data, v[i].name.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v = &amp;v[i];</span><br><span class="line">        <span class="comment">// 对于已定义过的，并且为不可变的变量，重复定义报错</span></span><br><span class="line">        <span class="keyword">if</span> (!(v-&gt;flags &amp; NGX_HTTP_VAR_CHANGEABLE)) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"the duplicate \"%V\" variable"</span>, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; NGX_HTTP_VAR_WEAK)) &#123;</span><br><span class="line">            v-&gt;flags &amp;= ~NGX_HTTP_VAR_WEAK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加到表中（这时可能一个变量在表中有两个元素）</span></span><br><span class="line">    v = ngx_array_push(&amp;cmcf-&gt;prefix_variables);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;name.len = name-&gt;len;</span><br><span class="line">    v-&gt;name.data = ngx_pnalloc(cf-&gt;pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (v-&gt;name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_strlow(v-&gt;name.data, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    v-&gt;set_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;get_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;data = <span class="number">0</span>;</span><br><span class="line">    v-&gt;flags = flags;</span><br><span class="line">    v-&gt;index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上可以看出，只有前缀并且设置可以变更的变量，可以重复添加。</p>
<h2 id="外部变量和脚本引擎"><a href="#外部变量和脚本引擎" class="headerlink" title="外部变量和脚本引擎"></a>外部变量和脚本引擎</h2><p>出了上文提到的使用模块的<code>preconfiguration</code>方法来添加变量以外，还可以使用ngx_http_rewrite_moduel模块提供的set配置。其使用了Nginx的脚本引擎。</p>
<p>变量名称在nginx.conf的配置文件里声明，且在配置文件中确定了变量的赋值。模块定义外部变量的格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set $variable value</span><br></pre></td></tr></table></figure>
<p>配置通过set关键字定义了一个在nginx.conf中指定的新变量variable，并将其赋值为value。value可以是一个文本字符串，还可以包含多个变量，也可以是变量与文本字符串的组合。</p>
<h3 id="相关数据结构-4"><a href="#相关数据结构-4" class="headerlink" title="相关数据结构"></a>相关数据结构</h3><p>同一段脚本被编译进nginx中，在不同请求中执行效果是不一样的，所以每个请求都必须有其独特的脚本执行上下文，或者称为脚本引擎。这由ngx_http_script_engine_t类充当：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 执行待执行的脚本指令</span></span><br><span class="line">    u_char                     *ip;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    u_char                     *pos;</span><br><span class="line">    <span class="comment">// 变量构成的栈</span></span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *sp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   buf;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   line;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the start of the rewritten arguments */</span></span><br><span class="line">    u_char                     *args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                    flushed:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    skip:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    quote:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    is_args:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    <span class="built_in">log</span>:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 脚本执行状态</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   status;</span><br><span class="line">    <span class="comment">// 执行当前脚本引擎所属的HTTP请求</span></span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>         *request;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_engine_t</span>;</span><br></pre></td></tr></table></figure>
<p>sp是一个栈，作为编译工具。大小默认为10.</p>
<p>ip可以理解为IP寄存器，指向下一行将要执行的代码。对于u_char*类型来说，其指向类型是不定的。其指向的一定是待执行的脚本指令。用面向对象的语言来说，其指向的是实现了ngx_http_script_code_pt接口的类。但C语言没有接口的概念，在C语言实现上述目的，通常会使用嵌套结构体的方法，比如表示接口的结构体A，要放在表示实现接口的类-结构体B的第一个位置。这样一个指向B的指针，也可以强制转换为A，再调用A的成员。ngx_http_script_code_pt是一个指针函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*ngx_http_script_code_pt) (ngx_http_script_engine_t *e);</span><br></pre></td></tr></table></figure>
<p>ngx_http_script_code_pt参数ngx_http_script_engine_t，其表示当前指令的脚本上下文。</p>
<p>ngx_http_script_code_pt相当于抽象基类的一个接口，会有相应的结构体担当类的角色。对于”set”配置来说，编译变量名（即第一个参数）由一个实现了ngx_http_script_code_pt接口的类担当，这个类为ngx_http_script_var_code_t：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 本例中指向方法为ngx_http_script_set_var_code</span></span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    <span class="comment">// 表示ngx_http_request_t中被索引、缓存的变量数组值variables中，当前解析的、set设置的外部变量是在的索引</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   index;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_var_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>第一个成员是ngx_http_script_code_pt，因此可以把ngx_http_script_var_code_t强制转换为ngx_http_script_code_pt执行。</p>
<p>set的第2个参数是变量值，其也需要一个结构体ngx_http_script_value_code_t来编译，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 本例中执行的方法为ngx_http_script_value_code</span></span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    <span class="comment">// 若外部变量是整数，则转换为整数赋值给value，否则value为0</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   value;</span><br><span class="line">    <span class="comment">// 外部变量值（set的第二个参数）长度</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   text_len;</span><br><span class="line">    <span class="comment">// 外部变量值的起始地址</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   text_data;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_value_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>为何一行set脚本分别由编译变量名、编译变量值的2个结构来表示呢。因为对于set有很多不同的使用场景，对变量名来说，就存在变量名首次出现与非首次出现，而变量值有纯文字、字符串与其他变量组合等情况。把变量名的编译提取为ngx_http_script_var_code_t结构体，使所以变量名的编译可以复用其index成员，而具体的ngx_http_script_code_pt指令则可以各组实现。把变量值的编译提取为ngx_http_script_value_code_t结构体，则可以复用text_len、text_data成员。</p>
<p>ngx_http_script_engine_t随着HTTP请求到来才创建，所以其无法保存Nginx启动时就编译出的脚本。保存编译后的脚本工作由ngx_http_rewrite_loc_conf_t结构承担。其是ngx_http_rewrite_module_ctx模块在location级别的配置结构体。其定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 保存所属location下的所有编译后的脚本（按照顺序）</span><br><span class="line">    ngx_array_t  *codes;        /* uintptr_t */</span><br><span class="line">    // 每一个请求的ngx_http_script_engine_t脚本引擎中都有一个变量值栈，即上文的ngx_http_script_engine_t的sp，其大小为stack_size</span><br><span class="line">    ngx_uint_t    stack_size;</span><br><span class="line"></span><br><span class="line">    ngx_flag_t    log;</span><br><span class="line">    ngx_flag_t    uninitialized_variable_warn;</span><br><span class="line">&#125; ngx_http_rewrite_loc_conf_t;</span><br></pre></td></tr></table></figure>
<p>如果location下没有脚本式配置，那么其成员codes数组就是空的，否则codes数组会放置承载者被解析后的脚本指令的结构体。</p>
<p>codes数组设置比较独特。脚本指令都是实现了”接口ngx_http_script_code_pt”的各个不同的充当类的结构体，这些结构体可以是ngx_http_script_var_code_t、ngx_http_script_value_code_t等，其类型不同，占用的内存也不同，如何放入一个数组中呢（不是它们的指针）。通过如下三点做到：</p>
<ol>
<li><p>codes数组设计每个元素仅占用1字节大小，即不奢望一个数组元素能够存放表示一个脚本指令的结构体。</p>
</li>
<li><p>每次要将1个指令放入codes数组中时，将根据指令结构体的占用内存字节数N，在codes数组中分配N个元素存储这1个指令，再依次把指令结构体的内容都拷贝到这N个数组成员中。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_http_script_start_code(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_array_t</span> **codes, <span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (*codes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *codes = ngx_array_create(pool, <span class="number">256</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (*codes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_array_push_n(*codes, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HTTP请求到来，脚本指令执行时，每执行完一个脚本指令的ngx_http_script_code_pt方法后，该方法必须主动告知所属指令结构体占用的内存数N，这样从当前指令所在codes数组索引加上N后就是下一条指令。</p>
</li>
</ol>
<p>下图展示了两个请求到来时，解析外部变量的流程：</p>
<p><a href="https://imgtu.com/i/WzSSNq" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/08/01/WzSSNq.png" alt="WzSSNq.png"></a></p>
<p>图中以<code>set $variable value</code>作为例子，脚本由右向左解析为ngx_http_script_value_code_t,ngx_http_script_var_code_t。</p>
<p>两个http请求（A和B）同时执行到该脚本，其中A请求正准备执行value指令的ngx_http_script_value_code_t，而B请求已经执行完值的入栈，正要执行ngx_http_script_var_code_t。ngx_http_script_engine_t脚本引擎的sp成员始终指向变量值正要操作的值，而ip成员则始终指向将要执行的下一条指令结构体。</p>
<h3 id="编译set脚本"><a href="#编译set脚本" class="headerlink" title="编译set脚本"></a>编译set脚本</h3><p>编译流程如下：</p>
<p><img src="/Users/wangyinkui/Library/Application Support/typora-user-images/image-20210801153020166.png" alt="image-20210801153020166"></p>
<p>执行流程为：</p>
<p><a href="https://imgtu.com/i/fFttns" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/08/03/fFttns.png" alt="fFttns.png"></a></p>
<p>set在ngx_http_rewrite_module模块的配置如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"set"</span>),</span><br><span class="line">  NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                   |NGX_CONF_TAKE2,</span><br><span class="line">  ngx_http_rewrite_set,</span><br><span class="line">  NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_rewrite_set函数逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_rewrite_set(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span>  *lcf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                            index;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                           *value;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>                 *v;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>          *vcode;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_handler_code_t</span>  *vhcode;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 判断第一个参数第一个字符是否为$</span></span><br><span class="line">    <span class="keyword">if</span> (value[<span class="number">1</span>].data[<span class="number">0</span>] != <span class="string">'$'</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid variable name \"%V\""</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去除$字符</span></span><br><span class="line">    value[<span class="number">1</span>].len--;</span><br><span class="line">    value[<span class="number">1</span>].data++;</span><br><span class="line">    <span class="comment">// 将变量添加到variable_keys中</span></span><br><span class="line">    v = ngx_http_add_variable(cf, &amp;value[<span class="number">1</span>],</span><br><span class="line">                              NGX_HTTP_VAR_CHANGEABLE|NGX_HTTP_VAR_WEAK);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将变量索引化，返回变量索引的下标</span></span><br><span class="line">    index = ngx_http_get_variable_index(cf, &amp;value[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (index == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果get_handler为空，就重新设置变量的get_handler函数</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;get_handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        v-&gt;get_handler = ngx_http_rewrite_var;</span><br><span class="line">        v-&gt;data = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理变量值</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_rewrite_value(cf, lcf, &amp;value[<span class="number">2</span>]) != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果变量存在set_handler函数，则设置对应的ngx_http_script_var_handler_code_t来对变量赋值</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;set_handler) &#123;</span><br><span class="line">        vhcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                   <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_handler_code_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (vhcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vhcode-&gt;code = ngx_http_script_var_set_handler_code;</span><br><span class="line">        vhcode-&gt;handler = v-&gt;set_handler;</span><br><span class="line">        <span class="comment">// 这里的data是set设置后的data，而非原始的data。</span></span><br><span class="line">        vhcode-&gt;data = v-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果变量没有设置set_handler函数，则使用ngx_http_script_var_code_t结构对变量赋值</span></span><br><span class="line">    vcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (vcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vcode-&gt;code = ngx_http_script_set_var_code;</span><br><span class="line">    vcode-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第四步中，内部变量的get_handler方法是必须实现的，因此通常都是采用惰性求值，即只有读取到这个变量时才会调用get_handler计算出这个值。然而外部变量是不同的。每一次set都会立即给变量重新赋值，同时读取变量时，因为变量值被索引化的，所有可以直接从请求的variables数组里取到set后的值。这样get_handler似乎是没有用的。然而，可能有某些模块会在set脚本执行前就使用外部变量了，此时外部变量的值是不存在的，即缓存的variables数组里变量是空的。因此这里将get_handler定义为ngx_http_rewrite_var，其功能就是在调用时将变量设置为空值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span>  ngx_http_variable_null_value =</span><br><span class="line">    ngx_http_variable(<span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<p>对于处理变量值，即value[2]较为复杂。首先定义了两个新的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                 *cf; <span class="comment">// 配置</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  *source; <span class="comment">// 需要compile的字符串</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               **flushes; <span class="comment">// 该结构也用于正则匹配，该成员，构建为变量为$1,$2...这种时，存储每个变量对应于哪一个，构成一个数组</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               **lengths; <span class="comment">//处理变量长度的处理子数组，需要执行ngx_http_script_code_pt构成的列表,这里是生成值时执行ngx_http_script_code_pt的列表</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               **values; <span class="comment">// 处理变量内容的处理子数组，对应于rewrite模块的locations层级下的codes执行数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  variables; <span class="comment">// 值中含有变量的数量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  ncaptures; <span class="comment">// 当前处理时，出现的$n变量的最大值，如配置的最大为$3，那么ncaptures就等于3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 以位移的形式保存$1,$2...$9等变量，即响应位置上置1来表示，主要的作用是为dup_capture准备，</span></span><br><span class="line"><span class="comment">     * 正是由于这个mask的存在，才比较容易得到是否有重复的$n出现。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  captures_mask;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * ngx_http_script_regex_code_t的结构</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span>                       *main;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                    compile_args:<span class="number">1</span>; <span class="comment">// 是否需要处理请求参数</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    complete_lengths:<span class="number">1</span>; <span class="comment">// 是否设置lengths数组的终止符，即NULL</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    complete_values:<span class="number">1</span>; <span class="comment">// 是否设置values数组的终止符</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    zero:<span class="number">1</span>; <span class="comment">// values数组运行时，得到的字符串是否追加'\0'结尾</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    conf_prefix:<span class="number">1</span>; <span class="comment">// 是否在生成的文件名前，追加路径前缀</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    root_prefix:<span class="number">1</span>; <span class="comment">// 同conf_prefix</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 这个标记位主要在rewrite模块里使用，在ngx_http_rewrite中，</span></span><br><span class="line"><span class="comment">     * if (sc.variables == 0 &amp;&amp; !sc.dup_capture) &#123;</span></span><br><span class="line"><span class="comment">     *     regex-&gt;lengths = NULL;</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     * 没有重复的$n，那么regex-&gt;lengths被置为NULL，这个设置很关键，在函数</span></span><br><span class="line"><span class="comment">     * ngx_http_script_regex_start_code中就是通过对regex-&gt;lengths的判断，来做不同的处理，</span></span><br><span class="line"><span class="comment">     * 因为在没有重复的$n的时候，可以通过正则自身的captures机制来获取$n，一旦出现重复的，</span></span><br><span class="line"><span class="comment">     * 那么pcre正则自身的captures并不能满足我们的要求，我们需要用自己handler来处理。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    dup_capture:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    args:<span class="number">1</span>; <span class="comment">// 待compile的字符串中是否发现了'?'</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_script_compile_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 *flushes;</span><br><span class="line">    <span class="keyword">void</span>                       *lengths; <span class="comment">// 需要执行ngx_http_script_code_pt构成的列表,这里是生成值时执行ngx_http_script_code_pt的列表</span></span><br><span class="line">    <span class="keyword">void</span>                       *values;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">size_t</span>                  size;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125; <span class="keyword">ngx_http_complex_value_t</span>;</span><br></pre></td></tr></table></figure>
<p>具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_rewrite_value(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_rewrite_loc_conf_t</span> *lcf,</span><br><span class="line">    <span class="keyword">ngx_str_t</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                              n;</span><br><span class="line">    <span class="keyword">ngx_http_script_compile_t</span>              sc;</span><br><span class="line">    <span class="keyword">ngx_http_script_value_code_t</span>          *val;</span><br><span class="line">    <span class="keyword">ngx_http_script_complex_value_code_t</span>  *<span class="keyword">complex</span>;</span><br><span class="line">    <span class="comment">// 根据$数量计算其中含有多少个变量</span></span><br><span class="line">    n = ngx_http_script_variables_count(value);</span><br><span class="line">    <span class="comment">// 如果是纯文本，则只需要增加ngx_http_script_value_code_t处理方法即可</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        val = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                         <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_value_code_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 尝试转换为整数</span></span><br><span class="line">        n = ngx_atoi(value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">            n = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        val-&gt;code = ngx_http_script_value_code;</span><br><span class="line">        val-&gt;value = (<span class="keyword">uintptr_t</span>) n;</span><br><span class="line">        val-&gt;text_len = (<span class="keyword">uintptr_t</span>) value-&gt;len;</span><br><span class="line">        val-&gt;text_data = (<span class="keyword">uintptr_t</span>) value-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果值中存在变量，则需要使用ngx_http_script_complex_value_code_t结构来承接</span></span><br><span class="line">    <span class="keyword">complex</span> = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_complex_value_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">complex</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其方法为ngx_http_script_complex_value_code</span></span><br><span class="line">    <span class="keyword">complex</span>-&gt;code = ngx_http_script_complex_value_code;</span><br><span class="line">    <span class="keyword">complex</span>-&gt;lengths = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;sc, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_compile_t</span>));</span><br><span class="line"></span><br><span class="line">    sc.cf = cf;</span><br><span class="line">    sc.source = value;</span><br><span class="line">    sc.lengths = &amp;<span class="keyword">complex</span>-&gt;lengths;</span><br><span class="line">    sc.values = &amp;lcf-&gt;codes;</span><br><span class="line">    sc.variables = n;</span><br><span class="line">    sc.complete_lengths = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 使用ngx_http_script_compile_t构建ngx_http_script_complex_value_code_t的lengths参数</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_script_compile(&amp;sc) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_compile函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_compile(<span class="keyword">ngx_http_script_compile_t</span> *sc)</span><br><span class="line">&#123;</span><br><span class="line">    u_char       ch;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>    name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, bracket;</span><br><span class="line">    <span class="comment">// 初始化sc中的各个数组</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_script_init_arrays(sc) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历需要进行编码的字符串</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sc-&gt;source-&gt;len; <span class="comment">/* void */</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        name.len = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 找到变量</span></span><br><span class="line">        <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'$'</span>) &#123;</span><br><span class="line">            <span class="comment">// $是结尾，说明表达式错误</span></span><br><span class="line">            <span class="keyword">if</span> (++i == sc-&gt;source-&gt;len) &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是$后面跟着数字，即$1,$2这种，则如下处理</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] &gt;= <span class="string">'1'</span> &amp;&amp; sc-&gt;source-&gt;data[i] &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">                <span class="keyword">ngx_uint_t</span>  n;</span><br><span class="line">                <span class="comment">// 获取变量值</span></span><br><span class="line">                n = sc-&gt;source-&gt;data[i] - <span class="string">'0'</span>;</span><br><span class="line">                <span class="comment">// 使用captures_mask查看是否当前变量被使用过</span></span><br><span class="line">                <span class="keyword">if</span> (sc-&gt;captures_mask &amp; ((<span class="keyword">ngx_uint_t</span>) <span class="number">1</span> &lt;&lt; n)) &#123;</span><br><span class="line">                    <span class="comment">// 存在重复使用的变量时，dup_capture置1</span></span><br><span class="line">                    sc-&gt;dup_capture = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 记录被使用的变量</span></span><br><span class="line">                sc-&gt;captures_mask |= (<span class="keyword">ngx_uint_t</span>) <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">                <span class="comment">// 添加对应的处理逻辑</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_script_add_capture_code(sc, n) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                i++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"using variable \"$%c\" requires "</span></span><br><span class="line">                                   <span class="string">"PCRE library"</span>, sc-&gt;source-&gt;data[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果变量后跟着&#123;的处理</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                <span class="comment">// 记录查找到左括号，需要一个右括号</span></span><br><span class="line">                bracket = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 同样，如果&#123;是末尾，则报错</span></span><br><span class="line">                <span class="keyword">if</span> (++i == sc-&gt;source-&gt;len) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bracket = <span class="number">0</span>;</span><br><span class="line">                name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 查找到当前变量的全名</span></span><br><span class="line">            <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; i &lt; sc-&gt;source-&gt;len; i++, name.len++) &#123;</span><br><span class="line">                ch = sc-&gt;source-&gt;data[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#125;'</span> &amp;&amp; bracket) &#123;</span><br><span class="line">                    i++;</span><br><span class="line">                    bracket = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>)</span><br><span class="line">                    || (ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>)</span><br><span class="line">                    || (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>)</span><br><span class="line">                    || ch == <span class="string">'_'</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果未找到又括号，则报错</span></span><br><span class="line">            <span class="keyword">if</span> (bracket) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"the closing bracket in \"%V\" "</span></span><br><span class="line">                                   <span class="string">"variable is missing"</span>, &amp;name);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 变量长度为0报错</span></span><br><span class="line">            <span class="keyword">if</span> (name.len == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 记录增加一个变量</span></span><br><span class="line">            sc-&gt;variables++;</span><br><span class="line">            <span class="comment">// 增加解析时对应的处理逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_script_add_var_code(sc, &amp;name) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果查找到了?,并且需要解析请求参数，则执行如下处理</span></span><br><span class="line">        <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'?'</span> &amp;&amp; sc-&gt;compile_args) &#123;</span><br><span class="line">            sc-&gt;args = <span class="number">1</span>;</span><br><span class="line">            sc-&gt;compile_args = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 增加解析参数对应的处理逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_script_add_args_code(sc) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line">        <span class="comment">// 如果无上述情况，即是简单的常量字符串部分时</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; sc-&gt;source-&gt;len) &#123;</span><br><span class="line">            <span class="comment">// 找到变量起始标识，break</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'$'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 找到?，并且需要解析请求参数时，break。不解析请求参数时，?仅仅当做一个简单的字符串处理</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'?'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                sc-&gt;args = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sc-&gt;compile_args) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line">            name.len++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sc-&gt;size += name.len;</span><br><span class="line">        <span class="comment">// 增加对应的解析常量的处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_script_add_copy_code(sc, &amp;name, (i == sc-&gt;source-&gt;len))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析完成后的最后处理</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_script_done(sc);</span><br><span class="line"></span><br><span class="line">invalid_variable:</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>, <span class="string">"invalid variable name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于set的脚本变量，ngx_http_script_complex_value_code_t结构的lengths是用来计算变量值所占空间大小，code成员用来在ngx_http_script_engine_t的sp中分配对应的空间。之后使用ngx_http_rewrite_loc_conf_t中的codes成员（一般包含多个）来对分配的内容进行赋值。而后使用ngx_http_rewrite_loc_conf_t中的codes中对变量名的解析方法，来将对应的值赋值给对应的变量。</p>
<p>总体上构建处理函数的顺序为：</p>
<ol>
<li>先将ngx_http_script_complex_value_code_t添加到ngx_http_rewrite_loc_conf_t中的codes成员中。</li>
<li>将变量解析的函数的每一部分（一般会含有多个部分）的处理函数（2种处理函数）依次添加到ngx_http_script_complex_value_code_t的lengths成员（计算每一部分生成的值长度）和ngx_http_rewrite_loc_conf_t的codes中（实际执行变量赋值的操作）</li>
<li>将变量名解析的函数增加到ngx_http_rewrite_loc_conf_t中的codes成员中。</li>
</ol>
<p>执行变量构建的顺序为：</p>
<ol>
<li>执行ngx_http_rewrite_loc_conf_t中的codes的ngx_http_script_complex_value_code_t成员的code方法，该方法会调用所有的ngx_http_script_complex_value_code_t中的lengths成员的方法，计算变量值总体占用空间，并在ngx_http_script_engine_t的当前sp中分配对应的空间。</li>
<li>接着执行ngx_http_rewrite_loc_conf_t中的codes后续的方法，对分配到sp的空间进行填充，构建完整的变量值。</li>
<li>执行变量名的解析函数，将sp中存储的变量值赋值到对应的变量上。</li>
</ol>
<p>其中ngx_http_script_compile_t中的lengths对应于ngx_http_script_complex_value_code_t中的lengths成员，ngx_http_script_compile_t中的values对应于ngx_http_rewrite_loc_conf_t中的codes成员。</p>
<p>在此基础上再来查看上述代码。首先来看ngx_http_script_complex_value_code_t的code方法，即ngx_http_rewrite_value方法中的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">complex</span>-&gt;code = ngx_http_script_complex_value_code;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_complex_value_code方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_complex_value_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                                 len;</span><br><span class="line">    <span class="keyword">ngx_http_script_engine_t</span>               le;</span><br><span class="line">    ngx_http_script_len_code_pt            lcode;</span><br><span class="line">    <span class="keyword">ngx_http_script_complex_value_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 恢复ngx_http_script_complex_value_code_t类</span></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_complex_value_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法，这里相当于是移动到ngx_http_rewrite_loc_conf_t中的codes下一个成员</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_complex_value_code_t</span>);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script complex value"</span>);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;le, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_engine_t</span>));</span><br><span class="line"></span><br><span class="line">    le.ip = code-&gt;lengths-&gt;elts;</span><br><span class="line">    le.line = e-&gt;line;</span><br><span class="line">    le.request = e-&gt;request;</span><br><span class="line">    le.quote = e-&gt;quote;</span><br><span class="line">    <span class="comment">// 依次执行ngx_http_script_complex_value_code_t的lengths函数，计算变量值占用空间大小</span></span><br><span class="line">    <span class="keyword">for</span> (len = <span class="number">0</span>; *(<span class="keyword">uintptr_t</span> *) le.ip; len += lcode(&amp;le)) &#123;</span><br><span class="line">        lcode = *(ngx_http_script_len_code_pt *) le.ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_engine_t的buf中分配该空间</span></span><br><span class="line">    e-&gt;buf.len = len;</span><br><span class="line">    e-&gt;buf.data = ngx_pnalloc(e-&gt;request-&gt;pool, len);</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;buf.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">        e-&gt;status = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 让ngx_http_script_engine_t的pos执行该空间，后续赋值操作都是在依据pos指针</span></span><br><span class="line">    e-&gt;pos = e-&gt;buf.data;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_engine_t的当前sp的成员中初始化变量值</span></span><br><span class="line">    e-&gt;sp-&gt;len = e-&gt;buf.len;</span><br><span class="line">    e-&gt;sp-&gt;data = e-&gt;buf.data;</span><br><span class="line">    <span class="comment">// 将sp栈上升。这里虽然sp进行了变更，但是由于赋值是，使用的pos成员，因此赋值依旧是原始的sp</span></span><br><span class="line">    e-&gt;sp++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看一下对不同类型的变量增加相应处理函数的逻辑，这里对于$1类变量较为复杂，目前没有完全理解，暂时先不考虑。这里主要看一下变量名和常量的部分，即如下形式的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> $value <span class="string">"$valueName text"</span></span><br></pre></td></tr></table></figure>
<p>其中$valueName部分对应与变量名，” text”对应与常量表达式。其处理函数分别是ngx_http_script_add_var_code和ngx_http_script_add_copy_code。</p>
<p>先来看一下ngx_http_script_add_var_code：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_var_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_str_t</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                    index, *p;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 找到变量的索引</span></span><br><span class="line">    index = ngx_http_get_variable_index(sc-&gt;cf, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sc-&gt;flushes) &#123;</span><br><span class="line">        p = ngx_array_push(*sc-&gt;flushes);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *p = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_compile_t中的lengths增加ngx_http_script_copy_var_len_code方法</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                             ngx_http_script_copy_var_len_code;</span><br><span class="line">    code-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line">    <span class="comment">// 在ngx_http_rewrite_loc_conf_t中的codes增加ngx_http_script_copy_var_code</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>),</span><br><span class="line">                                    &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_var_code;</span><br><span class="line">    code-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_var_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>   *value;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line">    <span class="comment">// 根据index获取变量长度</span></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;flushed) &#123;</span><br><span class="line">        value = ngx_http_get_indexed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value = ngx_http_get_flushed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; !value-&gt;not_found) &#123;</span><br><span class="line">        <span class="keyword">return</span> value-&gt;len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_copy_var_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                      *p;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>   *value;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line">    <span class="comment">// 通过index获取对应的值</span></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;skip) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e-&gt;flushed) &#123;</span><br><span class="line">            value = ngx_http_get_indexed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = ngx_http_get_flushed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value &amp;&amp; !value-&gt;not_found) &#123;</span><br><span class="line">        <span class="comment">// 把变量值拷贝到pos中，将pos后移</span></span><br><span class="line">            p = e-&gt;pos;</span><br><span class="line">            e-&gt;pos = ngx_copy(p, value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_HTTP,</span><br><span class="line">                           e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http script var: \"%*s\""</span>, e-&gt;pos - p, p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看一下ngx_http_script_add_copy_code：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_copy_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_str_t</span> *value,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> last)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                       *p;</span><br><span class="line">    <span class="keyword">size_t</span>                        size, len, zero;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 如果要在文本末尾增加\0,并且到达了末尾，长度增加ngx_http_script_copy_len_code处理函数</span></span><br><span class="line">    zero = (sc-&gt;zero &amp;&amp; last);</span><br><span class="line">    len = value-&gt;len + zero;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_compile_t中的lengths增加</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                                 ngx_http_script_copy_len_code;</span><br><span class="line">    code-&gt;len = len;</span><br><span class="line">    <span class="comment">// 申请空间包括一个存储ngx_http_script_copy_code_t结构的空间，和存储常量值长度的空间，并进行了内存对齐</span></span><br><span class="line">    size = (<span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>) + len + <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>)</span><br><span class="line">            &amp; ~(<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在ngx_http_rewrite_loc_conf_t中的codes增加ngx_http_script_copy_code</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values, size, &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_code;</span><br><span class="line">    code-&gt;len = len;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_copy_code_t的后面增加对应的常量值。</span></span><br><span class="line">    p = ngx_cpymem((u_char *) code + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>),</span><br><span class="line">                   value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zero) &#123;</span><br><span class="line">        *p = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="comment">// zero变更为0，表示末尾已正常添加\0,后续不用再添加了</span></span><br><span class="line">        sc-&gt;zero = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line">    </span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// ip指向下一个指令</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>);</span><br><span class="line">    <span class="comment">// 返回常量对应的长度</span></span><br><span class="line">    <span class="keyword">return</span> code-&gt;len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_copy_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                       *p;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_code_t</span> *) e-&gt;ip;</span><br><span class="line"></span><br><span class="line">    p = e-&gt;pos;</span><br><span class="line">    <span class="comment">// 把常量拷贝到pos中，将pos后移</span></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;skip) &#123;</span><br><span class="line">        e-&gt;pos = ngx_copy(p, e-&gt;ip + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>),</span><br><span class="line">                          code-&gt;len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法。这里和构建时一样，进行了内存对齐。</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>)</span><br><span class="line">          + ((code-&gt;len + <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>) &amp; ~(<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script copy: \"%*s\""</span>, e-&gt;pos - p, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看编译变量名的处理逻辑，对应于ngx_http_rewrite_set函数如下代码段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于系统内置变量，且支持用户重新使用set设置值的变量来说，会提供set_handler接口，这里使用    </span></span><br><span class="line"><span class="keyword">if</span> (v-&gt;set_handler) &#123;</span><br><span class="line">    vhcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                               <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_handler_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (vhcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// code为其执行函数</span></span><br><span class="line">    vhcode-&gt;code = ngx_http_script_var_set_handler_code;</span><br><span class="line">    <span class="comment">// handler被设置为变量原来的set_handler函数。</span></span><br><span class="line">    vhcode-&gt;handler = v-&gt;set_handler;</span><br><span class="line">    vhcode-&gt;data = v-&gt;data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果该变量不存在set_handler，则增加ngx_http_script_var_code_t结构来设置变量</span></span><br><span class="line">vcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                   <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>));</span><br><span class="line"><span class="keyword">if</span> (vcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vcode-&gt;code = ngx_http_script_set_var_code;</span><br><span class="line">vcode-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br></pre></td></tr></table></figure>
<p>ngx_http_script_var_handler_code_t结构专门支持内部变量能够被set重新设置，其定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 变量执行的方法</span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    // 对应于原变量的set_handler方法</span><br><span class="line">    ngx_http_set_variable_pt    handler;</span><br><span class="line">    // 对应数据</span><br><span class="line">    uintptr_t                   data;</span><br><span class="line">&#125; ngx_http_script_var_handler_code_t;</span><br></pre></td></tr></table></figure>
<p>先来看一下函数ngx_http_script_var_set_handler_code，其执行逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_var_set_handler_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_handler_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script set var handler"</span>);</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_handler_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_handler_code_t</span>);</span><br><span class="line">    <span class="comment">// 由于在ngx_http_script_complex_value_code_t方法中将sp上移了一个，但赋值是原来的，因此这里将栈下移，获取该变量的数据</span></span><br><span class="line">    e-&gt;sp--;</span><br><span class="line">    <span class="comment">// 执行原变量的set_handler方法</span></span><br><span class="line">    code-&gt;handler(e-&gt;request, e-&gt;sp, code-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一个具有set_handler方法的例子，如agrs：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    &#123; ngx_string(<span class="string">"args"</span>),</span><br><span class="line">      ngx_http_variable_set_args,</span><br><span class="line">      ngx_http_variable_request,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, args),</span><br><span class="line">      NGX_HTTP_VAR_CHANGEABLE|NGX_HTTP_VAR_NOCACHEABLE, <span class="number">0</span> &#125;,</span><br><span class="line">      </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_variable_set_args(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里v即为sp栈数据，这里直接赋值给args</span></span><br><span class="line">    r-&gt;args.len = v-&gt;len;</span><br><span class="line">    r-&gt;args.data = v-&gt;data;</span><br><span class="line">    r-&gt;valid_unparsed_uri = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，其取变量的方式是通过offsetof(ngx_http_request_t, args)，即r-&gt;args里面进行字符串匹配查找数据。</p>
<p>对应不包含set_handler的变量来说，其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_set_var_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>          *r;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 由于在ngx_http_script_complex_value_code_t方法中将sp上移了一个，但赋值是原来的，因此这里将栈下移，获取该变量的数据</span></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line"></span><br><span class="line">    r = e-&gt;request;</span><br><span class="line"></span><br><span class="line">    e-&gt;sp--;</span><br><span class="line">    <span class="comment">// 直接使用索引对数据赋值</span></span><br><span class="line">    r-&gt;variables[code-&gt;index].len = e-&gt;sp-&gt;len;</span><br><span class="line">    r-&gt;variables[code-&gt;index].valid = <span class="number">1</span>;</span><br><span class="line">    r-&gt;variables[code-&gt;index].no_cacheable = <span class="number">0</span>;</span><br><span class="line">    r-&gt;variables[code-&gt;index].not_found = <span class="number">0</span>;</span><br><span class="line">    r-&gt;variables[code-&gt;index].data = e-&gt;sp-&gt;data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script set $%V"</span>, &amp;v[code-&gt;index].name);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="变量间merge"><a href="#变量间merge" class="headerlink" title="变量间merge"></a>变量间merge</h2><p>在http层的set方法ngx_http_block中的ngx_http_variables_init_vars函数中会对三种变量（hash到变量，索引的变量，前缀变量）进行merge。其方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variables_init_vars(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>             *key;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>             hash;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v, *av, *pv;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set the handlers for the indexed http variables */</span></span><br><span class="line">    <span class="comment">// 获取mian层级ngx_http_core_module创建的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 索引后的变量数组</span></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line">    <span class="comment">// 前缀变量数组</span></span><br><span class="line">    pv = cmcf-&gt;prefix_variables.elts;</span><br><span class="line">    <span class="comment">// 即将要被hash化的数组</span></span><br><span class="line">    key = cmcf-&gt;variables_keys-&gt;keys.elts;</span><br><span class="line">    <span class="comment">// 遍历索引化的数据</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;variables.nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 遍历将要hash化的数组，找到与索引化的元素一样的元素</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cmcf-&gt;variables_keys-&gt;keys.nelts; n++) &#123;</span><br><span class="line"></span><br><span class="line">            av = key[n].value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (v[i].name.len == key[n].key.len</span><br><span class="line">                &amp;&amp; ngx_strncmp(v[i].name.data, key[n].key.data, v[i].name.len)</span><br><span class="line">                   == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 设置索引化的数组的get_handler为，待hash数组对应元素的get_handler</span></span><br><span class="line">                v[i].get_handler = av-&gt;get_handler;</span><br><span class="line">                v[i].data = av-&gt;data;</span><br><span class="line">                <span class="comment">// 设置hash化数组中对应元素为已hash化。这里对应与ngx_http_get_value函数中，先查找hash表，找到后查看该变量是否已索引化，对于索引化时，使用索引数组中该变量处理方法</span></span><br><span class="line">                av-&gt;flags |= NGX_HTTP_VAR_INDEXED;</span><br><span class="line">                v[i].flags = av-&gt;flags;</span><br><span class="line">                <span class="comment">// 设置hash数组中该变量index为在索引化数组中索引，方便查找</span></span><br><span class="line">                av-&gt;index = i;</span><br><span class="line">                <span class="comment">// 对于NGX_HTTP_VAR_WEAK变量，需要再查看是否属于前缀变量，否则直接进行下一个hash元素的查找</span></span><br><span class="line">                <span class="keyword">if</span> (av-&gt;get_handler == <span class="literal">NULL</span></span><br><span class="line">                    || (av-&gt;flags &amp; NGX_HTTP_VAR_WEAK))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">goto</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = <span class="number">0</span>;</span><br><span class="line">        av = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 遍历前缀变量，使用最长匹配查找是否为前缀变量，这里有个小bug，v[i].name.len &gt; len应该是pv[n].name.len&gt;len才对（个人理解）</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cmcf-&gt;prefix_variables.nelts; n++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v[i].name.len &gt;= pv[n].name.len &amp;&amp; v[i].name.len &gt; len</span><br><span class="line">                &amp;&amp; ngx_strncmp(v[i].name.data, pv[n].name.data, pv[n].name.len)</span><br><span class="line">                   == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                av = &amp;pv[n];</span><br><span class="line">                len = pv[n].name.len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是前缀变量，则设置变量的解析方式为前缀变量的解析方式，设置data为变量名（这是前缀变量get_handler使用方式要求）</span></span><br><span class="line">        <span class="keyword">if</span> (av) &#123;</span><br><span class="line">            v[i].get_handler = av-&gt;get_handler;</span><br><span class="line">            v[i].data = (<span class="keyword">uintptr_t</span>) &amp;v[i].name;</span><br><span class="line">            v[i].flags = av-&gt;flags;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (v[i].get_handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"unknown \"%V\" variable"</span>, &amp;v[i].name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置不需要hash化的变量data为null，这时构建hash表就会跳过该变量</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cmcf-&gt;variables_keys-&gt;keys.nelts; n++) &#123;</span><br><span class="line">        av = key[n].value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (av-&gt;flags &amp; NGX_HTTP_VAR_NOHASH) &#123;</span><br><span class="line">            key[n].key.data = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建variables_hash表，存储hash后变量。</span></span><br><span class="line">    hash.hash = &amp;cmcf-&gt;variables_hash;</span><br><span class="line">    hash.key = ngx_hash_key;</span><br><span class="line">    hash.max_size = cmcf-&gt;variables_hash_max_size;</span><br><span class="line">    hash.bucket_size = cmcf-&gt;variables_hash_bucket_size;</span><br><span class="line">    hash.name = <span class="string">"variables_hash"</span>;</span><br><span class="line">    hash.pool = cf-&gt;pool;</span><br><span class="line">    hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_init(&amp;hash, cmcf-&gt;variables_keys-&gt;keys.elts,</span><br><span class="line">                      cmcf-&gt;variables_keys-&gt;keys.nelts)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;variables_keys = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里看一下前缀变量get_handler方法</span></span><br><span class="line">      &#123; ngx_string(<span class="string">"arg_"</span>), <span class="literal">NULL</span>, ngx_http_variable_argument,</span><br><span class="line">      <span class="number">0</span>, NGX_HTTP_VAR_NOCACHEABLE|NGX_HTTP_VAR_PREFIX, <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_argument(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_variable_value_t</span> *v,</span><br><span class="line">    <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// data存储的是变量名</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span> *name = (<span class="keyword">ngx_str_t</span> *) data;</span><br><span class="line"></span><br><span class="line">    u_char     *arg;</span><br><span class="line">    <span class="keyword">size_t</span>      len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>   value;</span><br><span class="line">    <span class="comment">// 去除前缀arg_</span></span><br><span class="line">    len = name-&gt;len - (<span class="keyword">sizeof</span>(<span class="string">"arg_"</span>) - <span class="number">1</span>);</span><br><span class="line">    arg = name-&gt;data + <span class="keyword">sizeof</span>(<span class="string">"arg_"</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 在r-&gt;args中查找变量</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_arg(r, arg, len, &amp;value) != NGX_OK) &#123;</span><br><span class="line">        v-&gt;not_found = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;data = value.data;</span><br><span class="line">    v-&gt;len = value.len;</span><br><span class="line">    v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">    v-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">    v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>对于如下配置，输出为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location /url &#123;</span><br><span class="line"></span><br><span class="line">    set   $name   “$arg_name”;</span><br><span class="line"></span><br><span class="line">    set   $args   “name=jikui”;</span><br><span class="line"></span><br><span class="line">    return 200   “$name = $arg_name”;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">访问url输出结果是:</span><br><span class="line">curl http://127.0.0.1/url?name=test</span><br><span class="line"></span><br><span class="line">test = jikui</span><br></pre></td></tr></table></figure>
<p>对于<code>set   $name   “$arg_name”;</code>来说，<code>$arg_name</code>作为前缀变量，不可缓存，因此从请求的r-&gt;args中获取。这是$name值为test。对于<code>set   $args   “name=jikui”;</code>来说，由于args允许用户set值，因此其存在set_handler函数。ngx_http_script_var_handler_code_t结构的code方法调用其set_handler函数，设置r-&gt;args为<code>&quot;name=jikui&quot;</code>。由于这两步是顺序执行的，因此此时name是test。args是<code>name=jikui</code>。最后的<code>$name = $arg_name”</code>。由于set设置的name变量是可缓存的，因此会直接使用执行set脚本时生成的test值，而对于<code>$arg_name</code>来说，其是不可缓存的变量，因此会再次读取<code>r-&gt;args</code>来获取值，因此其值变更为jikui。</p>
<h1 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h1><p><a href="https://zhuanlan.zhihu.com/p/93684036" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/93684036</a></p>
<h2 id="ngx-shm-zone-t"><a href="#ngx-shm-zone-t" class="headerlink" title="ngx_shm_zone_t"></a>ngx_shm_zone_t</h2><p>其中<code>ngx_shm_zone_t</code>结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_shm_zone_s &#123;</span><br><span class="line">    void                     *data; // 分配的共享内存</span><br><span class="line">    ngx_shm_t                 shm; // </span><br><span class="line">    ngx_shm_zone_init_pt      init; // 初始化函数</span><br><span class="line">    void                     *tag; // 绑定的模块</span><br><span class="line">    void                     *sync;</span><br><span class="line">    ngx_uint_t                noreuse;  /* unsigned  noreuse:1; */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="ngx-shm-t结构"><a href="#ngx-shm-t结构" class="headerlink" title="ngx_shm_t结构"></a>ngx_shm_t结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    u_char      *addr; </span><br><span class="line">    size_t       size; // 需要分配的大小</span><br><span class="line">    ngx_str_t    name; // 绑定的key</span><br><span class="line">    ngx_log_t   *log;</span><br><span class="line">    ngx_uint_t   exists;   /* unsigned  exists:1;  */</span><br><span class="line">&#125; ngx_shm_t;</span><br></pre></td></tr></table></figure>
<h1 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h1><p>由于nginx是多进程异步处理，因此很多时候进程间需要使用锁来确保进程安全，进行进程间同步。nginx使用的锁主要涉及三部分内容。方便为<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E8%AE%B0%E5%BD%95%E9%94%81" target="_blank" rel="noopener">文件锁</a>、<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E4%BF%A1%E5%8F%B7%E9%87%8F" target="_blank" rel="noopener">信号量</a>、原子变量。对于原子变量，可参考如下两篇文章的介绍：</p>
<p><a href="https://www.infoq.cn/article/atomic-operation" target="_blank" rel="noopener">https://www.infoq.cn/article/atomic-operation</a></p>
<p><a href="https://www.jianshu.com/p/cb7b726e943c" target="_blank" rel="noopener">https://www.jianshu.com/p/cb7b726e943c</a></p>
<p>这里主要讲解使用原子变量来构建锁。</p>
<h2 id="相关数据结构-5"><a href="#相关数据结构-5" class="headerlink" title="相关数据结构"></a>相关数据结构</h2><p>首先来看一下相关数据结构。</p>
<h3 id="ngx-shmtx-t"><a href="#ngx-shmtx-t" class="headerlink" title="ngx_shmtx_t"></a>ngx_shmtx_t</h3><p>nginx封装的锁的类。其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_ATOMIC_OPS)</span></span><br><span class="line">    <span class="comment">// 如果系统支持原子变量，则优先使用原子变量</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>  *lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="comment">// 如果星图支持信号量，则可选信号量</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>  *wait; <span class="comment">// 当前在等待的进程数量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>     semaphore; <span class="comment">// 是否正常开启了信号量</span></span><br><span class="line">    <span class="keyword">sem_t</span>          sem; <span class="comment">// 信号量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// 如果不支持原子变量，则使用文件锁来进行</span></span><br><span class="line">    <span class="keyword">ngx_fd_t</span>       fd;</span><br><span class="line">    u_char        *name;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>     spin; <span class="comment">// 重复尝试获取锁间隔</span></span><br><span class="line">&#125; <span class="keyword">ngx_shmtx_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-shmtx-sh-t"><a href="#ngx-shmtx-sh-t" class="headerlink" title="ngx_shmtx_sh_t"></a>ngx_shmtx_sh_t</h3><p>由于进程间通讯需要各个进程访问同一个地址，因此该类是nginx封装的一个共享内存创建的锁地址。其由对应的使用方来创建。具体可以参考事件模块构建 accept锁的过程。其结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>   lock; <span class="comment">// 支持原子变量时，对应的原子变量地址</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>   wait; <span class="comment">// 支持信号量时，对应的信号量有多少进程在等待的数量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">ngx_shmtx_sh_t</span>;</span><br></pre></td></tr></table></figure>
<h2 id="创建锁"><a href="#创建锁" class="headerlink" title="创建锁"></a>创建锁</h2><p>使用ngx_shmtx_create方法来创建锁，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_shmtx_create(<span class="keyword">ngx_shmtx_t</span> *mtx, <span class="keyword">ngx_shmtx_sh_t</span> *addr, u_char *name)</span><br><span class="line">&#123;</span><br><span class="line">    mtx-&gt;lock = &amp;addr-&gt;lock;</span><br><span class="line">    <span class="comment">// 如果spin为-1，表示不能使用信号量（默认是不使用的，对于accept锁）</span></span><br><span class="line">    <span class="keyword">if</span> (mtx-&gt;spin == (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尝试获取锁的次数（并非准确值，具体下面介绍）</span></span><br><span class="line">    mtx-&gt;spin = <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="comment">// 如果支持信号量，则使用wait记录等待信号量的进程数</span></span><br><span class="line">    mtx-&gt;wait = &amp;addr-&gt;wait;</span><br><span class="line">    <span class="comment">// 初始化信号量为0</span></span><br><span class="line">    <span class="keyword">if</span> (sem_init(&amp;mtx-&gt;sem, <span class="number">1</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sem_init() failed"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 标识正确初始化了信号量</span></span><br><span class="line">        mtx-&gt;semaphore = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="销毁锁"><a href="#销毁锁" class="headerlink" title="销毁锁"></a>销毁锁</h2><p>使用ngx_shmtx_destroy方法来销毁锁：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_shmtx_destroy(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mtx-&gt;semaphore) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sem_destroy(&amp;mtx-&gt;sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"sem_destroy() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即仅在支持信号量，并且成功初始化了信号量时，需要执行一步信号量销毁操作。</p>
<h2 id="非阻塞获取锁"><a href="#非阻塞获取锁" class="headerlink" title="非阻塞获取锁"></a>非阻塞获取锁</h2><p>使用ngx_shmtx_trylock函数来非阻塞的获取锁，即如果不能获取锁，则直接返回。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_uint_t</span></span><br><span class="line">ngx_shmtx_trylock(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (*mtx-&gt;lock == <span class="number">0</span> &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_atomic_cmp_set(lock, old, set)                                    \</span></span><br><span class="line">    __sync_bool_compare_and_swap(lock, old, <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure>
<p><em>mtx-&gt;lock表示当前未被其他进程占用，但是在执行ngx_atomic_cmp_set的过程前（\</em>mtx-&gt;lock == 0后），可能已经被其他进程占用了，因此在原子变量中操作获取锁时，只有当前锁的值依然是0，即在该进程锁住变量前，没有其他进程已经对其进行设置，获取到该锁时，才对其进行赋值，表示当前进程占用该锁。当其他进程希望获取该锁时，由于lock值不为0，返回false。</p>
<h2 id="阻塞式获取锁"><a href="#阻塞式获取锁" class="headerlink" title="阻塞式获取锁"></a>阻塞式获取锁</h2><p>使用ngx_shmtx_lock函数来阻塞式获取锁，即直到获取到该锁才返回。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_cpu_pause()             __asm__ (<span class="meta-string">"pause"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SCHED_YIELD)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_sched_yield()  sched_yield()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_sched_yield()  usleep(1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_shmtx_lock(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i, n;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"shmtx lock"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 重试获取锁，获取成功立即返回</span></span><br><span class="line">        <span class="keyword">if</span> (*mtx-&gt;lock == <span class="number">0</span> &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 多处理器状态下spin才有效</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_ncpu &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 循环调用pause，并重试获取锁，pause的次数随着尝试次数指数增加</span></span><br><span class="line">            <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; mtx-&gt;spin; n &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                    ngx_cpu_pause();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 重复重试获取锁</span></span><br><span class="line">                <span class="keyword">if</span> (*mtx-&gt;lock == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">        <span class="comment">// 如果支持信号量，则尝试获取信号量</span></span><br><span class="line">        <span class="keyword">if</span> (mtx-&gt;semaphore) &#123;</span><br><span class="line">            <span class="comment">// 使用原子变量将等待的进程数量+1</span></span><br><span class="line">            (<span class="keyword">void</span>) ngx_atomic_fetch_add(mtx-&gt;wait, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 尝试获取锁，如果成功获取，则将等待进程数减一，返回</span></span><br><span class="line">            <span class="keyword">if</span> (*mtx-&gt;lock == <span class="number">0</span> &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid)) &#123;</span><br><span class="line">                (<span class="keyword">void</span>) ngx_atomic_fetch_add(mtx-&gt;wait, <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"shmtx wait %uA"</span>, *mtx-&gt;wait);</span><br><span class="line">            <span class="comment">// 等待其他进程释放信号量（执行减一操作，同一时刻，只有一个进程持有信号量）</span></span><br><span class="line">            <span class="keyword">while</span> (sem_wait(&amp;mtx-&gt;sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="comment">// 出错处理</span></span><br><span class="line">                <span class="keyword">ngx_err_t</span>  err;</span><br><span class="line"></span><br><span class="line">                err = ngx_errno;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EINTR) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                                  <span class="string">"sem_wait() failed while waiting on shmtx"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"shmtx awoke"</span>);</span><br><span class="line">            <span class="comment">// 获取到信号量，则执行下一次循环，再次尝试获取锁</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果没有信号量，则执行sched_yield()</span></span><br><span class="line">        ngx_sched_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里ngx_cpu_pause()执行的实际是汇编中pause指令，其会减少CPU的消耗，节省电量。指令的本质功能是：让加锁失败的CPU睡眠大约30个clock，从而使得读操作的频率低很多，流水线重排的代价也会很小。</p>
<p>ngx_sched_yield()执行的是sched_yield()函数，sched_yield()会让出当前线程的CPU占有权，然后把线程放到静态优先队列的尾端，然后一个新的线程会占用CPU。sched_yield()这个函数可以使用另一个级别等于或高于当前线程的线程先运行。如果没有符合条件的线程，那么这个函数将会立刻返回然后继续执行当前线程的程序。 这是其于sleep系列函数的本质区别，而sleep则是等待一定时间后等待CPU的调度，然后去获得CPU资源。</p>
<p>对于阻塞的sem_wait函数，其会阻塞进程。</p>
<p>对于使用信号量时，在将信号量-1后，没有对等待进程数量执行减一操作，该操作在释放信号量时进行。</p>
<h2 id="释放锁"><a href="#释放锁" class="headerlink" title="释放锁"></a>释放锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_shmtx_unlock(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mtx-&gt;spin != (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"shmtx unlock"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放锁，将原子变量设置回0，该进程获取锁时，原子变量值为该进程的id</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_atomic_cmp_set(mtx-&gt;lock, ngx_pid, <span class="number">0</span>)) &#123;</span><br><span class="line">        ngx_shmtx_wakeup(mtx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="释放信号"><a href="#释放信号" class="headerlink" title="释放信号"></a>释放信号</h2><p>在使用信号量时，释放信号后，会释放信号量来唤醒其他等待进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_shmtx_wakeup(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="keyword">ngx_atomic_uint_t</span>  wait;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mtx-&gt;semaphore) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里将等待的进程数量减一。这是由于在阻塞式获取锁时，获取信号量时，并未将该值减一，这样进行减一</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        wait = *mtx-&gt;wait;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">ngx_atomic_int_t</span>) wait &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_atomic_cmp_set(mtx-&gt;wait, wait, wait - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"shmtx wake %uA"</span>, wait);</span><br><span class="line">    <span class="comment">// 释放信号量来唤醒其余等待进程。</span></span><br><span class="line">    <span class="keyword">if</span> (sem_post(&amp;mtx-&gt;sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sem_post() failed while wake shmtx"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="强制释放锁"><a href="#强制释放锁" class="headerlink" title="强制释放锁"></a>强制释放锁</h2><p>当某些进程意外退出时，如果其已经获取到了某个锁，这时需要有一个机制能够让其他进程（master）进程来强制释放其所持有的锁。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_uint_t</span></span><br><span class="line">ngx_shmtx_force_unlock(<span class="keyword">ngx_shmtx_t</span> *mtx, <span class="keyword">ngx_pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"shmtx forced unlock"</span>);</span><br><span class="line">    <span class="comment">/* 如果释放锁返回为0，则表面出错进程确实拥有该锁，这时需要执行唤醒其余进程的操作，否则表示要释放的进程并不持有该锁，无需额外操作。*/</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_atomic_cmp_set(mtx-&gt;lock, pid, <span class="number">0</span>)) &#123;</span><br><span class="line">        ngx_shmtx_wakeup(mtx);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/30/Go语言学习/" rel="next" title="Go语言学习">
                <i class="fa fa-chevron-left"></i> Go语言学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/12/11/LambdaMart原理及实现/" rel="prev" title="LambdaMart算法原理与实现">
                LambdaMart算法原理与实现 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">chst</p>
              <p class="site-description motion-element" itemprop="description">人生苦酒,自酿自品</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx安装"><span class="nav-number">1.</span> <span class="nav-text">nginx安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#—prefix-PATH"><span class="nav-number">1.1.</span> <span class="nav-text">—prefix=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—sbin-path-PATH"><span class="nav-number">1.2.</span> <span class="nav-text">—sbin-path=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—conf-path-PATH"><span class="nav-number">1.3.</span> <span class="nav-text">—conf-path=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—error-log-path-PATH"><span class="nav-number">1.4.</span> <span class="nav-text">—error-log-path=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—pid-path-PATH"><span class="nav-number">1.5.</span> <span class="nav-text">—pid-path=PATH</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx的命令行控制"><span class="nav-number">2.</span> <span class="nav-text">nginx的命令行控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#直接执行Nginx二进制文件"><span class="nav-number">2.1.</span> <span class="nav-text">直接执行Nginx二进制文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#指定配置文件"><span class="nav-number">2.2.</span> <span class="nav-text">指定配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#另行指定全局配置项"><span class="nav-number">2.3.</span> <span class="nav-text">另行指定全局配置项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试配置信息是否错误"><span class="nav-number">2.4.</span> <span class="nav-text">测试配置信息是否错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示版本"><span class="nav-number">2.5.</span> <span class="nav-text">显示版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示编译阶段参数"><span class="nav-number">2.6.</span> <span class="nav-text">显示编译阶段参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速停止服务"><span class="nav-number">2.7.</span> <span class="nav-text">快速停止服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优雅的停止服务"><span class="nav-number">2.8.</span> <span class="nav-text">优雅的停止服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx的配置"><span class="nav-number">3.</span> <span class="nav-text">Nginx的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置demo"><span class="nav-number">3.1.</span> <span class="nav-text">配置demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#块配置"><span class="nav-number">3.2.</span> <span class="nav-text">块配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项语法"><span class="nav-number">3.3.</span> <span class="nav-text">配置项语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项单位"><span class="nav-number">3.4.</span> <span class="nav-text">配置项单位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置中使用变量"><span class="nav-number">3.5.</span> <span class="nav-text">配置中使用变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx提供的基础服务"><span class="nav-number">3.6.</span> <span class="nav-text">nginx提供的基础服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用语调试和定位问题的配置"><span class="nav-number">3.6.1.</span> <span class="nav-text">用语调试和定位问题的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是否以守护进程来执行"><span class="nav-number">3.6.1.1.</span> <span class="nav-text">是否以守护进程来执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#是否以master-worker方式进行工作"><span class="nav-number">3.6.1.2.</span> <span class="nav-text">是否以master/worker方式进行工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error日志设置"><span class="nav-number">3.6.1.3.</span> <span class="nav-text">error日志设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置特殊的调试点"><span class="nav-number">3.6.1.4.</span> <span class="nav-text">设置特殊的调试点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对指定客户端输出debug级别日志"><span class="nav-number">3.6.1.5.</span> <span class="nav-text">对指定客户端输出debug级别日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#限制coredump核心转储文件大小"><span class="nav-number">3.6.1.6.</span> <span class="nav-text">限制coredump核心转储文件大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定coredump文件生成目录"><span class="nav-number">3.6.1.7.</span> <span class="nav-text">指定coredump文件生成目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正常运行配置"><span class="nav-number">3.6.2.</span> <span class="nav-text">正常运行配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义环境变量"><span class="nav-number">3.6.2.1.</span> <span class="nav-text">定义环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#嵌入其他配置"><span class="nav-number">3.6.2.2.</span> <span class="nav-text">嵌入其他配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pid文件路径"><span class="nav-number">3.6.2.3.</span> <span class="nav-text">pid文件路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx进程运行的用户及用户组"><span class="nav-number">3.6.2.4.</span> <span class="nav-text">nginx进程运行的用户及用户组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#worker进程最大句柄描述符个数"><span class="nav-number">3.6.2.5.</span> <span class="nav-text">worker进程最大句柄描述符个数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#限制信号队列"><span class="nav-number">3.6.2.6.</span> <span class="nav-text">限制信号队列</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#性能优化配置"><span class="nav-number">3.6.3.</span> <span class="nav-text">性能优化配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx的worker进程数"><span class="nav-number">3.6.3.1.</span> <span class="nav-text">nginx的worker进程数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绑定nginx的worker进程到指定的CPU内核"><span class="nav-number">3.6.3.2.</span> <span class="nav-text">绑定nginx的worker进程到指定的CPU内核</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件类配置-都在event块中"><span class="nav-number">3.6.4.</span> <span class="nav-text">事件类配置(都在event块中)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是否打开负载均衡锁"><span class="nav-number">3.6.4.1.</span> <span class="nav-text">是否打开负载均衡锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lock文件路径"><span class="nav-number">3.6.4.2.</span> <span class="nav-text">lock文件路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用accept锁后未建立连接后等待时间"><span class="nav-number">3.6.4.3.</span> <span class="nav-text">使用accept锁后未建立连接后等待时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量建立新连接"><span class="nav-number">3.6.4.4.</span> <span class="nav-text">批量建立新连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#选择事件模型"><span class="nav-number">3.6.4.5.</span> <span class="nav-text">选择事件模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每个master的最大连接数"><span class="nav-number">3.6.4.6.</span> <span class="nav-text">每个master的最大连接数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#虚拟主机与请求的分发"><span class="nav-number">3.7.</span> <span class="nav-text">虚拟主机与请求的分发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#监听端口"><span class="nav-number">3.7.1.</span> <span class="nav-text">监听端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主机名称"><span class="nav-number">3.7.2.</span> <span class="nav-text">主机名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-name-hash-bucket-size"><span class="nav-number">3.7.3.</span> <span class="nav-text">server_name_hash_bucket_size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向主机名称处理"><span class="nav-number">3.7.4.</span> <span class="nav-text">重定向主机名称处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location"><span class="nav-number">3.7.5.</span> <span class="nav-text">location</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件路径的定义"><span class="nav-number">3.8.</span> <span class="nav-text">文件路径的定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#以root方式设置资源路径"><span class="nav-number">3.8.1.</span> <span class="nav-text">以root方式设置资源路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alias方式设置资源路径"><span class="nav-number">3.8.2.</span> <span class="nav-text">alias方式设置资源路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问首页"><span class="nav-number">3.8.3.</span> <span class="nav-text">访问首页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据http返回码重定向页面"><span class="nav-number">3.8.4.</span> <span class="nav-text">根据http返回码重定向页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#是否允许递归使用error-page"><span class="nav-number">3.8.5.</span> <span class="nav-text">是否允许递归使用error_page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#try-file"><span class="nav-number">3.8.6.</span> <span class="nav-text">try_file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">3.8.7.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存及磁盘资源的分配"><span class="nav-number">3.9.</span> <span class="nav-text">内存及磁盘资源的分配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP包体只存储在磁盘文件中"><span class="nav-number">3.9.1.</span> <span class="nav-text">HTTP包体只存储在磁盘文件中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP包体尽量写到一个内存buffer中"><span class="nav-number">3.9.2.</span> <span class="nav-text">HTTP包体尽量写到一个内存buffer中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储HTTP请求头部的内存大小"><span class="nav-number">3.9.3.</span> <span class="nav-text">存储HTTP请求头部的内存大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储超大HTTP头部的内存buffer大小"><span class="nav-number">3.9.4.</span> <span class="nav-text">存储超大HTTP头部的内存buffer大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储HTTP包体的内存buffer大小"><span class="nav-number">3.9.5.</span> <span class="nav-text">存储HTTP包体的内存buffer大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP包体临时存放目录"><span class="nav-number">3.9.6.</span> <span class="nav-text">HTTP包体临时存放目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connection-pool-size"><span class="nav-number">3.9.7.</span> <span class="nav-text">connection_pool_size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#request-pool-size"><span class="nav-number">3.9.8.</span> <span class="nav-text">request_pool_size</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络连接设置"><span class="nav-number">3.10.</span> <span class="nav-text">网络连接设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#读取HTTP头部超时时间"><span class="nav-number">3.10.1.</span> <span class="nav-text">读取HTTP头部超时时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#读取HTTP包体超时时间"><span class="nav-number">3.10.2.</span> <span class="nav-text">读取HTTP包体超时时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送响应超时时间"><span class="nav-number">3.10.3.</span> <span class="nav-text">发送响应超时时间</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#client-body-in-file-only"><span class="nav-number">3.11.</span> <span class="nav-text">client_body_in_file_only</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#client-body-in-single-buffer"><span class="nav-number">3.12.</span> <span class="nav-text">client_body_in_single_buffer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#长连接"><span class="nav-number">3.13.</span> <span class="nav-text">长连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#keepalive-requests"><span class="nav-number">3.13.1.</span> <span class="nav-text">keepalive_requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keepalive-timeout"><span class="nav-number">3.13.2.</span> <span class="nav-text">keepalive_timeout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tcp-nopush-tcp-nodelay"><span class="nav-number">3.14.</span> <span class="nav-text">tcp_nopush/tcp_nodelay</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#延迟关闭（lingering-close）"><span class="nav-number">3.15.</span> <span class="nav-text">延迟关闭（lingering_close）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lingering-close"><span class="nav-number">3.15.1.</span> <span class="nav-text">lingering_close</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lingering-time"><span class="nav-number">3.15.2.</span> <span class="nav-text">lingering_time</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lingering-timeout"><span class="nav-number">3.15.3.</span> <span class="nav-text">lingering_timeout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加速close"><span class="nav-number">3.16.</span> <span class="nav-text">加速close</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx常用数据结构"><span class="nav-number">4.</span> <span class="nav-text">Nginx常用数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-buf-t"><span class="nav-number">4.1.</span> <span class="nav-text">ngx_buf_t</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-chain-s"><span class="nav-number">4.2.</span> <span class="nav-text">ngx_chain_s</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-list-t"><span class="nav-number">4.3.</span> <span class="nav-text">ngx_list_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化链表ngx-list-init"><span class="nav-number">4.3.1.</span> <span class="nav-text">初始化链表ngx_list_init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建list-ngx-list-create"><span class="nav-number">4.3.2.</span> <span class="nav-text">创建list ngx_list_create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加数据ngx-list-push"><span class="nav-number">4.3.3.</span> <span class="nav-text">添加数据ngx_list_push</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-table-elt-t"><span class="nav-number">4.4.</span> <span class="nav-text">ngx_table_elt_t</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#散列表（ngx-hash-t）"><span class="nav-number">4.5.</span> <span class="nav-text">散列表（ngx_hash_t）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#散列表构建"><span class="nav-number">4.5.1.</span> <span class="nav-text">散列表构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#散列表查找"><span class="nav-number">4.5.2.</span> <span class="nav-text">散列表查找</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理散列表（ngx-hash-keys-arrays-t）"><span class="nav-number">4.6.</span> <span class="nav-text">管理散列表（ngx_hash_keys_arrays_t）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#构建ngx-hash-keys-arrays-t"><span class="nav-number">4.6.1.</span> <span class="nav-text">构建ngx_hash_keys_arrays_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加元素"><span class="nav-number">4.6.2.</span> <span class="nav-text">添加元素</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#带有通配符的散列表（ngx-hash-wildcard-t）"><span class="nav-number">4.7.</span> <span class="nav-text">带有通配符的散列表（ngx_hash_wildcard_t）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#构建带有通配符的散列表"><span class="nav-number">4.7.1.</span> <span class="nav-text">构建带有通配符的散列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找后缀通配符"><span class="nav-number">4.7.2.</span> <span class="nav-text">查找后缀通配符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找前缀通配符"><span class="nav-number">4.7.3.</span> <span class="nav-text">查找前缀通配符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-queue-t双向循环链表"><span class="nav-number">4.8.</span> <span class="nav-text">ngx_queue_t双向循环链表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构"><span class="nav-number">4.8.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化双向循环链表：ngx-queue-init-q"><span class="nav-number">4.8.2.</span> <span class="nav-text">初始化双向循环链表：ngx_queue_init(q)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#判空：ngx-queue-empty-h"><span class="nav-number">4.8.3.</span> <span class="nav-text">判空：ngx_queue_empty(h)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在头部插入元素：ngx-queue-insert-head（h，x）"><span class="nav-number">4.8.4.</span> <span class="nav-text">在头部插入元素：ngx_queue_insert_head（h，x）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在尾部插入节点：ngx-queue-insert-tail（h，x）"><span class="nav-number">4.8.5.</span> <span class="nav-text">在尾部插入节点：ngx_queue_insert_tail（h，x）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取列表第一个元素：ngx-queue-head-h"><span class="nav-number">4.8.6.</span> <span class="nav-text">获取列表第一个元素：ngx_queue_head(h)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取列表中最后一个元素：ngx-queue-last-h"><span class="nav-number">4.8.7.</span> <span class="nav-text">获取列表中最后一个元素：ngx_queue_last(h)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#返回链表容器结构体指针：ngx-queue-sentinel-h"><span class="nav-number">4.8.8.</span> <span class="nav-text">返回链表容器结构体指针：ngx_queue_sentinel(h)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取当前元素的下一个元素：ngx-queue-next-q"><span class="nav-number">4.8.9.</span> <span class="nav-text">获取当前元素的下一个元素：ngx_queue_next(q)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取当前元素的上一个元素：ngx-queue-prev-q"><span class="nav-number">4.8.10.</span> <span class="nav-text">获取当前元素的上一个元素：ngx_queue_prev(q)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#移出元素：ngx-queue-remove-x"><span class="nav-number">4.8.11.</span> <span class="nav-text">移出元素：ngx_queue_remove(x)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拆分链表：ngx-queue-split-h-q-n"><span class="nav-number">4.8.12.</span> <span class="nav-text">拆分链表：ngx_queue_split(h, q, n)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#合并链表：ngx-queue-add-h-n"><span class="nav-number">4.8.13.</span> <span class="nav-text">合并链表：ngx_queue_add(h, n)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#返回元素对应的地址：ngx-queue-data-q-type-link"><span class="nav-number">4.8.14.</span> <span class="nav-text">返回元素对应的地址：ngx_queue_data(q, type, link)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在指定元素后插入内容：ngx-queue-insert-after-h-x"><span class="nav-number">4.8.15.</span> <span class="nav-text">在指定元素后插入内容：ngx_queue_insert_after(h, x)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#返回链表中心元素：ngx-queue-middle-ngx-queue-t-queue"><span class="nav-number">4.8.16.</span> <span class="nav-text">返回链表中心元素：ngx_queue_middle(ngx_queue_t *queue)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对链表排序：ngx-queue-sort"><span class="nav-number">4.8.17.</span> <span class="nav-text">对链表排序：ngx_queue_sort</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#红黑树ngx-rbtree-node-t"><span class="nav-number">4.9.</span> <span class="nav-text">红黑树ngx_rbtree_node_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构-1"><span class="nav-number">4.9.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#红黑树节点提供的方法"><span class="nav-number">4.9.2.</span> <span class="nav-text">红黑树节点提供的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设置节点颜色"><span class="nav-number">4.9.2.1.</span> <span class="nav-text">设置节点颜色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#判断节点颜色"><span class="nav-number">4.9.2.2.</span> <span class="nav-text">判断节点颜色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝节点颜色"><span class="nav-number">4.9.2.3.</span> <span class="nav-text">拷贝节点颜色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化哨兵节点"><span class="nav-number">4.9.2.4.</span> <span class="nav-text">初始化哨兵节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查找子树中最小节点"><span class="nav-number">4.9.2.5.</span> <span class="nav-text">查找子树中最小节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#红黑树容器提供的方法"><span class="nav-number">4.9.3.</span> <span class="nav-text">红黑树容器提供的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化红黑树ngx-rbtree-init"><span class="nav-number">4.9.3.1.</span> <span class="nav-text">初始化红黑树ngx_rbtree_init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#寻找下一个元素ngx-rbtree-next"><span class="nav-number">4.9.3.2.</span> <span class="nav-text">寻找下一个元素ngx_rbtree_next</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#旋转节点"><span class="nav-number">4.9.3.3.</span> <span class="nav-text">旋转节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加节点ngx-rbtree-insert"><span class="nav-number">4.9.3.4.</span> <span class="nav-text">添加节点ngx_rbtree_insert</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除元素"><span class="nav-number">4.9.3.5.</span> <span class="nav-text">删除元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#架构提供的三个ngx-rbtree-insert-pt增加节点函数。"><span class="nav-number">4.9.3.6.</span> <span class="nav-text">架构提供的三个ngx_rbtree_insert_pt增加节点函数。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-rbtree-insert-value"><span class="nav-number">4.9.3.6.1.</span> <span class="nav-text">ngx_rbtree_insert_value</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-rbtree-insert-timer-value"><span class="nav-number">4.9.3.6.2.</span> <span class="nav-text">ngx_rbtree_insert_timer_value</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-str-rbtree-insert-value"><span class="nav-number">4.9.3.6.3.</span> <span class="nav-text">ngx_str_rbtree_insert_value</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx特殊技巧"><span class="nav-number">5.</span> <span class="nav-text">Nginx特殊技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-align-值对齐宏"><span class="nav-number">5.1.</span> <span class="nav-text">ngx_align 值对齐宏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-align-ptr内存对其"><span class="nav-number">5.2.</span> <span class="nav-text">ngx_align_ptr内存对其</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#指针最后两位一定是0"><span class="nav-number">5.3.</span> <span class="nav-text">指针最后两位一定是0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内联汇编"><span class="nav-number">5.4.</span> <span class="nav-text">内联汇编</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx架构及启动流程"><span class="nav-number">6.</span> <span class="nav-text">Nginx架构及启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx的架构设计"><span class="nav-number">6.1.</span> <span class="nav-text">Nginx的架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#优秀的模块化设计"><span class="nav-number">6.1.1.</span> <span class="nav-text">优秀的模块化设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx-module-t类"><span class="nav-number">6.1.1.1.</span> <span class="nav-text">nginx_module_t类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件驱动框架"><span class="nav-number">6.1.2.</span> <span class="nav-text">事件驱动框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求的多阶段异步处理"><span class="nav-number">6.1.3.</span> <span class="nav-text">请求的多阶段异步处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理进程、多工作进程设计"><span class="nav-number">6.1.4.</span> <span class="nav-text">管理进程、多工作进程设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存池的设计"><span class="nav-number">6.1.5.</span> <span class="nav-text">内存池的设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx框架中的核心结构体ngx-cycle-t"><span class="nav-number">6.2.</span> <span class="nav-text">Nginx框架中的核心结构体ngx_cycle_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-listening-t结构体"><span class="nav-number">6.2.1.</span> <span class="nav-text">ngx_listening_t结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-cycle-t结构体"><span class="nav-number">6.2.2.</span> <span class="nav-text">ngx_cycle_t结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-cycle-t支持的方法"><span class="nav-number">6.2.3.</span> <span class="nav-text">ngx_cycle_t支持的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx启动时框架处理流程"><span class="nav-number">6.2.4.</span> <span class="nav-text">nginx启动时框架处理流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx启动过程详解"><span class="nav-number">6.3.</span> <span class="nav-text">nginx启动过程详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解析启动参数"><span class="nav-number">6.3.1.</span> <span class="nav-text">解析启动参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化信息"><span class="nav-number">6.3.2.</span> <span class="nav-text">初始化信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化log打印描述符"><span class="nav-number">6.3.3.</span> <span class="nav-text">初始化log打印描述符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#申请内存池空间Pool"><span class="nav-number">6.3.4.</span> <span class="nav-text">申请内存池空间Pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储命令行参数"><span class="nav-number">6.3.5.</span> <span class="nav-text">存储命令行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置相关路径"><span class="nav-number">6.3.6.</span> <span class="nav-text">设置相关路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化系统相关全局变量"><span class="nav-number">6.3.7.</span> <span class="nav-text">初始化系统相关全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化差错校验"><span class="nav-number">6.3.8.</span> <span class="nav-text">初始化差错校验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化slab共享内存"><span class="nav-number">6.3.9.</span> <span class="nav-text">初始化slab共享内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#监听环境变量中的端口"><span class="nav-number">6.3.10.</span> <span class="nav-text">监听环境变量中的端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预初始化模块"><span class="nav-number">6.3.11.</span> <span class="nav-text">预初始化模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化cycle"><span class="nav-number">6.3.12.</span> <span class="nav-text">初始化cycle</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建管理目录"><span class="nav-number">6.3.12.1.</span> <span class="nav-text">创建管理目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建管理文件"><span class="nav-number">6.3.12.2.</span> <span class="nav-text">创建管理文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打开日志文件"><span class="nav-number">6.3.12.3.</span> <span class="nav-text">打开日志文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打开并设置监听地址"><span class="nav-number">6.3.12.4.</span> <span class="nav-text">打开并设置监听地址</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-open-listening-sockets打开监听地址"><span class="nav-number">6.3.12.4.1.</span> <span class="nav-text">ngx_open_listening_sockets打开监听地址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-configure-listening-sockets设置套接字属性"><span class="nav-number">6.3.12.4.2.</span> <span class="nav-text">ngx_configure_listening_sockets设置套接字属性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试配置的处理"><span class="nav-number">6.3.13.</span> <span class="nav-text">测试配置的处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送信号处理"><span class="nav-number">6.3.14.</span> <span class="nav-text">发送信号处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#判断运行方式"><span class="nav-number">6.3.15.</span> <span class="nav-text">判断运行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信号处理"><span class="nav-number">6.3.16.</span> <span class="nav-text">信号处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变更运行状态为守护进程"><span class="nav-number">6.3.17.</span> <span class="nav-text">变更运行状态为守护进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建pid文件"><span class="nav-number">6.3.18.</span> <span class="nav-text">创建pid文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置运行方式"><span class="nav-number">6.3.19.</span> <span class="nav-text">设置运行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行主体循环"><span class="nav-number">6.3.20.</span> <span class="nav-text">执行主体循环</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#master进程逻辑"><span class="nav-number">7.</span> <span class="nav-text">master进程逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#整体处理函数"><span class="nav-number">7.1.</span> <span class="nav-text">整体处理函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动worker子进程"><span class="nav-number">7.2.</span> <span class="nav-text">启动worker子进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关数据结构"><span class="nav-number">7.2.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#进程信息ngx-process-t"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">进程信息ngx_process_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进程间传递信息ngx-channel-t"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">进程间传递信息ngx_channel_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全局变量ngx-processes"><span class="nav-number">7.2.1.3.</span> <span class="nav-text">全局变量ngx_processes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动函数"><span class="nav-number">7.2.2.</span> <span class="nav-text">启动函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-spawn-process"><span class="nav-number">7.2.2.1.</span> <span class="nav-text">ngx_spawn_process</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进程间通讯"><span class="nav-number">7.2.2.2.</span> <span class="nav-text">进程间通讯</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-write-channel"><span class="nav-number">7.2.2.2.1.</span> <span class="nav-text">ngx_write_channel</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动cache管理子进程"><span class="nav-number">7.3.</span> <span class="nav-text">启动cache管理子进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置时钟信号"><span class="nav-number">7.4.</span> <span class="nav-text">设置时钟信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#子进程退出时处理"><span class="nav-number">7.5.</span> <span class="nav-text">子进程退出时处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#退出master进程"><span class="nav-number">7.6.</span> <span class="nav-text">退出master进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#删除pid文件"><span class="nav-number">7.6.1.</span> <span class="nav-text">删除pid文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭监听套接字"><span class="nav-number">7.6.2.</span> <span class="nav-text">关闭监听套接字</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#向子进程下发指令"><span class="nav-number">7.7.</span> <span class="nav-text">向子进程下发指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行新的二进制文件"><span class="nav-number">7.8.</span> <span class="nav-text">执行新的二进制文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#运行二进制文件"><span class="nav-number">7.8.1.</span> <span class="nav-text">运行二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置环境变量"><span class="nav-number">7.8.2.</span> <span class="nav-text">设置环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置中环境变量的解析"><span class="nav-number">7.8.3.</span> <span class="nav-text">配置中环境变量的解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#worker进程逻辑"><span class="nav-number">8.</span> <span class="nav-text">worker进程逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#work进程初始化"><span class="nav-number">8.1.</span> <span class="nav-text">work进程初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#绑定进程到指定CPU"><span class="nav-number">8.1.1.</span> <span class="nav-text">绑定进程到指定CPU</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置解析"><span class="nav-number">8.1.1.1.</span> <span class="nav-text">配置解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取进程绑定的cpu"><span class="nav-number">8.1.1.2.</span> <span class="nav-text">获取进程绑定的cpu</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置绑定"><span class="nav-number">8.1.1.3.</span> <span class="nav-text">设置绑定</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unix域套接字通信事件"><span class="nav-number">8.1.2.</span> <span class="nav-text">unix域套接字通信事件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-channel-handler可读事件触发时处理"><span class="nav-number">8.1.2.1.</span> <span class="nav-text">ngx_channel_handler可读事件触发时处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读取unix域数据"><span class="nav-number">8.1.2.2.</span> <span class="nav-text">读取unix域数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-worker-process-exit进程退出"><span class="nav-number">8.2.</span> <span class="nav-text">ngx_worker_process_exit进程退出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-set-shutdown-timer设置关机时间"><span class="nav-number">8.3.</span> <span class="nav-text">ngx_set_shutdown_timer设置关机时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-close-listening-sockets关闭正在监听套接字"><span class="nav-number">8.4.</span> <span class="nav-text">ngx_close_listening_sockets关闭正在监听套接字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-close-idle-connections关闭空闲连接"><span class="nav-number">8.5.</span> <span class="nav-text">ngx_close_idle_connections关闭空闲连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-reopen-files重新打开日志文件"><span class="nav-number">8.6.</span> <span class="nav-text">ngx_reopen_files重新打开日志文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-process-events-and-timers事件处理"><span class="nav-number">8.7.</span> <span class="nav-text">ngx_process_events_and_timers事件处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-trylock-accept-mutex获取负载均衡锁"><span class="nav-number">8.7.1.</span> <span class="nav-text">ngx_trylock_accept_mutex获取负载均衡锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-enable-accept-events添加监听套接字对应事件到事件驱动模块"><span class="nav-number">8.7.2.</span> <span class="nav-text">ngx_enable_accept_events添加监听套接字对应事件到事件驱动模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-disable-accept-events从事件驱动中删除监听套接字对应事件"><span class="nav-number">8.7.3.</span> <span class="nav-text">ngx_disable_accept_events从事件驱动中删除监听套接字对应事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-event-process-posted执行post队列中时间"><span class="nav-number">8.7.4.</span> <span class="nav-text">ngx_event_process_posted执行post队列中时间</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP请求处理流程"><span class="nav-number">9.</span> <span class="nav-text">HTTP请求处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主要结构"><span class="nav-number">9.1.</span> <span class="nav-text">主要结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-request-t请求结构"><span class="nav-number">9.1.1.</span> <span class="nav-text">ngx_http_request_t请求结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立连接"><span class="nav-number">9.2.</span> <span class="nav-text">建立连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据交互"><span class="nav-number">9.2.1.</span> <span class="nav-text">数据交互</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#接收数据ngx-unix-recv"><span class="nav-number">9.2.1.1.</span> <span class="nav-text">接收数据ngx_unix_recv</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接处理"><span class="nav-number">9.3.</span> <span class="nav-text">连接处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构-2"><span class="nav-number">9.3.1.</span> <span class="nav-text">数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-connection-t"><span class="nav-number">9.3.1.1.</span> <span class="nav-text">ngx_http_connection_t</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数方法ngx-http-init-connection"><span class="nav-number">9.3.2.</span> <span class="nav-text">函数方法ngx_http_init_connection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取请求地址"><span class="nav-number">9.3.2.1.</span> <span class="nav-text">获取请求地址</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-http-wait-request-handler获取请求"><span class="nav-number">9.4.</span> <span class="nav-text">ngx_http_wait_request_handler获取请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构"><span class="nav-number">9.4.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-proxy-protocol-s"><span class="nav-number">9.4.1.1.</span> <span class="nav-text">ngx_proxy_protocol_s</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理方法"><span class="nav-number">9.4.2.</span> <span class="nav-text">处理方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建请求结构"><span class="nav-number">9.4.2.1.</span> <span class="nav-text">创建请求结构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理请求行"><span class="nav-number">9.5.</span> <span class="nav-text">处理请求行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-1"><span class="nav-number">9.5.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-headers-in-t"><span class="nav-number">9.5.1.1.</span> <span class="nav-text">ngx_http_headers_in_t</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行方法"><span class="nav-number">9.5.2.</span> <span class="nav-text">执行方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭请求ngx-http-close-request"><span class="nav-number">9.5.2.1.</span> <span class="nav-text">关闭请求ngx_http_close_request</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读取请求行ngx-http-read-request-header"><span class="nav-number">9.5.2.2.</span> <span class="nav-text">读取请求行ngx_http_read_request_header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解析请求ngx-http-parse-request-line"><span class="nav-number">9.5.2.3.</span> <span class="nav-text">解析请求ngx_http_parse_request_line</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解析uri-ngx-http-process-request-uri"><span class="nav-number">9.5.2.4.</span> <span class="nav-text">解析uri ngx_http_process_request_uri</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取请求的服务-ngx-http-set-virtual-server"><span class="nav-number">9.5.2.5.</span> <span class="nav-text">获取请求的服务 ngx_http_set_virtual_server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行子请求方法ngx-http-run-posted-requests"><span class="nav-number">9.5.2.6.</span> <span class="nav-text">执行子请求方法ngx_http_run_posted_requests</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分配大请求内存ngx-http-alloc-large-header-buffer"><span class="nav-number">9.5.2.7.</span> <span class="nav-text">分配大请求内存ngx_http_alloc_large_header_buffer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理请求头ngx-http-process-request-headers"><span class="nav-number">9.6.</span> <span class="nav-text">处理请求头ngx_http_process_request_headers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解析请求头ngx-http-parse-header-line"><span class="nav-number">9.6.1.</span> <span class="nav-text">解析请求头ngx_http_parse_header_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部分请求头处理函数"><span class="nav-number">9.6.2.</span> <span class="nav-text">部分请求头处理函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#host处理方法ngx-http-process-host"><span class="nav-number">9.6.2.1.</span> <span class="nav-text">host处理方法ngx_http_process_host</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Connection处理方法ngx-http-process-connection"><span class="nav-number">9.6.2.2.</span> <span class="nav-text">Connection处理方法ngx_http_process_connection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Content-Length-amp-Transfer-Encoding处理方法ngx-http-process-unique-header-line"><span class="nav-number">9.6.2.3.</span> <span class="nav-text">Content-Length&amp;Transfer-Encoding处理方法ngx_http_process_unique_header_line</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keep-alive处理方法ngx-http-process-header-line"><span class="nav-number">9.6.2.4.</span> <span class="nav-text">keep-alive处理方法ngx_http_process_header_line</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理请求头ngx-http-process-request-header"><span class="nav-number">9.6.3.</span> <span class="nav-text">处理请求头ngx_http_process_request_header</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求处理ngx-http-process-request"><span class="nav-number">9.7.</span> <span class="nav-text">请求处理ngx_http_process_request</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置请求处理ngx-http-handler"><span class="nav-number">9.7.1.</span> <span class="nav-text">设置请求处理ngx_http_handler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#核心处理循环ngx-http-core-run-phases"><span class="nav-number">9.7.2.</span> <span class="nav-text">核心处理循环ngx_http_core_run_phases</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#epoll事件触发执行方法ngx-http-request-handler"><span class="nav-number">9.7.3.</span> <span class="nav-text">epoll事件触发执行方法ngx_http_request_handler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心处理阶段"><span class="nav-number">9.8.</span> <span class="nav-text">核心处理阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-core-generic-phase方法"><span class="nav-number">9.8.1.</span> <span class="nav-text">ngx_http_core_generic_phase方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-POST-READ-PHASE阶段"><span class="nav-number">9.9.</span> <span class="nav-text">NGX_HTTP_POST_READ_PHASE阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-SERVER-REWRITE-PHASE阶段"><span class="nav-number">9.10.</span> <span class="nav-text">NGX_HTTP_SERVER_REWRITE_PHASE阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-core-rewrite-phase方法"><span class="nav-number">9.10.1.</span> <span class="nav-text">ngx_http_core_rewrite_phase方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-FIND-CONFIG-PHASE阶段"><span class="nav-number">9.11.</span> <span class="nav-text">NGX_HTTP_FIND_CONFIG_PHASE阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查找location方法ngx-http-core-find-location"><span class="nav-number">9.11.1.</span> <span class="nav-text">查找location方法ngx_http_core_find_location</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新请求ngx-http-update-location-config"><span class="nav-number">9.11.2.</span> <span class="nav-text">更新请求ngx_http_update_location_config</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-REWRITE-PHASE阶段"><span class="nav-number">9.12.</span> <span class="nav-text">NGX_HTTP_REWRITE_PHASE阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-REWRITE-PHASE阶段-1"><span class="nav-number">9.13.</span> <span class="nav-text">NGX_HTTP_REWRITE_PHASE阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-PREACCESS-PHASE"><span class="nav-number">9.14.</span> <span class="nav-text">NGX_HTTP_PREACCESS_PHASE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-ACCESS-PHASE阶段"><span class="nav-number">9.15.</span> <span class="nav-text">NGX_HTTP_ACCESS_PHASE阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-access-module"><span class="nav-number">9.15.1.</span> <span class="nav-text">ngx_http_access_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-auth-basic-module"><span class="nav-number">9.15.2.</span> <span class="nav-text">ngx_http_auth_basic_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-auth-request-module"><span class="nav-number">9.15.3.</span> <span class="nav-text">ngx_http_auth_request_module</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-POST-ACCESS-PHASE阶段"><span class="nav-number">9.16.</span> <span class="nav-text">NGX_HTTP_POST_ACCESS_PHASE阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-PRECONTENT-PHASE阶段"><span class="nav-number">9.17.</span> <span class="nav-text">NGX_HTTP_PRECONTENT_PHASE阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-CONTENT-PHASE阶段"><span class="nav-number">9.18.</span> <span class="nav-text">NGX_HTTP_CONTENT_PHASE阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-static-module模块"><span class="nav-number">9.18.1.</span> <span class="nav-text">ngx_http_static_module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-static-handler方法"><span class="nav-number">9.18.1.1.</span> <span class="nav-text">ngx_http_static_handler方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NGX-HTTP-LOG-PHASE阶段"><span class="nav-number">9.19.</span> <span class="nav-text">NGX_HTTP_LOG_PHASE阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发送响应"><span class="nav-number">9.20.</span> <span class="nav-text">发送响应</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-2"><span class="nav-number">9.20.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-headers-out-t响应头"><span class="nav-number">9.20.1.1.</span> <span class="nav-text">ngx_http_headers_out_t响应头</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送响应头ngx-http-send-header"><span class="nav-number">9.20.2.</span> <span class="nav-text">发送响应头ngx_http_send_header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送响应体ngx-http-output-filter"><span class="nav-number">9.20.3.</span> <span class="nav-text">发送响应体ngx_http_output_filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送响应过滤模块"><span class="nav-number">9.20.4.</span> <span class="nav-text">发送响应过滤模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#响应头发送ngx-http-header-filter"><span class="nav-number">9.20.5.</span> <span class="nav-text">响应头发送ngx_http_header_filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#响应体发送ngx-http-write-filter"><span class="nav-number">9.20.6.</span> <span class="nav-text">响应体发送ngx_http_write_filter</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-writer-chain方法"><span class="nav-number">9.20.6.1.</span> <span class="nav-text">ngx_writer_chain方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-writer方法"><span class="nav-number">9.20.7.</span> <span class="nav-text">ngx_http_writer方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求体处理"><span class="nav-number">9.21.</span> <span class="nav-text">请求体处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-3"><span class="nav-number">9.21.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-request-body-t"><span class="nav-number">9.21.1.1.</span> <span class="nav-text">ngx_http_request_body_t</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接收请求体ngx-http-read-client-request-body"><span class="nav-number">9.21.2.</span> <span class="nav-text">接收请求体ngx_http_read_client_request_body</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-request-body-filter"><span class="nav-number">9.21.2.1.</span> <span class="nav-text">ngx_http_request_body_filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-request-body-chunked-filter"><span class="nav-number">9.21.2.2.</span> <span class="nav-text">ngx_http_request_body_chunked_filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-request-body-length-filter"><span class="nav-number">9.21.2.3.</span> <span class="nav-text">ngx_http_request_body_length_filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-top-request-body-filter"><span class="nav-number">9.21.2.4.</span> <span class="nav-text">ngx_http_top_request_body_filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-chain-update-chains"><span class="nav-number">9.21.2.5.</span> <span class="nav-text">ngx_chain_update_chains</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-do-read-client-request-body"><span class="nav-number">9.21.2.6.</span> <span class="nav-text">ngx_http_do_read_client_request_body</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-read-client-request-body-handler"><span class="nav-number">9.21.2.7.</span> <span class="nav-text">ngx_http_read_client_request_body_handler</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-discard-request-body丢弃请求体"><span class="nav-number">9.21.3.</span> <span class="nav-text">ngx_http_discard_request_body丢弃请求体</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束请求ngx-http-finalize-request"><span class="nav-number">9.22.</span> <span class="nav-text">结束请求ngx_http_finalize_request</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-finalize-connection"><span class="nav-number">9.22.1.</span> <span class="nav-text">ngx_http_finalize_connection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-discarded-request-body-handler"><span class="nav-number">9.22.1.1.</span> <span class="nav-text">ngx_http_discarded_request_body_handler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-set-keepalive"><span class="nav-number">9.22.1.2.</span> <span class="nav-text">ngx_http_set_keepalive</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-keepalive-handler处理函数"><span class="nav-number">9.22.1.3.</span> <span class="nav-text">ngx_http_keepalive_handler处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-set-lingering-close"><span class="nav-number">9.22.1.4.</span> <span class="nav-text">ngx_http_set_lingering_close</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-lingering-close-handler"><span class="nav-number">9.22.1.5.</span> <span class="nav-text">ngx_http_lingering_close_handler</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-close-request"><span class="nav-number">9.22.2.</span> <span class="nav-text">ngx_http_close_request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-free-request释放请求"><span class="nav-number">9.22.3.</span> <span class="nav-text">ngx_http_free_request释放请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-terminate-request"><span class="nav-number">9.22.4.</span> <span class="nav-text">ngx_http_terminate_request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-set-write-handler"><span class="nav-number">9.22.5.</span> <span class="nav-text">ngx_http_set_write_handler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-special-response-handler"><span class="nav-number">9.22.6.</span> <span class="nav-text">ngx_http_special_response_handler</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-send-error-page"><span class="nav-number">9.22.6.1.</span> <span class="nav-text">ngx_http_send_error_page</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-internal-redirect内部重定向"><span class="nav-number">9.22.6.2.</span> <span class="nav-text">ngx_http_internal_redirect内部重定向</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-named-location内部命名location"><span class="nav-number">9.22.6.3.</span> <span class="nav-text">ngx_http_named_location内部命名location</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-send-refresh"><span class="nav-number">9.22.6.4.</span> <span class="nav-text">ngx_http_send_refresh</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-send-special-response发送特殊响应"><span class="nav-number">9.22.6.5.</span> <span class="nav-text">ngx_http_send_special_response发送特殊响应</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-post-action"><span class="nav-number">9.22.7.</span> <span class="nav-text">ngx_http_post_action</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解析配置"><span class="nav-number">10.</span> <span class="nav-text">解析配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化核心模块"><span class="nav-number">10.1.</span> <span class="nav-text">初始化核心模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置及参数解析"><span class="nav-number">10.2.</span> <span class="nav-text">配置及参数解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-4"><span class="nav-number">10.2.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-conf-t结构"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">ngx_conf_t结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-conf-file-t结构"><span class="nav-number">10.2.1.2.</span> <span class="nav-text">ngx_conf_file_t结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#词法解析（ngx-conf-read-token）"><span class="nav-number">10.2.2.</span> <span class="nav-text">词法解析（ngx_conf_read_token）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认处理（ngx-conf-handler）"><span class="nav-number">10.2.3.</span> <span class="nav-text">默认处理（ngx_conf_handler）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置配置项解析方式（ngx-commend-S）"><span class="nav-number">10.2.4.</span> <span class="nav-text">设置配置项解析方式（ngx_commend_S）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-str-t-name"><span class="nav-number">10.2.4.1.</span> <span class="nav-text">ngx_str_t  name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-uint-t-type"><span class="nav-number">10.2.4.2.</span> <span class="nav-text">ngx_uint_t type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#char-set-ngx-conf-t-cf-ngx-command-t-cmd-void-conf"><span class="nav-number">10.2.4.3.</span> <span class="nav-text">char(set)(ngx_conf_t cf, ngx_command_t cmd, void *conf)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-uint-t-conf"><span class="nav-number">10.2.4.4.</span> <span class="nav-text">ngx_uint_t conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-uint-t-offset"><span class="nav-number">10.2.4.5.</span> <span class="nav-text">ngx_uint_t offset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-post"><span class="nav-number">10.2.4.6.</span> <span class="nav-text">void *post</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预设配置项处理方法工作原理"><span class="nav-number">10.2.4.7.</span> <span class="nav-text">预设配置项处理方法工作原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http模块配置解析"><span class="nav-number">10.3.</span> <span class="nav-text">http模块配置解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http层set函数"><span class="nav-number">10.3.1.</span> <span class="nav-text">http层set函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-conf-ctx-t"><span class="nav-number">10.3.1.1.</span> <span class="nav-text">ngx_http_conf_ctx_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-core-module模块生成的三个结构"><span class="nav-number">10.3.1.2.</span> <span class="nav-text">ngx_http_core_module模块生成的三个结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-main-conf-t"><span class="nav-number">10.3.1.2.1.</span> <span class="nav-text">ngx_http_core_main_conf_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-srv-conf-t"><span class="nav-number">10.3.1.2.2.</span> <span class="nav-text">ngx_http_core_srv_conf_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-loc-conf-s"><span class="nav-number">10.3.1.2.3.</span> <span class="nav-text">ngx_http_core_loc_conf_s</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#http级配置解析内存结构"><span class="nav-number">10.3.1.3.</span> <span class="nav-text">http级配置解析内存结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server级别set函数"><span class="nav-number">10.3.2.</span> <span class="nav-text">server级别set函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#server级配置解析内存结构"><span class="nav-number">10.3.2.1.</span> <span class="nav-text">server级配置解析内存结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理监听端口号"><span class="nav-number">10.3.3.</span> <span class="nav-text">管理监听端口号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#对应相关数据结构"><span class="nav-number">10.3.3.1.</span> <span class="nav-text">对应相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-listen-opt-t"><span class="nav-number">10.3.3.1.1.</span> <span class="nav-text">ngx_http_listen_opt_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-url-t"><span class="nav-number">10.3.3.1.2.</span> <span class="nav-text">ngx_url_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-conf-port-t"><span class="nav-number">10.3.3.1.3.</span> <span class="nav-text">ngx_http_conf_port_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-conf-addr-t"><span class="nav-number">10.3.3.1.4.</span> <span class="nav-text">ngx_http_conf_addr_t</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#监听端口与server-虚拟主机间内存关系"><span class="nav-number">10.3.3.2.</span> <span class="nav-text">监听端口与server{}虚拟主机间内存关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set方法"><span class="nav-number">10.3.3.3.</span> <span class="nav-text">set方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-listen"><span class="nav-number">10.3.3.3.1.</span> <span class="nav-text">ngx_http_core_listen</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解析url"><span class="nav-number">10.3.3.3.2.</span> <span class="nav-text">解析url</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-parse-url"><span class="nav-number">10.3.3.3.2.1.</span> <span class="nav-text">ngx_parse_url</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-inet-add-addr"><span class="nav-number">10.3.3.3.2.2.</span> <span class="nav-text">ngx_inet_add_addr</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-inet-resolve-host"><span class="nav-number">10.3.3.3.2.3.</span> <span class="nav-text">ngx_inet_resolve_host</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#添加监听地址到ports中"><span class="nav-number">10.3.3.3.3.</span> <span class="nav-text">添加监听地址到ports中</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-listen"><span class="nav-number">10.3.3.3.3.1.</span> <span class="nav-text">ngx_http_add_listen</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-address"><span class="nav-number">10.3.3.3.3.2.</span> <span class="nav-text">ngx_http_add_address</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#gx-http-add-server"><span class="nav-number">10.3.3.3.3.3.</span> <span class="nav-text">gx_http_add_server</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-addresses"><span class="nav-number">10.3.3.3.3.4.</span> <span class="nav-text">ngx_http_add_addresses</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#server-name处理"><span class="nav-number">10.3.3.4.</span> <span class="nav-text">server_name处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相关数据结构-1"><span class="nav-number">10.3.3.4.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-server-name-t"><span class="nav-number">10.3.3.4.1.1.</span> <span class="nav-text">ngx_http_server_name_t</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#处理逻辑"><span class="nav-number">10.3.3.4.2.</span> <span class="nav-text">处理逻辑</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#server块的快速查找"><span class="nav-number">10.3.3.5.</span> <span class="nav-text">server块的快速查找</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相关数据结构-2"><span class="nav-number">10.3.3.5.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-port-t"><span class="nav-number">10.3.3.5.1.1.</span> <span class="nav-text">ngx_http_port_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-listening-t"><span class="nav-number">10.3.3.5.1.2.</span> <span class="nav-text">ngx_listening_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-in-addr-t"><span class="nav-number">10.3.3.5.1.3.</span> <span class="nav-text">ngx_http_in_addr_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-addr-conf-s"><span class="nav-number">10.3.3.5.1.4.</span> <span class="nav-text">ngx_http_addr_conf_s</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-virtual-names-t"><span class="nav-number">10.3.3.5.1.5.</span> <span class="nav-text">ngx_http_virtual_names_t</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-optimize-servers"><span class="nav-number">10.3.3.5.2.</span> <span class="nav-text">ngx_http_optimize_servers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-server-names"><span class="nav-number">10.3.3.5.3.</span> <span class="nav-text">ngx_http_server_names</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-init-listening"><span class="nav-number">10.3.3.5.4.</span> <span class="nav-text">ngx_http_init_listening</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-listening"><span class="nav-number">10.3.3.5.4.1.</span> <span class="nav-text">ngx_http_add_listening</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-addrs"><span class="nav-number">10.3.3.5.4.2.</span> <span class="nav-text">ngx_http_add_addrs</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location层set函数"><span class="nav-number">10.3.4.</span> <span class="nav-text">location层set函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#loc级配置解析内存结构"><span class="nav-number">10.3.4.1.</span> <span class="nav-text">loc级配置解析内存结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#正则表达式解析"><span class="nav-number">10.3.4.2.</span> <span class="nav-text">正则表达式解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项合并"><span class="nav-number">10.4.</span> <span class="nav-text">配置项合并</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-merge-servers"><span class="nav-number">10.4.1.</span> <span class="nav-text">ngx_http_merge_servers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-merge-locations"><span class="nav-number">10.4.2.</span> <span class="nav-text">ngx_http_merge_locations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建location配置树"><span class="nav-number">10.5.</span> <span class="nav-text">创建location配置树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http头初始化"><span class="nav-number">10.6.</span> <span class="nav-text">http头初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理阶段"><span class="nav-number">10.7.</span> <span class="nav-text">处理阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化处理阶段"><span class="nav-number">10.7.1.</span> <span class="nav-text">初始化处理阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求处理阶段"><span class="nav-number">10.7.2.</span> <span class="nav-text">请求处理阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#每个阶段的checker函数"><span class="nav-number">10.7.3.</span> <span class="nav-text">每个阶段的checker函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心模块收尾"><span class="nav-number">10.8.</span> <span class="nav-text">核心模块收尾</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事件模块"><span class="nav-number">11.</span> <span class="nav-text">事件模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解析配置-1"><span class="nav-number">11.1.</span> <span class="nav-text">解析配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-events-module模块"><span class="nav-number">11.1.1.</span> <span class="nav-text">ngx_events_module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#comands数组处理函数"><span class="nav-number">11.1.1.1.</span> <span class="nav-text">comands数组处理函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#envents：ngx-events-block"><span class="nav-number">11.1.1.1.1.</span> <span class="nav-text">envents：ngx_events_block</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ctx的init-conf-ngx-event-init-conf"><span class="nav-number">11.1.1.2.</span> <span class="nav-text">ctx的init_conf:ngx_event_init_conf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-event-core-module模块"><span class="nav-number">11.1.2.</span> <span class="nav-text">ngx_event_core_module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#相关数据结构-3"><span class="nav-number">11.1.2.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-event-module-t"><span class="nav-number">11.1.2.1.1.</span> <span class="nav-text">ngx_event_module_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-event-conf-t"><span class="nav-number">11.1.2.1.2.</span> <span class="nav-text">ngx_event_conf_t</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ctx的create-conf函数：ngx-event-core-create-conf"><span class="nav-number">11.1.2.2.</span> <span class="nav-text">ctx的create_conf函数：ngx_event_core_create_conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#comands中对应配置的处理"><span class="nav-number">11.1.2.3.</span> <span class="nav-text">comands中对应配置的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#worker-connections配置解析方法"><span class="nav-number">11.1.2.3.1.</span> <span class="nav-text">worker_connections配置解析方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#use配置解析方法"><span class="nav-number">11.1.2.3.2.</span> <span class="nav-text">use配置解析方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#debug-connections配置解析方法"><span class="nav-number">11.1.2.3.3.</span> <span class="nav-text">debug_connections配置解析方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ctx的init-conf函数：ngx-event-core-init-conf"><span class="nav-number">11.1.2.4.</span> <span class="nav-text">ctx的init_conf函数：ngx_event_core_init_conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#module的init-module方法"><span class="nav-number">11.1.2.5.</span> <span class="nav-text">module的init_module方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#module的init-process方法"><span class="nav-number">11.1.2.6.</span> <span class="nav-text">module的init_process方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-module模块"><span class="nav-number">11.1.3.</span> <span class="nav-text">ngx_epoll_module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#相关结构-5"><span class="nav-number">11.1.3.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-epoll-conf-t"><span class="nav-number">11.1.3.1.1.</span> <span class="nav-text">ngx_epoll_conf_t</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ctx的create-conf方法"><span class="nav-number">11.1.3.2.</span> <span class="nav-text">ctx的create_conf方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ctx的init-conf方法"><span class="nav-number">11.1.3.3.</span> <span class="nav-text">ctx的init_conf方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统接口"><span class="nav-number">11.2.</span> <span class="nav-text">系统接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#epoll事件驱动"><span class="nav-number">11.2.1.</span> <span class="nav-text">epoll事件驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#epoll特点"><span class="nav-number">11.2.1.1.</span> <span class="nav-text">epoll特点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#epoll使用"><span class="nav-number">11.2.1.2.</span> <span class="nav-text">epoll使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#epoll-create"><span class="nav-number">11.2.1.2.1.</span> <span class="nav-text">epoll_create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#epoll-ctl"><span class="nav-number">11.2.1.2.2.</span> <span class="nav-text">epoll_ctl</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#epoll-wait"><span class="nav-number">11.2.1.2.3.</span> <span class="nav-text">epoll_wait</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#epoll原理"><span class="nav-number">11.2.1.3.</span> <span class="nav-text">epoll原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件异步I-O"><span class="nav-number">11.2.2.</span> <span class="nav-text">文件异步I/O</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化文件异步I-O上下文"><span class="nav-number">11.2.2.1.</span> <span class="nav-text">初始化文件异步I/O上下文</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向异步I-O上下文中增删文件操作事件"><span class="nav-number">11.2.2.2.</span> <span class="nav-text">向异步I/O上下文中增删文件操作事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取已完成事件"><span class="nav-number">11.2.2.3.</span> <span class="nav-text">获取已完成事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭异步I-O上下文"><span class="nav-number">11.2.2.4.</span> <span class="nav-text">关闭异步I/O上下文</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统事件模块eventfd"><span class="nav-number">11.2.3.</span> <span class="nav-text">系统事件模块eventfd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建eventfd"><span class="nav-number">11.2.3.1.</span> <span class="nav-text">创建eventfd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读eventfd"><span class="nav-number">11.2.3.2.</span> <span class="nav-text">读eventfd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写eventfd"><span class="nav-number">11.2.3.3.</span> <span class="nav-text">写eventfd</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关键结构"><span class="nav-number">11.3.</span> <span class="nav-text">关键结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-event-s事件结构"><span class="nav-number">11.3.1.</span> <span class="nav-text">ngx_event_s事件结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-connection-t连接"><span class="nav-number">11.3.2.</span> <span class="nav-text">ngx_connection_t连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-connection-t连接池"><span class="nav-number">11.3.3.</span> <span class="nav-text">ngx_connection_t连接池</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-get-connection获取空闲事件"><span class="nav-number">11.3.3.1.</span> <span class="nav-text">ngx_get_connection获取空闲事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-free-connection释放连接"><span class="nav-number">11.3.3.2.</span> <span class="nav-text">ngx_free_connection释放连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-reusable-connection变更连接可复用性"><span class="nav-number">11.3.3.3.</span> <span class="nav-text">ngx_reusable_connection变更连接可复用性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-drain-connections加速释放可复用连接"><span class="nav-number">11.3.3.4.</span> <span class="nav-text">ngx_drain_connections加速释放可复用连接</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事件处理方法"><span class="nav-number">11.4.</span> <span class="nav-text">事件处理方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-init初始化事件模块"><span class="nav-number">11.4.1.</span> <span class="nav-text">ngx_epoll_init初始化事件模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-epoll-notify-init初始化消息提醒"><span class="nav-number">11.4.1.1.</span> <span class="nav-text">ngx_epoll_notify_init初始化消息提醒</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#notify事件触发的处理方法"><span class="nav-number">11.4.1.1.1.</span> <span class="nav-text">notify事件触发的处理方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#向notify中写入事件"><span class="nav-number">11.4.1.1.2.</span> <span class="nav-text">向notify中写入事件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-epoll-aio-init初始化文件异步I-O"><span class="nav-number">11.4.1.2.</span> <span class="nav-text">ngx_epoll_aio_init初始化文件异步I/O</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#增加异步I-O事件"><span class="nav-number">11.4.1.2.1.</span> <span class="nav-text">增加异步I/O事件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#epoll事件异步I-O返回的处理"><span class="nav-number">11.4.1.2.2.</span> <span class="nav-text">epoll事件异步I/O返回的处理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-epoll-test-rdhup测试epoll监听事件"><span class="nav-number">11.4.1.3.</span> <span class="nav-text">ngx_epoll_test_rdhup测试epoll监听事件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-process-events事件处理"><span class="nav-number">11.4.2.</span> <span class="nav-text">ngx_epoll_process_events事件处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-add-event添加事件到epoll中"><span class="nav-number">11.4.3.</span> <span class="nav-text">ngx_epoll_add_event添加事件到epoll中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-del-event从epoll中删除事件"><span class="nav-number">11.4.4.</span> <span class="nav-text">ngx_epoll_del_event从epoll中删除事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-add-connection"><span class="nav-number">11.4.5.</span> <span class="nav-text">ngx_epoll_add_connection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-del-connection客户端关闭连接"><span class="nav-number">11.4.6.</span> <span class="nav-text">ngx_epoll_del_connection客户端关闭连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-epoll-done结束事件处理"><span class="nav-number">11.4.7.</span> <span class="nav-text">ngx_epoll_done结束事件处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定时器事件"><span class="nav-number">11.5.</span> <span class="nav-text">定时器事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存时间管理"><span class="nav-number">11.5.1.</span> <span class="nav-text">缓存时间管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-time-init初始化时间"><span class="nav-number">11.5.1.1.</span> <span class="nav-text">ngx_time_init初始化时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-time-update更新时间"><span class="nav-number">11.5.1.2.</span> <span class="nav-text">ngx_time_update更新时间</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定时器方法"><span class="nav-number">11.5.2.</span> <span class="nav-text">定时器方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-event-timer-init初始化定时器红黑树"><span class="nav-number">11.5.2.1.</span> <span class="nav-text">ngx_event_timer_init初始化定时器红黑树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-event-add-timer向事件树中增加元素"><span class="nav-number">11.5.2.2.</span> <span class="nav-text">ngx_event_add_timer向事件树中增加元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-event-del-timer从事件树中删除元素"><span class="nav-number">11.5.2.3.</span> <span class="nav-text">ngx_event_del_timer从事件树中删除元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-event-find-timer查找是否存在超时事件"><span class="nav-number">11.5.2.4.</span> <span class="nav-text">ngx_event_find_timer查找是否存在超时事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-event-expire-timers执行所有的超时事件"><span class="nav-number">11.5.2.5.</span> <span class="nav-text">ngx_event_expire_timers执行所有的超时事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-event-no-timers-left检查是否所有事件均可忽略"><span class="nav-number">11.5.2.6.</span> <span class="nav-text">ngx_event_no_timers_left检查是否所有事件均可忽略</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一些重要的模块"><span class="nav-number">12.</span> <span class="nav-text">一些重要的模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pcre正则"><span class="nav-number">12.1.</span> <span class="nav-text">pcre正则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pcre-compile"><span class="nav-number">12.1.1.</span> <span class="nav-text">pcre_compile()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pcre-study-函数"><span class="nav-number">12.1.2.</span> <span class="nav-text">pcre_study()函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pcre-exec-函数"><span class="nav-number">12.1.3.</span> <span class="nav-text">pcre_exec()函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pcre-fullinfo函数"><span class="nav-number">12.1.4.</span> <span class="nav-text">pcre_fullinfo函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pcre-config函数"><span class="nav-number">12.1.5.</span> <span class="nav-text">pcre_config函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx中使用pcre"><span class="nav-number">12.2.</span> <span class="nav-text">nginx中使用pcre</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-6"><span class="nav-number">12.2.1.</span> <span class="nav-text">相关结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-regex-compile编译正则"><span class="nav-number">12.2.2.</span> <span class="nav-text">ngx_regex_compile编译正则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-regex-exec执行匹配"><span class="nav-number">12.2.3.</span> <span class="nav-text">ngx_regex_exec执行匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-regex-exec-array匹配正则数组"><span class="nav-number">12.2.4.</span> <span class="nav-text">ngx_regex_exec_array匹配正则数组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rewrite模块"><span class="nav-number">12.3.</span> <span class="nav-text">rewrite模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置解析-1"><span class="nav-number">12.3.1.</span> <span class="nav-text">配置解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-7"><span class="nav-number">12.3.2.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-rewrite-loc-conf-t"><span class="nav-number">12.3.2.1.</span> <span class="nav-text">ngx_http_rewrite_loc_conf_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-regex-compile-t"><span class="nav-number">12.3.2.2.</span> <span class="nav-text">ngx_regex_compile_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-regex-t"><span class="nav-number">12.3.2.3.</span> <span class="nav-text">ngx_http_regex_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-regex-variable-t"><span class="nav-number">12.3.2.4.</span> <span class="nav-text">ngx_http_regex_variable_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-script-engine-t"><span class="nav-number">12.3.2.5.</span> <span class="nav-text">ngx_http_script_engine_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-script-compile-t"><span class="nav-number">12.3.2.6.</span> <span class="nav-text">ngx_http_script_compile_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-script-regex-code-t"><span class="nav-number">12.3.2.7.</span> <span class="nav-text">ngx_http_script_regex_code_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-script-regex-end-code-t"><span class="nav-number">12.3.2.8.</span> <span class="nav-text">ngx_http_script_regex_end_code_t</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-location方法"><span class="nav-number">12.3.3.</span> <span class="nav-text">create location方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#commands方法"><span class="nav-number">12.3.4.</span> <span class="nav-text">commands方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rewrite配置"><span class="nav-number">12.3.4.1.</span> <span class="nav-text">rewrite配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-regex-compile"><span class="nav-number">12.3.4.1.1.</span> <span class="nav-text">ngx_http_regex_compile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-script-regex-start-code"><span class="nav-number">12.3.4.1.2.</span> <span class="nav-text">ngx_http_script_regex_start_code</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-regex-exec"><span class="nav-number">12.3.4.1.2.1.</span> <span class="nav-text">ngx_http_regex_exec</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-script-compile"><span class="nav-number">12.3.4.1.3.</span> <span class="nav-text">ngx_http_script_compile</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-script-add-capture-code"><span class="nav-number">12.3.4.1.3.1.</span> <span class="nav-text">ngx_http_script_add_capture_code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-script-add-var-code"><span class="nav-number">12.3.4.1.3.2.</span> <span class="nav-text">ngx_http_script_add_var_code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-script-add-copy-code"><span class="nav-number">12.3.4.1.3.3.</span> <span class="nav-text">ngx_http_script_add_copy_code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-script-add-args-code"><span class="nav-number">12.3.4.1.3.4.</span> <span class="nav-text">ngx_http_script_add_args_code</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-script-add-code"><span class="nav-number">12.3.4.1.4.</span> <span class="nav-text">ngx_http_script_add_code</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-script-regex-end-code"><span class="nav-number">12.3.4.1.5.</span> <span class="nav-text">ngx_http_script_regex_end_code</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#if-配置"><span class="nav-number">12.3.4.2.</span> <span class="nav-text">if 配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#merge-location方法"><span class="nav-number">12.3.5.</span> <span class="nav-text">merge location方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#postconfiguration方法"><span class="nav-number">12.3.6.</span> <span class="nav-text">postconfiguration方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-http-limit-req-module"><span class="nav-number">12.4.</span> <span class="nav-text">ngx_http_limit_req_module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构-8"><span class="nav-number">12.4.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-conf-t"><span class="nav-number">12.4.1.1.</span> <span class="nav-text">ngx_http_limit_req_conf_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-ctx-t"><span class="nav-number">12.4.1.2.</span> <span class="nav-text">ngx_http_limit_req_ctx_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-shctx-t"><span class="nav-number">12.4.1.3.</span> <span class="nav-text">ngx_http_limit_req_shctx_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-complex-value-t"><span class="nav-number">12.4.1.4.</span> <span class="nav-text">ngx_http_complex_value_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-node-t"><span class="nav-number">12.4.1.5.</span> <span class="nav-text">ngx_http_limit_req_node_t</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-location"><span class="nav-number">12.4.2.</span> <span class="nav-text">create location</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit-req-zone配置"><span class="nav-number">12.4.3.</span> <span class="nav-text">limit_req_zone配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#语法及含义"><span class="nav-number">12.4.3.1.</span> <span class="nav-text">语法及含义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解析配置方法"><span class="nav-number">12.4.3.2.</span> <span class="nav-text">解析配置方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#共享内存初始化"><span class="nav-number">12.4.3.3.</span> <span class="nav-text">共享内存初始化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit-req配置"><span class="nav-number">12.4.4.</span> <span class="nav-text">limit_req配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#语法及含义-1"><span class="nav-number">12.4.4.1.</span> <span class="nav-text">语法及含义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置解析方法"><span class="nav-number">12.4.4.2.</span> <span class="nav-text">配置解析方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他配置"><span class="nav-number">12.4.5.</span> <span class="nav-text">其他配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#merge-location方法-1"><span class="nav-number">12.4.6.</span> <span class="nav-text">merge location方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#preconfiguration方法"><span class="nav-number">12.4.7.</span> <span class="nav-text">preconfiguration方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#postconfiguration方法-1"><span class="nav-number">12.4.8.</span> <span class="nav-text">postconfiguration方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理函数ngx-http-limit-req-handler"><span class="nav-number">12.4.9.</span> <span class="nav-text">处理函数ngx_http_limit_req_handler</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-complex-value计算请求在该zone的key"><span class="nav-number">12.4.9.1.</span> <span class="nav-text">ngx_http_complex_value计算请求在该zone的key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-unlock删除当前请求在前n个zone中的记录"><span class="nav-number">12.4.9.2.</span> <span class="nav-text">ngx_http_limit_req_unlock删除当前请求在前n个zone中的记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-lookup查找节点"><span class="nav-number">12.4.9.3.</span> <span class="nav-text">ngx_http_limit_req_lookup查找节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-expire释放空闲空间"><span class="nav-number">12.4.9.4.</span> <span class="nav-text">ngx_http_limit_req_expire释放空闲空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-account获取最大延迟处理时间"><span class="nav-number">12.4.9.5.</span> <span class="nav-text">ngx_http_limit_req_account获取最大延迟处理时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-test-reading延迟处理期间读事件处理"><span class="nav-number">12.4.9.6.</span> <span class="nav-text">ngx_http_test_reading延迟处理期间读事件处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-limit-req-delay请求延时期间写事件处理"><span class="nav-number">12.4.9.7.</span> <span class="nav-text">ngx_http_limit_req_delay请求延时期间写事件处理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-http-limit-conn-module模块"><span class="nav-number">12.5.</span> <span class="nav-text">ngx_http_limit_conn_module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">12.5.1.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-conn-zone配置"><span class="nav-number">12.5.1.1.</span> <span class="nav-text">limit_conn_zone配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-conn"><span class="nav-number">12.5.1.2.</span> <span class="nav-text">limit_conn</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现原理"><span class="nav-number">12.5.2.</span> <span class="nav-text">实现原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#变量"><span class="nav-number">13.</span> <span class="nav-text">变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相关结构-9"><span class="nav-number">13.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#存储变量名的数据结构"><span class="nav-number">13.1.1.</span> <span class="nav-text">存储变量名的数据结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析变量"><span class="nav-number">13.2.</span> <span class="nav-text">解析变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#data参数不起作用"><span class="nav-number">13.2.1.</span> <span class="nav-text">data参数不起作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data参数作为指针"><span class="nav-number">13.2.2.</span> <span class="nav-text">data参数作为指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data作为内存的相对偏移量"><span class="nav-number">13.2.3.</span> <span class="nav-text">data作为内存的相对偏移量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查找变量"><span class="nav-number">13.3.</span> <span class="nav-text">查找变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-variable-index"><span class="nav-number">13.3.1.</span> <span class="nav-text">ngx_http_get_variable_index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-indexed-variable"><span class="nav-number">13.3.2.</span> <span class="nav-text">ngx_http_get_indexed_variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-flushed-variable"><span class="nav-number">13.3.3.</span> <span class="nav-text">ngx_http_get_flushed_variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-value"><span class="nav-number">13.3.4.</span> <span class="nav-text">ngx_http_get_value</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加系统变量"><span class="nav-number">13.4.</span> <span class="nav-text">添加系统变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-add-variable"><span class="nav-number">13.4.1.</span> <span class="nav-text">ngx_http_add_variable</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#外部变量和脚本引擎"><span class="nav-number">13.5.</span> <span class="nav-text">外部变量和脚本引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关数据结构-4"><span class="nav-number">13.5.1.</span> <span class="nav-text">相关数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译set脚本"><span class="nav-number">13.5.2.</span> <span class="nav-text">编译set脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量间merge"><span class="nav-number">13.6.</span> <span class="nav-text">变量间merge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#举例"><span class="nav-number">13.7.</span> <span class="nav-text">举例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#共享内存"><span class="nav-number">14.</span> <span class="nav-text">共享内存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-shm-zone-t"><span class="nav-number">14.1.</span> <span class="nav-text">ngx_shm_zone_t</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-shm-t结构"><span class="nav-number">14.2.</span> <span class="nav-text">ngx_shm_t结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#锁机制"><span class="nav-number">15.</span> <span class="nav-text">锁机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相关数据结构-5"><span class="nav-number">15.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-shmtx-t"><span class="nav-number">15.1.1.</span> <span class="nav-text">ngx_shmtx_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-shmtx-sh-t"><span class="nav-number">15.1.2.</span> <span class="nav-text">ngx_shmtx_sh_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建锁"><span class="nav-number">15.2.</span> <span class="nav-text">创建锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#销毁锁"><span class="nav-number">15.3.</span> <span class="nav-text">销毁锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#非阻塞获取锁"><span class="nav-number">15.4.</span> <span class="nav-text">非阻塞获取锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#阻塞式获取锁"><span class="nav-number">15.5.</span> <span class="nav-text">阻塞式获取锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#释放锁"><span class="nav-number">15.6.</span> <span class="nav-text">释放锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#释放信号"><span class="nav-number">15.7.</span> <span class="nav-text">释放信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#强制释放锁"><span class="nav-number">15.8.</span> <span class="nav-text">强制释放锁</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chst</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="/js/src/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '0j9TGrGA2Aq8e4SO1sUkgQCv-gzGzoHsz',
        appKey: 'Q6jotQjlp43pwpkFCJhQ9s95',
        placeholder: '请留下联系方式，我会尽快回复',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("0j9TGrGA2Aq8e4SO1sUkgQCv-gzGzoHsz", "Q6jotQjlp43pwpkFCJhQ9s95");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
