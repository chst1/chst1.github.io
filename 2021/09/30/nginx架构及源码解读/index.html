<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="nginx,">










<meta name="description" content="Nginx源码解读，正在阅读中。">
<meta name="keywords" content="nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx架构及源码阅读">
<meta property="og:url" content="http://yoursite.com/2021/09/30/nginx架构及源码解读/index.html">
<meta property="og:site_name" content="chst&#39;s Blog">
<meta property="og:description" content="Nginx源码解读，正在阅读中。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/27/WItYGR.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/05/26/2pk4cn.md.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/05/30/2ELokD.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/05/30/2EXtrq.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/06/01/2npYee.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/06/03/21Zga9.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/02/RcHHKK.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/04/RW0I2j.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/05/R5gtCn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/08/10/fGIoYn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/06/RI50gJ.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/06/R7D2DO.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/06/R7DzPs.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/07/07/Rq8iGT.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/08/01/WzSSNq.png">
<meta property="og:image" content="http://yoursite.com/Users/wangyinkui/Library/Application%20Support/typora-user-images/image-20210801153020166.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/08/03/fFttns.png">
<meta property="og:updated_time" content="2021-10-01T13:12:24.933Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx架构及源码阅读">
<meta name="twitter:description" content="Nginx源码解读，正在阅读中。">
<meta name="twitter:image" content="https://z3.ax1x.com/2021/07/27/WItYGR.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/09/30/nginx架构及源码解读/">





  <title>nginx架构及源码阅读 | chst's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">chst's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">个人网站</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/30/nginx架构及源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chst">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chst's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">nginx架构及源码阅读</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-09-30T15:39:42+08:00">
                2021-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web服务/" itemprop="url" rel="index">
                    <span itemprop="name">Web服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/09/30/nginx架构及源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/09/30/nginx架构及源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/09/30/nginx架构及源码解读/" class="leancloud_visitors" data-flag-title="nginx架构及源码阅读">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Nginx源码解读，正在阅读中。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h1><p>从官方网站下载源码包（<a href="http://nginx.org/en/download.html)。" target="_blank" rel="noopener">http://nginx.org/en/download.html)。</a></p>
<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.*.tar.gz</span><br></pre></td></tr></table></figure>
<p>编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd nginx</span><br><span class="line">./config</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./config --help</span><br></pre></td></tr></table></figure>
<p>查看config包含的参数。</p>
<p>这里主要介绍几个参数：</p>
<h2 id="—prefix-PATH"><a href="#—prefix-PATH" class="headerlink" title="—prefix=PATH"></a>—prefix=PATH</h2><p>nginx安装部署后的根目录。默认在/usr/local/nginx目录。该目录影响其他目录的相对目录。</p>
<h2 id="—sbin-path-PATH"><a href="#—sbin-path-PATH" class="headerlink" title="—sbin-path=PATH"></a>—sbin-path=PATH</h2><p>该目录是可执行文件放置的目录。默认为\<prefix>/sbin/nginx。</prefix></p>
<h2 id="—conf-path-PATH"><a href="#—conf-path-PATH" class="headerlink" title="—conf-path=PATH"></a>—conf-path=PATH</h2><p>配置文件目录。默认为\<prefix>/conf/nginx.conf。执行时读取的默认配置。</prefix></p>
<h2 id="—error-log-path-PATH"><a href="#—error-log-path-PATH" class="headerlink" title="—error-log-path=PATH"></a>—error-log-path=PATH</h2><p>error日志的放置路径。默认为\<prefix>/log/error.log。可以打印不同等级的log日志，在nginx.conf中控制。</prefix></p>
<h2 id="—pid-path-PATH"><a href="#—pid-path-PATH" class="headerlink" title="—pid-path=PATH"></a>—pid-path=PATH</h2><p>pid文件存放路径。默认为\<prefix>/log/nginx.pid。该文件以ASCII码存放着nginx master的进程ID。</prefix></p>
<h1 id="nginx的命令行控制"><a href="#nginx的命令行控制" class="headerlink" title="nginx的命令行控制"></a>nginx的命令行控制</h1><h2 id="直接执行Nginx二进制文件"><a href="#直接执行Nginx二进制文件" class="headerlink" title="直接执行Nginx二进制文件"></a>直接执行Nginx二进制文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>读取默认配置文件</p>
<h2 id="指定配置文件"><a href="#指定配置文件" class="headerlink" title="指定配置文件"></a>指定配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -c 配置文件路径</span><br></pre></td></tr></table></figure>
<h2 id="另行指定全局配置项"><a href="#另行指定全局配置项" class="headerlink" title="另行指定全局配置项"></a>另行指定全局配置项</h2><p>-g</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -g &quot;pid /tem/test.pid;&quot;</span><br></pre></td></tr></table></figure>
<p>这时，pid文件将写到<code>/tem/test.pid</code>。-g的配置不能与nginx.conf不一致。</p>
<p>对于以-g启动的nginx来说，要执行其他操作，也应该包含-g参数，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -g &quot;pid /tem/test.pid;&quot; -s stop</span><br></pre></td></tr></table></figure>
<h2 id="测试配置信息是否错误"><a href="#测试配置信息是否错误" class="headerlink" title="测试配置信息是否错误"></a>测试配置信息是否错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure>
<h2 id="显示版本"><a href="#显示版本" class="headerlink" title="显示版本"></a>显示版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -v</span><br></pre></td></tr></table></figure>
<h2 id="显示编译阶段参数"><a href="#显示编译阶段参数" class="headerlink" title="显示编译阶段参数"></a>显示编译阶段参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>
<h2 id="快速停止服务"><a href="#快速停止服务" class="headerlink" title="快速停止服务"></a>快速停止服务</h2><p>-s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br></pre></td></tr></table></figure>
<p>-s参数是告诉Nginx向正在运行的服务发送信号。直接使用kill也是可以的。</p>
<h2 id="优雅的停止服务"><a href="#优雅的停止服务" class="headerlink" title="优雅的停止服务"></a>优雅的停止服务</h2><p>关闭监听端口，处理完当前所有请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s quit</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s SIGQIT masterpid</span><br></pre></td></tr></table></figure>
<p>停止某个worker进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s SIGQIT workerpid</span><br></pre></td></tr></table></figure>
<h1 id="Nginx的配置"><a href="#Nginx的配置" class="headerlink" title="Nginx的配置"></a>Nginx的配置</h1><p>部署Nginx是，都是使用一个master进程来管理多个worker进程，一般worker进程数量与服务器中的CPU核心数一致。</p>
<h2 id="配置demo"><a href="#配置demo" class="headerlink" title="配置demo"></a>配置demo</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> nobody;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_process</span> <span class="number">8</span>;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log <span class="literal">error</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#pid logs/nginx.pid</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">500000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">include</span> mime.types;</span><br><span class="line">  <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">    <span class="string">'<span class="variable">$status</span> <span class="variable">$bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">    <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line">  <span class="attribute">access_log</span> logs/access.log main buffer=<span class="number">32k</span>;</span><br><span class="line">   </span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="块配置"><a href="#块配置" class="headerlink" title="块配置"></a>块配置</h2><p>块配置项由一个块配置名和一对大括号组成。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    ...;</span><br><span class="line">    <span class="attribute">location</span> /webstatic &#123;</span><br><span class="line">      <span class="attribute">gzip</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的events、http、server、location、upstream都是块配置项，块配置项可以嵌套。</p>
<h2 id="配置项语法"><a href="#配置项语法" class="headerlink" title="配置项语法"></a>配置项语法</h2><p>基本的配置项语法为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置项名 配置项值1 配置项值2 ... ;</span><br></pre></td></tr></table></figure>
<p>配置项值可以是数字，字符串，正则表达式，这取决于该配置项名实际需求。（这个有点像是函数名和参数的关系）。</p>
<h2 id="配置项单位"><a href="#配置项单位" class="headerlink" title="配置项单位"></a>配置项单位</h2><p>指定大小时，可以使用的单位包括：</p>
<ol>
<li>K或者k字节（KiB）</li>
<li>M或者m字节（MiB）</li>
</ol>
<p>指定时间时，可以使用：</p>
<ol>
<li>ms（毫秒）</li>
<li>s（秒）</li>
<li>m（分钟）</li>
<li>h（小时）</li>
<li>d（天）</li>
<li>w（周）</li>
<li>M（月，30天）</li>
<li>y（年，365天）</li>
</ol>
<h2 id="配置中使用变量"><a href="#配置中使用变量" class="headerlink" title="配置中使用变量"></a>配置中使用变量</h2><p>部分模块可以使用变量，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format main &apos;$remote_addr [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">    &apos;$status $bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br></pre></td></tr></table></figure>
<p>变量前加上<code>$</code>。</p>
<h2 id="nginx提供的基础服务"><a href="#nginx提供的基础服务" class="headerlink" title="nginx提供的基础服务"></a>nginx提供的基础服务</h2><h3 id="用语调试和定位问题的配置"><a href="#用语调试和定位问题的配置" class="headerlink" title="用语调试和定位问题的配置"></a>用语调试和定位问题的配置</h3><h4 id="是否以守护进程来执行"><a href="#是否以守护进程来执行" class="headerlink" title="是否以守护进程来执行"></a>是否以守护进程来执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">daemon on|off</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">daemon on</span><br></pre></td></tr></table></figure>
<h4 id="是否以master-worker方式进行工作"><a href="#是否以master-worker方式进行工作" class="headerlink" title="是否以master/worker方式进行工作"></a>是否以master/worker方式进行工作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master_process on|off</span><br><span class="line"></span><br><span class="line">#deault</span><br><span class="line">master_process on</span><br></pre></td></tr></table></figure>
<h4 id="error日志设置"><a href="#error日志设置" class="headerlink" title="error日志设置"></a>error日志设置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_log /path/file level</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">error_log logs/error.log error</span><br></pre></td></tr></table></figure>
<p>当指定<code>/path/file</code>为<code>/dev/null</code>时即关闭日志。</p>
<p><code>level</code>为日志级别。取值为<code>debug</code> <code>info</code> <code>notice</code> <code>warn</code> <code>error</code> <code>crit</code> <code>alert</code> <code>emerg</code>。从左到右等级依次升高。指定的等级时，大于等于该等级的日志都会输出。</p>
<h4 id="设置特殊的调试点"><a href="#设置特殊的调试点" class="headerlink" title="设置特殊的调试点"></a>设置特殊的调试点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug_points [stop|abort]</span><br></pre></td></tr></table></figure>
<p>nginx在关键逻辑中设置了调试点。如果设置为stop，则nginx代码运行到这些调试点就会发出SIGSTOP信号以用于调试。如果设置为abort，则会产生一个coredump文件，可以使用gdb来查看。</p>
<h4 id="对指定客户端输出debug级别日志"><a href="#对指定客户端输出debug级别日志" class="headerlink" title="对指定客户端输出debug级别日志"></a>对指定客户端输出debug级别日志</h4><p>该配置属于事件类型配置，要放在events中才有效，起值可以是IP地址或者CIDR地址，如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">debug_connection</span> <span class="number">10.224.66.14</span>;</span><br><span class="line">  <span class="attribute">debug_connection</span> <span class="number">10.224.57.0</span>/<span class="number">24</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，只有配置的IP才会打印debug级别日志，其他请求仍然沿用error_log中配置的日志级别。</p>
<h4 id="限制coredump核心转储文件大小"><a href="#限制coredump核心转储文件大小" class="headerlink" title="限制coredump核心转储文件大小"></a>限制coredump核心转储文件大小</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_core size;</span><br></pre></td></tr></table></figure>
<h4 id="指定coredump文件生成目录"><a href="#指定coredump文件生成目录" class="headerlink" title="指定coredump文件生成目录"></a>指定coredump文件生成目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">working_directory path;</span><br></pre></td></tr></table></figure>
<h3 id="正常运行配置"><a href="#正常运行配置" class="headerlink" title="正常运行配置"></a>正常运行配置</h3><h4 id="定义环境变量"><a href="#定义环境变量" class="headerlink" title="定义环境变量"></a>定义环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env VAR|VAR=VALUE</span><br></pre></td></tr></table></figure>
<p>该配置可以让用户直接设置操作系统上的环境变量。仅是变更运行时使用的环境变量。</p>
<h4 id="嵌入其他配置"><a href="#嵌入其他配置" class="headerlink" title="嵌入其他配置"></a>嵌入其他配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /path/file</span><br></pre></td></tr></table></figure>
<p>将其他配置文件嵌入到当前配置中，参数可以是绝对路径，也可以是相对路径（相对于当前配置文件的目录）。路径可以是字符串和正则表达式。</p>
<h4 id="pid文件路径"><a href="#pid文件路径" class="headerlink" title="pid文件路径"></a>pid文件路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pid path/file</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">pid logs/nginx.pid</span><br></pre></td></tr></table></figure>
<p>master进程的pid</p>
<h4 id="nginx进程运行的用户及用户组"><a href="#nginx进程运行的用户及用户组" class="headerlink" title="nginx进程运行的用户及用户组"></a>nginx进程运行的用户及用户组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user username [groupname]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">user nobody nobody</span><br></pre></td></tr></table></figure>
<h4 id="worker进程最大句柄描述符个数"><a href="#worker进程最大句柄描述符个数" class="headerlink" title="worker进程最大句柄描述符个数"></a>worker进程最大句柄描述符个数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile limit;</span><br></pre></td></tr></table></figure>
<h4 id="限制信号队列"><a href="#限制信号队列" class="headerlink" title="限制信号队列"></a>限制信号队列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_sigpending limit;</span><br></pre></td></tr></table></figure>
<p>设置每个用户发往nginx的信号队列大小，当超过该值时，该用户发送的信号将被丢弃。</p>
<h3 id="性能优化配置"><a href="#性能优化配置" class="headerlink" title="性能优化配置"></a>性能优化配置</h3><h4 id="nginx的worker进程数"><a href="#nginx的worker进程数" class="headerlink" title="nginx的worker进程数"></a>nginx的worker进程数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_processes number;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">worker_processes 1;</span><br></pre></td></tr></table></figure>
<h4 id="绑定nginx的worker进程到指定的CPU内核"><a href="#绑定nginx的worker进程到指定的CPU内核" class="headerlink" title="绑定nginx的worker进程到指定的CPU内核"></a>绑定nginx的worker进程到指定的CPU内核</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity cpumask [cpumask, ...]</span><br></pre></td></tr></table></figure>
<p>避免多个worker进程抢占同一个cpu，设置每个进程绑定的cpu内核来加速。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  8;</span><br><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span><br></pre></td></tr></table></figure>
<h3 id="事件类配置-都在event块中"><a href="#事件类配置-都在event块中" class="headerlink" title="事件类配置(都在event块中)"></a>事件类配置(都在event块中)</h3><h4 id="是否打开负载均衡锁"><a href="#是否打开负载均衡锁" class="headerlink" title="是否打开负载均衡锁"></a>是否打开负载均衡锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex [on|off]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">accept_mutex on;</span><br></pre></td></tr></table></figure>
<p>Accept_mutex是nginx的负载均衡锁。该锁来让各个worker进程直接负载均衡。关闭该锁可以加快TCP连接速度，但会导致负载不均衡。</p>
<h4 id="lock文件路径"><a href="#lock文件路径" class="headerlink" title="lock文件路径"></a>lock文件路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lock_file path/file;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">lock_file logs/nginx.lock;</span><br></pre></td></tr></table></figure>
<p>存储负载均衡锁所需文件路径。</p>
<h4 id="使用accept锁后未建立连接后等待时间"><a href="#使用accept锁后未建立连接后等待时间" class="headerlink" title="使用accept锁后未建立连接后等待时间"></a>使用accept锁后未建立连接后等待时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex_delay Nms;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">accept_mutex_delay 500ms;</span><br></pre></td></tr></table></figure>
<p>使用accept锁后，每个时刻，只能有一个worker进程能够获取accept锁。该accept不是阻塞锁，没有获取就会立即返回。如果一个worker进程尝试获取accept锁没有获得时，至少要等到accept_mutex_delay时间才能再次获取。</p>
<h4 id="批量建立新连接"><a href="#批量建立新连接" class="headerlink" title="批量建立新连接"></a>批量建立新连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">multi_accept [on|off];</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">multi_accept off;</span><br></pre></td></tr></table></figure>
<p>当事件模型通知有新连接时，尽可能地对本次调度中客户端发起的所有TCP请求都建立连接。</p>
<h4 id="选择事件模型"><a href="#选择事件模型" class="headerlink" title="选择事件模型"></a>选择事件模型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use [kqueue|rtsig|epoll|/dev/poll|select|poll|eventport]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">use 最适合的（nginx自己寻找）。</span><br></pre></td></tr></table></figure>
<h4 id="每个master的最大连接数"><a href="#每个master的最大连接数" class="headerlink" title="每个master的最大连接数"></a>每个master的最大连接数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_connections number;</span><br></pre></td></tr></table></figure>
<h1 id="用HTTP核心模块配置一个静态服务器"><a href="#用HTTP核心模块配置一个静态服务器" class="headerlink" title="用HTTP核心模块配置一个静态服务器"></a>用HTTP核心模块配置一个静态服务器</h1><h2 id="虚拟主机与请求的分发"><a href="#虚拟主机与请求的分发" class="headerlink" title="虚拟主机与请求的分发"></a>虚拟主机与请求的分发</h2><p>由于IP地址限制，存在多个主机域名对应同一IP地址的情况，这时在nginx.conf中按照server_name(对应用户请求中的主机域名）并通过server块来定义虚拟机，每个server块就是一个虚拟机，它只处理与之相对应的主机域名请求。这样，一台服务器上的nginx就能够以不同方式处理访问不同主机域名的HTTP的请求了。</p>
<h3 id="监听端口"><a href="#监听端口" class="headerlink" title="监听端口"></a>监听端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen address:port [default(deprecated in 0.8.21) | default_server | [backlog=num | rcvbuf=size | sndbuf=size | accept_filter=filter | deferred | bind | ipv6only=[on|off] ssl]];</span><br><span class="line"></span><br><span class="line">#default </span><br><span class="line">listion 80;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>listen决定nginx服务监听端口。listen后可以加IP地址、端口号或者主机名。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen 127.0.0.1:8002;</span><br><span class="line">listen 127.0.0.1; //default port 80</span><br><span class="line">listen *:8000;</span><br></pre></td></tr></table></figure>
<p>地址后可以加其他参数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>将所在server块作为整个web服务的默认server块。当一个请求无法匹配配置文件中的所有主机域名时，就会选择默认虚拟主机。如果所有server都未指定，则默认选第一个。</td>
</tr>
<tr>
<td>backlog=num</td>
<td>TCP中backlog大小。（默认-1，无限制）在TCP建立三次连接时，进程还未监听句柄，此时backlog队列将会放置这些连接。如果backlog已满，还有客户端企图建立连接，则会失败。</td>
</tr>
<tr>
<td>rcvbuf=size</td>
<td>设置监听句柄的SO_RCVBUF参数。</td>
</tr>
<tr>
<td>sndbuf=size</td>
<td>设置监听句柄的SO_SNDBUF参数。</td>
</tr>
<tr>
<td>Accept_filter</td>
<td>设置accept过滤，只对FreeBSD系统有用。</td>
</tr>
<tr>
<td>deferred</td>
<td>设置该参数时，若用户建立了TCP连接（三次握手），内核也不会对该连接调度worker进程来处理，只会在用户真正发送请求时才会分配worker进程。使用于大并发情况下。</td>
</tr>
<tr>
<td>bind</td>
<td>绑定当前端口/地址对，如127.0.0.1:8000。</td>
</tr>
<tr>
<td>ssl</td>
<td>在当前监听的端口上建立的连接必须基于SSL。</td>
</tr>
</tbody>
</table>
</div>
<h3 id="主机名称"><a href="#主机名称" class="headerlink" title="主机名称"></a>主机名称</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_name name [...];</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">server_name &quot;&quot;;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>Server_name后面可以有多个主机名称，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name www.testweb.com download.testweb.com</span><br></pre></td></tr></table></figure>
<p>在开始处理一个HTTP请求时，nginx会取出header头中的Host，与每个server中的server_name进行比对，以决定由哪个server块来处理该请求。server_name与Host匹配优先级为：</p>
<ol>
<li>最先选择完全匹配的</li>
<li>其次选择通配符在前面的，如*.testweb.com</li>
<li>再次选择通配符在后面的，如www.testweb.*</li>
<li>最后选择使用正则表达式的，如~^\.testweb.com$</li>
</ol>
<p>Server_name后面是空字符串时，表示匹配没有这个host这个http头的请求。</p>
<h3 id="server-name-hash-bucket-size"><a href="#server-name-hash-bucket-size" class="headerlink" title="server_name_hash_bucket_size"></a>server_name_hash_bucket_size</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_name_hash_bucket_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">server_name_hash_bucket_size 32|64|128;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http server location</span><br></pre></td></tr></table></figure>
<p>为快速寻找对应server_name能力，nginx使用散列来存储server name。server_name_hash_bucket_size设置每个散列桶占用内存大小。</p>
<h3 id="重定向主机名称处理"><a href="#重定向主机名称处理" class="headerlink" title="重定向主机名称处理"></a>重定向主机名称处理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_name_in_redirect on|off;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">server_name_in_redirect on|off;</span><br><span class="line"></span><br><span class="line"># conf block</span><br><span class="line">http server location</span><br></pre></td></tr></table></figure>
<p>该配置配合server_name使用。在打开on时，表示重定向请求时会使用server_name的配置的第一个主机名代替原先请求的Host，使用off时，表示重定向时使用请求本身的Host。</p>
<h3 id="location"><a href="#location" class="headerlink" title="location"></a>location</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location [=|~|~*|^~|@] /uri/ &#123;...&#125;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>location尝试根据用户请求中的URI来匹配上面的/uri表达式，如果可以匹配，就选择location块中的请求来处理。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>把URI作为字符串，与参数的uri做完全匹配</td>
<td>Location = / {}</td>
</tr>
<tr>
<td><code>~</code></td>
<td>匹配URI时是大小写敏感的</td>
<td></td>
</tr>
<tr>
<td><code>~*</code></td>
<td>忽略大小写</td>
<td></td>
</tr>
<tr>
<td><code>^~</code></td>
<td>匹配前半部分uri即可。</td>
<td></td>
</tr>
<tr>
<td><code>@</code></td>
<td>表示仅用于nginx服务内部请求之间的重定向，带有@的请求不直接处理用户请求。</td>
</tr>
</tbody>
</table>
</div>
<p>最常用的是uri为正则表达式。</p>
<h2 id="文件路径的定义"><a href="#文件路径的定义" class="headerlink" title="文件路径的定义"></a>文件路径的定义</h2><h3 id="以root方式设置资源路径"><a href="#以root方式设置资源路径" class="headerlink" title="以root方式设置资源路径"></a>以root方式设置资源路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root path</span><br><span class="line"></span><br><span class="line"># default</span><br><span class="line">root html</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http, server, location, if</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /download/ &#123;</span><br><span class="line">  <span class="attribute">root</span> /opt/web/html/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于上面的配置，如果有一个请求的URI是/download/index/test.html，那么web服务器返回服务器上/opt/web/html/download/index/test.html文件的内容。</p>
<h3 id="alias方式设置资源路径"><a href="#alias方式设置资源路径" class="headerlink" title="alias方式设置资源路径"></a>alias方式设置资源路径</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alias path;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">location</span><br></pre></td></tr></table></figure>
<p>alias也是用来设置文件资源路径，与root不同点主要在于如何解读跟在location后面的uri参数，这使得alias与root以不同的方式将用户请求映射到真正的磁盘文件上。例如，如果一个请求的URI是/conf/nginx.conf，而用户实际希望访问的文件在/usr/location/nginx/conf/nginx.conf。中，如果想要使用alias来进行设置的话，可以采用如下形式：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /conf &#123;</span><br><span class="line">  <span class="attribute">alias</span> /usr/local/nginx/conf/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用root，则语句如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /conf &#123;</span><br><span class="line">  <span class="attribute">root</span> /usr/location/nginx/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用alias时，在URI向实际路径的映射过程中，已经将location后配置的/conf部分去除了，因此/conf/nginx.conf请求将根据alias path映射为path/nginx.conf。root则会根据完整的URI请求来映射，因此root会根据root path映射为path/conf/nginx.conf。</p>
<p>alias后面还可以添加正则表达式，例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> ~^/test/(\w+)\.(w+)$ &#123;</span><br><span class="line">  <span class="attribute">alias</span> /usr/location/nginx/<span class="variable">$2</span>/<span class="variable">$1</span>.<span class="variable">$2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="访问首页"><a href="#访问首页" class="headerlink" title="访问首页"></a>访问首页</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index file</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">index index.html</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http, server, location</span><br></pre></td></tr></table></figure>
<p>有时，访问站点的URI为/，这一般是网页站点，这与root和alias都不同，使用nginx_http_index_module模块提供的index配置实现。index后面可以更多个文件参数，nginx会按顺序访问这些文件，例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">root</span> path;</span><br><span class="line">  <span class="attribute">index</span> index.html, /html/index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="根据http返回码重定向页面"><a href="#根据http返回码重定向页面" class="headerlink" title="根据http返回码重定向页面"></a>根据http返回码重定向页面</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_page code[code...][=|=answer-code] uri | @named_location</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location,if</span><br></pre></td></tr></table></figure>
<p>对于某个请求返回错误码时，如果匹配上了error_page中设置的code，则重定向到新的URI中，例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span>  /<span class="number">404</span>.html</span><br><span class="line">error_page <span class="number">502</span> <span class="number">504</span> <span class="number">504</span> /50x.html</span><br><span class="line">error_page <span class="number">403</span> http://example.com/forbidden.html</span><br><span class="line">error_page <span class="number">404</span> = <span class="variable">@fetch</span></span><br></pre></td></tr></table></figure>
<p>注意，虽然重定向了URI，但返回的HTTP错误码还是原来的错误码。可以通过’=’来更改返回的错误码，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error_page 404 = 200  /empty.html;</span><br><span class="line">error_page 404 = 403  /forbidden.gif;</span><br></pre></td></tr></table></figure>
<p>也可以不指定确切的错误码，而是由重定向后时间处理的真实结果来决定，这时只要把=后面的错误码去掉即可，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page 404  /empty.html;</span><br></pre></td></tr></table></figure>
<p>如果不想修改URI，只是想让请求重定向到另一个location中进行处理，那么可以设置为：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">404</span> <span class="variable">@fallback</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="variable">@fallback</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，出现404错误时，请求转发到反向代理<a href="http://backend服务上。" target="_blank" rel="noopener">http://backend服务上。</a></p>
<h3 id="是否允许递归使用error-page"><a href="#是否允许递归使用error-page" class="headerlink" title="是否允许递归使用error_page"></a>是否允许递归使用error_page</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">recursive_error_pages [on|off];</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">recursive_error_pages off;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<h3 id="try-file"><a href="#try-file" class="headerlink" title="try_file"></a>try_file</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">try_file path1[path2] uri;</span><br><span class="line"></span><br><span class="line">#conf bloak</span><br><span class="line">server,location</span><br></pre></td></tr></table></figure>
<p>try_file后跟若果路径，如path1，path2…，最后必须要有uri参数，意义为：尝试顺序访问每一个path，如果可以有效获取，就直接向用户返回对于的文件请求，并结束，否则接着向下访问，如果所有path都找不到，则重定向到最后的uri上。例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">try_file</span> /sys/main.html <span class="variable">$uri</span> <span class="variable">$uri</span>/index/html <span class="variable">$uri</span>.html <span class="variable">@other</span>;</span><br><span class="line"><span class="attribute">location</span> <span class="variable">@other</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>一个网页，要访问服务器上3个页面，为路径$path下的index.html,master.html和slave.html，其中index.html是首页，其请求的uri为/。后面两个文件是index.html返回后，请求的两个页面，请求的uri分别为/showmaster/和/showslave/。此时，nginx配置可设置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">error_log /home/work/error.log debug;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    log_format main &apos;&quot;$request&quot;&apos;;</span><br><span class="line">    access_log /home/work/debug.log main;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8894;</span><br><span class="line">        location ~* ^/show([a-z]+)\/$ &#123;</span><br><span class="line">           root path/$1.html;</span><br><span class="line">        &#125;</span><br><span class="line">       location / &#123;</span><br><span class="line">           root path;</span><br><span class="line">           index index.html;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内存及磁盘资源的分配"><a href="#内存及磁盘资源的分配" class="headerlink" title="内存及磁盘资源的分配"></a>内存及磁盘资源的分配</h2><h3 id="HTTP包体只存储在磁盘文件中"><a href="#HTTP包体只存储在磁盘文件中" class="headerlink" title="HTTP包体只存储在磁盘文件中"></a>HTTP包体只存储在磁盘文件中</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_in_file_only on | clean | off</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_in_file_only off</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>当设置为非off时，用户请求的HTTP包体一律存储到磁盘文件中，即使只有0字节也会存储为文件。当配置结束时，如果设置为on，则该文件不会被删除（常用于调试），如果配置为clean，则会在请求结束，清除文件。</p>
<h3 id="HTTP包体尽量写到一个内存buffer中"><a href="#HTTP包体尽量写到一个内存buffer中" class="headerlink" title="HTTP包体尽量写到一个内存buffer中"></a>HTTP包体尽量写到一个内存buffer中</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_in_single_buffer on | off</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_in_single_buffer off</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>配置on时，HTTP包体一律存储到内存buffer。如果大小超过了client_body_buffer_size值，包体依然会写入磁盘。</p>
<h3 id="存储HTTP请求头部的内存大小"><a href="#存储HTTP请求头部的内存大小" class="headerlink" title="存储HTTP请求头部的内存大小"></a>存储HTTP请求头部的内存大小</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_header_buffer_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_header_buffer_size 1k</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>该配置定义了正常情况下Nginx接收用户请求中HTTP header部分（包括HTTP行和HTTP头部）分配的内存buffer大小。当HTTP header部分超过该值时，定义的buffer大小将失效。</p>
<h3 id="存储超大HTTP头部的内存buffer大小"><a href="#存储超大HTTP头部的内存buffer大小" class="headerlink" title="存储超大HTTP头部的内存buffer大小"></a>存储超大HTTP头部的内存buffer大小</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lager_client_header_buffer number size;</span><br><span class="line"></span><br><span class="line">#defult</span><br><span class="line">lager_client_header_buffer 4 8k;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>订阅了Nginx接收一个超大HTTP头部请求的buffer个数和每个buffer大小。如果请求行（如GET /index HTTP/1.1）大小超过上面单个大小限制时，返回Request URI too large（414）。请求中有很多header，每个header的大小也不能超过单个buffer大小，否则会返回Bad request（400）。请求行和请求头总数也不能超过buffer个数*buffer大小。</p>
<h3 id="存储HTTP包体的内存buffer大小"><a href="#存储HTTP包体的内存buffer大小" class="headerlink" title="存储HTTP包体的内存buffer大小"></a>存储HTTP包体的内存buffer大小</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_buffer_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_buffer_size 8k/16k;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>定义了Nginx接收http请求包体的内存缓冲区大小。即HTTP包体会先接收到指定的缓存中，再决定是否写入磁盘。</p>
<h3 id="HTTP包体临时存放目录"><a href="#HTTP包体临时存放目录" class="headerlink" title="HTTP包体临时存放目录"></a>HTTP包体临时存放目录</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_temp_path dir-path [level1 [level2 [level3]]]</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_temp_path client_body_temp</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>配置包体存放的临时目录。包体大小超过client_body_buffer_size指定大小时，会以递增的整数命名并存放到client_body_temp_path指定目录。后面的level1，level2，level3是防止一个目录文件过多，影响性能，使用level参数，可以按文件临时名再多加3层目录。</p>
<h3 id="connection-pool-size"><a href="#connection-pool-size" class="headerlink" title="connection_pool_size"></a>connection_pool_size</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connection_pool_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">connection_pool_size 256;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>Nginx对每一个建立的成功的TCP连接会预先分配一个内存池，这里size指定内存池初始大小，用于减少对小块内存的分配次数。过大的size导致内存资源浪费，过小的size，导致重复分配次数增加，影响性能，谨慎设置。</p>
<h3 id="request-pool-size"><a href="#request-pool-size" class="headerlink" title="request_pool_size"></a>request_pool_size</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">request_pool_size size;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">request_pool_size 4k</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server</span><br></pre></td></tr></table></figure>
<p>Nginx开始处理HTTP请求时，会为每个请求都分配一个内存池。这里size指定内存池初始大小，用于减少对小块内存的分配次数。TCP连接关闭时会销毁connection_pool_size指定的内存池，HTTP请求结束会销毁request_pool_size指定的内存池，但其创建和销毁时间并不一致，因为一个TCP连接可能被复用于多个HTTP请求。</p>
<h2 id="网络连接设置"><a href="#网络连接设置" class="headerlink" title="网络连接设置"></a>网络连接设置</h2><h3 id="读取HTTP头部超时时间"><a href="#读取HTTP头部超时时间" class="headerlink" title="读取HTTP头部超时时间"></a>读取HTTP头部超时时间</h3><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_header_timeout time(s)</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_header_timeout 60;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http，server，location</span><br></pre></td></tr></table></figure>
<p>客户端与服务器建立TCP连接后将开始接收HTTP头部，在这个过程中，如果在一个时间间隔内没有读取到客户端发来的字节，则认为超时，向客户端返回408（Request timed out）响应。</p>
<h3 id="读取HTTP包体超时时间"><a href="#读取HTTP包体超时时间" class="headerlink" title="读取HTTP包体超时时间"></a>读取HTTP包体超时时间</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_timeout time(s);</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">client_body_timeout 60;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>与client_header_timeout类似，不过使用在读取http包体。</p>
<h3 id="发送响应超时时间"><a href="#发送响应超时时间" class="headerlink" title="发送响应超时时间"></a>发送响应超时时间</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">send_timeout time;</span><br><span class="line"></span><br><span class="line">#default</span><br><span class="line">send_timeout 60;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">http,server,location</span><br></pre></td></tr></table></figure>
<p>Nginx向客户端发送数据包，客户端一直没有接收数据包，超过超时响应时间后，Nginx关闭连接。</p>
<p>还有很多网络连接配置，看书。</p>
<h1 id="Nginx常用数据结构"><a href="#Nginx常用数据结构" class="headerlink" title="Nginx常用数据结构"></a>Nginx常用数据结构</h1><h2 id="ngx-buf-t"><a href="#ngx-buf-t" class="headerlink" title="ngx_buf_t"></a>ngx_buf_t</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_buf_s</span>  <span class="title">ngx_buf_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_buf_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// pos通常表示从该位置处理内存中的数据</span></span><br><span class="line">    u_char          *pos;</span><br><span class="line">    <span class="comment">// last表示有效内容的结尾。ps到last的内存是nginx需要处理的内容</span></span><br><span class="line">    u_char          *last;</span><br><span class="line">    <span class="comment">// 处理文件时，file_post与file_last和处理内存时的pos与last相同</span></span><br><span class="line">    <span class="keyword">off_t</span>            file_pos;</span><br><span class="line">    <span class="keyword">off_t</span>            file_last;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果ngx_buf_t缓冲区用于内存，那么start指向这段内存的起始地址</span></span><br><span class="line">    u_char          *start;         <span class="comment">/* start of buffer */</span></span><br><span class="line">    <span class="comment">// 如果ngx_buf_t缓冲区用于内存，那么start指向这段内存的结束地址</span></span><br><span class="line">    u_char          *end;           <span class="comment">/* end of buffer */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 表示当前缓冲区类型，例如由哪个模块使用，就执行该模块的ngx_module_t变量的地址</span></span><br><span class="line">    <span class="keyword">ngx_buf_tag_t</span>    tag;</span><br><span class="line">    <span class="comment">// 引用的文件</span></span><br><span class="line">    <span class="keyword">ngx_file_t</span>      *file;</span><br><span class="line">    <span class="comment">// 当前缓冲区的影子缓冲区，使用较少。</span></span><br><span class="line">    <span class="keyword">ngx_buf_t</span>       *shadow;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the buf's content could be changed */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         temporary:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the buf's content is in a memory cache or in a read only memory</span></span><br><span class="line"><span class="comment">     * and must not be changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         memory:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the buf's content is mmap()ed and must not be changed */</span></span><br><span class="line">    <span class="keyword">unsigned</span>         mmap:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否可回收</span></span><br><span class="line">    <span class="keyword">unsigned</span>         recycled:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 处理的是否为文件</span></span><br><span class="line">    <span class="keyword">unsigned</span>         in_file:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否需要flush</span></span><br><span class="line">    <span class="keyword">unsigned</span>         flush:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否使用同步方式，需谨慎考虑，可能会阻塞nginx。sync为1时可能会以阻塞的方式进行I/O</span></span><br><span class="line">    <span class="keyword">unsigned</span>         sync:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否为最后一个缓冲区。因为ngx_buf_t可以由ngx_chain_t链表串联起来。</span></span><br><span class="line">    <span class="keyword">unsigned</span>         last_buf:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 是否为ngx_chain_t中最后一个缓冲区</span></span><br><span class="line">    <span class="keyword">unsigned</span>         last_in_chain:<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省份为最后一个影子缓冲区，与shadow配合使用</span></span><br><span class="line">    <span class="keyword">unsigned</span>         last_shadow:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 当前缓冲区是否为临时文件</span></span><br><span class="line">    <span class="keyword">unsigned</span>         temp_file:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* STUB */</span> <span class="keyword">int</span>   num;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ngx_buf_t为缓存区结构。</p>
<h2 id="散列表（ngx-hash-t）"><a href="#散列表（ngx-hash-t）" class="headerlink" title="散列表（ngx_hash_t）"></a>散列表（ngx_hash_t）</h2><p>存储散列表的类有如下三个相关结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash基础数据类</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>         key;  <span class="comment">// key值</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        key_hash; <span class="comment">// key经过ngx_hash_key_pt转换的类</span></span><br><span class="line">    <span class="keyword">void</span>             *value; <span class="comment">// key对应的值</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_key_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 散列表中存储的每个数据</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>             *value;  <span class="comment">// 对应存储的数据</span></span><br><span class="line">    u_short           len;    <span class="comment">// name长度</span></span><br><span class="line">    u_char            name[<span class="number">1</span>];  <span class="comment">// key值，name</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_elt_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际存储散列表的结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_hash_elt_t</span>  **buckets; <span class="comment">// 存储数据内容。为了解决冲突，因此是一个二维数组。</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        size;    <span class="comment">// 桶大小，多少个桶</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用来构建散列表的结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_hash_t</span>       *hash;</span><br><span class="line">    ngx_hash_key_pt   key; <span class="comment">// 将数据的key进行转换的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        max_size; <span class="comment">// hash表中的桶的个数。该字段越大，元素存储时冲突的可能性越小，每个桶中存储的元素会更少，则查询起来的速度更快。当然，这个值越大，越造成内存的浪费也越大，(实际上也浪费不了多少)。</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        bucket_size; <span class="comment">// 每个桶的最大限制大小，单位是字节。如果在初始化一个hash表的时候，发现某个桶里面无法存的下所有属于该桶的元素，则hash表初始化失败。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>             *name;  <span class="comment">// 散列表的名称</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *pool; <span class="comment">// 内存池</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *temp_pool; <span class="comment">// 临时内存池</span></span><br><span class="line">&#125; <span class="keyword">ngx_hash_init_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_uint_t</span> <span class="params">(*ngx_hash_key_pt)</span> <span class="params">(u_char *data, <span class="keyword">size_t</span> len)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="散列表构建"><a href="#散列表构建" class="headerlink" title="散列表构建"></a>散列表构建</h3><p>构建hash表使用函数ngx_hash_init:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_HASH_ELT_SIZE(name)                                               \</span></span><br><span class="line">    (<span class="keyword">sizeof</span>(<span class="keyword">void</span> *) + ngx_align((name)-&gt;key.len + <span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)))</span><br><span class="line"><span class="comment">/* 该宏返回每个key生成ngx_hash_elt_t大小（字节）的sizeof(void *)的整数倍，这即使用其占用内存大小（虽然可能实际需要内存小于该值）。这里sizeof(void *)对应于ngx_hash_elt_t的value指针，(name)-&gt;key.len对应与name占用空间，2对应于len字节。这里使用ngx_align方法不是为了内存对其，而是为了将每个ngx_hash_elt_t进行划分，为了方便查询时更方快速获取。由于ngx_hash_t中的buckets申请的连续内存，name字段是要存储在该连续内存中，因此每个ngx_hash_elt_t所占用空间大小不一致，不能直接使用下标进行获取，使用该方法是为了内存对其，加速获取速度，具体查找时的方法参加下一小*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_hash_init(<span class="keyword">ngx_hash_init_t</span> *hinit, <span class="keyword">ngx_hash_key_t</span> *names, <span class="keyword">ngx_uint_t</span> nelts)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里参数ngx_hash_key_t一般是存储在ngx_array_t中第一个元素，nelts是元素数量</span></span><br><span class="line">    u_char          *elts;</span><br><span class="line">    <span class="keyword">size_t</span>           len;</span><br><span class="line">    u_short         *test;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       i, n, key, size, start, bucket_size;</span><br><span class="line">    <span class="keyword">ngx_hash_elt_t</span>  *elt, **buckets;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// max_size为0表示不能分配一个桶</span></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;max_size == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"could not build %s, you should "</span></span><br><span class="line">                      <span class="string">"increase %s_max_size: %i"</span>,</span><br><span class="line">                      hinit-&gt;name, hinit-&gt;name, hinit-&gt;max_size);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 每个桶的容量（字节数量）过大</span></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;bucket_size &gt; <span class="number">65536</span> - ngx_cacheline_size) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"could not build %s, too large "</span></span><br><span class="line">                      <span class="string">"%s_bucket_size: %i"</span>,</span><br><span class="line">                      hinit-&gt;name, hinit-&gt;name, hinit-&gt;bucket_size);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">        <span class="comment">/* 如果某个key构建的ngx_hash_elt_t所需空间加上一个void*所用空间大于bucket_siz，则报错。这里增加void*指针，是因为在ngx_hash_t中的buckets中，对于每一个桶，并没有指名末尾是什么，因此需要在最后增加一个void*的空间，对应获取到ngx_hash_elt_t的value字段，该字段设置为空，表示桶的末尾。*/</span></span><br><span class="line">        <span class="keyword">if</span> (hinit-&gt;bucket_size &lt; NGX_HASH_ELT_SIZE(&amp;names[n]) + <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"could not build %s, you should "</span></span><br><span class="line">                          <span class="string">"increase %s_bucket_size: %i"</span>,</span><br><span class="line">                          hinit-&gt;name, hinit-&gt;name, hinit-&gt;bucket_size);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配 存储每个hash元素所需要的空间大小 数组</span></span><br><span class="line">    test = ngx_alloc(hinit-&gt;max_size * <span class="keyword">sizeof</span>(u_short), hinit-&gt;pool-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (test == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// bucket_size为允许桶存储的大小减去末尾记录为结尾的空间</span></span><br><span class="line">    bucket_size = hinit-&gt;bucket_size - <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 初始分配需要多少个桶，使用元素数量/(每个桶允许存储数据的字节大小/(2 * sizeof(void *))，这里2 * sizeof(void *)是一个ngx_hash_elt_t预估占用内存大小，因此实际为元素数量除以每个桶允许存放的元素个数 */</span></span><br><span class="line">    start = nelts / (bucket_size / (<span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line">    start = start ? start : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;max_size &gt; <span class="number">10000</span> &amp;&amp; nelts &amp;&amp; hinit-&gt;max_size / nelts &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        start = hinit-&gt;max_size - <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找实际需要多少个桶才能满足每个桶中最多分配bucket_size内存，实际需要的桶数量不能超过限制的最大值max_size</span></span><br><span class="line">    <span class="keyword">for</span> (size = start; size &lt;= hinit-&gt;max_size; size++) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_memzero(test, size * <span class="keyword">sizeof</span>(u_short));</span><br><span class="line">        <span class="comment">// 遍历每一个元素</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (names[n].key.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 找到以当前分配桶的数量时，其应该存放到哪个桶中</span></span><br><span class="line">            key = names[n].key_hash % size;</span><br><span class="line">            <span class="comment">// 计算当前分配到这个桶中所以元素所占用的内存大小</span></span><br><span class="line">            len = test[key] + NGX_HASH_ELT_SIZE(&amp;names[n]);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui: %ui %uz \"%V\""</span>,</span><br><span class="line">                          size, key, len, &amp;names[n].key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 如果当前该桶占用的内存已经超出限制，则表示当前分配的桶数量不足，增加桶的数量，再查找验证</span></span><br><span class="line">            <span class="keyword">if</span> (len &gt; bucket_size) &#123;</span><br><span class="line">                <span class="keyword">goto</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果循环结束，依然位发现有某个桶分配的元素所占用内存过大，则说明找到了桶大小</span></span><br><span class="line">            test[key] = (u_short) len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> found;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未找到，则表示hash表初始化失败，报错</span></span><br><span class="line">    size = hinit-&gt;max_size;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_WARN, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"could not build optimal %s, you should increase "</span></span><br><span class="line">                  <span class="string">"either %s_max_size: %i or %s_bucket_size: %i; "</span></span><br><span class="line">                  <span class="string">"ignoring %s_bucket_size"</span>,</span><br><span class="line">                  hinit-&gt;name, hinit-&gt;name, hinit-&gt;max_size,</span><br><span class="line">                  hinit-&gt;name, hinit-&gt;bucket_size, hinit-&gt;name);</span><br><span class="line"></span><br><span class="line">found:</span><br><span class="line"><span class="comment">// 查找到需要建立多少个桶的处理</span></span><br><span class="line">    <span class="comment">// 每一个桶中先分配一个作为末尾表示的空指针对应的存储空间大小</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        test[i] = <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每个元素</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (names[n].key.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 计算每个元素在该桶大小下分配到哪个桶中</span></span><br><span class="line">        key = names[n].key_hash % size;</span><br><span class="line">        <span class="comment">// 记录该桶中当前已占用内存大小</span></span><br><span class="line">        len = test[key] + NGX_HASH_ELT_SIZE(&amp;names[n]);</span><br><span class="line">        <span class="comment">// 超过该值报错</span></span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">65536</span> - ngx_cacheline_size) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"could not build %s, you should "</span></span><br><span class="line">                          <span class="string">"increase %s_max_size: %i"</span>,</span><br><span class="line">                          hinit-&gt;name, hinit-&gt;name, hinit-&gt;max_size);</span><br><span class="line">            ngx_free(test);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        test[key] = (u_short) len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 变量每一个桶，计算总共需要创建的内存大小</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="comment">// 空的桶不需要创建内存</span></span><br><span class="line">        <span class="keyword">if</span> (test[i] == <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 为了加速请求速度，每个桶分配内存都为cache line的整数倍 </span></span><br><span class="line">        test[i] = (u_short) (ngx_align(test[i], ngx_cacheline_size));</span><br><span class="line"></span><br><span class="line">        len += test[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配hash需要的内存大小，分配buckets空间</span></span><br><span class="line">    <span class="keyword">if</span> (hinit-&gt;hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        hinit-&gt;hash = ngx_pcalloc(hinit-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_wildcard_t</span>)</span><br><span class="line">                                             + size * <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_elt_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (hinit-&gt;hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_free(test);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buckets = (<span class="keyword">ngx_hash_elt_t</span> **)</span><br><span class="line">                      ((u_char *) hinit-&gt;hash + <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_wildcard_t</span>));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buckets = ngx_pcalloc(hinit-&gt;pool, size * <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_elt_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (buckets == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_free(test);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配存储所有元素需要的空间大小</span></span><br><span class="line">    elts = ngx_palloc(hinit-&gt;pool, len + ngx_cacheline_size);</span><br><span class="line">    <span class="keyword">if</span> (elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_free(test);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为加速，进行内存行对其</span></span><br><span class="line">    elts = ngx_align_ptr(elts, ngx_cacheline_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历每个桶</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (test[i] == <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用分配的内存，初始化每个桶的起始位置</span></span><br><span class="line">        buckets[i] = (<span class="keyword">ngx_hash_elt_t</span> *) elts;</span><br><span class="line">        elts += test[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        test[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对每一个元素赋值</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (names[n].key.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到该元素分配到每个哪个桶中</span></span><br><span class="line">        key = names[n].key_hash % size;</span><br><span class="line">        <span class="comment">// 找到该元素应该分配到桶中的内存起始位置</span></span><br><span class="line">        elt = (<span class="keyword">ngx_hash_elt_t</span> *) ((u_char *) buckets[key] + test[key]);</span><br><span class="line">        <span class="comment">// 对元素赋值</span></span><br><span class="line">        elt-&gt;value = names[n].value;</span><br><span class="line">        elt-&gt;len = (u_short) names[n].key.len;</span><br><span class="line"></span><br><span class="line">        ngx_strlow(elt-&gt;name, names[n].key.data, names[n].key.len);</span><br><span class="line">        <span class="comment">// 增加该桶中使用了的内存大小</span></span><br><span class="line">        test[key] = (u_short) (test[key] + NGX_HASH_ELT_SIZE(&amp;names[n]));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对每一个桶中，增加结束标识</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buckets[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取到当前桶已经使用到的内存位置</span></span><br><span class="line">        elt = (<span class="keyword">ngx_hash_elt_t</span> *) ((u_char *) buckets[i] + test[i]);</span><br><span class="line">        <span class="comment">// 对该位置的value设置为null，查找时作为结束标识</span></span><br><span class="line">        elt-&gt;value = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_free(test);</span><br><span class="line">    <span class="comment">// 赋值桶和桶大小</span></span><br><span class="line">    hinit-&gt;hash-&gt;buckets = buckets;</span><br><span class="line">    hinit-&gt;hash-&gt;size = size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">ngx_str_t</span>   val;</span><br><span class="line">        <span class="keyword">ngx_uint_t</span>  key;</span><br><span class="line"></span><br><span class="line">        elt = buckets[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (elt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui: NULL"</span>, i);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (elt-&gt;value) &#123;</span><br><span class="line">            val.len = elt-&gt;len;</span><br><span class="line">            val.data = &amp;elt-&gt;name[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            key = hinit-&gt;key(val.data, val.len);</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%ui: %p \"%V\" %ui"</span>, i, elt, &amp;val, key);</span><br><span class="line"></span><br><span class="line">            elt = (<span class="keyword">ngx_hash_elt_t</span> *) ngx_align_ptr(&amp;elt-&gt;name[<span class="number">0</span>] + elt-&gt;len,</span><br><span class="line">                                                   <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="散列表查找"><a href="#散列表查找" class="headerlink" title="散列表查找"></a>散列表查找</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_hash_find(<span class="keyword">ngx_hash_t</span> *hash, <span class="keyword">ngx_uint_t</span> key, u_char *name, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       i;</span><br><span class="line">    <span class="keyword">ngx_hash_elt_t</span>  *elt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"hf:\"%*s\""</span>, len, name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 找到该元素属于哪个桶</span></span><br><span class="line">    elt = hash-&gt;buckets[key % hash-&gt;size];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (elt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找桶中元素，直到末尾</span></span><br><span class="line">    <span class="keyword">while</span> (elt-&gt;value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (len != (<span class="keyword">size_t</span>) elt-&gt;len) &#123;</span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name[i] != elt-&gt;name[i]) &#123;</span><br><span class="line">                <span class="keyword">goto</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到后返回</span></span><br><span class="line">        <span class="keyword">return</span> elt-&gt;value;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line"></span><br><span class="line">        elt = (<span class="keyword">ngx_hash_elt_t</span> *) ngx_align_ptr(&amp;elt-&gt;name[<span class="number">0</span>] + elt-&gt;len,</span><br><span class="line">                                               <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="管理散列表（ngx-hash-keys-arrays-t）"><a href="#管理散列表（ngx-hash-keys-arrays-t）" class="headerlink" title="管理散列表（ngx_hash_keys_arrays_t）"></a>管理散列表（ngx_hash_keys_arrays_t）</h2><p>nginx为了让大家方便的构造hash表，提供给了此辅助类型，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 将要构建的hash表的桶的个数。对于使用这个结构中包含的信息构建的三种类型的hash表都会使用此参数。</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        hsize;</span><br><span class="line">    <span class="comment">// 构建这些hash表使用的pool。</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *pool;</span><br><span class="line">    <span class="comment">// 在构建这个类型以及最终的三个hash表过程中可能用到临时pool。该temp_pool可以在构建完成以后，被销毁掉。这里只是存放临时的一些内存消耗。</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>       *temp_pool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放所有非通配符key的数组。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>       keys;</span><br><span class="line">    <span class="comment">/*这是个二维数组，第一个维度代表的是bucket的编号，那么keys_hash[i]中存放的是所有的key算出来的hash值对hsize取模以后的值为i的key。假设有3个key,分别是key1,key2和key3假设hash值算出来以后对hsize取模的值都是i，那么这三个key的值就顺序存放在keys_hash[i][0],keys_hash[i][1], keys_hash[i][2]。该值在调用的过程中用来保存和检测是否有冲突的key值，也就是是否有重复。用于存放非通配符数据*/</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>      *keys_hash;</span><br><span class="line">    <span class="comment">// 放前向通配符key被处理完成以后的值。比如：“*.abc.com” 被处理完成以后，变成 “com.abc.” 被存放在此数组中。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>       dns_wc_head;</span><br><span class="line">    <span class="comment">// 该值在调用的过程中用来保存和检测是否有冲突的前向通配符的key值，也就是是否有重复。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>      *dns_wc_head_hash;</span><br><span class="line">    <span class="comment">// 存放后向通配符key被处理完成以后的值。比如：“mail.xxx.*” 被处理完成以后，变成 “mail.xxx.” 被存放在此数组中。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>       dns_wc_tail;</span><br><span class="line">    <span class="comment">// 该值在调用的过程中用来保存和检测是否有冲突的后向通配符的key值，也就是是否有重复。</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>      *dns_wc_tail_hash;</span><br><span class="line">&#125; <span class="keyword">ngx_hash_keys_arrays_t</span>;</span><br><span class="line"><span class="comment">// 一维数组存储数据一般ngx_hash_key_t，二维数组存储数据一般ngx_str_t</span></span><br></pre></td></tr></table></figure>
<h3 id="构建ngx-hash-keys-arrays-t"><a href="#构建ngx-hash-keys-arrays-t" class="headerlink" title="构建ngx_hash_keys_arrays_t"></a>构建ngx_hash_keys_arrays_t</h3><p>使用ngx_hash_keys_array_init构建该结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line"><span class="comment">// type指名构建的大小。其中NGX_HASH_SMALL表示待初始化的元素较少，NGX_HASH_LARGE表示待初始化的元素较多</span></span><br><span class="line">ngx_hash_keys_array_init(<span class="keyword">ngx_hash_keys_arrays_t</span> *ha, <span class="keyword">ngx_uint_t</span> type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 数组预分配空间大小 </span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  asize;</span><br><span class="line">    <span class="comment">// 初始化较少时，预分配大小为4，桶数量为107</span></span><br><span class="line">    <span class="keyword">if</span> (type == NGX_HASH_SMALL) &#123;</span><br><span class="line">        asize = <span class="number">4</span>;</span><br><span class="line">        ha-&gt;hsize = <span class="number">107</span>;</span><br><span class="line">    <span class="comment">// 初始化较多时，预分配大小为16384，桶数量为10007</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        asize = NGX_HASH_LARGE_ASIZE;</span><br><span class="line">        ha-&gt;hsize = NGX_HASH_LARGE_HSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化存储数据的三个数组</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;keys, ha-&gt;temp_pool, asize, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;dns_wc_head, ha-&gt;temp_pool, asize,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;dns_wc_tail, ha-&gt;temp_pool, asize,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化用于查看是否有重复的简易hash表</span></span><br><span class="line">    ha-&gt;keys_hash = ngx_pcalloc(ha-&gt;temp_pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_array_t</span>) * ha-&gt;hsize);</span><br><span class="line">    <span class="keyword">if</span> (ha-&gt;keys_hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ha-&gt;dns_wc_head_hash = ngx_pcalloc(ha-&gt;temp_pool,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_array_t</span>) * ha-&gt;hsize);</span><br><span class="line">    <span class="keyword">if</span> (ha-&gt;dns_wc_head_hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ha-&gt;dns_wc_tail_hash = ngx_pcalloc(ha-&gt;temp_pool,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_array_t</span>) * ha-&gt;hsize);</span><br><span class="line">    <span class="keyword">if</span> (ha-&gt;dns_wc_tail_hash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加元素"><a href="#添加元素" class="headerlink" title="添加元素"></a>添加元素</h3><p>使用如下函数增加元素：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* flag取值有三种：NGX_HASH_WILDCARD_KEY表示需要处理通配符。 NGX_HASH_READONLY_KEY表示不能对关键字做变更，即不能通过全小写关键字来获取散列码，其他值：即不处理通配符，又允许把关键字全小写获取散列码*/</span></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_hash_add_key(<span class="keyword">ngx_hash_keys_arrays_t</span> *ha, <span class="keyword">ngx_str_t</span> *key, <span class="keyword">void</span> *value,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>           len;</span><br><span class="line">    u_char          *p;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>       *name;</span><br><span class="line">    <span class="comment">// skip表示起始位置要跳过字符数量，last表示到末尾的长度</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       i, k, n, skip, last;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>     *keys, *hwc;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>  *hk;</span><br><span class="line"></span><br><span class="line">    last = key-&gt;len;</span><br><span class="line">    <span class="comment">// 处理通配符</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_HASH_WILDCARD_KEY) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * supported wildcards:</span></span><br><span class="line"><span class="comment">         *     "*.example.com", ".example.com", and "www.example.*"</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 校验字符串正确性</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; key-&gt;len; i++) &#123;</span><br><span class="line">            <span class="comment">// 如果出现多个*表示为nginx不正常的通配符格式（只支持首尾一个通配符）</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (++n &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 错误通配符数据</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'.'</span> &amp;&amp; key-&gt;data[i + <span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 字符串以\0结尾</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'\0'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ".example.com"格式数据,存储数据时去带.</span></span><br><span class="line">        <span class="keyword">if</span> (key-&gt;len &gt; <span class="number">1</span> &amp;&amp; key-&gt;data[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            skip = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> wildcard;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key-&gt;len &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// "*.example.com"格式数据,存储数据时去带.*</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[<span class="number">0</span>] == <span class="string">'*'</span> &amp;&amp; key-&gt;data[<span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                skip = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">goto</span> wildcard;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// "www.example.*"格式数据,存储数据时去带.*</span></span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i - <span class="number">2</span>] == <span class="string">'.'</span> &amp;&amp; key-&gt;data[i - <span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                skip = <span class="number">0</span>;</span><br><span class="line">                last -= <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">goto</span> wildcard;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 存在通配符*,但不在首尾</span></span><br><span class="line">        <span class="keyword">if</span> (n) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* exact hash */</span></span><br><span class="line">    <span class="comment">// 未找到通配符或不查看通配符</span></span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 根据是否可以转换为小写计算哈希值</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; last; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; NGX_HASH_READONLY_KEY)) &#123;</span><br><span class="line">            key-&gt;data[i] = ngx_tolower(key-&gt;data[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        k = ngx_hash(k, key-&gt;data[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    k %= ha-&gt;hsize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check conflicts in exact hash */</span></span><br><span class="line">    <span class="comment">// 找到在keys_hash精准匹配的哪个桶中</span></span><br><span class="line">    name = ha-&gt;keys_hash[k].elts;</span><br><span class="line">    <span class="comment">// 如果桶不为空，查看桶中是否有当前值</span></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ha-&gt;keys_hash[k].nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (last != name[i].len) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(key-&gt;data, name[i].data, last) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 初始化桶</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;keys_hash[k], ha-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加元素到桶中</span></span><br><span class="line">    name = ngx_array_push(&amp;ha-&gt;keys_hash[k]);</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *name = *key;</span><br><span class="line"></span><br><span class="line">    hk = ngx_array_push(&amp;ha-&gt;keys);</span><br><span class="line">    <span class="keyword">if</span> (hk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hk-&gt;key = *key;</span><br><span class="line">    hk-&gt;key_hash = ngx_hash_key(key-&gt;data, last);</span><br><span class="line">    hk-&gt;value = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通配符处理逻辑</span></span><br><span class="line">wildcard:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* wildcard hash */</span></span><br><span class="line">    <span class="comment">// 去除通配符相关字段*.,.，转换小写计算hash值</span></span><br><span class="line">    k = ngx_hash_strlow(&amp;key-&gt;data[skip], &amp;key-&gt;data[skip], last - skip);</span><br><span class="line"></span><br><span class="line">    k %= ha-&gt;hsize;</span><br><span class="line">    <span class="comment">// 对于是.example.com这种形式的key，其只能和精准的example.com两者直接存在一个。或者在精准中存在一个example.com，或者在前缀匹配中，存在一个.example.com</span></span><br><span class="line">    <span class="keyword">if</span> (skip == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check conflicts in exact hash for ".example.com" */</span></span><br><span class="line"></span><br><span class="line">        name = ha-&gt;keys_hash[k].elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name) &#123;</span><br><span class="line">            len = last - skip;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ha-&gt;keys_hash[k].nelts; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (len != name[i].len) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果精准匹配中已存在，则返回</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_strncmp(&amp;key-&gt;data[<span class="number">1</span>], name[i].data, len) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_array_init(&amp;ha-&gt;keys_hash[k], ha-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                               <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>))</span><br><span class="line">                != NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果精准匹配中不存在，则添加一个example.com形式的key到精准匹配中，避免精准匹配中再增加</span></span><br><span class="line">        name = ngx_array_push(&amp;ha-&gt;keys_hash[k]);</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        name-&gt;len = last - <span class="number">1</span>;</span><br><span class="line">        name-&gt;data = ngx_pnalloc(ha-&gt;temp_pool, name-&gt;len);</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(name-&gt;data, &amp;key-&gt;data[<span class="number">1</span>], name-&gt;len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于前置通配符</span></span><br><span class="line">    <span class="keyword">if</span> (skip) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * convert "*.example.com" to "com.example.\0"</span></span><br><span class="line"><span class="comment">         *      and ".example.com" to "com.example\0"</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(ha-&gt;temp_pool, last);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = <span class="number">0</span>;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 转换*.example.com到com.example.\0，.example.com到com.example\0，注意这里的i未到0</span></span><br><span class="line">        <span class="keyword">for</span> (i = last - <span class="number">1</span>; i; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key-&gt;data[i] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                ngx_memcpy(&amp;p[n], &amp;key-&gt;data[i + <span class="number">1</span>], len);</span><br><span class="line">                n += len;</span><br><span class="line">                p[n++] = <span class="string">'.'</span>;</span><br><span class="line">                len = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            len++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于.example.com的来说，将example拼接上</span></span><br><span class="line">        <span class="keyword">if</span> (len) &#123;</span><br><span class="line">            ngx_memcpy(&amp;p[n], &amp;key-&gt;data[<span class="number">1</span>], len);</span><br><span class="line">            n += len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p[n] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">        hwc = &amp;ha-&gt;dns_wc_head;</span><br><span class="line">        keys = &amp;ha-&gt;dns_wc_head_hash[k];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* convert "www.example.*" to "www.example\0" */</span></span><br><span class="line"></span><br><span class="line">        last++;</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(ha-&gt;temp_pool, last);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_cpystrn(p, key-&gt;data, last);</span><br><span class="line"></span><br><span class="line">        hwc = &amp;ha-&gt;dns_wc_tail;</span><br><span class="line">        keys = &amp;ha-&gt;dns_wc_tail_hash[k];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check conflicts in wildcard hash */</span></span><br><span class="line">    <span class="comment">// 在对应的通配符表中查找是否已经存在</span></span><br><span class="line">    name = keys-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        len = last - skip;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; keys-&gt;nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (len != name[i].len) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(key-&gt;data + skip, name[i].data, len) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_BUSY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(keys, ha-&gt;temp_pool, <span class="number">4</span>, <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>)) != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向对应的简易hash表中增加数据，注意，这里增加的是去除通配符字段后原始数据，并未将首通配符样式字段倒排</span></span><br><span class="line">    name = ngx_array_push(keys);</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    name-&gt;len = last - skip;</span><br><span class="line">    name-&gt;data = ngx_pnalloc(ha-&gt;temp_pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (name-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(name-&gt;data, key-&gt;data + skip, name-&gt;len);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add to wildcard hash */</span></span><br><span class="line">    <span class="comment">// 添加数据到对于的数组中，这里添加的是处理后的数据，即将首通配符样式字段倒排</span></span><br><span class="line">    hk = ngx_array_push(hwc);</span><br><span class="line">    <span class="keyword">if</span> (hk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// *.baidu.com被存储为com.baidu.;.baidu.com被存储为com.baidu; www.baidu.*被存储为www.baidu</span></span><br><span class="line">    hk-&gt;key.len = last - <span class="number">1</span>;</span><br><span class="line">    hk-&gt;key.data = p;</span><br><span class="line">    hk-&gt;key_hash = <span class="number">0</span>;</span><br><span class="line">    hk-&gt;value = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于构建好的通配符数组，不能直接调用ngx_hash_wildcard_init来构建包含通配符的散列表，而是要先对数组进行排序，这就是为什么要在字节后面添加\0的作用，用于判断字符串结尾。排序时，<code>.</code>被认为是最低顺序的字节，即：<code>example.com</code>小于（排在前面）<code>example1.com</code>。</p>
<h2 id="带有通配符的散列表（ngx-hash-wildcard-t）"><a href="#带有通配符的散列表（ngx-hash-wildcard-t）" class="headerlink" title="带有通配符的散列表（ngx_hash_wildcard_t）"></a>带有通配符的散列表（ngx_hash_wildcard_t）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 基本散列表</span><br><span class="line">    ngx_hash_t        hash;</span><br><span class="line">    // 当使用ngx_hash_wildcard_t通配符散列表作为某容器的元素时，可以使用value指向用户数据</span><br><span class="line">    void             *value;</span><br><span class="line">&#125; ngx_hash_wildcard_t;</span><br></pre></td></tr></table></figure>
<p>nginx支持的带通配符的散列表，仅支持在起始或末尾带有散列表，即如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">www.baidu.*</span><br><span class="line">*.baidu.com</span><br><span class="line">.baidu.com // 有可能被记录为不带通配符的baidu.com</span><br></pre></td></tr></table></figure>
<h3 id="构建带有通配符的散列表"><a href="#构建带有通配符的散列表" class="headerlink" title="构建带有通配符的散列表"></a>构建带有通配符的散列表</h3><p>ngx_hash_wildcard_init函数用来构建带有通配符的散列表。这里需要注意，不论是构建前置为通配符还是后置为通配符，其中的参数，即ngx_hash_key_t列表，均是z已被排序好的，即key均被排序完成，这时为了方便后续的构建。对于含有通配符的hash表来说，其是一个层级结构。例如对于如下两个key：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www.baidu.com</span><br><span class="line">www.tencent.com</span><br></pre></td></tr></table></figure>
<p>则构建的hash表为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一级   第二级    第三极</span><br><span class="line">        baidu    com</span><br><span class="line">www </span><br><span class="line">        tencent  com</span><br></pre></td></tr></table></figure>
<p>查找时也是同样的逻辑，先按照<code>.</code>划分块，再一层一层查找。这也是为啥要将前置的通配符反转，变更成类似于后置的结构。</p>
<p>具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_hash_wildcard_init(<span class="keyword">ngx_hash_init_t</span> *hinit, <span class="keyword">ngx_hash_key_t</span> *names,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> nelts)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                len, dot_len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            i, n, dot;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>           curr_names, next_names;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>       *name, *next_name;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>       h;</span><br><span class="line">    <span class="keyword">ngx_hash_wildcard_t</span>  *wdc;</span><br><span class="line">    <span class="comment">// 分配当前层级数据空间</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;curr_names, hinit-&gt;temp_pool, nelts,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配当下一层级数据空间</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;next_names, hinit-&gt;temp_pool, nelts,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从第一个开始查看，并不是简单的遍历</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; nelts; n = i) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"wc0: \"%V\""</span>, &amp;names[n].key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 记录是否查找到逗号，并使用len记录逗号所在下标</span></span><br><span class="line">        dot = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (len = <span class="number">0</span>; len &lt; names[n].key.len; len++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (names[n].key.data[len] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                dot = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加当前的数据到当前层级数据中，对于查找到逗号的情况，其key变更为逗号前的部分，value为当前key对应数据的value</span></span><br><span class="line">        name = ngx_array_push(&amp;curr_names);</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        name-&gt;key.len = len;</span><br><span class="line">        name-&gt;key.data = names[n].key.data;</span><br><span class="line">        name-&gt;key_hash = hinit-&gt;key(name-&gt;key.data, name-&gt;key.len);</span><br><span class="line">        name-&gt;value = names[n].value;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"wc1: \"%V\" %ui"</span>, &amp;name-&gt;key, dot);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 记录从开始到当前位置的长度，用于切割key</span></span><br><span class="line">        dot_len = len + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 如果发现了.，则len加一，对比时，.字符也会用来比较相同前缀的key</span></span><br><span class="line">        <span class="keyword">if</span> (dot) &#123;</span><br><span class="line">            len++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        next_names.nelts = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 表示并为遍历到结尾，后面还有待切割字段，则将后面部分数据添加到构建下一层hash表的列表中</span></span><br><span class="line">        <span class="keyword">if</span> (names[n].key.len != len) &#123;</span><br><span class="line">            next_name = ngx_array_push(&amp;next_names);</span><br><span class="line">            <span class="keyword">if</span> (next_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            next_name-&gt;key.len = names[n].key.len - len;</span><br><span class="line">            next_name-&gt;key.data = names[n].key.data + len;</span><br><span class="line">            next_name-&gt;key_hash = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// value存储对于的数据，后续可能会变更</span></span><br><span class="line">            next_name-&gt;value = names[n].value;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"wc2: \"%V\""</span>, &amp;next_name-&gt;key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历后面的key，找到第一个和当前查找到的前缀不匹配的key，注意 . 也会被匹配，即，查看的应该是 example.或者com这两种形式的查找匹配。</span></span><br><span class="line">        <span class="keyword">for</span> (i = n + <span class="number">1</span>; i &lt; nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_strncmp(names[n].key.data, names[i].key.data, len) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没有查找到逗号，即当前的n是切割的末尾了，并且当前的i长度要大于现在的n的长度，且i的len不是.就结束查找。这时由于，com.ex也要是com的子一层hash表。但comm不是com子一层。</span></span><br><span class="line">            <span class="keyword">if</span> (!dot</span><br><span class="line">                &amp;&amp; names[i].key.len &gt; len</span><br><span class="line">                &amp;&amp; names[i].key.data[len] != <span class="string">'.'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将查找到属于当前n的子一层hash元素的数据添加到用来构建子一层hash表的数组中。</span></span><br><span class="line">            next_name = ngx_array_push(&amp;next_names);</span><br><span class="line">            <span class="keyword">if</span> (next_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 同样是要把当前一层的key去掉，子一层只用剩下的字符串</span></span><br><span class="line">            next_name-&gt;key.len = names[i].key.len - dot_len;</span><br><span class="line">            next_name-&gt;key.data = names[i].key.data + dot_len;</span><br><span class="line">            next_name-&gt;key_hash = <span class="number">0</span>;</span><br><span class="line">            next_name-&gt;value = names[i].value;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, hinit-&gt;pool-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"wc3: \"%V\""</span>, &amp;next_name-&gt;key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果存在需要构建子一层hash表的key</span></span><br><span class="line">        <span class="keyword">if</span> (next_names.nelts) &#123;</span><br><span class="line"></span><br><span class="line">            h = *hinit;</span><br><span class="line">            h.hash = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">// 对子数组递归调用ngx_hash_wildcard_init构建函数。这里会调用ngx_hash_init，对于hash等于null来说，构建的hash是ngx_hash_wildcard_t结构</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_hash_wildcard_init(&amp;h, (<span class="keyword">ngx_hash_key_t</span> *) next_names.elts,</span><br><span class="line">                                       next_names.nelts)</span><br><span class="line">                != NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 转换为ngx_hash_wildcard_t</span></span><br><span class="line">            wdc = (<span class="keyword">ngx_hash_wildcard_t</span> *) h.hash;</span><br><span class="line">            <span class="comment">// 如果当前的n是查询的末尾，那么用ngx_hash_wildcard_t存储对应的value，如果不是查询末尾，则ngx_hash_wildcard_t存储对应的value对应为NULL</span></span><br><span class="line">            <span class="keyword">if</span> (names[n].key.len == len) &#123;</span><br><span class="line">                wdc-&gt;value = names[n].value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当前ngx_hash_key_t的value指向下一层的hash表。同时利用指针最后两位来标识当前节点状况。10表示当前的value指向下一层hash表，11表示当前value指向下一层hash并且该字符串后面跟随着 .</span></span><br><span class="line">            name-&gt;value = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) wdc | (dot ? <span class="number">3</span> : <span class="number">2</span>));</span><br><span class="line">        <span class="comment">// 如果不需要建下一层的hash表，并且发现了.，即com.example.这种情况，使用01记录。00则表示是最后的节点，其下层没有hash表，并且字段后面没有. 当前的value指向对应的数据</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dot) &#123;</span><br><span class="line">            name-&gt;value = (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) name-&gt;value | <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建当前层级的hash表</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_init(hinit, (<span class="keyword">ngx_hash_key_t</span> *) curr_names.elts,</span><br><span class="line">                      curr_names.nelts)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于如下数据：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*.baidu.com               value1</span><br><span class="line">*.baidu.cn                value2</span><br><span class="line">*.tencent.com             value3</span><br><span class="line">*.example.baidu.com       value4 </span><br><span class="line">*.example.baidu-int.com   value5</span><br></pre></td></tr></table></figure>
<p>首先被转换并排序为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cn.baidu.                value2</span><br><span class="line">com.baidu.               value1</span><br><span class="line">com.baidu.example.       value4 </span><br><span class="line">com.baidu-int.example.   value5</span><br><span class="line">com.tencent.             value3</span><br></pre></td></tr></table></figure>
<p>构建多层hash表如下：</p>
<p><a href="https://imgtu.com/i/WItYGR" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/27/WItYGR.png" alt="WItYGR.png"></a></p>
<h3 id="查找后缀通配符"><a href="#查找后缀通配符" class="headerlink" title="查找后缀通配符"></a>查找后缀通配符</h3><p>使用ngx_hash_find_wc_tail在后缀通配符中查找：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_hash_find_wc_tail(<span class="keyword">ngx_hash_wildcard_t</span> *hwc, u_char *name, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, key;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"wct:\"%*s\""</span>, len, name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 使用.进行切割。如果查找到末尾还未找到，则返回null。由于是后缀通配符，因此查找到了末尾还未找到对应数据，则应该在精准匹配里面查找，而不应该在后置表中查找。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name[i] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 计算切割后的hash值</span></span><br><span class="line">        key = ngx_hash(key, name[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i == len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"key:\"%ui\""</span>, key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 查找当前的hash表</span></span><br><span class="line">    value = ngx_hash_find(&amp;hwc-&gt;hash, key, name, i);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"value:\"%p\""</span>, value);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the 2 low bits of value have the special meaning:</span></span><br><span class="line"><span class="comment">         *     00 - value is data pointer;</span></span><br><span class="line"><span class="comment">         *     11 - value is pointer to wildcard hash allowing "example.*".</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 对于指针倒数第二位来说，如果是1，则表明value值是下一层的hash数据</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 加1，去掉 . 继续查找</span></span><br><span class="line">            i++;</span><br><span class="line">            <span class="comment">// 恢复指针为正常指针</span></span><br><span class="line">            hwc = (<span class="keyword">ngx_hash_wildcard_t</span> *) ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line">            <span class="comment">// 查找下一层的hash数据</span></span><br><span class="line">            value = ngx_hash_find_wc_tail(hwc, &amp;name[i], len - i);</span><br><span class="line">            <span class="comment">// 如果找到，则返回</span></span><br><span class="line">            <span class="keyword">if</span> (value) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 未找到，则查找到的value对应的hash表结构ngx_hash_wildcard_t的value值，有可能为null（取决于构建时是否构建该层级的数据）</span></span><br><span class="line">            <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果hash表中没有对应切割的数据，那么返回当前层级hash表结构ngx_hash_wildcard_t的value值。有可能为空，因为查找时找最长匹配，如果后面没有对应的匹配，则使用当前层级的hash对应数据（有可能为null）。</span></span><br><span class="line">    <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查找前缀通配符"><a href="#查找前缀通配符" class="headerlink" title="查找前缀通配符"></a>查找前缀通配符</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_hash_find_wc_head(<span class="keyword">ngx_hash_wildcard_t</span> *hwc, u_char *name, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, n, key;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"wch:\"%*s\""</span>, len, name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    n = len;</span><br><span class="line">    <span class="comment">// 从后向前切词</span></span><br><span class="line">    <span class="keyword">while</span> (n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name[n - <span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 计算切词的hash值</span></span><br><span class="line">    <span class="keyword">for</span> (i = n; i &lt; len; i++) &#123;</span><br><span class="line">        key = ngx_hash(key, name[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"key:\"%ui\""</span>, key);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 查找当前的前缀表</span></span><br><span class="line">    value = ngx_hash_find(&amp;hwc-&gt;hash, key, &amp;name[n], len - n);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"value:\"%p\""</span>, value);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 在当前hash表中查找到了对应数据</span></span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the 2 low bits of value have the special meaning:</span></span><br><span class="line"><span class="comment">         *     00 - value is data pointer for both "example.com"</span></span><br><span class="line"><span class="comment">         *          and "*.example.com";</span></span><br><span class="line"><span class="comment">         *     01 - value is data pointer for "*.example.com" only;</span></span><br><span class="line"><span class="comment">         *     10 - value is pointer to wildcard hash allowing</span></span><br><span class="line"><span class="comment">         *          both "example.com" and "*.example.com";</span></span><br><span class="line"><span class="comment">         *     11 - value is pointer to wildcard hash allowing</span></span><br><span class="line"><span class="comment">         *          "*.example.com" only.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 指针的倒数第二位是1，表示当前value指向的是下一层hash表</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 查找到了key的末尾</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* "example.com" */</span></span><br><span class="line">                <span class="comment">// 11表示构建hash时，是*.example.com，并且其后还有下一层hash。而当前搜索的key是example.com，返回空</span></span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 10表示构建hash时，是.example.com，并且其后还有下一层hash。其允许搜索的是example.com，因此返回value对应的ngx_hash_wildcard_t中的value数据</span></span><br><span class="line">                hwc = (<span class="keyword">ngx_hash_wildcard_t</span> *)</span><br><span class="line">                                          ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 恢复原指针，进行向下查找</span></span><br><span class="line">            hwc = (<span class="keyword">ngx_hash_wildcard_t</span> *) ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">            value = ngx_hash_find_wc_head(hwc, name, n - <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (value) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没找到，则返回value对应的ngx_hash_wildcard_t中的value数据（有可能为空）</span></span><br><span class="line">            <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 01表示构建表的时候，是*.example.com，且其后没有下一层hash表了</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) value &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 而当前搜索的key是example.com，返回空</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* "example.com" */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 01表示构建表的时候，是.example.com，且其后没有下一层hash表了，其存储的是普通数据</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">void</span> *) ((<span class="keyword">uintptr_t</span>) value &amp; (<span class="keyword">uintptr_t</span>) ~<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是00，表示就是普通数据</span></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果hash表中没有对应切割的数据，那么返回当前层级hash表结构ngx_hash_wildcard_t的value值。有可能为空，因为查找时找最长匹配，如果后面没有对应的匹配，则使用当前层级的hash对应数据（有可能为null）。</span></span><br><span class="line">    <span class="keyword">return</span> hwc-&gt;value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Nginx特殊技巧"><a href="#Nginx特殊技巧" class="headerlink" title="Nginx特殊技巧"></a>Nginx特殊技巧</h1><h2 id="ngx-align-值对齐宏"><a href="#ngx-align-值对齐宏" class="headerlink" title="ngx_align 值对齐宏"></a>ngx_align 值对齐宏</h2><p>ngx_align 为nginx中的一个值对齐宏。主要在需要内存申请的地方使用，为了减少在不同的 cache line 中内存而生。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// d 为需要对齐的</span></span><br><span class="line"><span class="comment">// a 为对齐宽度，必须为 2 的幂</span></span><br><span class="line"><span class="comment">// 返回对齐值</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_align(d, a)     (((d) + (a - 1)) &amp; ~(a - 1))</span></span><br></pre></td></tr></table></figure>
<p>原理简单，利用 <code>~(a - 1)</code> 的低位全为 0。在与 <code>~(a - 1)</code> 做 <code>&amp;</code> 操作时，低位的1被丢弃，就得到了a倍数的值（对齐）。</p>
<p>如果使用原始值直接与 <code>~(a - 1)</code> 做 <code>&amp;</code> 操作，那么得到的对齐值是会小于等于原始值的，这样会造成内存重叠，而期望的对齐值是一个大于等于原始值的，所以需要加上一个数来补上至对齐值这中间的差，这个数为 <code>(a - 1)</code> ，选择这个数的原因是 <code>(a - 1) &amp; ~(a - 1)</code> 的结果为0。</p>
<p>该操作含义为：取大于d且为a整数倍的第一个数。</p>
<h2 id="ngx-align-ptr内存对其"><a href="#ngx-align-ptr内存对其" class="headerlink" title="ngx_align_ptr内存对其"></a>ngx_align_ptr内存对其</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_align_ptr(p, a)                                                   \</span></span><br><span class="line">    (u_char *) (((<span class="keyword">uintptr_t</span>) (p) + ((<span class="keyword">uintptr_t</span>) a - <span class="number">1</span>)) &amp; ~((<span class="keyword">uintptr_t</span>) a - <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<p>这里和上面都存储对其类似，a一般是cache line大小。对其后，指针指向cache line的整数倍的地方，加快读取速度。具体参考下面文章。</p>
<p><a href="https://oopschen.github.io/posts/2013/cpu-cacheline/" target="_blank" rel="noopener">https://oopschen.github.io/posts/2013/cpu-cacheline/</a></p>
<h2 id="指针最后两位一定是0"><a href="#指针最后两位一定是0" class="headerlink" title="指针最后两位一定是0"></a>指针最后两位一定是0</h2><p>字节对齐和系统有关，也和编译器有关，具体到底是几字节对齐和本问题关系不大。主要是因为无论如何对齐，都是字节对齐，而不是bit对齐。也就是说指针的起始存放地址只可能是8的倍数，比如0x00,0x08,0x10,转换成二进制后三位永远是0。不可能出现0x02到0x22作为一个四字节的指针。</p>
<p>ps1：有些资料中将之描述为指针的后2位永远是0，猜想是汇编语言中好像有的语句可以把4bit看作一个基本的操作单位，所以只能保证指针的后2位永远是0。</p>
<p>ps2：是否可以申请一个数组，然后对其中的位进行操作，使之出现一个类似0x02到0x22作为一个四字节指针的情况，将这个畸形的指针传入指针操作API中会导致什么后果，这个问题还有待考证。</p>
<p>出处：<a href="https://www.zhihu.com/question/40636241/answer/311889614" target="_blank" rel="noopener">https://www.zhihu.com/question/40636241/answer/311889614</a></p>
<h2 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h2><p>内联汇编语言可以直接操作硬件。可以用来在nginx源码中实现对整数的原子操作。</p>
<p>使用GCC编译器在C语言中嵌入汇编语言的方式是使用__asm__关键字，语法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">asm__ <span class="title">volatile</span> <span class="params">( 汇编语句部分</span></span></span><br><span class="line"><span class="function"><span class="params">     : 输出部分    <span class="comment">/*可选*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">     : 输入部分    <span class="comment">/*可选*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">     : 破坏描述部分 <span class="comment">/*可选*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">）;</span></span></span><br></pre></td></tr></table></figure>
<p>加入volatile关键字用于限制GCC编译器对这段代码做优化。</p>
<p>内联汇编语言包含四部分：</p>
<ol>
<li><p>汇编语句部分</p>
<p>引号中所包含的汇编语句可以直接用占位符%来引用C语言中的变量（最多10个，%0-%9）。</p>
</li>
<li><p>输出部分</p>
<p>将寄存器中的值设置到C语言的变量中</p>
</li>
<li><p>输入部分</p>
<p>将C语言中的变量设置到寄存器中。</p>
</li>
<li><p>破坏描述部分</p>
<p>通知编译器使用了哪些寄存器、内存。</p>
</li>
</ol>
<p>以如下语句举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ngx_inline <span class="keyword">ngx_atomic_uint_t</span></span><br><span class="line">ngx_atomic_cmp_set(<span class="keyword">ngx_atomic_t</span> *lock, <span class="keyword">ngx_atomic_uint_t</span> old,</span><br><span class="line">    <span class="keyword">ngx_atomic_uint_t</span> <span class="built_in">set</span>)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  res;</span><br><span class="line"></span><br><span class="line">    __<span class="function">asm__ <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"    lock                "</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"    cmpxchgl  %3, %1;   "</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"    sete      %0;       "</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    : <span class="string">"=a"</span> (res) : <span class="string">"m"</span> (*lock), <span class="string">"a"</span> (old), <span class="string">"r"</span> (<span class="built_in">set</span>) : <span class="string">"cc"</span>, <span class="string">"memory"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看输入部分：”m” (*lock)表示<em>lock变量是在内存中，操作\</em>lock直接通过内存（不使用寄存器处理）,而”a” (old)表示把old变量写入eax寄存器中，”r” (set)表示把set变量写入通用寄存器中。这些都是为cmpxchgl做准备。</p>
<p>再来看汇编语句部分：”lock”表示在多核架构上首先锁住总线。</p>
<p>cmpxchgl语句含义为如下代码表示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * &quot;cmpxchgl  r, [m]&quot;:</span><br><span class="line"> *</span><br><span class="line"> *     if (eax == [m]) &#123;</span><br><span class="line"> *         zf = 1;</span><br><span class="line"> *         [m] = r;</span><br><span class="line"> *     &#125; else &#123;</span><br><span class="line"> *         zf = 0;</span><br><span class="line"> *         eax = [m];</span><br><span class="line"> *     &#125;</span><br><span class="line"> *</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p>即判断寄存器中的值是否等于[m]，如果相等，则设置[m]为r，并且设置sf为1。否则，设置zf为0，并且设置寄存器中值为[m]。</p>
<p>在语句cmpxchgl  %3, %1;中，寄存器变量为old。%3表示set，%1表示<em>loct。先比较\</em>lock是否等于old，如果相等设置*lock为set。并进行zf设置。</p>
<p>“sete      %0;”表示设置zf值到寄存器变量中。</p>
<p>返回部分”=a” (res)将寄存器中值写入res变量中，返回。</p>
<h1 id="Nginx基础架构"><a href="#Nginx基础架构" class="headerlink" title="Nginx基础架构"></a>Nginx基础架构</h1><h2 id="Nginx的架构设计"><a href="#Nginx的架构设计" class="headerlink" title="Nginx的架构设计"></a>Nginx的架构设计</h2><h3 id="优秀的模块化设计"><a href="#优秀的模块化设计" class="headerlink" title="优秀的模块化设计"></a>优秀的模块化设计</h3><p>高度模块化的设计是Nginx的架构基础。在nginx中，除了少量的核心代码，其他一切皆为模块。其具有如下特点：</p>
<ol>
<li><p>高度抽象的模块接口</p>
<p>所有模块都遵循同样的ngx_module_t接口设计规范，减少了系统变数。</p>
</li>
<li><p>模块接口非常简单，具有高度灵活性</p>
<p>模块的基本接口nginx_module_t足够简单，只设计模块的初始化、退出以及对配置项的处理，同时带来了足够的灵活性。</p>
<p><a href="https://imgtu.com/i/2pk4cn" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/05/26/2pk4cn.md.png" alt="2pk4cn.md.png"></a></p>
</li>
</ol>
<p><center>图8-1</center><br>如图所示，nginx_module_t结构体作为所有模块的通用接口，其只定义了<code>init_master</code> <code>init_module</code> <code>init_process</code> <code>init_thread</code> <code>exit_thread</code> <code>exit_process</code> <code>exit_master</code>这七个回调方法，他们负责模块的初始化与退出，同时权限非常高，可以处理核心结构体nginx_cycle_t。</p>
<h4 id="nginx-module-t类"><a href="#nginx-module-t类" class="headerlink" title="nginx_module_t类"></a>nginx_module_t类</h4><p>nginx_module_t结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_module_s</span> &#123;</span></span><br><span class="line">  <span class="comment">/* 下面的ctx_index、index、spare0、spare1、spare2、spare3、version不需要在定义时赋值，可以用Nginx准备好的宏NGINX_MODULE_V1来定义，其已经定义好了这7个值。 #define NGINX_MODULE_V1 0,0,0,0,0,0,1 */</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 对于一类模块（同一type）而言，ctx_index表示当前模块在这类模块中的序号，改成员变量通常由管理这类模块的一个nginx核心模块设置的，对于http而言，由核心模块nginx_http_module设置。ctx_index十分重要，nginx模块化依赖各个模块顺序，其既表达优先级，也用于表面每个模块的位置*/</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            ctx_index;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* index表示当前模块在ngx_modules数组中序号，即为当前模块在所有模块中的序号，nginx启动时，依据ngx_modules数组设置该值*/</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>                 *name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            spare0;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            spare1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            version;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>           *signature;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 指向一类模块的上下文结构体，例如在http模块中，ctx指向ngx_http_module_t结构体*/</span></span><br><span class="line">    <span class="keyword">void</span>                 *ctx;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* commands将处理nginx.conf中的配置项 */</span></span><br><span class="line">    <span class="keyword">ngx_command_t</span>        *commands;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* master进程启动时回调init_master，但目前未使用，设置为NULL*/</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_master)(<span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 初始化所有模块是调用init_module，在master/worker模式下，该阶段在启动worker子进程前完成 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_module)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*init_process在正常服务前被调用，在master/worker模式下，多个worker子进程已产生，在每个woker进程的初始化过程中会调用所有模块的改函数 */</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_process)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_thread)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">void</span>                (*exit_thread)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*exit_process在服务停止前被调用，在master/worker模式下，worker进程退出前调用 */</span></span><br><span class="line">    <span class="keyword">void</span>                (*exit_process)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*exit_master在master进程退出前调用*/</span></span><br><span class="line">    <span class="keyword">void</span>                (*exit_master)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook0;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook1;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook2;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook3;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook4;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook5;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook6;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook7;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ctx是void指针，可以指向任何数据，这改模块提供了极大的灵活性。</p>
<ol>
<li><p>配置模块的设计</p>
<p>ngx_module_t接口中type类型指名了nginx在设计模块时定义模块类型，允许专注于不同领域的模块按照类型来区别。配置类型模块是唯一一个只有一个模块的模块类型。配置模块的类型叫做NGX_CONF_MODULE，其仅有的模块为ngx_conf_module，其为底层模块，指导所有模块以配置项为核心来提供功能。</p>
</li>
<li><p>核心模块的简单化</p>
</li>
<li><p>多层次，多类别的模块设计</p>
<p>所以模块间是分层次、分类别的，官方Nginx共用5大类型模块：核心模块、配置模块、时间模块、HTTP模块、mail模块。虽然都具备相同的ngx_module_t接口，但在请求处理中的层级并不相同。</p>
<p><a href="https://imgtu.com/i/2ELokD" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/05/30/2ELokD.png" alt="2ELokD.png"></a></p>
</li>
</ol>
<p><center>图8-2</center><br>如上图，配置模块和核心模块由Nginx的框架代码定义，配置模块是所有模块的基础，其实现了最基础的配置项解析功能（解析nginx.conf）。Nginx框架还会调用核心模块，但其他3种模块都不会与框架产生直接关系。事件模块、HTTP模块、mail模块的共性为：它们在核心模块中各有一个模块，作为其代言人，并在同类模块中有一个作为核心业务与管理功能的模块。</p>
<h3 id="事件驱动框架"><a href="#事件驱动框架" class="headerlink" title="事件驱动框架"></a>事件驱动框架</h3><p>事件驱动指：由一些事件发送源来产生事件，由一个或多个时间收集器来收集、分发时间，然后许多事件处理器会注册自己感兴趣的，同时会消费这些事件。</p>
<p>对于nginx来说，一般会由网卡、磁盘产生事件，事件模块负责收集、分发操作，所有模块都可能是消费者，其首选向事件模块注册感兴趣的事件类型，这样，有事件产生时，事件模块会把事件分发到响应模块中进行处理。</p>
<p>传统Web服务器，采用的事件驱动往往局限于在TCP连接、关闭事件上，一个连接建立后，在其关闭前所有操作都不再是事件驱动，此时会退化为按需执行每个操作的批处理模式，这样，每个请求在连接后都将始终占有系统资源，直到连接关闭才会释放。</p>
<p>Nginx则不然，他不会使用进程或线程作为事件消费者，所谓事件消费者只能是某个模块。只有事件收集器、分发器才有资格占用进程资源，它们会在分发某个事件时调用事件消费模块使用当前占用进程资源。</p>
<p><a href="https://imgtu.com/i/2EXtrq" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/05/30/2EXtrq.png" alt="2EXtrq.png"></a></p>
<p><center>图8-4</center><br>如上图，在事件收集、分发者进程的一次处理过程中，5个事件按序被收集后，将开始使用当前进程分发事件，从而调用响应的事件消费者模块来处理事件。事件消费者只是被事件分发者进程短期调用而已。</p>
<h3 id="请求的多阶段异步处理"><a href="#请求的多阶段异步处理" class="headerlink" title="请求的多阶段异步处理"></a>请求的多阶段异步处理</h3><p>请求的多阶段异步处理是指：把一个请求过程按照事件的触发方式划分为多个阶段，每个阶段都可以由事件收集、分发来触发。</p>
<p>请求的多阶段异步处理优势：这种设计配合事件驱动架构，将极地提高网络性能，同时使得每个进程都能全力运转，不会或者尽量少的出现进程休眠状况。</p>
<p>划分请求阶段原则为：找到请求处理流程中阻塞方法，在阻塞代码段上按照下面四个方法来划分阶段：</p>
<ol>
<li><p>将阻塞进程的方法按照相关的触发事件分解为两个阶段：</p>
<p>一个本身可能导致进程休眠的方法或系统调用，一般可以分解为多个更小的方法或者系统调用，这些调用间可以通过事件触发关联起来。大部分情况，一个阻塞的方法调用可以划分为两个阶段：第一阶段为，将阻塞方法改为非阻塞方法，并将进程归还给事件分发器；第二阶段，用于处理非阻塞方法最终返回结果，这里的返回结果就是第二阶段触发事件。</p>
<p>例如使用send调用时，如果使用阻塞socket句柄，send向内核发送数据后将使当前进程休眠，直到成功发出数据。可以将send调用划分为两个阶段：使用非阻塞socket句柄，发送后进程不休眠，再将socket句柄加入事件收集器中就可以等待相应事件触发下一阶段，send发送数据被对方接收后会触发send结果返回阶段。</p>
</li>
<li><p>将阻塞方法调用按照时间分解为多个阶段的方法调用</p>
<p>系统中事件收集器、分发器并非可以处理任何事件。例如读取文件调用（非异步I/O），如果我们读取10MB文件，这些文件在磁盘块未必是连续的，此时可能需要多次驱动硬盘寻址，寻址时，进程多半会休眠或等待。如果内核不支持异步I/O时（或未打开），就不能采用第一个方案。此时可以分解读取文件调用：把10MB的文件划分为1000份，每次读取10KB。每次读取10KB的时间是可控的，意味着该事件不会占用进程太久，整个系统可以及时处理其他请求。</p>
<p>在读取0KB-10KB后如何进入10KB-20KB呢，可以有多种方式：如读取完10KB要使用网络进行发送，可以由网络事件进行触发。或者没有网络事件，可以设置一个简单的定时器。</p>
</li>
<li><p>在”无所事事”且必须等待系统响应时，使用定时器划分阶段</p>
<p>有时阻塞代码可以是这样的：进行某个无阻塞的系统调用后，必须通过持续检查标志位来确定是否继续向下执行，当标志位没有获得满足时就循环地检查。此时，应该使用定时器来代替循环检查标志，这样定时器事件发送时就会先检查标志，如果标志不满足，就立即归还进程控制权，同时继续加入期望的下一个定时器事件。</p>
</li>
<li><p>如果阻塞方法完全无法划分，则必须使用独立的进程执行这个阻塞方法</p>
<p>如果某个方法的调用时可能导致进程休眠，或者占用进程时间过长，开始又无法将该方法分级为非阻塞的方法，那么，这与事件驱动框架是相违背的。通常是由于方法实现者未开放非阻塞接口所导致，这时必须通过产生新的进程或者指定某个非事件分发者进程来执行阻塞方法，并在阻塞方法执行完毕时向事件收集、分发者进程发送事件通知继续执行。因此，至少要拆分为两个阶段：阻塞方法执行前阶段、阻塞方法执行后阶段，阻塞方法由单独的进程取调度，并在方法返回后发送事件通知。一旦出现这种情况，应该考虑这样的事件消费者是否合理，有没有必要使用这种违反事件驱动的方式来解决阻塞问题。</p>
</li>
</ol>
<h3 id="管理进程、多工作进程设计"><a href="#管理进程、多工作进程设计" class="headerlink" title="管理进程、多工作进程设计"></a>管理进程、多工作进程设计</h3><p>Nginx采用一个master管理进程，多个worker工作进程的设计方式，如下图：</p>
<p><a href="https://imgtu.com/i/2npYee" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/06/01/2npYee.png" alt="2npYee.png"></a></p>
<p><center>图8-5</center><br>该设计的优点为：</p>
<ol>
<li><p>利用多核系统的并发处理能力</p>
</li>
<li><p>负载均衡</p>
<p>每个worker工作进程通过进程间通信来实现负载均衡，即一个请求到达时会更容易地被分配到负载较轻的进程中。</p>
</li>
<li><p>管理进程负责监控工作进程的状态，并负责其行为</p>
<p>管理进程不会占用太多系统资源，其只用来启动、停止、建库或使用其他行为来控制工作进程。首选，这提高了系统的可靠性，当工作进程出现问题时，管理进程可以启动新的工作进程来避免系统性能下降。其次，管理进程支持nginx服务运行中的程序升级、配置项的修改等操作。这种设计使得动态可扩展性、动态定制性、动态可进化性较容易实现。</p>
</li>
</ol>
<h3 id="内存池的设计"><a href="#内存池的设计" class="headerlink" title="内存池的设计"></a>内存池的设计</h3><p>为了避免出现内存碎片、减少向操作系统申请内存的次数、降低各个模块的开发复杂度，Nginx设计了简单的内存池。内存池没有很复杂的功能：其通常不负责回收内存池中已经分配的内存。内存池最大的优点在于：把多次向系统申请内存的操作整合到一次，这大大减少了CPU资源消耗，同时减少了内存碎片。</p>
<h2 id="Nginx框架中的核心结构体ngx-cycle-t"><a href="#Nginx框架中的核心结构体ngx-cycle-t" class="headerlink" title="Nginx框架中的核心结构体ngx_cycle_t"></a>Nginx框架中的核心结构体ngx_cycle_t</h2><p>Nginx核心的框架代码围绕ngx_cycle_t结构体展开。</p>
<h3 id="ngx-listening-t结构体"><a href="#ngx-listening-t结构体" class="headerlink" title="ngx_listening_t结构体"></a>ngx_listening_t结构体</h3><p>作为web服务器，nginx首先需要监听端口并处理其中的网络事件。ngx_cycle_t对象有一个动态数组成员listening，其每个元素都是ngx_listening_t结构体，每个ngx_listening_t结构体代表nginx服务器监听的一个端口。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_listening_s</span>  <span class="title">ngx_listening_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_listening_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_socket_t</span>        fd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>    *<span class="title">sockaddr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span>           socklen;    <span class="comment">/* size of sockaddr */</span></span><br><span class="line">    <span class="keyword">size_t</span>              addr_text_max_len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>           addr_text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>                 type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* TCP实现监听时的backlog队列，它表示允许正在通过三次握手建立TCP连接但还没有任何进程开始处理的连接的最大个数 */</span></span><br><span class="line">    <span class="keyword">int</span>                 backlog;</span><br><span class="line">  <span class="comment">/* 内核中对该套接字的接收缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">int</span>                 rcvbuf;</span><br><span class="line">  <span class="comment">/* 内核中对该套接字的发送缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">int</span>                 sndbuf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KEEPALIVE_TUNABLE)</span></span><br><span class="line">    <span class="keyword">int</span>                 keepidle;</span><br><span class="line">    <span class="keyword">int</span>                 keepintvl;</span><br><span class="line">    <span class="keyword">int</span>                 keepcnt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler of accepted connection */</span></span><br><span class="line">    <span class="comment">/* 当新的TCP连接成功建立后的处理方法 */</span></span><br><span class="line">    ngx_connection_handler_pt   handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>               *servers;  <span class="comment">/* array of ngx_http_in_addr_t, for example */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* log和kogp都是可用的日志对象的指针 */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>           <span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>          *logp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果为新的TCP连接创建内存池，则内存池从初始大小 */</span></span><br><span class="line">    <span class="keyword">size_t</span>              pool_size;</span><br><span class="line">    <span class="comment">/* should be here because of the AcceptEx() preread */</span></span><br><span class="line">    <span class="keyword">size_t</span>              post_accept_buffer_size;</span><br><span class="line">    <span class="comment">/* should be here because of the deferred accept */</span></span><br><span class="line">    <span class="comment">/* TCP_DEFER_ACCEPT选项将在建立TCP连接成功并且接受到用户请求数据后，才向对监听套接字感兴趣的进程发送事件通知，而连接成功后，如果post_accept_timeout秒后仍未收到用户数据，则内核直接丢弃连接 */</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>          post_accept_timeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 前一个ngx_listening_t的指针，多个ngx_listening_t结构体之间由previous指针组成单链表 */</span></span><br><span class="line">    <span class="keyword">ngx_listening_t</span>    *previous;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 当前监听句柄对应着的ngx_connection_t结构体，为一个单链表 */</span></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>   *connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>        rbtree;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>   sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>          worker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 标志位，为1表示当前监听句柄有效，且执行ngx_init_cycle时不关闭监听端口，为0正常关闭。该标志由架构代码自动设置 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            open:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 为1表示已有ngx_cycle_t来初始化新的ngx_cycle_t结构体时，不关闭原先打开的监听端口，对运行中升级程序很有效。为0时，表示正常关闭曾经打开的监听端口。该标志由架构代码自动设置 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            remain:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 1表示跳过设置当前ngx_listening_t结构体中套接字，0正常初始化套接字。 该标志由架构代码自动设置*/</span></span><br><span class="line">    <span class="keyword">unsigned</span>            ignore:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>            bound:<span class="number">1</span>;       <span class="comment">/* already bound */</span></span><br><span class="line">    <span class="comment">/* 当前监听句柄是否来着于前一个进程 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            inherited:<span class="number">1</span>;   <span class="comment">/* inherited from previous process */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            nonblocking_accept:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* （书中说是当前套接字是否已监听），看代码似乎是说要重新执行listing函数来设置监听的第二个参数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            listen:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 套接字是否阻塞，目前无意义 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            nonblocking:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            shared:<span class="number">1</span>;    <span class="comment">/* shared between threads or processes */</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 1时nginx将网络地址转变为字符串形式地址 */</span></span><br><span class="line">    <span class="keyword">unsigned</span>            addr_ntop:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            wildcard:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">    <span class="keyword">unsigned</span>            ipv6only:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">unsigned</span>            reuseport:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            add_reuseport:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            keepalive:<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>            deferred_accept:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            delete_deferred:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>            add_deferred:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    <span class="keyword">char</span>               *accept_filter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">    <span class="keyword">int</span>                 setfib;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">    <span class="keyword">int</span>                 fastopen;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ngx_connection_handler_pt类型的handler成员表示在这个监听端口上成功建立新的tcp连接后，就会回调handler方法，其定义为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*ngx_connection_handler_pt)(ngx_connect_t *c);</span><br></pre></td></tr></table></figure>
<h3 id="ngx-cycle-t结构体"><a href="#ngx-cycle-t结构体" class="headerlink" title="ngx_cycle_t结构体"></a>ngx_cycle_t结构体</h3><p>首先来介绍一下ngx_cycle_t中的成员（其中connectins、read_events、write_events、files、free_connection成员与事件模块强相关，在事件模块中详细介绍）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_cycle_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 保存着所有模块（modules）存储配置项的结构体的指针。其首先是一个数组，每个数组成员又是一个指针，这个指针指向另一个存储着指针的数组 */</span></span><br><span class="line">    <span class="keyword">void</span>                  ****conf_ctx;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 内存池 */</span></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>               *pool;</span><br><span class="line">    <span class="comment">/* 在未执行ngx_init_cycle方法前，未确定日志输出位置时，暂时使用log，将内容输出到屏幕上，在执行了ngx_init_cycle方法后，确定日志输出位置时，会替换该值 */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>                *<span class="built_in">log</span>;</span><br><span class="line">    <span class="comment">/* 由nginx.conf配置文件读取到日志后，将开始初始化error_log日志文件，但log依然在向屏幕输出日志。这时会使用new_log对象暂时替代log日志，待初始化成功，使用new_log的地址替换log指针 */</span></span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 new_log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                log_use_stderr;  <span class="comment">/* unsigned  log_use_stderr:1; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 对于poll、rtsig的事件模块，会以有效文件句柄来预先建立这些ngx_connection_t结构体，以加速事件的收集分发，此时file保存了ngx_connection_t的指针数组 */</span></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>        **files;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 可用连接池，与free_connection_n配合使用 */</span></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>         *free_connections;</span><br><span class="line">    <span class="comment">/* 可用连接池中连接总数 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                free_connection_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_module_t</span>            **modules;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                modules_n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                modules_used;    <span class="comment">/* unsigned  modules_used:1; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 双向链表容器，元素类型为ngx_connection_t，表示可重复使用连接队列 */</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>               reusable_connections_queue;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                reusable_connections_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 动态数组，每个数组元素中存储着ngx_listening_t成员，表示监听端口及相关参数 */</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               listening;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 动态数组容器，其存储着Nginx所有要操作的目录。如果目录不存在则会试图创建，创建失败将会导致nginx启动失败.比如配置了client_body_temp_path，此时就需要创建一个路径临时存放请求用户http包体*/</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               paths;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               config_dump;</span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>              config_dump_rbtree;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>         config_dump_sentinel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 单链表容器，元素类型为ngx_open_file_t结构体，其表示nginx已经打开的所有文件 */</span></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                open_files;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 单链表容器，元素类型为ngx_shm_zone_y，每一个元素表示一块共享内存 */</span></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                shared_memory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 当前进程中连接总数 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                connection_n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                files_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 指向当前进程中所有链接对象，与connection_n配合使用 */</span> </span><br><span class="line">    <span class="keyword">ngx_connection_t</span>         *connections;</span><br><span class="line">    <span class="comment">/* 指向当前进程中所有读事件 connection_n同时表示读事件总数*/</span> </span><br><span class="line">    <span class="keyword">ngx_event_t</span>              *read_events;</span><br><span class="line">    <span class="comment">/* 指向当前进程中所有写事件 connection_n同时表示写事件总数*/</span> </span><br><span class="line">    <span class="keyword">ngx_event_t</span>              *write_events;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 旧的ngx_cycle_t对象引用上一个ngx_cycle_t对象的成员。在调用ngx_init_cycle方法前会建立一个临时ngx_cycle_t对象保存一些变量，再调用ngx_init_cycle方法时将旧的ngx_cycle_t传递进去，此时old_cycle将保存旧的ngx_cycle_t */</span></span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>              *old_cycle;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 配置文件相对按照目录的路径名 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_file;</span><br><span class="line">    <span class="comment">/* nginx处理配置文件时需要特殊处理的在命令行携带的参数，一般是-g选项携带的参数 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_param;</span><br><span class="line">    <span class="comment">/* nginx配置文件所在目录的路径 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_prefix;</span><br><span class="line">    <span class="comment">/* nginx安装目录 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 prefix;</span><br><span class="line">    <span class="comment">/* 用于进程间同步的锁的名称 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 lock_file;</span><br><span class="line">    <span class="comment">/* gethostname获取到的主机名 */</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 hostname;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-cycle-t支持的方法"><a href="#ngx-cycle-t支持的方法" class="headerlink" title="ngx_cycle_t支持的方法"></a>ngx_cycle_t支持的方法</h3><p>每个模块都可以通过init_module、init_process、exit_process、exit_master等方法操作进程的单独的ngx_cycle_t结构体。nginx框架关于ngx_cycle_t结构体方法如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>方法名</th>
<th>参数含义</th>
<th>执行含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_cycle_t <em>ngx_init_cycle(ngx_cycle_t </em>old_cycle)</td>
<td>old_cycle表示临时的ngx_cycle_t指针，一般用来传递配置文件路径等参数。</td>
<td>返回初始化完成的结构体，该函数将会负责初始化ngx_cycle_t中的数据结构、解析配置文件、加载所有模块、打开监听端口、初始化进程间通讯方式等工作。失败返回null。</td>
</tr>
<tr>
<td>ngx_init_t <em>ngx_process_options(ngx_cycle_t </em>cycle)</td>
<td>与上一个参数一致</td>
<td>用运行Nginx时可能携带的目录参数来初始化cycle，包括初始化运行目录、配置目录，并生成完整的nginx.conf配置文件路径</td>
</tr>
<tr>
<td>ngx_init_t <em>ngx_add_inherited_sockets(ngx_cycle_t </em>cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>在不重启服务器升级时，老的nginx进程会通过环境变量NGINX来传递需要打开的监听端口，新的nginx进程会通过ngx_add_ingerited_sockets方法来使用已经打开的TCP监听端口</td>
</tr>
<tr>
<td>ngx_int_t ngx_open_listening_sockets(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>监听、绑定cycle中listening动态数组指定的相应端口</td>
</tr>
<tr>
<td>void <em>ngx_configure_listening_sockets(ngx_cycle_t </em>cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>根据nginx.conf中的配置项设置已经监听的句柄</td>
</tr>
<tr>
<td>void ngx_close_listening_sockets(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>关闭cycle中listening动态数组中已经监听的句柄</td>
</tr>
<tr>
<td>void <em>ngx_master_process_cycle(ngx_cycle_t </em>cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>进入master进程主循环</td>
</tr>
<tr>
<td>void ngx_master_single_cycle(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>进入单进程模式的工作循环</td>
</tr>
<tr>
<td>void ngx_start_worker_processes(ngx_cycle_t *cycle, ngx_int_t n, ngx_int_t type)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针，n是启动进程数量，type是启动方式，其取值为如下5个；1）NGX_PROCESS_RESPAWN；2)NGX_PROCESS_NORESPAWN；3)NGX_PROCESS_JUST_SPAWN；4)NGX_PROCESS_JUST_RESPAWN；5)NGX_PROCESS_DEFACHED。type值影响ngx_process_t中respawn，detached，just_spawn标志位值</td>
<td>启动n个work子进程，并设置好每个子进程与父进程之间使用socketpair系统调用建立起来的socket句柄通信机制</td>
</tr>
<tr>
<td>void ngx_start_cache_manger_processes(ngx_cycle_t *cycle, ngx_nint_t respawn)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,respawn与ngx_start_worker_processes的type一致</td>
<td>根据是否使用文件缓存模块，即cycle中存储路径的动态数组中是否有路径的manage标志打开，来决定是否启动cache manage子进程，根据loader标志位来决定是否启动cache loader子进程</td>
</tr>
<tr>
<td>void ngx_pass_open_channel(ngx_cycle_t <em>cycle, ngx_channel_t </em>ch)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针，ch是将要发送的信息</td>
<td>向所有已经打开的channel（通过socketpair生成的句柄进行通信）发送ch信息</td>
</tr>
<tr>
<td>void ngx_single_worker_processes(ngx_cycle_t *cycle, int signo)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针，signo是信号</td>
<td>处理worker进程接受到的信号</td>
</tr>
<tr>
<td>ngx_uint_t ngx_reap_children(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>检查master进程的所有子进程，根据每个子进程的状态(ngx_process_t结构体中标志位)判断是否要启动子进程、更改pid文件等</td>
</tr>
<tr>
<td>void ngx_master_process_exit(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>退出master进程主循环</td>
</tr>
<tr>
<td>void ngx_work_process_cycle(ngx_cycle_t <em>cycle, void </em>data)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,data目前还未使用，null</td>
<td>进入worker进程主循环</td>
</tr>
<tr>
<td>void ngx_work_process_init(ngx_cycle_t *cycle, ngx_uint_t priority)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,priority是当前worker进程的优先级</td>
<td>进入worker进程主循环之前的初始化工作</td>
</tr>
<tr>
<td>void ngx_work_process_exit(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>退出worker进程主循环</td>
</tr>
<tr>
<td>void ngx_cache_manager_process_cycle(ngx_cycle_t <em>cycle, void </em>data)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针,data是传入的ngx_cache_manager_ctx_t结构体指针</td>
<td>执行缓存管理工作的循环方法。</td>
</tr>
<tr>
<td>void ngx_process_events_and_timers(ngx_cycle_t *cycle)</td>
<td>cycle是当前进程的ngx_cycle_t结构体指针</td>
<td>使用事件管理模块处理截止到现在已经收集到的事件</td>
</tr>
</tbody>
</table>
</div>
<h3 id="nginx启动时框架处理流程"><a href="#nginx启动时框架处理流程" class="headerlink" title="nginx启动时框架处理流程"></a>nginx启动时框架处理流程</h3><p><a href="https://imgtu.com/i/21Zga9" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/06/03/21Zga9.png" alt="21Zga9.png"></a></p>
<p><center>图8-6</center></p>
<h2 id="nginx启动过程详解"><a href="#nginx启动过程详解" class="headerlink" title="nginx启动过程详解"></a>nginx启动过程详解</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ngx_cdecl</span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> *argv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>        *b;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>        *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>      *cycle, init_cycle;</span><br><span class="line">    <span class="keyword">ngx_conf_dump_t</span>  *cd;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    ngx_debug_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_strerror_init() != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_get_options(argc, argv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_show_version) &#123;</span><br><span class="line">        ngx_show_version_info();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ngx_test_config) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* TODO */</span> ngx_max_sockets = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    ngx_time_init();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    ngx_regex_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取进程id和父进程id</span></span><br><span class="line">    ngx_pid = ngx_getpid();</span><br><span class="line">    ngx_parent = ngx_getppid();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = ngx_log_init(ngx_prefix);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* STUB */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_OPENSSL)</span></span><br><span class="line">    ngx_ssl_init(<span class="built_in">log</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * init_cycle-&gt;log is required for signal handlers and</span></span><br><span class="line"><span class="comment">     * ngx_process_options()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;init_cycle, <span class="keyword">sizeof</span>(<span class="keyword">ngx_cycle_t</span>));</span><br><span class="line">    init_cycle.<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    ngx_cycle = &amp;init_cycle;</span><br><span class="line"></span><br><span class="line">    init_cycle.pool = ngx_create_pool(<span class="number">1024</span>, <span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (init_cycle.pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_save_argv(&amp;init_cycle, argc, argv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_process_options(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_os_init(<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ngx_crc32_table_init() requires ngx_cacheline_size set in ngx_os_init()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_crc32_table_init() != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ngx_slab_sizes_init() requires ngx_pagesize set in ngx_os_init()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ngx_slab_sizes_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_preinit_modules() != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle = ngx_init_cycle(&amp;init_cycle);</span><br><span class="line">    <span class="keyword">if</span> (cycle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">            ngx_log_stderr(<span class="number">0</span>, <span class="string">"configuration file %s test failed"</span>,</span><br><span class="line">                           init_cycle.conf_file.data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ngx_quiet_mode) &#123;</span><br><span class="line">            ngx_log_stderr(<span class="number">0</span>, <span class="string">"configuration file %s test is successful"</span>,</span><br><span class="line">                           cycle-&gt;conf_file.data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_dump_config) &#123;</span><br><span class="line">            cd = cycle-&gt;config_dump.elts;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;config_dump.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">                ngx_write_stdout(<span class="string">"# configuration file "</span>);</span><br><span class="line">                (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, cd[i].name.data,</span><br><span class="line">                                    cd[i].name.len);</span><br><span class="line">                ngx_write_stdout(<span class="string">":"</span> NGX_LINEFEED);</span><br><span class="line"></span><br><span class="line">                b = cd[i].buffer;</span><br><span class="line"></span><br><span class="line">                (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, b-&gt;pos, b-&gt;last - b-&gt;pos);</span><br><span class="line">                ngx_write_stdout(NGX_LINEFEED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_signal) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_signal_process(cycle, ngx_signal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_os_status(cycle-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    ngx_cycle = cycle;</span><br><span class="line"></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;master &amp;&amp; ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">        ngx_process = NGX_PROCESS_MASTER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(NGX_WIN32)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_init_signals(cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ngx_inherited &amp;&amp; ccf-&gt;daemon) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_daemon(cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_daemonized = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_inherited) &#123;</span><br><span class="line">        ngx_daemonized = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_create_pidfile(&amp;ccf-&gt;pid, cycle-&gt;<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_log_redirect_stderr(cycle) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;file-&gt;fd != ngx_stderr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_close_file(<span class="built_in">log</span>-&gt;file-&gt;fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_close_file_n <span class="string">" built-in log failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_use_stderr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">        ngx_single_process_cycle(cycle);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_master_process_cycle(cycle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析启动参数"><a href="#解析启动参数" class="headerlink" title="解析启动参数"></a>解析启动参数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_get_options(argc, argv) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>逐字符解析启动请求参数，根据解析参数设置全局变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_get_options(<span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> *argv)</span><br><span class="line">&#123;</span><br><span class="line">    u_char     *p;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>   i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line"></span><br><span class="line">        p = (u_char *) argv[i];</span><br><span class="line">        <span class="comment">// 启动参数，必须使用-开始</span></span><br><span class="line">        <span class="keyword">if</span> (*p++ != <span class="string">'-'</span>) &#123;</span><br><span class="line">            ngx_log_stderr(<span class="number">0</span>, <span class="string">"invalid option: \"%s\""</span>, argv[i]);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (*p) &#123;</span><br><span class="line">            <span class="comment">// 检查参数</span></span><br><span class="line">            <span class="keyword">switch</span> (*p++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">                <span class="comment">// 打印help信息标识</span></span><br><span class="line">                ngx_show_version = <span class="number">1</span>;</span><br><span class="line">                ngx_show_help = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'v'</span>:</span><br><span class="line">                <span class="comment">// 打印版本标识</span></span><br><span class="line">                ngx_show_version = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'V'</span>:</span><br><span class="line">                <span class="comment">// 打印版本标识和显示配置编译阶段信息</span></span><br><span class="line">                ngx_show_version = <span class="number">1</span>;</span><br><span class="line">                ngx_show_configure = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                <span class="comment">// 测试配置正确性标识</span></span><br><span class="line">                ngx_test_config = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'T'</span>:</span><br><span class="line">                <span class="comment">// 测速配置正确性标识，dump配置并输出标识</span></span><br><span class="line">                ngx_test_config = <span class="number">1</span>;</span><br><span class="line">                ngx_dump_config = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'q'</span>:</span><br><span class="line">                <span class="comment">// 测试配置选项时，使用-q使得error级别以下的信息不输出</span></span><br><span class="line">                ngx_quiet_mode = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'p'</span>:</span><br><span class="line">                <span class="comment">// 另行指定nginx安装目录。决定了，error日志，conf配置和pid文件存储的默认位置</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    <span class="comment">// 使用ngx_prefix存储值，-p直接接目录，如 -p/home/work/nginx</span></span><br><span class="line">                    ngx_prefix = p;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// -p /home/work/nginx</span></span><br><span class="line">                <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_prefix = (u_char *) argv[i];</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-p\" requires directory name"</span>);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'c'</span>:</span><br><span class="line">                <span class="comment">// 配置文件目录，使用ngx_conf_file存储</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    ngx_conf_file = p;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_conf_file = (u_char *) argv[i];</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-c\" requires file name"</span>);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'g'</span>:</span><br><span class="line">                <span class="comment">// 指定一些全局变量，使用ngx_conf_params存储，后续会被与解析配置方式一样进行解析，使用ngx_conf_params存储</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    ngx_conf_params = p;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_conf_params = (u_char *) argv[i];</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-g\" requires parameter"</span>);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                <span class="comment">// 发送信号，使用ngx_signal存储</span></span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    ngx_signal = (<span class="keyword">char</span> *) p;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[++i]) &#123;</span><br><span class="line">                    ngx_signal = argv[i];</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ngx_log_stderr(<span class="number">0</span>, <span class="string">"option \"-s\" requires parameter"</span>);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_strcmp(ngx_signal, <span class="string">"stop"</span>) == <span class="number">0</span></span><br><span class="line">                    || ngx_strcmp(ngx_signal, <span class="string">"quit"</span>) == <span class="number">0</span></span><br><span class="line">                    || ngx_strcmp(ngx_signal, <span class="string">"reopen"</span>) == <span class="number">0</span></span><br><span class="line">                    || ngx_strcmp(ngx_signal, <span class="string">"reload"</span>) == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 如果是上述四种之一，设置ngx_process为NGX_PROCESS_SIGNALLER</span></span><br><span class="line">                    ngx_process = NGX_PROCESS_SIGNALLER;</span><br><span class="line">                    <span class="keyword">goto</span> next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"invalid option: \"-s %s\""</span>, ngx_signal);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                ngx_log_stderr(<span class="number">0</span>, <span class="string">"invalid option: \"%c\""</span>, *(p - <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化信息"><a href="#初始化信息" class="headerlink" title="初始化信息"></a>初始化信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_time_init();</span><br></pre></td></tr></table></figure>
<p>详见事件处理部分。</p>
<h3 id="初始化log打印描述符"><a href="#初始化log打印描述符" class="headerlink" title="初始化log打印描述符"></a>初始化log打印描述符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log = ngx_log_init(ngx_prefix);</span><br></pre></td></tr></table></figure>
<p>更加启动参数或默认log路径，初始化log信息，包括描述符和等级等信息。</p>
<h3 id="申请内存池空间Pool"><a href="#申请内存池空间Pool" class="headerlink" title="申请内存池空间Pool"></a>申请内存池空间Pool</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ngx_memzero(&amp;init_cycle, sizeof(ngx_cycle_t));</span><br><span class="line">init_cycle.log = log;</span><br><span class="line">ngx_cycle = &amp;init_cycle;</span><br><span class="line"></span><br><span class="line">init_cycle.pool = ngx_create_pool(1024, log);</span><br></pre></td></tr></table></figure>
<h3 id="存储命令行参数"><a href="#存储命令行参数" class="headerlink" title="存储命令行参数"></a>存储命令行参数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_save_argv(&amp;init_cycle, argc, argv) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将命令行存储到全国变量中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ngx_argv</span><br><span class="line">ngx_argc</span><br></pre></td></tr></table></figure>
<h3 id="设置相关路径"><a href="#设置相关路径" class="headerlink" title="设置相关路径"></a>设置相关路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_process_options(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过启动命令行参数或默认值设置cycle中的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_process_options(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  *p;</span><br><span class="line">    <span class="keyword">size_t</span>   len;</span><br><span class="line">    <span class="comment">// 如果存在-p参数，即设置了nginx环境目录</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_prefix) &#123;</span><br><span class="line">        len = ngx_strlen(ngx_prefix);</span><br><span class="line">        p = ngx_prefix;</span><br><span class="line">        <span class="comment">// 如果设置的目录最后不是/，则添加一个/</span></span><br><span class="line">        <span class="keyword">if</span> (len &amp;&amp; !ngx_path_separator(p[len - <span class="number">1</span>])) &#123;</span><br><span class="line">            p = ngx_pnalloc(cycle-&gt;pool, len + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_memcpy(p, ngx_prefix, len);</span><br><span class="line">            p[len++] = <span class="string">'/'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置conf_prefix配置文件所在目录路径和prefix安装路径</span></span><br><span class="line">        cycle-&gt;conf_prefix.len = len;</span><br><span class="line">        cycle-&gt;conf_prefix.data = p;</span><br><span class="line">        cycle-&gt;prefix.len = len;</span><br><span class="line">        cycle-&gt;prefix.data = p;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果未设置，则使用默认路径</span></span><br><span class="line"></span><br><span class="line">#ifndef NGX_PREFIX</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(cycle-&gt;pool, NGX_MAX_PATH);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_getcwd(p, NGX_MAX_PATH) == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_stderr(ngx_errno, <span class="string">"[emerg]: "</span> ngx_getcwd_n <span class="string">" failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = ngx_strlen(p);</span><br><span class="line"></span><br><span class="line">        p[len++] = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">        cycle-&gt;conf_prefix.len = len;</span><br><span class="line">        cycle-&gt;conf_prefix.data = p;</span><br><span class="line">        cycle-&gt;prefix.len = len;</span><br><span class="line">        cycle-&gt;prefix.data = p;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NGX_CONF_PREFIX</span></span><br><span class="line">        <span class="comment">// 设置conf_prefix为conf/，为相对于prefix路径</span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;conf_prefix, NGX_CONF_PREFIX);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;conf_prefix, NGX_PREFIX);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// /usr/local/nginx/</span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;prefix, NGX_PREFIX);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果-c指定了配置文件，则设置为对应文件</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_file) &#123;</span><br><span class="line">        cycle-&gt;conf_file.len = ngx_strlen(ngx_conf_file);</span><br><span class="line">        cycle-&gt;conf_file.data = ngx_conf_file;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则设置为相对与prefix的路径conf/nginx.conf</span></span><br><span class="line">        ngx_str_set(&amp;cycle-&gt;conf_file, NGX_CONF_PATH);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据prefix、和conf_file二者确认实际配置文件路径</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_full_name(cycle, &amp;cycle-&gt;conf_file, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据conf_file设置conf_prefix</span></span><br><span class="line">    <span class="keyword">for</span> (p = cycle-&gt;conf_file.data + cycle-&gt;conf_file.len - <span class="number">1</span>;</span><br><span class="line">         p &gt; cycle-&gt;conf_file.data;</span><br><span class="line">         p--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_path_separator(*p)) &#123;</span><br><span class="line">            cycle-&gt;conf_prefix.len = p - cycle-&gt;conf_file.data + <span class="number">1</span>;</span><br><span class="line">            cycle-&gt;conf_prefix.data = cycle-&gt;conf_file.data;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果使用-g指定了额外参数，使用cycle-&gt;conf_param存储</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_params) &#123;</span><br><span class="line">        cycle-&gt;conf_param.len = ngx_strlen(ngx_conf_params);</span><br><span class="line">        cycle-&gt;conf_param.data = ngx_conf_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">        cycle-&gt;<span class="built_in">log</span>-&gt;log_level = NGX_LOG_INFO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化系统相关全局变量"><a href="#初始化系统相关全局变量" class="headerlink" title="初始化系统相关全局变量"></a>初始化系统相关全局变量</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_os_init(<span class="built_in">log</span>) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>待详细查看。目前看包括如下数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ngx_pagesize = getpagesize(); // 内存分页大小</span><br><span class="line">ngx_cacheline_size = NGX_CPU_CACHE_LINE; // 缓存行的大小</span><br><span class="line">ngx_ncpu = sysconf(_SC_NPROCESSORS_ONLN); // cpu数据</span><br><span class="line"></span><br><span class="line">getrlimit(RLIMIT_NOFILE, &amp;rlmt);</span><br><span class="line">ngx_max_sockets = (ngx_int_t) rlmt.rlim_cur; // 最大sockets链接数量</span><br></pre></td></tr></table></figure>
<h3 id="初始化差错校验"><a href="#初始化差错校验" class="headerlink" title="初始化差错校验"></a>初始化差错校验</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_crc32_table_init() != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx使用CRC：循环冗余检测（Cycle Redundancy Check)来进行差错校验。</p>
<h3 id="初始化slab共享内存"><a href="#初始化slab共享内存" class="headerlink" title="初始化slab共享内存"></a>初始化slab共享内存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_slab_sizes_init();</span><br></pre></td></tr></table></figure>
<p>具体详见slab共享内存。</p>
<h3 id="监听环境变量中的端口"><a href="#监听环境变量中的端口" class="headerlink" title="监听环境变量中的端口"></a>监听环境变量中的端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于平滑升级来说，需要保证用户无感知，因此要将原本开发监听的套接字存放于环境变量，而后，由新启动的进程读取，重新进行监听。</p>
<p>首选从环境变量NGINX中读取到套接字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_add_inherited_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *p, *v, *inherited;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         s;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>  *ls;</span><br><span class="line">    <span class="comment">// 首选从环境变量NGINX中读取到套接字：</span></span><br><span class="line">    inherited = (u_char *) getenv(NGINX_VAR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inherited == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"using inherited sockets from \"%s\""</span>, inherited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cycle-&gt;listening, cycle-&gt;pool, <span class="number">10</span>,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_listening_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (p = inherited, v = p; *p; p++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*p == <span class="string">':'</span> || *p == <span class="string">';'</span>) &#123;</span><br><span class="line">            s = ngx_atoi(v, p - v);</span><br><span class="line">            <span class="keyword">if</span> (s == NGX_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"invalid socket number \"%s\" in "</span> NGINX_VAR</span><br><span class="line">                              <span class="string">" environment variable, ignoring the rest"</span></span><br><span class="line">                              <span class="string">" of the variable"</span>, v);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            v = p + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 将环境变量里的套接字添加到cyyle的listening中</span></span><br><span class="line">            ls = ngx_array_push(&amp;cycle-&gt;listening);</span><br><span class="line">            <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_memzero(ls, <span class="keyword">sizeof</span>(<span class="keyword">ngx_listening_t</span>));</span><br><span class="line"></span><br><span class="line">            ls-&gt;fd = (<span class="keyword">ngx_socket_t</span>) s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v != p) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"invalid socket number \"%s\" in "</span> NGINX_VAR</span><br><span class="line">                      <span class="string">" environment variable, ignoring"</span>, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_inherited = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_set_inherited_sockets(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取套接字对应的信息ngx_set_inherited_sockets：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line">getsockname(ls[i].fd, ls[i].sockaddr, &amp;ls[i].socklen); <span class="comment">// 获取套接字的sockaddr</span></span><br><span class="line">getsockopt; <span class="comment">// 获取套接字上设置的额外信息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_set_inherited_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line">    <span class="keyword">socklen_t</span>                  olen;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT || NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">    <span class="keyword">ngx_err_t</span>                  err;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">accept_filter_arg</span>   <span class="title">af</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span></span><br><span class="line">    <span class="keyword">int</span>                        timeout;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">    <span class="keyword">int</span>                        reuseport;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 当前listening中的套接字均为从环境变量中继承而来，遍历每一个套接字，获取其对应的ngx_listening_t结构中字段信息</span></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 分配套接字地址</span></span><br><span class="line">        ls[i].sockaddr = ngx_palloc(cycle-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (ls[i].sockaddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用getsockname函数获取套接字地址，如果获取失败，则ignore置1，表示忽略该套接字。</span></span><br><span class="line">        ls[i].socklen = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line">        <span class="keyword">if</span> (getsockname(ls[i].fd, ls[i].sockaddr, &amp;ls[i].socklen) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockname() of the inherited "</span></span><br><span class="line">                          <span class="string">"socket #%d failed"</span>, ls[i].fd);</span><br><span class="line">            ls[i].ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].socklen &gt; (<span class="keyword">socklen_t</span>) <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>)) &#123;</span><br><span class="line">            ls[i].socklen = <span class="keyword">sizeof</span>(<span class="keyword">ngx_sockaddr_t</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据套接字族类型，设置addr_text_max_len大小，即用于存储addr_text字段的空间大小</span></span><br><span class="line">        <span class="keyword">switch</span> (ls[i].sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            ls[i].addr_text_max_len = NGX_INET6_ADDRSTRLEN;</span><br><span class="line">            len = NGX_INET6_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">"[]:65535"</span>) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">        <span class="keyword">case</span> AF_UNIX:</span><br><span class="line">            ls[i].addr_text_max_len = NGX_UNIX_ADDRSTRLEN;</span><br><span class="line">            len = NGX_UNIX_ADDRSTRLEN;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AF_INET:</span><br><span class="line">            ls[i].addr_text_max_len = NGX_INET_ADDRSTRLEN;</span><br><span class="line">            len = NGX_INET_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"the inherited socket #%d has "</span></span><br><span class="line">                          <span class="string">"an unsupported protocol family"</span>, ls[i].fd);</span><br><span class="line">            ls[i].ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].addr_text.data = ngx_pnalloc(cycle-&gt;pool, len);</span><br><span class="line">        <span class="keyword">if</span> (ls[i].addr_text.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用地址回填addr_text内容，IP:PORT</span></span><br><span class="line">        len = ngx_sock_ntop(ls[i].sockaddr, ls[i].socklen,</span><br><span class="line">                            ls[i].addr_text.data, len, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].addr_text.len = len;</span><br><span class="line">        <span class="comment">// 设置默认的backlog</span></span><br><span class="line">        ls[i].backlog = NGX_LISTEN_BACKLOG;</span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">        <span class="comment">// 使用getsockopt获取套接字类型吗，如果失败，则ignore置1</span></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_TYPE, (<span class="keyword">void</span> *) &amp;ls[i].type,</span><br><span class="line">                       &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_TYPE) %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">            ls[i].ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">        <span class="comment">// 使用getsockopt获取套接字rcvbuf，如果没有设置，则默认值-1，后续内容一样，都是通过getsockopt获取套接字的其他特性</span></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_RCVBUF, (<span class="keyword">void</span> *) &amp;ls[i].rcvbuf,</span><br><span class="line">                       &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_RCVBUF) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">            ls[i].rcvbuf = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_SNDBUF, (<span class="keyword">void</span> *) &amp;ls[i].sndbuf,</span><br><span class="line">                       &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_SNDBUF) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">            ls[i].sndbuf = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        <span class="comment">/* SO_SETFIB is currently a set only option */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_SETFIB,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;ls[i].setfib, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_SETFIB) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">            ls[i].setfib = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line"></span><br><span class="line">        reuseport = <span class="number">0</span>;</span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_REUSEPORT_LB</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT_LB,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;reuseport, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_REUSEPORT_LB) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ls[i].reuseport = reuseport ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;reuseport, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">"getsockopt(SO_REUSEPORT) %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ls[i].reuseport = reuseport ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].type != SOCK_STREAM) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line"></span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, IPPROTO_TCP, TCP_FASTOPEN,</span><br><span class="line">                       (<span class="keyword">void</span> *) &amp;ls[i].fastopen, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err != NGX_EOPNOTSUPP &amp;&amp; err != NGX_ENOPROTOOPT</span><br><span class="line">                &amp;&amp; err != NGX_EINVAL)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                              <span class="string">"getsockopt(TCP_FASTOPEN) %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].fastopen = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line"></span><br><span class="line">        ngx_memzero(&amp;af, <span class="keyword">sizeof</span>(struct accept_filter_arg));</span><br><span class="line">        olen = <span class="keyword">sizeof</span>(struct accept_filter_arg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, SOL_SOCKET, SO_ACCEPTFILTER, &amp;af, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EINVAL) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"getsockopt(SO_ACCEPTFILTER) for %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (olen &lt; <span class="keyword">sizeof</span>(struct accept_filter_arg) || af.af_name[<span class="number">0</span>] == <span class="string">'\0'</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].accept_filter = ngx_palloc(cycle-&gt;pool, <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> (ls[i].accept_filter == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        (<span class="keyword">void</span>) ngx_cpystrn((u_char *) ls[i].accept_filter,</span><br><span class="line">                           (u_char *) af.af_name, <span class="number">16</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span></span><br><span class="line"></span><br><span class="line">        timeout = <span class="number">0</span>;</span><br><span class="line">        olen = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getsockopt(ls[i].fd, IPPROTO_TCP, TCP_DEFER_ACCEPT, &amp;timeout, &amp;olen)</span><br><span class="line">            == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EOPNOTSUPP) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"getsockopt(TCP_DEFER_ACCEPT) for %V failed, ignored"</span>,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (olen &lt; <span class="keyword">sizeof</span>(<span class="keyword">int</span>) || timeout == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls[i].deferred_accept = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预初始化模块"><a href="#预初始化模块" class="headerlink" title="预初始化模块"></a>预初始化模块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_preinit_modules() != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">ngx_int_t</span><br><span class="line">ngx_preinit_modules(void)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_uint_t  i;</span><br><span class="line"></span><br><span class="line">    for (i = 0; ngx_modules[i]; i++) &#123;</span><br><span class="line">        // 设置每个模块在所有模块中的index</span><br><span class="line">        ngx_modules[i]-&gt;index = i;</span><br><span class="line">        ngx_modules[i]-&gt;name = ngx_module_names[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_modules_n = i;</span><br><span class="line">    ngx_max_module = ngx_modules_n + NGX_MAX_DYNAMIC_MODULES;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化cycle"><a href="#初始化cycle" class="headerlink" title="初始化cycle"></a>初始化cycle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cycle = ngx_init_cycle(&amp;init_cycle);</span><br><span class="line">if (cycle == NULL) &#123;</span><br><span class="line">   if (ngx_test_config) &#123;</span><br><span class="line">      ngx_log_stderr(0, &quot;configuration file %s test failed&quot;,</span><br><span class="line">                           init_cycle.conf_file.data);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br></pre></td><td class="code"><pre><span class="line">/* 这里参数ngx_cycle_t被视为old cycle，一方面在不终止服务重新加载配置时会执行该操作，此时会传递一个old的cycle，另一方面，在一个新启动的服务来说，根据之前的操作，已经加载了相应的cycle参数，这里会继承上述获取到的部分参数，并进行升级合并 */</span><br><span class="line">ngx_cycle_t *</span><br><span class="line">ngx_init_cycle(ngx_cycle_t *old_cycle)</span><br><span class="line">&#123;</span><br><span class="line">    void                *rv;</span><br><span class="line">    char               **senv;</span><br><span class="line">    ngx_uint_t           i, n;</span><br><span class="line">    ngx_log_t           *log;</span><br><span class="line">    ngx_time_t          *tp;</span><br><span class="line">    ngx_conf_t           conf;</span><br><span class="line">    ngx_pool_t          *pool;</span><br><span class="line">    ngx_cycle_t         *cycle, **old;</span><br><span class="line">    ngx_shm_zone_t      *shm_zone, *oshm_zone;</span><br><span class="line">    ngx_list_part_t     *part, *opart;</span><br><span class="line">    ngx_open_file_t     *file;</span><br><span class="line">    ngx_listening_t     *ls, *nls;</span><br><span class="line">    ngx_core_conf_t     *ccf, *old_ccf;</span><br><span class="line">    ngx_core_module_t   *module;</span><br><span class="line">    char                 hostname[NGX_MAXHOSTNAMELEN];</span><br><span class="line">    // 读取环境变量的TZ，获取时区</span><br><span class="line">    ngx_timezone_update();</span><br><span class="line"></span><br><span class="line">    /* force localtime update with a new timezone */</span><br><span class="line"></span><br><span class="line">    tp = ngx_timeofday();</span><br><span class="line">    tp-&gt;sec = 0;</span><br><span class="line"></span><br><span class="line">    ngx_time_update();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    log = old_cycle-&gt;log;</span><br><span class="line"></span><br><span class="line">    pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, log);</span><br><span class="line">    if (pool == NULL) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    pool-&gt;log = log;</span><br><span class="line">    // 创建一个新的ngx_cycle_t</span><br><span class="line">    cycle = ngx_pcalloc(pool, sizeof(ngx_cycle_t));</span><br><span class="line">    if (cycle == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;pool = pool;</span><br><span class="line">    cycle-&gt;log = log;</span><br><span class="line">    // 存储老的cycle</span><br><span class="line">    cycle-&gt;old_cycle = old_cycle;</span><br><span class="line">    // 继承老的cycle中conf_prefix、prefix、conf_file、conf_param信息</span><br><span class="line">    cycle-&gt;conf_prefix.len = old_cycle-&gt;conf_prefix.len;</span><br><span class="line">    cycle-&gt;conf_prefix.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;conf_prefix);</span><br><span class="line">    if (cycle-&gt;conf_prefix.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;prefix.len = old_cycle-&gt;prefix.len;</span><br><span class="line">    cycle-&gt;prefix.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;prefix);</span><br><span class="line">    if (cycle-&gt;prefix.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;conf_file.len = old_cycle-&gt;conf_file.len;</span><br><span class="line">    cycle-&gt;conf_file.data = ngx_pnalloc(pool, old_cycle-&gt;conf_file.len + 1);</span><br><span class="line">    if (cycle-&gt;conf_file.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    ngx_cpystrn(cycle-&gt;conf_file.data, old_cycle-&gt;conf_file.data,</span><br><span class="line">                old_cycle-&gt;conf_file.len + 1);</span><br><span class="line"></span><br><span class="line">    cycle-&gt;conf_param.len = old_cycle-&gt;conf_param.len;</span><br><span class="line">    cycle-&gt;conf_param.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;conf_param);</span><br><span class="line">    if (cycle-&gt;conf_param.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据旧的path（管理路径列表）分配相应的新的cycle中paths的内存</span><br><span class="line">    n = old_cycle-&gt;paths.nelts ? old_cycle-&gt;paths.nelts : 10;</span><br><span class="line"></span><br><span class="line">    if (ngx_array_init(&amp;cycle-&gt;paths, pool, n, sizeof(ngx_path_t *))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(cycle-&gt;paths.elts, n * sizeof(ngx_path_t *));</span><br><span class="line"></span><br><span class="line">    // 初始化config_dump数组</span><br><span class="line">    if (ngx_array_init(&amp;cycle-&gt;config_dump, pool, 1, sizeof(ngx_conf_dump_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // 初始化config_dump_rbtree红黑树，具体参看红黑树部分解析</span><br><span class="line">    ngx_rbtree_init(&amp;cycle-&gt;config_dump_rbtree, &amp;cycle-&gt;config_dump_sentinel,</span><br><span class="line">                    ngx_str_rbtree_insert_value);</span><br><span class="line">    // 根据旧的open_files（打开文件列表）分配相应的新的cycle中open_files的内存</span><br><span class="line">    if (old_cycle-&gt;open_files.part.nelts) &#123;</span><br><span class="line">        n = old_cycle-&gt;open_files.part.nelts;</span><br><span class="line">        for (part = old_cycle-&gt;open_files.part.next; part; part = part-&gt;next) &#123;</span><br><span class="line">            n += part-&gt;nelts;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        n = 20;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ngx_list_init(&amp;cycle-&gt;open_files, pool, n, sizeof(ngx_open_file_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 根据旧的shared_memory（共享内存列表）分配相应的新的cycle中shared_memory的内存</span><br><span class="line">    if (old_cycle-&gt;shared_memory.part.nelts) &#123;</span><br><span class="line">        n = old_cycle-&gt;shared_memory.part.nelts;</span><br><span class="line">        for (part = old_cycle-&gt;shared_memory.part.next; part; part = part-&gt;next)</span><br><span class="line">        &#123;</span><br><span class="line">            n += part-&gt;nelts;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        n = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ngx_list_init(&amp;cycle-&gt;shared_memory, pool, n, sizeof(ngx_shm_zone_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据旧的listening（监听地址列表）分配相应的新的cycle中listening的内存</span><br><span class="line">    n = old_cycle-&gt;listening.nelts ? old_cycle-&gt;listening.nelts : 10;</span><br><span class="line"></span><br><span class="line">    if (ngx_array_init(&amp;cycle-&gt;listening, pool, n, sizeof(ngx_listening_t))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(cycle-&gt;listening.elts, n * sizeof(ngx_listening_t));</span><br><span class="line"></span><br><span class="line">    // 初始化用于事件模块的reusable_connections_queue，其值为双向队列。具体参考事件模块的处理</span><br><span class="line">    ngx_queue_init(&amp;cycle-&gt;reusable_connections_queue);</span><br><span class="line"></span><br><span class="line">    // 分配配置文件解析内存</span><br><span class="line">    cycle-&gt;conf_ctx = ngx_pcalloc(pool, ngx_max_module * sizeof(void *));</span><br><span class="line">    if (cycle-&gt;conf_ctx == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据gethostname获取机器的hostname</span><br><span class="line">    if (gethostname(hostname, NGX_MAXHOSTNAMELEN) == -1) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, log, ngx_errno, &quot;gethostname() failed&quot;);</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* on Linux gethostname() silently truncates name that does not fit */</span><br><span class="line"></span><br><span class="line">    hostname[NGX_MAXHOSTNAMELEN - 1] = &apos;\0&apos;;</span><br><span class="line">    cycle-&gt;hostname.len = ngx_strlen(hostname);</span><br><span class="line"></span><br><span class="line">    cycle-&gt;hostname.data = ngx_pnalloc(pool, cycle-&gt;hostname.len);</span><br><span class="line">    if (cycle-&gt;hostname.data == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_strlow(cycle-&gt;hostname.data, (u_char *) hostname, cycle-&gt;hostname.len);</span><br><span class="line"></span><br><span class="line">    // 复制全局变量ngx_modules（模块列表）到cycle的modules（深拷贝）</span><br><span class="line">    if (ngx_cycle_modules(cycle) != NGX_OK) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 执行每个核心模块的create_conf方法。由于核心模块管理者其所属下的各个模块。如ngx_http_module模块管理所有http模块。创建一个结构体，用于管理其下所有模块解析后的结果。具体可以参考配置解析*/</span><br><span class="line">    for (i = 0; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        if (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        module = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        if (module-&gt;create_conf) &#123;</span><br><span class="line">            rv = module-&gt;create_conf(cycle);</span><br><span class="line">            if (rv == NULL) &#123;</span><br><span class="line">                ngx_destroy_pool(pool);</span><br><span class="line">                return NULL;</span><br><span class="line">            &#125;</span><br><span class="line">            cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index] = rv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    senv = environ;</span><br><span class="line"></span><br><span class="line">    // 配置解析，解析包括-g传递的参数，和配置文件</span><br><span class="line">    ngx_memzero(&amp;conf, sizeof(ngx_conf_t));</span><br><span class="line">    /* STUB: init array ? */</span><br><span class="line">    conf.args = ngx_array_create(pool, 10, sizeof(ngx_str_t));</span><br><span class="line">    if (conf.args == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conf.temp_pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, log);</span><br><span class="line">    if (conf.temp_pool == NULL) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    conf.ctx = cycle-&gt;conf_ctx;</span><br><span class="line">    conf.cycle = cycle;</span><br><span class="line">    conf.pool = pool;</span><br><span class="line">    conf.log = log;</span><br><span class="line">    conf.module_type = NGX_CORE_MODULE;</span><br><span class="line">    conf.cmd_type = NGX_MAIN_CONF;</span><br><span class="line"></span><br><span class="line">#if 0</span><br><span class="line">    log-&gt;log_level = NGX_LOG_DEBUG_ALL;</span><br><span class="line">#endif</span><br><span class="line">    // 解析-g传递的参数</span><br><span class="line">    if (ngx_conf_param(&amp;conf) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析配置文件</span><br><span class="line">    if (ngx_conf_parse(&amp;conf, &amp;cycle-&gt;conf_file) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 如果是测试配置文件正确性，正常打印error级别下错误</span><br><span class="line">    if (ngx_test_config &amp;&amp; !ngx_quiet_mode) &#123;</span><br><span class="line">        ngx_log_stderr(0, &quot;the configuration file %s syntax is ok&quot;,</span><br><span class="line">                       cycle-&gt;conf_file.data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 执行每个核心模块的init方法。用于将create_conf时创建的管理配置项的类中，未设置的成员，设置为默认值</span><br><span class="line">    for (i = 0; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        if (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        module = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        if (module-&gt;init_conf) &#123;</span><br><span class="line">            if (module-&gt;init_conf(cycle,</span><br><span class="line">                                  cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index])</span><br><span class="line">                == NGX_CONF_ERROR)</span><br><span class="line">            &#123;</span><br><span class="line">                environ = senv;</span><br><span class="line">                ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">                return NULL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 如果是要给已存在服务发送信号，则结束处理。</span><br><span class="line">    if (ngx_process == NGX_PROCESS_SIGNALLER) &#123;</span><br><span class="line">        return cycle;</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取核心模块ngx_core_module解析配置后生成的ngx_core_conf_t结构体</span><br><span class="line">    ccf = (ngx_core_conf_t *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">    // 如果是测试配置文件</span><br><span class="line">    if (ngx_test_config) &#123;</span><br><span class="line">        // 创建pid文件，如果是以单进程模式运行，即非master-worker方式，就不创建了</span><br><span class="line">        if (ngx_create_pidfile(&amp;ccf-&gt;pid, log) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else if (!ngx_is_init_cycle(old_cycle)) &#123;</span><br><span class="line">    // 如果不是新开始的一个服务（即已存在的服务调用init函数时），通过查看old_cycle是否存在ctx_conf来判断</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * we do not create the pid file in the first ngx_init_cycle() call</span><br><span class="line">         * because we need to write the demonized process pid</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">        old_ccf = (ngx_core_conf_t *) ngx_get_conf(old_cycle-&gt;conf_ctx,</span><br><span class="line">                                                   ngx_core_module);</span><br><span class="line">        // 如果新的pid目录和当前的不一致，则创建一个最新的，并删除当前的</span><br><span class="line">        if (ccf-&gt;pid.len != old_ccf-&gt;pid.len</span><br><span class="line">            || ngx_strcmp(ccf-&gt;pid.data, old_ccf-&gt;pid.data) != 0)</span><br><span class="line">        &#123;</span><br><span class="line">            /* new pid file name */</span><br><span class="line"></span><br><span class="line">            if (ngx_create_pidfile(&amp;ccf-&gt;pid, log) != NGX_OK) &#123;</span><br><span class="line">                goto failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_delete_pidfile(old_cycle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 测试锁文件，即为了解决惊群现象，多个子进程见使用锁来实现负载均衡。如果系统不支持原子的锁机制，则使用文件锁的形式，这时需要创建一个文件。*/</span><br><span class="line">    if (ngx_test_lockfile(cycle-&gt;lock_file.data, log) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    // 创建管理路径，具体下面介绍</span><br><span class="line">    if (ngx_create_paths(cycle, ccf-&gt;user) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 打开日志文件，具体下面介绍</span><br><span class="line">    if (ngx_log_open_default(cycle) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* open the new files */</span><br><span class="line">    // 对于需要打开的文件，执行创建</span><br><span class="line">    part = &amp;cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (file[i].name.len == 0) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        file[i].fd = ngx_open_file(file[i].name.data,</span><br><span class="line">                                   NGX_FILE_APPEND,</span><br><span class="line">                                   NGX_FILE_CREATE_OR_OPEN,</span><br><span class="line">                                   NGX_FILE_DEFAULT_ACCESS);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_CORE, log, 0,</span><br><span class="line">                       &quot;log: %p %d \&quot;%s\&quot;&quot;,</span><br><span class="line">                       &amp;file[i], file[i].fd, file[i].name.data);</span><br><span class="line"></span><br><span class="line">        if (file[i].fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          ngx_open_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if !(NGX_WIN32)</span><br><span class="line">        // 设置文件为执行时关闭，即子进程执行exec后不继承该文件描述符，适用于平滑升级</span><br><span class="line">        if (fcntl(file[i].fd, F_SETFD, FD_CLOEXEC) == -1) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          &quot;fcntl(FD_CLOEXEC) \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cycle-&gt;log = &amp;cycle-&gt;new_log;</span><br><span class="line">    pool-&gt;log = &amp;cycle-&gt;new_log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* create shared memory */</span><br><span class="line">    // 创见共享内存，具体在共享内存介绍</span><br><span class="line">    part = &amp;cycle-&gt;shared_memory.part;</span><br><span class="line">    shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            shm_zone = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (shm_zone[i].shm.size == 0) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, 0,</span><br><span class="line">                          &quot;zero size shared memory zone \&quot;%V\&quot;&quot;,</span><br><span class="line">                          &amp;shm_zone[i].shm.name);</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        shm_zone[i].shm.log = cycle-&gt;log;</span><br><span class="line"></span><br><span class="line">        opart = &amp;old_cycle-&gt;shared_memory.part;</span><br><span class="line">        oshm_zone = opart-&gt;elts;</span><br><span class="line"></span><br><span class="line">        for (n = 0; /* void */ ; n++) &#123;</span><br><span class="line"></span><br><span class="line">            if (n &gt;= opart-&gt;nelts) &#123;</span><br><span class="line">                if (opart-&gt;next == NULL) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                opart = opart-&gt;next;</span><br><span class="line">                oshm_zone = opart-&gt;elts;</span><br><span class="line">                n = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].shm.name.len != oshm_zone[n].shm.name.len) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ngx_strncmp(shm_zone[i].shm.name.data,</span><br><span class="line">                            oshm_zone[n].shm.name.data,</span><br><span class="line">                            shm_zone[i].shm.name.len)</span><br><span class="line">                != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].tag == oshm_zone[n].tag</span><br><span class="line">                &amp;&amp; shm_zone[i].shm.size == oshm_zone[n].shm.size</span><br><span class="line">                &amp;&amp; !shm_zone[i].noreuse)</span><br><span class="line">            &#123;</span><br><span class="line">                shm_zone[i].shm.addr = oshm_zone[n].shm.addr;</span><br><span class="line">#if (NGX_WIN32)</span><br><span class="line">                shm_zone[i].shm.handle = oshm_zone[n].shm.handle;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">                if (shm_zone[i].init(&amp;shm_zone[i], oshm_zone[n].data)</span><br><span class="line">                    != NGX_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    goto failed;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                goto shm_zone_found;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_shm_alloc(&amp;shm_zone[i].shm) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_init_zone_pool(cycle, &amp;shm_zone[i]) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (shm_zone[i].init(&amp;shm_zone[i], NULL) != NGX_OK) &#123;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    shm_zone_found:</span><br><span class="line"></span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* handle the listening sockets */</span><br><span class="line">    // 处理监听套接字。</span><br><span class="line">    </span><br><span class="line">    if (old_cycle-&gt;listening.nelts) &#123;</span><br><span class="line">        ls = old_cycle-&gt;listening.elts;</span><br><span class="line">        // 遍历每一个旧版cycle监听的套接字，设置remain为0，即默认关闭所有旧套接字。</span><br><span class="line">        for (i = 0; i &lt; old_cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">            ls[i].remain = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nls = cycle-&gt;listening.elts;</span><br><span class="line">        /* 遍历每个新cycle的监听套接字，和旧套接字进行比对，如果新监听的套接字中存在与旧套接字一样的，则不关闭对应的旧套接字。*/</span><br><span class="line">        for (n = 0; n &lt; cycle-&gt;listening.nelts; n++) &#123;</span><br><span class="line"></span><br><span class="line">            for (i = 0; i &lt; old_cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">                // 如果旧套接字设置了ignore，表示该套接字发生错误，不需要进行比对。</span><br><span class="line">                if (ls[i].ignore) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // 如果旧套接字的remain已经为1，表示已经有一个新套接字和当前套接字地址一致，不能关闭当前套接字，因此不需要再比对</span><br><span class="line">                if (ls[i].remain) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // 类型不一致，不用比对</span><br><span class="line">                if (ls[i].type != nls[n].type) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // 对比新旧套接字地址是否一致</span><br><span class="line">                if (ngx_cmp_sockaddr(nls[n].sockaddr, nls[n].socklen,</span><br><span class="line">                                     ls[i].sockaddr, ls[i].socklen, 1)</span><br><span class="line">                    == NGX_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    // 新套接字设置为旧套接字的描述符</span><br><span class="line">                    nls[n].fd = ls[i].fd;</span><br><span class="line">                    // previous设置为对应的旧套接字</span><br><span class="line">                    nls[n].previous = &amp;ls[i];</span><br><span class="line">                    // 记录需要继续维护旧套接字（不能close）</span><br><span class="line">                    ls[i].remain = 1;</span><br><span class="line">                    // 如果新的套接字的backlog和旧版的不一致，则将listen置1，告知后续需要再次执行listen函数，来变更backlog</span><br><span class="line">                    if (ls[i].backlog != nls[n].backlog) &#123;</span><br><span class="line">                        nls[n].listen = 1;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line"></span><br><span class="line">                    /*</span><br><span class="line">                     * FreeBSD, except the most recent versions,</span><br><span class="line">                     * could not remove accept filter</span><br><span class="line">                     */</span><br><span class="line">                    nls[n].deferred_accept = ls[i].deferred_accept;</span><br><span class="line"></span><br><span class="line">                    if (ls[i].accept_filter &amp;&amp; nls[n].accept_filter) &#123;</span><br><span class="line">                        if (ngx_strcmp(ls[i].accept_filter,</span><br><span class="line">                                       nls[n].accept_filter)</span><br><span class="line">                            != 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            nls[n].delete_deferred = 1;</span><br><span class="line">                            nls[n].add_deferred = 1;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; else if (ls[i].accept_filter) &#123;</span><br><span class="line">                        nls[n].delete_deferred = 1;</span><br><span class="line"></span><br><span class="line">                    &#125; else if (nls[n].accept_filter) &#123;</span><br><span class="line">                        nls[n].add_deferred = 1;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line"></span><br><span class="line">                    if (ls[i].deferred_accept &amp;&amp; !nls[n].deferred_accept) &#123;</span><br><span class="line">                        nls[n].delete_deferred = 1;</span><br><span class="line"></span><br><span class="line">                    &#125; else if (ls[i].deferred_accept != nls[n].deferred_accept)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nls[n].add_deferred = 1;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_REUSEPORT)</span><br><span class="line">                    // 如果新的套接字设置了复用端口，但老的未设置，则将add_reuseport置1，告知后续需要设置套接字复用端口。</span><br><span class="line">                    if (nls[n].reuseport &amp;&amp; !ls[i].reuseport) &#123;</span><br><span class="line">                        nls[n].add_reuseport = 1;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // 如果套接字不为-1，表示当前套接字有效，后续不需要关闭套接字</span><br><span class="line">            if (nls[n].fd == (ngx_socket_t) -1) &#123;</span><br><span class="line">                nls[n].open = 1;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">                if (nls[n].accept_filter) &#123;</span><br><span class="line">                    nls[n].add_deferred = 1;</span><br><span class="line">                &#125;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line">                if (nls[n].deferred_accept) &#123;</span><br><span class="line">                    nls[n].add_deferred = 1;</span><br><span class="line">                &#125;</span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 如果不存在旧的监听套接字，则设置每个待初始化的新套接字有效</span><br><span class="line">        ls = cycle-&gt;listening.elts;</span><br><span class="line">        for (i = 0; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">            ls[i].open = 1;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">            if (ls[i].accept_filter) &#123;</span><br><span class="line">                ls[i].add_deferred = 1;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line">            if (ls[i].deferred_accept) &#123;</span><br><span class="line">                ls[i].add_deferred = 1;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 处理监听套接字，打开并绑定,详见配置项解析中，监听端口的管理章节</span><br><span class="line">    if (ngx_open_listening_sockets(cycle) != NGX_OK) &#123;</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line">    // 设置套接字属性</span><br><span class="line">    if (!ngx_test_config) &#123;</span><br><span class="line">        ngx_configure_listening_sockets(cycle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* commit the new cycle configuration */</span><br><span class="line">    // 设置日志的错误输出到标注错误输出上</span><br><span class="line">    if (!ngx_use_stderr) &#123;</span><br><span class="line">        (void) ngx_log_redirect_stderr(cycle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pool-&gt;log = cycle-&gt;log;</span><br><span class="line">    // 执行每个module的init_module函数（默认的module似乎都没有）</span><br><span class="line">    if (ngx_init_modules(cycle) != NGX_OK) &#123;</span><br><span class="line">        /* fatal */</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* close and delete stuff that lefts from an old cycle */</span><br><span class="line"></span><br><span class="line">    /* free the unnecessary shared memory */</span><br><span class="line">    // 释放不再使用的共享存储</span><br><span class="line">    opart = &amp;old_cycle-&gt;shared_memory.part;</span><br><span class="line">    oshm_zone = opart-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= opart-&gt;nelts) &#123;</span><br><span class="line">            if (opart-&gt;next == NULL) &#123;</span><br><span class="line">                goto old_shm_zone_done;</span><br><span class="line">            &#125;</span><br><span class="line">            opart = opart-&gt;next;</span><br><span class="line">            oshm_zone = opart-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        part = &amp;cycle-&gt;shared_memory.part;</span><br><span class="line">        shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">        for (n = 0; /* void */ ; n++) &#123;</span><br><span class="line"></span><br><span class="line">            if (n &gt;= part-&gt;nelts) &#123;</span><br><span class="line">                if (part-&gt;next == NULL) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                part = part-&gt;next;</span><br><span class="line">                shm_zone = part-&gt;elts;</span><br><span class="line">                n = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (oshm_zone[i].shm.name.len != shm_zone[n].shm.name.len) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ngx_strncmp(oshm_zone[i].shm.name.data,</span><br><span class="line">                            shm_zone[n].shm.name.data,</span><br><span class="line">                            oshm_zone[i].shm.name.len)</span><br><span class="line">                != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (oshm_zone[i].tag == shm_zone[n].tag</span><br><span class="line">                &amp;&amp; oshm_zone[i].shm.size == shm_zone[n].shm.size</span><br><span class="line">                &amp;&amp; !oshm_zone[i].noreuse)</span><br><span class="line">            &#123;</span><br><span class="line">                goto live_shm_zone;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_shm_free(&amp;oshm_zone[i].shm);</span><br><span class="line"></span><br><span class="line">    live_shm_zone:</span><br><span class="line"></span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">old_shm_zone_done:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* close the unnecessary listening sockets */</span><br><span class="line">    // 关闭不再监听的旧的监听套接字</span><br><span class="line">    ls = old_cycle-&gt;listening.elts;</span><br><span class="line">    for (i = 0; i &lt; old_cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        // 对于需要维护的，或者是-1的，不进行处理</span><br><span class="line">        if (ls[i].remain || ls[i].fd == (ngx_socket_t) -1) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_socket(ls[i].fd) == -1) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_socket_errno,</span><br><span class="line">                          ngx_close_socket_n &quot; listening socket on %V failed&quot;,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_UNIX_DOMAIN)</span><br><span class="line">        // 对应unix域的套接字，删除文件</span><br><span class="line">        if (ls[i].sockaddr-&gt;sa_family == AF_UNIX) &#123;</span><br><span class="line">            u_char  *name;</span><br><span class="line"></span><br><span class="line">            name = ls[i].addr_text.data + sizeof(&quot;unix:&quot;) - 1;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_WARN, cycle-&gt;log, 0,</span><br><span class="line">                          &quot;deleting socket %s&quot;, name);</span><br><span class="line"></span><br><span class="line">            if (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;log, ngx_socket_errno,</span><br><span class="line">                              ngx_delete_file_n &quot; %s failed&quot;, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* close the unnecessary open files */</span><br><span class="line">    // 关闭不再需要的文件</span><br><span class="line">    part = &amp;old_cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (file[i].fd == NGX_INVALID_FILE || file[i].fd == ngx_stderr) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          ngx_close_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(conf.temp_pool);</span><br><span class="line"></span><br><span class="line">    if (ngx_process == NGX_PROCESS_MASTER || ngx_is_init_cycle(old_cycle)) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_destroy_pool(old_cycle-&gt;pool);</span><br><span class="line">        cycle-&gt;old_cycle = NULL;</span><br><span class="line"></span><br><span class="line">        return cycle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 申请临时的内存池</span><br><span class="line">    if (ngx_temp_pool == NULL) &#123;</span><br><span class="line">        ngx_temp_pool = ngx_create_pool(128, cycle-&gt;log);</span><br><span class="line">        if (ngx_temp_pool == NULL) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cycle-&gt;log, 0,</span><br><span class="line">                          &quot;could not create ngx_temp_pool&quot;);</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n = 10;</span><br><span class="line"></span><br><span class="line">        if (ngx_array_init(&amp;ngx_old_cycles, ngx_temp_pool, n,</span><br><span class="line">                           sizeof(ngx_cycle_t *))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ngx_memzero(ngx_old_cycles.elts, n * sizeof(ngx_cycle_t *));</span><br><span class="line">        // 设置定时清理事件</span><br><span class="line">        ngx_cleaner_event.handler = ngx_clean_old_cycles;</span><br><span class="line">        ngx_cleaner_event.log = cycle-&gt;log;</span><br><span class="line">        ngx_cleaner_event.data = &amp;dumb;</span><br><span class="line">        dumb.fd = (ngx_socket_t) -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_temp_pool-&gt;log = cycle-&gt;log;</span><br><span class="line">    // 将旧的cycle添加到全局变量ngx_old_cycles中</span><br><span class="line">    old = ngx_array_push(&amp;ngx_old_cycles);</span><br><span class="line">    if (old == NULL) &#123;</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line">    *old = old_cycle;</span><br><span class="line">    // 设置定时清理事件的时间</span><br><span class="line">    if (!ngx_cleaner_event.timer_set) &#123;</span><br><span class="line">        ngx_add_timer(&amp;ngx_cleaner_event, 30000);</span><br><span class="line">        ngx_cleaner_event.timer_set = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    // 返回新创建的cycle</span><br><span class="line">    return cycle;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    if (!ngx_is_init_cycle(old_cycle)) &#123;</span><br><span class="line">        old_ccf = (ngx_core_conf_t *) ngx_get_conf(old_cycle-&gt;conf_ctx,</span><br><span class="line">                                                   ngx_core_module);</span><br><span class="line">        if (old_ccf-&gt;environment) &#123;</span><br><span class="line">            environ = old_ccf-&gt;environment;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* rollback the new cycle configuration */</span><br><span class="line"></span><br><span class="line">    part = &amp;cycle-&gt;open_files.part;</span><br><span class="line">    file = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            file = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (file[i].fd == NGX_INVALID_FILE || file[i].fd == ngx_stderr) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          ngx_close_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                          file[i].name.data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* free the newly created shared memory */</span><br><span class="line"></span><br><span class="line">    part = &amp;cycle-&gt;shared_memory.part;</span><br><span class="line">    shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    for (i = 0; /* void */ ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            if (part-&gt;next == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            shm_zone = part-&gt;elts;</span><br><span class="line">            i = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (shm_zone[i].shm.addr == NULL) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        opart = &amp;old_cycle-&gt;shared_memory.part;</span><br><span class="line">        oshm_zone = opart-&gt;elts;</span><br><span class="line"></span><br><span class="line">        for (n = 0; /* void */ ; n++) &#123;</span><br><span class="line"></span><br><span class="line">            if (n &gt;= opart-&gt;nelts) &#123;</span><br><span class="line">                if (opart-&gt;next == NULL) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                opart = opart-&gt;next;</span><br><span class="line">                oshm_zone = opart-&gt;elts;</span><br><span class="line">                n = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].shm.name.len != oshm_zone[n].shm.name.len) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ngx_strncmp(shm_zone[i].shm.name.data,</span><br><span class="line">                            oshm_zone[n].shm.name.data,</span><br><span class="line">                            shm_zone[i].shm.name.len)</span><br><span class="line">                != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (shm_zone[i].tag == oshm_zone[n].tag</span><br><span class="line">                &amp;&amp; shm_zone[i].shm.size == oshm_zone[n].shm.size</span><br><span class="line">                &amp;&amp; !shm_zone[i].noreuse)</span><br><span class="line">            &#123;</span><br><span class="line">                goto old_shm_zone_found;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_shm_free(&amp;shm_zone[i].shm);</span><br><span class="line"></span><br><span class="line">    old_shm_zone_found:</span><br><span class="line"></span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ngx_test_config) &#123;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    for (i = 0; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">        if (ls[i].fd == (ngx_socket_t) -1 || !ls[i].open) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_close_socket(ls[i].fd) == -1) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_socket_errno,</span><br><span class="line">                          ngx_close_socket_n &quot; %V failed&quot;,</span><br><span class="line">                          &amp;ls[i].addr_text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line"></span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建管理目录"><a href="#创建管理目录" class="headerlink" title="创建管理目录"></a>创建管理目录</h4><p>ngx_create_paths。对于需要管理目录的配置，生成相应的目录，例如：http请求包体零时存放路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_body_temp_path dir-path [level1 [level2 [level3]]]</span><br></pre></td></tr></table></figure>
<h4 id="创建管理文件"><a href="#创建管理文件" class="headerlink" title="创建管理文件"></a>创建管理文件</h4><p>ngx_http_log_set_log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;access_log&quot;),</span><br><span class="line">  NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                    |NGX_HTTP_LMT_CONF|NGX_CONF_1MORE,</span><br><span class="line">  ngx_http_log_set_log,</span><br><span class="line">  NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">  0,</span><br><span class="line">  NULL &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="打开日志文件"><a href="#打开日志文件" class="headerlink" title="打开日志文件"></a>打开日志文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static ngx_command_t  ngx_errlog_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;error_log&quot;),</span><br><span class="line">      NGX_MAIN_CONF|NGX_CONF_1MORE,</span><br><span class="line">      ngx_error_log,</span><br><span class="line">      0,</span><br><span class="line">      0,</span><br><span class="line">      NULL &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="打开并设置监听地址"><a href="#打开并设置监听地址" class="headerlink" title="打开并设置监听地址"></a>打开并设置监听地址</h4><p>在看这部分之前，应该先查看配置项解析章节，至少需要查看其中的管理监听端口号部分。</p>
<h5 id="ngx-open-listening-sockets打开监听地址"><a href="#ngx-open-listening-sockets打开监听地址" class="headerlink" title="ngx_open_listening_sockets打开监听地址"></a>ngx_open_listening_sockets打开监听地址</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_open_listening_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>               reuseaddr;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, tries, failed;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>         err;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>        *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_socket_t</span>      s;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>  *ls;</span><br><span class="line"></span><br><span class="line">    reuseaddr = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">    failed = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> configurable try number */</span></span><br><span class="line">    <span class="comment">// 尝试重复执行5次</span></span><br><span class="line">    <span class="keyword">for</span> (tries = <span class="number">5</span>; tries; tries--) &#123;</span><br><span class="line">        failed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* for each listening socket */</span></span><br><span class="line"></span><br><span class="line">        ls = cycle-&gt;listening.elts;</span><br><span class="line">        <span class="comment">// 遍历每一个监听的listening</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line">            <span class="comment">// 如果是ignore，则忽略</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].ignore) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">            <span class="comment">// 如果是add_reuseport则表示是一个旧的监听地址，需要增加reuseport属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].add_reuseport) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * to allow transition from a socket without SO_REUSEPORT</span></span><br><span class="line"><span class="comment">                 * to multiple sockets with SO_REUSEPORT, we have to set</span></span><br><span class="line"><span class="comment">                 * SO_REUSEPORT on the old socket before opening new ones</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span>  reuseport = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_REUSEPORT_LB</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT_LB,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT_LB) %V failed, "</span></span><br><span class="line">                                  <span class="string">"ignored"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                <span class="comment">// 设置地址的reuseport属性</span></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_REUSEPORT,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT) %V failed, ignored"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="comment">// 恢复为0，避免下次重复执行（由于整个大循环可能会执行多次）</span></span><br><span class="line">                ls[i].add_reuseport = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 如果套接字不为-1，则说明已经是已经打开的套接字（大循环可能执行多次）</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].fd != (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是继承而来的，则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].inherited) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* <span class="doctag">TODO:</span> close on exit */</span></span><br><span class="line">                <span class="comment">/* <span class="doctag">TODO:</span> nonblocking */</span></span><br><span class="line">                <span class="comment">/* <span class="doctag">TODO:</span> deferred accept */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建套接字</span></span><br><span class="line">            s = ngx_socket(ls[i].sockaddr-&gt;sa_family, ls[i].type, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (s == (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              ngx_socket_n <span class="string">" %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置套接字复用地址属性</span></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_REUSEADDR,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseaddr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_REUSEADDR) %V failed"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">            <span class="comment">// 如果用户设置了套接字的reuseport属性，则设置套接字的reuseport属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].reuseport &amp;&amp; !ngx_test_config) &#123;</span><br><span class="line">                <span class="keyword">int</span>  reuseport;</span><br><span class="line"></span><br><span class="line">                reuseport = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_REUSEPORT_LB</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_REUSEPORT_LB,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT_LB) %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                      ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                      &amp;ls[i].addr_text);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_REUSEPORT,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;reuseport, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(SO_REUSEPORT) %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                      ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                      &amp;ls[i].addr_text);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6 &amp;&amp; defined IPV6_V6ONLY)</span></span><br><span class="line">            <span class="comment">// 设置套接字属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].sockaddr-&gt;sa_family == AF_INET6) &#123;</span><br><span class="line">                <span class="keyword">int</span>  ipv6only;</span><br><span class="line"></span><br><span class="line">                ipv6only = ls[i].ipv6only;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setsockopt(s, IPPROTO_IPV6, IPV6_V6ONLY,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ipv6only, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  <span class="string">"setsockopt(IPV6_V6ONLY) %V failed, ignored"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">/* <span class="doctag">TODO:</span> close on exit */</span></span><br><span class="line">            <span class="comment">// 如果选择的事件模块不是NGX_USE_IOCP_EVENT，则设置套接字为非阻塞的ioctl(s, FIONBIO, &amp;nb)</span></span><br><span class="line">            <span class="keyword">if</span> (!(ngx_event_flags &amp; NGX_USE_IOCP_EVENT)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_nonblocking(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_nonblocking_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                      ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                      &amp;ls[i].addr_text);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_CORE, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"bind() %V #%d "</span>, &amp;ls[i].addr_text, s);</span><br><span class="line">            <span class="comment">// 绑定套接字及其地址</span></span><br><span class="line">            <span class="keyword">if</span> (bind(s, ls[i].sockaddr, ls[i].socklen) == <span class="number">-1</span>) &#123;</span><br><span class="line">                err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE || !ngx_test_config) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, err,</span><br><span class="line">                                  <span class="string">"bind() to %V failed"</span>, &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ngx_test_config) &#123;</span><br><span class="line">                    failed = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_UNIX_DOMAIN)</span></span><br><span class="line">            <span class="comment">// 如果是unix域套接字，则变更对应的文件属性</span></span><br><span class="line">            <span class="keyword">if</span> (ls[i].sockaddr-&gt;sa_family == AF_UNIX) &#123;</span><br><span class="line">                <span class="keyword">mode_t</span>   mode;</span><br><span class="line">                u_char  *name;</span><br><span class="line"></span><br><span class="line">                name = ls[i].addr_text.data + <span class="keyword">sizeof</span>(<span class="string">"unix:"</span>) - <span class="number">1</span>;</span><br><span class="line">                mode = (S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (chmod((<span class="keyword">char</span> *) name, mode) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                  <span class="string">"chmod() \"%s\" failed"</span>, name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ngx_delete_file(name) == NGX_FILE_ERROR) &#123;</span><br><span class="line">                        ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                                      ngx_delete_file_n <span class="string">" %s failed"</span>, name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ls[i].type != SOCK_STREAM) &#123;</span><br><span class="line">                ls[i].fd = s;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 开启监听</span></span><br><span class="line">            <span class="keyword">if</span> (listen(s, ls[i].backlog) == <span class="number">-1</span>) &#123;</span><br><span class="line">                err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * on OpenVZ after suspend/resume EADDRINUSE</span></span><br><span class="line"><span class="comment">                 * may be returned by listen() instead of bind(), see</span></span><br><span class="line"><span class="comment">                 * https://bugzilla.openvz.org/show_bug.cgi?id=2470</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE || !ngx_test_config) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, err,</span><br><span class="line">                                  <span class="string">"listen() to %V, backlog %d failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text, ls[i].backlog);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_close_socket(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                                  ngx_close_socket_n <span class="string">" %V failed"</span>,</span><br><span class="line">                                  &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EADDRINUSE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ngx_test_config) &#123;</span><br><span class="line">                    failed = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 标记已监听</span></span><br><span class="line">            ls[i].listen = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 设置描述符</span></span><br><span class="line">            ls[i].fd = s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有错误，则跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (!failed) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> delay configurable */</span></span><br><span class="line"></span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"try again to bind() after 500ms"</span>);</span><br><span class="line">        <span class="comment">// 如果有错，则500ms重试</span></span><br><span class="line">        ngx_msleep(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (failed) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_EMERG, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"still could not bind()"</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要着重关注一下reuseport属性。对于监听多个地址：不同ip+同一个port，如果未开启该属性时，会失败。例如如下配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8884</span> bind;</span><br><span class="line">        <span class="attribute">location</span> /L1 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8884</span>;</span><br><span class="line">        <span class="attribute">server_name</span> chst.bcc-bdbl.baidu.com;</span><br><span class="line">        <span class="attribute">location</span> /L2 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，对于127.0.0.1:8884这个地址，我们希望进行单独的监听（设置了bind），这时会先单独对该地址进行bind。而后，对于0.0.0.0:8884这个通配符地址来说，我们还要再执行一次bind。但由于未设置reuseport属性，监听0.0.0.0:8884将会出错。改成如下配置则可以正常监听：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8884</span> bind reuseport;</span><br><span class="line">        <span class="attribute">location</span> /L1 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8884</span> reuseport;</span><br><span class="line">        <span class="attribute">server_name</span> chst.bcc-bdbl.baidu.com;</span><br><span class="line">        <span class="attribute">location</span> /L2 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，两个地址都设置了reuseport属性，此时可以实现正常监听。由于对每个ip+port形式的地址，nginx维护一个ngx_http_listen_opt_t。因此两个listen都需要加上reuseport才行。注意如下配置也不会有问题：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8884</span>;</span><br><span class="line">        <span class="attribute">location</span> /L1 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8884</span>;</span><br><span class="line">        <span class="attribute">server_name</span> chst.bcc-bdbl.baidu.com;</span><br><span class="line">        <span class="attribute">location</span> /L2 &#123;</span><br><span class="line">           <span class="attribute">root</span> /home/work/Nginx/study/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时由于第一个地址并未设置bind。此时不会单独对127.0.0.1:8884创建一个套接字。而是直接在0.0.0.0:8884这个通配符地址上进行监听。对于建立的连接，通过<code>getsockname</code>函数来发现绑定到套接字上的地址，以此来区分使用哪个虚拟服务。</p>
<h5 id="ngx-configure-listening-sockets设置套接字属性"><a href="#ngx-configure-listening-sockets设置套接字属性" class="headerlink" title="ngx_configure_listening_sockets设置套接字属性"></a>ngx_configure_listening_sockets设置套接字属性</h5><p>通过setsockopt函数对套接字进行设置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_configure_listening_sockets(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>                        value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">accept_filter_arg</span>   <span class="title">af</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ls[i].<span class="built_in">log</span> = *ls[i].logp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].rcvbuf != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_RCVBUF,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].rcvbuf, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_RCVBUF, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].rcvbuf, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].sndbuf != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_SNDBUF,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].sndbuf, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_SNDBUF, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].sndbuf, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepalive) &#123;</span><br><span class="line">            value = (ls[i].keepalive == <span class="number">1</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_KEEPALIVE,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_KEEPALIVE, %d) %V failed, ignored"</span>,</span><br><span class="line">                              value, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KEEPALIVE_TUNABLE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepidle) &#123;</span><br><span class="line">            value = ls[i].keepidle;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_KEEPALIVE_FACTOR)</span></span><br><span class="line">            value *= NGX_KEEPALIVE_FACTOR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_KEEPIDLE,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_KEEPIDLE, %d) %V failed, ignored"</span>,</span><br><span class="line">                              value, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepintvl) &#123;</span><br><span class="line">            value = ls[i].keepintvl;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_KEEPALIVE_FACTOR)</span></span><br><span class="line">            value *= NGX_KEEPALIVE_FACTOR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_KEEPINTVL,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                             <span class="string">"setsockopt(TCP_KEEPINTVL, %d) %V failed, ignored"</span>,</span><br><span class="line">                             value, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].keepcnt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_KEEPCNT,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].keepcnt, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_KEEPCNT, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].keepcnt, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].setfib != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_SETFIB,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].setfib, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_SETFIB, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].setfib, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">        <span class="keyword">if</span> (ls[i].fastopen != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_FASTOPEN,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;ls[i].fastopen, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_FASTOPEN, %d) %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].fastopen, &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> tcp_nodelay = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_NODELAY,</span><br><span class="line">                       (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;tcp_nodelay, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_NODELAY) %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].listen) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* change backlog via listen() */</span></span><br><span class="line">            <span class="comment">// 通过listen函数来重新设置backlog大小</span></span><br><span class="line">            <span class="keyword">if</span> (listen(ls[i].fd, ls[i].backlog) == <span class="number">-1</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"listen() to %V, backlog %d failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text, ls[i].backlog);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * setting deferred mode should be last operation on socket,</span></span><br><span class="line"><span class="comment">         * because code may prematurely continue cycle on failure</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SO_ACCEPTFILTER</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].delete_deferred) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_ACCEPTFILTER, <span class="literal">NULL</span>, <span class="number">0</span>)</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_ACCEPTFILTER, NULL) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ls[i].accept_filter) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"could not change the accept filter "</span></span><br><span class="line">                                  <span class="string">"to \"%s\" for %V, ignored"</span>,</span><br><span class="line">                                  ls[i].accept_filter, &amp;ls[i].addr_text);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].deferred_accept = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].add_deferred) &#123;</span><br><span class="line">            ngx_memzero(&amp;af, <span class="keyword">sizeof</span>(struct accept_filter_arg));</span><br><span class="line">            (<span class="keyword">void</span>) ngx_cpystrn((u_char *) af.af_name,</span><br><span class="line">                               (u_char *) ls[i].accept_filter, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, SOL_SOCKET, SO_ACCEPTFILTER,</span><br><span class="line">                           &amp;af, <span class="keyword">sizeof</span>(struct accept_filter_arg))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(SO_ACCEPTFILTER, \"%s\") "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              ls[i].accept_filter, &amp;ls[i].addr_text);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ls[i].deferred_accept = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TCP_DEFER_ACCEPT</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].add_deferred || ls[i].delete_deferred) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ls[i].add_deferred) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * There is no way to find out how long a connection was</span></span><br><span class="line"><span class="comment">                 * in queue (and a connection may bypass deferred queue at all</span></span><br><span class="line"><span class="comment">                 * if syncookies were used), hence we use 1 second timeout</span></span><br><span class="line"><span class="comment">                 * here.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_TCP, TCP_DEFER_ACCEPT,</span><br><span class="line">                           &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(TCP_DEFER_ACCEPT, %d) for %V failed, "</span></span><br><span class="line">                              <span class="string">"ignored"</span>,</span><br><span class="line">                              value, &amp;ls[i].addr_text);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].add_deferred) &#123;</span><br><span class="line">            ls[i].deferred_accept = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NGX_HAVE_DEFERRED_ACCEPT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_IP_RECVDSTADDR)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].wildcard</span><br><span class="line">            &amp;&amp; ls[i].type == SOCK_DGRAM</span><br><span class="line">            &amp;&amp; ls[i].sockaddr-&gt;sa_family == AF_INET)</span><br><span class="line">        &#123;</span><br><span class="line">            value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_IP, IP_RECVDSTADDR,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(IP_RECVDSTADDR) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> (NGX_HAVE_IP_PKTINFO)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].wildcard</span><br><span class="line">            &amp;&amp; ls[i].type == SOCK_DGRAM</span><br><span class="line">            &amp;&amp; ls[i].sockaddr-&gt;sa_family == AF_INET)</span><br><span class="line">        &#123;</span><br><span class="line">            value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_IP, IP_PKTINFO,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(IP_PKTINFO) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6 &amp;&amp; NGX_HAVE_IPV6_RECVPKTINFO)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ls[i].wildcard</span><br><span class="line">            &amp;&amp; ls[i].type == SOCK_DGRAM</span><br><span class="line">            &amp;&amp; ls[i].sockaddr-&gt;sa_family == AF_INET6)</span><br><span class="line">        &#123;</span><br><span class="line">            value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setsockopt(ls[i].fd, IPPROTO_IPV6, IPV6_RECVPKTINFO,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                              <span class="string">"setsockopt(IPV6_RECVPKTINFO) "</span></span><br><span class="line">                              <span class="string">"for %V failed, ignored"</span>,</span><br><span class="line">                              &amp;ls[i].addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试配置的处理"><a href="#测试配置的处理" class="headerlink" title="测试配置的处理"></a>测试配置的处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_test_config) &#123;</span><br><span class="line">    <span class="comment">// 测试配置文件处理</span></span><br><span class="line">    <span class="comment">// 如果需要打印非error的日志</span></span><br><span class="line">    <span class="keyword">if</span> (!ngx_quiet_mode) &#123;</span><br><span class="line">        ngx_log_stderr(<span class="number">0</span>, <span class="string">"configuration file %s test is successful"</span>,</span><br><span class="line">                       cycle-&gt;conf_file.data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果需要将配置dump打印</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_dump_config) &#123;</span><br><span class="line">        cd = cycle-&gt;config_dump.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;config_dump.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">            ngx_write_stdout(<span class="string">"# configuration file "</span>);</span><br><span class="line">            (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, cd[i].name.data,</span><br><span class="line">                                cd[i].name.len);</span><br><span class="line">            ngx_write_stdout(<span class="string">":"</span> NGX_LINEFEED);</span><br><span class="line"></span><br><span class="line">            b = cd[i].buffer;</span><br><span class="line"></span><br><span class="line">            (<span class="keyword">void</span>) ngx_write_fd(ngx_stdout, b-&gt;pos, b-&gt;last - b-&gt;pos);</span><br><span class="line">            ngx_write_stdout(NGX_LINEFEED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送信号处理"><a href="#发送信号处理" class="headerlink" title="发送信号处理"></a>发送信号处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_signal) &#123;</span><br><span class="line">    <span class="comment">// 如果是向正在执行的nginx服务发送信号</span></span><br><span class="line">    <span class="keyword">return</span> ngx_signal_process(cycle, ngx_signal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_signal_process(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">char</span> *sig)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>           n;</span><br><span class="line">    <span class="keyword">ngx_pid_t</span>         pid;</span><br><span class="line">    <span class="keyword">ngx_file_t</span>        file;</span><br><span class="line">    <span class="keyword">ngx_core_conf_t</span>  *ccf;</span><br><span class="line">    u_char            buf[NGX_INT64_LEN + <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"signal process started"</span>);</span><br><span class="line">    <span class="comment">// 获取解析到的pid文件</span></span><br><span class="line">    ccf = (<span class="keyword">ngx_core_conf_t</span> *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;file, <span class="keyword">sizeof</span>(<span class="keyword">ngx_file_t</span>));</span><br><span class="line"></span><br><span class="line">    file.name = ccf-&gt;pid;</span><br><span class="line">    file.<span class="built_in">log</span> = cycle-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    file.fd = ngx_open_file(file.name.data, NGX_FILE_RDONLY,</span><br><span class="line">                            NGX_FILE_OPEN, NGX_FILE_DEFAULT_ACCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file.fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      ngx_open_file_n <span class="string">" \"%s\" failed"</span>, file.name.data);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取内容</span></span><br><span class="line">    n = ngx_read_file(&amp;file, buf, NGX_INT64_LEN + <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_close_file(file.fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      ngx_close_file_n <span class="string">" \"%s\" failed"</span>, file.name.data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去除末尾的\r,\n</span></span><br><span class="line">    <span class="keyword">while</span> (n-- &amp;&amp; (buf[n] == CR || buf[n] == LF)) &#123; <span class="comment">/* void */</span> &#125;</span><br><span class="line">    <span class="comment">// 获取进程id</span></span><br><span class="line">    pid = ngx_atoi(buf, ++n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == (<span class="keyword">ngx_pid_t</span>) NGX_ERROR) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"invalid PID number \"%*s\" in \"%s\""</span>,</span><br><span class="line">                      n, buf, file.name.data);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行发送信号</span></span><br><span class="line">    <span class="keyword">return</span> ngx_os_signal_process(cycle, sig, pid);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span>     signo;</span><br><span class="line">    <span class="keyword">char</span>   *signame;</span><br><span class="line">    <span class="keyword">char</span>   *name;</span><br><span class="line">    <span class="keyword">void</span>  (*handler)(<span class="keyword">int</span> signo, <span class="keyword">siginfo_t</span> *siginfo, <span class="keyword">void</span> *ucontext);</span><br><span class="line">&#125; <span class="keyword">ngx_signal_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_os_signal_process(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">char</span> *name, <span class="keyword">ngx_pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_signal_t</span>  *sig;</span><br><span class="line">    <span class="comment">// 遍历所有系统支持信号，找到发送的信号，向对应的进程发送信号。</span></span><br><span class="line">    <span class="keyword">for</span> (sig = signals; sig-&gt;signo != <span class="number">0</span>; sig++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_strcmp(name, sig-&gt;name) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (kill(pid, sig-&gt;signo) != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"kill(%P, %d) failed"</span>, pid, sig-&gt;signo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体对接收到信号的处理，后续介绍。</p>
<h3 id="判断运行方式"><a href="#判断运行方式" class="headerlink" title="判断运行方式"></a>判断运行方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 获取配置解析的ngx_core_module解析项</span><br><span class="line">ccf = (ngx_core_conf_t *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</span><br><span class="line">// 如果设置了master，并且在此之前未设置其他运行方式（默认NGX_PROCESS_SINGLE 0），ngx_process为全局变量，初值为0</span><br><span class="line">if (ccf-&gt;master &amp;&amp; ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">    // 设置运行方式为mater-worker方式运行</span><br><span class="line">    ngx_process = NGX_PROCESS_MASTER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_init_signals(cycle-&gt;log) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    int     signo; // 信号</span><br><span class="line">    char   *signame; // 信号名</span><br><span class="line">    char   *name;</span><br><span class="line">    void  (*handler)(int signo, siginfo_t *siginfo, void *ucontext); // 处理函数</span><br><span class="line">&#125; ngx_signal_t;</span><br><span class="line"></span><br><span class="line">ngx_signal_t  signals[] = &#123;</span><br><span class="line">    &#123; ngx_signal_value(NGX_RECONFIGURE_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_RECONFIGURE_SIGNAL),</span><br><span class="line">      &quot;reload&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_REOPEN_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_REOPEN_SIGNAL),</span><br><span class="line">      &quot;reopen&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_NOACCEPT_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_NOACCEPT_SIGNAL),</span><br><span class="line">      &quot;&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_TERMINATE_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_TERMINATE_SIGNAL),</span><br><span class="line">      &quot;stop&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_SHUTDOWN_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_SHUTDOWN_SIGNAL),</span><br><span class="line">      &quot;quit&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_signal_value(NGX_CHANGEBIN_SIGNAL),</span><br><span class="line">      &quot;SIG&quot; ngx_value(NGX_CHANGEBIN_SIGNAL),</span><br><span class="line">      &quot;&quot;,</span><br><span class="line">      ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGALRM, &quot;SIGALRM&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGINT, &quot;SIGINT&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGIO, &quot;SIGIO&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGCHLD, &quot;SIGCHLD&quot;, &quot;&quot;, ngx_signal_handler &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGSYS, &quot;SIGSYS, SIG_IGN&quot;, &quot;&quot;, NULL &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; SIGPIPE, &quot;SIGPIPE, SIG_IGN&quot;, &quot;&quot;, NULL &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; 0, NULL, &quot;&quot;, NULL &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ngx_int_t</span><br><span class="line">ngx_init_signals(ngx_log_t *log)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_signal_t      *sig;</span><br><span class="line">    struct sigaction   sa;</span><br><span class="line">    // 其中signals为ngx_signal_t数组</span><br><span class="line">    for (sig = signals; sig-&gt;signo != 0; sig++) &#123;</span><br><span class="line">        ngx_memzero(&amp;sa, sizeof(struct sigaction));</span><br><span class="line"></span><br><span class="line">        if (sig-&gt;handler) &#123;</span><br><span class="line">            sa.sa_sigaction = sig-&gt;handler;</span><br><span class="line">            sa.sa_flags = SA_SIGINFO;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sa.sa_handler = SIG_IGN;</span><br><span class="line">        &#125;</span><br><span class="line">        // 注册信号处理函数</span><br><span class="line">        sigemptyset(&amp;sa.sa_mask);</span><br><span class="line">        if (sigaction(sig-&gt;signo, &amp;sa, NULL) == -1) &#123;</span><br><span class="line">#if (NGX_VALGRIND)</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, log, ngx_errno,</span><br><span class="line">                          &quot;sigaction(%s) failed, ignored&quot;, sig-&gt;signame);</span><br><span class="line">#else</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</span><br><span class="line">                          &quot;sigaction(%s) failed&quot;, sig-&gt;signame);</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>信号处理相关内容可以查看如下文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E4%BF%A1%E5%8F%B7" target="_blank" rel="noopener">信号处理</a>。其中处理函数为空的函数，即表示不对信号做任何处理，即忽略。其他信号处理函数均为ngx_signal_handler。处理如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_signal_handler(<span class="keyword">int</span> signo, <span class="keyword">siginfo_t</span> *siginfo, <span class="keyword">void</span> *ucontext)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>            *action;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>        ignore;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>        err;</span><br><span class="line">    <span class="keyword">ngx_signal_t</span>    *sig;</span><br><span class="line"></span><br><span class="line">    ignore = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    err = ngx_errno;</span><br><span class="line">    <span class="comment">// 首先找到对应的信号，用于获取信号名记录log</span></span><br><span class="line">    <span class="keyword">for</span> (sig = signals; sig-&gt;signo != <span class="number">0</span>; sig++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sig-&gt;signo == signo) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 以线程安全的方式更新时间，具体参考时间章节介绍</span></span><br><span class="line">    ngx_time_sigsafe_update();</span><br><span class="line"></span><br><span class="line">    action = <span class="string">""</span>;</span><br><span class="line">    <span class="comment">// 在每个子进程中，都会先设置进行类型ngx_process</span></span><br><span class="line">    <span class="keyword">switch</span> (ngx_process) &#123;</span><br><span class="line">    <span class="comment">// master进程，或者单进程运行模式下处理</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_MASTER:</span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_SINGLE:</span><br><span class="line">        <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line">        <span class="comment">// 退出信号，设置ngx_quit为1</span></span><br><span class="line">        case ngx_signal_value(NGX_SHUTDOWN_SIGNAL):</span><br><span class="line">            ngx_quit = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", shutting down"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 终止信息。ngx_terminate设置为1</span></span><br><span class="line">        case ngx_signal_value(NGX_TERMINATE_SIGNAL):</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            ngx_terminate = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", exiting"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 停止接收连接信号，如果是守护进程方式运行，则将ngx_noaccept置1</span></span><br><span class="line">        case ngx_signal_value(NGX_NOACCEPT_SIGNAL):</span><br><span class="line">            <span class="keyword">if</span> (ngx_daemonized) &#123;</span><br><span class="line">                ngx_noaccept = <span class="number">1</span>;</span><br><span class="line">                action = <span class="string">", stop accepting connections"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新加载配置</span></span><br><span class="line">        case ngx_signal_value(NGX_RECONFIGURE_SIGNAL):</span><br><span class="line">            ngx_reconfigure = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", reconfiguring"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新打开日志文件</span></span><br><span class="line">        case ngx_signal_value(NGX_REOPEN_SIGNAL):</span><br><span class="line">            ngx_reopen = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", reopening logs"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 变更二进制文件，即不关机重启</span></span><br><span class="line">        case ngx_signal_value(NGX_CHANGEBIN_SIGNAL):</span><br><span class="line">            <span class="comment">/* 对应不关机升级来说，master进行会fork子进程，运行新的二进制文件。而后应该由用户向老的master进程发送终止解析，使旧版服务退出。原master退出来，新的mater进程将会被init进程接管，即此时新master进程的父进程id为init进程id：1。对于新进程来说，如果其父进程依旧为原来mater进程的子进程id时，说明原来master进程还未退出，此时会忽略该信号。对于老的master进程来说，如果ngx_new_binary大于0，表明新的二进制文件已经在运行了，此时也会忽略该信号。*/</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_getppid() == ngx_parent || ngx_new_binary &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Ignore the signal in the new binary if its parent is</span></span><br><span class="line"><span class="comment">                 * not changed, i.e. the old binary's process is still</span></span><br><span class="line"><span class="comment">                 * running.  Or ignore the signal in the old binary's</span></span><br><span class="line"><span class="comment">                 * process if the new binary's process is already running.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                action = <span class="string">", ignoring"</span>;</span><br><span class="line">                ignore = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置ngx_change_binary为1</span></span><br><span class="line">            ngx_change_binary = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", changing binary"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SIGALRM:</span><br><span class="line">            <span class="comment">// 时钟信号</span></span><br><span class="line">            ngx_sigalrm = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 异步io</span></span><br><span class="line">        <span class="keyword">case</span> SIGIO:</span><br><span class="line">            ngx_sigio = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 子进程退出或终止</span></span><br><span class="line">        <span class="keyword">case</span> SIGCHLD:</span><br><span class="line">            ngx_reap = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// worker和helper进程处理逻辑</span></span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_WORKER:</span><br><span class="line">    <span class="keyword">case</span> NGX_PROCESS_HELPER:</span><br><span class="line">        <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line">        <span class="comment">// 退出debug</span></span><br><span class="line">        case ngx_signal_value(NGX_NOACCEPT_SIGNAL):</span><br><span class="line">            <span class="keyword">if</span> (!ngx_daemonized) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ngx_debug_quit = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">/* fall through */</span></span><br><span class="line">        <span class="comment">// 关闭</span></span><br><span class="line">        case ngx_signal_value(NGX_SHUTDOWN_SIGNAL):</span><br><span class="line">            ngx_quit = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", shutting down"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 退出</span></span><br><span class="line">        case ngx_signal_value(NGX_TERMINATE_SIGNAL):</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            ngx_terminate = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", exiting"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 重新打开日志文件</span></span><br><span class="line">        case ngx_signal_value(NGX_REOPEN_SIGNAL):</span><br><span class="line">            ngx_reopen = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">", reopening logs"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 忽略重新读取配置、变更二进制文件，异步io</span></span><br><span class="line">        case ngx_signal_value(NGX_RECONFIGURE_SIGNAL):</span><br><span class="line">        case ngx_signal_value(NGX_CHANGEBIN_SIGNAL):</span><br><span class="line">        <span class="keyword">case</span> SIGIO:</span><br><span class="line">            action = <span class="string">", ignoring"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录日志，根据是否能够明确信号来源进行划分。</span></span><br><span class="line">    <span class="keyword">if</span> (siginfo &amp;&amp; siginfo-&gt;si_pid) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"signal %d (%s) received from %P%s"</span>,</span><br><span class="line">                      signo, sig-&gt;signame, siginfo-&gt;si_pid, action);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"signal %d (%s) received%s"</span>,</span><br><span class="line">                      signo, sig-&gt;signame, action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ignore) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"the changing binary signal is ignored: "</span></span><br><span class="line">                      <span class="string">"you should shutdown or terminate "</span></span><br><span class="line">                      <span class="string">"before either old or new binary's process"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子进程终止，则执行如下处理</span></span><br><span class="line">    <span class="keyword">if</span> (signo == SIGCHLD) &#123;</span><br><span class="line">        ngx_process_get_status();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_set_errno(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应子进程退出时的处理如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_process_get_status(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>              status;</span><br><span class="line">    <span class="keyword">char</span>            *process;</span><br><span class="line">    <span class="keyword">ngx_pid_t</span>        pid;</span><br><span class="line">    <span class="keyword">ngx_err_t</span>        err;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>       one;</span><br><span class="line"></span><br><span class="line">    one = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 不阻塞的查看其子进程中哪个进程结束</span></span><br><span class="line">        pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG);</span><br><span class="line">        <span class="comment">// 如果没有终止进程，则返回</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果获取终止子进程失败</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            err = ngx_errno;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_EINTR) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ECHILD &amp;&amp; one) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Solaris always calls the signal handler for each exited process</span></span><br><span class="line"><span class="comment">             * despite waitpid() may be already called for this process.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * When several processes exit at the same time FreeBSD may</span></span><br><span class="line"><span class="comment">             * erroneously call the signal handler for exited process</span></span><br><span class="line"><span class="comment">             * despite waitpid() may be already called for this process.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NGX_ECHILD) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_INFO, ngx_cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                              <span class="string">"waitpid() failed"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                          <span class="string">"waitpid() failed"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 标注找到一个退出进程</span></span><br><span class="line">        one = <span class="number">1</span>;</span><br><span class="line">        process = <span class="string">"unknown process"</span>;</span><br><span class="line">        <span class="comment">// 遍历保存进程信息的ngx_processes数组，找到对应的元素，设置其状态，并设置其exited为1</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ngx_last_process; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_processes[i].pid == pid) &#123;</span><br><span class="line">                ngx_processes[i].status = status;</span><br><span class="line">                ngx_processes[i].exited = <span class="number">1</span>;</span><br><span class="line">                process = ngx_processes[i].name;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进程异常终止，获取子进程终止的信号编号。</span></span><br><span class="line">        <span class="keyword">if</span> (WTERMSIG(status)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WCOREDUMP</span></span><br><span class="line">            <span class="comment">// 可以通过WCOREDUMP获取否生成了终止进程的core文件</span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited on signal %d%s"</span>,</span><br><span class="line">                          process, pid, WTERMSIG(status),</span><br><span class="line">                          WCOREDUMP(status) ? <span class="string">" (core dumped)"</span> : <span class="string">""</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited on signal %d"</span>,</span><br><span class="line">                          process, pid, WTERMSIG(status));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_NOTICE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited with code %d"</span>,</span><br><span class="line">                          process, pid, WEXITSTATUS(status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取子进程传递给exit或_exit参数的低八位,如果值为2，并且进程需要重启</span></span><br><span class="line">        <span class="keyword">if</span> (WEXITSTATUS(status) == <span class="number">2</span> &amp;&amp; ngx_processes[i].respawn) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"%s %P exited with fatal code %d "</span></span><br><span class="line">                          <span class="string">"and cannot be respawned"</span>,</span><br><span class="line">                          process, pid, WEXITSTATUS(status));</span><br><span class="line">            ngx_processes[i].respawn = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 释放终止进程所持有的锁</span></span><br><span class="line">        ngx_unlock_mutexes(pid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应进程终止相关处理，可参考如下文档：<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener">进程控制</a>。</p>
<p>释放终止进程锁的函数逻辑如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_unlock_mutexes(<span class="keyword">ngx_pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i;</span><br><span class="line">    <span class="keyword">ngx_shm_zone_t</span>   *shm_zone;</span><br><span class="line">    <span class="keyword">ngx_list_part_t</span>  *part;</span><br><span class="line">    <span class="keyword">ngx_slab_pool_t</span>  *sp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * unlock the accept mutex if the abnormally exited process</span></span><br><span class="line"><span class="comment">     * held it</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* 如果设置了进程间的负载均衡锁，则根据该进程是否拥有该锁，进行释放操作。注意ngx_accept_mutex也是使用mmap内存映射技术来生成的，因此所有进程共享。*/</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_accept_mutex_ptr) &#123;</span><br><span class="line">        (<span class="keyword">void</span>) ngx_shmtx_force_unlock(&amp;ngx_accept_mutex, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * unlock shared memory mutexes if held by the abnormally exited</span></span><br><span class="line"><span class="comment">     * process</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 释放共享内存的锁</span></span><br><span class="line">    part = (<span class="keyword">ngx_list_part_t</span> *) &amp;ngx_cycle-&gt;shared_memory.part;</span><br><span class="line">    shm_zone = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; <span class="comment">/* void */</span> ; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">            <span class="keyword">if</span> (part-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            part = part-&gt;next;</span><br><span class="line">            shm_zone = part-&gt;elts;</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp = (<span class="keyword">ngx_slab_pool_t</span> *) shm_zone[i].shm.addr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_shmtx_force_unlock(&amp;sp-&gt;mutex, pid)) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"shared memory zone \"%V\" was locked by %P"</span>,</span><br><span class="line">                          &amp;shm_zone[i].shm.name, pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="变更运行状态为守护进程"><a href="#变更运行状态为守护进程" class="headerlink" title="变更运行状态为守护进程"></a>变更运行状态为守护进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 非继承而来，即正常启动，并且设置为守护进程运行模式（默认）</span><br><span class="line">if (!ngx_inherited &amp;&amp; ccf-&gt;daemon) &#123;</span><br><span class="line">    // 进程变更为守护进程模式</span><br><span class="line">    if (ngx_daemon(cycle-&gt;log) != NGX_OK) &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_daemonized = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (ngx_inherited) &#123;</span><br><span class="line">    ngx_daemonized = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx默认为以守护进程的模式运行。关于守护进程，详细信息可以参考如下文档，其实际方法也与其大致相同。<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B" target="_blank" rel="noopener">守护进程</a>。</p>
<h3 id="创建pid文件"><a href="#创建pid文件" class="headerlink" title="创建pid文件"></a>创建pid文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 对于非继承而来的进程，会创建pid文件，继承而来的进程，已经在init cycle中创建了，详情参考上文。</span><br><span class="line">if (ngx_create_pidfile(&amp;ccf-&gt;pid, cycle-&gt;log) != NGX_OK) &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置运行方式"><a href="#设置运行方式" class="headerlink" title="设置运行方式"></a>设置运行方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">    ngx_single_process_cycle(cycle);</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">    ngx_master_process_cycle(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据是单进程模式运行还是master-workers方式执行对应的方法。这里我们只看master-worker方式运行。</p>
<h3 id="执行主体循环"><a href="#执行主体循环" class="headerlink" title="执行主体循环"></a>执行主体循环</h3><p>根据配置，选择运行方式，分别为单进程方式运行和master-workers方式运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_process == NGX_PROCESS_SINGLE) &#123;</span><br><span class="line">    ngx_single_process_cycle(cycle);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ngx_master_process_cycle(cycle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体细节参考master进程和worker进程逻辑。</p>
<h1 id="解析配置"><a href="#解析配置" class="headerlink" title="解析配置"></a>解析配置</h1><h2 id="初始化核心模块"><a href="#初始化核心模块" class="headerlink" title="初始化核心模块"></a>初始化核心模块</h2><p>执行核心模块的ctx-&gt;create_conf方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_conf) &#123;</span><br><span class="line">        rv = <span class="keyword">module</span>-&gt;create_conf(cycle);</span><br><span class="line">        <span class="keyword">if</span> (rv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_destroy_pool(pool);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index] = rv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，http核心模块的ctx为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_str_t             name;</span><br><span class="line">    void               *(*create_conf)(ngx_cycle_t *cycle);</span><br><span class="line">    char               *(*init_conf)(ngx_cycle_t *cycle, void *conf);</span><br><span class="line">&#125; ngx_core_module_t;</span><br></pre></td></tr></table></figure>
<p>该步骤主要是分配配置存储空间，并为核心模块关注的全局配置赋初值。需要执行的有</p>
<p>ngx_core_module：其返回为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_flag_t                daemon;</span><br><span class="line">    ngx_flag_t                master;</span><br><span class="line"></span><br><span class="line">    ngx_msec_t                timer_resolution;</span><br><span class="line">    ngx_msec_t                shutdown_timeout;</span><br><span class="line"></span><br><span class="line">    ngx_int_t                 worker_processes;</span><br><span class="line">    ngx_int_t                 debug_points;</span><br><span class="line"></span><br><span class="line">    ngx_int_t                 rlimit_nofile;</span><br><span class="line">    off_t                     rlimit_core;</span><br><span class="line"></span><br><span class="line">    int                       priority;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                cpu_affinity_auto;</span><br><span class="line">    ngx_uint_t                cpu_affinity_n;</span><br><span class="line">    ngx_cpuset_t             *cpu_affinity;</span><br><span class="line"></span><br><span class="line">    char                     *username;</span><br><span class="line">    ngx_uid_t                 user;</span><br><span class="line">    ngx_gid_t                 group;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                 working_directory;</span><br><span class="line">    ngx_str_t                 lock_file;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                 pid;</span><br><span class="line">    ngx_str_t                 oldpid;</span><br><span class="line"></span><br><span class="line">    ngx_array_t               env;</span><br><span class="line">    char                    **environment;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                transparent;  /* unsigned  transparent:1; */</span><br><span class="line">&#125; ngx_core_conf_t;</span><br></pre></td></tr></table></figure>
<p>ngx_regex_module_ctx，其返回为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_flag_t  pcre_jit;</span><br><span class="line">&#125; ngx_regex_conf_t;</span><br></pre></td></tr></table></figure>
<h2 id="配置及参数解析"><a href="#配置及参数解析" class="headerlink" title="配置及参数解析"></a>配置及参数解析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    ngx_memzero(&amp;conf, <span class="keyword">sizeof</span>(<span class="keyword">ngx_conf_t</span>));</span><br><span class="line">    <span class="comment">/* STUB: init array ? */</span></span><br><span class="line">    conf.args = ngx_array_create(pool, <span class="number">10</span>, <span class="keyword">sizeof</span>(<span class="keyword">ngx_str_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (conf.args == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conf.temp_pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, <span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (conf.temp_pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_destroy_pool(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    conf.ctx = cycle-&gt;conf_ctx;</span><br><span class="line">    conf.cycle = cycle;</span><br><span class="line">    conf.pool = pool;</span><br><span class="line">    conf.<span class="built_in">log</span> = <span class="built_in">log</span>;</span><br><span class="line">    conf.module_type = NGX_CORE_MODULE;</span><br><span class="line">    conf.cmd_type = NGX_MAIN_CONF;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="built_in">log</span>-&gt;log_level = NGX_LOG_DEBUG_ALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 解析启动参数 -g</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_param(&amp;conf) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_conf_parse(&amp;conf, &amp;cycle-&gt;conf_file) != NGX_CONF_OK) &#123;</span><br><span class="line">        environ = senv;</span><br><span class="line">        ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="相关结构"><a href="#相关结构" class="headerlink" title="相关结构"></a>相关结构</h3><h4 id="ngx-conf-t结构"><a href="#ngx-conf-t结构" class="headerlink" title="ngx_conf_t结构"></a>ngx_conf_t结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ngx_conf_s &#123;</span><br><span class="line">    <span class="keyword">char</span>                 *name;</span><br><span class="line">    <span class="comment">// 词法解析后，解析出的值</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>          *args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>          *cycle;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>           *pool;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>           *temp_pool;</span><br><span class="line">    <span class="keyword">ngx_conf_file_t</span>      *conf_file;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>            *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>                 *ctx;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            module_type;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            cmd_type;</span><br><span class="line"></span><br><span class="line">    ngx_conf_handler_pt   handler;</span><br><span class="line">    <span class="keyword">void</span>                 *handler_conf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *(*ngx_conf_handler_pt)(<span class="keyword">ngx_conf_t</span> *cf,</span><br><span class="line">    <span class="keyword">ngx_command_t</span> *dummy, <span class="keyword">void</span> *conf);</span><br></pre></td></tr></table></figure>
<p>ngx_conf_param函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">ngx_conf_param(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>             *rv;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>        *param;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>         b;</span><br><span class="line">    <span class="keyword">ngx_conf_file_t</span>   conf_file;</span><br><span class="line"></span><br><span class="line">    param = &amp;cf-&gt;cycle-&gt;conf_param;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (param-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;conf_file, <span class="keyword">sizeof</span>(<span class="keyword">ngx_conf_file_t</span>));</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;b, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line"></span><br><span class="line">    b.start = param-&gt;data;</span><br><span class="line">    b.pos = param-&gt;data;</span><br><span class="line">    b.last = param-&gt;data + param-&gt;len;</span><br><span class="line">    b.end = b.last;</span><br><span class="line">    b.temporary = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    conf_file.file.fd = NGX_INVALID_FILE;</span><br><span class="line">    conf_file.file.name.data = <span class="literal">NULL</span>;</span><br><span class="line">    conf_file.line = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cf-&gt;conf_file = &amp;conf_file;</span><br><span class="line">    cf-&gt;conf_file-&gt;buffer = &amp;b;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    cf-&gt;conf_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-conf-file-t结构"><a href="#ngx-conf-file-t结构" class="headerlink" title="ngx_conf_file_t结构"></a>ngx_conf_file_t结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_file_t</span>            file;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>            *buffer;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>            *dump;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            line;</span><br><span class="line">&#125; <span class="keyword">ngx_conf_file_t</span>;</span><br></pre></td></tr></table></figure>
<p>执行的ngx_conf_parse函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">ngx_conf_parse(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *filename)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>             *rv;</span><br><span class="line">    <span class="keyword">ngx_fd_t</span>          fd;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         rc;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>         buf;</span><br><span class="line">    <span class="keyword">ngx_conf_file_t</span>  *prev, conf_file;</span><br><span class="line">    <span class="comment">// 解析方式：解析文件、解析块配置（如server、location）、解析参数（-g参数）</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        parse_file = <span class="number">0</span>,</span><br><span class="line">        parse_block,</span><br><span class="line">        parse_param</span><br><span class="line">    &#125; type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_SUPPRESS_WARN)</span></span><br><span class="line">    fd = NGX_INVALID_FILE;</span><br><span class="line">    prev = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filename) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* open configuration file */</span></span><br><span class="line">        <span class="comment">// 打开配置文件</span></span><br><span class="line">        fd = ngx_open_file(filename-&gt;data, NGX_FILE_RDONLY, NGX_FILE_OPEN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, ngx_errno,</span><br><span class="line">                               ngx_open_file_n <span class="string">" \"%s\" failed"</span>,</span><br><span class="line">                               filename-&gt;data);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 存储原来的conf_file</span></span><br><span class="line">        prev = cf-&gt;conf_file;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file = &amp;conf_file;</span><br><span class="line">        <span class="comment">// 获取文件信息</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_fd_info(fd, &amp;cf-&gt;conf_file-&gt;file.info) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_fd_info_n <span class="string">" \"%s\" failed"</span>, filename-&gt;data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file-&gt;buffer = &amp;buf;</span><br><span class="line"></span><br><span class="line">        buf.start = ngx_alloc(NGX_CONF_BUFFER, cf-&gt;<span class="built_in">log</span>);</span><br><span class="line">        <span class="keyword">if</span> (buf.start == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf.pos = buf.start;</span><br><span class="line">        buf.last = buf.start;</span><br><span class="line">        buf.end = buf.last + NGX_CONF_BUFFER;</span><br><span class="line">        buf.temporary = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file-&gt;file.fd = fd;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.name.len = filename-&gt;len;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.name.data = filename-&gt;data;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.offset = <span class="number">0</span>;</span><br><span class="line">        cf-&gt;conf_file-&gt;file.<span class="built_in">log</span> = cf-&gt;<span class="built_in">log</span>;</span><br><span class="line">        cf-&gt;conf_file-&gt;line = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        type = parse_file;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_dump_config</span><br><span class="line">#<span class="keyword">if</span> (NGX_DEBUG)</span><br><span class="line">            || <span class="number">1</span></span><br><span class="line">#endif</span><br><span class="line">           )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 需要dump配置时，增加配置到config_dump_rbtree和config_dump</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_conf_add_dump(cf, filename) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cf-&gt;conf_file-&gt;dump = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;conf_file-&gt;file.fd != NGX_INVALID_FILE) &#123;</span><br><span class="line"></span><br><span class="line">        type = parse_block;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        type = parse_param;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 词法解析，解析配置或参数,返回解析结构状态或错误</span></span><br><span class="line">        rc = ngx_conf_read_token(cf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ngx_conf_read_token() may return</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *    NGX_ERROR             there is error</span></span><br><span class="line"><span class="comment">         *    NGX_OK                the token terminated by ";" was found</span></span><br><span class="line"><span class="comment">         *    NGX_CONF_BLOCK_START  the token terminated by "&#123;" was found</span></span><br><span class="line"><span class="comment">         *    NGX_CONF_BLOCK_DONE   the "&#125;" was found</span></span><br><span class="line"><span class="comment">         *    NGX_CONF_FILE_DONE    the configuration file is done</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面三个faild表示解析类型和词法解析结果不匹配，返回错误</span></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_CONF_BLOCK_DONE) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type != parse_block) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"unexpected \"&#125;\""</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_CONF_FILE_DONE) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == parse_block) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"unexpected end of file, expecting \"&#125;\""</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_CONF_BLOCK_START) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == parse_param) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"block directives are not supported "</span></span><br><span class="line">                                   <span class="string">"in -g option"</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* rc == NGX_OK || rc == NGX_CONF_BLOCK_START */</span></span><br><span class="line">        <span class="comment">// 如果解析的模块自定义了解析后处理方法</span></span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;handler) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * the custom handler, i.e., that is used in the http's</span></span><br><span class="line"><span class="comment">             * "types &#123; ... &#125;" directive</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_CONF_BLOCK_START) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"unexpected \"&#123;\""</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 模块自定义处理函数，例如ngx_http_core_commands中typescommends中自定义的ngx_http_core_types函数。</span></span><br><span class="line">            rv = (*cf-&gt;handler)(cf, <span class="literal">NULL</span>, cf-&gt;handler_conf);</span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">"%s"</span>, rv);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认处理逻辑</span></span><br><span class="line">        rc = ngx_conf_handler(cf, rc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    rc = NGX_ERROR;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;conf_file-&gt;buffer-&gt;start) &#123;</span><br><span class="line">            ngx_free(cf-&gt;conf_file-&gt;buffer-&gt;start);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_close_file(fd) == NGX_FILE_ERROR) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cf-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          ngx_close_file_n <span class="string">" %s failed"</span>,</span><br><span class="line">                          filename-&gt;data);</span><br><span class="line">            rc = NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cf-&gt;conf_file = prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="词法解析（ngx-conf-read-token）"><a href="#词法解析（ngx-conf-read-token）" class="headerlink" title="词法解析（ngx_conf_read_token）"></a>词法解析（ngx_conf_read_token）</h3><p>ngx_conf_read_token函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_conf_read_token(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    u_char      *start, ch, *src, *dst;</span><br><span class="line">    <span class="keyword">off_t</span>        file_size;</span><br><span class="line">    <span class="keyword">size_t</span>       len;</span><br><span class="line">    <span class="keyword">ssize_t</span>      n, size;</span><br><span class="line">    <span class="comment">// 记录当前状态：分别表示：查找到解析块、需要一个分割符、需要解析下一个语句、注释、变量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   found, need_space, last_space, sharp_comment, variable;</span><br><span class="line">    <span class="comment">// 转义、单引号、双引号、起始行</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   quoted, s_quoted, d_quoted, start_line;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>   *word;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>   *b, *dump;</span><br><span class="line"></span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    need_space = <span class="number">0</span>;</span><br><span class="line">    last_space = <span class="number">1</span>;</span><br><span class="line">    sharp_comment = <span class="number">0</span>;</span><br><span class="line">    variable = <span class="number">0</span>;</span><br><span class="line">    quoted = <span class="number">0</span>;</span><br><span class="line">    s_quoted = <span class="number">0</span>;</span><br><span class="line">    d_quoted = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cf-&gt;args-&gt;nelts = <span class="number">0</span>;</span><br><span class="line">    b = cf-&gt;conf_file-&gt;buffer;</span><br><span class="line">    dump = cf-&gt;conf_file-&gt;dump;</span><br><span class="line">    start = b-&gt;pos;</span><br><span class="line">    start_line = cf-&gt;conf_file-&gt;line;</span><br><span class="line"></span><br><span class="line">    file_size = ngx_file_size(&amp;cf-&gt;conf_file-&gt;file.info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 当前内存中的数据已经解析结束</span></span><br><span class="line">        <span class="keyword">if</span> (b-&gt;pos &gt;= b-&gt;last) &#123;</span><br><span class="line">            <span class="comment">// 文件已经解析完成（如果是非文件，则都为0）</span></span><br><span class="line">            <span class="keyword">if</span> (cf-&gt;conf_file-&gt;file.offset &gt;= file_size) &#123;</span><br><span class="line">                <span class="comment">// 如果解析出了值或者状态不是要查找下一个解析块（但文件已经解析完了），则报错</span></span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &gt; <span class="number">0</span> || !last_space) &#123;</span><br><span class="line">                    <span class="comment">// 解析的是参数-g时的报错</span></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;conf_file-&gt;file.fd == NGX_INVALID_FILE) &#123;</span><br><span class="line">                        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                           <span class="string">"unexpected end of parameter, "</span></span><br><span class="line">                                           <span class="string">"expecting \";\""</span>);</span><br><span class="line">                        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"unexpected end of file, "</span></span><br><span class="line">                                  <span class="string">"expecting \";\" or \"&#125;\""</span>);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果没有错误，则返回配置解析完成</span></span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_FILE_DONE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// start为执行该函数时的b-&gt;pos</span></span><br><span class="line">            len = b-&gt;pos - start;</span><br><span class="line">            <span class="comment">// 如果解析到长度大于NGX_CONF_BUFFER时，还未完成一个语句的解析，则是参数过长，报错</span></span><br><span class="line">            <span class="keyword">if</span> (len == NGX_CONF_BUFFER) &#123;</span><br><span class="line">                cf-&gt;conf_file-&gt;line = start_line;</span><br><span class="line">                <span class="comment">// 当前状态为找到一个双引号</span></span><br><span class="line">                <span class="keyword">if</span> (d_quoted) &#123;</span><br><span class="line">                    ch = <span class="string">'"'</span>;</span><br><span class="line">                <span class="comment">// 当前状态为找到一个单引号</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_quoted) &#123;</span><br><span class="line">                    ch = <span class="string">'\''</span>;</span><br><span class="line">                <span class="comment">// 否则直接报错，告知出错的起始位置</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                       <span class="string">"too long parameter \"%*s...\" started"</span>,</span><br><span class="line">                                       <span class="number">10</span>, start);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 报错，并告知可能缺少单引号或双引号</span></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"too long parameter, probably "</span></span><br><span class="line">                                   <span class="string">"missing terminating \"%c\" character"</span>, ch);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果存在已分析语句，但未完成（未return），则将分析开始到当前这部分值，拷贝到b-&gt;start上，以进行继续分析</span></span><br><span class="line">            <span class="keyword">if</span> (len) &#123;</span><br><span class="line">                ngx_memmove(b-&gt;start, start, len);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 计算文件中未读取的大小</span></span><br><span class="line">            size = (<span class="keyword">ssize_t</span>) (file_size - cf-&gt;conf_file-&gt;file.offset);</span><br><span class="line">            <span class="comment">// 如果文件剩余大小大于当前buf中还剩余的空间（b-&gt;end - (b-&gt;start + len)），则减少读取数量</span></span><br><span class="line">            <span class="keyword">if</span> (size &gt; b-&gt;end - (b-&gt;start + len)) &#123;</span><br><span class="line">                size = b-&gt;end - (b-&gt;start + len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从文件中读取数据</span></span><br><span class="line">            n = ngx_read_file(&amp;cf-&gt;conf_file-&gt;file, b-&gt;start + len, size,</span><br><span class="line">                              cf-&gt;conf_file-&gt;file.offset);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n != size) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   ngx_read_file_n <span class="string">" returned "</span></span><br><span class="line">                                   <span class="string">"only %z bytes instead of %z"</span>,</span><br><span class="line">                                   n, size);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 继续解析的起始位置</span></span><br><span class="line">            b-&gt;pos = b-&gt;start + len;</span><br><span class="line">            b-&gt;last = b-&gt;pos + n;</span><br><span class="line">            start = b-&gt;start;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dump) &#123;</span><br><span class="line">                dump-&gt;last = ngx_cpymem(dump-&gt;last, b-&gt;pos, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 读取当前pos的字符，并将pos后移</span></span><br><span class="line">        ch = *b-&gt;pos++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// #define LF     (u_char) '\n'</span></span><br><span class="line">        <span class="comment">// 如果字符为换行</span></span><br><span class="line">        <span class="keyword">if</span> (ch == LF) &#123;</span><br><span class="line">            cf-&gt;conf_file-&gt;line++;</span><br><span class="line">            <span class="comment">// 如果当前解析处于注释，则删除注释</span></span><br><span class="line">            <span class="keyword">if</span> (sharp_comment) &#123;</span><br><span class="line">                sharp_comment = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前解析处于注释内，直接跳过</span></span><br><span class="line">        <span class="keyword">if</span> (sharp_comment) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前在专业状态，则转义结束，并结束转义状态</span></span><br><span class="line">        <span class="keyword">if</span> (quoted) &#123;</span><br><span class="line">            quoted = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果需要一个分隔符</span></span><br><span class="line">        <span class="keyword">if</span> (need_space) &#123;</span><br><span class="line">        <span class="comment">// #define LF     (u_char) '\n'</span></span><br><span class="line">        <span class="comment">// #define CR     (u_char) '\r'</span></span><br><span class="line">        <span class="comment">// 如果是如下分隔符，则需要解析下一个语句，且不再需要分隔符</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span> || ch == <span class="string">'\t'</span> || ch == CR || ch == LF) &#123;</span><br><span class="line">                last_space = <span class="number">1</span>;</span><br><span class="line">                need_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果解析到分号，则表示当前语句解析结束，返回ok</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">';'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果解析到&#123;则表示将要解析块配置</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_BLOCK_START;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析到)，则需要解析下一个语句，并且不需要</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">')'</span>) &#123;</span><br><span class="line">                last_space = <span class="number">1</span>;</span><br><span class="line">                need_space = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 否则报错</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"unexpected \"%c\""</span>, ch);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果需要解析下一个语句</span></span><br><span class="line">        <span class="keyword">if</span> (last_space) &#123;</span><br><span class="line">            <span class="comment">// start为当前字符的地址</span></span><br><span class="line">            start = b-&gt;pos - <span class="number">1</span>;</span><br><span class="line">            start_line = cf-&gt;conf_file-&gt;line;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">' '</span> || ch == <span class="string">'\t'</span> || ch == CR || ch == LF) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据ch判断</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="comment">// 如果是分号或&#123;，如果解析出的语句为0，则表示配置错误。如果是&#123;则表示后续要解析语法快。</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">';'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#123;'</span>:</span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts == <span class="number">0</span>) &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                       <span class="string">"unexpected \"%c\""</span>, ch);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_BLOCK_START;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            <span class="comment">// 如果是&#125;，则判断解析出的语句是否为0，不为0则表示，应该要进行解析，但读取到结束，表示配置错误。否则返回块结束解析完成</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#125;'</span>:</span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts != <span class="number">0</span>) &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                       <span class="string">"unexpected \"&#125;\""</span>);</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_BLOCK_DONE;</span><br><span class="line">            <span class="comment">// 如果是#，则表示为注释</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">                sharp_comment = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是转义，则记录转义状态，并进行当前语句解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">                quoted = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是双引号，则起始位置应该不包括引号本身，并标识需要下一个双引号，并进行当前语句的解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'"'</span>:</span><br><span class="line">                start++;</span><br><span class="line">                d_quoted = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是单引号，则起始位置应该不包括引号本身，并标识需要下一个单引号，并进行当前语句的解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">                start++;</span><br><span class="line">                s_quoted = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 如果是$,则表示要解析变量，并进行当前语句的解析</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'$'</span>:</span><br><span class="line">                variable = <span class="number">1</span>;</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 默认进入当前语句的解析</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                last_space = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果正处于解析当前语句时</span></span><br><span class="line">            <span class="comment">// 如果要解析变量，并且ch为&#123;,即$&#123;&#125;情况，则直接continue</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span> &amp;&amp; variable) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// variable标识置为0</span></span><br><span class="line">            variable = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'\\'</span>) &#123;</span><br><span class="line">                quoted = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">'$'</span>) &#123;</span><br><span class="line">                variable = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果需要双引号，并且ch是双引号，则不再需要双引号，并需要分隔符，并找到一个词</span></span><br><span class="line">            <span class="keyword">if</span> (d_quoted) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'"'</span>) &#123;</span><br><span class="line">                    d_quoted = <span class="number">0</span>;</span><br><span class="line">                    need_space = <span class="number">1</span>;</span><br><span class="line">                    found = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果需要单引号，并且ch是单引号，则不再需要单引号，并需要分隔符，并找到一个词</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_quoted) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'\''</span>) &#123;</span><br><span class="line">                    s_quoted = <span class="number">0</span>;</span><br><span class="line">                    need_space = <span class="number">1</span>;</span><br><span class="line">                    found = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 如果是下列字符，则表示需要解析下一个词，并且标识当前查找到一个词</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">' '</span> || ch == <span class="string">'\t'</span> || ch == CR || ch == LF</span><br><span class="line">                       || ch == <span class="string">';'</span> || ch == <span class="string">'&#123;'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                last_space = <span class="number">1</span>;</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查找到一个词，增加到args中</span></span><br><span class="line">            <span class="keyword">if</span> (found) &#123;</span><br><span class="line">                <span class="comment">//向args添加，并分配空间</span></span><br><span class="line">                word = ngx_array_push(cf-&gt;args);</span><br><span class="line">                <span class="keyword">if</span> (word == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                word-&gt;data = ngx_pnalloc(cf-&gt;pool, b-&gt;pos - <span class="number">1</span> - start + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (word-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (dst = word-&gt;data, src = start, len = <span class="number">0</span>;</span><br><span class="line">                     src &lt; b-&gt;pos - <span class="number">1</span>;</span><br><span class="line">                     len++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (*src == <span class="string">'\\'</span>) &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (src[<span class="number">1</span>]) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'"'</span>:</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">                            src++;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                            *dst++ = <span class="string">'\t'</span>;</span><br><span class="line">                            src += <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">                            *dst++ = <span class="string">'\r'</span>;</span><br><span class="line">                            src += <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'n'</span>:</span><br><span class="line">                            *dst++ = <span class="string">'\n'</span>;</span><br><span class="line">                            src += <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    *dst++ = *src++;</span><br><span class="line">                &#125;</span><br><span class="line">                *dst = <span class="string">'\0'</span>;</span><br><span class="line">                word-&gt;len = len;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">';'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_BLOCK_START;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                found = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="默认处理（ngx-conf-handler）"><a href="#默认处理（ngx-conf-handler）" class="headerlink" title="默认处理（ngx_conf_handler）"></a>默认处理（ngx_conf_handler）</h3><p>ngx_conf_handler函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_conf_handler(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_int_t</span> last)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>           *rv;</span><br><span class="line">    <span class="keyword">void</span>           *conf, **confp;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>      i, found;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>      *name;</span><br><span class="line">    <span class="keyword">ngx_command_t</span>  *cmd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取词法解析后的第一个词</span></span><br><span class="line">    name = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历所有modules</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="comment">// 取modules下的commands</span></span><br><span class="line">        cmd = cf-&gt;cycle-&gt;modules[i]-&gt;commands;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历commands列表</span></span><br><span class="line">        <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; cmd-&gt;name.len; cmd++) &#123;</span><br><span class="line">            <span class="comment">// 判断该commands是否是该配置对应的模块，通过比较长度和值</span></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;len != cmd-&gt;name.len) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_strcmp(name-&gt;data, cmd-&gt;name.data) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 找到对于的commends的标识</span></span><br><span class="line">            found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果该modules类型不是核心模块，或者该模块不是当前解析所关注的模块时，跳过该模块</span></span><br><span class="line">            <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_CONF_MODULE</span><br><span class="line">                &amp;&amp; cf-&gt;cycle-&gt;modules[i]-&gt;type != cf-&gt;module_type)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* is the directive's location right ? */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果commands的类型和当前解析的块不一致时，跳过。对于commands的类型详见设置配置项解析方式</span></span><br><span class="line">            <span class="keyword">if</span> (!(cmd-&gt;type &amp; cf-&gt;cmd_type)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果commends不是需要进行块解析，并且词法解析返回结果不是ok时，错误</span></span><br><span class="line">            <span class="keyword">if</span> (!(cmd-&gt;type &amp; NGX_CONF_BLOCK) &amp;&amp; last != NGX_OK) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">"directive \"%s\" is not terminated by \";\""</span>,</span><br><span class="line">                                  name-&gt;data);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果commends是需要进行块解析，但词法解析返回结果不是NGX_CONF_BLOCK_START时，错误</span></span><br><span class="line">            <span class="keyword">if</span> ((cmd-&gt;type &amp; NGX_CONF_BLOCK) &amp;&amp; last != NGX_CONF_BLOCK_START) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"directive \"%s\" has no opening \"&#123;\""</span>,</span><br><span class="line">                                   name-&gt;data);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* is the directive's argument count right ? */</span></span><br><span class="line">            <span class="comment">// 根据commends所需配置项参数数量和词法解析出的数量，进行正确性校验</span></span><br><span class="line">            <span class="keyword">if</span> (!(cmd-&gt;type &amp; NGX_CONF_ANY)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_FLAG) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts != <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">goto</span> invalid;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_1MORE) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">goto</span> invalid;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_2MORE) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                        <span class="keyword">goto</span> invalid;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &gt; NGX_CONF_MAX_ARGS) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(cmd-&gt;type &amp; argument_number[cf-&gt;args-&gt;nelts - <span class="number">1</span>]))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set up the directive's configuration context */</span></span><br><span class="line"></span><br><span class="line">            conf = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">// commends需要解析的内容为全局配置（&#123;&#125;外）</span></span><br><span class="line">            <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_DIRECT_CONF) &#123;</span><br><span class="line">                conf = ((<span class="keyword">void</span> **) cf-&gt;ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;index];</span><br><span class="line">            <span class="comment">// commends需要解析的内容为NGX_MAIN_CONF，这只在核心模块进行处理，核心模块管理其下的所有模块，如ngx_http_module模块，管理所有的http模块。对于cmd-&gt;type解释详见下一节</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_MAIN_CONF) &#123;</span><br><span class="line">                conf = &amp;(((<span class="keyword">void</span> **) cf-&gt;ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;index]);</span><br><span class="line">            <span class="comment">// 对于非上述两种情况，此时cf-&gt;ctx与cycle的ctx_conf不是一个纬度了，而是由NGX_MAIN_CONF模块创建的配置数字，cmd-&gt;conf是改模块在其核心模块创建的配置中的偏移。如果http模块创建的ngx_http_conf_ctx_t，其中包含main_conf、srv_conf、loc_conf，此时的cmd-&gt;conf表示是这三个中的哪一个。</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;ctx) &#123;</span><br><span class="line">                confp = *(<span class="keyword">void</span> **) ((<span class="keyword">char</span> *) cf-&gt;ctx + cmd-&gt;conf);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (confp) &#123;</span><br><span class="line">                    conf = confp[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用模块的set函数</span></span><br><span class="line">            rv = cmd-&gt;<span class="built_in">set</span>(cf, cmd, conf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"\"%s\" directive %s"</span>, name-&gt;data, rv);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (found) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"\"%s\" directive is not allowed here"</span>, name-&gt;data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"unknown directive \"%s\""</span>, name-&gt;data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">invalid:</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"invalid number of arguments in \"%s\" directive"</span>,</span><br><span class="line">                       name-&gt;data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码，可以看出来，cycle中的ctx_conf中，并不是每个模块都有一个对应的<code>ctx_conf[modules[i]-&gt;index]</code>。一般都是核心模块会存在一个对应的配置。核心模块下的<code>ctx_conf[modules[i]-&gt;index]</code>配置，会分配好其管理的每个子模块的存储空间。查找子模块时，通过其所属的核心模块的配置地址，再通过模块的ctx_index查找到对应配置。（具体查找方式较为复杂，详见http模块解析）。</p>
<h3 id="设置配置项解析方式（ngx-commend-S）"><a href="#设置配置项解析方式（ngx-commend-S）" class="headerlink" title="设置配置项解析方式（ngx_commend_S）"></a>设置配置项解析方式（ngx_commend_S）</h3><p>下面介绍读取配置时是如何使用ngx_commend_s的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_command_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>             name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            type;</span><br><span class="line">    <span class="keyword">char</span>               *(*<span class="built_in">set</span>)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf);</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            conf;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            offset;</span><br><span class="line">    <span class="keyword">void</span>                 *post;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-str-t-name"><a href="#ngx-str-t-name" class="headerlink" title="ngx_str_t  name"></a>ngx_str_t  name</h4><p>配置名称，和解析出的名称做比较，确定是否是该模块关注的配置。</p>
<h4 id="ngx-uint-t-type"><a href="#ngx-uint-t-type" class="headerlink" title="ngx_uint_t type"></a>ngx_uint_t type</h4><p>type决定配置项可以在哪些块出现（如http、server、location、if、upstream），以及可以携带参数类型和个数。下表列出了可以的取值。可同时取多个值，通过$ \vert $连接。</p>
<table>
  <tr>
    <td>type类型</td>
    <td>type取值</td>
    <td>含义</td>
  </tr>
  <tr>
    <td rowspan="2">处理配置项时获取当前配置块的方式</td>
    <td>NGX_DIRECT_CONF</td>
    <td>一般由NGX_CORE_MODULE类型的核心模块使用，仅与下面的NGX_MAIN_CONF同时设置，表示模块需要解析不属于任何{}内的全局配置项。它实际上会指定set方法里的第三个参数conf的值，使之指向每个模块解析全局配置项的配置结构体</td>
  </tr>
  <tr>
    <td>NGX_ANY_CONF</td>
    <td>当前未使用</td>
  </tr>
  <tr>
    <td rowspan="12">配置项可以在哪些{}配置块中出现</td>
    <td>NGX_MAIN_CONF</td>
    <td>配置项可以出现在全局配置中，即不属于任何{}配置块</td>
  </tr>
  <tr>
    <td>NGX_EVENT_CONF</td>
    <td>配置项可以出现在events{}块内</td>
  </tr>
  <tr>
    <td>NGX_MAIL_MAIN_CONF</td>
    <td>配置项可以出现在mail{}块或imap{}内</td>
  </tr>
  <tr>
    <td>NGX_MAIL_SRV_CONF</td>
    <td>配置项可以出现在server{}块内，但server{}必须在mail{}块或imap{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_MAIN_CONF</td>
    <td>配置项可以出现在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_SRV_CONF</td>
    <td>配置项可以出现在server{}块内，但server{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_SRV_CONF</td>
    <td>配置项可以出现在server{}块内，但server{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_LOC_CONF</td>
    <td>配置项可以出现在location{}块内，但location{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_UPS_CONF</td>
    <td>配置项可以出现在upstream{}块内，但upstream{}块必须在http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_SIF_CONF</td>
    <td>配置项可以出现在server{}块内的if{}中，目前仅rewrite模块使用。if必须属于http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_LIF_CONF</td>
    <td>配置项可以出现在loc{}块内的if{}中，目前仅rewrite模块使用。if必须属于http{}内</td>
  </tr>
  <tr>
    <td>NGX_HTTP_LMT_CONF</td>
    <td>配置项可以出现在limit_except{}内。limit_except必须属于http{}内</td>
  </tr>
  <tr>
    <td rowspan="13">配置项参数限制</td>
    <td>NGX_CONF_NOARGS</td>
    <td>配置项不携带任何参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE1</td>
    <td>配置项必须携带1个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE2</td>
    <td>配置项必须携带2个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE3</td>
    <td>配置项必须携带3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE4</td>
    <td>配置项必须携带4个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE5</td>
    <td>配置项必须携带5个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE6</td>
    <td>配置项必须携带6个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE7</td>
    <td>配置项必须携带7个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE12</td>
    <td>配置项必须携带1~2个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE13</td>
    <td>配置项必须携带1~3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE23</td>
    <td>配置项必须携带2~3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE123</td>
    <td>配置项必须携带1~3个参数</td>
  </tr>
  <tr>
    <td>NGX_CONF_TAKE1234</td>
    <td>配置项必须携带1~4个参数</td>
  </tr>
  <tr>
    <td rowspan="7">限制配置项后参数出现形式</td>
    <td>NGX_CONF_ARGS_NUMBER</td>
    <td>目前未使用，无意义</td>
  </tr>
  <tr>
    <td>NGX_CONF_BLOCK</td>
    <td>配置项定义了一种新的{}块。例如http、server、location等配置，其type必须为NGX_CONF_BLOCK</td>
  </tr>
  <tr>
    <td>NGX_CONF_ANY</td>
    <td>不验证配置项携带参数个数</td>
  </tr>
  <tr>
    <td>NGX_CONF_FLAG</td>
    <td>配置项携带参数只能是1个，并且参数只能是on/off</td>
  </tr>
  <tr>
    <td>NGX_CONF_1MORE</td>
    <td>配置项携带参数必须超过1个</td>
  </tr>
  <tr>
    <td>NGX_CONF_2MORE</td>
    <td>配置项携带参数必须超过2个</td>
  </tr>
  <tr>
    <td>NGX_CONF_MULTI</td>
    <td>表示当前配置项可以出现在任意块中</td>
  </tr>
</table>

<p> 如果HTTP模块中定义的配置项在nginx.conf配置文件中实际出现的位置和参数格式与type意义不符，那么Nginx启动报错。</p>
<p>每个进程都有一个唯一的ngx_cycle_t核心结构体，其成员conf_ctx维护所有模块配置结构体。其类型是void<strong><strong>。conf_ctx意义为首先指向一个成员皆为指针的数组，其中每个成员指针又指向另外一个成员皆为指针的数组，第二个子数组中的成员指针才会指向个模块生成的配置结构体。这是为了事件模块、http模块、mail模块而设计的。而NGX_CORE_MODULE类型的核心模块解析配置项时，配置项一定是全局的，不会从属任何{}配置块，其不需要这种双数组设计。解析标识为NGX_DIRECT_CONF类型的配置项时，会将void</strong></strong>转换为void**。</p>
<h4 id="char-set-ngx-conf-t-cf-ngx-command-t-cmd-void-conf"><a href="#char-set-ngx-conf-t-cf-ngx-command-t-cmd-void-conf" class="headerlink" title="char(set)(ngx_conf_t cf, ngx_command_t cmd, void *conf)"></a>char(set)(ngx_conf_t <em>cf, ngx_command_t</em> cmd, void *conf)</h4><p><code>set</code>回调方法，使用位置在ngx_conf_handler中已展现。对于set方法，我们即可以实现一个回调方法来处理，也可以使用Nginx预设的14个解析配置项方法。预设方法如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>预设方法名</th>
<th>行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_conf_set_flag_slot</td>
<td>如果nginx.conf文件中某个配置项的参数是on或off（打开或关闭），而且在Nginx模块的代码中使用ngx_flag_t变量来保存这个配置项的参数，就可以将set回调方法设为ngx_conf_set_flag_slot。当nginx.conf文件中参数是on时，代码中的ngx_flag_t类型变量设为1，参数off时为0.</td>
</tr>
<tr>
<td>ngx_conf_set_str_slot</td>
<td>如果配置项后只有一个参数，同时在代码中我们希望用ngx_str_t类型变量来报错这个配置项的参数，则可以使用ngx_conf_set_str_slot方法</td>
</tr>
<tr>
<td>ngx_conf_set_str_array_slot</td>
<td>如果配置项会出现多次，每个配置项后面跟着1个参数，而程序中使用一个ngx_array_t动态数组来存储所有参数，且数组中的每个参数都使用ngx_str_t来存储，可以设置该方法。</td>
</tr>
<tr>
<td>ngx_conf_set_keyval_slot</td>
<td>与ngx_conf_set_str_array_slot类似，也是使用ngx_array_t动态数组来存储所有参数。只是每个配置项的参数不再是1个，而必须是2个，且以配置项名 关键字 值的形式出现在nginx.conf中，同时改方法把这些配置项转化为数组，其中每个元素都存储这key/value对。</td>
</tr>
<tr>
<td>ngx_conf_set_num_slot</td>
<td>配置项后必须携带1个参数，且只能是数字，存储这个参数的变量必须是整数</td>
</tr>
<tr>
<td>ngx_conf_set_size_slot</td>
<td>配置项后必须携带1个参数，表示空间大小，可以是一个数字，此时表示字节数（Byte）。如果后面跟着K或k，表示kilobyte，1kb=1024B,如果后面更早m或M，就表示Megabyte，1MB=1024KB。该函数解析后，都转换成byte。</td>
</tr>
<tr>
<td>ngx_conf_set_off_slot</td>
<td>配置项后必须携带1个参数，表示空间上的偏移，可以是一个数字，此时表示字节数（Byte）。如果后面跟着K或k，表示kilobyte，1kb=1024B,如果后面更早m或M，就表示Megabyte，1MB=1024KB。还可以是g或G。该函数解析后，都转换成byte。</td>
</tr>
<tr>
<td>ngx_conf_set_msec_slot</td>
<td>配置项后必须携带1个参数，表示时间。无单位表示秒。m表示分钟。h表示小时。d表示天。w表示周。m表示月（30天）。y表示年。解析后转化为毫秒的单位</td>
</tr>
<tr>
<td>ngx_conf_set_sec_slot</td>
<td>与ngx_conf_set_msec_slot类似，不过解析后转化为秒</td>
</tr>
<tr>
<td>ngx_conf_set_bufs_slot</td>
<td>配置项后必须携带2个参数。第一个参数是数字，第二个参数表示空间大小。例如”gzip-buffers 4 8k”（通常用来表示有多少个ngx_buf_t缓冲区）。第一个不可带单位。第二个为存储大小。该配置对应Nginx最常用的多缓冲区的解决方案（如接收对端发来的TCP流）</td>
</tr>
<tr>
<td>ngx_conf_set_enum_slot</td>
<td>配置项后必须携带1个参数，其取值范围是我们设定好的字符串之一。</td>
</tr>
<tr>
<td>ngx_conf_set_bitmask_slot</td>
<td>与ngx_conf_set_enum_slot类似。</td>
</tr>
<tr>
<td>ngx_conf_set_access_slot</td>
<td>这个方法用于设置目录或者文件的读写权限。配置项后可以携带1~3个参数，可以是如下形式：user:rw group:rw all:rw。其意义与Linux上文件或目录的权限一致，但user/group/all后面权限只可以设置rw，或者r</td>
</tr>
<tr>
<td>ngx_conf_set_path_slot</td>
<td>用于设置路径，配置项后面必须携带1个参数，表示一个有意义的路径。该方法会把参数转化为ngx_path_t结构</td>
</tr>
</tbody>
</table>
</div>
<h4 id="ngx-uint-t-conf"><a href="#ngx-uint-t-conf" class="headerlink" title="ngx_uint_t conf"></a>ngx_uint_t conf</h4><p>conf用于指示配置项所处内存的相对偏移位置，仅在type中没有设置NGX_DIRECT_CONF和NGX_MAIN_CONF时才会生效。对于HTTP模块，conf是必须要设置的，其取值范围如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>conf在HTTP模块的取值</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>NGX_HTTP_MAIN_CONF_OFFSET</td>
<td>使用create_main_conf方法产生的结构体来存储解析出的配置项参数</td>
</tr>
<tr>
<td>NGX_HTTP_SRV_CONF_OFFSET</td>
<td>使用create_srv_conf方法产生的结构体来存储解析出的配置项参数</td>
</tr>
<tr>
<td>NGX_HTTP_LOC_CONF_OFFSET</td>
<td>使用create_loc_conf方法产生的结构体来存储解析出的配置项参数</td>
</tr>
</tbody>
</table>
</div>
<p>HTTP框架可以使用预设的14种方法自动地将解析出的配置项写入HTTP模块代码定义的结构体中，但HTTP模块中可能会定义3个结 构体，分别用于存储main、srv、loc级别的配置项(对应于create_main_conf、 create_srv_conf、create_loc_conf方法创建的结构体)，而HTTP框架自动解析时需要知道应把解析出的配置项值写入哪个结构体中，这将由conf成员完成。</p>
<p>对conf的设置是与ngx_http_module_t实现的回调方法相关的。 如果用于存储这个配置项的数据结构是由create_main_conf回调方法完成的，那么必须把conf 设置为NGX_HTTP_MAIN_CONF_OFFSET。同样，如果这个配置项所属的数据结构是由 create_srv_conf回调方法完成的，那么必须把conf设置为NGX_HTTP_SRV_CONF_OFFSET。 可如果create_loc_conf负责生成存储这个配置项的数据结构，就得将conf设置为 NGX_HTTP_LOC_CONF_OFFSET。</p>
<p>目前，功能较为简单的HTTP模块都只实现了create_loc_conf回调方法，对于http{}、 server{}块内出现的同名配置项，都是并入某个location{}内create_loc_conf方法产生的结构体 中的。当我们希望同时出现在http{}、server{}、 location{}块的同名配置项，在HTTP模块的代码中保存于不同的变量中时，就需要实现 create_main_conf方法、create_srv_conf方法产生新的结构体，从而以不同的结构体独立保存 不同级别的配置项，而不是全部合并到某个location下create_loc_conf方法生成的结构体中。</p>
<h4 id="ngx-uint-t-offset"><a href="#ngx-uint-t-offset" class="headerlink" title="ngx_uint_t offset"></a>ngx_uint_t offset</h4><p>offset表示当前配置项在整个存储配置项的结构体中的偏移位置(以字节(Byte)为单位)。在使用Nginx预设的解析配置项方法时，就必须指定offset，这 样Nginx首先通过conf成员找到应该用哪个结构体来存放，然后通过offset成员找到这个结构 体中的相应成员，以便存放该配置。如果是自定义的专用配置项解析方法(只解析某一个配 置项)，则可以不设置offset的值。其设置方式主要方式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(type,member)(size_t)&amp;(((type*)0)-&gt;member)</span></span><br></pre></td></tr></table></figure>
<h4 id="void-post"><a href="#void-post" class="headerlink" title="void *post"></a>void *post</h4><p>post指针有许多用处，其使用方式是在调用set方法内调用。</p>
<p>如果自定义了配置项的回调方法，那么post指针的用途完全由用户来定义。如果不使用 它，那么随意设为NULL即可。如果想将一些数据结构或者方法的指针传过来，那么使用post 也可以。</p>
<p>如果使用Nginx预设的配置项解析方法，就需要根据这些预设方法来决定post的使用方 式。表4-4说明了post相对于14个预设方法的用途。</p>
<table>
  <tr>
    <td>pos使用方法</td>
    <td>适用的预设配置项解析方法</td>
  </tr>
  <tr>
    <td rowspan="9">可以选择是否实现。如果设置NULL，则表示不实现，否则必须实现为指向ngx_conf_post_t结构的指针。ngx_conf_post_t中包含一个方法指针，表示在解析当前配置项完毕后，需要回调这个方法</td>
    <td>ngx_conf_set_flag_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_str_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_str_array_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_keyval_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_num_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_size_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_off_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_msec_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_sec_slot</td>
  </tr>
  <tr>
    <td>指向ngx_conf_enum_t数组，表示当前配置项的参数必须设置为ngx_conf_enum_t规定的值（类似枚举）。必须定义</td>
    <td>ngx_conf_set_enum_slot</td>
  </tr>
  <tr>
    <td>指向ngx_conf_bitmask_t数组，表示当前配置项的参数必须设置为ngx_conf_bitmask_t规定的值（类似枚举）。必须定义</td>
    <td>ngx_conf_set_enum_slot</td>
  </tr>
  <tr>
    <td rowspan="3">无任何用处</td>
    <td>ngx_conf_set_buffs_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_path_slot</td>
  </tr>
  <tr>
    <td>ngx_conf_set_access_slot</td>
  </tr>
</table>

<p>有9个预设方法在使用post是可以设置为ngx_conf_post_t结构体来使用，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">char</span> <span class="params">(ngx_conf_post_handler_pt)</span> <span class="params">(<span class="keyword">ngx_conf_t</span> cf, <span class="keyword">void</span> data, <span class="keyword">void</span> *conf)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  ngx_conf_post_handler_pt post_handler;</span><br><span class="line">&#125; <span class="keyword">ngx_conf_post_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="预设配置项处理方法工作原理"><a href="#预设配置项处理方法工作原理" class="headerlink" title="预设配置项处理方法工作原理"></a>预设配置项处理方法工作原理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">ngx_conf_set_num_slot(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// conf为存储参数的结构体指针。该结构体是每个模块自定义的。</span></span><br><span class="line">    <span class="keyword">char</span>  *p = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>        *np;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>        *value;</span><br><span class="line">    <span class="keyword">ngx_conf_post_t</span>  *post;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据ngx_command_t中offset偏移量，可以找到结构体中成员</span></span><br><span class="line">    np = (<span class="keyword">ngx_int_t</span> *) (p + cmd-&gt;offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*np != NGX_CONF_UNSET) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// value将指向配置项的参数</span></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 将字符串的参数转换为整数，并设置到create_loc_conf等方法生成的结构体的相关成员上</span></span><br><span class="line">    *np = ngx_atoi(value[<span class="number">1</span>].data, value[<span class="number">1</span>].len);</span><br><span class="line">    <span class="keyword">if</span> (*np == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"invalid number"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果ngx_command_t中post已经实现，那么还需要调用post-&gt;post_handler方法。目前Nginx官方模块未使用</span></span><br><span class="line">    <span class="keyword">if</span> (cmd-&gt;post) &#123;</span><br><span class="line">        post = cmd-&gt;post;</span><br><span class="line">        <span class="keyword">return</span> post-&gt;post_handler(cf, post, np);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="http模块配置解析"><a href="#http模块配置解析" class="headerlink" title="http模块配置解析"></a>http模块配置解析</h2><p><a href="https://imgtu.com/i/RcHHKK" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/02/RcHHKK.png" alt="RcHHKK.png"></a></p>
<p>在默认的处理函数<code>ngx_conf_handler</code>中，会会调用核心模块的commands数组的每个元素的set方法。对于http来说，核心模块为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span>  ngx_http_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http"</span>),</span><br><span class="line">      NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span><br><span class="line">      ngx_http_block,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_core_module_t</span>  ngx_http_module_ctx = &#123;</span><br><span class="line">    ngx_string(<span class="string">"http"</span>),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_module_t</span>  ngx_http_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_http_module_ctx,                  <span class="comment">/* module context */</span></span><br><span class="line">    ngx_http_commands,                     <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_CORE_MODULE,                       <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init master */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init module */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="http层set函数"><a href="#http层set函数" class="headerlink" title="http层set函数"></a>http层set函数</h3><p>执行set方法即执行ngx_http_block函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_block(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                        *rv;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   mi, m, s;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                   pcf;</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span>           *<span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>         *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>   **cscfp;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>   *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">ngx_http_conf_ctx_t</span> **) conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"is duplicate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the main http context */</span></span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">ngx_http_conf_ctx_t</span> **) conf = ctx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* count the number of the http modules and set up their indices */</span></span><br><span class="line">    <span class="comment">// 获取http模块数量，并设置其ctx_index</span></span><br><span class="line">    ngx_http_max_module = ngx_count_modules(cf-&gt;cycle, NGX_HTTP_MODULE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the http main_conf context, it is the same in the all http contexts */</span></span><br><span class="line">    <span class="comment">// 初始化ctx</span></span><br><span class="line">    ctx-&gt;main_conf = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;main_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the http null srv_conf context, it is used to merge</span></span><br><span class="line"><span class="comment">     * the server&#123;&#125;s' srv_conf's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;srv_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the http null loc_conf context, it is used to merge</span></span><br><span class="line"><span class="comment">     * the server&#123;&#125;s' loc_conf's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * create the main_conf's, the null srv_conf's, and the null loc_conf's</span></span><br><span class="line"><span class="comment">     * of the all http modules</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 执行每个http模块的create_main_conf、create_srv_conf、create_loc_conf方法，其返回为每个模块在对于块下用于存储解析结果的结构体</span></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">        mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_main_conf) &#123;</span><br><span class="line">            ctx-&gt;main_conf[mi] = <span class="keyword">module</span>-&gt;create_main_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;main_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_srv_conf) &#123;</span><br><span class="line">            ctx-&gt;srv_conf[mi] = <span class="keyword">module</span>-&gt;create_srv_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;srv_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_loc_conf) &#123;</span><br><span class="line">            ctx-&gt;loc_conf[mi] = <span class="keyword">module</span>-&gt;create_loc_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;loc_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pcf = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    <span class="comment">// 执行每个模块的preconfiguration方法，增加变量。</span></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;preconfiguration) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;preconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* parse inside the http&#123;&#125; block */</span></span><br><span class="line">    <span class="comment">// 解析http块下配置</span></span><br><span class="line">    cf-&gt;module_type = NGX_HTTP_MODULE;</span><br><span class="line">    cf-&gt;cmd_type = NGX_HTTP_MAIN_CONF;</span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * init http&#123;&#125; main_conf's, merge the server&#123;&#125;s' srv_conf's</span></span><br><span class="line"><span class="comment">     * and its location&#123;&#125;s' loc_conf's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 解析后合并及其他操作，下一章节介绍</span></span><br><span class="line">    cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    cscfp = cmcf-&gt;servers.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">        mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* init http&#123;&#125; main_conf's */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;init_main_conf) &#123;</span><br><span class="line">            rv = <span class="keyword">module</span>-&gt;init_main_conf(cf, ctx-&gt;main_conf[mi]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rv = ngx_http_merge_servers(cf, cmcf, <span class="keyword">module</span>, mi);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create location trees */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_locations(cf, cscfp[s], clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_phases(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_headers_in_hash(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_variables_init_vars(cf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * http&#123;&#125;'s cf-&gt;ctx was needed while the configuration merging</span></span><br><span class="line"><span class="comment">     * and in postconfiguration process</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_phase_handlers(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* optimize the lists of ports, addresses and server names */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_optimize_servers(cf, cmcf, cmcf-&gt;ports) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-conf-ctx-t"><a href="#ngx-http-conf-ctx-t" class="headerlink" title="ngx_http_conf_ctx_t"></a>ngx_http_conf_ctx_t</h4><p>上面代码中ngx_http_conf_ctx_t类定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    void        **main_conf;</span><br><span class="line">    void        **srv_conf;</span><br><span class="line">    void        **loc_conf;</span><br><span class="line">&#125; ngx_http_conf_ctx_t;</span><br></pre></td></tr></table></figure>
<p>分别用来存储main、server、loc块下配置。</p>
<h4 id="ngx-http-core-module模块生成的三个结构"><a href="#ngx-http-core-module模块生成的三个结构" class="headerlink" title="ngx_http_core_module模块生成的三个结构"></a>ngx_http_core_module模块生成的三个结构</h4><p>在执行create_main_conf、create_srv_conf、create_loc_conf时，会生成三个结构体，其中ngx_http_core_module是http的核心模块。其生成的三个结构体如下：</p>
<h5 id="ngx-http-core-main-conf-t"><a href="#ngx-http-core-main-conf-t" class="headerlink" title="ngx_http_core_main_conf_t"></a>ngx_http_core_main_conf_t</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_array_t                servers;         /* ngx_http_core_srv_conf_t */</span><br><span class="line"></span><br><span class="line">    ngx_http_phase_engine_t    phase_engine;</span><br><span class="line"></span><br><span class="line">    ngx_hash_t                 headers_in_hash;</span><br><span class="line"></span><br><span class="line">    ngx_hash_t                 variables_hash;</span><br><span class="line"></span><br><span class="line">    ngx_array_t                variables;         /* ngx_http_variable_t */</span><br><span class="line">    ngx_array_t                prefix_variables;  /* ngx_http_variable_t */</span><br><span class="line">    ngx_uint_t                 ncaptures;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                 server_names_hash_max_size;</span><br><span class="line">    ngx_uint_t                 server_names_hash_bucket_size;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                 variables_hash_max_size;</span><br><span class="line">    ngx_uint_t                 variables_hash_bucket_size;</span><br><span class="line"></span><br><span class="line">    ngx_hash_keys_arrays_t    *variables_keys;</span><br><span class="line"></span><br><span class="line">    ngx_array_t               *ports;</span><br><span class="line"></span><br><span class="line">    ngx_http_phase_t           phases[NGX_HTTP_LOG_PHASE + 1];</span><br><span class="line">&#125; ngx_http_core_main_conf_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-core-srv-conf-t"><a href="#ngx-http-core-srv-conf-t" class="headerlink" title="ngx_http_core_srv_conf_t"></a>ngx_http_core_srv_conf_t</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    /* array of the ngx_http_server_name_t, &quot;server_name&quot; directive */</span><br><span class="line">    ngx_array_t                 server_names;</span><br><span class="line"></span><br><span class="line">    /* server ctx */</span><br><span class="line">    ngx_http_conf_ctx_t        *ctx;</span><br><span class="line"></span><br><span class="line">    u_char                     *file_name;</span><br><span class="line">    ngx_uint_t                  line;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                   server_name;</span><br><span class="line"></span><br><span class="line">    size_t                      connection_pool_size;</span><br><span class="line">    size_t                      request_pool_size;</span><br><span class="line">    size_t                      client_header_buffer_size;</span><br><span class="line"></span><br><span class="line">    ngx_bufs_t                  large_client_header_buffers;</span><br><span class="line"></span><br><span class="line">    ngx_msec_t                  client_header_timeout;</span><br><span class="line"></span><br><span class="line">    ngx_flag_t                  ignore_invalid_headers;</span><br><span class="line">    ngx_flag_t                  merge_slashes;</span><br><span class="line">    ngx_flag_t                  underscores_in_headers;</span><br><span class="line"></span><br><span class="line">    unsigned                    listen:1; // 配置中是否设置了监听</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    unsigned                    captures:1;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_http_core_loc_conf_t  **named_locations;</span><br><span class="line">&#125; ngx_http_core_srv_conf_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-core-loc-conf-s"><a href="#ngx-http-core-loc-conf-s" class="headerlink" title="ngx_http_core_loc_conf_s"></a>ngx_http_core_loc_conf_s</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_http_core_loc_conf_s &#123;</span><br><span class="line">    ngx_str_t     name;          /* location name */</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_regex_t  *regex;</span><br><span class="line">#endif</span><br><span class="line">    // nginx将if语句和limit_except也看作为ngx_http_core_loc_conf_s，这里标识其类型为非location块的</span><br><span class="line">    unsigned      noname:1;   /* &quot;if () &#123;&#125;&quot; block or limit_except */ </span><br><span class="line">    unsigned      lmt_excpt:1;</span><br><span class="line">    // 以’@’开头的，如location @test &#123;&#125;</span><br><span class="line">    unsigned      named:1;</span><br><span class="line">    // 类似 location = / &#123;&#125;，所谓准确匹配。</span><br><span class="line">    unsigned      exact_match:1;</span><br><span class="line">    // 没有正则，指类似location ^~ /a &#123; ... &#125; 的location。</span><br><span class="line">    unsigned      noregex:1;</span><br><span class="line"></span><br><span class="line">    unsigned      auto_redirect:1;</span><br><span class="line">#if (NGX_HTTP_GZIP)</span><br><span class="line">    unsigned      gzip_disable_msie6:2;</span><br><span class="line">    unsigned      gzip_disable_degradation:2;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_http_location_tree_node_t   *static_locations;</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_core_loc_conf_t       **regex_locations;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    /* pointer to the modules&apos; loc_conf */</span><br><span class="line">    void        **loc_conf;</span><br><span class="line"></span><br><span class="line">    uint32_t      limit_except;</span><br><span class="line">    void        **limit_except_loc_conf;</span><br><span class="line"></span><br><span class="line">    ngx_http_handler_pt  handler;</span><br><span class="line"></span><br><span class="line">    /* location name length for inclusive location with inherited alias */</span><br><span class="line">    size_t        alias;</span><br><span class="line">    ngx_str_t     root;                    /* root, alias */</span><br><span class="line">    ngx_str_t     post_action;</span><br><span class="line"></span><br><span class="line">    ngx_array_t  *root_lengths;</span><br><span class="line">    ngx_array_t  *root_values;</span><br><span class="line"></span><br><span class="line">    ngx_array_t  *types;</span><br><span class="line">    ngx_hash_t    types_hash;</span><br><span class="line">    ngx_str_t     default_type;</span><br><span class="line"></span><br><span class="line">    off_t         client_max_body_size;    /* client_max_body_size */</span><br><span class="line">    off_t         directio;                /* directio */</span><br><span class="line">    off_t         directio_alignment;      /* directio_alignment */</span><br><span class="line"></span><br><span class="line">    size_t        client_body_buffer_size; /* client_body_buffer_size */</span><br><span class="line">    size_t        send_lowat;              /* send_lowat */</span><br><span class="line">    size_t        postpone_output;         /* postpone_output */</span><br><span class="line">    size_t        sendfile_max_chunk;      /* sendfile_max_chunk */</span><br><span class="line">    size_t        read_ahead;              /* read_ahead */</span><br><span class="line">    size_t        subrequest_output_buffer_size;</span><br><span class="line">                                           /* subrequest_output_buffer_size */</span><br><span class="line"></span><br><span class="line">    ngx_http_complex_value_t  *limit_rate; /* limit_rate */</span><br><span class="line">    ngx_http_complex_value_t  *limit_rate_after; /* limit_rate_after */</span><br><span class="line"></span><br><span class="line">    ngx_msec_t    client_body_timeout;     /* client_body_timeout */</span><br><span class="line">    ngx_msec_t    send_timeout;            /* send_timeout */</span><br><span class="line">    ngx_msec_t    keepalive_timeout;       /* keepalive_timeout */</span><br><span class="line">    ngx_msec_t    lingering_time;          /* lingering_time */</span><br><span class="line">    ngx_msec_t    lingering_timeout;       /* lingering_timeout */</span><br><span class="line">    ngx_msec_t    resolver_timeout;        /* resolver_timeout */</span><br><span class="line">    ngx_msec_t    auth_delay;              /* auth_delay */</span><br><span class="line"></span><br><span class="line">    ngx_resolver_t  *resolver;             /* resolver */</span><br><span class="line"></span><br><span class="line">    time_t        keepalive_header;        /* keepalive_timeout */</span><br><span class="line"></span><br><span class="line">    ngx_uint_t    keepalive_requests;      /* keepalive_requests */</span><br><span class="line">    ngx_uint_t    keepalive_disable;       /* keepalive_disable */</span><br><span class="line">    ngx_uint_t    satisfy;                 /* satisfy */</span><br><span class="line">    ngx_uint_t    lingering_close;         /* lingering_close */</span><br><span class="line">    ngx_uint_t    if_modified_since;       /* if_modified_since */</span><br><span class="line">    ngx_uint_t    max_ranges;              /* max_ranges */</span><br><span class="line">    ngx_uint_t    client_body_in_file_only; /* client_body_in_file_only */</span><br><span class="line"></span><br><span class="line">    ngx_flag_t    client_body_in_single_buffer;</span><br><span class="line">                                           /* client_body_in_singe_buffer */</span><br><span class="line">    ngx_flag_t    internal;                /* internal */</span><br><span class="line">    ngx_flag_t    sendfile;                /* sendfile */</span><br><span class="line">    ngx_flag_t    aio;                     /* aio */</span><br><span class="line">    ngx_flag_t    aio_write;               /* aio_write */</span><br><span class="line">    ngx_flag_t    tcp_nopush;              /* tcp_nopush */</span><br><span class="line">    ngx_flag_t    tcp_nodelay;             /* tcp_nodelay */</span><br><span class="line">    ngx_flag_t    reset_timedout_connection; /* reset_timedout_connection */</span><br><span class="line">    ngx_flag_t    absolute_redirect;       /* absolute_redirect */</span><br><span class="line">    ngx_flag_t    server_name_in_redirect; /* server_name_in_redirect */</span><br><span class="line">    ngx_flag_t    port_in_redirect;        /* port_in_redirect */</span><br><span class="line">    ngx_flag_t    msie_padding;            /* msie_padding */</span><br><span class="line">    ngx_flag_t    msie_refresh;            /* msie_refresh */</span><br><span class="line">    ngx_flag_t    log_not_found;           /* log_not_found */</span><br><span class="line">    ngx_flag_t    log_subrequest;          /* log_subrequest */</span><br><span class="line">    ngx_flag_t    recursive_error_pages;   /* recursive_error_pages */</span><br><span class="line">    ngx_uint_t    server_tokens;           /* server_tokens */</span><br><span class="line">    ngx_flag_t    chunked_transfer_encoding; /* chunked_transfer_encoding */</span><br><span class="line">    ngx_flag_t    etag;                    /* etag */</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_GZIP)</span><br><span class="line">    ngx_flag_t    gzip_vary;               /* gzip_vary */</span><br><span class="line"></span><br><span class="line">    ngx_uint_t    gzip_http_version;       /* gzip_http_version */</span><br><span class="line">    ngx_uint_t    gzip_proxied;            /* gzip_proxied */</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_array_t  *gzip_disable;            /* gzip_disable */</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_THREADS || NGX_COMPAT)</span><br><span class="line">    ngx_thread_pool_t         *thread_pool;</span><br><span class="line">    ngx_http_complex_value_t  *thread_pool_value;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_OPENAT)</span><br><span class="line">    ngx_uint_t    disable_symlinks;        /* disable_symlinks */</span><br><span class="line">    ngx_http_complex_value_t  *disable_symlinks_from;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_array_t  *error_pages;             /* error_page */</span><br><span class="line"></span><br><span class="line">    ngx_path_t   *client_body_temp_path;   /* client_body_temp_path */</span><br><span class="line"></span><br><span class="line">    ngx_open_file_cache_t  *open_file_cache;</span><br><span class="line">    time_t        open_file_cache_valid;</span><br><span class="line">    ngx_uint_t    open_file_cache_min_uses;</span><br><span class="line">    ngx_flag_t    open_file_cache_errors;</span><br><span class="line">    ngx_flag_t    open_file_cache_events;</span><br><span class="line"></span><br><span class="line">    ngx_log_t    *error_log;</span><br><span class="line"></span><br><span class="line">    ngx_uint_t    types_hash_max_size;</span><br><span class="line">    ngx_uint_t    types_hash_bucket_size;</span><br><span class="line"></span><br><span class="line">    ngx_queue_t  *locations;</span><br><span class="line"></span><br><span class="line">#if 0</span><br><span class="line">    ngx_http_core_loc_conf_t  *prev_location;</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在处理http块内main配置时，对每个http模块创建了三个结构体，这是为了把同时出现在http、server、location块中相同的配置进行合并而准备的。例如，有一个与server相关的配置（例如负责指定每个TCP连接池大小的connection_pool_size配置项）同时出现在http和server中，那么对其感兴趣的http模块有权决定srv结构内成员究竟是以main级别的为准还是已srv的为准。对loc级别的配置也是如此，loc级别的需要http下创建的loc和server创建的loc和loc级别本身创建的loc三者共同决定。因此main级别的配置会被创建1次（在解析http时创建），server级别的配置会被创建2次（解析http块一次和解析server块一次），loc级别配置会被创建三次（解析http块一次、解析server块一次和解析loc块一次）。具体配置在内存中结构之后会详细解释。</p>
<p>在创建配置后，就会继续解析配置，此时，遇到的第一个http模块就是ngx_http_core_module。从上述代码可以看出来，nginx配置项解析采用的是深度优先搜索模式，其解析的顺序是十分重要的，一定要先解析核心模块，再解析每类模块在该模块下的代理（如http模块的代理为ngx_http_core_module），之后才能再解析该类模块下其他模块。</p>
<h4 id="http级配置解析内存结构"><a href="#http级配置解析内存结构" class="headerlink" title="http级配置解析内存结构"></a>http级配置解析内存结构</h4><p><a href="https://imgtu.com/i/RW0I2j" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/04/RW0I2j.png" alt="RW0I2j.png"></a></p>
<p><center>图10-1</center><br>ngx_http_core_module是第一个http模块，其ctx_index为0，因此，数组中第一个指针指向ngx_http_core_module生成的三个结构体。要由ngx_cycle_t获得main级别配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ngx_http_get_module_main_conf(r, module)                             \</span><br><span class="line">    (r)-&gt;main_conf[module.ctx_index]</span><br></pre></td></tr></table></figure>
<h3 id="server级别set函数"><a href="#server级别set函数" class="headerlink" title="server级别set函数"></a>server级别set函数</h3><p>在http中，接着执行解析函数时，当解析到server配置时，首先会遇到ngx_http_core_module核心模块的commands中的server。如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"server"</span>),</span><br><span class="line">      NGX_HTTP_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span><br><span class="line">      ngx_http_core_server,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>其函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_core_server(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *dummy)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                        *rv;</span><br><span class="line">    <span class="keyword">void</span>                        *mconf;</span><br><span class="line">    <span class="keyword">size_t</span>                       len;</span><br><span class="line">    u_char                      *p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   i;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                   pcf;</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span>           *<span class="keyword">module</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>          *<span class="title">sin</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>         *ctx, *http_ctx;</span><br><span class="line">    <span class="keyword">ngx_http_listen_opt_t</span>        lsopt;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>    *cscf, **cscfp;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>   *cmcf;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里的ctx为http块解析时生成的ngx_http_conf_ctx_t，具体可看http的set代码。</span></span><br><span class="line">    http_ctx = cf-&gt;ctx;</span><br><span class="line">    <span class="comment">// 由于server块中不含main层级的配置项，因此其main_conf执行http层生成的main_conf即可</span></span><br><span class="line">    ctx-&gt;main_conf = http_ctx-&gt;main_conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the server&#123;&#125;'s srv_conf */</span></span><br><span class="line">    <span class="comment">// 创建server和location块的存储结构</span></span><br><span class="line">    ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;srv_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the server&#123;&#125;'s loc_conf */</span></span><br><span class="line"></span><br><span class="line">    ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_srv_conf) &#123;</span><br><span class="line">            mconf = <span class="keyword">module</span>-&gt;create_srv_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (mconf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctx-&gt;srv_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] = mconf;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_loc_conf) &#123;</span><br><span class="line">            mconf = <span class="keyword">module</span>-&gt;create_loc_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (mconf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctx-&gt;loc_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] = mconf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the server configuration context */</span></span><br><span class="line">    <span class="comment">// 使用server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t的ctx来存储server块生成的配置内存结构</span></span><br><span class="line">    cscf = ctx-&gt;srv_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    cscf-&gt;ctx = ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取main层ngx_http_core_module块生成的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// 将server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t添加到main层ngx_http_core_module块生成的ngx_http_core_main_conf_t的server中，使用该方式将main层的配置内存结构和server层配置内存结构串联起来。</span></span><br><span class="line">    cscfp = ngx_array_push(&amp;cmcf-&gt;servers);</span><br><span class="line">    <span class="keyword">if</span> (cscfp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *cscfp = cscf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* parse inside server&#123;&#125; */</span></span><br><span class="line">    <span class="comment">// 继续解析server块。</span></span><br><span class="line">    pcf = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    cf-&gt;cmd_type = NGX_HTTP_SRV_CONF;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    *cf = pcf;</span><br><span class="line">    <span class="comment">// 如果正常解析，但并未设置监听，则使用默认监听（root 80， user 8000）。具体可以看下一部分的管理监听端口章节</span></span><br><span class="line">    <span class="keyword">if</span> (rv == NGX_CONF_OK &amp;&amp; !cscf-&gt;listen) &#123;</span><br><span class="line">        ngx_memzero(&amp;lsopt, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_listen_opt_t</span>));</span><br><span class="line"></span><br><span class="line">        p = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(struct sockaddr_in));</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lsopt.sockaddr = (struct sockaddr *) p;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sin</span> = (struct sockaddr_in *) p;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_family = AF_INET;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_port = htons(<span class="number">80</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_port = htons((getuid() == <span class="number">0</span>) ? <span class="number">80</span> : <span class="number">8000</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="built_in">sin</span>-&gt;sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">        lsopt.socklen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line"></span><br><span class="line">        lsopt.backlog = NGX_LISTEN_BACKLOG;</span><br><span class="line">        lsopt.rcvbuf = <span class="number">-1</span>;</span><br><span class="line">        lsopt.sndbuf = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">        lsopt.setfib = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">        lsopt.fastopen = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        lsopt.wildcard = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        len = NGX_INET_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(cf-&gt;pool, len);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lsopt.addr_text.data = p;</span><br><span class="line">        lsopt.addr_text.len = ngx_sock_ntop(lsopt.sockaddr, lsopt.socklen, p,</span><br><span class="line">                                            len, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_add_listen(cf, cscf, &amp;lsopt) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="server级配置解析内存结构"><a href="#server级配置解析内存结构" class="headerlink" title="server级配置解析内存结构"></a>server级配置解析内存结构</h4><p><a href="https://imgtu.com/i/R5gtCn" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/05/R5gtCn.png" alt="R5gtCn.png"></a></p>
<p><center>图10-3</center><br>解析每一个server块时都会创建一个新的 ngx_http_conf_ctx_t结构体，其中的main_conf将指向http块下main_conf指针数组，而srv_conf和 loc_conf数组则都会重新分配，它们的内容就是所有HTTP模块的create_srv_conf方法、 create_loc_conf方法创建的结构体指针。</p>
<p>http层的存储结构和server层存储关联方式为：将server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t添加到main层ngx_http_core_module块生成的ngx_http_core_main_conf_t的server中，其中server层ngx_http_core_module模块生成的ngx_http_core_srv_conf_t中的ctx指向server层生成的ngx_http_conf_ctx_t结构体。使用该方式将main层的配置内存结构和server层配置内存结构串联起来。</p>
<h3 id="管理监听端口号"><a href="#管理监听端口号" class="headerlink" title="管理监听端口号"></a>管理监听端口号</h3><p>nginx配置，使用listen来设置监听端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen address:port [default(deprecated in 0.8.21) | default_server | [backlog=num | rcvbuf=size | sndbuf=size | accept_filter=filter | deferred | bind | ipv6only=[on|off] ssl | so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]]];</span><br><span class="line"></span><br><span class="line">#default </span><br><span class="line">listion 80;</span><br><span class="line"></span><br><span class="line">#conf block</span><br><span class="line">server</span><br></pre></td></tr></table></figure>
<p>listen决定nginx服务监听端口。listen后可以加IP地址、端口号或者主机名。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen 127.0.0.1:8002;</span><br><span class="line">listen 127.0.0.1; //default port 80</span><br><span class="line">listen *:8000;</span><br></pre></td></tr></table></figure>
<p>地址后可以加其他参数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>将所在server块作为整个web服务的默认server块。当一个请求无法匹配配置文件中的所有主机域名时，就会选择默认虚拟主机。如果所有server都未指定，则默认选第一个。</td>
</tr>
<tr>
<td>backlog=num</td>
<td>TCP中backlog大小。（默认-1，无限制）在TCP建立三次连接时，进程还未监听句柄，此时backlog队列将会放置这些连接。如果backlog已满，还有客户端企图建立连接，则会失败。</td>
</tr>
<tr>
<td>rcvbuf=size</td>
<td>设置监听句柄的SO_RCVBUF参数。</td>
</tr>
<tr>
<td>sndbuf=size</td>
<td>设置监听句柄的SO_SNDBUF参数。</td>
</tr>
<tr>
<td>accept_filter</td>
<td>设置accept过滤，只对FreeBSD系统有用。</td>
</tr>
<tr>
<td>deferred</td>
<td>设置该参数时，若用户建立了TCP连接（三次握手），内核也不会对该连接调度worker进程来处理，只会在用户真正发送请求时才会分配worker进程。使用于大并发情况下。</td>
</tr>
<tr>
<td>bind</td>
<td>绑定当前端口/地址对，如127.0.0.1:8000。</td>
</tr>
<tr>
<td>ssl</td>
<td>在当前监听的端口上建立的连接必须基于SSL。</td>
</tr>
<tr>
<td>so_keepalive</td>
<td>当客户端与服务器端三次握手正式建立tcp以后，默认情况下，除非客户端或服务器端关闭上层socket，否则tcp会始终保持连接，如果这个时候网络断掉，这个链接就会变成一个死链接，会占用服务器资源。解决方式为：大多数的上游应用会通过心跳机制来检测对方是否存活，不存会则由上游应用程序关闭socket释放链接。对于tcp探活来说，存在三个参数：tcp_keepalive_time（tcp建立链接后指定时间无数据传输，则会发出探活数据包）、tcp_keepalive_probes（发出探活数据包次数）、tcp_keepalive_intvl（探活数据包之间间隔时间）so_keepalive<code>=</code>on 表示开启tcp探活，并且使用系统内核的参数。so_keepalive=30m::10 表示开启tcp探活，30分钟后伍数据会发送探活包，时间间隔使用系统默认的，发送10次探活包。</td>
</tr>
<tr>
<td>fastopen</td>
<td>number，HTTP 处于保持连接（keepalive）状态时，允许不经过三次握手的 TCP 连接的队列的最大数</td>
</tr>
<tr>
<td>sentfib</td>
<td>number，为监听套接字设置关联路由表，仅在 FreeBSD 系统上有效</td>
</tr>
<tr>
<td>ipv6only</td>
<td>on，只接收 IPv6 连接或接收 IPv6 和 IPv4 连接</td>
</tr>
<tr>
<td>reuseport</td>
<td>默认情况下，所有的工作进程会共享一个 socket 去监听同一 IP 和端口的组合。该参数启用后，允许每个工作进程有独立的 socket 去监听同一 IP 和端口的组合，内核会对传人的连接进行负载均衡。</td>
</tr>
<tr>
<td>proxy_protocol</td>
<td>在指定监听端口上启用 proxy_protocol 协议支持</td>
</tr>
</tbody>
</table>
</div>
<p>解析时，其属于ngx_http_core_commands，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"listen"</span>),</span><br><span class="line">  NGX_HTTP_SRV_CONF|NGX_CONF_1MORE,</span><br><span class="line">  ngx_http_core_listen,</span><br><span class="line">  NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="对应相关数据结构"><a href="#对应相关数据结构" class="headerlink" title="对应相关数据结构"></a>对应相关数据结构</h4><h5 id="ngx-http-listen-opt-t"><a href="#ngx-http-listen-opt-t" class="headerlink" title="ngx_http_listen_opt_t"></a>ngx_http_listen_opt_t</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    struct sockaddr           *sockaddr; // 套接字地址</span><br><span class="line">    socklen_t                  socklen; // 套接字地址长度</span><br><span class="line">    ngx_str_t                  addr_text; // 配置中监听文本</span><br><span class="line"></span><br><span class="line">    unsigned                   set:1; // 用户是否进行了相关设置</span><br><span class="line">    unsigned                   default_server:1; // 是否为默认使用的server</span><br><span class="line">    unsigned                   bind:1; </span><br><span class="line">    unsigned                   wildcard:1; // 是否为通配符形式监听地址</span><br><span class="line">    unsigned                   ssl:1;</span><br><span class="line">    unsigned                   http2:1;</span><br><span class="line">#if (NGX_HAVE_INET6)</span><br><span class="line">    unsigned                   ipv6only:1;</span><br><span class="line">#endif</span><br><span class="line">    unsigned                   deferred_accept:1;</span><br><span class="line">    unsigned                   reuseport:1;</span><br><span class="line">    unsigned                   so_keepalive:2;</span><br><span class="line">    unsigned                   proxy_protocol:1;</span><br><span class="line"></span><br><span class="line">    int                        backlog; // 对应配置backlog</span><br><span class="line">    int                        rcvbuf; // 对应配置rcvbuf</span><br><span class="line">    int                        sndbuf;// 对应配置sndbuf</span><br><span class="line">#if (NGX_HAVE_SETFIB)</span><br><span class="line">    int                        setfib;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_TCP_FASTOPEN)</span><br><span class="line">    int                        fastopen;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_KEEPALIVE_TUNABLE)</span><br><span class="line">    int                        tcp_keepidle; // 建立链接后无数据传输超出该时间，进行数据探活</span><br><span class="line">    int                        tcp_keepintvl; // 探活包之间时间间隔</span><br><span class="line">    int                        tcp_keepcnt; // 探活次数</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">    char                      *accept_filter;</span><br><span class="line">#endif</span><br><span class="line">&#125; ngx_http_listen_opt_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-url-t"><a href="#ngx-url-t" class="headerlink" title="ngx_url_t"></a>ngx_url_t</h5><p>该结构是用于存储解析url后的结果信息的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_str_t                 url; // url</span><br><span class="line">    ngx_str_t                 host; // 主机名</span><br><span class="line">    ngx_str_t                 port_text; // 端口号对应文本</span><br><span class="line">    ngx_str_t                 uri; // uri</span><br><span class="line"></span><br><span class="line">    in_port_t                 port; // 端口号</span><br><span class="line">    in_port_t                 default_port; // 默认端口号</span><br><span class="line">    in_port_t                 last_port; // 当端口号是一个区间时，最后一个端口号</span><br><span class="line">    int                       family; // 协议族</span><br><span class="line"></span><br><span class="line">    unsigned                  listen:1; // 是否为监听</span><br><span class="line">    unsigned                  uri_part:1;</span><br><span class="line">    unsigned                  no_resolve:1; // 是否不解析主机（url中不一定是ip形式请求，可能是主机，如localhost）</span><br><span class="line"></span><br><span class="line">    unsigned                  no_port:1; // 是否用户未指名端口号</span><br><span class="line">    unsigned                  wildcard:1; // 是否监听地址为通配符形式</span><br><span class="line"></span><br><span class="line">    socklen_t                 socklen; // 套接字地址长度</span><br><span class="line">    ngx_sockaddr_t            sockaddr; // 套接字地址结构，其是临时变量，会将每一个sockaddr添加到addrs中</span><br><span class="line"></span><br><span class="line">    ngx_addr_t               *addrs; // 对应的监听地址</span><br><span class="line">    ngx_uint_t                naddrs; // 对应的监听地址数量</span><br><span class="line"></span><br><span class="line">    char                     *err; // 存储解析后错误信息</span><br><span class="line">&#125; ngx_url_t;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">    struct sockaddr          *sockaddr;</span><br><span class="line">    socklen_t                 socklen;</span><br><span class="line">    ngx_str_t                 name;</span><br><span class="line">&#125; ngx_addr_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-conf-port-t"><a href="#ngx-http-conf-port-t" class="headerlink" title="ngx_http_conf_port_t"></a>ngx_http_conf_port_t</h5><p>该类是记录端口号对应每一个地址的结构。（由于一个机器可能存在多个ip地址）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_int_t                  family;</span><br><span class="line">    in_port_t                  port;</span><br><span class="line">    ngx_array_t                addrs;     /* array of ngx_http_conf_addr_t */</span><br><span class="line">&#125; ngx_http_conf_port_t;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_core_main_conf_t中的ports参数的成员即是ngx_http_conf_port_t。</p>
<h5 id="ngx-http-conf-addr-t"><a href="#ngx-http-conf-addr-t" class="headerlink" title="ngx_http_conf_addr_t"></a>ngx_http_conf_addr_t</h5><p>由于一个端口，我们可以同时监听多个ip（一个机器可能存在多个ip地址）。nginx使用ngx_http_conf_addr_t结构来表示一个对应着具体地址的监听端口，因此一个ngx_http_conf_port_t可能对应多个ngx_http_conf_addr_t。具体结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 监听套接字对应的各种属性</span><br><span class="line">    ngx_http_listen_opt_t      opt;</span><br><span class="line">    // 下面三个散列表用于加速寻找对应监听端口上的新连接，确定到达使用哪个server&#123;&#125;虚拟主机下的配置来进行处理，散列表的值是ngx_http_core_srv_conf_t结构体</span><br><span class="line">    ngx_hash_t                 hash;</span><br><span class="line">    ngx_hash_wildcard_t       *wc_head; // 通配符前缀散列表</span><br><span class="line">    ngx_hash_wildcard_t       *wc_tail; // 通配符后置散列表</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_uint_t                 nregex; // regex数量</span><br><span class="line">    ngx_http_server_name_t    *regex; // 正则表达式匹配的虚拟主机</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    /* the default server configuration for this address:port */</span><br><span class="line">    ngx_http_core_srv_conf_t  *default_server; // 监听端口下默认的虚拟主机</span><br><span class="line">    ngx_array_t                servers;  /* array of ngx_http_core_srv_conf_t */</span><br><span class="line">&#125; ngx_http_conf_addr_t;</span><br></pre></td></tr></table></figure>
<h4 id="监听端口与server-虚拟主机间内存关系"><a href="#监听端口与server-虚拟主机间内存关系" class="headerlink" title="监听端口与server{}虚拟主机间内存关系"></a>监听端口与server{}虚拟主机间内存关系</h4><p>对于一个如下的配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> A;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">127</span>.<span class="number">0</span>,<span class="number">0</span>.<span class="number">1</span>:<span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">location</span> /L1 &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> B;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">173.39.160.51:8000</span>;</span><br><span class="line">    <span class="attribute">location</span> /L1&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://imgtu.com/i/fGIoYn" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/08/10/fGIoYn.png" alt="fGIoYn.png"></a></p>
<h4 id="set方法"><a href="#set方法" class="headerlink" title="set方法"></a>set方法</h4><h5 id="ngx-http-core-listen"><a href="#ngx-http-core-listen" class="headerlink" title="ngx_http_core_listen"></a>ngx_http_core_listen</h5><p>其中对应的ngx_http_core_listen方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line">static char *</span><br><span class="line">ngx_http_core_listen(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)</span><br><span class="line">&#123;</span><br><span class="line">    // server层级下的ngx_http_core_srv_conf_t</span><br><span class="line">    ngx_http_core_srv_conf_t *cscf = conf;</span><br><span class="line"></span><br><span class="line">    ngx_str_t              *value, size;</span><br><span class="line">    ngx_url_t               u;</span><br><span class="line">    ngx_uint_t              n;</span><br><span class="line">    ngx_http_listen_opt_t   lsopt;</span><br><span class="line"></span><br><span class="line">    cscf-&gt;listen = 1;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;u, sizeof(ngx_url_t));</span><br><span class="line">    // 对listen后的字符串进行解析，标识为监听，并设置默认端口</span><br><span class="line">    u.url = value[1];</span><br><span class="line">    u.listen = 1;</span><br><span class="line">    u.default_port = 80;</span><br><span class="line">    // 解析参数，解析完成后，u的addrs就存储这ip+port的地址对</span><br><span class="line">    if (ngx_parse_url(cf-&gt;pool, &amp;u) != NGX_OK) &#123;</span><br><span class="line">        if (u.err) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;%s in \&quot;%V\&quot; of the \&quot;listen\&quot; directive&quot;,</span><br><span class="line">                               u.err, &amp;u.url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析其余参数，先分配存储结构，并设置默认值</span><br><span class="line">    ngx_memzero(&amp;lsopt, sizeof(ngx_http_listen_opt_t));</span><br><span class="line"></span><br><span class="line">    lsopt.backlog = NGX_LISTEN_BACKLOG;</span><br><span class="line">    lsopt.rcvbuf = -1;</span><br><span class="line">    lsopt.sndbuf = -1;</span><br><span class="line">#if (NGX_HAVE_SETFIB)</span><br><span class="line">    lsopt.setfib = -1;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_TCP_FASTOPEN)</span><br><span class="line">    lsopt.fastopen = -1;</span><br><span class="line">#endif</span><br><span class="line">#if (NGX_HAVE_INET6)</span><br><span class="line">    lsopt.ipv6only = 1;</span><br><span class="line">#endif</span><br><span class="line">    // 从第二个参数开始进行解析</span><br><span class="line">    for (n = 2; n &lt; cf-&gt;args-&gt;nelts; n++) &#123;</span><br><span class="line">        // 设置了default_server，则将default_server置1</span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;default_server&quot;) == 0</span><br><span class="line">            || ngx_strcmp(value[n].data, &quot;default&quot;) == 0)</span><br><span class="line">        &#123;</span><br><span class="line">            lsopt.default_server = 1;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;bind&quot;) == 0) &#123;</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_SETFIB)</span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;setfib=&quot;, 7) == 0) &#123;</span><br><span class="line">            lsopt.setfib = ngx_atoi(value[n].data + 7, value[n].len - 7);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.setfib == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid setfib \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_TCP_FASTOPEN)</span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;fastopen=&quot;, 9) == 0) &#123;</span><br><span class="line">            lsopt.fastopen = ngx_atoi(value[n].data + 9, value[n].len - 9);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.fastopen == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid fastopen \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;backlog=&quot;, 8) == 0) &#123;</span><br><span class="line">            lsopt.backlog = ngx_atoi(value[n].data + 8, value[n].len - 8);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.backlog == NGX_ERROR || lsopt.backlog == 0) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid backlog \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;rcvbuf=&quot;, 7) == 0) &#123;</span><br><span class="line">            size.len = value[n].len - 7;</span><br><span class="line">            size.data = value[n].data + 7;</span><br><span class="line"></span><br><span class="line">            lsopt.rcvbuf = ngx_parse_size(&amp;size);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.rcvbuf == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid rcvbuf \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;sndbuf=&quot;, 7) == 0) &#123;</span><br><span class="line">            size.len = value[n].len - 7;</span><br><span class="line">            size.data = value[n].data + 7;</span><br><span class="line"></span><br><span class="line">            lsopt.sndbuf = ngx_parse_size(&amp;size);</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            if (lsopt.sndbuf == NGX_ERROR) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid sndbuf \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;accept_filter=&quot;, 14) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span><br><span class="line">            lsopt.accept_filter = (char *) &amp;value[n].data[14];</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;accept filters \&quot;%V\&quot; are not supported &quot;</span><br><span class="line">                               &quot;on this platform, ignored&quot;,</span><br><span class="line">                               &amp;value[n]);</span><br><span class="line">#endif</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;deferred&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span><br><span class="line">            lsopt.deferred_accept = 1;</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;the deferred accept is not supported &quot;</span><br><span class="line">                               &quot;on this platform, ignored&quot;);</span><br><span class="line">#endif</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;ipv6only=o&quot;, 10) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_INET6 &amp;&amp; defined IPV6_V6ONLY)</span><br><span class="line">            if (ngx_strcmp(&amp;value[n].data[10], &quot;n&quot;) == 0) &#123;</span><br><span class="line">                lsopt.ipv6only = 1;</span><br><span class="line"></span><br><span class="line">            &#125; else if (ngx_strcmp(&amp;value[n].data[10], &quot;ff&quot;) == 0) &#123;</span><br><span class="line">                lsopt.ipv6only = 0;</span><br><span class="line"></span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;invalid ipv6only flags \&quot;%s\&quot;&quot;,</span><br><span class="line">                                   &amp;value[n].data[9]);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;ipv6only is not supported &quot;</span><br><span class="line">                               &quot;on this platform&quot;);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;reuseport&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HAVE_REUSEPORT)</span><br><span class="line">            lsopt.reuseport = 1;</span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;reuseport is not supported &quot;</span><br><span class="line">                               &quot;on this platform, ignored&quot;);</span><br><span class="line">#endif</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;ssl&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HTTP_SSL)</span><br><span class="line">            lsopt.ssl = 1;</span><br><span class="line">            continue;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;the \&quot;ssl\&quot; parameter requires &quot;</span><br><span class="line">                               &quot;ngx_http_ssl_module&quot;);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;http2&quot;) == 0) &#123;</span><br><span class="line">#if (NGX_HTTP_V2)</span><br><span class="line">            lsopt.http2 = 1;</span><br><span class="line">            continue;</span><br><span class="line">#else</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;the \&quot;http2\&quot; parameter requires &quot;</span><br><span class="line">                               &quot;ngx_http_v2_module&quot;);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;spdy&quot;) == 0) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_WARN, cf, 0,</span><br><span class="line">                               &quot;invalid parameter \&quot;spdy\&quot;: &quot;</span><br><span class="line">                               &quot;ngx_http_spdy_module was superseded &quot;</span><br><span class="line">                               &quot;by ngx_http_v2_module&quot;);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strncmp(value[n].data, &quot;so_keepalive=&quot;, 13) == 0) &#123;</span><br><span class="line"></span><br><span class="line">            if (ngx_strcmp(&amp;value[n].data[13], &quot;on&quot;) == 0) &#123;</span><br><span class="line">                lsopt.so_keepalive = 1;</span><br><span class="line"></span><br><span class="line">            &#125; else if (ngx_strcmp(&amp;value[n].data[13], &quot;off&quot;) == 0) &#123;</span><br><span class="line">                lsopt.so_keepalive = 2;</span><br><span class="line"></span><br><span class="line">            &#125; else &#123;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_KEEPALIVE_TUNABLE)</span><br><span class="line">                u_char     *p, *end;</span><br><span class="line">                ngx_str_t   s;</span><br><span class="line"></span><br><span class="line">                end = value[n].data + value[n].len;</span><br><span class="line">                s.data = value[n].data + 13;</span><br><span class="line"></span><br><span class="line">                p = ngx_strlchr(s.data, end, &apos;:&apos;);</span><br><span class="line">                if (p == NULL) &#123;</span><br><span class="line">                    p = end;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (p &gt; s.data) &#123;</span><br><span class="line">                    s.len = p - s.data;</span><br><span class="line"></span><br><span class="line">                    lsopt.tcp_keepidle = ngx_parse_time(&amp;s, 1);</span><br><span class="line">                    if (lsopt.tcp_keepidle == (time_t) NGX_ERROR) &#123;</span><br><span class="line">                        goto invalid_so_keepalive;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                s.data = (p &lt; end) ? (p + 1) : end;</span><br><span class="line"></span><br><span class="line">                p = ngx_strlchr(s.data, end, &apos;:&apos;);</span><br><span class="line">                if (p == NULL) &#123;</span><br><span class="line">                    p = end;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (p &gt; s.data) &#123;</span><br><span class="line">                    s.len = p - s.data;</span><br><span class="line"></span><br><span class="line">                    lsopt.tcp_keepintvl = ngx_parse_time(&amp;s, 1);</span><br><span class="line">                    if (lsopt.tcp_keepintvl == (time_t) NGX_ERROR) &#123;</span><br><span class="line">                        goto invalid_so_keepalive;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                s.data = (p &lt; end) ? (p + 1) : end;</span><br><span class="line"></span><br><span class="line">                if (s.data &lt; end) &#123;</span><br><span class="line">                    s.len = end - s.data;</span><br><span class="line"></span><br><span class="line">                    lsopt.tcp_keepcnt = ngx_atoi(s.data, s.len);</span><br><span class="line">                    if (lsopt.tcp_keepcnt == NGX_ERROR) &#123;</span><br><span class="line">                        goto invalid_so_keepalive;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (lsopt.tcp_keepidle == 0 &amp;&amp; lsopt.tcp_keepintvl == 0</span><br><span class="line">                    &amp;&amp; lsopt.tcp_keepcnt == 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    goto invalid_so_keepalive;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                lsopt.so_keepalive = 1;</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                   &quot;the \&quot;so_keepalive\&quot; parameter accepts &quot;</span><br><span class="line">                                   &quot;only \&quot;on\&quot; or \&quot;off\&quot; on this platform&quot;);</span><br><span class="line">                return NGX_CONF_ERROR;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lsopt.set = 1;</span><br><span class="line">            lsopt.bind = 1;</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line"></span><br><span class="line">#if (NGX_HAVE_KEEPALIVE_TUNABLE)</span><br><span class="line">        invalid_so_keepalive:</span><br><span class="line"></span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;invalid so_keepalive value: \&quot;%s\&quot;&quot;,</span><br><span class="line">                               &amp;value[n].data[13]);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strcmp(value[n].data, &quot;proxy_protocol&quot;) == 0) &#123;</span><br><span class="line">            lsopt.proxy_protocol = 1;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                           &quot;invalid parameter \&quot;%V\&quot;&quot;, &amp;value[n]);</span><br><span class="line">        return NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 对每一个解析出的地址，和配置的属性，使用ngx_http_add_listen方法添加ip+port形式的地址到main层级的ngx_http_core_main_conf_t的ports中</span><br><span class="line">    for (n = 0; n &lt; u.naddrs; n++) &#123;</span><br><span class="line">        lsopt.sockaddr = u.addrs[n].sockaddr;</span><br><span class="line">        lsopt.socklen = u.addrs[n].socklen;</span><br><span class="line">        lsopt.addr_text = u.addrs[n].name;</span><br><span class="line">        lsopt.wildcard = ngx_inet_wildcard(lsopt.sockaddr);</span><br><span class="line"></span><br><span class="line">        if (ngx_http_add_listen(cf, cscf, &amp;lsopt) != NGX_OK) &#123;</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要着重介绍一下bind标志位。bind表示是否一个ip+port的地址进行绑定。这样的目的是，如果在一个在同样的端口上，存在一个通配符形式地址（即任意ip地址）时。对于bind的地址来说，会先开启一个地址的监听，让bind的端口走单独的监听，其他未绑定的地址走通配符监听。这样主要是因为我们可能希望在该bind的地址上设置一些额外信息，如backlog、rcvbuf、sndbuf等内容。因此在设置这些额外参数时，就会默认将该地址设置为bind。当然也可以通过配置中直接设置bind的方式指明需要单独进行监听。</p>
<h5 id="解析url"><a href="#解析url" class="headerlink" title="解析url"></a>解析url</h5><h6 id="ngx-parse-url"><a href="#ngx-parse-url" class="headerlink" title="ngx_parse_url"></a>ngx_parse_url</h6><p>解析参数的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ngx_int_t</span><br><span class="line">ngx_parse_url(ngx_pool_t *pool, ngx_url_t *u)</span><br><span class="line">&#123;</span><br><span class="line">    u_char  *p;</span><br><span class="line">    size_t   len;</span><br><span class="line"></span><br><span class="line">    p = u-&gt;url.data;</span><br><span class="line">    len = u-&gt;url.len;</span><br><span class="line"></span><br><span class="line">    if (len &gt;= 5 &amp;&amp; ngx_strncasecmp(p, (u_char *) &quot;unix:&quot;, 5) == 0) &#123;</span><br><span class="line">        return ngx_parse_unix_domain_url(pool, u);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (len &amp;&amp; p[0] == &apos;[&apos;) &#123;</span><br><span class="line">        return ngx_parse_inet6_url(pool, u);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ngx_parse_inet_url(pool, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用的是ngx_parse_inet_url函数。具体逻辑如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">static ngx_int_t</span><br><span class="line">ngx_parse_inet_url(ngx_pool_t *pool, ngx_url_t *u)</span><br><span class="line">&#123;</span><br><span class="line">    u_char              *host, *port, *last, *uri, *args, *dash;</span><br><span class="line">    size_t               len;</span><br><span class="line">    ngx_int_t            n;</span><br><span class="line">    struct sockaddr_in  *sin;</span><br><span class="line">    // 分配套接字地址</span><br><span class="line">    u-&gt;socklen = sizeof(struct sockaddr_in);</span><br><span class="line">    sin = (struct sockaddr_in *) &amp;u-&gt;sockaddr;</span><br><span class="line">    // 设置套接字族</span><br><span class="line">    sin-&gt;sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">    u-&gt;family = AF_INET;</span><br><span class="line"></span><br><span class="line">    host = u-&gt;url.data;</span><br><span class="line"></span><br><span class="line">    last = host + u-&gt;url.len;</span><br><span class="line">    // 查找设置的端口号起始地址。ngx_strlchr函数找到第一个指定的字符，并返回对应的指针。这里查找到:8000这种端口号</span><br><span class="line">    port = ngx_strlchr(host, last, &apos;:&apos;);</span><br><span class="line">    // 查找到uri起始地址</span><br><span class="line">    uri = ngx_strlchr(host, last, &apos;/&apos;);</span><br><span class="line">    // 查找参数的起始地址</span><br><span class="line">    args = ngx_strlchr(host, last, &apos;?&apos;);</span><br><span class="line">    // 如果存在参数，并且uri为空，或者参数的起始地址小于uri的起始地址，则将uri设置为参数的起始地址</span><br><span class="line">    if (args) &#123;</span><br><span class="line">        if (uri == NULL || args &lt; uri) &#123;</span><br><span class="line">            uri = args;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 存在uri</span><br><span class="line">    if (uri) &#123;</span><br><span class="line">        // 如果是在解析监听，则报错返回</span><br><span class="line">        if (u-&gt;listen || !u-&gt;uri_part) &#123;</span><br><span class="line">            u-&gt;err = &quot;invalid host&quot;;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        // uri长度为从末尾到uri起始地址</span><br><span class="line">        u-&gt;uri.len = last - uri;</span><br><span class="line">        u-&gt;uri.data = uri;</span><br><span class="line">        // 将last变更为uri地址</span><br><span class="line">        last = uri;</span><br><span class="line">        // 如果uri起始地址小于端口号起始地址，则说明不存在端口号</span><br><span class="line">        if (uri &lt; port) &#123;</span><br><span class="line">            port = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果查找到:80形式的端口号</span><br><span class="line">    if (port) &#123;</span><br><span class="line">        // 获取端口号起始地址</span><br><span class="line">        port++;</span><br><span class="line">        // 获取端口号长度</span><br><span class="line">        len = last - port;</span><br><span class="line">        // 如果在解析监听</span><br><span class="line">        if (u-&gt;listen) &#123;</span><br><span class="line">            // 查找监听端口是否为一个范围，即:8000-8100形式</span><br><span class="line">            dash = ngx_strlchr(port, last, &apos;-&apos;);</span><br><span class="line">            // 如果是范围</span><br><span class="line">            if (dash) &#123;</span><br><span class="line">                dash++;</span><br><span class="line">                // 解析末尾端口</span><br><span class="line">                n = ngx_atoi(dash, last - dash);</span><br><span class="line"></span><br><span class="line">                if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">                    u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line">                    return NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                u-&gt;last_port = (in_port_t) n;</span><br><span class="line">                // 变更长度为起始端口长度</span><br><span class="line">                len = dash - port - 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取端口（如果是监听，则是起始端口）</span><br><span class="line">        n = ngx_atoi(port, len);</span><br><span class="line"></span><br><span class="line">        if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">            u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        // 如果范围不合法，报错</span><br><span class="line">        if (u-&gt;last_port &amp;&amp; n &gt; u-&gt;last_port) &#123;</span><br><span class="line">            u-&gt;err = &quot;invalid port range&quot;;</span><br><span class="line">            return NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        // 设置端口为n</span><br><span class="line">        u-&gt;port = (in_port_t) n;</span><br><span class="line">        sin-&gt;sin_port = htons((in_port_t) n);</span><br><span class="line">        // 设置端口对应的文本</span><br><span class="line">        u-&gt;port_text.len = last - port;</span><br><span class="line">        u-&gt;port_text.data = port;</span><br><span class="line"></span><br><span class="line">        last = port - 1;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //未解析到:8000形式端口</span><br><span class="line">        // 如果uri为空</span><br><span class="line">        if (uri == NULL) &#123;</span><br><span class="line">            // 如果是在解析监听</span><br><span class="line">            if (u-&gt;listen) &#123;</span><br><span class="line"></span><br><span class="line">                /* test value as port only */</span><br><span class="line">                // 认为整个文本全是端口，即listen 80；形式，并尝试解析</span><br><span class="line">                len = last - host;</span><br><span class="line">                // 查看是否为范围监听</span><br><span class="line">                dash = ngx_strlchr(host, last, &apos;-&apos;);</span><br><span class="line"></span><br><span class="line">                if (dash) &#123;</span><br><span class="line">                    dash++;</span><br><span class="line"></span><br><span class="line">                    n = ngx_atoi(dash, last - dash);</span><br><span class="line"></span><br><span class="line">                    if (n == NGX_ERROR) &#123;</span><br><span class="line">                        goto no_port;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">                        u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line"></span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        u-&gt;last_port = (in_port_t) n;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    len = dash - host - 1;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                n = ngx_atoi(host, len);</span><br><span class="line">                // 如果解析到端口</span><br><span class="line">                if (n != NGX_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">                    if (u-&gt;err) &#123;</span><br><span class="line">                        return NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (n &lt; 1 || n &gt; 65535) &#123;</span><br><span class="line">                        u-&gt;err = &quot;invalid port&quot;;</span><br><span class="line">                        return NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (u-&gt;last_port &amp;&amp; n &gt; u-&gt;last_port) &#123;</span><br><span class="line">                        u-&gt;err = &quot;invalid port range&quot;;</span><br><span class="line">                        return NGX_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    u-&gt;port = (in_port_t) n;</span><br><span class="line">                    sin-&gt;sin_port = htons((in_port_t) n);</span><br><span class="line">                    sin-&gt;sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">                    u-&gt;port_text.len = last - host;</span><br><span class="line">                    u-&gt;port_text.data = host;</span><br><span class="line">                    // 由于是listen未指定ip，因此机器所有ip均被监听，因此属于通配符形式监听</span><br><span class="line">                    u-&gt;wildcard = 1;</span><br><span class="line">                    // 添加监听端口到addrs中</span><br><span class="line">                    return ngx_inet_add_addr(pool, u, &amp;u-&gt;sockaddr.sockaddr,</span><br><span class="line">                                             u-&gt;socklen, 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">no_port:</span><br><span class="line">        // 未查找到端口号，即只有ip的情况，设置默认端口</span><br><span class="line">        u-&gt;err = NULL;</span><br><span class="line">        u-&gt;no_port = 1;</span><br><span class="line">        u-&gt;port = u-&gt;default_port;</span><br><span class="line">        sin-&gt;sin_port = htons(u-&gt;default_port);</span><br><span class="line">        u-&gt;last_port = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    // 只有主机名，或主机名+端口号形式的配置，才会执行如下处理</span><br><span class="line">    len = last - host;</span><br><span class="line">    // 如果没有主机，则报错</span><br><span class="line">    if (len == 0) &#123;</span><br><span class="line">        u-&gt;err = &quot;no host&quot;;</span><br><span class="line">        return NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;host.len = len;</span><br><span class="line">    u-&gt;host.data = host;</span><br><span class="line">    // 如果是解析监听，并且主机名是*，设置sin_addr.s_addr为INADDR_ANY，即监听所有ip，并设置wildcard为1</span><br><span class="line">    if (u-&gt;listen &amp;&amp; len == 1 &amp;&amp; *host == &apos;*&apos;) &#123;</span><br><span class="line">        sin-&gt;sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">        u-&gt;wildcard = 1;</span><br><span class="line">        return ngx_inet_add_addr(pool, u, &amp;u-&gt;sockaddr.sockaddr, u-&gt;socklen, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取主机ip，将127.0.0.1转换为int形式的地址</span><br><span class="line">    sin-&gt;sin_addr.s_addr = ngx_inet_addr(host, len);</span><br><span class="line">    // ip合法（如果主机名是域名，则返回就是INADDR_NONE）</span><br><span class="line">    if (sin-&gt;sin_addr.s_addr != INADDR_NONE) &#123;</span><br><span class="line">        // ip是INADDR_ANY，设置wildcard</span><br><span class="line">        if (sin-&gt;sin_addr.s_addr == INADDR_ANY) &#123;</span><br><span class="line">            u-&gt;wildcard = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // 添加地址到addrs</span><br><span class="line">        return ngx_inet_add_addr(pool, u, &amp;u-&gt;sockaddr.sockaddr, u-&gt;socklen, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果不解析主机名</span><br><span class="line">    if (u-&gt;no_resolve) &#123;</span><br><span class="line">        return NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    // 使用getaddrinfo函数解析域名，获取ip，并添加地址到u的addrs中</span><br><span class="line">    if (ngx_inet_resolve_host(pool, u) != NGX_OK) &#123;</span><br><span class="line">        return NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 根据域名解析出的地址，对u的相关参数进行赋值</span><br><span class="line">    u-&gt;family = u-&gt;addrs[0].sockaddr-&gt;sa_family;</span><br><span class="line">    u-&gt;socklen = u-&gt;addrs[0].socklen;</span><br><span class="line">    ngx_memcpy(&amp;u-&gt;sockaddr, u-&gt;addrs[0].sockaddr, u-&gt;addrs[0].socklen);</span><br><span class="line">    u-&gt;wildcard = ngx_inet_wildcard(&amp;u-&gt;sockaddr.sockaddr);</span><br><span class="line"></span><br><span class="line">    return NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-inet-add-addr"><a href="#ngx-inet-add-addr" class="headerlink" title="ngx_inet_add_addr"></a>ngx_inet_add_addr</h6><p>该方法用于将ngx_url_t解析出的地址添加到其addrs参数中。具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_inet_add_addr(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_url_t</span> *u, struct sockaddr *sockaddr,</span><br><span class="line">    <span class="keyword">socklen_t</span> socklen, <span class="keyword">ngx_uint_t</span> total)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *p;</span><br><span class="line">    <span class="keyword">size_t</span>            len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, nports;</span><br><span class="line">    <span class="keyword">ngx_addr_t</span>       *addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>  *<span class="title">sa</span>;</span></span><br><span class="line">    <span class="comment">// 如果是范围监听，则会有last_port</span></span><br><span class="line">    nports = u-&gt;last_port ? u-&gt;last_port - u-&gt;port + <span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 初始化addrs</span></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;addrs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        u-&gt;addrs = ngx_palloc(pool, total * nports * <span class="keyword">sizeof</span>(<span class="keyword">ngx_addr_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;addrs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对每一个监听端口进行处理</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nports; i++) &#123;</span><br><span class="line">        <span class="comment">// 初始化地址，并对地址中参数进行赋值</span></span><br><span class="line">        sa = ngx_pcalloc(pool, socklen);</span><br><span class="line">        <span class="keyword">if</span> (sa == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(sa, sockaddr, socklen);</span><br><span class="line"></span><br><span class="line">        ngx_inet_set_port(sa, u-&gt;port + i);</span><br><span class="line">        <span class="comment">// 根据不同协议族对地址赋值</span></span><br><span class="line">        <span class="keyword">switch</span> (sa-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            len = NGX_INET6_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">"[]:65536"</span>) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            len = NGX_INET_ADDRSTRLEN + <span class="keyword">sizeof</span>(<span class="string">":65535"</span>) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p = ngx_pnalloc(pool, len);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = ngx_sock_ntop(sa, socklen, p, len, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 添加地址到addrs中</span></span><br><span class="line">        addr = &amp;u-&gt;addrs[u-&gt;naddrs++];</span><br><span class="line"></span><br><span class="line">        addr-&gt;sockaddr = sa;</span><br><span class="line">        addr-&gt;socklen = socklen;</span><br><span class="line"></span><br><span class="line">        addr-&gt;name.len = len;</span><br><span class="line">        addr-&gt;name.data = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-inet-resolve-host"><a href="#ngx-inet-resolve-host" class="headerlink" title="ngx_inet_resolve_host"></a>ngx_inet_resolve_host</h6><p>该方法将域名解析为ip地址。使用的方法为getaddrinfo函数。具体可以参考<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E5%9C%B0%E5%9D%80%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener">地址查询</a></p>
<p>代码逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_inet_resolve_host(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_url_t</span> *u)</span><br><span class="line">&#123;</span><br><span class="line">    u_char           *host;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        n;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span>   <span class="title">hints</span>, *<span class="title">res</span>, *<span class="title">rp</span>;</span></span><br><span class="line"></span><br><span class="line">    host = ngx_alloc(u-&gt;host.len + <span class="number">1</span>, pool-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (host == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) ngx_cpystrn(host, u-&gt;host.data, u-&gt;host.len + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// hint来选择符合特定条件的地址</span></span><br><span class="line">    ngx_memzero(&amp;hints, <span class="keyword">sizeof</span>(struct addrinfo));</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> AI_ADDRCONFIG</span></span><br><span class="line">    hints.ai_flags = AI_ADDRCONFIG;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getaddrinfo((<span class="keyword">char</span> *) host, <span class="literal">NULL</span>, &amp;hints, &amp;res) != <span class="number">0</span>) &#123;</span><br><span class="line">        u-&gt;err = <span class="string">"host not found"</span>;</span><br><span class="line">        ngx_free(host);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_free(host);</span><br><span class="line">    <span class="comment">// 遍历获取到的每一个地址，查找ipv4或ipv6的地址数量</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>, rp = res; rp != <span class="literal">NULL</span>; rp = rp-&gt;ai_next) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (rp-&gt;ai_family) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AF_INET:</span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        u-&gt;err = <span class="string">"host not found"</span>;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* MP: ngx_shared_palloc() */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (rp = res; rp != <span class="literal">NULL</span>; rp = rp-&gt;ai_next) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (rp-&gt;ai_family) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AF_INET:</span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将每一个ipv4或ipv6地址都添加到addrs中</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_inet_add_addr(pool, u, rp-&gt;ai_addr, rp-&gt;ai_addrlen, n)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里配置的主机可以任意配置，在设置监听时，如果解析出的ip地址不是机器表示的ip，则报错。</p>
<h5 id="添加监听地址到ports中"><a href="#添加监听地址到ports中" class="headerlink" title="添加监听地址到ports中"></a>添加监听地址到ports中</h5><h6 id="ngx-http-add-listen"><a href="#ngx-http-add-listen" class="headerlink" title="ngx_http_add_listen"></a>ngx_http_add_listen</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_listen(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_listen_opt_t</span> *lsopt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">in_port_t</span>                   p;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>            *<span class="title">sa</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span>       *port;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取main级别下的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 创建ports空间</span></span><br><span class="line">    <span class="keyword">if</span> (cmcf-&gt;ports == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        cmcf-&gt;ports = ngx_array_create(cf-&gt;temp_pool, <span class="number">2</span>,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_port_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (cmcf-&gt;ports == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa = lsopt-&gt;sockaddr;</span><br><span class="line">    p = ngx_inet_get_port(sa);</span><br><span class="line">    <span class="comment">// 遍历每个port，查找是当前端口已存在</span></span><br><span class="line">    port = cmcf-&gt;ports-&gt;elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;ports-&gt;nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p != port[i].port || sa-&gt;sa_family != port[i].family) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a port is already in the port list */</span></span><br><span class="line">        <span class="comment">// 对于已存在的端口，执行如下函数来添加对应的addr</span></span><br><span class="line">        <span class="keyword">return</span> ngx_http_add_addresses(cf, cscf, &amp;port[i], lsopt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add a port to the port list */</span></span><br><span class="line">   <span class="comment">// 添加当前端口到ports中</span></span><br><span class="line">    port = ngx_array_push(cmcf-&gt;ports);</span><br><span class="line">    <span class="keyword">if</span> (port == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    port-&gt;family = sa-&gt;sa_family;</span><br><span class="line">    port-&gt;port = p;</span><br><span class="line">    port-&gt;addrs.elts = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 添加对应的addr</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_add_address(cf, cscf, port, lsopt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-address"><a href="#ngx-http-add-address" class="headerlink" title="ngx_http_add_address"></a>ngx_http_add_address</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_address(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span> *port, <span class="keyword">ngx_http_listen_opt_t</span> *lsopt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>  *addr;</span><br><span class="line">    <span class="comment">// 分配空间</span></span><br><span class="line">    <span class="keyword">if</span> (port-&gt;addrs.elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;port-&gt;addrs, cf-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_addr_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2 &amp;&amp; NGX_HTTP_SSL                                              \</span></span><br><span class="line">     &amp;&amp; !defined TLSEXT_TYPE_application_layer_protocol_negotiation           \</span><br><span class="line">     &amp;&amp; !defined TLSEXT_TYPE_next_proto_neg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lsopt-&gt;http2 &amp;&amp; lsopt-&gt;ssl) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_WARN, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"nginx was built with OpenSSL that lacks ALPN "</span></span><br><span class="line">                           <span class="string">"and NPN support, HTTP/2 is not enabled for %V"</span>,</span><br><span class="line">                           &amp;lsopt-&gt;addr_text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 添加addr</span></span><br><span class="line">    addr = ngx_array_push(&amp;port-&gt;addrs);</span><br><span class="line">    <span class="keyword">if</span> (addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置对应成员</span></span><br><span class="line">    addr-&gt;opt = *lsopt;</span><br><span class="line">    addr-&gt;hash.buckets = <span class="literal">NULL</span>;</span><br><span class="line">    addr-&gt;hash.size = <span class="number">0</span>;</span><br><span class="line">    addr-&gt;wc_head = <span class="literal">NULL</span>;</span><br><span class="line">    addr-&gt;wc_tail = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    addr-&gt;nregex = <span class="number">0</span>;</span><br><span class="line">    addr-&gt;regex = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    addr-&gt;default_server = cscf;</span><br><span class="line">    addr-&gt;servers.elts = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 绑定对应的server模块</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_add_server(cf, cscf, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="gx-http-add-server"><a href="#gx-http-add-server" class="headerlink" title="gx_http_add_server"></a>gx_http_add_server</h6><p>绑定ip+port形式的地址到对应的server块中。逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_server(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  **server;</span><br><span class="line">    <span class="comment">// 分配server空间</span></span><br><span class="line">    <span class="keyword">if</span> (addr-&gt;servers.elts == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;addr-&gt;servers, cf-&gt;temp_pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_core_srv_conf_t</span> *))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 查找当前地址中是否已经存在对该server服务的绑定关系，如果存在，则报错</span></span><br><span class="line">        server = addr-&gt;servers.elts;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; addr-&gt;servers.nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server[i] == cscf) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"a duplicate listen %V"</span>,</span><br><span class="line">                                   &amp;addr-&gt;opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在servers中添加对应的server配置块</span></span><br><span class="line">    server = ngx_array_push(&amp;addr-&gt;servers);</span><br><span class="line">    <span class="keyword">if</span> (server == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *server = cscf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-addresses"><a href="#ngx-http-add-addresses" class="headerlink" title="ngx_http_add_addresses"></a>ngx_http_add_addresses</h6><p>当监听端口（port形式的地址）已经存在一个ngx_http_conf_port_t结构时，这时添加一个addr（ip+port形式的地址）需要使用该方法。该方法会先对比是否已存在对应的ip+port形式的地址，再进行相应操作。具体逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_addresses(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span> *port, <span class="keyword">ngx_http_listen_opt_t</span> *lsopt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             i, default_server, proxy_protocol;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>  *addr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * we cannot compare whole sockaddr struct's as kernel</span></span><br><span class="line"><span class="comment">     * may fill some fields in inherited sockaddr struct's</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    addr = port-&gt;addrs.elts;</span><br><span class="line">    <span class="comment">// 遍历addrs，查找是否已存在与当前ip+port对应的地址相同的地址</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; port-&gt;addrs.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_cmp_sockaddr(lsopt-&gt;sockaddr, lsopt-&gt;socklen,</span><br><span class="line">                             addr[i].opt.sockaddr,</span><br><span class="line">                             addr[i].opt.socklen, <span class="number">0</span>)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the address is already in the address list */</span></span><br><span class="line">        <span class="comment">// 当前地址已存在时进行如下处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在该地址中的server中增加对应的server服务</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_add_server(cf, cscf, &amp;addr[i]) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* preserve default_server bit during listen options overwriting */</span></span><br><span class="line">        <span class="comment">// 记录当前的opt是否设置了默认的服务</span></span><br><span class="line">        default_server = addr[i].opt.default_server;</span><br><span class="line"></span><br><span class="line">        proxy_protocol = lsopt-&gt;proxy_protocol || addr[i].opt.proxy_protocol;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        ssl = lsopt-&gt;ssl || addr[i].opt.ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">        http2 = lsopt-&gt;http2 || addr[i].opt.http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果当前地址进行了额外参数的设置，如rcvbuf=size | sndbuf=size，不包括default_server</span></span><br><span class="line">        <span class="keyword">if</span> (lsopt-&gt;<span class="built_in">set</span>) &#123;</span><br><span class="line">            <span class="comment">// 当前的opt也设置进行了相应的设置，这时会报错，因为使用opt中相应的参数对监听进行设置，但同一个ip+port组成的地址只能进行一次设置，这时所有服务对该地址进行监听时（如果有其他服务），则使用同样的设置。</span></span><br><span class="line">            <span class="keyword">if</span> (addr[i].opt.<span class="built_in">set</span>) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"duplicate listen options for %V"</span>,</span><br><span class="line">                                   &amp;addr[i].opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置地址的opt，对应于进行了额外设置的opt</span></span><br><span class="line">            addr[i].opt = *lsopt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check the duplicate "default" server for this address:port */</span></span><br><span class="line">        <span class="comment">// 如果当前解析出的listen设置为了默认的server服务</span></span><br><span class="line">        <span class="keyword">if</span> (lsopt-&gt;default_server) &#123;</span><br><span class="line">            <span class="comment">// 之前已经设置了默认的server服务，则报错</span></span><br><span class="line">            <span class="keyword">if</span> (default_server) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"a duplicate default server for %V"</span>,</span><br><span class="line">                                   &amp;addr[i].opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 标识已经设置了默认的服务</span></span><br><span class="line">            default_server = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 地址中default_server执行当前的server块</span></span><br><span class="line">            addr[i].default_server = cscf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录是否已经设置了默认的服务块</span></span><br><span class="line">        addr[i].opt.default_server = default_server;</span><br><span class="line">        addr[i].opt.proxy_protocol = proxy_protocol;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        addr[i].opt.ssl = ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">        addr[i].opt.http2 = http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add the address to the addresses list that bound to this port */</span></span><br><span class="line">    <span class="comment">// 未找到相同的地址，则在port中增加一个ip+port形式的地址</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_add_address(cf, cscf, port, lsopt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="server-name处理"><a href="#server-name处理" class="headerlink" title="server_name处理"></a>server_name处理</h4><p>快速查找请求对应的server块和server_name密切相关，这里先来看一下配置中server_name相应的处理。注意一个server块支持多个server_name，且server_name支持精确名，通配符和正则表达式。在未设置时，默认为空。</p>
<h5 id="相关数据结构"><a href="#相关数据结构" class="headerlink" title="相关数据结构"></a>相关数据结构</h5><h6 id="ngx-http-server-name-t"><a href="#ngx-http-server-name-t" class="headerlink" title="ngx_http_server_name_t"></a>ngx_http_server_name_t</h6><p>ngx_http_server_name_t结构用户存储服务名，并构建服务名到server的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">    ngx_http_regex_t          *regex;</span><br><span class="line">#endif</span><br><span class="line">    ngx_http_core_srv_conf_t  *server;   /* virtual name server conf */</span><br><span class="line">    ngx_str_t                  name;</span><br><span class="line">&#125; ngx_http_server_name_t;</span><br></pre></td></tr></table></figure>
<h5 id="处理逻辑"><a href="#处理逻辑" class="headerlink" title="处理逻辑"></a>处理逻辑</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;server_name&quot;),</span><br><span class="line">  NGX_HTTP_SRV_CONF|NGX_CONF_1MORE,</span><br><span class="line">  ngx_http_core_server_name,</span><br><span class="line">  NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">  0,</span><br><span class="line">  NULL &#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">static char *</span><br><span class="line">ngx_http_core_server_name(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)</span><br><span class="line">&#123;</span><br><span class="line">    // 获取server层级下的ngx_http_core_srv_conf_t</span><br><span class="line">    ngx_http_core_srv_conf_t *cscf = conf;</span><br><span class="line"></span><br><span class="line">    u_char                   ch;</span><br><span class="line">    ngx_str_t               *value;</span><br><span class="line">    ngx_uint_t               i;</span><br><span class="line">    ngx_http_server_name_t  *sn;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    // 对于每一个server_name进行处理。</span><br><span class="line">    for (i = 1; i &lt; cf-&gt;args-&gt;nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        ch = value[i].data[0];</span><br><span class="line">        // 检验配置语法准确性</span><br><span class="line">        if ((ch == &apos;*&apos; &amp;&amp; (value[i].len &lt; 3 || value[i].data[1] != &apos;.&apos;))</span><br><span class="line">            || (ch == &apos;.&apos; &amp;&amp; value[i].len &lt; 2))</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;server name \&quot;%V\&quot; is invalid&quot;, &amp;value[i]);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ngx_strchr(value[i].data, &apos;/&apos;)) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_WARN, cf, 0,</span><br><span class="line">                               &quot;server name \&quot;%V\&quot; has suspicious symbols&quot;,</span><br><span class="line">                               &amp;value[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        // 在ngx_http_core_srv_conf_t的server_names中增加元素</span><br><span class="line">        sn = ngx_array_push(&amp;cscf-&gt;server_names);</span><br><span class="line">        if (sn == NULL) &#123;</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">        sn-&gt;regex = NULL;</span><br><span class="line">#endif</span><br><span class="line">        sn-&gt;server = cscf;</span><br><span class="line">        // 对于服务名是hostname来说，使用之前获取到的hostname</span><br><span class="line">        if (ngx_strcasecmp(value[i].data, (u_char *) &quot;$hostname&quot;) == 0) &#123;</span><br><span class="line">            sn-&gt;name = cf-&gt;cycle-&gt;hostname;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sn-&gt;name = value[i];</span><br><span class="line">        &#125;</span><br><span class="line">        // 对应首字母为~的表达式来说，是使用正则匹配</span><br><span class="line">        if (value[i].data[0] != &apos;~&apos;) &#123;</span><br><span class="line">            ngx_strlow(sn-&gt;name.data, sn-&gt;name.data, sn-&gt;name.len);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_PCRE)</span><br><span class="line">        &#123;</span><br><span class="line">        //构建正则匹配</span><br><span class="line">        u_char               *p;</span><br><span class="line">        ngx_regex_compile_t   rc;</span><br><span class="line">        u_char                errstr[NGX_MAX_CONF_ERRSTR];</span><br><span class="line"></span><br><span class="line">        if (value[i].len == 1) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                               &quot;empty regex in server name \&quot;%V\&quot;&quot;, &amp;value[i]);</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        value[i].len--;</span><br><span class="line">        value[i].data++;</span><br><span class="line"></span><br><span class="line">        ngx_memzero(&amp;rc, sizeof(ngx_regex_compile_t));</span><br><span class="line"></span><br><span class="line">        rc.pattern = value[i];</span><br><span class="line">        rc.err.len = NGX_MAX_CONF_ERRSTR;</span><br><span class="line">        rc.err.data = errstr;</span><br><span class="line"></span><br><span class="line">        for (p = value[i].data; p &lt; value[i].data + value[i].len; p++) &#123;</span><br><span class="line">            if (*p &gt;= &apos;A&apos; &amp;&amp; *p &lt;= &apos;Z&apos;) &#123;</span><br><span class="line">                rc.options = NGX_REGEX_CASELESS;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sn-&gt;regex = ngx_http_regex_compile(cf, &amp;rc);</span><br><span class="line">        if (sn-&gt;regex == NULL) &#123;</span><br><span class="line">            return NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sn-&gt;name = value[i];</span><br><span class="line">        cscf-&gt;captures = (rc.captures &gt; 0);</span><br><span class="line">        &#125;</span><br><span class="line">#else</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                           &quot;using regex \&quot;%V\&quot; &quot;</span><br><span class="line">                           &quot;requires PCRE library&quot;, &amp;value[i]);</span><br><span class="line"></span><br><span class="line">        return NGX_CONF_ERROR;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，对应某个模块的serve_name未明确配置来说，其对应的ngx_http_core_srv_conf_t的server_names中将为空。</p>
<h4 id="server块的快速查找"><a href="#server块的快速查找" class="headerlink" title="server块的快速查找"></a>server块的快速查找</h4><h5 id="相关数据结构-1"><a href="#相关数据结构-1" class="headerlink" title="相关数据结构"></a>相关数据结构</h5><p>相关数据结构可以先不看，先看处理函数，当遇到对应结构时再查看。</p>
<h6 id="ngx-http-port-t"><a href="#ngx-http-port-t" class="headerlink" title="ngx_http_port_t"></a>ngx_http_port_t</h6><p>每个监听地址实际对应的地址数量和具体每个地址信息。由于含有通配符的地址，可能只需要进行一个建库，但对应多个地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    /* ngx_http_in_addr_t or ngx_http_in6_addr_t */</span><br><span class="line">    void                      *addrs; // 每个地址的详细信息，按协议区分</span><br><span class="line">    ngx_uint_t                 naddrs; // 地址数据</span><br><span class="line">&#125; ngx_http_port_t;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-listening-t"><a href="#ngx-listening-t" class="headerlink" title="ngx_listening_t"></a>ngx_listening_t</h6><p>前文已介绍过。</p>
<h6 id="ngx-http-in-addr-t"><a href="#ngx-http-in-addr-t" class="headerlink" title="ngx_http_in_addr_t"></a>ngx_http_in_addr_t</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    in_addr_t                  addr; // ipv4地址</span><br><span class="line">    ngx_http_addr_conf_t       conf; // 监听地址对应的详细信息</span><br><span class="line">&#125; ngx_http_in_addr_t;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-addr-conf-s"><a href="#ngx-http-addr-conf-s" class="headerlink" title="ngx_http_addr_conf_s"></a>ngx_http_addr_conf_s</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_http_addr_conf_s &#123;</span><br><span class="line">    /* the default server configuration for this address:port */</span><br><span class="line">    ngx_http_core_srv_conf_t  *default_server; // 监听地址对应的默认server</span><br><span class="line"></span><br><span class="line">    ngx_http_virtual_names_t  *virtual_names; // 监听地址对于的server集合</span><br><span class="line"></span><br><span class="line">    unsigned                   ssl:1;</span><br><span class="line">    unsigned                   http2:1;</span><br><span class="line">    unsigned                   proxy_protocol:1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-virtual-names-t"><a href="#ngx-http-virtual-names-t" class="headerlink" title="ngx_http_virtual_names_t"></a>ngx_http_virtual_names_t</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ngx_hash_combined_t        names; // 存在server信息的hash结构，包含精准，前置通配符，后置通配符</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                 nregex; // 正则表达式server name数量</span><br><span class="line">    ngx_http_server_name_t    *regex; // 每一个正则表达式server name</span><br><span class="line">&#125; ngx_http_virtual_names_t;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-optimize-servers"><a href="#ngx-http-optimize-servers" class="headerlink" title="ngx_http_optimize_servers"></a>ngx_http_optimize_servers</h5><p>经过上述的set方法，已经构建了从main级别的ngx_http_core_main_conf_t成员ports（ngx_http_conf_port_t，port形式的地址）数组、到addrs（ngx_http_conf_addr_t，ip+port形式的地址）、再到servers（ngx_http_core_srv_conf_t，每一个虚拟server）数组的关系。但每次查找时，使用ip+port的地址，再查找对应的server是相对复杂的，如果有大量的server块，并且监听的是同一个ip+port形式的地址。这时逐个进行server_name和请求的host匹配是过于缓慢的。为了加速查找，这里在ip+port形式的地址中，增加了hash表。已加速查找。具体hash表的构建在http层set函数ngx_http_block的ngx_http_optimize_servers方法中。其逻辑如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* optimize the lists of ports, addresses and server names */</span><br><span class="line"></span><br><span class="line">if (ngx_http_optimize_servers(cf, cmcf, cmcf-&gt;ports) != NGX_OK) &#123;</span><br><span class="line">    return NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_optimize_servers(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf,</span><br><span class="line">    <span class="keyword">ngx_array_t</span> *ports)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>             p, a;</span><br><span class="line">    <span class="keyword">ngx_http_conf_port_t</span>  *port;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>  *addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ports == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每一个port地址下的ip+port地址</span></span><br><span class="line">    port = ports-&gt;elts;</span><br><span class="line">    <span class="keyword">for</span> (p = <span class="number">0</span>; p &lt; ports-&gt;nelts; p++) &#123;</span><br><span class="line">        <span class="comment">/* 对ip+port的地址进行排序，将通配符形式地址，即任意ip+port的排到最后（如果有，不需要考虑是否bind()ed，因为对应通配符的地址来说bind()无意义）。最开始是bind()ed的地址。中间是未bind()ed的地址。*/</span></span><br><span class="line">        ngx_sort(port[p].addrs.elts, (<span class="keyword">size_t</span>) port[p].addrs.nelts,</span><br><span class="line">                 <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_addr_t</span>), ngx_http_cmp_conf_addrs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * check whether all name-based servers have the same</span></span><br><span class="line"><span class="comment">         * configuration as a default server for given address:port</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 遍历ip+port地址</span></span><br><span class="line">        addr = port[p].addrs.elts;</span><br><span class="line">        <span class="keyword">for</span> (a = <span class="number">0</span>; a &lt; port[p].addrs.nelts; a++) &#123;</span><br><span class="line">            <span class="comment">// 如果ip+port地址下有多个server块，或者只有一个server块（会被设置为默认server块）存在正则匹配时</span></span><br><span class="line">            <span class="keyword">if</span> (addr[a].servers.nelts &gt; <span class="number">1</span></span><br><span class="line">#<span class="keyword">if</span> (NGX_PCRE)</span><br><span class="line">                || addr[a].default_server-&gt;captures</span><br><span class="line">#endif</span><br><span class="line">               )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建hash表，方便查找</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_server_names(cf, cmcf, &amp;addr[a]) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 构建需要进行监听的结构</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_listening(cf, &amp;port[p]) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-server-names"><a href="#ngx-http-server-names" class="headerlink" title="ngx_http_server_names"></a>ngx_http_server_names</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_server_names(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf,</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  n, s;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>             hash;</span><br><span class="line">    <span class="keyword">ngx_hash_keys_arrays_t</span>      ha;</span><br><span class="line">    <span class="keyword">ngx_http_server_name_t</span>     *name;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  **cscfp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  regex, i;</span><br><span class="line"></span><br><span class="line">    regex = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 分配构建hash表的ngx_hash_keys_arrays_t结构，具体可查看前文的正则表达式</span></span><br><span class="line">    ngx_memzero(&amp;ha, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_keys_arrays_t</span>));</span><br><span class="line"></span><br><span class="line">    ha.temp_pool = ngx_create_pool(NGX_DEFAULT_POOL_SIZE, cf-&gt;<span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (ha.temp_pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ha.pool = cf-&gt;pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_keys_array_init(&amp;ha, NGX_HASH_LARGE) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cscfp = addr-&gt;servers.elts;</span><br><span class="line">    <span class="comment">// 遍历ip+port地址下每一个server块的配置</span></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; addr-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        name = cscfp[s]-&gt;server_names.elts;</span><br><span class="line">        <span class="comment">/* 遍历每个seerver块下的server_names（ngx_http_server_name_t数组），注意，如果未显式配置server_name，则数组为空*/</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cscfp[s]-&gt;server_names.nelts; n++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">            <span class="comment">// 如果server_name为正则表达式,则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (name[n].regex) &#123;</span><br><span class="line">                regex++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 添加server_name到要构建的hash表的ngx_hash_keys_arrays_t结构中</span></span><br><span class="line">            rc = ngx_hash_add_key(&amp;ha, &amp;name[n].name, name[n].server,</span><br><span class="line">                                  NGX_HASH_WILDCARD_KEY);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_DECLINED) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"invalid server name or wildcard \"%V\" on %V"</span>,</span><br><span class="line">                              &amp;name[n].name, &amp;addr-&gt;opt.addr_text);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_WARN, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"conflicting server name \"%V\" on %V, ignored"</span>,</span><br><span class="line">                              &amp;name[n].name, &amp;addr-&gt;opt.addr_text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建hash表的hash函数，即相关配置，其中server_names_hash_max_size，和server_names_hash_bucket_size可配置</span></span><br><span class="line">    hash.key = ngx_hash_key_lc;</span><br><span class="line">    hash.max_size = cmcf-&gt;server_names_hash_max_size;</span><br><span class="line">    hash.bucket_size = cmcf-&gt;server_names_hash_bucket_size;</span><br><span class="line">    hash.name = <span class="string">"server_names_hash"</span>;</span><br><span class="line">    hash.pool = cf-&gt;pool;</span><br><span class="line">    <span class="comment">// 如果精确名数组不为空，则构建精确名hash表</span></span><br><span class="line">    <span class="keyword">if</span> (ha.keys.nelts) &#123;</span><br><span class="line">        hash.hash = &amp;addr-&gt;hash;</span><br><span class="line">        hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_hash_init(&amp;hash, ha.keys.elts, ha.keys.nelts) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构建前缀通配符</span></span><br><span class="line">    <span class="keyword">if</span> (ha.dns_wc_head.nelts) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_qsort(ha.dns_wc_head.elts, (<span class="keyword">size_t</span>) ha.dns_wc_head.nelts,</span><br><span class="line">                  <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>), ngx_http_cmp_dns_wildcards);</span><br><span class="line"></span><br><span class="line">        hash.hash = <span class="literal">NULL</span>;</span><br><span class="line">        hash.temp_pool = ha.temp_pool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_hash_wildcard_init(&amp;hash, ha.dns_wc_head.elts,</span><br><span class="line">                                   ha.dns_wc_head.nelts)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addr-&gt;wc_head = (<span class="keyword">ngx_hash_wildcard_t</span> *) hash.hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建后置通配符</span></span><br><span class="line">    <span class="keyword">if</span> (ha.dns_wc_tail.nelts) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_qsort(ha.dns_wc_tail.elts, (<span class="keyword">size_t</span>) ha.dns_wc_tail.nelts,</span><br><span class="line">                  <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>), ngx_http_cmp_dns_wildcards);</span><br><span class="line"></span><br><span class="line">        hash.hash = <span class="literal">NULL</span>;</span><br><span class="line">        hash.temp_pool = ha.temp_pool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_hash_wildcard_init(&amp;hash, ha.dns_wc_tail.elts,</span><br><span class="line">                                   ha.dns_wc_tail.nelts)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addr-&gt;wc_tail = (<span class="keyword">ngx_hash_wildcard_t</span> *) hash.hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(ha.temp_pool);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">// 如果存在通配符名，则在addr的regex中添加正则表达式server name</span></span><br><span class="line">    <span class="keyword">if</span> (regex == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addr-&gt;nregex = regex;</span><br><span class="line">    addr-&gt;regex = ngx_palloc(cf-&gt;pool, regex * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_server_name_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (addr-&gt;regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; addr-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        name = cscfp[s]-&gt;server_names.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cscfp[s]-&gt;server_names.nelts; n++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name[n].regex) &#123;</span><br><span class="line">                addr-&gt;regex[i++] = name[n];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    ngx_destroy_pool(ha.temp_pool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ngx-http-init-listening"><a href="#ngx-http-init-listening" class="headerlink" title="ngx_http_init_listening"></a>ngx_http_init_listening</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_listening(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_conf_port_t</span> *port)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i, last, bind_wildcard;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line">    <span class="keyword">ngx_http_port_t</span>           *hport;</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span>      *addr;</span><br><span class="line"></span><br><span class="line">    addr = port-&gt;addrs.elts;</span><br><span class="line">    last = port-&gt;addrs.nelts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If there is a binding to an "*:port" then we need to bind() to</span></span><br><span class="line"><span class="comment">     * the "*:port" only and ignore other implicit bindings.  The bindings</span></span><br><span class="line"><span class="comment">     * have been already sorted: explicit bindings are on the start, then</span></span><br><span class="line"><span class="comment">     * implicit bindings go, and wildcard binding is in the end.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">/* 对于一个port存在通配符形式地址来说，未bind()的ip+port不需要额外进行监听，只需要监听bind（）的地址。注意这里已经是排好序的ip+port形式的地址，其中bind()的在最前面（非通配符形式），其次是未bind（）地址，最后是通配符地址 */</span></span><br><span class="line">     <span class="comment">// 如果最后一个是通配符形式地址</span></span><br><span class="line">    <span class="keyword">if</span> (addr[last - <span class="number">1</span>].opt.wildcard) &#123;</span><br><span class="line">        <span class="comment">// 设置最后一个为bind的，保证最后所有地址均被监听</span></span><br><span class="line">        addr[last - <span class="number">1</span>].opt.bind = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 记录存在通配符形式地址</span></span><br><span class="line">        bind_wildcard = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 记录不存在通配符形式地址</span></span><br><span class="line">        bind_wildcard = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历每个地址</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; last) &#123;</span><br><span class="line">        <span class="comment">// 如果存在通配符形式地址，并且当前地址未绑定时，直接跳过，注意，最后一个地址已被强制设置为bind。</span></span><br><span class="line">        <span class="keyword">if</span> (bind_wildcard &amp;&amp; !addr[i].opt.bind) &#123;</span><br><span class="line">            <span class="comment">// 记录有多少个不需要单独进行监听的地址</span></span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于需要进行监听的地址，将其增加到listening队列中。</span></span><br><span class="line">        ls = ngx_http_add_listening(cf, &amp;addr[i]);</span><br><span class="line">        <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 由于将不需要单独监听的地址进行了合并，因此需要将每个地址中查找server块的hash表也进行统一管理。</span></span><br><span class="line">        hport = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_port_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (hport == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ls-&gt;servers = hport;</span><br><span class="line">        <span class="comment">// 地址合并数量，除最后一个通配符（如果有的化）地址以外，其他需要单独监听的应该都是1</span></span><br><span class="line">        hport-&gt;naddrs = i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 根据协议进行分别处理</span></span><br><span class="line">        <span class="keyword">switch</span> (ls-&gt;sockaddr-&gt;sa_family) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">        <span class="keyword">case</span> AF_INET6:</span><br><span class="line">            <span class="keyword">if</span> (ngx_http_add_addrs6(cf, hport, addr) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* AF_INET */</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_add_addrs(cf, hport, addr) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理完成，将地址向前移。这是为了方便最后通配符形式的地址，进行统一处理</span></span><br><span class="line">        addr++;</span><br><span class="line">        <span class="comment">/* 处理完成，将总数量减一。这是由于对于需要单独监听的地址来说，记录合并数量的i并未增加，要保障遍历的正确性，需要对总数减一。*/</span></span><br><span class="line">        last--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-listening"><a href="#ngx-http-add-listening" class="headerlink" title="ngx_http_add_listening"></a>ngx_http_add_listening</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_listening_t</span> *</span><br><span class="line">ngx_http_add_listening(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>           *ls;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>  *cscf;</span><br><span class="line">    <span class="comment">// 将需要监听的地址增加到cycle的listening中，并对ngx_listening_t结构的参数赋默认初值</span></span><br><span class="line">    ls = ngx_create_listening(cf, addr-&gt;opt.sockaddr, addr-&gt;opt.socklen);</span><br><span class="line">    <span class="keyword">if</span> (ls == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ls-&gt;addr_ntop = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 设置建立链接后处理函数，进一步解析见http的处理部分</span></span><br><span class="line">    ls-&gt;handler = ngx_http_init_connection;</span><br><span class="line"></span><br><span class="line">    cscf = addr-&gt;default_server;</span><br><span class="line">    ls-&gt;pool_size = cscf-&gt;connection_pool_size;</span><br><span class="line">    ls-&gt;post_accept_timeout = cscf-&gt;client_header_timeout;</span><br><span class="line"></span><br><span class="line">    clcf = cscf-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// 根据addr的opt对ls设置参数值。</span></span><br><span class="line">    ls-&gt;logp = clcf-&gt;error_log;</span><br><span class="line">    ls-&gt;<span class="built_in">log</span>.data = &amp;ls-&gt;addr_text;</span><br><span class="line">    ls-&gt;<span class="built_in">log</span>.handler = ngx_accept_log_error;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">ngx_iocp_conf_t</span>  *iocpcf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_get_conf(cf-&gt;cycle-&gt;conf_ctx, ngx_events_module)) &#123;</span><br><span class="line">        iocpcf = ngx_event_get_conf(cf-&gt;cycle-&gt;conf_ctx, ngx_iocp_module);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (iocpcf &amp;&amp; iocpcf-&gt;acceptex_read) &#123;</span><br><span class="line">        ls-&gt;post_accept_buffer_size = cscf-&gt;client_header_buffer_size;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ls-&gt;backlog = addr-&gt;opt.backlog;</span><br><span class="line">    ls-&gt;rcvbuf = addr-&gt;opt.rcvbuf;</span><br><span class="line">    ls-&gt;sndbuf = addr-&gt;opt.sndbuf;</span><br><span class="line"></span><br><span class="line">    ls-&gt;keepalive = addr-&gt;opt.so_keepalive;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_KEEPALIVE_TUNABLE)</span></span><br><span class="line">    ls-&gt;keepidle = addr-&gt;opt.tcp_keepidle;</span><br><span class="line">    ls-&gt;keepintvl = addr-&gt;opt.tcp_keepintvl;</span><br><span class="line">    ls-&gt;keepcnt = addr-&gt;opt.tcp_keepcnt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined SO_ACCEPTFILTER)</span></span><br><span class="line">    ls-&gt;accept_filter = addr-&gt;opt.accept_filter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_DEFERRED_ACCEPT &amp;&amp; defined TCP_DEFER_ACCEPT)</span></span><br><span class="line">    ls-&gt;deferred_accept = addr-&gt;opt.deferred_accept;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_INET6)</span></span><br><span class="line">    ls-&gt;ipv6only = addr-&gt;opt.ipv6only;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SETFIB)</span></span><br><span class="line">    ls-&gt;setfib = addr-&gt;opt.setfib;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_TCP_FASTOPEN)</span></span><br><span class="line">    ls-&gt;fastopen = addr-&gt;opt.fastopen;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_REUSEPORT)</span></span><br><span class="line">    ls-&gt;reuseport = addr-&gt;opt.reuseport;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ngx-http-add-addrs"><a href="#ngx-http-add-addrs" class="headerlink" title="ngx_http_add_addrs"></a>ngx_http_add_addrs</h6><p>ipv4和ipv6对应的处理类似，这里以ipv4举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_addrs(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_port_t</span> *hport,</span><br><span class="line">    <span class="keyword">ngx_http_conf_addr_t</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_http_in_addr_t</span>        *addrs;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>        *<span class="title">sin</span>;</span></span><br><span class="line">    <span class="keyword">ngx_http_virtual_names_t</span>  *vn;</span><br><span class="line">    <span class="comment">// 根据需要进行地址合并监听的数量，来分配ngx_http_in_addr_t的数量</span></span><br><span class="line">    hport-&gt;addrs = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                               hport-&gt;naddrs * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_in_addr_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (hport-&gt;addrs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addrs = hport-&gt;addrs;</span><br><span class="line">    <span class="comment">// 遍历addr（即ip+port对应的地址结构ngx_http_conf_addr_t）对addrs赋值。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hport-&gt;naddrs; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sin</span> = (struct sockaddr_in *) addr[i].opt.sockaddr;</span><br><span class="line">        addrs[i].addr = <span class="built_in">sin</span>-&gt;sin_addr.s_addr;</span><br><span class="line">        <span class="comment">/* 设置默认server块。这里如果有两个监听同样的ip+port地址的server块，但都没有设置server_name，则第二个的服务永远不会被访问到 */</span></span><br><span class="line">        addrs[i].conf.default_server = addr[i].default_server;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">        addrs[i].conf.ssl = addr[i].opt.ssl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_V2)</span></span><br><span class="line">        addrs[i].conf.http2 = addr[i].opt.http2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        addrs[i].conf.proxy_protocol = addr[i].opt.proxy_protocol;</span><br><span class="line">        <span class="comment">/* 如果ip+port地址下的server name未存在hash（三种）并且无正则表达式，则直接跳过。即此时所有server块，均无明确server name。 这时只能通过default_server进行服务服务，因此其他服务将无法访问到*/</span></span><br><span class="line">        <span class="keyword">if</span> (addr[i].hash.buckets == <span class="literal">NULL</span></span><br><span class="line">            &amp;&amp; (addr[i].wc_head == <span class="literal">NULL</span></span><br><span class="line">                || addr[i].wc_head-&gt;hash.buckets == <span class="literal">NULL</span>)</span><br><span class="line">            &amp;&amp; (addr[i].wc_tail == <span class="literal">NULL</span></span><br><span class="line">                || addr[i].wc_tail-&gt;hash.buckets == <span class="literal">NULL</span>)</span><br><span class="line">#<span class="keyword">if</span> (NGX_PCRE)</span><br><span class="line">            &amp;&amp; addr[i].nregex == <span class="number">0</span></span><br><span class="line">#endif</span><br><span class="line">            )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果上述有一个存在，则会构建一个ngx_http_virtual_names_t进行存储</span></span><br><span class="line">        vn = ngx_palloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_virtual_names_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (vn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addrs[i].conf.virtual_names = vn;</span><br><span class="line">        <span class="comment">// 存储hash表</span></span><br><span class="line">        vn-&gt;names.hash = addr[i].hash;</span><br><span class="line">        vn-&gt;names.wc_head = addr[i].wc_head;</span><br><span class="line">        vn-&gt;names.wc_tail = addr[i].wc_tail;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">        <span class="comment">// 存储正则表达式。</span></span><br><span class="line">        vn-&gt;nregex = addr[i].nregex;</span><br><span class="line">        vn-&gt;regex = addr[i].regex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="location层set函数"><a href="#location层set函数" class="headerlink" title="location层set函数"></a>location层set函数</h3><p>在server中，接着执行解析函数时，当解析到location配置时，首先会遇到ngx_http_core_module核心模块的commands中的location。如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"location"</span>),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_BLOCK|NGX_CONF_TAKE12,</span><br><span class="line">      ngx_http_core_location,</span><br><span class="line">      NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>其函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_core_location(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *dummy)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                      *rv;</span><br><span class="line">    u_char                    *mod;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 *value, *name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 i;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                 save;</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span>         *<span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>       *ctx, *pctx;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf, *pclcf;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_conf_ctx_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里的ctx为server层创建的ngx_http_conf_ctx_t。由于loc层不会有main和server层的配置，因此这两部分指向server层创建的空间即可</span></span><br><span class="line">    pctx = cf-&gt;ctx;</span><br><span class="line">    ctx-&gt;main_conf = pctx-&gt;main_conf;</span><br><span class="line">    ctx-&gt;srv_conf = pctx-&gt;srv_conf;</span><br><span class="line">    <span class="comment">// 创建loc_conf存储空间</span></span><br><span class="line">    ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * ngx_http_max_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;create_loc_conf) &#123;</span><br><span class="line">            ctx-&gt;loc_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] =</span><br><span class="line">                                                   <span class="keyword">module</span>-&gt;create_loc_conf(cf);</span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;loc_conf[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取loc层ngx_http_core_module创建的ngx_http_core_loc_conf_s</span></span><br><span class="line">    clcf = ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// loc层的ngx_http_core_loc_conf_s的loc_conf指向loc层创建的loc_conf</span></span><br><span class="line">    clcf-&gt;loc_conf = ctx-&gt;loc_conf;</span><br><span class="line">    <span class="comment">// 获取词法解析后的数量。这里value只会是2、3，由于location中的commands中的NGX_CONF_TAKE12限制。正常来说是3，详见location配置。2是由于中间的参数和后面的参数中间未添加空格导致。这里分别进行处理。</span></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 对解析参数进行处理，来对clcf赋值。只有~和~*时需要进行正则匹配，对于正则匹配的介绍，后续进行</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts == <span class="number">3</span>) &#123;</span><br><span class="line"></span><br><span class="line">        len = value[<span class="number">1</span>].len;</span><br><span class="line">        mod = value[<span class="number">1</span>].data;</span><br><span class="line">        name = &amp;value[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">1</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'='</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name = *name;</span><br><span class="line">            clcf-&gt;exact_match = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">2</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'^'</span> &amp;&amp; mod[<span class="number">1</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name = *name;</span><br><span class="line">            clcf-&gt;noregex = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">1</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">2</span> &amp;&amp; mod[<span class="number">0</span>] == <span class="string">'~'</span> &amp;&amp; mod[<span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">1</span>) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"invalid location modifier \"%V\""</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        name = &amp;value[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'='</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name.len = name-&gt;len - <span class="number">1</span>;</span><br><span class="line">            clcf-&gt;name.data = name-&gt;data + <span class="number">1</span>;</span><br><span class="line">            clcf-&gt;exact_match = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'^'</span> &amp;&amp; name-&gt;data[<span class="number">1</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name.len = name-&gt;len - <span class="number">2</span>;</span><br><span class="line">            clcf-&gt;name.data = name-&gt;data + <span class="number">2</span>;</span><br><span class="line">            clcf-&gt;noregex = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'~'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            name-&gt;len--;</span><br><span class="line">            name-&gt;data++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                name-&gt;len--;</span><br><span class="line">                name-&gt;data++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">1</span>) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ngx_http_core_regex_location(cf, clcf, name, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            clcf-&gt;name = *name;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name-&gt;data[<span class="number">0</span>] == <span class="string">'@'</span>) &#123;</span><br><span class="line">                clcf-&gt;named = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上一层（正常来说是server层，如果是location中嵌套location，则是当前location的上一层location）ngx_http_core_module创建的ngx_http_core_loc_conf_s</span></span><br><span class="line">    pclcf = pctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">// 对于location块中嵌套location的处理</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cmd_type == NGX_HTTP_LOC_CONF) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* nested location */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        clcf-&gt;prev_location = pclcf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pclcf-&gt;exact_match) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"location \"%V\" cannot be inside "</span></span><br><span class="line">                               <span class="string">"the exact location \"%V\""</span>,</span><br><span class="line">                               &amp;clcf-&gt;name, &amp;pclcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pclcf-&gt;named) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"location \"%V\" cannot be inside "</span></span><br><span class="line">                               <span class="string">"the named location \"%V\""</span>,</span><br><span class="line">                               &amp;clcf-&gt;name, &amp;pclcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;named) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"named location \"%V\" can be "</span></span><br><span class="line">                               <span class="string">"on the server level only"</span>,</span><br><span class="line">                               &amp;clcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = pclcf-&gt;name.len;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;regex == <span class="literal">NULL</span></span><br><span class="line">            &amp;&amp; ngx_filename_cmp(clcf-&gt;name.data, pclcf-&gt;name.data, len) != <span class="number">0</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> (ngx_filename_cmp(clcf-&gt;name.data, pclcf-&gt;name.data, len) != <span class="number">0</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"location \"%V\" is outside location \"%V\""</span>,</span><br><span class="line">                               &amp;clcf-&gt;name, &amp;pclcf-&gt;name);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在上一层（正常来说是server层，如果是location中嵌套location，则是当前location的上一层location）ngx_http_core_module创建的ngx_http_core_loc_conf_s中的location变量里增加loc层创建的ngx_http_core_loc_conf_s，以此将server层和location层的解析关系进行连接。这里建立的是ngx_http_location_queue_t结构，其中存储了当前loc下的配置信息。</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_add_location(cf, &amp;pclcf-&gt;locations, clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续解析location层的配置</span></span><br><span class="line">    save = *cf;</span><br><span class="line">    cf-&gt;ctx = ctx;</span><br><span class="line">    cf-&gt;cmd_type = NGX_HTTP_LOC_CONF;</span><br><span class="line"></span><br><span class="line">    rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    *cf = save;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="loc级配置解析内存结构"><a href="#loc级配置解析内存结构" class="headerlink" title="loc级配置解析内存结构"></a>loc级配置解析内存结构</h4><p><a href="https://imgtu.com/i/RI50gJ" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/06/RI50gJ.png" alt="RI50gJ.png"></a></p>
<p><center>图10-5</center><br>解析每一个location块时都会创建一个新的 ngx_http_conf_ctx_t结构体，其中的main_conf、srv_conf将指向http块下main_conf、srv_conf指针数组，loc_conf数组则都会重新分配，内容就是所有HTTP模块的create_loc_conf方法创建的结构体指针。</p>
<p>server层的存储结构和location层存储关联方式为：将location层ngx_http_core_module模块生成的ngx_http_core_loc_conf_s添加到server层ngx_http_core_module块生成的ngx_http_core_loc_conf_s的locations中，ngx_http_core_loc_conf_s的locations为一个队列，其元素为ngx_http_location_queue_t。定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// queue为双向队列容器，用于将ngx_http_location_queue_t链接起来</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                      <span class="built_in">queue</span>;</span><br><span class="line">    <span class="comment">// 如果location中的字符串可以精确匹配（包括正则表达式），exact指向对应的ngx_http_core_loc_conf_t结构体。否则为null</span></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *exact;</span><br><span class="line">    <span class="comment">// 如果location中的字符串无法精确匹配（包括了自定义的通配符），inclusive指向对应的ngx_http_core_loc_conf_t结构体。否则为null</span></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *inclusive;</span><br><span class="line">    <span class="comment">// 指向location名称</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                       *name;</span><br><span class="line">    u_char                          *file_name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       line;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                      <span class="built_in">list</span>;</span><br><span class="line">&#125; <span class="keyword">ngx_http_location_queue_t</span>;</span><br></pre></td></tr></table></figure>
<p>使用ngx_http_location_queue_t将server层配置与location层配置相关联，server层的ngx_http_core_loc_conf_s的locations存储了其下所有location块生成的ngx_http_location_queue_t。最终解析后结构可能如下：</p>
<p><a href="https://imgtu.com/i/R7D2DO" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/06/R7D2DO.png" alt="R7D2DO.png"></a></p>
<p>location本身是可以进行嵌套的，嵌套后结构也是可以按照上面的方式进行扩招，即上一层的ngx_http_core_loc_conf_s中的locations存储下一层的所有location解析。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    mytest_num 1;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name A;</span><br><span class="line">        listen 8000;</span><br><span class="line">        listen 80;</span><br><span class="line">        mytest_num 2;</span><br><span class="line">        location /L1 &#123;</span><br><span class="line">            mytest_num 3;</span><br><span class="line">            ...</span><br><span class="line">            location /L1/CL1 &#123;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其解析结果为：</p>
<p><a href="https://imgtu.com/i/R7DzPs" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/06/R7DzPs.png" alt="R7DzPs.png"></a></p>
<p>向locations中增加ngx_http_core_loc_conf_t的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_add_location(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> **locations,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *clcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *locations = ngx_palloc(cf-&gt;temp_pool,</span><br><span class="line">                                <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_location_queue_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (*locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_queue_init(*locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lq = ngx_palloc(cf-&gt;temp_pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_location_queue_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (lq == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;exact_match</span><br><span class="line">#<span class="keyword">if</span> (NGX_PCRE)</span><br><span class="line">        || clcf-&gt;regex</span><br><span class="line">#endif</span><br><span class="line">        || clcf-&gt;named || clcf-&gt;noname)</span><br><span class="line">    &#123;</span><br><span class="line">        lq-&gt;exact = clcf;</span><br><span class="line">        lq-&gt;inclusive = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// location ^~ 会使用包含匹配</span></span><br><span class="line">        lq-&gt;exact = <span class="literal">NULL</span>;</span><br><span class="line">        lq-&gt;inclusive = clcf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lq-&gt;name = &amp;clcf-&gt;name;</span><br><span class="line">    lq-&gt;file_name = cf-&gt;conf_file-&gt;file.name.data;</span><br><span class="line">    lq-&gt;line = cf-&gt;conf_file-&gt;line;</span><br><span class="line"></span><br><span class="line">    ngx_queue_init(&amp;lq-&gt;<span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line">    ngx_queue_insert_tail(*locations, &amp;lq-&gt;<span class="built_in">queue</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码可以看出来，locations并非直接存储的ngx_http_location_queue_t。而是一个ngx_queue_t，即nginx自己实现的双向队列。这里存储的是ngx_http_location_queue_t结构中的queue队列，可以通过ngx_queue_t支持的操作，获取到对应的源数据。</p>
<h4 id="正则表达式解析"><a href="#正则表达式解析" class="headerlink" title="正则表达式解析"></a>正则表达式解析</h4><h2 id="配置项合并"><a href="#配置项合并" class="headerlink" title="配置项合并"></a>配置项合并</h2><p>合并配置项，主要是合并main层的srv_conf与server层的srv_conf合并，以及main层的loc_conf与server层的loc_conf和location层的loc_conf三者之间的合并。即如下图：</p>
<p><a href="https://imgtu.com/i/Rq8iGT" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/07/07/Rq8iGT.png" alt="Rq8iGT.png"></a></p>
<p>在http层解析完成配置后，就会进行配置项的合并：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取http级别ngx_http_core_module创建的http_ngx_core_main_conf_t</span></span><br><span class="line">cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">cscfp = cmcf-&gt;servers.elts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">    mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init http&#123;&#125; main_conf's */</span></span><br><span class="line">    <span class="comment">// 执行每个模块的init_main_conf方法，解析后，对main级别的main_conf进行进一步处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;init_main_conf) &#123;</span><br><span class="line">        rv = <span class="keyword">module</span>-&gt;init_main_conf(cf, ctx-&gt;main_conf[mi]);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 合并配置项</span></span><br><span class="line"></span><br><span class="line">    rv = ngx_http_merge_servers(cf, cmcf, <span class="keyword">module</span>, mi);</span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-merge-servers"><a href="#ngx-http-merge-servers" class="headerlink" title="ngx_http_merge_servers"></a>ngx_http_merge_servers</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_merge_servers(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf,</span><br><span class="line">    <span class="keyword">ngx_http_module_t</span> *<span class="keyword">module</span>, <span class="keyword">ngx_uint_t</span> ctx_index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                        *rv;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   s;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>         *ctx, saved;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_core_srv_conf_t</span>   **cscfp;</span><br><span class="line">    <span class="comment">// 获取main级别ngx_http_core_module创建的http_ngx_core_main_conf_t的servers</span></span><br><span class="line">    cscfp = cmcf-&gt;servers.elts;</span><br><span class="line">    ctx = (<span class="keyword">ngx_http_conf_ctx_t</span> *) cf-&gt;ctx;</span><br><span class="line">    saved = *ctx;</span><br><span class="line">    rv = NGX_CONF_OK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* merge the server&#123;&#125;s' srv_conf's */</span></span><br><span class="line">        <span class="comment">// 使ctx-&gt;srv_conf变更为server层创建的ngx_http_conf_ctx_t的srv_conf</span></span><br><span class="line">        ctx-&gt;srv_conf = cscfp[s]-&gt;ctx-&gt;srv_conf;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;merge_srv_conf) &#123;</span><br><span class="line">            <span class="comment">// 调用模块的merge_srv_conf（如果有），合并main级别和server级别的srv_conf。参数中，前者为main级别下创建的srv_conf，后者为server级别创建的srv_conf，merger后，对后者进行变更（即server层）</span></span><br><span class="line">            rv = <span class="keyword">module</span>-&gt;merge_srv_conf(cf, saved.srv_conf[ctx_index],</span><br><span class="line">                                        cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;merge_loc_conf) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* merge the server&#123;&#125;'s loc_conf */</span></span><br><span class="line">            <span class="comment">// 使ctx-&gt;loc_conf变更为server层创建的ngx_http_conf_ctx_t的loc_conf</span></span><br><span class="line">            ctx-&gt;loc_conf = cscfp[s]-&gt;ctx-&gt;loc_conf;</span><br><span class="line">            <span class="comment">// 调用模块的merge_loc_conf（如果有），合并main级别和server级别的loc_conf。参数中，前者为main级别下创建的loc_conf，后者为server级别创建的loc_conf，merger后，对后者进行变更（即server层）</span></span><br><span class="line">            rv = <span class="keyword">module</span>-&gt;merge_loc_conf(cf, saved.loc_conf[ctx_index],</span><br><span class="line">                                        cscfp[s]-&gt;ctx-&gt;loc_conf[ctx_index]);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* merge the locations&#123;&#125;' loc_conf's */</span></span><br><span class="line">            <span class="comment">// 获取server级别ngx_http_core_module创建的ngx_http_conf_ctx_t的loc_conf</span></span><br><span class="line">            clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">            <span class="comment">// 调用ngx_http_merge_locations模块，merge server层（已经和main层合并过）的loc_conf和location层的loc_conf，参数中，前者为server下的location块列表，后者为server层的loc_conf</span></span><br><span class="line">            rv = ngx_http_merge_locations(cf, clcf-&gt;locations,</span><br><span class="line">                                          cscfp[s]-&gt;ctx-&gt;loc_conf,</span><br><span class="line">                                          <span class="keyword">module</span>, ctx_index);</span><br><span class="line">            <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    *ctx = saved;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-merge-locations"><a href="#ngx-http-merge-locations" class="headerlink" title="ngx_http_merge_locations"></a>ngx_http_merge_locations</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_merge_locations(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> *locations,</span><br><span class="line">    <span class="keyword">void</span> **loc_conf, <span class="keyword">ngx_http_module_t</span> *<span class="keyword">module</span>, <span class="keyword">ngx_uint_t</span> ctx_index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>                       *rv;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q;</span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>        *ctx, saved;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上一层（无嵌套location时，为server层，在嵌套location时，为上一层location）的ngx_http_conf_ctx_t</span></span><br><span class="line">    ctx = (<span class="keyword">ngx_http_conf_ctx_t</span> *) cf-&gt;ctx;</span><br><span class="line">    saved = *ctx;</span><br><span class="line">    <span class="comment">// 循环server块下，每一个location块，将每一个location块中的ctx_index对应模块与server层的ctx_index进行合并</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_head(locations);</span><br><span class="line">         q != ngx_queue_sentinel(locations);</span><br><span class="line">         q = ngx_queue_next(q))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 由于ngx_queue_t是ngx_http_location_queue_t的第一个元素，因此可以直接转换。</span></span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">        <span class="comment">// 获取location块生成的ngx_http_core_loc_conf_t</span></span><br><span class="line">        clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;</span><br><span class="line">        <span class="comment">// 将ctx-&gt;loc_conf变更为下一层（无嵌套location时，为空，有嵌套location时，为为一层location）的ngx_http_conf_ctx_t中的loc_conf</span></span><br><span class="line">        ctx-&gt;loc_conf = clcf-&gt;loc_conf;</span><br><span class="line">        <span class="comment">// 调用模块的merge_loc_conf（如果有），合并server级别和location级别的loc_conf。参数中，前者为server级别下创建的loc_conf，后者为location级别创建的loc_conf，merger后，对后者进行变更（即location层）</span></span><br><span class="line">        rv = <span class="keyword">module</span>-&gt;merge_loc_conf(cf, loc_conf[ctx_index],</span><br><span class="line">                                    clcf-&gt;loc_conf[ctx_index]);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> rv;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于存在嵌套的location，循环调用ngx_http_merge_locations</span></span><br><span class="line">        rv = ngx_http_merge_locations(cf, clcf-&gt;locations, clcf-&gt;loc_conf,</span><br><span class="line">                                      <span class="keyword">module</span>, ctx_index);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> rv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *ctx = saved;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建location配置树"><a href="#创建location配置树" class="headerlink" title="创建location配置树"></a>创建location配置树</h2><p>当请求到达时，需要先找到对应的server模块，再根据请求的uri找到对应的location配置块。location存储在server层级创建的ngx_http_core_loc_conf_s的locations，使用双向链表存储，这时查找效率太慢，因此为了加速查询，构建一个快速查询的树结构。其代码在http层set函数ngx_http_block。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* create location trees */</span></span><br><span class="line"><span class="comment">// cmcf为http层创建的ngx_http_core_main_conf_t</span></span><br><span class="line"><span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line">    <span class="comment">// cscfp为http层创建的ngx_http_core_main_conf_t的servers，即server层创建的ngx_http_core_srv_conf_t列表</span></span><br><span class="line">    <span class="comment">// clcf为server层创建的ngx_http_core_loc_conf_t</span></span><br><span class="line">    clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">    <span class="comment">/* 按照类型排序location，排序完后的队列：  (exact_match 或 inclusive) (排序好的，如果某个exact_match名字和inclusive location相同，exact_match排在前面)</span></span><br><span class="line"><span class="comment">   |  regex（未排序）| named(排序好的)  |  noname（未排序）*/</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_locations(cf, cscfp[s], clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建location的静态树</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>locations排序和分隔ngx_http_init_locations：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_locations(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_srv_conf_t</span> *cscf,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *pclcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   n;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                 *q, *locations, *named, tail;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>   *lq;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   **clcfp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                   r;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                 *regex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取server层下包含所有location</span></span><br><span class="line">    locations = pclcf-&gt;locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用ngx_http_cmp_locations对location进行排序，排序结果为(exact_match 或 inclusive) (排序好的，如果某个exact_match名字和inclusive location相同，exact_match排在前面)|  regex（未排序）| named(排序好的)  |  noname（未排序）</span></span><br><span class="line">    ngx_queue_sort(locations, ngx_http_cmp_locations);</span><br><span class="line"></span><br><span class="line">    named = <span class="literal">NULL</span>;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    regex = <span class="literal">NULL</span>;</span><br><span class="line">    r = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取regex类型的location数量和与named的分隔位置，获取named类型的location数量和其与noname的分隔位置</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_head(locations);</span><br><span class="line">         q != ngx_queue_sentinel(locations);</span><br><span class="line">         q = ngx_queue_next(q))</span><br><span class="line">    &#123;</span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">        clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;</span><br><span class="line">        <span class="comment">// 递归的对location内包含的locations进行排序和切割</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_locations(cf, <span class="literal">NULL</span>, clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;regex) &#123;</span><br><span class="line">            r++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (regex == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                regex = q;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;named) &#123;</span><br><span class="line">            n++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (named == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                named = q;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于noname类型的location，找到第一个，直接结束，if和limit_except</span></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;noname) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果未查找到双向队列的末尾，说明含有noname，直接将noname的数据切割掉。</span></span><br><span class="line">    <span class="keyword">if</span> (q != ngx_queue_sentinel(locations)) &#123;</span><br><span class="line">        ngx_queue_split(locations, q, &amp;tail);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果找到了named的location（@），则将named的部分切割出来，存储到server层创建的ngx_http_core_srv_conf_t的named_locations中</span></span><br><span class="line">    <span class="keyword">if</span> (named) &#123;</span><br><span class="line">        clcfp = ngx_palloc(cf-&gt;pool,</span><br><span class="line">                           (n + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_core_loc_conf_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (clcfp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cscf-&gt;named_locations = clcfp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (q = named;</span><br><span class="line">             q != ngx_queue_sentinel(locations);</span><br><span class="line">             q = ngx_queue_next(q))</span><br><span class="line">        &#123;</span><br><span class="line">            lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">            *(clcfp++) = lq-&gt;exact;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *clcfp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        ngx_queue_split(locations, named, &amp;tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">// 如果存在正则匹配的location，则将正则匹配的location切割出来，放到server层创建的ngx_http_core_loc_conf_t的regex_locations中</span></span><br><span class="line">    <span class="keyword">if</span> (regex) &#123;</span><br><span class="line"></span><br><span class="line">        clcfp = ngx_palloc(cf-&gt;pool,</span><br><span class="line">                           (r + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_core_loc_conf_t</span> *));</span><br><span class="line">        <span class="keyword">if</span> (clcfp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pclcf-&gt;regex_locations = clcfp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (q = regex;</span><br><span class="line">             q != ngx_queue_sentinel(locations);</span><br><span class="line">             q = ngx_queue_next(q))</span><br><span class="line">        &#123;</span><br><span class="line">            lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">            *(clcfp++) = lq-&gt;exact;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *clcfp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        ngx_queue_split(locations, regex, &amp;tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 至此server层创建的ngx_http_core_loc_conf_t的locations中只有排序好的exact_match 或 inclusive类型的location</span></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对exact_match 或 inclusive类型的location构建静态树：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_static_location_trees(<span class="keyword">ngx_conf_t</span> *cf,</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *pclcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q, *locations;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>   *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq;</span><br><span class="line"></span><br><span class="line">    locations = pclcf-&gt;locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(locations)) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 递归的对location内包含location的情况进行处理。</span></span><br><span class="line">    <span class="keyword">for</span> (q = ngx_queue_head(locations);</span><br><span class="line">         q != ngx_queue_sentinel(locations);</span><br><span class="line">         q = ngx_queue_next(q))</span><br><span class="line">    &#123;</span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line"></span><br><span class="line">        clcf = lq-&gt;exact ? lq-&gt;exact : lq-&gt;inclusive;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 该函数把同一层次里的名称相同的不同 location 合并在一起。</span></span><br><span class="line"><span class="comment">     * "名称相同，但又是不同的 location"?</span></span><br><span class="line"><span class="comment">     * 这主要是因为 location 有绝对匹配（对应 exact 字段）和包含匹配（也就是前缀</span></span><br><span class="line"><span class="comment">     * 匹配，以指定前缀开头的都匹配上，所以是包含匹配，对应 inclusive 字段）。若</span></span><br><span class="line"><span class="comment">     * 这两个 location 的名称相同（如都为 "/"），则可以把它们共用在一个队列节点里 */</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_join_exact_locations(cf, locations) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 递归每个location节点，得到当前节点的名字为其前缀的location的列表，保存在当前节点的list字段下 这里是将前缀匹配的location进行和其他的location合并，构建一个前缀匹配的list*/</span></span><br><span class="line">    ngx_http_create_locations_list(locations, ngx_queue_head(locations));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 递归建立location三叉排序树 */</span></span><br><span class="line">    pclcf-&gt;static_locations = ngx_http_create_locations_tree(cf, locations, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pclcf-&gt;static_locations == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>融合exact和inclusive类型的location代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_join_exact_locations(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> *locations)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *q, *x;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq, *lx;</span><br><span class="line"></span><br><span class="line">    q = ngx_queue_head(locations);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (q != ngx_queue_last(locations)) &#123;</span><br><span class="line"></span><br><span class="line">        x = ngx_queue_next(q);</span><br><span class="line"></span><br><span class="line">        lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">        lx = (<span class="keyword">ngx_http_location_queue_t</span> *) x;</span><br><span class="line">        <span class="comment">// 前后两个一致，则将后面的inclusive赋值到前一个inclusive，将后一个删除</span></span><br><span class="line">        <span class="keyword">if</span> (lq-&gt;name-&gt;len == lx-&gt;name-&gt;len</span><br><span class="line">            &amp;&amp; ngx_filename_cmp(lq-&gt;name-&gt;data, lx-&gt;name-&gt;data, lx-&gt;name-&gt;len)</span><br><span class="line">               == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((lq-&gt;exact &amp;&amp; lx-&gt;exact) || (lq-&gt;inclusive &amp;&amp; lx-&gt;inclusive)) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"duplicate location \"%V\" in %s:%ui"</span>,</span><br><span class="line">                              lx-&gt;name, lx-&gt;file_name, lx-&gt;line);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lq-&gt;inclusive = lx-&gt;inclusive;</span><br><span class="line"></span><br><span class="line">            ngx_queue_remove(x);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        q = ngx_queue_next(q);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构架前缀列表ngx_http_create_locations_list：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_create_locations_list(<span class="keyword">ngx_queue_t</span> *locations, <span class="keyword">ngx_queue_t</span> *q)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                     *name;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                *x, tail;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>  *lq, *lx;</span><br><span class="line">    <span class="comment">// 如果当前的location是locations列表中最后一个，直接结束</span></span><br><span class="line">    <span class="keyword">if</span> (q == ngx_queue_last(locations)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">    <span class="comment">// 如果当前的location不包含前缀类型的location，则接着向后处理</span></span><br><span class="line">    <span class="keyword">if</span> (lq-&gt;inclusive == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_create_locations_list(locations, ngx_queue_next(q));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前的location包含前缀类型的location，则构建前缀列表</span></span><br><span class="line">    len = lq-&gt;name-&gt;len;</span><br><span class="line">    name = lq-&gt;name-&gt;data;</span><br><span class="line">    <span class="comment">// 找到以当前的location的name作为前缀的所有location</span></span><br><span class="line">    <span class="keyword">for</span> (x = ngx_queue_next(q);</span><br><span class="line">         x != ngx_queue_sentinel(locations);</span><br><span class="line">         x = ngx_queue_next(x))</span><br><span class="line">    &#123;</span><br><span class="line">        lx = (<span class="keyword">ngx_http_location_queue_t</span> *) x;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len &gt; lx-&gt;name-&gt;len</span><br><span class="line">            || ngx_filename_cmp(name, lx-&gt;name-&gt;data, len) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    q = ngx_queue_next(q);</span><br><span class="line">    <span class="comment">// 如果没有以当前的location的name作为前缀的所有location，则接着处理后面的列表。</span></span><br><span class="line">    <span class="keyword">if</span> (q == x) &#123;</span><br><span class="line">        ngx_http_create_locations_list(locations, x);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以当前的location将locations切割成两部分</span></span><br><span class="line">    ngx_queue_split(locations, q, &amp;tail);</span><br><span class="line">    <span class="comment">// 将后半部分location列表添加到当前location对应的ngx_http_location_queue_t成员list上</span></span><br><span class="line">    ngx_queue_add(&amp;lq-&gt;<span class="built_in">list</span>, &amp;tail);</span><br><span class="line">    <span class="comment">// 如果后半部分全部是能够以当前的location的name作为前缀的location，则直接递归处理该后半部分的location即可</span></span><br><span class="line">    <span class="keyword">if</span> (x == ngx_queue_sentinel(locations)) &#123;</span><br><span class="line">        ngx_http_create_locations_list(&amp;lq-&gt;<span class="built_in">list</span>, ngx_queue_head(&amp;lq-&gt;<span class="built_in">list</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果后半部分只有部分是能够以当前的location的name作为前缀的location，将剩余的location重新拼接到locations列表中</span></span><br><span class="line">    ngx_queue_split(&amp;lq-&gt;<span class="built_in">list</span>, x, &amp;tail);</span><br><span class="line">    ngx_queue_add(locations, &amp;tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递归处理能够以当前的location的name作为前缀的location列表</span></span><br><span class="line">    ngx_http_create_locations_list(&amp;lq-&gt;<span class="built_in">list</span>, ngx_queue_head(&amp;lq-&gt;<span class="built_in">list</span>));</span><br><span class="line">    <span class="comment">// 接着处理之后的locations</span></span><br><span class="line">    ngx_http_create_locations_list(locations, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如，对于如下的location配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /abc</span><br><span class="line">location = /abc</span><br><span class="line">location = /bdf</span><br><span class="line">location = /bdf/hl</span><br><span class="line">location ^~ /efg</span><br><span class="line">location ^~ /efghjk</span><br><span class="line">location ^~ /efghjo</span><br><span class="line">location = /efghjk/npq</span><br><span class="line">location = /fgk</span><br></pre></td></tr></table></figure>
<p>则经过ngx_http_create_locations_list后，locations结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/abc ---&gt; /bef ---&gt; /bef/hl ---&gt; /efg ---&gt; /fgk</span><br><span class="line">                                  |</span><br><span class="line">                                 \|/</span><br><span class="line">                                 /efghjk ---&gt; /efghjo</span><br><span class="line">                                  |</span><br><span class="line">                                 \|/ </span><br><span class="line">                                 /efghjk/npq</span><br></pre></td></tr></table></figure>
<p>构建静态树ngx_http_create_locations_tree：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_location_tree_node_t</span> *</span><br><span class="line">ngx_http_create_locations_tree(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_queue_t</span> *locations,</span><br><span class="line">    <span class="keyword">size_t</span> prefix)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                          len;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                    *q, tail;</span><br><span class="line">    <span class="keyword">ngx_http_location_queue_t</span>      *lq;</span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>  *node;</span><br><span class="line">    <span class="comment">// 获取locations中间的location</span></span><br><span class="line">    q = ngx_queue_middle(locations);</span><br><span class="line"></span><br><span class="line">    lq = (<span class="keyword">ngx_http_location_queue_t</span> *) q;</span><br><span class="line">    len = lq-&gt;name-&gt;len - prefix;</span><br><span class="line"></span><br><span class="line">    node = ngx_palloc(cf-&gt;pool,</span><br><span class="line">                      offsetof(<span class="keyword">ngx_http_location_tree_node_t</span>, name) + len);</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node-&gt;left = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;tree = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;exact = lq-&gt;exact;</span><br><span class="line">    node-&gt;inclusive = lq-&gt;inclusive;</span><br><span class="line"></span><br><span class="line">    node-&gt;auto_redirect = (u_char) ((lq-&gt;exact &amp;&amp; lq-&gt;exact-&gt;auto_redirect)</span><br><span class="line">                           || (lq-&gt;inclusive &amp;&amp; lq-&gt;inclusive-&gt;auto_redirect));</span><br><span class="line"></span><br><span class="line">    node-&gt;len = (u_char) len;</span><br><span class="line">    ngx_memcpy(node-&gt;name, &amp;lq-&gt;name-&gt;data[prefix], len);</span><br><span class="line">    <span class="comment">// 从中间切割locations</span></span><br><span class="line">    ngx_queue_split(locations, q, &amp;tail);</span><br><span class="line">    <span class="comment">// 如果切割后locations为空，则将该location下的list（前缀列表），递归改操作。</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(locations)) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ngx_queue_split() insures that if left part is empty,</span></span><br><span class="line"><span class="comment">         * then right one is empty too</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">goto</span> inclusive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 左子树执行构建</span></span><br><span class="line">    node-&gt;left = ngx_http_create_locations_tree(cf, locations, prefix);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;left == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_queue_remove(q);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(&amp;tail)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> inclusive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 右子树执行构建</span></span><br><span class="line">    node-&gt;right = ngx_http_create_locations_tree(cf, &amp;tail, prefix);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">inclusive:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_queue_empty(&amp;lq-&gt;<span class="built_in">list</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node-&gt;tree = ngx_http_create_locations_tree(cf, &amp;lq-&gt;<span class="built_in">list</span>, prefix + len);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;tree == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构建出的ngx_http_location_tree_node_t结构为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_location_tree_node_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>   *left; <span class="comment">// 左子树</span></span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>   *right; <span class="comment">// 右子树</span></span><br><span class="line">    <span class="keyword">ngx_http_location_tree_node_t</span>   *tree; <span class="comment">// 当前location对应的list(前缀匹配列表)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *exact;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>        *inclusive;</span><br><span class="line"></span><br><span class="line">    u_char                           auto_redirect;</span><br><span class="line">    u_char                           len;</span><br><span class="line">    u_char                           name[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="http头初始化"><a href="#http头初始化" class="headerlink" title="http头初始化"></a>http头初始化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ngx_http_init_headers_in_hash(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    return NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于每一个http头会对应到一个结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        offset;</span><br><span class="line">    ngx_http_header_handler_pt        handler;</span><br><span class="line">&#125; <span class="keyword">ngx_http_header_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中handler为请求中存在该头时的处理函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_headers_in_hash(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>         headers_in;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>     *hk;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>     hash;</span><br><span class="line">    <span class="keyword">ngx_http_header_t</span>  *header;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;headers_in, cf-&gt;temp_pool, <span class="number">32</span>, <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_key_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// nginx默认包含的一批http头部，并包含对其处理，即handler函数，如Host、Connection等</span></span><br><span class="line">    <span class="keyword">for</span> (header = ngx_http_headers_in; header-&gt;name.len; header++) &#123;</span><br><span class="line">        hk = ngx_array_push(&amp;headers_in);</span><br><span class="line">        <span class="keyword">if</span> (hk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hk-&gt;key = header-&gt;name;</span><br><span class="line">        hk-&gt;key_hash = ngx_hash_key_lc(header-&gt;name.data, header-&gt;name.len);</span><br><span class="line">        hk-&gt;value = header;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// http的请求头构成的hash结构，存储于main级别创建的ngx_http_core_main_conf_t的headers_in_hash</span></span><br><span class="line">    hash.hash = &amp;cmcf-&gt;headers_in_hash;</span><br><span class="line">    <span class="comment">// 构建hash转换的函数</span></span><br><span class="line">    hash.key = ngx_hash_key_lc;</span><br><span class="line">    <span class="comment">// 最大允许的桶数量</span></span><br><span class="line">    hash.max_size = <span class="number">512</span>;</span><br><span class="line">    <span class="comment">// 每个桶最大包含的字节数</span></span><br><span class="line">    hash.bucket_size = ngx_align(<span class="number">64</span>, ngx_cacheline_size);</span><br><span class="line">    <span class="comment">// hash表名，用户日志记录</span></span><br><span class="line">    hash.name = <span class="string">"headers_in_hash"</span>;</span><br><span class="line">    hash.pool = cf-&gt;pool;</span><br><span class="line">    hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 构建hash表，详见散列表</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_init(&amp;hash, headers_in.elts, headers_in.nelts) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理阶段"><a href="#处理阶段" class="headerlink" title="处理阶段"></a>处理阶段</h2><p>main级别创建的ngx_http_core_main_conf_t的phases字段管理http处理阶段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">ngx_http_phase_t</span>           phases[NGX_HTTP_LOG_PHASE + <span class="number">1</span>];</span><br><span class="line">&#125; <span class="keyword">ngx_http_core_main_conf_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                handlers;</span><br><span class="line">&#125; <span class="keyword">ngx_http_phase_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_handler_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r)</span></span>;</span><br></pre></td></tr></table></figure>
<p>每一个阶段对应一个函数列表，每个阶段执行时，依次执行。</p>
<p>存在如下阶段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">// 收到完整的http头部后处理的阶段</span></span><br><span class="line">    NGX_HTTP_POST_READ_PHASE = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在将请求的URI与location表达式匹配前，修改请求的URI（所谓重定向）是一个独立的http阶段</span></span><br><span class="line">    NGX_HTTP_SERVER_REWRITE_PHASE,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据请求的URI寻找匹配的location表达式，该阶段只能由ngx_http_core_module模块实现，不建议其他HTTP模块重新定义该阶段</span></span><br><span class="line">    NGX_HTTP_FIND_CONFIG_PHASE,</span><br><span class="line">    <span class="comment">// 在NGX_HTTP_FIND_CONFIG_PHASE阶段寻找到匹配的location之后再修改请求的URI</span></span><br><span class="line">    NGX_HTTP_REWRITE_PHASE,</span><br><span class="line">    <span class="comment">// 该阶段是用于rewrite重新URI后，防止错误的配置导致死循环。控制方式是检查rewrite次数，超过10次就认为是有死循环，该阶段就返回500，表示服务器内部错误</span></span><br><span class="line">    NGX_HTTP_POST_REWRITE_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理NGX_HTTP_ACCESS_PHASE阶段决定访问权限前，http模块可以介入的阶段</span></span><br><span class="line">    NGX_HTTP_PREACCESS_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让HTTP模块判断是否允许这个请求访问nginx服务</span></span><br><span class="line">    NGX_HTTP_ACCESS_PHASE,</span><br><span class="line">    <span class="comment">// 在NGX_HTTP_ACCESS_PHASE阶段，如果http模块的handler处理函数返回不允许访问的错误码时，这里负责向用户发送拒绝服务的错误</span></span><br><span class="line">    NGX_HTTP_POST_ACCESS_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    NGX_HTTP_PRECONTENT_PHASE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于处理HTTP请求内容的阶段，是大部分http模块介入的阶段</span></span><br><span class="line">    NGX_HTTP_CONTENT_PHASE,</span><br><span class="line">    <span class="comment">// 处理完成后记录日志的阶段</span></span><br><span class="line">    NGX_HTTP_LOG_PHASE</span><br><span class="line">&#125; ngx_http_phases;</span><br></pre></td></tr></table></figure>
<p>有些阶段是必须的，有些阶段是可选的。上述11个阶段中NGX_HTTP_FIND_CONFIG_PHASE、NGX_HTTP_POST_REWRITE_PHASE、NGX_HTTP_POST_ACCESS_PHASE三个阶段不允许http模块加入增加的ngx_http_handler_pt方法处理用户请求，其仅由http框架实现。</p>
<h3 id="初始化处理阶段"><a href="#初始化处理阶段" class="headerlink" title="初始化处理阶段"></a>初始化处理阶段</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化处理阶段</span></span><br><span class="line"><span class="keyword">if</span> (ngx_http_init_phases(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 每个模块在postconfiguration中可以在每个阶段中增加处理</span></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span> = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;postconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">....</span><br><span class="line">*cf = pcf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ngx_http_init_phase_handlers(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ngx_http_init_phases方法会初始化必须的处理阶段到main级别创建的ngx_http_core_main_conf_t中的phases中。其中phases是一个存储每个阶段处理函数的临时变量。处理方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_phases(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 阶段0</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_POST_READ_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段1</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_SERVER_REWRITE_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段3</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段5</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段6</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_ACCESS_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">2</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段8</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_PRECONTENT_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">2</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 阶段9</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_CONTENT_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">4</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 阶段10</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;phases[NGX_HTTP_LOG_PHASE].handlers,</span><br><span class="line">                       cf-&gt;pool, <span class="number">1</span>, <span class="keyword">sizeof</span>(ngx_http_handler_pt))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在http初始化过程中，任何HTTP模块都可以在postconfiguration中增加自定义的方法到phases中某个阶段的数组中。</p>
<p>例如：ngx_http_index_module模块的postconfiguration方法ngx_http_index_init会添加NGX_HTTP_CONTENT_PHASE阶段处理方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_index_init(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    h = ngx_array_push(&amp;cmcf-&gt;phases[NGX_HTTP_CONTENT_PHASE].handlers);</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *h = ngx_http_index_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的NGX_HTTP_CONTENT_PHASE由ngx_http_static_module模块添加。</p>
<h3 id="请求处理阶段"><a href="#请求处理阶段" class="headerlink" title="请求处理阶段"></a>请求处理阶段</h3><p>phases只是临时存储请求阶段，真正请求时，使用的是phase_engine字段。先看一下其结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">ngx_http_phase_engine_t</span>    phase_engine;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">ngx_http_core_main_conf_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span>  *handlers; <span class="comment">// 由ngx_http_phase_handler_t构成的数组首地址，表示一个请求可能经历的所有ngx_http_phase_handler_t处理方法</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 server_rewrite_index; <span class="comment">// 表示NGX_HTTP_SERVER_REWRITE_PHASE阶段的第一个ngx_http_phase_handler_t处理方法在handlers中的下标。用于执行任意http请求时，快速跳转到NGX_HTTP_SERVER_REWRITE_PHASE处理阶段</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 location_rewrite_index;<span class="comment">// 表示NGX_HTTP_REWRITE_PHASE阶段的第一个ngx_http_phase_handler_t处理方法在handlers中的下标。用于执行任意http请求时，快速跳转到NGX_HTTP_REWRITE_PHASE处理阶段</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_phase_engine_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_phase_handler_s</span>  <span class="title">ngx_http_phase_handler_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个http处理阶段的checker检查方法，仅由http框架实现，以控制http的处理流程</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_phase_handler_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_phase_handler_t</span> *ph)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_phase_handler_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 在处理到某一个http阶段时，框架会首先在checker方法已实现的基础上先调用checker方法来处理请求，而不会调用任何阶段的handler方法。只有在checker方法中才会调用handler方法。所有checker方法均通过ngx_http_core_module模块实现，普通http模块无法重新定义 */</span></span><br><span class="line">    ngx_http_phase_handler_pt  checker;</span><br><span class="line">    <span class="comment">/* 除ngx_http_core_module模块以外的模块，只能通过定义handler方法才能介入某一个http处理阶段的处理 */</span></span><br><span class="line">    ngx_http_handler_pt        handler;</span><br><span class="line">    <span class="comment">/* next使得处理阶段可以不按照handlers定义的数组顺序执行，即可以向前跳跃数个阶段，执行之前执行过的方法，也可以向后跳跃数个阶段。通常，next表示下一个处理阶段中第一个ngx_http_phase_handler_s下标，next是用来跳转处理的过程，如何使用取决于每个阶段的处理逻辑，大部分时候还都是按照顺序，依次执行，并不是都使用next进行跳转 */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在经过初始化处理阶段后，就会执行ngx_http_init_phase_handlers方法来确定阶段执行顺序。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_init_phase_handlers(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_core_main_conf_t</span> *cmcf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   j;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="comment">// find_config_index表示NGX_HTTP_FIND_CONFIG_PHASE阶段对应的在handlers中的索引。use_rewrite, use_access表示，是否使用了NGX_HTTP_REWRITE_PHASE阶段和NGX_HTTP_ACCESS_PHASE阶段（默认使用）</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  find_config_index, use_rewrite, use_access;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="keyword">ngx_http_phase_handler_t</span>   *ph;</span><br><span class="line">    ngx_http_phase_handler_pt   checker;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;phase_engine.server_rewrite_index = (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>;</span><br><span class="line">    cmcf-&gt;phase_engine.location_rewrite_index = (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>;</span><br><span class="line">    find_config_index = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 判断是否使用NGX_HTTP_REWRITE_PHASE阶段和NGX_HTTP_ACCESS_PHASE阶段</span></span><br><span class="line">    use_rewrite = cmcf-&gt;phases[NGX_HTTP_REWRITE_PHASE].handlers.nelts ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    use_access = cmcf-&gt;phases[NGX_HTTP_ACCESS_PHASE].handlers.nelts ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NGX_HTTP_FIND_CONFIG_PHASE阶段不允许用户自己添加处理函数，因此不会在phases中存在，因此要自己分配空间</span></span><br><span class="line">    <span class="comment">// 当使用NGX_HTTP_REWRITE_PHASE阶段和NGX_HTTP_ACCESS_PHASE阶段时，就会相应的增加NGX_HTTP_POST_REWRITE_PHASE阶段和NGX_HTTP_POST_ACCESS_PHASE阶段，这两个阶段也是不允许用户自己添加处理函数，因此不会在phases中存在，因此要自己分配空间。</span></span><br><span class="line">    n = <span class="number">1</span>                  <span class="comment">/* find config phase */</span></span><br><span class="line">        + use_rewrite      <span class="comment">/* post rewrite phase */</span></span><br><span class="line">        + use_access;      <span class="comment">/* post access phase */</span></span><br><span class="line">    <span class="comment">// 查找除了上面三个阶段以外，其他阶段总共有多少个处理函数</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) &#123;</span><br><span class="line">        n += cmcf-&gt;phases[i].handlers.nelts;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配空间</span></span><br><span class="line">    ph = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                     n * <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_phase_handler_t</span>) + <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="keyword">if</span> (ph == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;phase_engine.handlers = ph;</span><br><span class="line">    <span class="comment">// n表示下一个要加入到phase_engine数组中元素的下标</span></span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历每个阶段进行处理</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) &#123;</span><br><span class="line">        h = cmcf-&gt;phases[i].handlers.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">        <span class="comment">// NGX_HTTP_SERVER_REWRITE_PHASE阶段，n即当前阶段的第一个ngx_http_phase_handler_s，因此phase_engine.server_rewrite_index指向该值</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_SERVER_REWRITE_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (cmcf-&gt;phase_engine.server_rewrite_index == (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                cmcf-&gt;phase_engine.server_rewrite_index = n;</span><br><span class="line">            &#125;</span><br><span class="line">            checker = ngx_http_core_rewrite_phase;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// NGX_HTTP_FIND_CONFIG_PHASE阶段，由于该阶段不允许用户自定义处理方法，因此直接指定checker方法，将本身添加到phase_engine队列中，忽略用户在phase中增加的处理函数，并使用find_config_index记录该阶段在phase_engine队列的下标，这里未设置next值，与checker函数本身有关，具体参加下一小节</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_FIND_CONFIG_PHASE:</span><br><span class="line">            find_config_index = n;</span><br><span class="line"></span><br><span class="line">            ph-&gt;checker = ngx_http_core_find_config_phase;</span><br><span class="line">            n++;</span><br><span class="line">            ph++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// NGX_HTTP_REWRITE_PHASE阶段，处理逻辑与NGX_HTTP_SERVER_REWRITE_PHASE类似</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_REWRITE_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (cmcf-&gt;phase_engine.location_rewrite_index == (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">                cmcf-&gt;phase_engine.location_rewrite_index = n;</span><br><span class="line">            &#125;</span><br><span class="line">            checker = ngx_http_core_rewrite_phase;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// NGX_HTTP_POST_REWRITE_PHASE阶段，如果用户使用了NGX_HTTP_REWRITE_PHASE阶段，则需要增加该阶段，阶段处理结束后，执行NGX_HTTP_FIND_CONFIG_PHASE阶段，因此next使用之前存储的find_config_index值，且该阶段不允许用户自定义处理函数</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_POST_REWRITE_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (use_rewrite) &#123;</span><br><span class="line">                ph-&gt;checker = ngx_http_core_post_rewrite_phase;</span><br><span class="line">                ph-&gt;next = find_config_index;</span><br><span class="line">                n++;</span><br><span class="line">                ph++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* NGX_HTTP_ACCESS_PHASE阶段，这里在未将该阶段加入phase_engine时，就对n进行增加是和其下一阶段NGX_HTTP_POST_ACCESS_PHASE有关。当存在该阶段时，如果校验权限为无权限时，执行NGX_HTTP_POST_ACCESS_PHASE阶段，这时只需要依次执行phase_engine数组即可，当校验有权限时，则有可能（取决于是要全部校验通过，还是任意一个条件满足）直接跳转到NGX_HTTP_POST_ACCESS_PHASE后面的一个阶段。由于NGX_HTTP_POST_ACCESS_PHASE只会有一个元素，因此这里增加1后，执行的就是NGX_HTTP_POST_ACCESS_PHASE阶段后一个阶段的第一个处理元素。但这里我感觉有一个bug，就是在没有该阶段的时候，即用户未在该阶段注册函数时，就会导致NGX_HTTP_POST_ACCESS_PHASE后面阶段的next指向混乱，不知道是我哪里没看明白还是怎么回事。不过当前默认是存在该模块的（将框架里面的模块会向该模块增加处理函数）*/</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_ACCESS_PHASE:</span><br><span class="line">            checker = ngx_http_core_access_phase;</span><br><span class="line">            n++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 只有当存在NGX_HTTP_ACCESS_PHASE阶段时才会增加该阶段。由于在NGX_HTTP_ACCESS_PHASE阶段已经将n指向了该阶段后的一个阶段的第一个处理元素，因此其next直接使用n即可（正常来说，直接就返回了，也不会有后续处理了）。该阶段不允许用户增加处理函数。</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_POST_ACCESS_PHASE:</span><br><span class="line">            <span class="keyword">if</span> (use_access) &#123;</span><br><span class="line">                ph-&gt;checker = ngx_http_core_post_access_phase;</span><br><span class="line">                ph-&gt;next = n;</span><br><span class="line">                ph++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// NGX_HTTP_CONTENT_PHASE阶段，不允许用户增加自定义处理函数</span></span><br><span class="line">        <span class="keyword">case</span> NGX_HTTP_CONTENT_PHASE:</span><br><span class="line">            checker = ngx_http_core_content_phase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 默认处理模块</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            checker = ngx_http_core_generic_phase;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// n增加当前模块的处理函数数量，这时n就指向了下一个模块的第一个处理元素了（NGX_HTTP_ACCESS_PHASE阶段除外，其在之前先让那个n自增了1）</span></span><br><span class="line">        n += cmcf-&gt;phases[i].handlers.nelts;</span><br><span class="line">        <span class="comment">// 遍历当前阶段的handlers数组，增加phase_engine元素，每个元素的next都设置为下一个阶段的第一个处理函数。但这里赋值顺序和添加顺序是相反的，目前也不知道具体原因</span></span><br><span class="line">        <span class="keyword">for</span> (j = cmcf-&gt;phases[i].handlers.nelts - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            ph-&gt;checker = checker;</span><br><span class="line">            ph-&gt;handler = h[j];</span><br><span class="line">            ph-&gt;next = n;</span><br><span class="line">            ph++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="每个阶段的checker函数"><a href="#每个阶段的checker函数" class="headerlink" title="每个阶段的checker函数"></a>每个阶段的checker函数</h3><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><p>在读取配置项的时候，会对变量进行初始化，包括nginx提供的内置变量和用户配置文件中的变量。</p>
<h2 id="相关结构-1"><a href="#相关结构-1" class="headerlink" title="相关结构"></a>相关结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数分别为请求r，表示变量值的v，以及一个可能使用到的参数data。</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_http_set_variable_pt)</span> <span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_get_variable_pt)</span> <span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_variable_s</span> &#123;</span></span><br><span class="line">    <span class="comment">// 变量名</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                     name;   <span class="comment">/* must be first to build the hash */</span></span><br><span class="line">    <span class="comment">// 如果需要变量最初赋值时就进行变量值的设置，需要实现set_handler方法。内部变量允许在配置中以set的方式重新设置值时，可以实现该方法。</span></span><br><span class="line">    ngx_http_set_variable_pt      set_handler;</span><br><span class="line">    <span class="comment">// 获取变量值方法。nginx官方模块变量解析大都使用该方法。</span></span><br><span class="line">    ngx_http_get_variable_pt      get_handler;</span><br><span class="line">    <span class="comment">// 作为参数传递给get_handler，set_handler方法</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                     data;</span><br><span class="line">    <span class="comment">// 变量特性</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    flags;</span><br><span class="line">    <span class="comment">// 变量值在请求的缓存数组中索引</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                    index;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 变量值是一段连续内存中的字符串，len表示长度</span></span><br><span class="line">    <span class="keyword">unsigned</span>    len:<span class="number">28</span>;</span><br><span class="line">    <span class="comment">// valid表示变量已解析过，数据可用</span></span><br><span class="line">    <span class="keyword">unsigned</span>    valid:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// no_cacheable为1表示变量值不可被缓存，和ngx_http_variable_s中的flag相关</span></span><br><span class="line">    <span class="keyword">unsigned</span>    no_cacheable:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// no_cacheable为1表示变量值解析过，但未找到相应的值</span></span><br><span class="line">    <span class="keyword">unsigned</span>    not_found:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// ngx_http_log_module模块使用，用于日志格式字符转义，其他模块忽略该字段</span></span><br><span class="line">    <span class="keyword">unsigned</span>    escape:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// data指向变量值起始地址</span></span><br><span class="line">    u_char     *data;</span><br><span class="line">&#125; <span class="keyword">ngx_variable_value_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_variable_s中的flag相关取值是如下值的1按位与：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGX_HTTP_VAR_CHANGEABLE   1</code></td>
<td>表示变量值可变，即对同一个请求来说，变量可以被反复修改其值。因此以上定义同一变量名与修改变量等价。</td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_NOCACHEABLE  2</code></td>
<td>不能缓存改变量的值，每次使用变量时都需要重新解析。有些请求的变量会在执行中随着url跳转等动作反复改变。如$uri，如果取上次缓存值，是无法知道是否正确的。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_NOHASH       8</code></td>
<td>不要将该变量hash到散列表。散列表需要消耗空间，如果某个模块设计了一个可选变量提供给其他模块使用，并且要求有其他模块使用该变量时必须索引化再使用（即不能调用ngx_http_get_variable方法获取），这样，这个变量就不用浪费散列表的空间了。</td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_WEAK         16</code></td>
<td>弱变量，对于set设置的变量都是弱变量，如果该变量是前缀变量，则会使用前缀变量的get_handler解析方法。</td>
</tr>
<tr>
<td><code>NGX_HTTP_VAR_PREFIX       32</code></td>
<td>前缀变量，如args_、cookie_、http_等，一般是nginx内置的一系列变量。</td>
</tr>
</tbody>
</table>
</div>
<h3 id="存储变量名的数据结构"><a href="#存储变量名的数据结构" class="headerlink" title="存储变量名的数据结构"></a>存储变量名的数据结构</h3><p>变量被存储在main级别下的ngx_http_core_main_conf_t中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    ngx_hash_t                 variables_hash; // 存储hash过的变量</span><br><span class="line"></span><br><span class="line">    ngx_array_t                variables;         /* ngx_http_variable_t */ // 存储索引过的变量。通过索引获取</span><br><span class="line">    ngx_array_t                prefix_variables;  /* ngx_http_variable_t */ // 前缀变量存储</span><br><span class="line"></span><br><span class="line">    ngx_hash_keys_arrays_t    *variables_keys;   // 构建过程中临时存储，用于方便构建hash表的，hash管理结构，用于构建variables_hash</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125; ngx_http_core_main_conf_t;</span><br></pre></td></tr></table></figure>
<p>对于一个变量，可能存在于多个结构中，即variables_hash或variables或prefix_variables中。这时一个变量可能存在多份ngx_http_variable_t结构，但是需要保证，每个的都要要相等的。保证相等的操作在ngx_http_variables_init_vars方法中完成。具体见下文。</p>
<h2 id="解析变量"><a href="#解析变量" class="headerlink" title="解析变量"></a>解析变量</h2><p>解析变量使用get_handler方法，其原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_get_variable_pt)</span> <span class="params">(<span class="keyword">ngx_http_request_t</span> *r,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中r和data是用来帮助生成变量值，而v是存放值的载体。结构体v已经分配好内存（调用get_handler的函数负责），分配好的内存不包括字符串变量值。可以使用请求r的内存池来分配新的内存放置变量值，这样请求结束，内存就被释放。参数v的data和len成员指向变量值字符串即完成解析。对于data参数来说，存在多种场景。</p>
<h3 id="data参数不起作用"><a href="#data参数不起作用" class="headerlink" title="data参数不起作用"></a>data参数不起作用</h3><p>如果只是生成一些和用户请求无关的变量值，例如时间、系统负载，那么使用各种方法获得变量后赋值给参数v的data和len即可。或者ngx_http_request_t *r中成员已经足够解析出变量值了，data参数不用也可以。</p>
<p>例如，HTTP架构提供的一个变量body_bytes_sent,表示一个请求的响应包体长度，常用在日志中，其解析方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_variable_t</span>  ngx_http_core_variables[] = &#123; </span><br><span class="line">    ...</span><br><span class="line">    &#123; ngx_string(<span class="string">"body_bytes_sent"</span>), <span class="literal">NULL</span>, ngx_http_variable_body_bytes_sent,</span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_body_bytes_sent(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">off_t</span>    sent;</span><br><span class="line">    u_char  *p;</span><br><span class="line">    <span class="comment">// 大小直接通过r就能获取到，不需要data，因此请求是data为0</span></span><br><span class="line">    sent = r-&gt;connection-&gt;sent - r-&gt;header_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        sent = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = ngx_pnalloc(r-&gt;pool, NGX_OFF_T_LEN);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;len = ngx_sprintf(p, <span class="string">"%O"</span>, sent) - p;</span><br><span class="line">    v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">    v-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">    v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">    v-&gt;data = p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="data参数作为指针"><a href="#data参数作为指针" class="headerlink" title="data参数作为指针"></a>data参数作为指针</h3><p>uintptr_t是一个可以放置指针的整型，所以，uintptr_t被设计为即可以用来做整型偏移，也可以做指针。</p>
<p>对于5类前缀字符串，如http_、args_等，实际每个这样的变量其解析方式都大同小异，遍历解析出来的r-&gt;headers_in.headers或者r-&gt;headers_in.headers数组，找到变量名再返回其值。为了设计更加通用，就使用data作为指针指向实际的变量名字符串。如下，当出现如http_这样的变量被模块使用时，就把data作为指针来保存实际的变量名字符串v[i].name（ngx_http_variables_init_vars初始化特殊变量时的代码段）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_strncmp(src[i].key.data, <span class="string">"HTTP_"</span>, <span class="keyword">sizeof</span>(<span class="string">"HTTP_"</span>) - <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    v[i].get_hander = ngx_http_variable_unknown_header_in;</span><br><span class="line">    v[i].data = (<span class="keyword">uintptr_t</span>)&amp;v[i].name;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>解析变量的方法get_hander将data转换为ngx_str_t*</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_unknown_header_in(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ngx_http_variable_unknown_header(v, (<span class="keyword">ngx_str_t</span> *) data,</span><br><span class="line">                                            &amp;r-&gt;headers_in.headers.part,</span><br><span class="line">                                            <span class="keyword">sizeof</span>(<span class="string">"http_"</span>) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ngx_http_variable_unknown_header遍历ngx_list_t链表类型的headers数组，找到符合变量名的头部后，将其值作为变量返回。</p>
<h3 id="data作为内存的相对偏移量"><a href="#data作为内存的相对偏移量" class="headerlink" title="data作为内存的相对偏移量"></a>data作为内存的相对偏移量</h3><p>很多时候，变量值很可能是原始HTTP字符流中的一部分连续字符串，如果能够复用，就不用再为变量分配，拷贝内存了。而且HTTP模块在使用get_handler时，HTTP框架可能在请求的自动解析过程中已经得到了需要的变量值。这就是data参数作为整数设计的目的。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(&quot;http_host&quot;), NULL, ngx_http_variable_header,</span><br><span class="line">      offsetof(ngx_http_request_t, headers_in.host), 0, 0 &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(&quot;http_user_agent&quot;), NULL, ngx_http_variable_header,</span><br><span class="line">      offsetof(ngx_http_request_t, headers_in.user_agent), 0, 0 &#125;,</span><br></pre></td></tr></table></figure>
<p>http_host变量对应于ngx_http_request_t结构体里的headers_in成员的host成员，http_user_agent变量对应ngx_http_request_t结构体里的headers_in成员的user_agent成员。对应的处理函数为ngx_http_variable_header：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_header(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_variable_value_t</span> *v,</span><br><span class="line">    <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>  *h;</span><br><span class="line">    <span class="comment">// 找到对应的内存地址</span></span><br><span class="line">    h = *(<span class="keyword">ngx_table_elt_t</span> **) ((<span class="keyword">char</span> *) r + data);</span><br><span class="line">    <span class="comment">// 赋值</span></span><br><span class="line">    <span class="keyword">if</span> (h) &#123;</span><br><span class="line">        v-&gt;len = h-&gt;value.len;</span><br><span class="line">        v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">        v-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">        v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">        v-&gt;data = h-&gt;value.data;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v-&gt;not_found = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查找变量"><a href="#查找变量" class="headerlink" title="查找变量"></a>查找变量</h2><h3 id="ngx-http-get-variable-index"><a href="#ngx-http-get-variable-index" class="headerlink" title="ngx_http_get_variable_index"></a>ngx_http_get_variable_index</h3><p>设置变量被索引，并获得索引号，这是使用ngx_http_get_indexed_variable、ngx_http_get_flushed_variable方法的前置条件。调用它意味着这个变量会被频繁的使用，希望Nginx处理这个变量时效率更加高，体现在：</p>
<ol>
<li>变量值可以被缓存，重复读取时不用每次都解析。</li>
<li>定义变量的解析方法时，可以通过索引直接查找到该方法进行解析，而不是通过操作散列表。</li>
<li>nginx在初始化http请求时，就需要为这个变量预分配好ngx_http_variable_value_t变量结构体。</li>
</ol>
<p>函数执行逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_get_variable_index(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid variable name \"$\""</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取main级别下的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line">    <span class="comment">// 在variables查找是否存在，如果还没有variables，则分配空间</span></span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;variables, cf-&gt;pool, <span class="number">4</span>,</span><br><span class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_t</span>))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果查找到相同的变量（不区分大小写），则返回当前已经存在的变量的索引</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;variables.nelts; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name-&gt;len != v[i].name.len</span><br><span class="line">                || ngx_strncasecmp(name-&gt;data, v[i].name.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果为查找到相同的变量，添加到variables，返回对于的索引。</span></span><br><span class="line">    v = ngx_array_push(&amp;cmcf-&gt;variables);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;name.len = name-&gt;len;</span><br><span class="line">    v-&gt;name.data = ngx_pnalloc(cf-&gt;pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (v-&gt;name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_strlow(v-&gt;name.data, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    v-&gt;set_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;get_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;data = <span class="number">0</span>;</span><br><span class="line">    v-&gt;flags = <span class="number">0</span>;</span><br><span class="line">    v-&gt;index = cmcf-&gt;variables.nelts - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v-&gt;index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-get-indexed-variable"><a href="#ngx-http-get-indexed-variable" class="headerlink" title="ngx_http_get_indexed_variable"></a>ngx_http_get_indexed_variable</h3><p>根据ngx_http_get_variable_index得到的索引号，获取被索引过的变量的值。若变量被解析过一次后，其值会被缓存，这样该方法再次调用会直接获取缓存过的值，而不是重新解析。该方法忽略NGX_HTTP_VAR_NOCACHEABLE标识。</p>
<p>其方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span> *</span><br><span class="line">ngx_http_get_indexed_variable(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_uint_t</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取这次请求分配的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmcf-&gt;variables.nelts &lt;= index) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"unknown variable index: %ui"</span>, index);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 变量被解析过，无论是否查找到值，都直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;variables[index].not_found || r-&gt;variables[index].valid) &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;r-&gt;variables[index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 防止循环死链，使用ngx_http_variable_depth记录，起始100</span></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_variable_depth == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cycle while evaluating variable \"%V\""</span>,</span><br><span class="line">                      &amp;v[index].name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_variable_depth--;</span><br><span class="line">    <span class="comment">// 执行变量的解析函数成功</span></span><br><span class="line">    <span class="keyword">if</span> (v[index].get_handler(r, &amp;r-&gt;variables[index], v[index].data)</span><br><span class="line">        == NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_http_variable_depth++;</span><br><span class="line">        <span class="comment">// 如果变量是不允许缓存，则增加标志</span></span><br><span class="line">        <span class="keyword">if</span> (v[index].flags &amp; NGX_HTTP_VAR_NOCACHEABLE) &#123;</span><br><span class="line">            r-&gt;variables[index].no_cacheable = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回数据</span></span><br><span class="line">        <span class="keyword">return</span> &amp;r-&gt;variables[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_variable_depth++;</span><br><span class="line">    <span class="comment">// 解析未查找数据，记录状态</span></span><br><span class="line">    r-&gt;variables[index].valid = <span class="number">0</span>;</span><br><span class="line">    r-&gt;variables[index].not_found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-get-flushed-variable"><a href="#ngx-http-get-flushed-variable" class="headerlink" title="ngx_http_get_flushed_variable"></a>ngx_http_get_flushed_variable</h3><p>该方法与ngx_http_get_indexed_variable类似，不过其不忽略NGX_HTTP_VAR_NOCACHEABLE标识。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span> *</span><br><span class="line">ngx_http_get_flushed_variable(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_uint_t</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *v;</span><br><span class="line"></span><br><span class="line">    v = &amp;r-&gt;variables[index];</span><br><span class="line">    <span class="comment">// 如果变量被解析过</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;valid || v-&gt;not_found) &#123;</span><br><span class="line">        <span class="comment">// 如果变量可以被缓存，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!v-&gt;no_cacheable) &#123;</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则，表示变量未被解析过</span></span><br><span class="line">        v-&gt;valid = <span class="number">0</span>;</span><br><span class="line">        v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行解析</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_get_indexed_variable(r, index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-get-value"><a href="#ngx-http-get-value" class="headerlink" title="ngx_http_get_value"></a>ngx_http_get_value</h3><p>根据变量名称，从hash过的散列表中找到对应的变量，并调用其解析方法，获得值，这里不存在缓存变量值的可能。同时前缀变量也可以从该方法中获取解析值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span> *</span><br><span class="line">ngx_http_get_variable(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_str_t</span> *name, <span class="keyword">ngx_uint_t</span> key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *vv;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 在散列表中查找对于的变量</span></span><br><span class="line">    v = ngx_hash_find(&amp;cmcf-&gt;variables_hash, key, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v) &#123;</span><br><span class="line">        <span class="comment">// 如果变量被找到，并且已经被索引，则优先使用索引列表里面的值</span></span><br><span class="line">        <span class="keyword">if</span> (v-&gt;flags &amp; NGX_HTTP_VAR_INDEXED) &#123;</span><br><span class="line">            <span class="keyword">return</span> ngx_http_get_flushed_variable(r, v-&gt;index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_variable_depth == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"cycle while evaluating variable \"%V\""</span>, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_variable_depth--;</span><br><span class="line"></span><br><span class="line">        vv = ngx_palloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_value_t</span>));</span><br><span class="line">        <span class="comment">// 调用变量的解析方法</span></span><br><span class="line">        <span class="keyword">if</span> (vv &amp;&amp; v-&gt;get_handler(r, vv, v-&gt;data) == NGX_OK) &#123;</span><br><span class="line">            ngx_http_variable_depth++;</span><br><span class="line">            <span class="keyword">return</span> vv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_variable_depth++;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vv = ngx_palloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_value_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (vv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 在前缀变量中查找</span></span><br><span class="line">    v = cmcf-&gt;prefix_variables.elts;</span><br><span class="line">    n = cmcf-&gt;prefix_variables.nelts;</span><br><span class="line">    <span class="comment">// 找到最长匹配的一个变量（这里只有5个http_,arg_,cookie_,sent_trailer_,sent_http_）</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;prefix_variables.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len &gt;= v[i].name.len &amp;&amp; name-&gt;len &gt; len</span><br><span class="line">            &amp;&amp; ngx_strncmp(name-&gt;data, v[i].name.data, v[i].name.len) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            len = v[i].name.len;</span><br><span class="line">            n = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用对应的解析方法</span></span><br><span class="line">    <span class="keyword">if</span> (n != cmcf-&gt;prefix_variables.nelts) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v[n].get_handler(r, vv, (<span class="keyword">uintptr_t</span>) name) == NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> vv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未查到</span></span><br><span class="line">    vv-&gt;not_found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="添加系统变量"><a href="#添加系统变量" class="headerlink" title="添加系统变量"></a>添加系统变量</h2><p>内部变量会在系统初始化是定义。赋值是在需要使用该变量时才赋值，而不是请求到达后就优先赋值。查找变量的方式为根据索引找到系统中相应的变量或者通过hash表来进行查找。</p>
<p>系统变量定义都是在执行模块的<code>proconfiguration</code>阶段。该方法添加变量到main级别创建的ngx_http_core_main_conf_t的variables_keys（散列表）或prefix_variables（数组）中。例如，对于核心模块ngx_http_core_module对应的方法ngx_http_core_preconfiguration：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_core_preconfiguration(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ngx_http_variables_add_core_vars(cf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variables_add_core_vars(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *cv, *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line">    <span class="comment">// 获取main级别创建的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 分配variables_keys内存</span></span><br><span class="line">    cmcf-&gt;variables_keys = ngx_pcalloc(cf-&gt;temp_pool,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_hash_keys_arrays_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (cmcf-&gt;variables_keys == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;variables_keys-&gt;pool = cf-&gt;pool;</span><br><span class="line">    cmcf-&gt;variables_keys-&gt;temp_pool = cf-&gt;pool;</span><br><span class="line">    <span class="comment">// 初始化散列表管理结构ngx_hash_keys_arrays_t</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_keys_array_init(cmcf-&gt;variables_keys, NGX_HASH_SMALL)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化前缀变量的列表</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_array_init(&amp;cmcf-&gt;prefix_variables, cf-&gt;pool, <span class="number">8</span>,</span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历每一个nginx预设的系统变量，将其添加到对应的结构中（前缀列表或者散列表管理结构）.ngx_http_core_variables包含了大量nginx预设变量，如http_host、http_cookie、cookie_</span></span><br><span class="line">    <span class="keyword">for</span> (cv = ngx_http_core_variables; cv-&gt;name.len; cv++) &#123;</span><br><span class="line">        v = ngx_http_add_variable(cf, &amp;cv-&gt;name, cv-&gt;flags);</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *v = *cv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//部分ngx_http_core_variables</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_variable_t</span>  ngx_http_core_variables[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http_host"</span>), <span class="literal">NULL</span>, ngx_http_variable_header,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, headers_in.host), <span class="number">0</span>, <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http_user_agent"</span>), <span class="literal">NULL</span>, ngx_http_variable_header,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, headers_in.user_agent), <span class="number">0</span>, <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">"http_referer"</span>), <span class="literal">NULL</span>, ngx_http_variable_header,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, headers_in.referer), <span class="number">0</span>, <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-http-add-variable"><a href="#ngx-http-add-variable" class="headerlink" title="ngx_http_add_variable"></a>ngx_http_add_variable</h3><p>其中ngx_http_add_variable函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_t</span> *</span><br><span class="line">ngx_http_add_variable(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *name, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// name为变量名称，flags为ngx_http_variable_s中的flag。返回值为已经准备好的ngx_http_variable_t。这时需要在返回值在添加解析方法set/get_handler,h和data。</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>             *key;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid variable name \"$\""</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是前缀变量，则使用ngx_http_add_prefix_variable添加</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; NGX_HTTP_VAR_PREFIX) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_add_prefix_variable(cf, name, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    key = cmcf-&gt;variables_keys-&gt;keys.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;variables_keys-&gt;keys.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len != key[i].key.len</span><br><span class="line">            || ngx_strncasecmp(name-&gt;data, key[i].key.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v = key[i].value;</span><br><span class="line">        <span class="comment">// 如果变量是不可变更的，并且现在已经存在该变量，即出现重复添加，则报错</span></span><br><span class="line">        <span class="keyword">if</span> (!(v-&gt;flags &amp; NGX_HTTP_VAR_CHANGEABLE)) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"the duplicate \"%V\" variable"</span>, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; NGX_HTTP_VAR_WEAK)) &#123;</span><br><span class="line">            v-&gt;flags &amp;= ~NGX_HTTP_VAR_WEAK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配空间，赋值</span></span><br><span class="line">    v = ngx_palloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_variable_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;name.len = name-&gt;len;</span><br><span class="line">    v-&gt;name.data = ngx_pnalloc(cf-&gt;pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (v-&gt;name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用小写存储变量名</span></span><br><span class="line">    ngx_strlow(v-&gt;name.data, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    v-&gt;set_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;get_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;data = <span class="number">0</span>;</span><br><span class="line">    v-&gt;flags = flags;</span><br><span class="line">    v-&gt;index = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 将变量添加到variables_keys散列表中,散列表添加元素见上文,这里添加的变量是不带通配符的变量，这里增加的变量也不允许重复</span></span><br><span class="line">    rc = ngx_hash_add_key(cmcf-&gt;variables_keys, &amp;v-&gt;name, v, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"conflicting variable name \"%V\""</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_add_prefix_variable如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_variable_t</span> *</span><br><span class="line">ngx_http_add_prefix_variable(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_str_t</span> *name, <span class="keyword">ngx_uint_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    v = cmcf-&gt;prefix_variables.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;prefix_variables.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len != v[i].name.len</span><br><span class="line">            || ngx_strncasecmp(name-&gt;data, v[i].name.data, name-&gt;len) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v = &amp;v[i];</span><br><span class="line">        <span class="comment">// 对于已定义过的，并且为不可变的变量，重复定义报错</span></span><br><span class="line">        <span class="keyword">if</span> (!(v-&gt;flags &amp; NGX_HTTP_VAR_CHANGEABLE)) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">"the duplicate \"%V\" variable"</span>, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; NGX_HTTP_VAR_WEAK)) &#123;</span><br><span class="line">            v-&gt;flags &amp;= ~NGX_HTTP_VAR_WEAK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加到表中（这时可能一个变量在表中有两个元素）</span></span><br><span class="line">    v = ngx_array_push(&amp;cmcf-&gt;prefix_variables);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;name.len = name-&gt;len;</span><br><span class="line">    v-&gt;name.data = ngx_pnalloc(cf-&gt;pool, name-&gt;len);</span><br><span class="line">    <span class="keyword">if</span> (v-&gt;name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_strlow(v-&gt;name.data, name-&gt;data, name-&gt;len);</span><br><span class="line"></span><br><span class="line">    v-&gt;set_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;get_handler = <span class="literal">NULL</span>;</span><br><span class="line">    v-&gt;data = <span class="number">0</span>;</span><br><span class="line">    v-&gt;flags = flags;</span><br><span class="line">    v-&gt;index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上可以看出，只有前缀并且设置可以变更的变量，可以重复添加。</p>
<h2 id="外部变量和脚本引擎"><a href="#外部变量和脚本引擎" class="headerlink" title="外部变量和脚本引擎"></a>外部变量和脚本引擎</h2><p>出了上文提到的使用模块的<code>preconfiguration</code>方法来添加变量以外，还可以使用ngx_http_rewrite_moduel模块提供的set配置。其使用了Nginx的脚本引擎。</p>
<p>变量名称在nginx.conf的配置文件里声明，且在配置文件中确定了变量的赋值。模块定义外部变量的格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set $variable value</span><br></pre></td></tr></table></figure>
<p>配置通过set关键字定义了一个在nginx.conf中指定的新变量variable，并将其赋值为value。value可以是一个文本字符串，还可以包含多个变量，也可以是变量与文本字符串的组合。</p>
<h3 id="相关数据结构-2"><a href="#相关数据结构-2" class="headerlink" title="相关数据结构"></a>相关数据结构</h3><p>同一段脚本被编译进nginx中，在不同请求中执行效果是不一样的，所以每个请求都必须有其独特的脚本执行上下文，或者称为脚本引擎。这由ngx_http_script_engine_t类充当：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 执行待执行的脚本指令</span></span><br><span class="line">    u_char                     *ip;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    u_char                     *pos;</span><br><span class="line">    <span class="comment">// 变量构成的栈</span></span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>  *sp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   buf;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   line;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the start of the rewritten arguments */</span></span><br><span class="line">    u_char                     *args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                    flushed:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    skip:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    quote:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    is_args:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    <span class="built_in">log</span>:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 脚本执行状态</span></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                   status;</span><br><span class="line">    <span class="comment">// 执行当前脚本引擎所属的HTTP请求</span></span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>         *request;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_engine_t</span>;</span><br></pre></td></tr></table></figure>
<p>sp是一个栈，作为编译工具。大小默认为10.</p>
<p>ip可以理解为IP寄存器，指向下一行将要执行的代码。对于u_char*类型来说，其指向类型是不定的。其指向的一定是待执行的脚本指令。用面向对象的语言来说，其指向的是实现了ngx_http_script_code_pt接口的类。但C语言没有接口的概念，在C语言实现上述目的，通常会使用嵌套结构体的方法，比如表示接口的结构体A，要放在表示实现接口的类-结构体B的第一个位置。这样一个指向B的指针，也可以强制转换为A，再调用A的成员。ngx_http_script_code_pt是一个指针函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*ngx_http_script_code_pt) (ngx_http_script_engine_t *e);</span><br></pre></td></tr></table></figure>
<p>ngx_http_script_code_pt参数ngx_http_script_engine_t，其表示当前指令的脚本上下文。</p>
<p>ngx_http_script_code_pt相当于抽象基类的一个接口，会有相应的结构体担当类的角色。对于”set”配置来说，编译变量名（即第一个参数）由一个实现了ngx_http_script_code_pt接口的类担当，这个类为ngx_http_script_var_code_t：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 本例中指向方法为ngx_http_script_set_var_code</span></span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    <span class="comment">// 表示ngx_http_request_t中被索引、缓存的变量数组值variables中，当前解析的、set设置的外部变量是在的索引</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   index;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_var_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>第一个成员是ngx_http_script_code_pt，因此可以把ngx_http_script_var_code_t强制转换为ngx_http_script_code_pt执行。</p>
<p>set的第2个参数是变量值，其也需要一个结构体ngx_http_script_value_code_t来编译，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 本例中执行的方法为ngx_http_script_value_code</span></span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    <span class="comment">// 若外部变量是整数，则转换为整数赋值给value，否则value为0</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   value;</span><br><span class="line">    <span class="comment">// 外部变量值（set的第二个参数）长度</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   text_len;</span><br><span class="line">    <span class="comment">// 外部变量值的起始地址</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>                   text_data;</span><br><span class="line">&#125; <span class="keyword">ngx_http_script_value_code_t</span>;</span><br></pre></td></tr></table></figure>
<p>为何一行set脚本分别由编译变量名、编译变量值的2个结构来表示呢。因为对于set有很多不同的使用场景，对变量名来说，就存在变量名首次出现与非首次出现，而变量值有纯文字、字符串与其他变量组合等情况。把变量名的编译提取为ngx_http_script_var_code_t结构体，使所以变量名的编译可以复用其index成员，而具体的ngx_http_script_code_pt指令则可以各组实现。把变量值的编译提取为ngx_http_script_value_code_t结构体，则可以复用text_len、text_data成员。</p>
<p>ngx_http_script_engine_t随着HTTP请求到来才创建，所以其无法保存Nginx启动时就编译出的脚本。保存编译后的脚本工作由ngx_http_rewrite_loc_conf_t结构承担。其是ngx_http_rewrite_module_ctx模块在location级别的配置结构体。其定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 保存所属location下的所有编译后的脚本（按照顺序）</span><br><span class="line">    ngx_array_t  *codes;        /* uintptr_t */</span><br><span class="line">    // 每一个请求的ngx_http_script_engine_t脚本引擎中都有一个变量值栈，即上文的ngx_http_script_engine_t的sp，其大小为stack_size</span><br><span class="line">    ngx_uint_t    stack_size;</span><br><span class="line"></span><br><span class="line">    ngx_flag_t    log;</span><br><span class="line">    ngx_flag_t    uninitialized_variable_warn;</span><br><span class="line">&#125; ngx_http_rewrite_loc_conf_t;</span><br></pre></td></tr></table></figure>
<p>如果location下没有脚本式配置，那么其成员codes数组就是空的，否则codes数组会放置承载者被解析后的脚本指令的结构体。</p>
<p>codes数组设置比较独特。脚本指令都是实现了”接口ngx_http_script_code_pt”的各个不同的充当类的结构体，这些结构体可以是ngx_http_script_var_code_t、ngx_http_script_value_code_t等，其类型不同，占用的内存也不同，如何放入一个数组中呢（不是它们的指针）。通过如下三点做到：</p>
<ol>
<li><p>codes数组设计每个元素仅占用1字节大小，即不奢望一个数组元素能够存放表示一个脚本指令的结构体。</p>
</li>
<li><p>每次要将1个指令放入codes数组中时，将根据指令结构体的占用内存字节数N，在codes数组中分配N个元素存储这1个指令，再依次把指令结构体的内容都拷贝到这N个数组成员中。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">ngx_http_script_start_code(<span class="keyword">ngx_pool_t</span> *pool, <span class="keyword">ngx_array_t</span> **codes, <span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (*codes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *codes = ngx_array_create(pool, <span class="number">256</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (*codes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_array_push_n(*codes, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HTTP请求到来，脚本指令执行时，每执行完一个脚本指令的ngx_http_script_code_pt方法后，该方法必须主动告知所属指令结构体占用的内存数N，这样从当前指令所在codes数组索引加上N后就是下一条指令。</p>
</li>
</ol>
<p>下图展示了两个请求到来时，解析外部变量的流程：</p>
<p><a href="https://imgtu.com/i/WzSSNq" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/08/01/WzSSNq.png" alt="WzSSNq.png"></a></p>
<p>图中以<code>set $variable value</code>作为例子，脚本由右向左解析为ngx_http_script_value_code_t,ngx_http_script_var_code_t。</p>
<p>两个http请求（A和B）同时执行到该脚本，其中A请求正准备执行value指令的ngx_http_script_value_code_t，而B请求已经执行完值的入栈，正要执行ngx_http_script_var_code_t。ngx_http_script_engine_t脚本引擎的sp成员始终指向变量值正要操作的值，而ip成员则始终指向将要执行的下一条指令结构体。</p>
<h3 id="编译set脚本"><a href="#编译set脚本" class="headerlink" title="编译set脚本"></a>编译set脚本</h3><p>编译流程如下：</p>
<p><img src="/Users/wangyinkui/Library/Application Support/typora-user-images/image-20210801153020166.png" alt="image-20210801153020166"></p>
<p>执行流程为：</p>
<p><a href="https://imgtu.com/i/fFttns" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/08/03/fFttns.png" alt="fFttns.png"></a></p>
<p>set在ngx_http_rewrite_module模块的配置如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; ngx_string(<span class="string">"set"</span>),</span><br><span class="line">  NGX_HTTP_SRV_CONF|NGX_HTTP_SIF_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                   |NGX_CONF_TAKE2,</span><br><span class="line">  ngx_http_rewrite_set,</span><br><span class="line">  NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="literal">NULL</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_rewrite_set函数逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_rewrite_set(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_rewrite_loc_conf_t</span>  *lcf = conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                            index;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                           *value;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>                 *v;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>          *vcode;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_handler_code_t</span>  *vhcode;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 判断第一个参数第一个字符是否为$</span></span><br><span class="line">    <span class="keyword">if</span> (value[<span class="number">1</span>].data[<span class="number">0</span>] != <span class="string">'$'</span>) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"invalid variable name \"%V\""</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去除$字符</span></span><br><span class="line">    value[<span class="number">1</span>].len--;</span><br><span class="line">    value[<span class="number">1</span>].data++;</span><br><span class="line">    <span class="comment">// 将变量添加到variable_keys中</span></span><br><span class="line">    v = ngx_http_add_variable(cf, &amp;value[<span class="number">1</span>],</span><br><span class="line">                              NGX_HTTP_VAR_CHANGEABLE|NGX_HTTP_VAR_WEAK);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将变量索引化，返回变量索引的下标</span></span><br><span class="line">    index = ngx_http_get_variable_index(cf, &amp;value[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (index == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果get_handler为空，就重新设置变量的get_handler函数</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;get_handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        v-&gt;get_handler = ngx_http_rewrite_var;</span><br><span class="line">        v-&gt;data = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理变量值</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_rewrite_value(cf, lcf, &amp;value[<span class="number">2</span>]) != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果变量存在set_handler函数，则设置对应的ngx_http_script_var_handler_code_t来对变量赋值</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;set_handler) &#123;</span><br><span class="line">        vhcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                   <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_handler_code_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (vhcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vhcode-&gt;code = ngx_http_script_var_set_handler_code;</span><br><span class="line">        vhcode-&gt;handler = v-&gt;set_handler;</span><br><span class="line">        <span class="comment">// 这里的data是set设置后的data，而非原始的data。</span></span><br><span class="line">        vhcode-&gt;data = v-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果变量没有设置set_handler函数，则使用ngx_http_script_var_code_t结构对变量赋值</span></span><br><span class="line">    vcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                       <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (vcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vcode-&gt;code = ngx_http_script_set_var_code;</span><br><span class="line">    vcode-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第四步中，内部变量的get_handler方法是必须实现的，因此通常都是采用惰性求值，即只有读取到这个变量时才会调用get_handler计算出这个值。然而外部变量是不同的。每一次set都会立即给变量重新赋值，同时读取变量时，因为变量值被索引化的，所有可以直接从请求的variables数组里取到set后的值。这样get_handler似乎是没有用的。然而，可能有某些模块会在set脚本执行前就使用外部变量了，此时外部变量的值是不存在的，即缓存的variables数组里变量是空的。因此这里将get_handler定义为ngx_http_rewrite_var，其功能就是在调用时将变量设置为空值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_http_variable_value_t</span>  ngx_http_variable_null_value =</span><br><span class="line">    ngx_http_variable(<span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<p>对于处理变量值，即value[2]较为复杂。首先定义了两个新的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_conf_t</span>                 *cf; <span class="comment">// 配置</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  *source; <span class="comment">// 需要compile的字符串</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               **flushes; <span class="comment">// 该结构也用于正则匹配，该成员，构建为变量为$1,$2...这种时，存储每个变量对应于哪一个，构成一个数组</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               **lengths; <span class="comment">//处理变量长度的处理子数组，需要执行ngx_http_script_code_pt构成的列表,这里是生成值时执行ngx_http_script_code_pt的列表</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               **values; <span class="comment">// 处理变量内容的处理子数组，对应于rewrite模块的locations层级下的codes执行数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  variables; <span class="comment">// 值中含有变量的数量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  ncaptures; <span class="comment">// 当前处理时，出现的$n变量的最大值，如配置的最大为$3，那么ncaptures就等于3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 以位移的形式保存$1,$2...$9等变量，即响应位置上置1来表示，主要的作用是为dup_capture准备，</span></span><br><span class="line"><span class="comment">     * 正是由于这个mask的存在，才比较容易得到是否有重复的$n出现。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  captures_mask;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * ngx_http_script_regex_code_t的结构</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span>                       *main;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                    compile_args:<span class="number">1</span>; <span class="comment">// 是否需要处理请求参数</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    complete_lengths:<span class="number">1</span>; <span class="comment">// 是否设置lengths数组的终止符，即NULL</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    complete_values:<span class="number">1</span>; <span class="comment">// 是否设置values数组的终止符</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    zero:<span class="number">1</span>; <span class="comment">// values数组运行时，得到的字符串是否追加'\0'结尾</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    conf_prefix:<span class="number">1</span>; <span class="comment">// 是否在生成的文件名前，追加路径前缀</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    root_prefix:<span class="number">1</span>; <span class="comment">// 同conf_prefix</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 这个标记位主要在rewrite模块里使用，在ngx_http_rewrite中，</span></span><br><span class="line"><span class="comment">     * if (sc.variables == 0 &amp;&amp; !sc.dup_capture) &#123;</span></span><br><span class="line"><span class="comment">     *     regex-&gt;lengths = NULL;</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     * 没有重复的$n，那么regex-&gt;lengths被置为NULL，这个设置很关键，在函数</span></span><br><span class="line"><span class="comment">     * ngx_http_script_regex_start_code中就是通过对regex-&gt;lengths的判断，来做不同的处理，</span></span><br><span class="line"><span class="comment">     * 因为在没有重复的$n的时候，可以通过正则自身的captures机制来获取$n，一旦出现重复的，</span></span><br><span class="line"><span class="comment">     * 那么pcre正则自身的captures并不能满足我们的要求，我们需要用自己handler来处理。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    dup_capture:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                    args:<span class="number">1</span>; <span class="comment">// 待compile的字符串中是否发现了'?'</span></span><br><span class="line">&#125; <span class="keyword">ngx_http_script_compile_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   value;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 *flushes;</span><br><span class="line">    <span class="keyword">void</span>                       *lengths; <span class="comment">// 需要执行ngx_http_script_code_pt构成的列表,这里是生成值时执行ngx_http_script_code_pt的列表</span></span><br><span class="line">    <span class="keyword">void</span>                       *values;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">size_t</span>                  size;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125; <span class="keyword">ngx_http_complex_value_t</span>;</span><br></pre></td></tr></table></figure>
<p>具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">ngx_http_rewrite_value(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_http_rewrite_loc_conf_t</span> *lcf,</span><br><span class="line">    <span class="keyword">ngx_str_t</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                              n;</span><br><span class="line">    <span class="keyword">ngx_http_script_compile_t</span>              sc;</span><br><span class="line">    <span class="keyword">ngx_http_script_value_code_t</span>          *val;</span><br><span class="line">    <span class="keyword">ngx_http_script_complex_value_code_t</span>  *<span class="keyword">complex</span>;</span><br><span class="line">    <span class="comment">// 根据$数量计算其中含有多少个变量</span></span><br><span class="line">    n = ngx_http_script_variables_count(value);</span><br><span class="line">    <span class="comment">// 如果是纯文本，则只需要增加ngx_http_script_value_code_t处理方法即可</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        val = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                         <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_value_code_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 尝试转换为整数</span></span><br><span class="line">        n = ngx_atoi(value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n == NGX_ERROR) &#123;</span><br><span class="line">            n = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        val-&gt;code = ngx_http_script_value_code;</span><br><span class="line">        val-&gt;value = (<span class="keyword">uintptr_t</span>) n;</span><br><span class="line">        val-&gt;text_len = (<span class="keyword">uintptr_t</span>) value-&gt;len;</span><br><span class="line">        val-&gt;text_data = (<span class="keyword">uintptr_t</span>) value-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果值中存在变量，则需要使用ngx_http_script_complex_value_code_t结构来承接</span></span><br><span class="line">    <span class="keyword">complex</span> = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_complex_value_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">complex</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其方法为ngx_http_script_complex_value_code</span></span><br><span class="line">    <span class="keyword">complex</span>-&gt;code = ngx_http_script_complex_value_code;</span><br><span class="line">    <span class="keyword">complex</span>-&gt;lengths = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;sc, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_compile_t</span>));</span><br><span class="line"></span><br><span class="line">    sc.cf = cf;</span><br><span class="line">    sc.source = value;</span><br><span class="line">    sc.lengths = &amp;<span class="keyword">complex</span>-&gt;lengths;</span><br><span class="line">    sc.values = &amp;lcf-&gt;codes;</span><br><span class="line">    sc.variables = n;</span><br><span class="line">    sc.complete_lengths = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 使用ngx_http_script_compile_t构建ngx_http_script_complex_value_code_t的lengths参数</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_script_compile(&amp;sc) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_compile函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_compile(<span class="keyword">ngx_http_script_compile_t</span> *sc)</span><br><span class="line">&#123;</span><br><span class="line">    u_char       ch;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>    name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   i, bracket;</span><br><span class="line">    <span class="comment">// 初始化sc中的各个数组</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_script_init_arrays(sc) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历需要进行编码的字符串</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sc-&gt;source-&gt;len; <span class="comment">/* void */</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        name.len = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 找到变量</span></span><br><span class="line">        <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'$'</span>) &#123;</span><br><span class="line">            <span class="comment">// $是结尾，说明表达式错误</span></span><br><span class="line">            <span class="keyword">if</span> (++i == sc-&gt;source-&gt;len) &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果是$后面跟着数字，即$1,$2这种，则如下处理</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] &gt;= <span class="string">'1'</span> &amp;&amp; sc-&gt;source-&gt;data[i] &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">                <span class="keyword">ngx_uint_t</span>  n;</span><br><span class="line">                <span class="comment">// 获取变量值</span></span><br><span class="line">                n = sc-&gt;source-&gt;data[i] - <span class="string">'0'</span>;</span><br><span class="line">                <span class="comment">// 使用captures_mask查看是否当前变量被使用过</span></span><br><span class="line">                <span class="keyword">if</span> (sc-&gt;captures_mask &amp; ((<span class="keyword">ngx_uint_t</span>) <span class="number">1</span> &lt;&lt; n)) &#123;</span><br><span class="line">                    <span class="comment">// 存在重复使用的变量时，dup_capture置1</span></span><br><span class="line">                    sc-&gt;dup_capture = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 记录被使用的变量</span></span><br><span class="line">                sc-&gt;captures_mask |= (<span class="keyword">ngx_uint_t</span>) <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">                <span class="comment">// 添加对应的处理逻辑</span></span><br><span class="line">                <span class="keyword">if</span> (ngx_http_script_add_capture_code(sc, n) != NGX_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                i++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"using variable \"$%c\" requires "</span></span><br><span class="line">                                   <span class="string">"PCRE library"</span>, sc-&gt;source-&gt;data[i]);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果变量后跟着&#123;的处理</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                <span class="comment">// 记录查找到左括号，需要一个右括号</span></span><br><span class="line">                bracket = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 同样，如果&#123;是末尾，则报错</span></span><br><span class="line">                <span class="keyword">if</span> (++i == sc-&gt;source-&gt;len) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bracket = <span class="number">0</span>;</span><br><span class="line">                name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 查找到当前变量的全名</span></span><br><span class="line">            <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; i &lt; sc-&gt;source-&gt;len; i++, name.len++) &#123;</span><br><span class="line">                ch = sc-&gt;source-&gt;data[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'&#125;'</span> &amp;&amp; bracket) &#123;</span><br><span class="line">                    i++;</span><br><span class="line">                    bracket = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>)</span><br><span class="line">                    || (ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>)</span><br><span class="line">                    || (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>)</span><br><span class="line">                    || ch == <span class="string">'_'</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果未找到又括号，则报错</span></span><br><span class="line">            <span class="keyword">if</span> (bracket) &#123;</span><br><span class="line">                ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>,</span><br><span class="line">                                   <span class="string">"the closing bracket in \"%V\" "</span></span><br><span class="line">                                   <span class="string">"variable is missing"</span>, &amp;name);</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 变量长度为0报错</span></span><br><span class="line">            <span class="keyword">if</span> (name.len == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid_variable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 记录增加一个变量</span></span><br><span class="line">            sc-&gt;variables++;</span><br><span class="line">            <span class="comment">// 增加解析时对应的处理逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_script_add_var_code(sc, &amp;name) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果查找到了?,并且需要解析请求参数，则执行如下处理</span></span><br><span class="line">        <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'?'</span> &amp;&amp; sc-&gt;compile_args) &#123;</span><br><span class="line">            sc-&gt;args = <span class="number">1</span>;</span><br><span class="line">            sc-&gt;compile_args = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 增加解析参数对应的处理逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_script_add_args_code(sc) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        name.data = &amp;sc-&gt;source-&gt;data[i];</span><br><span class="line">        <span class="comment">// 如果无上述情况，即是简单的常量字符串部分时</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; sc-&gt;source-&gt;len) &#123;</span><br><span class="line">            <span class="comment">// 找到变量起始标识，break</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'$'</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 找到?，并且需要解析请求参数时，break。不解析请求参数时，?仅仅当做一个简单的字符串处理</span></span><br><span class="line">            <span class="keyword">if</span> (sc-&gt;source-&gt;data[i] == <span class="string">'?'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                sc-&gt;args = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sc-&gt;compile_args) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i++;</span><br><span class="line">            name.len++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sc-&gt;size += name.len;</span><br><span class="line">        <span class="comment">// 增加对应的解析常量的处理</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_script_add_copy_code(sc, &amp;name, (i == sc-&gt;source-&gt;len))</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析完成后的最后处理</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_script_done(sc);</span><br><span class="line"></span><br><span class="line">invalid_variable:</span><br><span class="line"></span><br><span class="line">    ngx_conf_log_error(NGX_LOG_EMERG, sc-&gt;cf, <span class="number">0</span>, <span class="string">"invalid variable name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于set的脚本变量，ngx_http_script_complex_value_code_t结构的lengths是用来计算变量值所占空间大小，code成员用来在ngx_http_script_engine_t的sp中分配对应的空间。之后使用ngx_http_rewrite_loc_conf_t中的codes成员（一般包含多个）来对分配的内容进行赋值。而后使用ngx_http_rewrite_loc_conf_t中的codes中对变量名的解析方法，来将对应的值赋值给对应的变量。</p>
<p>总体上构建处理函数的顺序为：</p>
<ol>
<li>先将ngx_http_script_complex_value_code_t添加到ngx_http_rewrite_loc_conf_t中的codes成员中。</li>
<li>将变量解析的函数的每一部分（一般会含有多个部分）的处理函数（2种处理函数）依次添加到ngx_http_script_complex_value_code_t的lengths成员（计算每一部分生成的值长度）和ngx_http_rewrite_loc_conf_t的codes中（实际执行变量赋值的操作）</li>
<li>将变量名解析的函数增加到ngx_http_rewrite_loc_conf_t中的codes成员中。</li>
</ol>
<p>执行变量构建的顺序为：</p>
<ol>
<li>执行ngx_http_rewrite_loc_conf_t中的codes的ngx_http_script_complex_value_code_t成员的code方法，该方法会调用所有的ngx_http_script_complex_value_code_t中的lengths成员的方法，计算变量值总体占用空间，并在ngx_http_script_engine_t的当前sp中分配对应的空间。</li>
<li>接着执行ngx_http_rewrite_loc_conf_t中的codes后续的方法，对分配到sp的空间进行填充，构建完整的变量值。</li>
<li>执行变量名的解析函数，将sp中存储的变量值赋值到对应的变量上。</li>
</ol>
<p>其中ngx_http_script_compile_t中的lengths对应于ngx_http_script_complex_value_code_t中的lengths成员，ngx_http_script_compile_t中的values对应于ngx_http_rewrite_loc_conf_t中的codes成员。</p>
<p>在此基础上再来查看上述代码。首先来看ngx_http_script_complex_value_code_t的code方法，即ngx_http_rewrite_value方法中的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">complex</span>-&gt;code = ngx_http_script_complex_value_code;</span><br></pre></td></tr></table></figure>
<p>其中ngx_http_script_complex_value_code方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_complex_value_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                                 len;</span><br><span class="line">    <span class="keyword">ngx_http_script_engine_t</span>               le;</span><br><span class="line">    ngx_http_script_len_code_pt            lcode;</span><br><span class="line">    <span class="keyword">ngx_http_script_complex_value_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 恢复ngx_http_script_complex_value_code_t类</span></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_complex_value_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法，这里相当于是移动到ngx_http_rewrite_loc_conf_t中的codes下一个成员</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_complex_value_code_t</span>);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script complex value"</span>);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;le, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_engine_t</span>));</span><br><span class="line"></span><br><span class="line">    le.ip = code-&gt;lengths-&gt;elts;</span><br><span class="line">    le.line = e-&gt;line;</span><br><span class="line">    le.request = e-&gt;request;</span><br><span class="line">    le.quote = e-&gt;quote;</span><br><span class="line">    <span class="comment">// 依次执行ngx_http_script_complex_value_code_t的lengths函数，计算变量值占用空间大小</span></span><br><span class="line">    <span class="keyword">for</span> (len = <span class="number">0</span>; *(<span class="keyword">uintptr_t</span> *) le.ip; len += lcode(&amp;le)) &#123;</span><br><span class="line">        lcode = *(ngx_http_script_len_code_pt *) le.ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_engine_t的buf中分配该空间</span></span><br><span class="line">    e-&gt;buf.len = len;</span><br><span class="line">    e-&gt;buf.data = ngx_pnalloc(e-&gt;request-&gt;pool, len);</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;buf.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        e-&gt;ip = ngx_http_script_exit;</span><br><span class="line">        e-&gt;status = NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 让ngx_http_script_engine_t的pos执行该空间，后续赋值操作都是在依据pos指针</span></span><br><span class="line">    e-&gt;pos = e-&gt;buf.data;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_engine_t的当前sp的成员中初始化变量值</span></span><br><span class="line">    e-&gt;sp-&gt;len = e-&gt;buf.len;</span><br><span class="line">    e-&gt;sp-&gt;data = e-&gt;buf.data;</span><br><span class="line">    <span class="comment">// 将sp栈上升。这里虽然sp进行了变更，但是由于赋值是，使用的pos成员，因此赋值依旧是原始的sp</span></span><br><span class="line">    e-&gt;sp++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看一下对不同类型的变量增加相应处理函数的逻辑，这里对于$1类变量较为复杂，目前没有完全理解，暂时先不考虑。这里主要看一下变量名和常量的部分，即如下形式的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> $value <span class="string">"$valueName text"</span></span><br></pre></td></tr></table></figure>
<p>其中$valueName部分对应与变量名，” text”对应与常量表达式。其处理函数分别是ngx_http_script_add_var_code和ngx_http_script_add_copy_code。</p>
<p>先来看一下ngx_http_script_add_var_code：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_var_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_str_t</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                    index, *p;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 找到变量的索引</span></span><br><span class="line">    index = ngx_http_get_variable_index(sc-&gt;cf, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sc-&gt;flushes) &#123;</span><br><span class="line">        p = ngx_array_push(*sc-&gt;flushes);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *p = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_compile_t中的lengths增加ngx_http_script_copy_var_len_code方法</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                             ngx_http_script_copy_var_len_code;</span><br><span class="line">    code-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line">    <span class="comment">// 在ngx_http_rewrite_loc_conf_t中的codes增加ngx_http_script_copy_var_code</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>),</span><br><span class="line">                                    &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_var_code;</span><br><span class="line">    code-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_var_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>   *value;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line">    <span class="comment">// 根据index获取变量长度</span></span><br><span class="line">    <span class="keyword">if</span> (e-&gt;flushed) &#123;</span><br><span class="line">        value = ngx_http_get_indexed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value = ngx_http_get_flushed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; !value-&gt;not_found) &#123;</span><br><span class="line">        <span class="keyword">return</span> value-&gt;len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_copy_var_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                      *p;</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>   *value;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line">    <span class="comment">// 通过index获取对应的值</span></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;skip) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e-&gt;flushed) &#123;</span><br><span class="line">            value = ngx_http_get_indexed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = ngx_http_get_flushed_variable(e-&gt;request, code-&gt;index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value &amp;&amp; !value-&gt;not_found) &#123;</span><br><span class="line">        <span class="comment">// 把变量值拷贝到pos中，将pos后移</span></span><br><span class="line">            p = e-&gt;pos;</span><br><span class="line">            e-&gt;pos = ngx_copy(p, value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">            ngx_log_debug2(NGX_LOG_DEBUG_HTTP,</span><br><span class="line">                           e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http script var: \"%*s\""</span>, e-&gt;pos - p, p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看一下ngx_http_script_add_copy_code：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_script_add_copy_code(<span class="keyword">ngx_http_script_compile_t</span> *sc, <span class="keyword">ngx_str_t</span> *value,</span><br><span class="line">    <span class="keyword">ngx_uint_t</span> last)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                       *p;</span><br><span class="line">    <span class="keyword">size_t</span>                        size, len, zero;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 如果要在文本末尾增加\0,并且到达了末尾，长度增加ngx_http_script_copy_len_code处理函数</span></span><br><span class="line">    zero = (sc-&gt;zero &amp;&amp; last);</span><br><span class="line">    len = value-&gt;len + zero;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_compile_t中的lengths增加</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;lengths,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = (ngx_http_script_code_pt) (<span class="keyword">void</span> *)</span><br><span class="line">                                                 ngx_http_script_copy_len_code;</span><br><span class="line">    code-&gt;len = len;</span><br><span class="line">    <span class="comment">// 申请空间包括一个存储ngx_http_script_copy_code_t结构的空间，和存储常量值长度的空间，并进行了内存对齐</span></span><br><span class="line">    size = (<span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>) + len + <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>)</span><br><span class="line">            &amp; ~(<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在ngx_http_rewrite_loc_conf_t中的codes增加ngx_http_script_copy_code</span></span><br><span class="line">    code = ngx_http_script_add_code(*sc-&gt;values, size, &amp;sc-&gt;main);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    code-&gt;code = ngx_http_script_copy_code;</span><br><span class="line">    code-&gt;len = len;</span><br><span class="line">    <span class="comment">// 在ngx_http_script_copy_code_t的后面增加对应的常量值。</span></span><br><span class="line">    p = ngx_cpymem((u_char *) code + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>),</span><br><span class="line">                   value-&gt;data, value-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zero) &#123;</span><br><span class="line">        *p = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="comment">// zero变更为0，表示末尾已正常添加\0,后续不用再添加了</span></span><br><span class="line">        sc-&gt;zero = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span></span><br><span class="line">ngx_http_script_copy_len_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line">    </span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// ip指向下一个指令</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>);</span><br><span class="line">    <span class="comment">// 返回常量对应的长度</span></span><br><span class="line">    <span class="keyword">return</span> code-&gt;len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_copy_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                       *p;</span><br><span class="line">    <span class="keyword">ngx_http_script_copy_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_copy_code_t</span> *) e-&gt;ip;</span><br><span class="line"></span><br><span class="line">    p = e-&gt;pos;</span><br><span class="line">    <span class="comment">// 把常量拷贝到pos中，将pos后移</span></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;skip) &#123;</span><br><span class="line">        e-&gt;pos = ngx_copy(p, e-&gt;ip + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>),</span><br><span class="line">                          code-&gt;len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法。这里和构建时一样，进行了内存对齐。</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_copy_code_t</span>)</span><br><span class="line">          + ((code-&gt;len + <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>) &amp; ~(<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script copy: \"%*s\""</span>, e-&gt;pos - p, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看编译变量名的处理逻辑，对应于ngx_http_rewrite_set函数如下代码段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于系统内置变量，且支持用户重新使用set设置值的变量来说，会提供set_handler接口，这里使用    </span></span><br><span class="line"><span class="keyword">if</span> (v-&gt;set_handler) &#123;</span><br><span class="line">    vhcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                               <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_handler_code_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (vhcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// code为其执行函数</span></span><br><span class="line">    vhcode-&gt;code = ngx_http_script_var_set_handler_code;</span><br><span class="line">    <span class="comment">// handler被设置为变量原来的set_handler函数。</span></span><br><span class="line">    vhcode-&gt;handler = v-&gt;set_handler;</span><br><span class="line">    vhcode-&gt;data = v-&gt;data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果该变量不存在set_handler，则增加ngx_http_script_var_code_t结构来设置变量</span></span><br><span class="line">vcode = ngx_http_script_start_code(cf-&gt;pool, &amp;lcf-&gt;codes,</span><br><span class="line">                                   <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>));</span><br><span class="line"><span class="keyword">if</span> (vcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vcode-&gt;code = ngx_http_script_set_var_code;</span><br><span class="line">vcode-&gt;index = (<span class="keyword">uintptr_t</span>) index;</span><br></pre></td></tr></table></figure>
<p>ngx_http_script_var_handler_code_t结构专门支持内部变量能够被set重新设置，其定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    // 变量执行的方法</span><br><span class="line">    ngx_http_script_code_pt     code;</span><br><span class="line">    // 对应于原变量的set_handler方法</span><br><span class="line">    ngx_http_set_variable_pt    handler;</span><br><span class="line">    // 对应数据</span><br><span class="line">    uintptr_t                   data;</span><br><span class="line">&#125; ngx_http_script_var_handler_code_t;</span><br></pre></td></tr></table></figure>
<p>先来看一下函数ngx_http_script_var_set_handler_code，其执行逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_var_set_handler_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_handler_code_t</span>  *code;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script set var handler"</span>);</span><br><span class="line"></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_handler_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_handler_code_t</span>);</span><br><span class="line">    <span class="comment">// 由于在ngx_http_script_complex_value_code_t方法中将sp上移了一个，但赋值是原来的，因此这里将栈下移，获取该变量的数据</span></span><br><span class="line">    e-&gt;sp--;</span><br><span class="line">    <span class="comment">// 执行原变量的set_handler方法</span></span><br><span class="line">    code-&gt;handler(e-&gt;request, e-&gt;sp, code-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一个具有set_handler方法的例子，如agrs：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    &#123; ngx_string(<span class="string">"args"</span>),</span><br><span class="line">      ngx_http_variable_set_args,</span><br><span class="line">      ngx_http_variable_request,</span><br><span class="line">      offsetof(<span class="keyword">ngx_http_request_t</span>, args),</span><br><span class="line">      NGX_HTTP_VAR_CHANGEABLE|NGX_HTTP_VAR_NOCACHEABLE, <span class="number">0</span> &#125;,</span><br><span class="line">      </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_variable_set_args(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span> *v, <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里v即为sp栈数据，这里直接赋值给args</span></span><br><span class="line">    r-&gt;args.len = v-&gt;len;</span><br><span class="line">    r-&gt;args.data = v-&gt;data;</span><br><span class="line">    r-&gt;valid_unparsed_uri = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，其取变量的方式是通过offsetof(ngx_http_request_t, args)，即r-&gt;args里面进行字符串匹配查找数据。</p>
<p>对应不包含set_handler的变量来说，其处理逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_script_set_var_code(<span class="keyword">ngx_http_script_engine_t</span> *e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>          *r;</span><br><span class="line">    <span class="keyword">ngx_http_script_var_code_t</span>  *code;</span><br><span class="line">    <span class="comment">// 由于在ngx_http_script_complex_value_code_t方法中将sp上移了一个，但赋值是原来的，因此这里将栈下移，获取该变量的数据</span></span><br><span class="line">    code = (<span class="keyword">ngx_http_script_var_code_t</span> *) e-&gt;ip;</span><br><span class="line">    <span class="comment">// 将ip执行下一个要执行的方法</span></span><br><span class="line">    e-&gt;ip += <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_script_var_code_t</span>);</span><br><span class="line"></span><br><span class="line">    r = e-&gt;request;</span><br><span class="line"></span><br><span class="line">    e-&gt;sp--;</span><br><span class="line">    <span class="comment">// 直接使用索引对数据赋值</span></span><br><span class="line">    r-&gt;variables[code-&gt;index].len = e-&gt;sp-&gt;len;</span><br><span class="line">    r-&gt;variables[code-&gt;index].valid = <span class="number">1</span>;</span><br><span class="line">    r-&gt;variables[code-&gt;index].no_cacheable = <span class="number">0</span>;</span><br><span class="line">    r-&gt;variables[code-&gt;index].not_found = <span class="number">0</span>;</span><br><span class="line">    r-&gt;variables[code-&gt;index].data = e-&gt;sp-&gt;data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_get_module_main_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, e-&gt;request-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http script set $%V"</span>, &amp;v[code-&gt;index].name);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="变量间merge"><a href="#变量间merge" class="headerlink" title="变量间merge"></a>变量间merge</h2><p>在http层的set方法ngx_http_block中的ngx_http_variables_init_vars函数中会对三种变量（hash到变量，索引的变量，前缀变量）进行merge。其方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variables_init_vars(<span class="keyword">ngx_conf_t</span> *cf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                      len;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  i, n;</span><br><span class="line">    <span class="keyword">ngx_hash_key_t</span>             *key;</span><br><span class="line">    <span class="keyword">ngx_hash_init_t</span>             hash;</span><br><span class="line">    <span class="keyword">ngx_http_variable_t</span>        *v, *av, *pv;</span><br><span class="line">    <span class="keyword">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set the handlers for the indexed http variables */</span></span><br><span class="line">    <span class="comment">// 获取mian层级ngx_http_core_module创建的ngx_http_core_main_conf_t</span></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// 索引后的变量数组</span></span><br><span class="line">    v = cmcf-&gt;variables.elts;</span><br><span class="line">    <span class="comment">// 前缀变量数组</span></span><br><span class="line">    pv = cmcf-&gt;prefix_variables.elts;</span><br><span class="line">    <span class="comment">// 即将要被hash化的数组</span></span><br><span class="line">    key = cmcf-&gt;variables_keys-&gt;keys.elts;</span><br><span class="line">    <span class="comment">// 遍历索引化的数据</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cmcf-&gt;variables.nelts; i++) &#123;</span><br><span class="line">        <span class="comment">// 遍历将要hash化的数组，找到与索引化的元素一样的元素</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cmcf-&gt;variables_keys-&gt;keys.nelts; n++) &#123;</span><br><span class="line"></span><br><span class="line">            av = key[n].value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (v[i].name.len == key[n].key.len</span><br><span class="line">                &amp;&amp; ngx_strncmp(v[i].name.data, key[n].key.data, v[i].name.len)</span><br><span class="line">                   == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 设置索引化的数组的get_handler为，待hash数组对应元素的get_handler</span></span><br><span class="line">                v[i].get_handler = av-&gt;get_handler;</span><br><span class="line">                v[i].data = av-&gt;data;</span><br><span class="line">                <span class="comment">// 设置hash化数组中对应元素为已hash化。这里对应与ngx_http_get_value函数中，先查找hash表，找到后查看该变量是否已索引化，对于索引化时，使用索引数组中该变量处理方法</span></span><br><span class="line">                av-&gt;flags |= NGX_HTTP_VAR_INDEXED;</span><br><span class="line">                v[i].flags = av-&gt;flags;</span><br><span class="line">                <span class="comment">// 设置hash数组中该变量index为在索引化数组中索引，方便查找</span></span><br><span class="line">                av-&gt;index = i;</span><br><span class="line">                <span class="comment">// 对于NGX_HTTP_VAR_WEAK变量，需要再查看是否属于前缀变量，否则直接进行下一个hash元素的查找</span></span><br><span class="line">                <span class="keyword">if</span> (av-&gt;get_handler == <span class="literal">NULL</span></span><br><span class="line">                    || (av-&gt;flags &amp; NGX_HTTP_VAR_WEAK))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">goto</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = <span class="number">0</span>;</span><br><span class="line">        av = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 遍历前缀变量，使用最长匹配查找是否为前缀变量，这里有个小bug，v[i].name.len &gt; len应该是pv[n].name.len&gt;len才对（个人理解）</span></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cmcf-&gt;prefix_variables.nelts; n++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v[i].name.len &gt;= pv[n].name.len &amp;&amp; v[i].name.len &gt; len</span><br><span class="line">                &amp;&amp; ngx_strncmp(v[i].name.data, pv[n].name.data, pv[n].name.len)</span><br><span class="line">                   == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                av = &amp;pv[n];</span><br><span class="line">                len = pv[n].name.len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是前缀变量，则设置变量的解析方式为前缀变量的解析方式，设置data为变量名（这是前缀变量get_handler使用方式要求）</span></span><br><span class="line">        <span class="keyword">if</span> (av) &#123;</span><br><span class="line">            v[i].get_handler = av-&gt;get_handler;</span><br><span class="line">            v[i].data = (<span class="keyword">uintptr_t</span>) &amp;v[i].name;</span><br><span class="line">            v[i].flags = av-&gt;flags;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (v[i].get_handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"unknown \"%V\" variable"</span>, &amp;v[i].name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    next:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置不需要hash化的变量data为null，这时构建hash表就会跳过该变量</span></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; cmcf-&gt;variables_keys-&gt;keys.nelts; n++) &#123;</span><br><span class="line">        av = key[n].value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (av-&gt;flags &amp; NGX_HTTP_VAR_NOHASH) &#123;</span><br><span class="line">            key[n].key.data = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建variables_hash表，存储hash后变量。</span></span><br><span class="line">    hash.hash = &amp;cmcf-&gt;variables_hash;</span><br><span class="line">    hash.key = ngx_hash_key;</span><br><span class="line">    hash.max_size = cmcf-&gt;variables_hash_max_size;</span><br><span class="line">    hash.bucket_size = cmcf-&gt;variables_hash_bucket_size;</span><br><span class="line">    hash.name = <span class="string">"variables_hash"</span>;</span><br><span class="line">    hash.pool = cf-&gt;pool;</span><br><span class="line">    hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_hash_init(&amp;hash, cmcf-&gt;variables_keys-&gt;keys.elts,</span><br><span class="line">                      cmcf-&gt;variables_keys-&gt;keys.nelts)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmcf-&gt;variables_keys = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里看一下前缀变量get_handler方法</span></span><br><span class="line">      &#123; ngx_string(<span class="string">"arg_"</span>), <span class="literal">NULL</span>, ngx_http_variable_argument,</span><br><span class="line">      <span class="number">0</span>, NGX_HTTP_VAR_NOCACHEABLE|NGX_HTTP_VAR_PREFIX, <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_variable_argument(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_variable_value_t</span> *v,</span><br><span class="line">    <span class="keyword">uintptr_t</span> data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// data存储的是变量名</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span> *name = (<span class="keyword">ngx_str_t</span> *) data;</span><br><span class="line"></span><br><span class="line">    u_char     *arg;</span><br><span class="line">    <span class="keyword">size_t</span>      len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>   value;</span><br><span class="line">    <span class="comment">// 去除前缀arg_</span></span><br><span class="line">    len = name-&gt;len - (<span class="keyword">sizeof</span>(<span class="string">"arg_"</span>) - <span class="number">1</span>);</span><br><span class="line">    arg = name-&gt;data + <span class="keyword">sizeof</span>(<span class="string">"arg_"</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 在r-&gt;args中查找变量</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_arg(r, arg, len, &amp;value) != NGX_OK) &#123;</span><br><span class="line">        v-&gt;not_found = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v-&gt;data = value.data;</span><br><span class="line">    v-&gt;len = value.len;</span><br><span class="line">    v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">    v-&gt;no_cacheable = <span class="number">0</span>;</span><br><span class="line">    v-&gt;not_found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>对于如下配置，输出为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location /url &#123;</span><br><span class="line"></span><br><span class="line">    set   $name   “$arg_name”;</span><br><span class="line"></span><br><span class="line">    set   $args   “name=jikui”;</span><br><span class="line"></span><br><span class="line">    return 200   “$name = $arg_name”;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">访问url输出结果是:</span><br><span class="line">curl http://127.0.0.1/url?name=test</span><br><span class="line"></span><br><span class="line">test = jikui</span><br></pre></td></tr></table></figure>
<p>对于<code>set   $name   “$arg_name”;</code>来说，<code>$arg_name</code>作为前缀变量，不可缓存，因此从请求的r-&gt;args中获取。这是$name值为test。对于<code>set   $args   “name=jikui”;</code>来说，由于args允许用户set值，因此其存在set_handler函数。ngx_http_script_var_handler_code_t结构的code方法调用其set_handler函数，设置r-&gt;args为<code>&quot;name=jikui&quot;</code>。由于这两步是顺序执行的，因此此时name是test。args是<code>name=jikui</code>。最后的<code>$name = $arg_name”</code>。由于set设置的name变量是可缓存的，因此会直接使用执行set脚本时生成的test值，而对于<code>$arg_name</code>来说，其是不可缓存的变量，因此会再次读取<code>r-&gt;args</code>来获取值，因此其值变更为jikui。</p>
<h1 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h1><p><a href="https://zhuanlan.zhihu.com/p/93684036" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/93684036</a></p>
<h1 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h1><p>由于nginx是多进程异步处理，因此很多时候进程间需要使用锁来确保进程安全，进行进程间同步。nginx使用的锁主要涉及三部分内容。方便为<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E8%AE%B0%E5%BD%95%E9%94%81" target="_blank" rel="noopener">文件锁</a>、<a href="http://www.yinkuiwang.cn/2019/12/18/unix%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/#%E4%BF%A1%E5%8F%B7%E9%87%8F" target="_blank" rel="noopener">信号量</a>、原子变量。对于原子变量，可参考如下两篇文章的介绍：</p>
<p><a href="https://www.infoq.cn/article/atomic-operation" target="_blank" rel="noopener">https://www.infoq.cn/article/atomic-operation</a></p>
<p><a href="https://www.jianshu.com/p/cb7b726e943c" target="_blank" rel="noopener">https://www.jianshu.com/p/cb7b726e943c</a></p>
<p>这里主要讲解使用原子变量来构建锁。</p>
<h2 id="相关数据结构-3"><a href="#相关数据结构-3" class="headerlink" title="相关数据结构"></a>相关数据结构</h2><p>首先来看一下相关数据结构。</p>
<h3 id="ngx-shmtx-t"><a href="#ngx-shmtx-t" class="headerlink" title="ngx_shmtx_t"></a>ngx_shmtx_t</h3><p>nginx封装的锁的类。其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_ATOMIC_OPS)</span></span><br><span class="line">    <span class="comment">// 如果系统支持原子变量，则优先使用原子变量</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>  *lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="comment">// 如果星图支持信号量，则可选信号量</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>  *wait; <span class="comment">// 当前在等待的进程数量</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>     semaphore; <span class="comment">// 是否正常开启了信号量</span></span><br><span class="line">    <span class="keyword">sem_t</span>          sem; <span class="comment">// 信号量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// 如果不支持原子变量，则使用文件锁来进行</span></span><br><span class="line">    <span class="keyword">ngx_fd_t</span>       fd;</span><br><span class="line">    u_char        *name;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>     spin; <span class="comment">// 重复尝试获取锁间隔</span></span><br><span class="line">&#125; <span class="keyword">ngx_shmtx_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="ngx-shmtx-sh-t"><a href="#ngx-shmtx-sh-t" class="headerlink" title="ngx_shmtx_sh_t"></a>ngx_shmtx_sh_t</h3><p>由于进程间通讯需要各个进程访问同一个地址，因此该类是nginx封装的一个共享内存创建的锁地址。其由对应的使用方来创建。具体可以参考事件模块构建 accept锁的过程。其结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>   lock; <span class="comment">// 支持原子变量时，对应的原子变量地址</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>   wait; <span class="comment">// 支持信号量时，对应的信号量有多少进程在等待的数量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">ngx_shmtx_sh_t</span>;</span><br></pre></td></tr></table></figure>
<h2 id="创建锁"><a href="#创建锁" class="headerlink" title="创建锁"></a>创建锁</h2><p>使用ngx_shmtx_create方法来创建锁，其逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_shmtx_create(<span class="keyword">ngx_shmtx_t</span> *mtx, <span class="keyword">ngx_shmtx_sh_t</span> *addr, u_char *name)</span><br><span class="line">&#123;</span><br><span class="line">    mtx-&gt;lock = &amp;addr-&gt;lock;</span><br><span class="line">    <span class="comment">// 如果spin为-1，表示不能使用信号量（默认是不使用的，对于accept锁）</span></span><br><span class="line">    <span class="keyword">if</span> (mtx-&gt;spin == (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尝试获取锁的次数（并非准确值，具体下面介绍）</span></span><br><span class="line">    mtx-&gt;spin = <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="comment">// 如果支持信号量，则使用wait记录等待信号量的进程数</span></span><br><span class="line">    mtx-&gt;wait = &amp;addr-&gt;wait;</span><br><span class="line">    <span class="comment">// 初始化信号量为0</span></span><br><span class="line">    <span class="keyword">if</span> (sem_init(&amp;mtx-&gt;sem, <span class="number">1</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sem_init() failed"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 标识正确初始化了信号量</span></span><br><span class="line">        mtx-&gt;semaphore = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="销毁锁"><a href="#销毁锁" class="headerlink" title="销毁锁"></a>销毁锁</h2><p>使用ngx_shmtx_destroy方法来销毁锁：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_shmtx_destroy(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mtx-&gt;semaphore) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sem_destroy(&amp;mtx-&gt;sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                          <span class="string">"sem_destroy() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即仅在支持信号量，并且成功初始化了信号量时，需要执行一步信号量销毁操作。</p>
<h2 id="非阻塞获取锁"><a href="#非阻塞获取锁" class="headerlink" title="非阻塞获取锁"></a>非阻塞获取锁</h2><p>使用ngx_shmtx_trylock函数来非阻塞的获取锁，即如果不能获取锁，则直接返回。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_uint_t</span></span><br><span class="line">ngx_shmtx_trylock(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (*mtx-&gt;lock == <span class="number">0</span> &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_atomic_cmp_set(lock, old, set)                                    \</span></span><br><span class="line">    __sync_bool_compare_and_swap(lock, old, <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure>
<p><em>mtx-&gt;lock表示当前未被其他进程占用，但是在执行ngx_atomic_cmp_set的过程前（\</em>mtx-&gt;lock == 0后），可能已经被其他进程占用了，因此在原子变量中操作获取锁时，只有当前锁的值依然是0，即在该进程锁住变量前，没有其他进程已经对其进行设置，获取到该锁时，才对其进行赋值，表示当前进程占用该锁。当其他进程希望获取该锁时，由于lock值不为0，返回false。</p>
<h2 id="阻塞式获取锁"><a href="#阻塞式获取锁" class="headerlink" title="阻塞式获取锁"></a>阻塞式获取锁</h2><p>使用ngx_shmtx_lock函数来阻塞式获取锁，即直到获取到该锁才返回。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_cpu_pause()             __asm__ (<span class="meta-string">"pause"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_SCHED_YIELD)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_sched_yield()  sched_yield()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_sched_yield()  usleep(1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_shmtx_lock(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i, n;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"shmtx lock"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="comment">// 重试获取锁，获取成功立即返回</span></span><br><span class="line">        <span class="keyword">if</span> (*mtx-&gt;lock == <span class="number">0</span> &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 多处理器状态下spin才有效</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_ncpu &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 循环调用pause，并重试获取锁，pause的次数随着尝试次数指数增加</span></span><br><span class="line">            <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; mtx-&gt;spin; n &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                    ngx_cpu_pause();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 重复重试获取锁</span></span><br><span class="line">                <span class="keyword">if</span> (*mtx-&gt;lock == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">        <span class="comment">// 如果支持信号量，则尝试获取信号量</span></span><br><span class="line">        <span class="keyword">if</span> (mtx-&gt;semaphore) &#123;</span><br><span class="line">            <span class="comment">// 使用原子变量将等待的进程数量+1</span></span><br><span class="line">            (<span class="keyword">void</span>) ngx_atomic_fetch_add(mtx-&gt;wait, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 尝试获取锁，如果成功获取，则将等待进程数减一，返回</span></span><br><span class="line">            <span class="keyword">if</span> (*mtx-&gt;lock == <span class="number">0</span> &amp;&amp; ngx_atomic_cmp_set(mtx-&gt;lock, <span class="number">0</span>, ngx_pid)) &#123;</span><br><span class="line">                (<span class="keyword">void</span>) ngx_atomic_fetch_add(mtx-&gt;wait, <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug1(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"shmtx wait %uA"</span>, *mtx-&gt;wait);</span><br><span class="line">            <span class="comment">// 等待其他进程释放信号量（执行减一操作，同一时刻，只有一个进程持有信号量）</span></span><br><span class="line">            <span class="keyword">while</span> (sem_wait(&amp;mtx-&gt;sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="comment">// 出错处理</span></span><br><span class="line">                <span class="keyword">ngx_err_t</span>  err;</span><br><span class="line"></span><br><span class="line">                err = ngx_errno;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err != NGX_EINTR) &#123;</span><br><span class="line">                    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                                  <span class="string">"sem_wait() failed while waiting on shmtx"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"shmtx awoke"</span>);</span><br><span class="line">            <span class="comment">// 获取到信号量，则执行下一次循环，再次尝试获取锁</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 如果没有信号量，则执行sched_yield()</span></span><br><span class="line">        ngx_sched_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里ngx_cpu_pause()执行的实际是汇编中pause指令，其会减少CPU的消耗，节省电量。指令的本质功能是：让加锁失败的CPU睡眠大约30个clock，从而使得读操作的频率低很多，流水线重排的代价也会很小。</p>
<p>ngx_sched_yield()执行的是sched_yield()函数，sched_yield()会让出当前线程的CPU占有权，然后把线程放到静态优先队列的尾端，然后一个新的线程会占用CPU。sched_yield()这个函数可以使用另一个级别等于或高于当前线程的线程先运行。如果没有符合条件的线程，那么这个函数将会立刻返回然后继续执行当前线程的程序。 这是其于sleep系列函数的本质区别，而sleep则是等待一定时间后等待CPU的调度，然后去获得CPU资源。</p>
<p>对于阻塞的sem_wait函数，其会阻塞进程。</p>
<p>对于使用信号量时，在将信号量-1后，没有对等待进程数量执行减一操作，该操作在释放信号量时进行。</p>
<h2 id="释放锁"><a href="#释放锁" class="headerlink" title="释放锁"></a>释放锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_shmtx_unlock(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mtx-&gt;spin != (<span class="keyword">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"shmtx unlock"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放锁，将原子变量设置回0，该进程获取锁时，原子变量值为该进程的id</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_atomic_cmp_set(mtx-&gt;lock, ngx_pid, <span class="number">0</span>)) &#123;</span><br><span class="line">        ngx_shmtx_wakeup(mtx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="释放信号"><a href="#释放信号" class="headerlink" title="释放信号"></a>释放信号</h2><p>在使用信号量时，释放信号后，会释放信号量来唤醒其他等待进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_shmtx_wakeup(<span class="keyword">ngx_shmtx_t</span> *mtx)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_POSIX_SEM)</span></span><br><span class="line">    <span class="keyword">ngx_atomic_uint_t</span>  wait;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mtx-&gt;semaphore) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里将等待的进程数量减一。这是由于在阻塞式获取锁时，获取信号量时，并未将该值减一，这样进行减一</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        wait = *mtx-&gt;wait;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">ngx_atomic_int_t</span>) wait &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_atomic_cmp_set(mtx-&gt;wait, wait, wait - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"shmtx wake %uA"</span>, wait);</span><br><span class="line">    <span class="comment">// 释放信号量来唤醒其余等待进程。</span></span><br><span class="line">    <span class="keyword">if</span> (sem_post(&amp;mtx-&gt;sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">"sem_post() failed while wake shmtx"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="强制释放锁"><a href="#强制释放锁" class="headerlink" title="强制释放锁"></a>强制释放锁</h2><p>当某些进程意外退出时，如果其已经获取到了某个锁，这时需要有一个机制能够让其他进程（master）进程来强制释放其所持有的锁。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_uint_t</span></span><br><span class="line">ngx_shmtx_force_unlock(<span class="keyword">ngx_shmtx_t</span> *mtx, <span class="keyword">ngx_pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_CORE, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"shmtx forced unlock"</span>);</span><br><span class="line">    <span class="comment">/* 如果释放锁返回为0，则表面出错进程确实拥有该锁，这时需要执行唤醒其余进程的操作，否则表示要释放的进程并不持有该锁，无需额外操作。*/</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_atomic_cmp_set(mtx-&gt;lock, pid, <span class="number">0</span>)) &#123;</span><br><span class="line">        ngx_shmtx_wakeup(mtx);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/30/Go语言学习/" rel="next" title="Go语言学习">
                <i class="fa fa-chevron-left"></i> Go语言学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">chst</p>
              <p class="site-description motion-element" itemprop="description">人生苦酒,自酿自品</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx安装"><span class="nav-number">1.</span> <span class="nav-text">nginx安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#—prefix-PATH"><span class="nav-number">1.1.</span> <span class="nav-text">—prefix=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—sbin-path-PATH"><span class="nav-number">1.2.</span> <span class="nav-text">—sbin-path=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—conf-path-PATH"><span class="nav-number">1.3.</span> <span class="nav-text">—conf-path=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—error-log-path-PATH"><span class="nav-number">1.4.</span> <span class="nav-text">—error-log-path=PATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#—pid-path-PATH"><span class="nav-number">1.5.</span> <span class="nav-text">—pid-path=PATH</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx的命令行控制"><span class="nav-number">2.</span> <span class="nav-text">nginx的命令行控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#直接执行Nginx二进制文件"><span class="nav-number">2.1.</span> <span class="nav-text">直接执行Nginx二进制文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#指定配置文件"><span class="nav-number">2.2.</span> <span class="nav-text">指定配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#另行指定全局配置项"><span class="nav-number">2.3.</span> <span class="nav-text">另行指定全局配置项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试配置信息是否错误"><span class="nav-number">2.4.</span> <span class="nav-text">测试配置信息是否错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示版本"><span class="nav-number">2.5.</span> <span class="nav-text">显示版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示编译阶段参数"><span class="nav-number">2.6.</span> <span class="nav-text">显示编译阶段参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速停止服务"><span class="nav-number">2.7.</span> <span class="nav-text">快速停止服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优雅的停止服务"><span class="nav-number">2.8.</span> <span class="nav-text">优雅的停止服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx的配置"><span class="nav-number">3.</span> <span class="nav-text">Nginx的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置demo"><span class="nav-number">3.1.</span> <span class="nav-text">配置demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#块配置"><span class="nav-number">3.2.</span> <span class="nav-text">块配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项语法"><span class="nav-number">3.3.</span> <span class="nav-text">配置项语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项单位"><span class="nav-number">3.4.</span> <span class="nav-text">配置项单位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置中使用变量"><span class="nav-number">3.5.</span> <span class="nav-text">配置中使用变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx提供的基础服务"><span class="nav-number">3.6.</span> <span class="nav-text">nginx提供的基础服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用语调试和定位问题的配置"><span class="nav-number">3.6.1.</span> <span class="nav-text">用语调试和定位问题的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是否以守护进程来执行"><span class="nav-number">3.6.1.1.</span> <span class="nav-text">是否以守护进程来执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#是否以master-worker方式进行工作"><span class="nav-number">3.6.1.2.</span> <span class="nav-text">是否以master/worker方式进行工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error日志设置"><span class="nav-number">3.6.1.3.</span> <span class="nav-text">error日志设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置特殊的调试点"><span class="nav-number">3.6.1.4.</span> <span class="nav-text">设置特殊的调试点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对指定客户端输出debug级别日志"><span class="nav-number">3.6.1.5.</span> <span class="nav-text">对指定客户端输出debug级别日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#限制coredump核心转储文件大小"><span class="nav-number">3.6.1.6.</span> <span class="nav-text">限制coredump核心转储文件大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定coredump文件生成目录"><span class="nav-number">3.6.1.7.</span> <span class="nav-text">指定coredump文件生成目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正常运行配置"><span class="nav-number">3.6.2.</span> <span class="nav-text">正常运行配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义环境变量"><span class="nav-number">3.6.2.1.</span> <span class="nav-text">定义环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#嵌入其他配置"><span class="nav-number">3.6.2.2.</span> <span class="nav-text">嵌入其他配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pid文件路径"><span class="nav-number">3.6.2.3.</span> <span class="nav-text">pid文件路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx进程运行的用户及用户组"><span class="nav-number">3.6.2.4.</span> <span class="nav-text">nginx进程运行的用户及用户组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#worker进程最大句柄描述符个数"><span class="nav-number">3.6.2.5.</span> <span class="nav-text">worker进程最大句柄描述符个数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#限制信号队列"><span class="nav-number">3.6.2.6.</span> <span class="nav-text">限制信号队列</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#性能优化配置"><span class="nav-number">3.6.3.</span> <span class="nav-text">性能优化配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx的worker进程数"><span class="nav-number">3.6.3.1.</span> <span class="nav-text">nginx的worker进程数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绑定nginx的worker进程到指定的CPU内核"><span class="nav-number">3.6.3.2.</span> <span class="nav-text">绑定nginx的worker进程到指定的CPU内核</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件类配置-都在event块中"><span class="nav-number">3.6.4.</span> <span class="nav-text">事件类配置(都在event块中)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是否打开负载均衡锁"><span class="nav-number">3.6.4.1.</span> <span class="nav-text">是否打开负载均衡锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lock文件路径"><span class="nav-number">3.6.4.2.</span> <span class="nav-text">lock文件路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用accept锁后未建立连接后等待时间"><span class="nav-number">3.6.4.3.</span> <span class="nav-text">使用accept锁后未建立连接后等待时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量建立新连接"><span class="nav-number">3.6.4.4.</span> <span class="nav-text">批量建立新连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#选择事件模型"><span class="nav-number">3.6.4.5.</span> <span class="nav-text">选择事件模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每个master的最大连接数"><span class="nav-number">3.6.4.6.</span> <span class="nav-text">每个master的最大连接数</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#用HTTP核心模块配置一个静态服务器"><span class="nav-number">4.</span> <span class="nav-text">用HTTP核心模块配置一个静态服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#虚拟主机与请求的分发"><span class="nav-number">4.1.</span> <span class="nav-text">虚拟主机与请求的分发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#监听端口"><span class="nav-number">4.1.1.</span> <span class="nav-text">监听端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主机名称"><span class="nav-number">4.1.2.</span> <span class="nav-text">主机名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-name-hash-bucket-size"><span class="nav-number">4.1.3.</span> <span class="nav-text">server_name_hash_bucket_size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向主机名称处理"><span class="nav-number">4.1.4.</span> <span class="nav-text">重定向主机名称处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location"><span class="nav-number">4.1.5.</span> <span class="nav-text">location</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件路径的定义"><span class="nav-number">4.2.</span> <span class="nav-text">文件路径的定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#以root方式设置资源路径"><span class="nav-number">4.2.1.</span> <span class="nav-text">以root方式设置资源路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alias方式设置资源路径"><span class="nav-number">4.2.2.</span> <span class="nav-text">alias方式设置资源路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问首页"><span class="nav-number">4.2.3.</span> <span class="nav-text">访问首页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据http返回码重定向页面"><span class="nav-number">4.2.4.</span> <span class="nav-text">根据http返回码重定向页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#是否允许递归使用error-page"><span class="nav-number">4.2.5.</span> <span class="nav-text">是否允许递归使用error_page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#try-file"><span class="nav-number">4.2.6.</span> <span class="nav-text">try_file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">4.2.7.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存及磁盘资源的分配"><span class="nav-number">4.3.</span> <span class="nav-text">内存及磁盘资源的分配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP包体只存储在磁盘文件中"><span class="nav-number">4.3.1.</span> <span class="nav-text">HTTP包体只存储在磁盘文件中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP包体尽量写到一个内存buffer中"><span class="nav-number">4.3.2.</span> <span class="nav-text">HTTP包体尽量写到一个内存buffer中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储HTTP请求头部的内存大小"><span class="nav-number">4.3.3.</span> <span class="nav-text">存储HTTP请求头部的内存大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储超大HTTP头部的内存buffer大小"><span class="nav-number">4.3.4.</span> <span class="nav-text">存储超大HTTP头部的内存buffer大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储HTTP包体的内存buffer大小"><span class="nav-number">4.3.5.</span> <span class="nav-text">存储HTTP包体的内存buffer大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP包体临时存放目录"><span class="nav-number">4.3.6.</span> <span class="nav-text">HTTP包体临时存放目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connection-pool-size"><span class="nav-number">4.3.7.</span> <span class="nav-text">connection_pool_size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#request-pool-size"><span class="nav-number">4.3.8.</span> <span class="nav-text">request_pool_size</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络连接设置"><span class="nav-number">4.4.</span> <span class="nav-text">网络连接设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#读取HTTP头部超时时间"><span class="nav-number">4.4.1.</span> <span class="nav-text">读取HTTP头部超时时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#读取HTTP包体超时时间"><span class="nav-number">4.4.2.</span> <span class="nav-text">读取HTTP包体超时时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送响应超时时间"><span class="nav-number">4.4.3.</span> <span class="nav-text">发送响应超时时间</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx常用数据结构"><span class="nav-number">5.</span> <span class="nav-text">Nginx常用数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-buf-t"><span class="nav-number">5.1.</span> <span class="nav-text">ngx_buf_t</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#散列表（ngx-hash-t）"><span class="nav-number">5.2.</span> <span class="nav-text">散列表（ngx_hash_t）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#散列表构建"><span class="nav-number">5.2.1.</span> <span class="nav-text">散列表构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#散列表查找"><span class="nav-number">5.2.2.</span> <span class="nav-text">散列表查找</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理散列表（ngx-hash-keys-arrays-t）"><span class="nav-number">5.3.</span> <span class="nav-text">管理散列表（ngx_hash_keys_arrays_t）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#构建ngx-hash-keys-arrays-t"><span class="nav-number">5.3.1.</span> <span class="nav-text">构建ngx_hash_keys_arrays_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加元素"><span class="nav-number">5.3.2.</span> <span class="nav-text">添加元素</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#带有通配符的散列表（ngx-hash-wildcard-t）"><span class="nav-number">5.4.</span> <span class="nav-text">带有通配符的散列表（ngx_hash_wildcard_t）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#构建带有通配符的散列表"><span class="nav-number">5.4.1.</span> <span class="nav-text">构建带有通配符的散列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找后缀通配符"><span class="nav-number">5.4.2.</span> <span class="nav-text">查找后缀通配符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找前缀通配符"><span class="nav-number">5.4.3.</span> <span class="nav-text">查找前缀通配符</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx特殊技巧"><span class="nav-number">6.</span> <span class="nav-text">Nginx特殊技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-align-值对齐宏"><span class="nav-number">6.1.</span> <span class="nav-text">ngx_align 值对齐宏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-align-ptr内存对其"><span class="nav-number">6.2.</span> <span class="nav-text">ngx_align_ptr内存对其</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#指针最后两位一定是0"><span class="nav-number">6.3.</span> <span class="nav-text">指针最后两位一定是0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内联汇编"><span class="nav-number">6.4.</span> <span class="nav-text">内联汇编</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx基础架构"><span class="nav-number">7.</span> <span class="nav-text">Nginx基础架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx的架构设计"><span class="nav-number">7.1.</span> <span class="nav-text">Nginx的架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#优秀的模块化设计"><span class="nav-number">7.1.1.</span> <span class="nav-text">优秀的模块化设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx-module-t类"><span class="nav-number">7.1.1.1.</span> <span class="nav-text">nginx_module_t类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件驱动框架"><span class="nav-number">7.1.2.</span> <span class="nav-text">事件驱动框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求的多阶段异步处理"><span class="nav-number">7.1.3.</span> <span class="nav-text">请求的多阶段异步处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理进程、多工作进程设计"><span class="nav-number">7.1.4.</span> <span class="nav-text">管理进程、多工作进程设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存池的设计"><span class="nav-number">7.1.5.</span> <span class="nav-text">内存池的设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx框架中的核心结构体ngx-cycle-t"><span class="nav-number">7.2.</span> <span class="nav-text">Nginx框架中的核心结构体ngx_cycle_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-listening-t结构体"><span class="nav-number">7.2.1.</span> <span class="nav-text">ngx_listening_t结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-cycle-t结构体"><span class="nav-number">7.2.2.</span> <span class="nav-text">ngx_cycle_t结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-cycle-t支持的方法"><span class="nav-number">7.2.3.</span> <span class="nav-text">ngx_cycle_t支持的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx启动时框架处理流程"><span class="nav-number">7.2.4.</span> <span class="nav-text">nginx启动时框架处理流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx启动过程详解"><span class="nav-number">7.3.</span> <span class="nav-text">nginx启动过程详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解析启动参数"><span class="nav-number">7.3.1.</span> <span class="nav-text">解析启动参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化信息"><span class="nav-number">7.3.2.</span> <span class="nav-text">初始化信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化log打印描述符"><span class="nav-number">7.3.3.</span> <span class="nav-text">初始化log打印描述符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#申请内存池空间Pool"><span class="nav-number">7.3.4.</span> <span class="nav-text">申请内存池空间Pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储命令行参数"><span class="nav-number">7.3.5.</span> <span class="nav-text">存储命令行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置相关路径"><span class="nav-number">7.3.6.</span> <span class="nav-text">设置相关路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化系统相关全局变量"><span class="nav-number">7.3.7.</span> <span class="nav-text">初始化系统相关全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化差错校验"><span class="nav-number">7.3.8.</span> <span class="nav-text">初始化差错校验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化slab共享内存"><span class="nav-number">7.3.9.</span> <span class="nav-text">初始化slab共享内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#监听环境变量中的端口"><span class="nav-number">7.3.10.</span> <span class="nav-text">监听环境变量中的端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预初始化模块"><span class="nav-number">7.3.11.</span> <span class="nav-text">预初始化模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化cycle"><span class="nav-number">7.3.12.</span> <span class="nav-text">初始化cycle</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建管理目录"><span class="nav-number">7.3.12.1.</span> <span class="nav-text">创建管理目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建管理文件"><span class="nav-number">7.3.12.2.</span> <span class="nav-text">创建管理文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打开日志文件"><span class="nav-number">7.3.12.3.</span> <span class="nav-text">打开日志文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打开并设置监听地址"><span class="nav-number">7.3.12.4.</span> <span class="nav-text">打开并设置监听地址</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-open-listening-sockets打开监听地址"><span class="nav-number">7.3.12.4.1.</span> <span class="nav-text">ngx_open_listening_sockets打开监听地址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-configure-listening-sockets设置套接字属性"><span class="nav-number">7.3.12.4.2.</span> <span class="nav-text">ngx_configure_listening_sockets设置套接字属性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试配置的处理"><span class="nav-number">7.3.13.</span> <span class="nav-text">测试配置的处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送信号处理"><span class="nav-number">7.3.14.</span> <span class="nav-text">发送信号处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#判断运行方式"><span class="nav-number">7.3.15.</span> <span class="nav-text">判断运行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信号处理"><span class="nav-number">7.3.16.</span> <span class="nav-text">信号处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变更运行状态为守护进程"><span class="nav-number">7.3.17.</span> <span class="nav-text">变更运行状态为守护进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建pid文件"><span class="nav-number">7.3.18.</span> <span class="nav-text">创建pid文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置运行方式"><span class="nav-number">7.3.19.</span> <span class="nav-text">设置运行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行主体循环"><span class="nav-number">7.3.20.</span> <span class="nav-text">执行主体循环</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解析配置"><span class="nav-number">8.</span> <span class="nav-text">解析配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化核心模块"><span class="nav-number">8.1.</span> <span class="nav-text">初始化核心模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置及参数解析"><span class="nav-number">8.2.</span> <span class="nav-text">配置及参数解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关结构"><span class="nav-number">8.2.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-conf-t结构"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">ngx_conf_t结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-conf-file-t结构"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">ngx_conf_file_t结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#词法解析（ngx-conf-read-token）"><span class="nav-number">8.2.2.</span> <span class="nav-text">词法解析（ngx_conf_read_token）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认处理（ngx-conf-handler）"><span class="nav-number">8.2.3.</span> <span class="nav-text">默认处理（ngx_conf_handler）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置配置项解析方式（ngx-commend-S）"><span class="nav-number">8.2.4.</span> <span class="nav-text">设置配置项解析方式（ngx_commend_S）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-str-t-name"><span class="nav-number">8.2.4.1.</span> <span class="nav-text">ngx_str_t  name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-uint-t-type"><span class="nav-number">8.2.4.2.</span> <span class="nav-text">ngx_uint_t type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#char-set-ngx-conf-t-cf-ngx-command-t-cmd-void-conf"><span class="nav-number">8.2.4.3.</span> <span class="nav-text">char(set)(ngx_conf_t cf, ngx_command_t cmd, void *conf)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-uint-t-conf"><span class="nav-number">8.2.4.4.</span> <span class="nav-text">ngx_uint_t conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-uint-t-offset"><span class="nav-number">8.2.4.5.</span> <span class="nav-text">ngx_uint_t offset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-post"><span class="nav-number">8.2.4.6.</span> <span class="nav-text">void *post</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预设配置项处理方法工作原理"><span class="nav-number">8.2.4.7.</span> <span class="nav-text">预设配置项处理方法工作原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http模块配置解析"><span class="nav-number">8.3.</span> <span class="nav-text">http模块配置解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http层set函数"><span class="nav-number">8.3.1.</span> <span class="nav-text">http层set函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-conf-ctx-t"><span class="nav-number">8.3.1.1.</span> <span class="nav-text">ngx_http_conf_ctx_t</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-http-core-module模块生成的三个结构"><span class="nav-number">8.3.1.2.</span> <span class="nav-text">ngx_http_core_module模块生成的三个结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-main-conf-t"><span class="nav-number">8.3.1.2.1.</span> <span class="nav-text">ngx_http_core_main_conf_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-srv-conf-t"><span class="nav-number">8.3.1.2.2.</span> <span class="nav-text">ngx_http_core_srv_conf_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-loc-conf-s"><span class="nav-number">8.3.1.2.3.</span> <span class="nav-text">ngx_http_core_loc_conf_s</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#http级配置解析内存结构"><span class="nav-number">8.3.1.3.</span> <span class="nav-text">http级配置解析内存结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server级别set函数"><span class="nav-number">8.3.2.</span> <span class="nav-text">server级别set函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#server级配置解析内存结构"><span class="nav-number">8.3.2.1.</span> <span class="nav-text">server级配置解析内存结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理监听端口号"><span class="nav-number">8.3.3.</span> <span class="nav-text">管理监听端口号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#对应相关数据结构"><span class="nav-number">8.3.3.1.</span> <span class="nav-text">对应相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-listen-opt-t"><span class="nav-number">8.3.3.1.1.</span> <span class="nav-text">ngx_http_listen_opt_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-url-t"><span class="nav-number">8.3.3.1.2.</span> <span class="nav-text">ngx_url_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-conf-port-t"><span class="nav-number">8.3.3.1.3.</span> <span class="nav-text">ngx_http_conf_port_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-conf-addr-t"><span class="nav-number">8.3.3.1.4.</span> <span class="nav-text">ngx_http_conf_addr_t</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#监听端口与server-虚拟主机间内存关系"><span class="nav-number">8.3.3.2.</span> <span class="nav-text">监听端口与server{}虚拟主机间内存关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set方法"><span class="nav-number">8.3.3.3.</span> <span class="nav-text">set方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-core-listen"><span class="nav-number">8.3.3.3.1.</span> <span class="nav-text">ngx_http_core_listen</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解析url"><span class="nav-number">8.3.3.3.2.</span> <span class="nav-text">解析url</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-parse-url"><span class="nav-number">8.3.3.3.2.1.</span> <span class="nav-text">ngx_parse_url</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-inet-add-addr"><span class="nav-number">8.3.3.3.2.2.</span> <span class="nav-text">ngx_inet_add_addr</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-inet-resolve-host"><span class="nav-number">8.3.3.3.2.3.</span> <span class="nav-text">ngx_inet_resolve_host</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#添加监听地址到ports中"><span class="nav-number">8.3.3.3.3.</span> <span class="nav-text">添加监听地址到ports中</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-listen"><span class="nav-number">8.3.3.3.3.1.</span> <span class="nav-text">ngx_http_add_listen</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-address"><span class="nav-number">8.3.3.3.3.2.</span> <span class="nav-text">ngx_http_add_address</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#gx-http-add-server"><span class="nav-number">8.3.3.3.3.3.</span> <span class="nav-text">gx_http_add_server</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-addresses"><span class="nav-number">8.3.3.3.3.4.</span> <span class="nav-text">ngx_http_add_addresses</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#server-name处理"><span class="nav-number">8.3.3.4.</span> <span class="nav-text">server_name处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相关数据结构"><span class="nav-number">8.3.3.4.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-server-name-t"><span class="nav-number">8.3.3.4.1.1.</span> <span class="nav-text">ngx_http_server_name_t</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#处理逻辑"><span class="nav-number">8.3.3.4.2.</span> <span class="nav-text">处理逻辑</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#server块的快速查找"><span class="nav-number">8.3.3.5.</span> <span class="nav-text">server块的快速查找</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相关数据结构-1"><span class="nav-number">8.3.3.5.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-port-t"><span class="nav-number">8.3.3.5.1.1.</span> <span class="nav-text">ngx_http_port_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-listening-t"><span class="nav-number">8.3.3.5.1.2.</span> <span class="nav-text">ngx_listening_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-in-addr-t"><span class="nav-number">8.3.3.5.1.3.</span> <span class="nav-text">ngx_http_in_addr_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-addr-conf-s"><span class="nav-number">8.3.3.5.1.4.</span> <span class="nav-text">ngx_http_addr_conf_s</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-virtual-names-t"><span class="nav-number">8.3.3.5.1.5.</span> <span class="nav-text">ngx_http_virtual_names_t</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-optimize-servers"><span class="nav-number">8.3.3.5.2.</span> <span class="nav-text">ngx_http_optimize_servers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-server-names"><span class="nav-number">8.3.3.5.3.</span> <span class="nav-text">ngx_http_server_names</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ngx-http-init-listening"><span class="nav-number">8.3.3.5.4.</span> <span class="nav-text">ngx_http_init_listening</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-listening"><span class="nav-number">8.3.3.5.4.1.</span> <span class="nav-text">ngx_http_add_listening</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ngx-http-add-addrs"><span class="nav-number">8.3.3.5.4.2.</span> <span class="nav-text">ngx_http_add_addrs</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location层set函数"><span class="nav-number">8.3.4.</span> <span class="nav-text">location层set函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#loc级配置解析内存结构"><span class="nav-number">8.3.4.1.</span> <span class="nav-text">loc级配置解析内存结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#正则表达式解析"><span class="nav-number">8.3.4.2.</span> <span class="nav-text">正则表达式解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项合并"><span class="nav-number">8.4.</span> <span class="nav-text">配置项合并</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-merge-servers"><span class="nav-number">8.4.1.</span> <span class="nav-text">ngx_http_merge_servers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-merge-locations"><span class="nav-number">8.4.2.</span> <span class="nav-text">ngx_http_merge_locations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建location配置树"><span class="nav-number">8.5.</span> <span class="nav-text">创建location配置树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http头初始化"><span class="nav-number">8.6.</span> <span class="nav-text">http头初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理阶段"><span class="nav-number">8.7.</span> <span class="nav-text">处理阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化处理阶段"><span class="nav-number">8.7.1.</span> <span class="nav-text">初始化处理阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求处理阶段"><span class="nav-number">8.7.2.</span> <span class="nav-text">请求处理阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#每个阶段的checker函数"><span class="nav-number">8.7.3.</span> <span class="nav-text">每个阶段的checker函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#变量"><span class="nav-number">9.</span> <span class="nav-text">变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相关结构-1"><span class="nav-number">9.1.</span> <span class="nav-text">相关结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#存储变量名的数据结构"><span class="nav-number">9.1.1.</span> <span class="nav-text">存储变量名的数据结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析变量"><span class="nav-number">9.2.</span> <span class="nav-text">解析变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#data参数不起作用"><span class="nav-number">9.2.1.</span> <span class="nav-text">data参数不起作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data参数作为指针"><span class="nav-number">9.2.2.</span> <span class="nav-text">data参数作为指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data作为内存的相对偏移量"><span class="nav-number">9.2.3.</span> <span class="nav-text">data作为内存的相对偏移量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查找变量"><span class="nav-number">9.3.</span> <span class="nav-text">查找变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-variable-index"><span class="nav-number">9.3.1.</span> <span class="nav-text">ngx_http_get_variable_index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-indexed-variable"><span class="nav-number">9.3.2.</span> <span class="nav-text">ngx_http_get_indexed_variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-flushed-variable"><span class="nav-number">9.3.3.</span> <span class="nav-text">ngx_http_get_flushed_variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-get-value"><span class="nav-number">9.3.4.</span> <span class="nav-text">ngx_http_get_value</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加系统变量"><span class="nav-number">9.4.</span> <span class="nav-text">添加系统变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-add-variable"><span class="nav-number">9.4.1.</span> <span class="nav-text">ngx_http_add_variable</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#外部变量和脚本引擎"><span class="nav-number">9.5.</span> <span class="nav-text">外部变量和脚本引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关数据结构-2"><span class="nav-number">9.5.1.</span> <span class="nav-text">相关数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译set脚本"><span class="nav-number">9.5.2.</span> <span class="nav-text">编译set脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量间merge"><span class="nav-number">9.6.</span> <span class="nav-text">变量间merge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#举例"><span class="nav-number">9.7.</span> <span class="nav-text">举例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#共享内存"><span class="nav-number">10.</span> <span class="nav-text">共享内存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#锁机制"><span class="nav-number">11.</span> <span class="nav-text">锁机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相关数据结构-3"><span class="nav-number">11.1.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-shmtx-t"><span class="nav-number">11.1.1.</span> <span class="nav-text">ngx_shmtx_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-shmtx-sh-t"><span class="nav-number">11.1.2.</span> <span class="nav-text">ngx_shmtx_sh_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建锁"><span class="nav-number">11.2.</span> <span class="nav-text">创建锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#销毁锁"><span class="nav-number">11.3.</span> <span class="nav-text">销毁锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#非阻塞获取锁"><span class="nav-number">11.4.</span> <span class="nav-text">非阻塞获取锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#阻塞式获取锁"><span class="nav-number">11.5.</span> <span class="nav-text">阻塞式获取锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#释放锁"><span class="nav-number">11.6.</span> <span class="nav-text">释放锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#释放信号"><span class="nav-number">11.7.</span> <span class="nav-text">释放信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#强制释放锁"><span class="nav-number">11.8.</span> <span class="nav-text">强制释放锁</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chst</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '0j9TGrGA2Aq8e4SO1sUkgQCv-gzGzoHsz',
        appKey: 'Q6jotQjlp43pwpkFCJhQ9s95',
        placeholder: '请留下联系方式，我会尽快回复',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("0j9TGrGA2Aq8e4SO1sUkgQCv-gzGzoHsz", "Q6jotQjlp43pwpkFCJhQ9s95");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
