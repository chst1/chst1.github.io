<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="æ’åº,">










<meta name="description" content="LambdaMartç®—æ³•ä½œä¸ºç»å…¸çš„æœç´¢æ’åºç®—æ³•ï¼Œè‡³ä»Šä¾ç„¶è¢«å„å¤§äº’è”ç½‘å…¬å¸ä½¿ç”¨ï¼Œåœ¨å·¥ä½œä¸­ä½¿ç”¨åˆ°è¯¥ç®—æ³•ï¼Œè¿™é‡Œè¿›è¡Œè¯¦ç»†å­¦ä¹ ã€‚">
<meta name="keywords" content="æ’åº">
<meta property="og:type" content="article">
<meta property="og:title" content="LambdaMartç®—æ³•åŸç†ä¸å®ç°">
<meta property="og:url" content="http://yoursite.com/2021/12/11/LambdaMartåŸç†åŠå®ç°/index.html">
<meta property="og:site_name" content="chst&#39;s Blog">
<meta property="og:description" content="LambdaMartç®—æ³•ä½œä¸ºç»å…¸çš„æœç´¢æ’åºç®—æ³•ï¼Œè‡³ä»Šä¾ç„¶è¢«å„å¤§äº’è”ç½‘å…¬å¸ä½¿ç”¨ï¼Œåœ¨å·¥ä½œä¸­ä½¿ç”¨åˆ°è¯¥ç®—æ³•ï¼Œè¿™é‡Œè¿›è¡Œè¯¦ç»†å­¦ä¹ ã€‚">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://z3.ax1x.com/2021/10/24/5WQ0JI.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/10/24/5WNCo8.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/10/24/5fujCq.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/10/28/5qj7Z9.png">
<meta property="og:updated_time" content="2021-12-11T12:59:44.241Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LambdaMartç®—æ³•åŸç†ä¸å®ç°">
<meta name="twitter:description" content="LambdaMartç®—æ³•ä½œä¸ºç»å…¸çš„æœç´¢æ’åºç®—æ³•ï¼Œè‡³ä»Šä¾ç„¶è¢«å„å¤§äº’è”ç½‘å…¬å¸ä½¿ç”¨ï¼Œåœ¨å·¥ä½œä¸­ä½¿ç”¨åˆ°è¯¥ç®—æ³•ï¼Œè¿™é‡Œè¿›è¡Œè¯¦ç»†å­¦ä¹ ã€‚">
<meta name="twitter:image" content="https://z3.ax1x.com/2021/10/24/5WQ0JI.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/12/11/LambdaMartåŸç†åŠå®ç°/">





  <title>LambdaMartç®—æ³•åŸç†ä¸å®ç° | chst's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">chst's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ä¸ªäººç½‘ç«™</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/11/LambdaMartåŸç†åŠå®ç°/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chst">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chst's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LambdaMartç®—æ³•åŸç†ä¸å®ç°</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-12-11T16:31:59+08:00">
                2021-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æœºå™¨å­¦ä¹ /" itemprop="url" rel="index">
                    <span itemprop="name">æœºå™¨å­¦ä¹ </span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/12/11/LambdaMartåŸç†åŠå®ç°/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/12/11/LambdaMartåŸç†åŠå®ç°/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/12/11/LambdaMartåŸç†åŠå®ç°/" class="leancloud_visitors" data-flag-title="LambdaMartç®—æ³•åŸç†ä¸å®ç°">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  
                </span>
              
            </div>
          

          
              <div class="post-description">
                  LambdaMartç®—æ³•ä½œä¸ºç»å…¸çš„æœç´¢æ’åºç®—æ³•ï¼Œè‡³ä»Šä¾ç„¶è¢«å„å¤§äº’è”ç½‘å…¬å¸ä½¿ç”¨ï¼Œåœ¨å·¥ä½œä¸­ä½¿ç”¨åˆ°è¯¥ç®—æ³•ï¼Œè¿™é‡Œè¿›è¡Œè¯¦ç»†å­¦ä¹ ã€‚
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="NDCGè¯„ä¼°æŒ‡æ ‡"><a href="#NDCGè¯„ä¼°æŒ‡æ ‡" class="headerlink" title="NDCGè¯„ä¼°æŒ‡æ ‡"></a>NDCGè¯„ä¼°æŒ‡æ ‡</h1><p>NDCGç”¨äºè¯„ä¼°æœç´¢è¿”å›çš„ç»“æœç›¸å…³æ€§æŒ‡æ ‡ã€‚å…¶ç”±CGè½¬æ¢åˆ°DCGå†å‘å±•å‡ºnDCGã€‚ä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚</p>
<h2 id="ç´¯è®¡å¢ç›Š-CG"><a href="#ç´¯è®¡å¢ç›Š-CG" class="headerlink" title="ç´¯è®¡å¢ç›Š(CG)"></a>ç´¯è®¡å¢ç›Š(CG)</h2><p>CGï¼Œcumulative gainï¼Œæ˜¯DCGçš„å‰èº«ï¼Œåªè€ƒè™‘åˆ°äº†ç›¸å…³æ€§çš„å…³è”ç¨‹åº¦ï¼Œæ²¡æœ‰è€ƒè™‘åˆ°ä½ç½®çš„å› ç´ ã€‚å®ƒæ˜¯ä¸€ä¸ªæœç´ ç»“æœç›¸å…³æ€§åˆ†æ•°çš„æ€»å’Œã€‚æŒ‡å®šä½ç½®Pä¸Šçš„CGä¸ºï¼š</p>
<script type="math/tex; mode=display">
CG_P=\sum_{i=1}^P rel_i</script><p>å…¶ä¸­$rel_i$ä¸ºç¬¬$i$ä¸ªä½ç½®ä¸Šçš„æ–‡æ¡£å’Œqueryçš„ç›¸å…³æ€§ã€‚</p>
<p>è¯¥åº¦é‡æ–¹æ³•å­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºå…¶æ— æ³•åŒºåˆ†æ’åºé¡ºåºï¼Œåªèƒ½åˆ¤æ–­å¬å›çš„æ•°æ®æ˜¯å¦ç›¸å…³ï¼Œæ¯”å¦‚ä¸€ä¸ªqueryåº”è¯¥å¬å›ä¸‰ä¸ªæ–‡æ¡£$a,b,c$ã€‚å…¶ç›¸å…³æ€§ä¾æ¬¡é™ä½ï¼Œä½†å¦‚æœå¬å›çš„å®é™…é¡ºåºæ˜¯$c,b,a$æ—¶ï¼Œè¯¥è¯„ä¼°æŒ‡æ ‡å’Œæœ€ä¼˜æƒ…å†µä¸‹çš„æŒ‡æ ‡å€¼æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¼•å…¥äº†DCGã€‚</p>
<h2 id="æŠ˜æŸç´¯è®¡å¢ç›Š-DCG"><a href="#æŠ˜æŸç´¯è®¡å¢ç›Š-DCG" class="headerlink" title="æŠ˜æŸç´¯è®¡å¢ç›Š(DCG)"></a>æŠ˜æŸç´¯è®¡å¢ç›Š(DCG)</h2><p>ç›¸æ¯”äºCGï¼ŒDCGåœ¨CGçš„æ¯ä¸€ä¸ªç»“æœä¸Šå¢åŠ äº†ä¸€ä¸ªæŠ˜æŸå€¼ã€‚ç›®çš„å°±æ˜¯ä¸ºäº†è®©æ’åè¶Šé å‰çš„ç»“æœè¶Šèƒ½å½±å“æœ€åçš„ç»“æœã€‚å‡è®¾æ’åºè¶Šå¾€åï¼Œä»·å€¼è¶Šä½ã€‚åˆ°ç¬¬iä¸ªä½ç½®çš„æ—¶å€™ï¼Œå®ƒçš„ä»·å€¼æ˜¯ $\frac{1}{log_2{(i+1)}}$ï¼Œé‚£ä¹ˆç¬¬iä¸ªç»“æœäº§ç”Ÿçš„æ•ˆç›Šå°±æ˜¯ $rel_i * \frac{1}{log_2{(i+1)}}$ï¼Œå› æ­¤ï¼š</p>
<script type="math/tex; mode=display">
DCG_P\sum_i^P\frac{rel_i}{log_2{(i+1)}}</script><p>å› ä¸ºæ˜¯ä¹˜ä»¥ä¸€ä¸ªæŠ˜æŸå€¼ï¼Œå› æ­¤è¯¥å€¼å¯ä»¥å–åˆ«çš„å‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´åŠ å¸¸ç”¨çš„å…¬å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
DCG_P\sum_i^P\frac{2^{rel_i}-1}{log_2{(i+1)}}</script><p>DCGè§£å†³äº†åŒä¸€ä¸ªqueryä¸‹æ’åºçš„æŒ‡æ ‡ï¼Œä½†æ˜¯å¯¹äºä¸åŒqueryå…¶å¬å›çš„æ–‡æ¡£æ•°é‡æ˜¯ä¸ä¸€è‡´çš„ï¼ŒDCGé‡‡ç”¨çš„æ˜¯ç´¯åŠ çš„æ–¹å¼ï¼Œè¿™å¯¹åº”å¬å›æ–‡æ¡£æ›´å¤šçš„queryæ˜¯æ›´åŠ å‹å¥½çš„ï¼Œä½†ä¸ç¬¦åˆå®é™…ä½¿ç”¨ï¼Œå› æ­¤NDCGè¢«æå‡ºä»¥æ”¹è¿›DCGã€‚</p>
<h2 id="å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š-NDCG"><a href="#å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š-NDCG" class="headerlink" title="å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š(NDCG)"></a>å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š(NDCG)</h2><p>ç”±äºDCGæ˜¯ä¸€ä¸ªç´¯åŠ å€¼ï¼Œæ— æ³•å¯¹ä¸åŒæœç´¢ç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤NDCCå¯¹æ¯ä¸ªqueryçš„ç»“æœè¿›è¡Œäº†å½’ä¸€åŒ–æ“ä½œï¼Œå…¶æ–¹æ³•æ˜¯å¯¹DCGå€¼é™¤ä»¥IDCG(ç†æƒ³æƒ…å†µä¸‹æœ€å¤§DCGå€¼)ï¼š</p>
<script type="math/tex; mode=display">
nDCG_P=\frac{DCG_p}{IDCG_p}</script><script type="math/tex; mode=display">
IDCG_P = \sum_{i=1}^{\vert RET \vert}\frac{2^{rel_i}-1}{log_2{(i+1)}}</script><p>å…¶ä¸­$\vert REL \vert$è¡¨ç¤ºï¼Œç»“æœæŒ‰ç…§ç›¸å…³æ€§ä»å¤§åˆ°å°çš„é¡ºåºæ’åºï¼Œå–å‰Pä¸ªç»“æ„ç»„åˆæˆçš„é›†åˆï¼Œå³æŒ‰ç…§æœ€ä¼˜çš„æ–¹å¼å¯¹ç»“æœè¿›è¡Œæ’åºæ˜¯çš„DCGå€¼ã€‚</p>
<h1 id="æ’åºå­¦ä¹ LTR"><a href="#æ’åºå­¦ä¹ LTR" class="headerlink" title="æ’åºå­¦ä¹ LTR"></a>æ’åºå­¦ä¹ LTR</h1><p><strong>æ’åºå­¦ä¹ ï¼ˆLearning to Rankï¼ŒLTRï¼‰</strong>ï¼Œä¹Ÿç§°<strong>æœºå™¨æ’åºå­¦ä¹ ï¼ˆMachine-learned Rankingï¼ŒMLR)</strong> ï¼Œå°±æ˜¯ä½¿ç”¨æœºå™¨å­¦ä¹ çš„æŠ€æœ¯è§£å†³æ’åºé—®é¢˜ã€‚</p>
<p>ä¼ ç»Ÿçš„æ£€ç´¢æ¨¡å‹æ‰€è€ƒè™‘çš„å› ç´ å¹¶ä¸å¤šï¼Œä¸»è¦æ˜¯åˆ©ç”¨è¯é¢‘ã€é€†æ–‡æ¡£é¢‘ç‡å’Œæ–‡æ¡£é•¿åº¦ã€æ–‡æ¡£é‡è¦åº¦è¿™å‡ ä¸ªå› å­æ¥äººå·¥æ‹Ÿåˆæ’åºå…¬å¼ï¼Œä¸”å…¶ä¸­å¤§å¤šæ•°æ¨¡å‹éƒ½åŒ…å«å‚æ•°ï¼Œä¹Ÿå°±éœ€è¦é€šè¿‡ä¸æ–­çš„å®éªŒç¡®å®šæœ€ä½³çš„å‚æ•°ç»„åˆï¼Œä»¥æ­¤æ¥å½¢æˆç›¸å…³æ€§æ‰“åˆ†ã€‚</p>
<p>LTR åˆ™æ˜¯åŸºäºç‰¹å¾ï¼Œé€šè¿‡æœºå™¨å­¦ä¹ ç®—æ³•è®­ç»ƒæ¥å­¦ä¹ åˆ°æœ€ä½³çš„æ‹Ÿåˆå…¬å¼ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„æ’åºæ–¹æ³•ã€‚</p>
<p>æ’åºå­¦ä¹ çš„æ¨¡å‹é€šå¸¸åˆ†ä¸º<strong>å•ç‚¹æ³•ï¼ˆPointwise Approachï¼‰</strong>ã€<strong>é…å¯¹æ³•ï¼ˆPairwise Approachï¼‰</strong>å’Œ<strong>åˆ—è¡¨æ³•ï¼ˆListwise</strong> <strong>Approachï¼‰</strong>ä¸‰å¤§ç±»ï¼Œä¸‰ç§æ–¹æ³•å¹¶ä¸æ˜¯ç‰¹å®šçš„ç®—æ³•ï¼Œè€Œæ˜¯æ’åºå­¦ä¹ æ¨¡å‹çš„è®¾è®¡æ€è·¯ï¼Œä¸»è¦åŒºåˆ«ä½“ç°åœ¨æŸå¤±å‡½æ•°ï¼ˆLoss Functionï¼‰ã€ä»¥åŠç›¸åº”çš„æ ‡ç­¾æ ‡æ³¨æ–¹å¼å’Œä¼˜åŒ–æ–¹æ³•çš„ä¸åŒã€‚</p>
<h2 id="å•ç‚¹æ³•"><a href="#å•ç‚¹æ³•" class="headerlink" title="å•ç‚¹æ³•"></a>å•ç‚¹æ³•</h2><p>å•ç‚¹æ³•æ’åºå­¦ä¹ æ¨¡å‹çš„æ¯ä¸€ä¸ªè®­ç»ƒæ ·æœ¬éƒ½ä»…ä»…æ˜¯æŸä¸€ä¸ªæŸ¥è¯¢å…³é”®å­—å’ŒæŸä¸€ä¸ªæ–‡æ¡£çš„é…å¯¹ã€‚å®ƒä»¬ä¹‹é—´æ˜¯å¦ç›¸å…³ï¼Œä¸å…¶ä»–æ–‡æ¡£å’Œå…¶ä»–æŸ¥è¯¢å…³é”®å­—éƒ½æ²¡æœ‰å…³ç³»ã€‚</p>
<h2 id="é…å¯¹æ³•"><a href="#é…å¯¹æ³•" class="headerlink" title="é…å¯¹æ³•"></a>é…å¯¹æ³•</h2><p>é…å¯¹æ³•çš„åŸºæœ¬æ€è·¯æ˜¯å¯¹æ ·æœ¬è¿›è¡Œä¸¤ä¸¤æ¯”è¾ƒï¼Œæ„å»ºååºæ–‡æ¡£å¯¹ï¼Œä»æ¯”è¾ƒä¸­å­¦ä¹ æ’åºï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªæŸ¥è¯¢å…³é”®å­—æ¥è¯´ï¼Œæœ€é‡è¦çš„å…¶å®ä¸æ˜¯é’ˆå¯¹æŸä¸€ä¸ªæ–‡æ¡£çš„ç›¸å…³æ€§æ˜¯å¦ä¼°è®¡å¾—å‡†ç¡®ï¼Œè€Œæ˜¯è¦èƒ½å¤Ÿæ­£ç¡®ä¼°è®¡ä¸€ç»„æ–‡æ¡£ä¹‹é—´çš„ â€œç›¸å¯¹å…³ç³»â€ã€‚</p>
<h2 id="åˆ—è¡¨æ³•"><a href="#åˆ—è¡¨æ³•" class="headerlink" title="åˆ—è¡¨æ³•"></a>åˆ—è¡¨æ³•</h2><p>ç›¸å¯¹äºå°è¯•å­¦ä¹ æ¯ä¸€ä¸ªæ ·æœ¬æ˜¯å¦ç›¸å…³æˆ–è€…ä¸¤ä¸ªæ–‡æ¡£çš„ç›¸å¯¹æ¯”è¾ƒå…³ç³»ï¼Œåˆ—è¡¨æ³•æ’åºå­¦ä¹ çš„åŸºæœ¬æ€è·¯æ˜¯å°è¯•ç›´æ¥ä¼˜åŒ–åƒ NDCGï¼ˆNormalized Discounted Cumulative Gainï¼‰è¿™æ ·çš„æŒ‡æ ‡ï¼Œä»è€Œèƒ½å¤Ÿå­¦ä¹ åˆ°æœ€ä½³æ’åºç»“æœã€‚</p>
<h1 id="LambdaMARTç®—æ³•"><a href="#LambdaMARTç®—æ³•" class="headerlink" title="LambdaMARTç®—æ³•"></a>LambdaMARTç®—æ³•</h1><p>LambdaMART çš„æå‡ºå…ˆåç»ç”± RankNetã€LambdaRank é€æ­¥æ¼”åŒ–è€Œæ¥ã€‚</p>
<h2 id="RankNet"><a href="#RankNet" class="headerlink" title="RankNet"></a>RankNet</h2><p>RankNet çš„æ ¸å¿ƒæ˜¯<strong>æå‡ºäº†ä¸€ç§æ¦‚ç‡æŸå¤±å‡½æ•°æ¥å­¦ä¹  Ranking Function</strong>ï¼Œå¹¶åº”ç”¨ Ranking Function å¯¹æ–‡æ¡£è¿›è¡Œæ’åºã€‚</p>
<p>RankNetç½‘ç»œå°†è¾“å…¥queryçš„ç‰¹å¾å‘é‡$x\in R^n$,æ˜ å°„ä¸ºä¸€ä¸ªå®æ•°$f(x) \in R$ã€‚å…·ä½“çš„ï¼Œç»™å®šä¸¤ä¸ªqueryä¸‹çš„ä¸¤ä¸ªæ–‡æ¡£$U_i$å’Œ$U_j$ï¼Œå…¶ç‰¹å¾å€¼åˆ†åˆ«ä¸º$x_i$ï¼Œ$x_j$ï¼Œç»è¿‡RankNetè¿›è¡Œå‰å‘è®¡ç®—å¾—åˆ°ç›¸åº”çš„å¯¹åº”åˆ†æ•°$s_i = f(x_i) $,$s_j=f(x_j)$ã€‚ä½¿ç”¨$U_i \triangleright U_j$è¡¨ç¤º$U_i$æ¯”$U_j$æ’åºæ›´é å‰ï¼ˆå¦‚å¯¹æŸä¸ª query æ¥è¯´ï¼Œğ‘ˆğ‘– è¢«æ ‡è®°ä¸º â€œgoodâ€ï¼Œğ‘ˆğ‘— è¢«æ ‡è®°ä¸º â€œbadâ€ï¼‰ã€‚RankNetæŠŠæ’åºé—®é¢˜è½¬åŒ–æˆæ¯”è¾ƒä¸€ä¸ª$(U_i,U_j)$æ–‡æ¡£å¯¹çš„æ’åºé—®é¢˜ï¼Œé¦–å…ˆè®¡ç®—æ¯ä¸ªæ–‡æ¡£å¾—åˆ†ï¼Œå®šä¹‰ä½¿ç”¨ä¸‹é¢çš„å…¬å¼è®¡ç®—æ ¹æ®æ¨¡å‹å¾—åˆ†è·å–çš„$U_i$æ¯”$U_j$æ’åºæ›´é å‰çš„æ¦‚ç‡ï¼š</p>
<script type="math/tex; mode=display">
P_{ij} \equiv P(U_i \triangleright U_j) \equiv \frac{1}{1+e^{-\sigma(s_i-s_j)}}</script><p>è¿™ä¸ªæ¦‚ç‡å°±æ˜¯æ·±åº¦å­¦ä¹ ä¸­å¸¸ç”¨çš„sigmoidå‡½æ•°ï¼Œç”±äºå‚æ•°$\sigma$åªå½±å“å‡½æ•°å½¢çŠ¶ï¼Œå¯¹æœ€ç»ˆç»“æœå½±å“ä¸å¤§ï¼Œå› æ­¤é€šå¸¸ä½¿ç”¨$\sigma=1$è¿›è¡Œç®€åŒ–ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°RankNeté¢„æµ‹çš„åˆ†æ•°$s_i&gt;s_j$ä¸”å·®è·è¶Šå¤§æ—¶ï¼Œ$P_{ij}$è¶Šæ¥è¿‘1ï¼Œå³$U_i$æ’åºå°±åº”è¯¥åœ¨$U_j$å‰æ¦‚ç‡è¶Šå¤§ï¼Œåä¹‹åˆ™$U_j$åœ¨$U_i$ä¹‹å‰æ¦‚ç‡è¶Šå¤§ã€‚</p>
<p>RankNet è¯æ˜äº†å¦‚æœçŸ¥é“ä¸€ä¸ªå¾…æ’åºæ–‡æ¡£çš„æ’åˆ—ä¸­ç›¸é‚»ä¸¤ä¸ªæ–‡æ¡£ä¹‹é—´çš„æ’åºæ¦‚ç‡ï¼Œåˆ™é€šè¿‡æ¨å¯¼å¯ä»¥ç®—å‡ºæ¯ä¸¤ä¸ªæ–‡æ¡£ä¹‹é—´çš„æ’åºæ¦‚ç‡ã€‚å› æ­¤å¯¹äºä¸€ä¸ªå¾…æ’åºæ–‡æ¡£åºåˆ—ï¼Œåªéœ€è®¡ç®—ç›¸é‚»æ–‡æ¡£ä¹‹é—´çš„æ’åºæ¦‚ç‡ï¼Œä¸éœ€è¦è®¡ç®—æ‰€æœ‰ pairï¼Œå‡å°‘è®¡ç®—é‡ã€‚</p>
<h3 id="çœŸå®çš„ç›¸å…³æ€§æ¦‚ç‡"><a href="#çœŸå®çš„ç›¸å…³æ€§æ¦‚ç‡" class="headerlink" title="çœŸå®çš„ç›¸å…³æ€§æ¦‚ç‡"></a>çœŸå®çš„ç›¸å…³æ€§æ¦‚ç‡</h3><p>å¯¹äºç‰¹å®šqueryï¼Œå®šä¹‰$S_{ij} \in {0,\pm 1}$ä¸ºæ–‡æ¡£$U_i$å’Œæ–‡æ¡£$U_j$è¢«æ ‡è®°çš„æ ‡ç­¾ä¹‹é—´çš„å…³è”ï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
S_{ij} =
\begin{cases}
1,\qquad U_iæ¯”U_jæ›´ç›¸å…³ \\
0,\qquad U_iå’ŒU_jç›¸å…³æ€§ä¸€è‡´ \\
-1,\qquad U_jæ¯”U_iæ›´ç›¸å…³
\end{cases}</script><p>å› æ­¤å¯ä»¥å®šä¹‰æ–‡æ¡£$U_i$æ¯”æ–‡æ¡£$U_j$æ›´ç›¸å…³çš„çœŸå®æ¦‚ç‡ä¸ºï¼š</p>
<script type="math/tex; mode=display">
\overline{P_{ij}} = \frac{1}{1+S_{ij}}</script><h3 id="æŸå¤±å‡½æ•°"><a href="#æŸå¤±å‡½æ•°" class="headerlink" title="æŸå¤±å‡½æ•°"></a>æŸå¤±å‡½æ•°</h3><p>å¯¹äºä¸€ä¸ªæ’åºï¼ŒRankNet ä»å„ä¸ª doc çš„ç›¸å¯¹å…³ç³»æ¥è¯„ä»·æ’åºç»“æœçš„å¥½åï¼Œæ’åºçš„æ•ˆæœè¶Šå¥½ï¼Œé‚£ä¹ˆæœ‰é”™è¯¯ç›¸å¯¹å…³ç³»çš„ pair å°±è¶Šå°‘ã€‚æ‰€è°“é”™è¯¯çš„ç›¸å¯¹å…³ç³»å³å¦‚æœæ ¹æ®æ¨¡å‹è¾“å‡º ğ‘ˆğ‘– æ’åœ¨ ğ‘ˆğ‘— å‰é¢ï¼Œä½†çœŸå® label ä¸º ğ‘ˆğ‘– çš„ç›¸å…³æ€§å°äº ğ‘ˆğ‘—ï¼Œé‚£ä¹ˆå°±è®°ä¸€ä¸ªé”™è¯¯ pairï¼Œ<strong>RankNet æœ¬è´¨ä¸Šå°±æ˜¯ä»¥é”™è¯¯çš„ pair æœ€å°‘ä¸ºä¼˜åŒ–ç›®æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´ RankNet çš„ç›®çš„æ˜¯ä¼˜åŒ–é€†åºå¯¹æ•°ã€‚è€Œåœ¨æŠ½è±¡æˆæŸå¤±å‡½æ•°æ—¶ï¼ŒRankNet å®é™…ä¸Šæ˜¯å¼•å…¥äº†æ¦‚ç‡çš„æ€æƒ³ï¼šä¸æ˜¯ç›´æ¥åˆ¤æ–­ ğ‘ˆğ‘– æ’åœ¨ ğ‘ˆğ‘— å‰é¢ï¼Œè€Œæ˜¯è¯´ ğ‘ˆğ‘– ä»¥ä¸€å®šçš„æ¦‚ç‡ P æ’åœ¨ ğ‘ˆğ‘— å‰é¢ï¼Œå³æ˜¯ä»¥é¢„æµ‹æ¦‚ç‡ä¸çœŸå®æ¦‚ç‡çš„å·®è·æœ€å°ä½œä¸ºä¼˜åŒ–ç›®æ ‡ã€‚</strong>æœ€åï¼Œ<strong>RankNet ä½¿ç”¨äº¤å‰ç†µï¼ˆCross Entropyï¼‰ä½œä¸ºæŸå¤±å‡½æ•°</strong>ï¼Œæ¥è¡¡é‡ $P_{ij}$ å¯¹ $\overline{P_{ij}}$ çš„æ‹Ÿåˆç¨‹åº¦ï¼š</p>
<script type="math/tex; mode=display">
L = - \overline{P_{ij}}logP_{ij} - (1-\overline{P_{ij}})log(1-P_{ij})</script><p>åŒ–ç®€åï¼š</p>
<script type="math/tex; mode=display">
L_{ij} = \frac{(1-S_{ij}) \sigma (s_i-s_j)}{2}+log(1+e^{-\sigma(s_i-s_j)})</script><p>å½“$S_{ij}=1$æ—¶ï¼š</p>
<script type="math/tex; mode=display">
L_{ij} = log(1+e^{-\sigma(s_i-s_j)})</script><p>å½“$S_{ij}=-1$æ—¶ï¼š</p>
<script type="math/tex; mode=display">
L_{ij} = \sigma (s_i-s_j) + log(1+e^{-\sigma(s_i-s_j)})  = log(1+e^{-\sigma(s_j-s_i)})</script><p>ä»æŸå¤±å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå¯¹æ–‡æ¡£$U_i$å’Œ$U_j$çš„æ‰“åˆ†å¯ä»¥æ­£ç¡®æ‹Ÿåˆæ ‡ç­¾æ—¶ï¼Œåˆ™$L_{ij}$è¶‹äº0ï¼Œå¦åˆ™è¶‹äºçº¿æ€§å‡½æ•°ã€‚å…·ä½“çš„ï¼Œå‡å¦‚$S_{ij}$=1,åˆ™$U_i$åº”è¯¥æ¯”$U_j$æ’åºé«˜ï¼š</p>
<p>å¦‚æœ$s_i &gt; s_j$åˆ™æ‹Ÿåˆçš„åˆ†æ•°å¯ä»¥æ­£ç¡®æ’åºæ–‡æ¡£ï¼š</p>
<script type="math/tex; mode=display">
\underset{si-sj \rightarrow \infty}{lim} L_{ij}  =  \underset{si-sj \rightarrow \infty}{lim}log(1+e^{-\sigma(s_i-s_j)}) = log1=0</script><p>å¦‚æœ$s_i&lt;s_j$ï¼Œåˆ™æ‹Ÿåˆçš„åˆ†æ•°ä¸èƒ½æ­£ç¡®æ’åºæ–‡æ¡£ï¼š</p>
<script type="math/tex; mode=display">
\underset{si-sj \rightarrow -\infty}{lim} L_{ij}  =  \underset{si-sj \rightarrow -\infty}{lim}log(1+e^{-\sigma(s_i-s_j)})=log(e^{-\sigma(s_i-s_j)}) = -\sigma(s_i-s_j)</script><p>ä¸‹å›¾å±•ç¤ºäº†å½“$S_{ij}$åˆ†åˆ«å–1ï¼Œ0ï¼Œ-1æ—¶ï¼ŒæŸå¤±å‡½æ•°ä»¥$s_i-s_j$ä¸ºå˜é‡çš„å–å€¼ç¤ºæ„å›¾ï¼š</p>
<p><a href="https://imgtu.com/i/5WQ0JI" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/10/24/5WQ0JI.png" alt="5WQ0JI.png"></a></p>
<p>è¯¥æŸå¤±å‡½æ•°å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>å½“ä¸¤ä¸ªç›¸å…³æ€§ä¸åŒçš„æ–‡æ¡£ç®—å‡ºæ¥çš„æ¨¡å‹åˆ†æ•°ç›¸åŒæ—¶ï¼Œå³ ğ‘ ğ‘–=ğ‘ ğ‘—ï¼Œæ­¤æ—¶çš„æŸå¤±å‡½æ•°çš„å€¼ä¸º log2ï¼Œä¾ç„¶å¤§äº 0ï¼Œä»ä¼šå¯¹è¿™å¯¹ pair åšæƒ©ç½šï¼Œä½¿ä»–ä»¬çš„æ’åºä½ç½®åŒºåˆ†å¼€ã€‚</li>
<li>æŸå¤±å‡½æ•°æ˜¯ä¸€ä¸ªç±»çº¿æ€§å‡½æ•°ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘å¼‚å¸¸æ ·æœ¬æ•°æ®å¯¹æ¨¡å‹çš„å½±å“ï¼Œå› æ­¤å…·æœ‰é²æ£’æ€§ã€‚</li>
</ol>
<p>Ranknet æœ€ç»ˆç›®æ ‡æ˜¯è®­ç»ƒå‡ºä¸€ä¸ªæ‰“åˆ†å‡½æ•°$s=f(x,w)$ï¼Œä½¿å¾—æ‰€æœ‰ pair çš„æ’åºæ¦‚ç‡ä¼°è®¡çš„æŸå¤±æœ€å°ï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
L = \sum_{(i,j) \in I} L_{ij}</script><p>å…¶ä¸­ï¼Œğ¼ è¡¨ç¤ºæ‰€æœ‰åœ¨åŒä¸€ query ä¸‹ï¼Œä¸”å…·æœ‰ä¸åŒç›¸å…³æ€§åˆ¤æ–­çš„ doc pairï¼Œæ¯ä¸ª pair æœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚</p>
<p>é€šå¸¸è¯¥æ‰“åˆ†å‡½æ•°åªè¦å…‰æ»‘å¯å¯¼å³å¯ã€‚</p>
<h3 id="å‚æ•°æ›´æ–°"><a href="#å‚æ•°æ›´æ–°" class="headerlink" title="å‚æ•°æ›´æ–°"></a>å‚æ•°æ›´æ–°</h3><p>RankNet é‡‡ç”¨ç¥ç»ç½‘ç»œæ¨¡å‹ä¼˜åŒ–æŸå¤±å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åå‘ä¼ æ’­è¿‡ç¨‹ï¼Œé‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•æ±‚è§£å¹¶æ›´æ–°å‚æ•°ï¼š</p>
<script type="math/tex; mode=display">
w_k = w_k - \eta \frac{\partial L} {\partial w_k}</script><p>å…¶ä¸­$\eta$ä¸ºå­¦ä¹ ç‡ã€‚RankNet æ˜¯ä¸€ç§æ–¹æ³•æ¡†æ¶ï¼Œå› æ­¤è¿™é‡Œçš„ ğ‘¤ğ‘˜ å¯ä»¥æ˜¯ NNã€LRã€GBDT ç­‰ç®—æ³•çš„æƒé‡ã€‚</p>
<p>å¯¹RankNetçš„æ¢¯åº¦$\frac{\partial L} {\partial w_k}$è¿›è¡Œå› å¼åˆ†è§£ï¼Œæœ‰ï¼š</p>
<script type="math/tex; mode=display">
\frac{\partial L} {\partial w_k} = \sum_{(i,j)\in I}\frac{\partial L_{ij}} {\partial w_k}=\sum_{(i,j)\in I}[\frac{\partial L_{ij}} {\partial s_i} \frac{\partial s_i}{\partial w_k} + \frac{\partial L_{ij}} {\partial s_j} \frac{\partial s_j}{\partial w_k}]</script><p>å…¶ä¸­ï¼š</p>
<script type="math/tex; mode=display">
\frac{\partial L_{ij}} {\partial s_i} = \\ \frac{\partial \{ \frac{(1-S_{ij}) \sigma (s_i-s_j)}{2}+log(1+e^{-\sigma(s_i-s_j)})\}}{\partial s_i} = \\ \sigma[\frac{(1-S_{ij})}{2}-\frac 1 {1+e^{\sigma(s_i-s_j)}}] =\\ -\frac{\partial L_{ij}} {\partial s_j}</script><p>$s_i$å’Œ$s_j$å¯¹$w_k$çš„åå¯¼æ•°å¯ä»¥æ ¹æ®å®é™…ä½¿ç”¨çš„æ¨¡å‹æ±‚çš„ã€‚</p>
<p>ç»“æœæ’åºæœ€ç»ˆç”±æ¨¡å‹å¾—åˆ†$s_i$ç¡®å®šï¼Œå…¶æ¢¯åº¦å¾ˆå…³é”®ï¼Œå®šä¹‰ï¼š</p>
<script type="math/tex; mode=display">
\lambda_{ij} \overset{def}{=} \frac{\partial L_{ij}} {\partial s_i} = -\frac{\partial L_{ij}} {\partial s_j} =\\ \sigma[\frac{(1-S_{ij})}{2}-\frac 1 {1+e^{\sigma(s_i-s_j)}}]</script><p>å¯¹äºæœ‰åºå¯¹$(i,j)$,æœ‰$S_{ij}= 1$ï¼Œäºæ˜¯åŒ–ç®€ï¼š</p>
<script type="math/tex; mode=display">
\lambda_{ij} \overset{def}=-\frac 1 {1+e^{\sigma(s_i-s_j)}}</script><p>æ­¤æ—¶$\lambda_{ij}$å§‹ç»ˆä¸ºè´Ÿæ•°ï¼Œä½¿ç”¨æ¢¯åº¦æ›´æ–°æ—¶ï¼Œå°†ä¼šä½¿$s_i$å¢å¤§ï¼Œå› æ­¤ï¼Œå¯¹äºæ–‡æ¡£$U_i$æ¥è¯´ï¼ŒçœŸå®çš„ç›¸å…³æ€§åœ¨å…¶åçš„æ–‡æ¡£å°†ä¿ƒè¿›å…¶åˆ†æ•°å¢åŠ ã€‚å³ç»™å…¶ä¸€ä¸ªå‘ä¸Šæ¨çš„åŠ›ã€‚</p>
<p>ç”±äºï¼š</p>
<script type="math/tex; mode=display">
\frac{\partial L_{ij}} {\partial s_i}  = -\frac{\partial L_{ij}} {\partial s_j}</script><p>å¯¹äº$s_j$æ¥è¯´ï¼Œå…¶å¯¼æ•°å‡ä¸ºæ­£æ•°ï¼Œåˆ™åœ¨æ›´æ–°æ¨¡å‹æ—¶ä½¿$s_j$å˜å°ï¼Œå› æ­¤å¯¹åº”ä»»æ„æ–‡æ¡£æ¥è¯´ï¼ŒçœŸå®çš„ç›¸å…³æ€§åœ¨å…¶å‰çš„æ–‡æ¡£éƒ½å°†ä¿ƒä½¿å…¶åˆ†æ•°å‡å°ï¼Œå³ç»™å…¶ä¸€ä¸ªå‘ä¸‹æ¨çš„åŠ›ã€‚</p>
<p>è¿™ä¸ª$lambda_{ij}$å³ä¸ºæ¥ä¸‹æ¥ä»‹ç»çš„LambdaRank å’Œ LambdaMART ä¸­çš„ Lambdaï¼Œç§°ä¸º Lambda æ¢¯åº¦ã€‚</p>
<h2 id="LambdaRank"><a href="#LambdaRank" class="headerlink" title="LambdaRank"></a>LambdaRank</h2><p>RankNet æœ¬è´¨ä¸Šå°±æ˜¯ä»¥é”™è¯¯çš„ pair æœ€å°‘ä¸ºä¼˜åŒ–ç›®æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´ RankNet çš„ç›´æ¥ç›®çš„å°±æ˜¯ä¼˜åŒ–é€†åºå¯¹æ•°ï¼ˆpairwise errorï¼‰ï¼Œè¿™ç§æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿè§£å†³ä¸€äº›æ’åºé—®é¢˜ï¼Œä½†å®ƒå¹¶ä¸å®Œç¾ã€‚</p>
<p>é€†åºå¯¹æ•°ï¼ˆpairwise errorï¼‰è¡¨ç¤ºä¸€ä¸ªæ’åˆ—ä¸­ï¼ŒæŠ½æŸ¥ä»»æ„ä¸¤ä¸ª itemï¼Œä¸€å…±æœ‰ $C_2^n$ ç§å¯èƒ½çš„ç»„åˆï¼Œå¦‚æœè¿™ä¸¤ä¸ª item çš„ä¹‹é—´çš„ç›¸å¯¹æ’åºé”™è¯¯ï¼Œé€†åºå¯¹æ•°é‡å¢åŠ  1ã€‚</p>
<p><strong>é€†åºå¯¹æ•°çš„å®è´¨å°±æ˜¯æ’å…¥æ’åºè¿‡ç¨‹ä¸­è¦ç§»åŠ¨å…ƒç´ çš„æ¬¡æ•°ã€‚ç›´è§‚ç†è§£ä¸ºè¦æƒ³æŠŠæŸä¸ªå…ƒç´ ç§»åŠ¨åˆ°æœ€ä¼˜æ’åºä½ç½®ï¼Œéœ€è¦ç§»åŠ¨å¤šå°‘æ¬¡ï¼Œä¸¤ä¸ªå…ƒç´ å°±æ˜¯äºŒè€…ç§»åŠ¨æ¬¡æ•°çš„å’Œã€‚</strong></p>
<p>ä¾‹å¦‚ï¼Œå¯¹æŸä¸ª Queryï¼Œå’Œå®ƒç›¸å…³çš„æ–‡ç« æœ‰ä¸¤ä¸ªï¼Œè®°ä¸º (ğ‘„,[ğ·1,ğ·2]) ã€‚</p>
<ol>
<li>å¦‚æœæ¨¡å‹ ğ‘“(â‹…) å¯¹æ­¤ Query è¿”å›çš„ n æ¡ç»“æœä¸­ï¼Œ ğ·1,ğ·2 åˆ†åˆ«ä½äºå‰ä¸¤ä½ï¼Œé‚£ä¹ˆ pairwise error å°±ä¸º 0ï¼›</li>
<li>å¦‚æœæ¨¡å‹ ğ‘“(â‹…) å¯¹æ­¤ Query è¿”å›çš„ n æ¡ç»“æœä¸­ï¼Œ ğ·1,ğ·2 åˆ†åˆ«ä½äºç¬¬ 1 ä½å’Œç¬¬ n ä½ï¼Œé‚£ä¹ˆ pairwise error ä¸º n-2ï¼›</li>
<li>å¦‚æœæ¨¡å‹ ğ‘“(â‹…) å¯¹æ­¤ Query è¿”å›çš„ n æ¡ç»“æœä¸­ï¼Œ ğ·1,ğ·2 åˆ†åˆ«ä½äºç¬¬ 2 å’Œç¬¬ 3 ä½ï¼Œé‚£ä¹ˆ pair-wise error ä¸º 2ï¼›</li>
</ol>
<p>å‡è®¾RankNetç»è¿‡ä¸¤è½®è¿­ä»£å®ç°ä¸‹å›¾æ‰€ç¤ºçš„é¡ºåºä¼˜åŒ–ï¼š</p>
<p><a href="https://imgtu.com/i/5WNCo8" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/10/24/5WNCo8.png" alt="5WNCo8.png"></a></p>
<p>ç¬¬ä¸€è½®çš„æ—¶å€™é€†åºå¯¹æ•°ä¸º 13ï¼Œç¬¬äºŒè½®ä¸º 3 + 8 = 11ï¼Œé€†åºå¯¹æ•°ä» 13 ä¼˜åŒ–åˆ° 11ï¼ŒæŸå¤±ç¡®å®æ˜¯å‡å°äº†ï¼Œå¦‚æœç”¨ AUC ä½œä¸ºè¯„ä»·æŒ‡æ ‡ï¼Œä¹Ÿå¯ä»¥è·å¾—æŒ‡æ ‡çš„æå‡ã€‚ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œä¼˜åŒ–é€†åºå¯¹æ•°å¹¶æ²¡æœ‰è€ƒè™‘ä½ç½®çš„æƒé‡ï¼Œè¿™ä¸æˆ‘ä»¬å®é™…å¸Œæœ›çš„æ’åºç›®æ ‡ä¸ä¸€è‡´ã€‚ä¸‹ä¸€è½®è¿­ä»£ï¼ŒRankNet ä¸ºäº†è·å¾—æ›´å¤§çš„é€†åºå¯¹æ•°çš„å‡å°ï¼Œä¼šæŒ‰ç…§é»‘è‰²ç®­å¤´é‚£æ ·çš„è¶‹åŠ¿ï¼Œæ’åé å‰çš„æ–‡æ¡£ä¼˜åŒ–åŠ›åº¦ä¼šå‡å¼±ï¼Œæ›´å¤šçš„é‡å¿ƒæ˜¯æŠŠåä¸€ä¸ªæ–‡æ¡£å¾€å‰æ’ï¼Œè¿™ä¸æˆ‘ä»¬æœç´¢æ’åºç›®æ ‡æ˜¯ä¸ä¸€è‡´çš„ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›å‡ºç°çº¢è‰²ç®­å¤´çš„è¶‹åŠ¿ï¼Œä¼˜åŒ–çš„é‡ç‚¹æ”¾åœ¨æ’åé å‰çš„æ–‡æ¡£ï¼Œå°½å¯èƒ½åœ°å…ˆè®©å®ƒæ’åœ¨æœ€ä¼˜ä½ç½®ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿè€ƒè™‘ä½ç½®æƒé‡çš„ä¼˜åŒ–æŒ‡æ ‡ã€‚</p>
<p><strong>RankNet ä»¥ä¼˜åŒ–é€†åºå¯¹æ•°ä¸ºç›®æ ‡ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘ä½ç½®çš„æƒé‡ï¼Œè¿™ç§ä¼˜åŒ–æ–¹å¼å¯¹ AUC è¿™ç±»è¯„ä»·æŒ‡æ ‡æ¯”è¾ƒå‹å¥½ï¼Œä½†å®é™…çš„æ’åºç»“æœä¸ç°å®çš„æ’åºéœ€æ±‚ä¸ä¸€è‡´ï¼Œç°å®ä¸­çš„æ’åºéœ€æ±‚æ›´åŠ æ³¨é‡å¤´éƒ¨çš„ç›¸å…³åº¦ï¼Œæ’åºè¯„ä»·æŒ‡æ ‡é€‰ç”¨ NDCG è¿™ä¸€ç±»çš„æŒ‡æ ‡æ‰æ›´åŠ ç¬¦åˆå®é™…éœ€æ±‚ã€‚è€Œ RankNet è¿™ç§ä»¥ä¼˜åŒ–é€†åºå¯¹æ•°ä¸ºç›®çš„çš„äº¤å‰ç†µæŸå¤±ï¼Œå¹¶ä¸èƒ½ç›´æ¥æˆ–è€…é—´æ¥ä¼˜åŒ– NDCG è¿™æ ·çš„æŒ‡æ ‡ã€‚</strong></p>
<p><strong>å¯¹äºç»å¤§å¤šæ•°çš„ä¼˜åŒ–è¿‡ç¨‹æ¥è¯´ï¼Œç›®æ ‡å‡½æ•°å¾ˆå¤šæ—¶å€™ä»…ä»…æ˜¯ä¸ºäº†æ¨å¯¼æ¢¯åº¦è€Œå­˜åœ¨çš„ã€‚è€Œå¦‚æœæˆ‘ä»¬ç›´æ¥å°±å¾—åˆ°äº†æ¢¯åº¦ï¼Œé‚£è‡ªç„¶å°±ä¸éœ€è¦ç›®æ ‡å‡½æ•°äº†ã€‚</strong></p>
<p>å¾®è½¯å­¦è€…ç»è¿‡åˆ†æï¼Œå°±ç›´æ¥æŠŠ RankNet æœ€åå¾—åˆ°çš„ Lambda æ¢¯åº¦æ‹¿æ¥ä½œä¸º LambdaRank çš„æ¢¯åº¦æ¥ç”¨äº†ï¼Œè¿™ä¹Ÿæ˜¯ LambdaRank ä¸­ Lambda çš„å«ä¹‰ã€‚è¿™æ ·æˆ‘ä»¬ä¾¿çŸ¥é“äº† LambdaRank å…¶å®æ˜¯ä¸€ä¸ªç»éªŒç®—æ³•ï¼Œå®ƒä¸æ˜¯é€šè¿‡æ˜¾ç¤ºå®šä¹‰æŸå¤±å‡½æ•°å†æ±‚æ¢¯åº¦çš„æ–¹å¼å¯¹æ’åºé—®é¢˜è¿›è¡Œæ±‚è§£ï¼Œè€Œæ˜¯åˆ†ææ’åºé—®é¢˜éœ€è¦çš„æ¢¯åº¦çš„ç‰©ç†æ„ä¹‰ï¼Œç›´æ¥å®šä¹‰æ¢¯åº¦ï¼Œå³ Lambda æ¢¯åº¦ã€‚æœ‰äº†æ¢¯åº¦ï¼Œå°±ä¸ç”¨å…³å¿ƒæŸå¤±å‡½æ•°æ˜¯å¦è¿ç»­ã€æ˜¯å¦å¯å¾®äº†ï¼Œæ‰€ä»¥ï¼Œå¾®è½¯å­¦è€…ç›´æ¥æŠŠ NDCG è¿™ä¸ªæ›´å®Œå–„çš„è¯„ä»·æŒ‡æ ‡ä¸ Lambda æ¢¯åº¦ç»“åˆäº†èµ·æ¥ï¼Œå°±å½¢æˆäº† LambdaRankã€‚</p>
<p>é¦–å…ˆæ¥åˆ†æä¸€ä¸‹lambdaæ¢¯åº¦çš„æ„ä¹‰ï¼šLambdaRank ä¸­çš„ Lambd å…¶å®å°±æ˜¯ RankNet ä¸­çš„æ¢¯åº¦ $\lambda_{ij}$ï¼Œ $\lambda_{ij}$å¯ä»¥çœ‹æˆæ˜¯ ğ‘ˆğ‘– å’Œ ğ‘ˆğ‘— ä¸­é—´çš„ä½œç”¨åŠ›ï¼Œä»£è¡¨ä¸‹ä¸€æ¬¡è¿­ä»£ä¼˜åŒ–çš„æ–¹å‘å’Œå¼ºåº¦ã€‚å¦‚æœ ğ‘ˆğ‘–âŠ³ğ‘ˆğ‘—ï¼Œåˆ™ ğ‘ˆğ‘— ä¼šç»™äºˆ ğ‘ˆğ‘– å‘ä¸Šçš„å¤§å°ä¸º  $\lambda_{ij}$ çš„æ¨åŠ¨åŠ›ï¼Œè€Œå¯¹åº”åœ° ğ‘ˆğ‘– ä¼šç»™äºˆ ğ‘ˆğ‘— å‘ä¸‹çš„å¤§å°ä¸º  $\lambda_{ij}$ çš„æ¨åŠ¨åŠ›ã€‚å¯¹åº”ä¸Šé¢çš„é‚£å¼ å›¾ï¼ŒLambda çš„ç‰©ç†æ„ä¹‰å¯ä»¥ç†è§£ä¸ºå›¾ä¸­ç®­å¤´ï¼Œå³ä¼˜åŒ–è¶‹åŠ¿ã€‚</p>
<p>å› æ­¤ï¼Œç›´æ¥ä½¿ç”¨$\vert \triangle_{NDCG} \vert $ä¹˜ä»¥$\lambda_{ij}$ï¼Œå°±å¯ä»¥å¾—åˆ°LambdaRankçš„Lambdaï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
\lambda_{i,j} \overset{def}=\frac{\partial L{(s_i-s_j)}}{\partial s_i} =-\frac 1 {1+e^{\sigma(s_i-s_j)}} \vert \triangle_{NDCG} \vert</script><p>å…¶ä¸­$\vert \triangle_{NDCG} \vert $ä¸º$U_i$å’Œ$U_j$äº¤æ¢æ’åºä½ç½®å¾—åˆ°çš„NDCGå·®å€¼çš„<strong>ç»å¯¹å€¼</strong>ã€‚é€šè¿‡å‰æ–‡çš„æè¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒNDCGæŒ‡æ ‡è€ƒè™‘äº†æ’åºä½ç½®çš„å½±å“ï¼Œ$\vert \triangle_{NDCG} \vert $å€¼ä¸ºåœ¨å…¨éƒ¨å¬å›é˜Ÿåˆ—ä¸­ä»…è€ƒè™‘iå’Œjä¸¤ä¸ªæ–‡æ¡£æ—¶ï¼Œäº’æ¢ä½ç½®å¯¹æœ€ç»ˆDNCGåˆ†æ•°çš„å½±å“ã€‚</p>
<p>å¯¹äº$U_i \rhd U_j$æ¥è¯´ï¼Œå¦‚æœè¿”å›çš„åˆ†æ•°æ’åºå$U_i$å¯¹åº”$index_1$,$U_j$å¯¹åº”$index_j$ã€‚åˆ™ï¼š</p>
<script type="math/tex; mode=display">
 \triangle_{NDCG}   = \frac 1 {IDCG} [ (\sum_{k \in I, k \notin {i,j} } \frac{rel_k}{log_2(index_k+1)})+ \frac{rel_i}{log_2{(index_j+1)}}+\frac{rel_j}{log_2{(index_i+1)}} - \\ (\sum_{k \in I, k \notin {i,j} } \frac{rel_k}{log_2(index_k+1)})+ \frac{rel_i}{log_2{(index_j+1)}} - \frac{rel_i}{log_2{(index_i+1)}}-\frac{rel_j}{log_2{(index_j+1)}}]=\\
\frac 1 {IDCG} (rel_i-rel_j)(\frac 1 {log(index_j+1)}-\frac 1 {log(index_i+1)})</script><p>ä»ä¸Šè¯•æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œå¤§ä¸¤ä¸ªæ–‡æ¡£çš„çœŸå®åˆ†æ•°å·®è¶Šå¤§æ—¶ï¼Œç»“æœçš„$\vert \triangle_{NDCG} \vert $å€¼è¶Šå¤§ï¼Œè¿™æ ·å°±èµ·åˆ°äº†å¯¹äºæ’åé«˜å¹¶ä¸”ç›¸å…³æ€§é«˜çš„æ–‡æ¡£æ›´å¿«åœ°å‘ä¸Šæ¨åŠ¨ï¼Œè€Œæ’åä½è€Œä¸”ç›¸å…³æ€§è¾ƒä½çš„æ–‡æ¡£è¾ƒæ…¢åœ°å‘ä¸Šæ¨åŠ¨ã€‚</p>
<p>å¯¹äºç‰¹å®š$U_i$ï¼Œç´¯åŠ å…¶ä»–æ‰€æœ‰æ’åºé¡¹çš„å½±å“ï¼Œå¾—åˆ°ï¼š</p>
<script type="math/tex; mode=display">
\lambda_i = \sum_{(i,j)\in I,i \rhd j}\lambda_{ij} + \sum_{(k,i)\in I,k \rhd i}\lambda_{ki}=\sum_{(i,j)\in I,i \rhd j}\lambda_{ij} - \sum_{(k,i)\in I,k \rhd i}\lambda_{ik}</script><p>å³ï¼Œå¯¹äºæ¯ä¸ªæ–‡æ¡£ï¼Œåˆ†åˆ«è®¡ç®—ä¸æ’åœ¨å…¶åçš„æ‰€æœ‰æ–‡æ¡£çš„$\lambda_{ij}$å’Œä¸æ’åœ¨å…¶å‰çš„æ‰€æœ‰æ–‡æ¡£çš„$\lambda_{ki}$,å¯¹è¿™äº›å€¼è¿›è¡Œæ±‚å’Œã€‚</p>
<p>ä»ä¹‹å‰çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œæ’åœ¨å…¶åçš„æ–‡æ¡£ç»™äºˆå½“å‰æ–‡æ¡£ä¸€ä¸ªå‘ä¸Šæ¨åŠ¨çš„åŠ›ï¼Œæ’åœ¨å…¶åçš„æ–‡æ¡£ç»™äºˆå…¶å‘ä¸‹æ¨åŠ¨çš„åŠ›ã€‚å› æ­¤ä¸ºäº†ä¿è¯ç›¸å…³æ€§æ›´é«˜çš„æ–‡æ¡£æ’åºæ›´é«˜(å¯¹ç›¸å…³æ€§ä½çš„ç±»ä¼¼ï¼Œè®©å…¶æ’åºæ›´é å)ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æ‹Ÿåˆ$\lambda_i$å³å¯ã€‚</p>
<p>å¦‚æœå°†$\lambda_i$çœ‹åšä¸€ä¸ªå¯¼æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¨å‡ºå…¶æ•ˆç”¨å‡½æ•°ä¸ºï¼š</p>
<script type="math/tex; mode=display">
C_{ij} = log(1+e^{-\sigma(si-sj)})\vert \triangle_{NDCG} \vert</script><h2 id="LambdaMARTç®—æ³•-1"><a href="#LambdaMARTç®—æ³•-1" class="headerlink" title="LambdaMARTç®—æ³•"></a>LambdaMARTç®—æ³•</h2><p>LambdaRank é‡æ–°å®šä¹‰äº†æ¢¯åº¦ï¼Œèµ‹äºˆäº†æ¢¯åº¦æ–°çš„ç‰©ç†æ„ä¹‰ï¼Œå› æ­¤ï¼Œæ‰€æœ‰å¯ä»¥ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•æ±‚è§£çš„æ¨¡å‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¢¯åº¦ï¼ŒåŸºäºå†³ç­–æ ‘çš„ MART å°±æ˜¯å…¶ä¸­ä¸€ç§ï¼Œå°†æ¢¯åº¦ Lambda å’Œ MART ç»“åˆå°±æ˜¯å¤§åé¼é¼çš„ LambdaMARTã€‚</p>
<p>MARTå³ä¸ºGBDTï¼ŒLambdaMART åªæ˜¯åœ¨ GBDT çš„è¿‡ç¨‹ä¸­åšäº†ä¸€ä¸ªå¾ˆå°çš„ä¿®æ”¹ã€‚åŸå§‹ GBDT çš„åŸç†æ˜¯ç›´æ¥åœ¨å‡½æ•°ç©ºé—´å¯¹å‡½æ•°è¿›è¡Œæ±‚è§£æ¨¡å‹ï¼Œç»“æœç”±è®¸å¤šæ£µæ ‘ç»„æˆï¼Œæ¯æ£µæ ‘çš„æ‹Ÿåˆç›®æ ‡æ˜¯æŸå¤±å‡½æ•°çš„æ¢¯åº¦ï¼Œè€Œåœ¨ LambdaMART ä¸­è¿™ä¸ªæ¢¯åº¦å°±æ¢æˆäº† Lambda æ¢¯åº¦ï¼Œè¿™æ ·å°±ä½¿å¾— GBDT å¹¶ä¸æ˜¯ç›´æ¥ä¼˜åŒ–äºŒåˆ†åˆ†ç±»é—®é¢˜ï¼Œè€Œæ˜¯ä¸€ä¸ªæ”¹è£…äº†çš„äºŒåˆ†åˆ†ç±»é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¼˜åŒ–çš„æ—¶å€™ä¼˜å…ˆè€ƒè™‘èƒ½å¤Ÿè¿›ä¸€æ­¥æ”¹è¿› NDCG çš„æ–¹å‘ã€‚</p>
<p>LambdaMARTæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><a href="https://imgtu.com/i/5fujCq" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/10/24/5fujCq.png" alt="5fujCq.png"></a></p>
<p>å…¶æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>éšå«æ­¥éª¤ï¼šä½¿ç”¨å½“å‰æ¨¡å‹$F(x)$çš„è¾“å‡º$s$è®¡ç®—æ•ˆç”¨å‡½æ•°$C$ã€‚è¿™é‡Œå®é™…å¹¶ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ç›´æ¥æ‰¾åˆ°äº†å…¶æ¢¯åº¦ï¼Œä¸éœ€è¦é€šè¿‡æ•ˆç”¨å‡½æ•°æ¥è®¡ç®—æ¢¯åº¦ã€‚è¿™é‡Œæ˜¯æé†’è¯»è€…ï¼Œæ¯è½®å¾ªç¯ä¼˜åŒ–çš„ç›®æ ‡ï¼Œä¾ç„¶æ˜¯æœ€å°åŒ–æ•ˆç”¨å‡½æ•°ã€‚</p>
</li>
<li><p>æ¯æ£µæ ‘çš„è®­ç»ƒéƒ½ä¼šå…ˆéå†æ‰€æœ‰çš„æ•°æ®ï¼Œè®¡ç®—æ¯ä¸ªpairï¼ˆåŒä¸€ä¸ªqueryä¸‹çš„ï¼‰äº’æ¢ä½ç½®å¯¼è‡´çš„æŒ‡æ ‡å˜åŒ–$\vert \triangle_{NDCG} \vert $ä»¥åŠlambdaå€¼ï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
\lambda_{i,j} =-\frac 1 {1+e^{\sigma(s_i-s_j)}} \vert \triangle_{NDCG} \vert</script><p>ä¹‹åè®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„Lambdaï¼š</p>
<script type="math/tex; mode=display">
\lambda_i =\sum_{(i,j)\in I,i \rhd j}\lambda_{ij} - \sum_{(k,i)\in I,k \rhd i}\lambda_{ik}</script><p>é€šè¿‡lambdaæ¢¯åº¦æˆ‘ä»¬æ¨å‡ºæ•ˆç”¨å‡½æ•°ä¸ºï¼š</p>
<script type="math/tex; mode=display">
C(s_i-sj) = \sum_{i,j\in I}{log(1+e^{-\sigma(si-sj)})\vert \triangle_{NDCG} \vert}</script><p>ç”±æ­¤å¯å¾—ï¼š</p>
<script type="math/tex; mode=display">
\frac{\partial C} {\partial s_i} = \sum_{i,j \in I} \frac{-\sigma\vert \triangle_{NDCG} \vert }{1+e^{\sigma (s_i -s_j)}}</script><p>å®šä¹‰ï¼š</p>
<script type="math/tex; mode=display">
\rho_{ij} = \frac 1 {1+e^{\sigma (s_i -s_j)}}=\frac{-\lambda_{ij}}{\sigma\vert \triangle_{NDCG} \vert }</script><p>åˆ™ï¼š</p>
<script type="math/tex; mode=display">
y_i = \lambda_i =\frac{\partial C} {\partial s_i} = \sum_{i,j \in I} {-\sigma}\vert \triangle_{NDCG} \vert \rho_{ij}</script><p>è®¡ç®—æ¯ä¸ª$ y_i$å¯¹$\lambda_i$çš„å€’æ•°ï¼Œç”¨äºåç»­ä½¿ç”¨ç‰›é¡¿æ³•æ±‚è§£å¶å­èŠ‚ç‚¹çš„æ•°å€¼ï¼š</p>
<script type="math/tex; mode=display">
w_i =\frac{\partial y_i} {\partial s_i} = \frac{\partial^2 C} {\partial s_i^2} = \sum_{i,j\in I}\sigma^2 \vert \triangle_{NDCG} \vert \rho_{ij}(1-\rho_{ij}) = \sum_{i,j \in I} \sigma^2 (-\lambda_{ij}) (1+\frac{\lambda_{ij}}{\sigma \vert \triangle_{NDCG} \vert})</script></li>
<li><p>ä½¿ç”¨$(X, \lambda)$,æ‹Ÿåˆä¸€ä¸ªå†³ç­–å›å½’æ ‘ï¼Œä½œä¸ºæœ¬è½®å¾ªç¯ç”Ÿæˆçš„å¼±åˆ†ç±»å™¨ã€‚<font color="red">æ³¨æ„ï¼Œè¿™é‡Œçš„$\lambda$æ˜¯ä¸Šä¸€æ­¥çš„$-y_i$ï¼Œå³è´Ÿæ¢¯åº¦</font>ã€‚</p>
</li>
<li><p>å¯¹ç¬¬äºŒæ­¥ç”Ÿæˆçš„å›å½’æ ‘ï¼Œè®¡ç®—æ¯ä¸ªå¶å­èŠ‚ç‚¹çš„æ•°å€¼ï¼Œé‡‡ç”¨ç‰›é¡¿è¿­ä»£æ³•æ±‚è§£ã€‚</p>
<p>ç‰›é¡¿æ³•æ˜¯å¯¹äºä¸€ä¸ªå‡½æ•°ï¼Œä½¿ç”¨æ³°å‹’å±•å¼€ï¼Œå¿½ç•¥é«˜é˜¶é¡¹çš„ä¸€ä¸ªè¿­ä»£ä¼˜åŒ–æ–¹å¼ã€‚ä¾‹å¦‚å¯¹äºä»»æ„$f(X)$,åœ¨ä»»æ„ç‚¹$x_n$è¿›è¡Œæ³°å‹’å±•ç¤ºä¸ºï¼š</p>
<script type="math/tex; mode=display">
f(x) = f(x_n) + \frac{f^{(1)}(x_n)}{1}(x-x_n) + \frac{f^{(2)}(x_n)}{2}(x-x_n)^2 + \sum_{k=3}^{\infty}\frac{f^{(k)}(x_n)}{k}(x-x_n)^k \approx \\ f(x_n) + \frac{f^{(1)}(x_n)}{1}(x-x_n) + \frac{f^{(2)}(x_n)}{2}(x-x_n)^2</script><p>ç‰›é¡¿æ³•å¿½ç•¥é«˜é˜¶é¡¹ï¼Œä¹‹åå¦‚æœè¦ä½¿å¾—å‡½æ•°$f(x)$æœ€å°ï¼Œåˆ™æ‰¾åˆ°$f(x)$æ¢¯åº¦ä¸º0ï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
f^{(1)}(x_n) + f^{(2)}(x_n)(x-x_n) = 0 => \\
x = x_n - \frac{f^{(1)}(x_n)}{f^{(2)}(x_n)}</script><p>GBDTå¯¹çš„æ¯ä¸ªå¶èŠ‚ç‚¹çš„è®¡ç®—ä¸ºï¼š </p>
<script type="math/tex; mode=display">
c_{lk} = arg \ \underset{c}{min} \sum_{x_i \in R_{lk}}L(y_i, f_{t-1}(x_i)+c)</script></li>
</ol>
<p>   å¯¹åº”åˆ°lambdaMARTç®—æ³•ï¼Œå½“å‰çš„$x_i$å¯¹åº”ä¸ºè¾“å…¥$x_i$ã€‚å‡½æ•°$f_{t-1}(x)$å¯¹åº”äºå½“å‰è¾“å‡ºçš„$s_i$åˆ†æ•°ã€‚$L$å¯¹åº”äºæ•ˆç”¨å‡½æ•°$C$ã€‚è¿™é‡Œ$s_i$çš„å®é™…æ˜¯å½“å‰å·²ç»è®­ç»ƒçš„å¼±æ¨¡å‹çš„åŠ å’Œå³:$s_i=F_{k-1}(x_i)$ï¼Œå…¶ä¸­$k$-1ä¸ºå½“å‰è®­ç»ƒçš„å›å½’æ ‘æ•°é‡ã€‚</p>
<p>   åˆ©ç”¨ç‰›é¡¿æ³•ï¼Œè·å–æœ€å°åŒ–æ•ˆç”¨å‡½æ•°æ—¶è¾“å…¥ä¸ºï¼š</p>
<script type="math/tex; mode=display">
   f_{t-1}(x_i)+c = -\frac{\lambda_i}{w_i}</script><p>   æ­¤æ—¶$s_i-s_j = f_{t-1}(x_i)$ï¼Œå› æ­¤ï¼š</p>
<script type="math/tex; mode=display">
   c_{lk} = -\frac{\lambda_i}{w_i}</script><p>   å¯¹åº”ä¸Šå›¾$\gamma_{lk}$çš„è®¡ç®—ï¼š</p>
<script type="math/tex; mode=display">
   \gamma_{lk} = \frac{\sum_{x_i in R_{lK}} y_i}{\sum_{x_i \in R_{lk}}w_i} = \frac{\sum_{x_i in R_{lK}} \frac{\partial C} {\partial s_i}}{\sum_{x_i \in R_{lk}}\frac{\partial^{(2)} C} {\partial s_i^2}} = \frac{\sum_{x_i in R_{lK}} \lambda_i}{\sum_{x_i \in R_{lk}}w_i}</script><p>   è¿™é‡Œç¼ºå¤±ä¸€ä¸ªè´Ÿå·ï¼Œæˆ‘ç†è§£æ˜¯ä¸Šå›¾æœ‰é”™è¯¯ï¼Œåœ¨ä½¿ç”¨å›å½’æ ‘æ‹Ÿåˆçš„æ—¶å€™ï¼Œæ‹Ÿåˆçš„æ˜¯è´Ÿæ¢¯åº¦ï¼Œå³$y_i = -\lambda_i$ï¼Œå¯¹äºäºŒé˜¶å¯¼ï¼Œåº”è¯¥ä½¿ç”¨åŸ$\lambda$çš„äºŒé˜¶å¯¼ï¼Œè¿™æ ·ç›¸é™¤å°±å­˜åœ¨ä¸€ä¸ªè´Ÿå·ï¼Œè¿™æ ·æ±‚å‡ºçš„$\gamma_{lk}$æ‰æ˜¯ä¸Šå›¾ä¸­çš„å½¢å¼ã€‚</p>
<ol>
<li><p>æ¨¡å‹æ›´æ–°</p>
<p>ä½¿ç”¨ç‰›é¡¿æ³•æ›´æ–°æ¨¡å‹ï¼Œå°†ç¬¬ké¢—æ ‘å¢åŠ åˆ°æ¨¡å‹ä¸­ã€‚æ¨¡å‹æ›´æ–°å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
F_k(x_i) = F_{k-1} + \eta \sum_l \gamma_{lk}I(x_i \in R_{lk})</script><p>å…¶ä¸­$\eta$ä¸ºå­¦ä¹ ç‡ã€‚</p>
</li>
</ol>
<h1 id="ç¨‹åºæ‰§è¡Œé€»è¾‘"><a href="#ç¨‹åºæ‰§è¡Œé€»è¾‘" class="headerlink" title="ç¨‹åºæ‰§è¡Œé€»è¾‘"></a>ç¨‹åºæ‰§è¡Œé€»è¾‘</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(train_data, valid_data, model_save_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(train_data) <span class="keyword">as</span> trainfile, \</span><br><span class="line">            open(valid_data) <span class="keyword">as</span> valifile:</span><br><span class="line">        TX, Ty, sample_weight, Tqids, _ = pyltr.data.letor.read_dataset(trainfile, one_indexed=<span class="literal">True</span>, has_weight=<span class="literal">True</span>)</span><br><span class="line">        VX, Vy, _, Vqids, _ = pyltr.data.letor.read_dataset(valifile, one_indexed=<span class="literal">True</span>, has_weight=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># old_k is 4 </span></span><br><span class="line">    metric_train = pyltr.metrics.NDCG(k=<span class="number">20</span>)</span><br><span class="line">    metric_valid = pyltr_note.metrics.NDCG(k=<span class="number">4</span>)</span><br><span class="line">    monitor = pyltr.models.monitors.ValidationMonitor(</span><br><span class="line">            VX, Vy, Vqids, metric=metric_valid, stop_after=<span class="number">250</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"load data finished ....."</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'begin to train ......'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#pjz</span></span><br><span class="line">    model = pyltr.models.LambdaMART(</span><br><span class="line">        metric=metric_train,</span><br><span class="line">        n_estimators=<span class="number">1000</span>,</span><br><span class="line">        learning_rate=<span class="number">0.01</span>,</span><br><span class="line">        max_features=<span class="number">0.5</span>,</span><br><span class="line">        query_subsample=<span class="number">0.75</span>,</span><br><span class="line">        max_leaf_nodes=<span class="number">20</span>,</span><br><span class="line">        min_samples_leaf=<span class="number">64</span>,</span><br><span class="line">        verbose=<span class="number">1</span>,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    model.fit(TX, Ty, sample_weight, Tqids, monitor=monitor)</span><br><span class="line">    save_model(model, model_save_path)</span><br><span class="line"></span><br><span class="line">    gen_info(model.estimators_)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'output tree info at trees.info'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> sum(model.feature_importances_)</span><br><span class="line">    <span class="keyword">print</span> model.feature_importances_</span><br><span class="line">    <span class="keyword">print</span> np.argsort(model.feature_importances_)</span><br><span class="line">    </span><br><span class="line">    id2featrue = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">'../dicts/featrue2id'</span>):</span><br><span class="line">        line = line.strip()</span><br><span class="line">        featrue,id = line.split()</span><br><span class="line">        id = int(id)</span><br><span class="line">        id2featrue[id] = featrue</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> np.argsort(model.feature_importances_):</span><br><span class="line">        <span class="keyword">print</span> id2featrue[i],model.feature_importances_[i]</span><br></pre></td></tr></table></figure>
<h2 id="è¯»å–æ•°æ®"><a href="#è¯»å–æ•°æ®" class="headerlink" title="è¯»å–æ•°æ®"></a>è¯»å–æ•°æ®</h2><p><code>pyltr.data.letor.read_dataset</code>é€»è¾‘ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">source: string or iterable å¯è¿­ä»£è¯»å–çš„æ•°æ®ã€‚å¯ä»¥æ˜¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">has_targets: bool æ˜¯å¦å­˜åœ¨yï¼ˆå³æ ‡ç­¾ï¼‰,å¦‚æœæœ‰çš„åŒ–ï¼Œåˆ™å¿…é¡»æ”¾åˆ°æ¯ä¸€è¡Œçš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line"><span class="comment">one_indexed: bool å‚æ•°xæ˜¯å¦æ˜¯æŒ‰ç…§ç´¢å¼•å¼€å§‹çš„ï¼ˆä¹Ÿå°±æ˜¯æ˜¯ä»1å¼€å§‹è¿˜æ˜¯ä»0å¼€å§‹ï¼‰</span></span><br><span class="line"><span class="comment">missing: float æŸä¸ªçº¬åº¦çš„æ•°æ®ç¼ºå¤±æ—¶çš„é»˜è®¤å€¼</span></span><br><span class="line"><span class="comment">has_weight: bool æ˜¯å¦æ¯ä¸ªæ•°æ®æœ‰ä¸åŒçš„æƒé‡ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæƒé‡å¿…é¡»åœ¨æ¯è¡Œçš„ç¬¬äºŒä¸ªå€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">def read_dataset(source, has_targets=True, one_indexed=True, missing=0.0, has_weight=False):</span><br><span class="line">    <span class="string">""</span><span class="string">"Parses a LETOR dataset from `source`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    source : string or iterable of lines</span></span><br><span class="line"><span class="string">        String, file, or other file-like object to parse.</span></span><br><span class="line"><span class="string">    has_targets : bool, optional</span></span><br><span class="line"><span class="string">        See `iter_lines`.</span></span><br><span class="line"><span class="string">    one_indexed : bool, optional</span></span><br><span class="line"><span class="string">        See `iter_lines`.</span></span><br><span class="line"><span class="string">    missing : float, optional</span></span><br><span class="line"><span class="string">        See `iter_lines`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    X : array of arrays of floats</span></span><br><span class="line"><span class="string">        Feature matrix (see `iter_lines`).</span></span><br><span class="line"><span class="string">    y : array of floats</span></span><br><span class="line"><span class="string">        Target vector (see `iter_lines`).</span></span><br><span class="line"><span class="string">    qids : array of objects</span></span><br><span class="line"><span class="string">        Query id vector (see `iter_lines`).</span></span><br><span class="line"><span class="string">    comments : array of strs</span></span><br><span class="line"><span class="string">        Comment vector (see `iter_lines`).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    if isinstance(source, sklearn.externals.six.string_types):</span><br><span class="line">        source = source.splitlines()</span><br><span class="line"></span><br><span class="line">    max_width = <span class="number">0</span></span><br><span class="line">    xs, ys, weights, qids, comments = [], [], [], [], []</span><br><span class="line">    <span class="comment">// å¤„ç†æ•°æ®</span></span><br><span class="line">    it = iter_lines(source, has_targets=has_targets,</span><br><span class="line">                    one_indexed=one_indexed, missing=missing, has_weight=has_weight)</span><br><span class="line">    # æ·»åŠ æ¯ä¸€è¡Œæ•°æ®åˆ°å„ç§æ•°ç»„ä¸­</span><br><span class="line">    <span class="keyword">for</span> x, y, weight, qid, comment in it:</span><br><span class="line">        xs.append(x)</span><br><span class="line">        ys.append(y)</span><br><span class="line">        weights.append(weight)</span><br><span class="line">        qids.append(qid)</span><br><span class="line">        comments.append(comment)</span><br><span class="line">        # è®°å½•æœ€å¤§çš„xçº¬åº¦</span><br><span class="line">        max_width = max(max_width, len(x))</span><br><span class="line">    # æ ¹æ®æœ€å¤§çš„xçº¬åº¦ï¼Œå¯¹æ•´ä½“çš„xè¿›è¡Œå¡«å……ï¼Œä¿è¯æ‰€æœ‰xçº¬åº¦ä¸€è‡´</span><br><span class="line">    assert max_width &gt; <span class="number">0</span></span><br><span class="line">    X = np.ndarray((len(xs), max_width), dtype=np.float64)</span><br><span class="line">    X.fill(missing)</span><br><span class="line">    <span class="keyword">for</span> i, x in enumerate(xs):</span><br><span class="line">        X[i, :len(x)] = x</span><br><span class="line">    ys = np.<span class="built_in">array</span>(ys) <span class="keyword">if</span> has_targets <span class="keyword">else</span> None</span><br><span class="line">    qids = np.<span class="built_in">array</span>(qids)</span><br><span class="line">    comments = np.<span class="built_in">array</span>(comments)</span><br><span class="line">    weights = np.<span class="built_in">array</span>(weights)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (X, ys, weights, qids, comments)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‚æ•°ä¸ä¸Šè¿°çš„å‡½æ•°ä¸€è‡´</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">iter_lines</span><span class="params">(lines, has_targets=True, one_indexed=True, missing=<span class="number">0.0</span>, has_weight=False)</span>:</span></span><br><span class="line">    <span class="string">"""Transforms an iterator of lines to an iterator of LETOR rows.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Each row is represented by a (x, y, qid, comment) tuple.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    lines : iterable of lines</span></span><br><span class="line"><span class="string">        Lines to parse.</span></span><br><span class="line"><span class="string">    has_targets : bool, optional</span></span><br><span class="line"><span class="string">        Whether the file contains targets. If True, will expect the first token</span></span><br><span class="line"><span class="string">        of every line to be a real representing the sample's target (i.e.</span></span><br><span class="line"><span class="string">        score). If False, will use -1 as a placeholder for all targets.</span></span><br><span class="line"><span class="string">    one_indexed : bool, optional</span></span><br><span class="line"><span class="string">        Whether feature ids are one-indexed. If True, will subtract 1 from each</span></span><br><span class="line"><span class="string">        feature id.</span></span><br><span class="line"><span class="string">    missing : float, optional</span></span><br><span class="line"><span class="string">        Placeholder to use if a feature value is not provided for a sample.</span></span><br><span class="line"><span class="string">    has_weight : bool, optional</span></span><br><span class="line"><span class="string">        Whether has sample weight, If False, all samples' weight will be assigned 1.0, otherwise</span></span><br><span class="line"><span class="string">        use the value read from data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields</span></span><br><span class="line"><span class="string">    ------</span></span><br><span class="line"><span class="string">    x : array of floats</span></span><br><span class="line"><span class="string">        Feature vector of the sample.</span></span><br><span class="line"><span class="string">    y : float</span></span><br><span class="line"><span class="string">        Target value (score) of the sample, or -1 if no target was parsed.</span></span><br><span class="line"><span class="string">    weight : float</span></span><br><span class="line"><span class="string">        sample  weight</span></span><br><span class="line"><span class="string">    qid : object</span></span><br><span class="line"><span class="string">        Query id of the sample. This is currently guaranteed to be a string.</span></span><br><span class="line"><span class="string">    comment : str</span></span><br><span class="line"><span class="string">        Comment accompanying the sample.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># éå†æ¯ä¸€è¡Œ</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="comment"># å»é™¤æœ«å°¾çš„ç©ºæ ¼ï¼Œå¹¶æŒ‰ç…§#åˆ‡å‰²ä¸ºä¸¤éƒ¨åˆ†ï¼Œdataä¸ºè¦è·å–çš„æ•°æ®ï¼Œcommentä¸ºæ³¨é‡Šï¼Œå³æ•°æ®å¯¹åº”çš„è¾…åŠ©ä¿¡æ¯</span></span><br><span class="line">        data, _, comment = line.rstrip().partition(<span class="string">'#'</span>)</span><br><span class="line">        <span class="comment"># æŒ‰ç…§ç©ºæ ¼åˆ‡å‰²æ•°æ®</span></span><br><span class="line">        toks = data.split()</span><br><span class="line"></span><br><span class="line">        num_features = <span class="number">0</span></span><br><span class="line">        <span class="comment"># é»˜è®¤xå­˜åœ¨8ä¸ªçº¬åº¦ï¼Œå…ˆä½¿ç”¨missingå³ç¼ºå¤±å€¼è¿›è¡Œå¡«å……</span></span><br><span class="line">        x = np.repeat(missing, <span class="number">8</span>)</span><br><span class="line">        y = <span class="number">-1.0</span></span><br><span class="line">        weight = <span class="number">1.0</span></span><br><span class="line">        <span class="comment"># æœ‰æ ‡ç­¾yæ—¶ï¼Œç¬¬ä¸€ä¸ªå€¼ä¸ºæƒé‡</span></span><br><span class="line">        <span class="keyword">if</span> has_targets:</span><br><span class="line">            y = float(toks[<span class="number">0</span>])</span><br><span class="line">            toks = toks[<span class="number">1</span>:]</span><br><span class="line">        <span class="comment"># æœ‰æƒé‡æ—¶ï¼Œç¬¬äºŒä¸ªå€¼ä¸ºæƒé‡</span></span><br><span class="line">        <span class="keyword">if</span> has_weight:</span><br><span class="line">            weight = float(toks[<span class="number">0</span>])</span><br><span class="line">            toks = toks[<span class="number">1</span>:]</span><br><span class="line">        <span class="comment"># è·å–qidï¼Œä½¿ç”¨qid:åˆ‡å‰²</span></span><br><span class="line">        qid = _parse_qid_tok(toks[<span class="number">0</span>])</span><br><span class="line">        <span class="comment"># å‰©ä½™çš„toks[1:]å…¨éƒ¨ä¸ºxï¼Œå˜é‡æ¯ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="keyword">for</span> tok <span class="keyword">in</span> toks[<span class="number">1</span>:]:</span><br><span class="line">            <span class="comment"># è·å–å¯¹åº”çš„çº¬åº¦å’Œå€¼</span></span><br><span class="line">            fid, _, val = tok.partition(<span class="string">':'</span>)</span><br><span class="line">            fid = int(fid)</span><br><span class="line">            val = float(val)</span><br><span class="line">            <span class="comment"># å¦‚æœä½¿ç”¨ç´¢å¼•å¼€å§‹ï¼Œåˆ™éœ€è¦å°†fidå‡å»1ï¼ˆå³æ–‡ä»¶ä¸­ä»1å¼€å§‹ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> one_indexed:</span><br><span class="line">                fid -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">assert</span> fid &gt;= <span class="number">0</span></span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰xé•¿åº¦å°äºå…¶ç´¢å¼•ï¼Œåˆ™è¯´æ˜é¢„åˆ†é…çš„ç©ºé—´ä¸è¶³</span></span><br><span class="line">            <span class="keyword">while</span> len(x) &lt;= fid:</span><br><span class="line">                orig = len(x)</span><br><span class="line">                <span class="comment"># å°†xæ‰©å¤§åˆ°ä¸¤å€ï¼Œæ‰©å¤§éƒ¨åˆ†ä¹Ÿä½¿ç”¨missingå¡«å……</span></span><br><span class="line">                x.resize(len(x) * <span class="number">2</span>)</span><br><span class="line">                x[orig:orig * <span class="number">2</span>] = missing</span><br><span class="line">            <span class="comment"># è®¾ç½®å¯¹åº”xå‘é‡å€¼</span></span><br><span class="line">            x[fid] = val</span><br><span class="line">            <span class="comment"># è®°å½•å®é™…xçš„çº¬åº¦</span></span><br><span class="line">            num_features = max(fid + <span class="number">1</span>, num_features)</span><br><span class="line">        <span class="comment"># æ ¹æ®çº¬åº¦å¯¹Xè¿›è¡Œresize</span></span><br><span class="line">        <span class="keyword">assert</span> num_features &gt; <span class="number">0</span></span><br><span class="line">        x.resize(num_features)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> (x, y, weight, qid, comment)</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥ç›´åˆ°ï¼Œpyltrè¯»å–æ•°æ®çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y weight qid:value x_1:value_1 x_2:value_2 ... x_n:value_n<span class="meta">#commment</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­yå’Œweightéå¿…é¡»ï¼ˆè®­ç»ƒåº”è¯¥å¿…é¡»æœ‰yï¼‰qidçš„valueç”¨äºåˆ’åˆ†pairï¼Œx_iä¸ºè¾“å…¥çš„xå‘é‡ï¼Œå¦‚æœæŸä¸ªå‘é‡æ²¡æœ‰ï¼Œå¯ä»¥ä¸åœ¨æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œä½¿ç”¨missingå¡«å……ã€‚commentæ˜¯è¿™æ¡æ•°æ®å¯¹åº”çš„é¢å¤–ä¿¡æ¯ï¼Œå¦‚queryå’Œå¯¹åº”çš„docã€‚</p>
<p>æ³¨æ„qidå¿…é¡»è¦æ˜¯åŒä¸€ä¸ªçš„è¿ç»­å­˜æ”¾ã€‚</p>
<h1 id="lambdaMart"><a href="#lambdaMart" class="headerlink" title="lambdaMart"></a>lambdaMart</h1><h2 id="åˆå§‹åŒ–å‚æ•°"><a href="#åˆå§‹åŒ–å‚æ•°" class="headerlink" title="åˆå§‹åŒ–å‚æ•°"></a>åˆå§‹åŒ–å‚æ•°</h2><div class="table-container">
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>ç±»å‹</th>
<th>å«ä¹‰</th>
<th>é»˜è®¤å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>metric</td>
<td>object</td>
<td>æ¨¡å‹è¦æœ€å¤§åŒ–çš„åº¦é‡ã€‚</td>
<td></td>
</tr>
<tr>
<td>learning_rate</td>
<td>float</td>
<td>å­¦ä¹ ç‡</td>
<td>0.1</td>
</tr>
<tr>
<td>n_estimators</td>
<td>int</td>
<td>æå‡é˜¶æ®µæ•°é‡ï¼Œå³ç®€å•æ¨¡å‹çš„æ•°é‡ï¼ˆå†³ç­–æ ‘ï¼‰</td>
<td>100</td>
</tr>
<tr>
<td>max_depth</td>
<td>int</td>
<td>å•ä¸ªå›å½’ä¼°è®¡å™¨çš„æœ€å¤§æ·±åº¦ã€‚æœ€å¤§æ·±åº¦é™åˆ¶äº†æ ‘ä¸­èŠ‚ç‚¹æ•°é‡ï¼Œé€šè¿‡è°ƒæ•´è¯¥å‚æ•°æ¥ä¼˜åŒ–æ€§èƒ½ã€‚å¦‚æœ<code>max_leaf_nodes</code>ä¸ä¸ºç©ºåˆ™å¿½ç•¥è¯¥å‚æ•°ã€‚</td>
<td>3</td>
</tr>
<tr>
<td>min_samples_split</td>
<td>int</td>
<td>æ‹†åˆ†å†…éƒ¨èŠ‚ç‚¹æ‰€éœ€çš„æœ€å°æ ·æœ¬æ•°ã€‚</td>
<td>2</td>
</tr>
<tr>
<td>min_samples_leaf</td>
<td>int</td>
<td>å¶èŠ‚ç‚¹æ‰€éœ€çš„æœ€å°æ ·æœ¬æ•°ã€‚</td>
<td>1</td>
</tr>
<tr>
<td>subsample</td>
<td>float</td>
<td>ç”¨äºæ‹Ÿåˆå•ä¸ªåŸºç¡€å­¦ä¹ å™¨çš„æ ·æœ¬æ¯”ä¾‹ã€‚</td>
<td>1.0</td>
</tr>
<tr>
<td>query_subsample</td>
<td>float</td>
<td>ç”¨äºæ‹Ÿåˆå•ä¸ªåŸºç¡€å­¦ä¹ å™¨çš„æŸ¥è¯¢æ¯”ä¾‹ã€‚ï¼ˆå³qidæ•°é‡ï¼‰</td>
<td>1.0</td>
</tr>
<tr>
<td>max_features</td>
<td>intï¼Œfloatï¼Œstringï¼Œnone</td>
<td>å†…éƒ¨èŠ‚ç‚¹ç”Ÿæˆå­èŠ‚ç‚¹æ—¶è€ƒè™‘çš„ç‰¹å¾æ•°é‡ã€‚ï¼ˆåœ¨å­˜åœ¨å¤§é‡ç‰¹å¾æ—¶åŠ é€Ÿï¼‰ã€‚intæ—¶ï¼Œè¡¨ç¤ºè¦è€ƒè™‘çš„æ•°é‡ã€‚floatæ—¶ï¼Œè¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„ç™¾åˆ†æ¯”ï¼Œautoæ—¶ä¸ºsqrt(n_features)ï¼Œsqrtå’Œautoä¸€æ ·ï¼Œlog2ä¸º($log_2{n_features}$)ï¼Œnoneæ—¶ä¸ºæ‰€æœ‰ç‰¹å¾å‡è¦è€ƒè™‘ã€‚é€‰æ‹©â€œmax_features &lt; n_featuresâ€ä¼šå¯¼è‡´æ–¹å·®å‡å°‘å’Œåå·®å¢åŠ ã€‚æ³¨æ„ï¼šåœ¨æ‰¾åˆ°è‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹æ ·æœ¬çš„æœ‰æ•ˆåˆ†åŒºä¹‹å‰ï¼Œåˆ†å‰²çš„æœç´¢ä¸ä¼šåœæ­¢ï¼Œå³ä½¿å®ƒæ£€æŸ¥å·²ç»è¶…è¿‡ <code>max_features</code> ä¸ªç‰¹å¾ã€‚</td>
<td>none</td>
</tr>
<tr>
<td>max_leaf_nodes</td>
<td>int/none</td>
<td>ç”Ÿæˆæ ‘çš„æœ€å¤§å¶èŠ‚ç‚¹æ•°é‡ã€‚å¦‚æœæ˜¯noneï¼Œåˆ™è¡¨ç¤ºæ— é™åˆ¶ã€‚ä¸ä¸ºnoneæ—¶å°†å¿½ç•¥å‚æ•°<code>max_depth</code></td>
<td>none</td>
</tr>
<tr>
<td>verbose</td>
<td>int</td>
<td>å¯ç”¨è¯¦ç»†è¾“å‡ºã€‚ å¦‚æœä¸º 1ï¼Œåˆ™å®ƒä¼šä¸æ—¶æ‰“å°è¿›åº¦å’Œæ€§èƒ½ï¼ˆæ ‘è¶Šå¤šé¢‘ç‡è¶Šä½ï¼‰ã€‚ å¦‚æœå¤§äº 1ï¼Œåˆ™å®ƒä¼šæ‰“å°æ¯æ£µæ ‘çš„è¿›åº¦å’Œæ€§èƒ½ã€‚</td>
<td>0</td>
</tr>
<tr>
<td>warm_start</td>
<td>bool</td>
<td>å½“è®¾ç½®ä¸º <code>True</code> æ—¶ï¼Œé‡ç”¨ä¹‹å‰è°ƒç”¨ fit çš„é›†æˆæ¨¡å‹å¹¶å‘é›†æˆæ·»åŠ æ›´å¤šä¼°è®¡é‡ï¼Œå¦åˆ™ï¼Œåªéœ€åˆ é™¤ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆã€‚</td>
<td>false</td>
</tr>
<tr>
<td>random_state</td>
<td>intï¼ŒRandomState instanceï¼Œnone</td>
<td>å¦‚æœæ˜¯ intï¼Œrandom_state æ˜¯éšæœºæ•°ç”Ÿæˆå™¨ä½¿ç”¨çš„ç§å­ï¼› å¦‚æœæ˜¯ RandomState å®ä¾‹ï¼Œrandom_state æ˜¯éšæœºæ•°ç”Ÿæˆå™¨ï¼› å¦‚æœæ²¡æœ‰ï¼Œéšæœºæ•°ç”Ÿæˆå™¨æ˜¯ <code>np.random</code> ä½¿ç”¨çš„ RandomState å®ä¾‹ã€‚</td>
<td>none</td>
</tr>
</tbody>
</table>
</div>
<p>ä¸Šè¿°æ˜¯åˆå§‹åŒ–LambdaMARTçš„å‚æ•°ï¼Œç”¨äºå®šä¹‰å¦‚ä¸‹ç”Ÿæˆæ¨¡å‹ã€‚é™¤äº†è¿™äº›å‚æ•°ä»¥å¤–ï¼Œè¿˜åŒ…å«å¦‚ä¸‹çš„å†…éƒ¨å±æ€§ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>ç±»å‹</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>feature_importances_</td>
<td>n_featuresçº¬æ•°ç»„</td>
<td>ç‰¹å¾é‡è¦æ€§ï¼ˆè¶Šé«˜ï¼Œç‰¹å¾è¶Šé‡è¦ï¼‰ã€‚</td>
</tr>
<tr>
<td>oob_improvement_</td>
<td>n_estimatorsçº¬æ•°ç»„</td>
<td>è¢‹å¤–æ ·æœ¬ç›¸å¯¹äºå‰ä¸€æ¬¡è¿­ä»£çš„æŸå¤±ï¼ˆ= åå·®ï¼‰æ”¹è¿›ã€‚<code>oob_improvement_[0]</code> æ˜¯å¯¹ <code>init</code> ä¼°è®¡å™¨çš„ç¬¬ä¸€é˜¶æ®µæŸå¤±çš„æ”¹è¿›ã€‚</td>
</tr>
<tr>
<td>train_score_</td>
<td>n_estimatorsçº¬æ•°ç»„</td>
<td>ç¬¬ i ä¸ªåˆ†æ•° <code>train_score_[i]</code> æ˜¯æ¨¡å‹åœ¨è¿­ä»£ <code>i</code> æ—¶åœ¨è¢‹å†…æ ·æœ¬ä¸Šçš„åå·®ï¼ˆ= æŸå¤±ï¼‰ã€‚å¦‚æœ <code>subsample == 1</code> è¿™å°±æ˜¯è®­ç»ƒæ•°æ®çš„åå·®ã€‚</td>
</tr>
<tr>
<td>estimators_</td>
<td>[n_estimators, 1]çš„ndarrayå­˜å‚¨è®­ç»ƒå®Œæˆçš„å†³ç­–æ ‘é›†åˆ</td>
<td>æ‹Ÿåˆå­ä¼°è®¡é‡çš„é›†åˆã€‚ å¯¹äºäºŒå…ƒåˆ†ç±»ï¼Œ<code>loss_.K</code> ä¸º 1ï¼Œå¦åˆ™ä¸º n_classesã€‚</td>
</tr>
<tr>
<td>estimators_fitted_</td>
<td>int</td>
<td>å®é™…æ‹Ÿåˆçš„å­ä¼°è®¡é‡çš„æ•°é‡ã€‚ è¿™å¯èƒ½ä¸ n_estimators åœ¨æå‰åœæ­¢ã€ä¿®å‰ªç­‰æƒ…å†µä¸‹ä¸åŒã€‚</td>
</tr>
</tbody>
</table>
</div>
<h3 id="metric"><a href="#metric" class="headerlink" title="metric"></a>metric</h3><p>è¿›è¡Œè®­ç»ƒæ•ˆæœçš„åº¦é‡ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯NDCGï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NDCG</span><span class="params">(Metric)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, k=<span class="number">10</span>, gain_type=<span class="string">'exp2'</span>)</span>:</span></span><br><span class="line">        super(NDCG, self).__init__()</span><br><span class="line">        self.k = k</span><br><span class="line">        self.gain_type = gain_type</span><br><span class="line">        self._dcg = DCG(k=k, gain_type=gain_type)</span><br><span class="line">        self._ideals = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­kè¡¨ç¤ºåªè®¡ç®—æ’åºå‰kçš„æ•°æ®çš„NDCGã€‚<code>gain_type</code>è¡¨ç¤ºåº¦é‡NDCGæ˜¯ï¼Œæ¯ä¸ªæ–‡æ¡£çš„åŠ æƒå€¼ï¼Œå¯ä»¥é€‰æ‹©ï¼š</p>
<p>exp2è¡¨ç¤ºä½¿ç”¨çš„ç®—åˆ†å‡½æ•°ä¸ºï¼š</p>
<script type="math/tex; mode=display">
DCG_P\sum_i^P\frac{2^{rel_i}-1}{log_2{(i+1)}}</script><p>identityè¡¨ç¤ºä½¿ç”¨çš„å‡½æ•°ä¸ºï¼š</p>
<script type="math/tex; mode=display">
DCG_P\sum_i^P\frac{x}{log_2{(i+1)}}</script><h2 id="æ‰§è¡Œfitï¼ˆæ‹Ÿåˆï¼‰å‡½æ•°"><a href="#æ‰§è¡Œfitï¼ˆæ‹Ÿåˆï¼‰å‡½æ•°" class="headerlink" title="æ‰§è¡Œfitï¼ˆæ‹Ÿåˆï¼‰å‡½æ•°"></a>æ‰§è¡Œfitï¼ˆæ‹Ÿåˆï¼‰å‡½æ•°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fit</span><span class="params">(self, X, y, sample_weight, qids, monitor=None)</span>:</span></span><br><span class="line">    <span class="string">"""Fit lambdamart onto a dataset.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    X : array_like, shape = [n_samples, n_features]</span></span><br><span class="line"><span class="string">        Training vectors, where n_samples is the number of samples</span></span><br><span class="line"><span class="string">        and n_features is the number of features.</span></span><br><span class="line"><span class="string">    y : array_like, shape = [n_samples]</span></span><br><span class="line"><span class="string">        Target values (integers in classification, real numbers in</span></span><br><span class="line"><span class="string">        regression)</span></span><br><span class="line"><span class="string">        For classification, labels must correspond to classes.</span></span><br><span class="line"><span class="string">    sample_weight : array_like, shape = [n_samples]</span></span><br><span class="line"><span class="string">        The weight of the samples.</span></span><br><span class="line"><span class="string">    qids : array_like, shape = [n_samples]</span></span><br><span class="line"><span class="string">        Query ids for each sample. Samples must be grouped by query such</span></span><br><span class="line"><span class="string">        that all queries with the same qid appear in one contiguous block.</span></span><br><span class="line"><span class="string">    monitor : callable, optional</span></span><br><span class="line"><span class="string">        The monitor is called after each iteration with the current</span></span><br><span class="line"><span class="string">        iteration, a reference to the estimator and the local variables of</span></span><br><span class="line"><span class="string">        ``_fit_stages`` as keyword arguments ``callable(i, self,</span></span><br><span class="line"><span class="string">        locals())``. If the callable returns ``True`` the fitting procedure</span></span><br><span class="line"><span class="string">        is stopped. The monitor can be used for various things such as</span></span><br><span class="line"><span class="string">        computing held-out estimates, early stopping, model introspecting,</span></span><br><span class="line"><span class="string">        and snapshoting.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    // å¦‚æœåˆå§‹åŒ–æ—¶å‚æ•°warm_startä¸ºfalseï¼Œåˆ™å°†å…¶ä¹‹å‰å¯èƒ½å­˜åœ¨çš„è®­ç»ƒå±æ€§å…¨éƒ¨æ¸…ç©º</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.warm_start:</span><br><span class="line">        self._clear_state()</span><br><span class="line">    </span><br><span class="line">    // æ£€éªŒè¾“å…¥æ•°æ®</span><br><span class="line">    X, y = sklearn.utils.check_X_y(X, y, dtype=sklearn.tree._tree.DTYPE)</span><br><span class="line">    n_samples, self.n_features = X.shape</span><br><span class="line"></span><br><span class="line">    sklearn.utils.check_consistent_length(X, y, qids)</span><br><span class="line">    <span class="keyword">if</span> y.dtype.kind == <span class="string">'O'</span>:</span><br><span class="line">        y = y.astype(np.float64)</span><br><span class="line"></span><br><span class="line">    random_state = sklearn.utils.check_random_state(self.random_state)</span><br><span class="line">    self._check_params()</span><br><span class="line">    </span><br><span class="line">    // åˆ†é…å†…éƒ¨å±æ€§ç©ºé—´ã€‚</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self._is_initialized():</span><br><span class="line">        self._init_state()</span><br><span class="line">        begin_at_stage = <span class="number">0</span></span><br><span class="line">        y_pred = np.zeros(y.shape[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> self.n_estimators &lt; self.estimators_.shape[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'n_estimators=%d must be larger or equal to '</span></span><br><span class="line">                             <span class="string">'estimators_.shape[0]=%d when '</span></span><br><span class="line">                             <span class="string">'warm_start==True'</span></span><br><span class="line">                             % (self.n_estimators,</span><br><span class="line">                                self.estimators_.shape[<span class="number">0</span>]))</span><br><span class="line">        begin_at_stage = self.estimators_.shape[<span class="number">0</span>]</span><br><span class="line">        self.estimators_fitted_ = begin_at_stage</span><br><span class="line">        self.estimators_.resize((self.n_estimators, <span class="number">1</span>))</span><br><span class="line">        self.train_score_.resize(self.n_estimators)</span><br><span class="line">        <span class="keyword">if</span> self.query_subsample &lt; <span class="number">1.0</span>:</span><br><span class="line">            self.oob_improvement_.resize(self.n_estimators)</span><br><span class="line">        y_pred = self.predict(X)</span><br><span class="line">    </span><br><span class="line">    // æ‰§è¡Œfit</span><br><span class="line">    n_stages = self._fit_stages(X, y, sample_weight, qids, y_pred,</span><br><span class="line">                                random_state, begin_at_stage, monitor)</span><br><span class="line"></span><br><span class="line">    // å¦‚æœå®é™…ç”Ÿæˆçš„æ ‘æ•°é‡å°äºåˆå§‹åŒ–å‚æ•°n_estimatorsï¼Œåˆ™å°†ç›¸åº”é¢„åˆ†é…çš„å†…éƒ¨å±æ€§å˜æ›´ä¸ºå®é™…å¤§å°</span><br><span class="line">    <span class="keyword">if</span> n_stages &lt; self.estimators_.shape[<span class="number">0</span>]:</span><br><span class="line">        self.trim(n_stages)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_fit_stages</span><span class="params">(self, X, y, sample_weight, qids, y_pred, random_state,</span></span></span><br><span class="line"><span class="function"><span class="params">                begin_at_stage=<span class="number">0</span>, monitor=None)</span>:</span></span><br><span class="line">    // æ ·æœ¬æ•°é‡</span><br><span class="line">    n_samples = X.shape[<span class="number">0</span>]</span><br><span class="line">    // æ¯æ¬¡è®­ç»ƒæ˜¯å¦ä½¿ç”¨å…¨éƒ¨æ ·æœ¬</span><br><span class="line">    do_subsample = self.subsample &lt; <span class="number">1.0</span></span><br><span class="line">    <span class="comment">#sample_weight = np.ones(n_samples, dtype=np.float64)</span></span><br><span class="line">    // è·å–qidæ•°é‡ï¼ˆuniqueï¼›å¤šå°‘ä¸ªqueryï¼‰</span><br><span class="line">    n_queries = check_qids(qids)</span><br><span class="line">    // æ ¹æ®qidç”Ÿæˆqueryç»„ï¼Œå…¶ä¸­å…ƒç´ ä¸ºqidï¼Œåœ¨æ ·æœ¬ä¸­èµ·å§‹ä¸‹æ ‡ï¼Œæœ«å°¾ä¸‹æ ‡ï¼Œä¸‹æ ‡åˆ—è¡¨</span><br><span class="line">    query_groups = np.array([(qid, a, b, np.arange(a, b))</span><br><span class="line">                             <span class="keyword">for</span> qid, a, b <span class="keyword">in</span> get_groups(qids)],</span><br><span class="line">                            dtype=np.object)</span><br><span class="line">    // ä¹‹å‰è®¡ç®—çš„qidæ•°é‡åº”è¯¥å’Œqueryç»„æ•°é‡ä¸€è‡´</span><br><span class="line">    <span class="keyword">assert</span> n_queries == len(query_groups)</span><br><span class="line">    // æ¯æ¬¡è®­ç»ƒæ˜¯å¦ä½¿ç”¨å…¨éƒ¨query</span><br><span class="line">    do_query_oob = self.query_subsample &lt; <span class="number">1.0</span></span><br><span class="line">    // queryçš„maskï¼Œå½“ä¸ä½¿ç”¨å…¨éƒ¨queryæ—¶ï¼Œä½¿ç”¨è¯¥æ•°ç»„å’Œquery_groupsè·å–æ‰€æœ‰è¦å‚åŠ è®­ç»ƒçš„æ ·æœ¬ï¼Œåˆå§‹åŒ–å…¨éƒ¨ä¸º<span class="number">1</span>ï¼Œè¡¨ç¤ºæ‰€æœ‰queryå‡å‚ä¸è®­ç»ƒ</span><br><span class="line">    query_mask = np.ones(n_queries, dtype=np.bool)</span><br><span class="line">    // queryæ•°ç»„ä¸‹æ ‡ï¼Œåœ¨ä¸ä½¿ç”¨å…¨éƒ¨queyæ—¶ï¼Œéœ€è¦è¿›è¡Œæ‰“æ•£ï¼Œé€‰æ‹©éƒ¨åˆ†queryç»„</span><br><span class="line">    query_idx = np.arange(n_queries)</span><br><span class="line">    // é€‰æ‹©å…¨éƒ¨queryç»„ä¸­çš„æ¯”ä¾‹</span><br><span class="line">    q_inbag = max(<span class="number">1</span>, int(self.query_subsample * n_queries))</span><br><span class="line"></span><br><span class="line">    // åˆå§‹åŒ–è¾“å‡º</span><br><span class="line">    <span class="keyword">if</span> self.verbose:</span><br><span class="line">        verbose_reporter = _VerboseReporter(self.verbose)</span><br><span class="line">        verbose_reporter.init(self, begin_at_stage)</span><br><span class="line">    </span><br><span class="line">    // æ‰§è¡Œæ¯ä¸€ä¸ªåŸºç¡€è®­ç»ƒ</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(begin_at_stage, self.n_estimators):</span><br><span class="line">        // å¦‚æœä¸ä½¿ç”¨å…¨éƒ¨çš„queryç»„</span><br><span class="line">        <span class="keyword">if</span> do_query_oob:</span><br><span class="line">            // å°†ç´¢å¼•éšæœºåŒ–</span><br><span class="line">            random_state.shuffle(query_idx)</span><br><span class="line">            // é‡æ–°åˆå§‹åŒ–queryçš„mask</span><br><span class="line">            query_mask = np.zeros(n_queries, dtype=np.bool)</span><br><span class="line">            // é€‰æ‹©æŒ‡å®šéƒ¨åˆ†çš„queryè¿›è¡Œè®­ç»ƒ</span><br><span class="line">            query_mask[query_idx[:q_inbag]] = <span class="number">1</span></span><br><span class="line">        // å®é™…éœ€è¦å‚ä¸æœ¬è½®è®­ç»ƒçš„queryç»„</span><br><span class="line">        query_groups_to_use = query_groups[query_mask]</span><br><span class="line">        // å®é™…éœ€è¦å‚ä¸è®­ç»ƒçš„æ ·æœ¬mask</span><br><span class="line">        sample_mask = np.zeros(n_samples, dtype=np.bool)</span><br><span class="line">        // å˜é‡æ¯ä¸€ä¸ªqueryç»„</span><br><span class="line">        <span class="keyword">for</span> qid, a, b, sidx <span class="keyword">in</span> query_groups_to_use:</span><br><span class="line">            // éœ€è¦ä½¿ç”¨çš„æ ·æœ¬ä¸‹æ ‡</span><br><span class="line">            sidx_to_use = sidx</span><br><span class="line">            // å¦‚æœä¸ä½¿ç”¨å…¨éƒ¨æ ·æœ¬ï¼Œä¸queryç±»ä¼¼ï¼Œå¯¹queryç»„ä¸­çš„æ ·æœ¬è¿›è¡Œéšæœºé‡‡æ ·ï¼Œä½†æ„Ÿè§‰è¿™é‡Œæœ‰é—®é¢˜ï¼Œå› ä¸ºå–çš„æœ€å¤§å€¼æ˜¯b<span class="number">-1</span>ä¹˜ä»¥é‡‡æ ·ç³»æ•°ï¼Œä½†æ¯ä¸ªæ ·æœ¬ä¸­æ ·æœ¬æ•°é‡åº”è¯¥æ˜¯b-aï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨b-aï¼Œä¹Ÿæ— æ³•ä¿è¯è®­ç»ƒä½¿ç”¨çš„æ ·æœ¬æ•°é‡æ˜¯æŒ‡å®šçš„æ¯”ä¾‹ï¼Œå› ä¸ºè¿˜æœ‰å¯èƒ½åªæ˜¯ä½¿ç”¨äº†éƒ¨åˆ†çš„queryã€‚</span><br><span class="line">            <span class="keyword">if</span> do_subsample:</span><br><span class="line">                query_samples_inbag = max(</span><br><span class="line">                    <span class="number">1</span>, int(self.subsample * (b - <span class="number">1</span>)))</span><br><span class="line">                random_state.shuffle(sidx)</span><br><span class="line">                sidx_to_use = sidx[:query_samples_inbag]</span><br><span class="line">            sample_mask[sidx_to_use] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        // è®°å½•æœªå‚ä¸è®­ç»ƒçš„æ ·æœ¬çš„å½“å‰è®­ç»ƒåˆ†æ•°</span><br><span class="line">        <span class="keyword">if</span> do_query_oob:</span><br><span class="line">            old_oob_total_score = <span class="number">0.0</span></span><br><span class="line">            <span class="keyword">for</span> qid, a, b, _ <span class="keyword">in</span> query_groups[~query_mask]:</span><br><span class="line">                old_oob_total_score += self.metric.evaluate_preds(</span><br><span class="line">                    qid, y[a:b], y_pred[a:b])</span><br><span class="line"></span><br><span class="line">        // è¿›è¡Œè®­ç»ƒï¼Œå¹¶è·å–æ–°çš„æ ·æœ¬é¢„ä¼°</span><br><span class="line">        y_pred = self._fit_stage(i, X, y, qids, y_pred, sample_weight,</span><br><span class="line">                                 sample_mask, query_groups_to_use,</span><br><span class="line">                                 random_state)</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—å‚ä¸è®­ç»ƒåï¼Œè®­ç»ƒæ ·æœ¬è¯„åˆ†å’Œæœªå‚ä¸è®­ç»ƒæ ·æœ¬è¯„åˆ†</span><br><span class="line">        train_total_score, oob_total_score = <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">for</span> qidx, (qid, a, b, _) <span class="keyword">in</span> enumerate(query_groups):</span><br><span class="line">            score = self.metric.evaluate_preds(</span><br><span class="line">                qid, y[a:b], y_pred[a:b])</span><br><span class="line">            <span class="keyword">if</span> query_mask[qidx]:</span><br><span class="line">                train_total_score += score</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                oob_total_score += score</span><br><span class="line">        // è®°å½•å½“å‰å¾ªç¯çš„å‚ä¸è®­ç»ƒçš„æ ·æœ¬çš„åˆ†æ•°</span><br><span class="line">        self.train_score_[i] = train_total_score / q_inbag</span><br><span class="line">        // å¦‚æœä¸æ˜¯ä½¿ç”¨å…¨éƒ¨æ ·æœ¬è¿›è¡Œè®­ç»ƒï¼Œåˆ™è®°å½•æœ¬è½®è®­ç»ƒå¯¹æœªå‚ä¸è®­ç»ƒæ ·æœ¬çš„åˆ†æ•°æå‡</span><br><span class="line">        <span class="keyword">if</span> do_query_oob:</span><br><span class="line">            <span class="keyword">if</span> q_inbag &lt; n_queries:</span><br><span class="line">                self.oob_improvement_[i] = \</span><br><span class="line">                    ((oob_total_score - old_oob_total_score) /</span><br><span class="line">                     (n_queries - q_inbag))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆ¤æ–­æ˜¯å¦ç»ˆæ­¢è®­ç»ƒ</span></span><br><span class="line">        early_stop = <span class="literal">False</span></span><br><span class="line">        monitor_output = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> monitor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            monitor_output = monitor(i, self, locals())</span><br><span class="line">            <span class="keyword">if</span> monitor_output <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                early_stop = <span class="literal">True</span></span><br><span class="line">        <span class="comment"># è¾“å‡ºå½“å‰è®­ç»ƒè¿›åº¦æ—¥å¿—`	1qnm  Zxdsdwertyul;xcv</span></span><br><span class="line">        <span class="keyword">if</span> self.verbose &gt; <span class="number">0</span>:</span><br><span class="line">            verbose_reporter.update(i, self, monitor_output)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> early_stop:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œçš„è®­ç»ƒå‡½æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_fit_stage</span><span class="params">(self, i, X, y, qids, y_pred, sample_weight, sample_mask,</span></span></span><br><span class="line"><span class="function"><span class="params">                   query_groups, random_state)</span>:</span></span><br><span class="line">        <span class="string">"""Fit another tree to the boosting model."""</span></span><br><span class="line">        <span class="keyword">assert</span> sample_mask.dtype == np.bool</span><br><span class="line"></span><br><span class="line">        n_samples = X.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        all_lambdas = np.zeros(n_samples)</span><br><span class="line">        all_deltas = np.zeros(n_samples)</span><br><span class="line">        <span class="comment">#æ ¹æ®queryç»„è®¡ç®—lambdaå’Œlambdaå¯¹æ¨¡å‹çš„æ¢¯åº¦</span></span><br><span class="line">        <span class="keyword">for</span> qid, a, b, _ <span class="keyword">in</span> query_groups:</span><br><span class="line">            lambdas, deltas = self._calc_lambdas_deltas(qid, y[a:b],</span><br><span class="line">                                                        y_pred[a:b])</span><br><span class="line">            all_lambdas[a:b] = lambdas</span><br><span class="line">            all_deltas[a:b] = deltas</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># æ„å»ºå›å½’å†³ç­–æ ‘</span></span><br><span class="line">        tree = sklearn.tree.DecisionTreeRegressor(</span><br><span class="line">            criterion=<span class="string">'friedman_mse'</span>,</span><br><span class="line">            splitter=<span class="string">'best'</span>,</span><br><span class="line">            presort=<span class="literal">True</span>,</span><br><span class="line">            max_depth=self.max_depth,</span><br><span class="line">            min_samples_split=self.min_samples_split,</span><br><span class="line">            min_samples_leaf=self.min_samples_leaf,</span><br><span class="line">            min_weight_fraction_leaf=<span class="number">0.0</span>,</span><br><span class="line">            max_features=self.max_features,</span><br><span class="line">            max_leaf_nodes=self.max_leaf_nodes,</span><br><span class="line">            random_state=random_state)</span><br><span class="line">        <span class="comment"># æ ¹æ®é‡‡æ ·ï¼Œç¡®å®šæ¨¡å‹æƒé‡ï¼Œå¯¹äºæƒé‡ä¸º0çš„æ•°æ®ï¼Œç›¸å½“äºæ²¡æœ‰å‚ä¸è®­ç»ƒ</span></span><br><span class="line">        <span class="keyword">if</span> self.subsample &lt; <span class="number">1.0</span> <span class="keyword">or</span> self.query_subsample &lt; <span class="number">1.0</span>:</span><br><span class="line">            sample_weight = sample_weight * sample_mask.astype(np.float64)</span><br><span class="line">        <span class="comment"># å›å½’æ ‘è®­ç»ƒï¼Œæ‹Ÿåˆæ–°çš„lambda</span></span><br><span class="line">        tree.fit(X, all_lambdas, sample_weight=sample_weight,</span><br><span class="line">                 check_input=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># æ›´æ–°æ¨¡å‹</span></span><br><span class="line">        self._update_terminal_regions(tree.tree_, X, y, all_lambdas,</span><br><span class="line">                                      all_deltas, y_pred, sample_mask)</span><br><span class="line">        self.estimators_[i, <span class="number">0</span>] = tree</span><br><span class="line">        self.estimators_fitted_ = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#        print 'sample_weight:', sample_weight</span></span><br><span class="line">        <span class="keyword">return</span> y_pred</span><br></pre></td></tr></table></figure>
<h2 id="è·å–lambdaåŠç›¸å¯¹äºå½“å‰æ¨¡å‹çš„æ¢¯åº¦"><a href="#è·å–lambdaåŠç›¸å¯¹äºå½“å‰æ¨¡å‹çš„æ¢¯åº¦" class="headerlink" title="è·å–lambdaåŠç›¸å¯¹äºå½“å‰æ¨¡å‹çš„æ¢¯åº¦"></a>è·å–lambdaåŠç›¸å¯¹äºå½“å‰æ¨¡å‹çš„æ¢¯åº¦</h2><p>è¿™é‡Œè®¡ç®—ç®—æ³•ä»‹ç»ä¸­çš„$\lambda_i$å’Œ$w_i$ã€‚</p>
<p>å…¶æ‰§è¡Œé€»è¾‘ä¸ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¾“å…¥ä¸ºqidï¼Œyä¸ºæ ·æœ¬çœŸå®labelï¼Œy_predä¸ºæ¨¡å‹è®­ç»ƒçš„è¾“å‡ºlabelï¼Œy, y_predå‡ä¸ºä¸€ç»´æ•°ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_calc_lambdas_deltas</span><span class="params">(self, qid, y, y_pred)</span>:</span></span><br><span class="line">    ns = y.shape[<span class="number">0</span>]</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    è·å–æŒ‰ç…§é¢„ä¼°çš„åˆ†æ•°æ¯ä¸ªæ–‡æ¡£çš„æ’åï¼ˆä»0å¼€å§‹ï¼‰</span></span><br><span class="line"><span class="string">    def get_sorted_y_positions(y, y_pred, check=True):</span></span><br><span class="line"><span class="string">        if check:</span></span><br><span class="line"><span class="string">            y = sklearn.utils.validation.column_or_1d(y)</span></span><br><span class="line"><span class="string">            y_pred = sklearn.utils.validation.column_or_1d(y_pred)</span></span><br><span class="line"><span class="string">            sklearn.utils.validation.check_consistent_length(y, y_pred)</span></span><br><span class="line"><span class="string">        # å¯¹ç´¢å¼•æŒ‰ç…§äºŒç»´æ•°ç»„æ’åºï¼Œå…ˆæŒ‰ç…§-y_predå†æŒ‰ç…§yæ’åº</span></span><br><span class="line"><span class="string">        return np.lexsort((y, -y_pred))</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    positions = get_sorted_y_positions(y, y_pred, check=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># æŒ‰ç…§é¢„ä¼°çš„æ’åºå¯¹æ ·æœ¬çœŸå®çš„ç›¸å…³æ€§è¿›è¡Œé‡æ’</span></span><br><span class="line">    actual = y[positions]</span><br><span class="line">    <span class="comment"># è·å–äº¤æ¢ä»»æ„ä¸¤ä¸ªæ–‡æ¡£å…¶ NDCGå·®å€¼</span></span><br><span class="line">    swap_deltas = self.metric.calc_swap_deltas(qid, actual)</span><br><span class="line">    <span class="comment"># è·å–æ¨¡å‹å…³æ³¨çš„æ–‡æ¡£æ•°é‡ï¼ˆå³queryå¬å›çš„å‰kä¸ªï¼‰</span></span><br><span class="line">    max_k = self.metric.max_k()</span><br><span class="line">    <span class="comment"># å¦‚æœæœªè®¾ç½®æ•°é‡ï¼Œæˆ–è€…æ•°é‡è¶…è¿‡äº†queryä¸‹å¬å›çš„æ–‡æ¡£æ•°é‡ï¼Œåˆ™è®¾ç½®ä¸ºå¬å›æ–‡æ¡£æ•°é‡</span></span><br><span class="line">    <span class="keyword">if</span> max_k <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> ns &lt; max_k:</span><br><span class="line">        max_k = ns</span><br><span class="line"></span><br><span class="line">    lambdas = np.zeros(ns)</span><br><span class="line">    deltas = np.zeros(ns)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># éå†æ¯ä¸ªéœ€è¦è€ƒè™‘çš„æ’åºå‰Kä¸ªæ–‡æ¡£ï¼Œè®¡ç®—ä¸å…¶ä»–æ–‡æ¡£çš„lambdaå’Œæ¢¯åº¦</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(max_k):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i + <span class="number">1</span>, ns):</span><br><span class="line">            <span class="comment"># å¯¹äºç›¸å…³æ€§ä¸€è‡´åˆ™è·³è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> actual[i] == actual[j]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># è·å–æ–‡æ¡£ä½ç½®äº’æ¢çš„NDCGå·®å€¼ï¼Œè¿™é‡Œå¹¶æœªå–ç»å¯¹å€¼ï¼Œéœ€è¦åç»­åˆ¤æ–­</span></span><br><span class="line">            delta_metric = swap_deltas[i, j]</span><br><span class="line">            <span class="keyword">if</span> delta_metric == <span class="number">0.0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            // è·å–æ–‡æ¡£åœ¨æ•°æ®ä¸­å®é™…ä½ç½®</span><br><span class="line">            a, b = positions[i], positions[j]</span><br><span class="line">            <span class="comment"># invariant: y_pred[a] &gt;= y_pred[b]</span></span><br><span class="line">            <span class="comment"># å¯¹äºçœŸå®çš„ç›¸å…³æ€§ i &lt; jå¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> actual[i] &lt; actual[j]:</span><br><span class="line">                <span class="comment"># è¿™æ—¶delta_metricåº”è¯¥å¤§äº0</span></span><br><span class="line">                <span class="keyword">assert</span> delta_metric &gt; <span class="number">0.0</span></span><br><span class="line">                <span class="comment"># è®¡ç®— 1/(1+e^(sj - si)),æ³¨æ„scipy.special.expit = 1/(1+exp(-x)),å³æœ¬èº«å­˜åœ¨ä¸€ä¸ªè´Ÿå·ï¼Œå› æ­¤è¾“å…¥æ—¶æ˜¯si-sj</span></span><br><span class="line">                logistic = scipy.special.expit(y_pred[a] - y_pred[b])</span><br><span class="line">                <span class="comment"># è®¡ç®— 1/(1+e^(sj - si))* NDGCï¼Œå› ä¸ºdelta_metricæ˜¯æ­£æ•°ï¼Œå› æ­¤ç›´æ¥è®¡ç®—</span></span><br><span class="line">                l = logistic * delta_metric</span><br><span class="line">                <span class="comment"># å¯¹äºaæ¥è¯´ï¼Œå…¶æ˜¯çœŸå®ç›¸å…³æ€§è¾ƒå·®çš„æ–‡æ¡£ï¼Œå› æ­¤å‡å»lambda</span></span><br><span class="line">                lambdas[a] -= l</span><br><span class="line">                <span class="comment"># å¯¹åº”bæ¥è¯´ï¼Œå…¶æ˜¯çœŸå®ç›¸å…³æ€§è¾ƒå¥½çš„æ–‡æ¡£ï¼Œå› æ­¤åŠ ä¸Šlambda</span></span><br><span class="line">                lambdas[b] += l</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">assert</span> delta_metric &lt; <span class="number">0.0</span></span><br><span class="line">                logistic = scipy.special.expit(y_pred[b] - y_pred[a])</span><br><span class="line">                l = logistic * -delta_metric</span><br><span class="line">                lambdas[a] += l</span><br><span class="line">                lambdas[b] -= l</span><br><span class="line">            <span class="comment"># è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">            gradient = (<span class="number">1</span> - logistic) * l</span><br><span class="line">            <span class="comment"># æ›´æ–°æ¢¯åº¦</span></span><br><span class="line">            deltas[a] += gradient</span><br><span class="line">            deltas[b] += gradient</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lambdas, deltas</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„lambdaæ˜¯è´Ÿæ¢¯åº¦ï¼Œdeltasæ˜¯æ­£å¸¸çš„lambdaå¯¹$s_i$çš„å¯¼æ•°ã€‚</p>
<h2 id="è®¡ç®—äº’æ¢ä½ç½®åNDCGå€¼"><a href="#è®¡ç®—äº’æ¢ä½ç½®åNDCGå€¼" class="headerlink" title="è®¡ç®—äº’æ¢ä½ç½®åNDCGå€¼"></a>è®¡ç®—äº’æ¢ä½ç½®åNDCGå€¼</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calc_swap_deltas</span><span class="params">(self, qid, targets)</span>:</span></span><br><span class="line">        <span class="comment"># æ ¹æ®qidè·å–IDCGå€¼</span></span><br><span class="line">        ideal = self._get_ideal(qid, targets)</span><br><span class="line">        <span class="keyword">if</span> ideal &lt; _EPS:</span><br><span class="line">            <span class="keyword">return</span> np.zeros((len(targets), len(targets)))</span><br><span class="line">        <span class="comment"># è®¡ç®—æ›¿æ¢åçš„NDCGå·®å€¼</span></span><br><span class="line">        <span class="keyword">return</span> self._dcg.calc_swap_deltas(</span><br><span class="line">            qid, targets, coeff=<span class="number">1.0</span> / ideal)</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">_get_ideal</span><span class="params">(self, qid, targets)</span>:</span></span><br><span class="line">        <span class="comment"># å¦‚æœ_idealsä¸­å·²ç»å­˜åœ¨åˆ™ä¸ç”¨è®¡ç®—ç›´æ¥è¿”å›</span></span><br><span class="line">        ideal = self._ideals.get(qid)</span><br><span class="line">        <span class="keyword">if</span> ideal <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ideal</span><br><span class="line">        <span class="comment"># æŒ‰ç…§çœŸå®çš„æ–‡æ¡£ç›¸å…³æ€§å¯¹æ–‡æ¡£è¿›è¡Œæ’åºï¼ˆç”±å¤§åˆ°å°ï¼‰</span></span><br><span class="line">        sorted_targets = np.sort(targets)[::<span class="number">-1</span>]</span><br><span class="line">        <span class="comment"># è®¡ç®—IDCGå€¼</span></span><br><span class="line">        ideal = self._dcg.evaluate(qid, sorted_targets)</span><br><span class="line">        <span class="comment"># å†™å…¥_ideals</span></span><br><span class="line">        self._ideals[qid] = ideal</span><br><span class="line">        <span class="keyword">return</span> ideal</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DCG</span><span class="params">(Metric)</span>:</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span><span class="params">(self, qid, targets)</span>:</span></span><br><span class="line">        <span class="comment"># è®¡ç®—æ¯ä¸ªæ–‡æ¡£å¾—åˆ†ï¼Œç›¸åŠ </span></span><br><span class="line">        <span class="comment"># _gain_fnå¯é€‰ï¼Œç›´æ¥ä½¿ç”¨xè¿˜æ˜¯(2.0 ** x) - 1.0ï¼Œé€šè¿‡åˆå§‹åŒ–æ—¶æŒ‡å®šgain_fnå‚æ•°ï¼šidentityï¼šxï¼›exp2ï¼š(2.0 ** x) - 1.0</span></span><br><span class="line">        <span class="comment"># _get_discountä¸ºå¯¹åº”ä½ç½®çš„log(i+2)ï¼Œä½ç½®ä»0å¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> sum(self._gain_fn(t) * self._get_discount(i)</span><br><span class="line">                   <span class="keyword">for</span> i, t <span class="keyword">in</span> enumerate(targets) <span class="keyword">if</span> i &lt; self.k)</span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">_get_discount</span><span class="params">(self, i)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= self.k:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">while</span> i &gt;= len(self._discounts):</span><br><span class="line">            self._grow_discounts()</span><br><span class="line">        <span class="keyword">return</span> self._discounts[i]</span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">_grow_discounts</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._discounts = self._make_discounts(len(self._discounts) * <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">_make_discounts</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> np.array([<span class="number">1.0</span> / np.log2(i + <span class="number">2.0</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(n)])</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">calc_swap_deltas</span><span class="params">(self, qid, targets, coeff=<span class="number">1.0</span>)</span>:</span></span><br><span class="line">        n_targets = len(targets)</span><br><span class="line">        deltas = np.zeros((n_targets, n_targets))</span><br><span class="line">        <span class="comment"># åªæŸ¥çœ‹å…³æ³¨çš„å‰kä¸ªæ–‡æ¡£ä¸å…¶ä»–æ–‡æ¡£äº¤æ¢é¡ºåºçš„å·®å€¼ï¼Œä½¿ç”¨ä¸Šæ–‡ä»‹ç»çš„æ–¹æ³•æ¥è®¡ç®—å·®å€¼ï¼Œè¿™é‡Œå¹¶æœªå–ç»å¯¹å€¼</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(min(n_targets, self.k)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i + <span class="number">1</span>, n_targets):</span><br><span class="line">                deltas[i, j] = coeff * \</span><br><span class="line">                    (self._gain_fn(targets[i]) - self._gain_fn(targets[j])) * \</span><br><span class="line">                    (self._get_discount(j) - self._get_discount(i))</span><br></pre></td></tr></table></figure>
<h2 id="æ›´æ–°æ¨¡å‹"><a href="#æ›´æ–°æ¨¡å‹" class="headerlink" title="æ›´æ–°æ¨¡å‹"></a>æ›´æ–°æ¨¡å‹</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_update_terminal_regions</span><span class="params">(self, tree, X, y, lambdas, deltas, y_pred,</span></span></span><br><span class="line"><span class="function"><span class="params">                             sample_mask)</span>:</span></span><br><span class="line">    <span class="comment"># è·å–æ¯ä¸ªæ ·æœ¬è¿›è¿‡å‰å‘ç®—æ³•æœ€ç»ˆè¾“å‡ºçš„å¶å­èŠ‚ç‚¹</span></span><br><span class="line">    terminal_regions = tree.apply(X)</span><br><span class="line">    masked_terminal_regions = terminal_regions.copy()</span><br><span class="line">    <span class="comment"># å¯¹äºæœªå‚ä¸è®­ç»ƒçš„æ ·æœ¬ï¼Œè®¾ç½®å…¶è¾“å‡ºçš„å¶å­èŠ‚ç‚¹ä¸º-1ï¼Œå³å‰”é™¤</span></span><br><span class="line">    masked_terminal_regions[~sample_mask] = <span class="number">-1</span></span><br><span class="line">    <span class="comment"># éå†æ¨¡å‹çš„æ¯ä¸ªå¶å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> leaf <span class="keyword">in</span> np.where(tree.children_left ==</span><br><span class="line">                         sklearn.tree._tree.TREE_LEAF)[<span class="number">0</span>]:</span><br><span class="line">        <span class="comment"># è·å–æ‰€æœ‰è¾“å‡ºä¸ºè¯¥èŠ‚ç‚¹çš„æ ·æœ¬</span></span><br><span class="line">        terminal_region = np.where(masked_terminal_regions == leaf)</span><br><span class="line">        <span class="comment"># è®¡ç®—å…¶lambdaçš„å’Œ</span></span><br><span class="line">        suml = np.sum(lambdas[terminal_region])</span><br><span class="line">        <span class="comment"># è®¡ç®—å…¶æ¢¯åº¦çš„å’Œ</span></span><br><span class="line">        sumd = np.sum(deltas[terminal_region])</span><br><span class="line">        <span class="comment"># è®¾ç½®å¶å­èŠ‚ç‚¹çš„è¾“å‡ºå€¼</span></span><br><span class="line">        tree.value[leaf, <span class="number">0</span>, <span class="number">0</span>] = <span class="number">0.0</span> <span class="keyword">if</span> abs(sumd) &lt; <span class="number">1e-300</span> <span class="keyword">else</span> (suml / sumd)</span><br><span class="line">    <span class="comment"># æ›´æ–°æ¨¡å‹çš„é¢„æµ‹ç»“æœ</span></span><br><span class="line">    y_pred += tree.value[terminal_regions, <span class="number">0</span>, <span class="number">0</span>] * self.learning_rate</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè¿™é‡Œ</p>
<h2 id="é¢„æµ‹"><a href="#é¢„æµ‹" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h2><p>è®­ç»ƒå®Œæˆåï¼Œæˆ–è€…éªŒè¯æ—¶ï¼Œæ‰§è¡Œé¢„æµ‹çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span><span class="params">(self, X)</span>:</span></span><br><span class="line">        <span class="comment"># æ ¡éªŒè¾“å…¥</span></span><br><span class="line">        X = sklearn.utils.validation.check_array(</span><br><span class="line">            X, dtype=sklearn.tree._tree.DTYPE, order=<span class="string">'C'</span>)</span><br><span class="line">        score = np.zeros((X.shape[<span class="number">0</span>], <span class="number">1</span>))</span><br><span class="line">        <span class="comment"># ç¡®å®šå®é™…å›å½’æ ‘æ•°é‡</span></span><br><span class="line">        estimators = self.estimators_</span><br><span class="line">        <span class="keyword">if</span> self.estimators_fitted_ &lt; len(estimators):</span><br><span class="line">            estimators = estimators[:self.estimators_fitted_]</span><br><span class="line">        <span class="comment"># æ‰§è¡Œé¢„æµ‹</span></span><br><span class="line">        sklearn.ensemble._gradient_boosting.predict_stages(</span><br><span class="line">            estimators, X, self.learning_rate, score)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> score.ravel()</span><br></pre></td></tr></table></figure>
<h2 id="ç»ˆæ­¢è®­ç»ƒåˆ¤æ–­"><a href="#ç»ˆæ­¢è®­ç»ƒåˆ¤æ–­" class="headerlink" title="ç»ˆæ­¢è®­ç»ƒåˆ¤æ–­"></a>ç»ˆæ­¢è®­ç»ƒåˆ¤æ–­</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidationMonitor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Monitor for early stopping via validation set."""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, X, y, qids, metric, stop_after=<span class="number">100</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 trim_on_stop=True)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(X) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"A validation set can not be empty!"</span>)</span><br><span class="line">        self.X, self.y = sklearn.utils.check_X_y(</span><br><span class="line">            X, y, dtype=sklearn.tree._tree.DTYPE)</span><br><span class="line">        self.qids = qids</span><br><span class="line">        self.metric = metric</span><br><span class="line">        self.stop_after = stop_after</span><br><span class="line">        self.trim_on_stop = trim_on_stop</span><br><span class="line"></span><br><span class="line">        sklearn.utils.check_consistent_length(self.X, self.y, self.qids)</span><br><span class="line">        check_qids(qids)</span><br><span class="line"></span><br><span class="line">        self._query_groups = list(get_groups(self.qids))</span><br><span class="line">        self._y_pred = <span class="literal">None</span></span><br><span class="line">        self._prev_iter = <span class="number">-1</span></span><br><span class="line">        self._iter_scores = []</span><br><span class="line">        self._best_score = <span class="literal">None</span></span><br><span class="line">        self._best_score_i = <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­å‚æ•°<code>trim_on_stop</code>è¡¨ç¤ºæ˜¯å¦å…è®¸æå‰ç»ˆæ­¢ï¼Œ<code>stop_after</code>è¡¨ç¤ºå½“å‰è®­ç»ƒçš„è½®æ•°ï¼Œä¸æ•ˆæœæœ€å¥½çš„ä¸€è½®ä¹‹é—´å·®çš„è½®æ•°å¦‚æœè¶…è¿‡è¯¥å€¼åˆ™åœæ­¢è®­ç»ƒï¼ˆ<code>trim_on_stop</code>ä¸ºtrueæ—¶ï¼‰ã€‚</p>
<p>å…·ä½“ç»ˆæ­¢åˆ¤æ–­çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›trueè¡¨ç¤ºç»ˆæ­¢è®­ç»ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, i, model, localvars)</span>:</span></span><br><span class="line">    <span class="string">"""Returns True if the model should stop early.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Otherwise, returns a status string.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># å½“å‰è½®æ•°</span></span><br><span class="line">    <span class="keyword">assert</span> i == self._prev_iter + <span class="number">1</span></span><br><span class="line">    self._prev_iter = i</span><br><span class="line">    <span class="comment"># å¦‚æœæ˜¯åŠ æ³•æ¨¡å‹ï¼Œåˆ™å¯¹é¢„æµ‹å€¼è¿›è¡Œç´¯åŠ </span></span><br><span class="line">    <span class="keyword">if</span> isinstance(model, AdditiveModel):</span><br><span class="line">        <span class="keyword">if</span> self._y_pred <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._y_pred = model.predict(self.X)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._y_pred += model.iter_y_delta(i, self.X)</span><br><span class="line">        y_pred = self._y_pred</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        y_pred = model.predict(self.X)</span><br><span class="line">    <span class="comment"># è®¡ç®—æ¯ä¸ªqueryä¸‹æ–‡æ¡£çš„NDCGå€¼ï¼Œå¹¶åŠ å’Œ</span></span><br><span class="line">    score = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> qid, a, b <span class="keyword">in</span> self._query_groups:</span><br><span class="line">        sorted_y = get_sorted_y(self.y[a:b], y_pred[a:b])</span><br><span class="line">        score += self.metric.evaluate(qid, sorted_y)</span><br><span class="line">    <span class="comment"># è¾“å‡ºå½“å‰è½®æ€»çš„NDCGå€¼</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"monitor score: "</span>, score</span><br><span class="line">    <span class="comment"># è®¡ç®—å¹³å‡æ¯ä¸ªqueryçš„NDCGå€¼</span></span><br><span class="line">    score /= len(self._query_groups)</span><br><span class="line">    <span class="comment"># è®°å½•æœ€å¥½çš„è½®æ¬¡å’Œå…¶åˆ†æ•°</span></span><br><span class="line">    <span class="keyword">if</span> self._best_score <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> score &gt; self._best_score:</span><br><span class="line">        self._best_score = score</span><br><span class="line">        self._best_score_i = i</span><br><span class="line">    <span class="comment"># è®°å½•å½“å‰è½®æ¬¡ä¸æœ€å¥½è½®æ¬¡ä¹‹é—´å·®è·</span></span><br><span class="line">    since = i - self._best_score_i</span><br><span class="line">    <span class="comment"># å¦‚æœå…è®¸æå‰ç»ˆæ­¢ï¼Œå¹¶ä¸”è¾¾åˆ°ç»ˆæ­¢æ¡ä»¶ï¼Œåˆ™ç»ˆæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> self.trim_on_stop <span class="keyword">and</span> \</span><br><span class="line">            (since &gt;= self.stop_after <span class="keyword">or</span> i + <span class="number">1</span> == model.n_estimators):</span><br><span class="line">        <span class="comment"># å°†æ¨¡å‹æŒ‰ç…§å®é™…å›å½’æ ‘æ•°é‡ç¼©å°</span></span><br><span class="line">        model.trim(self._best_score_i + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="comment"># å¦‚æœæœªç»ˆæ­¢ï¼Œåˆ™è¿”å›å½“å‰è®­ç»ƒçŠ¶æ€ Cä¸ºqueryçš„å¹³å‡NDCGï¼ŒBä¸ºæœ€å¥½çš„åˆ†æ•°ï¼ŒSä¸ºä¸¾ä¾‹ä¹‹å‰çš„æœ€å¥½åˆ†æ•°çš„è½®æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'C:&#123;:12.4f&#125; B:&#123;:12.4f&#125; S:&#123;:3d&#125;'</span>.format(</span><br><span class="line">        score, self._best_score, since)</span><br></pre></td></tr></table></figure>
<h2 id="æ—¥å¿—è¾“å‡º"><a href="#æ—¥å¿—è¾“å‡º" class="headerlink" title="æ—¥å¿—è¾“å‡º"></a>æ—¥å¿—è¾“å‡º</h2><p>æ—¥å¿—è¾“å‡ºç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_VerboseReporter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Reports verbose output to stdout.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If ``verbose==1`` output is printed once in a while (when iteration mod</span></span><br><span class="line"><span class="string">    verbose_mod is zero).; if larger than 1 then output is printed for</span></span><br><span class="line"><span class="string">    each update.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, verbose)</span>:</span></span><br><span class="line">        self.verbose = verbose</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(self, est, begin_at_stage=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="comment"># header fields and line format str</span></span><br><span class="line">        header_fields = [<span class="string">'Iter'</span>, <span class="string">'Train score'</span>]</span><br><span class="line">        verbose_fmt = [<span class="string">'&#123;iter:&gt;5d&#125;'</span>, <span class="string">'&#123;train_score:&gt;12.4f&#125;'</span>]</span><br><span class="line">        <span class="comment"># do oob?</span></span><br><span class="line">        <span class="keyword">if</span> est.query_subsample &lt; <span class="number">1</span>:</span><br><span class="line">            header_fields.append(<span class="string">'OOB Improve'</span>)</span><br><span class="line">            verbose_fmt.append(<span class="string">'&#123;oob_impr:&gt;12.4f&#125;'</span>)</span><br><span class="line">        header_fields.append(<span class="string">'Remaining'</span>)</span><br><span class="line">        verbose_fmt.append(<span class="string">'&#123;remaining_time:&gt;12s&#125;'</span>)</span><br><span class="line">        header_fields.append(<span class="string">'Monitor Output'</span>)</span><br><span class="line">        verbose_fmt.append(<span class="string">'&#123;monitor_output:&gt;40s&#125;'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print the header line</span></span><br><span class="line">        print((<span class="string">'%5s '</span> + <span class="string">'%12s '</span> *</span><br><span class="line">               (len(header_fields) - <span class="number">2</span>) + <span class="string">'%40s '</span>) % tuple(header_fields))</span><br><span class="line"></span><br><span class="line">        self.verbose_fmt = <span class="string">' '</span>.join(verbose_fmt)</span><br><span class="line">        <span class="comment"># plot verbose info each time i % verbose_mod == 0</span></span><br><span class="line">        self.verbose_mod = <span class="number">1</span></span><br><span class="line">        self.start_time = time.time()</span><br><span class="line">        self.begin_at_stage = begin_at_stage</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, j, est, monitor_output)</span>:</span></span><br><span class="line">        <span class="string">"""Update reporter with new iteration. """</span></span><br><span class="line">        <span class="keyword">if</span> monitor_output <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            print(<span class="string">'Early termination at iteration '</span>, j)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        do_query_oob = est.query_subsample &lt; <span class="number">1</span></span><br><span class="line">        <span class="comment"># we need to take into account if we fit additional estimators.</span></span><br><span class="line">        i = j - self.begin_at_stage  <span class="comment"># iteration relative to the start iter</span></span><br><span class="line">        <span class="keyword">if</span> self.verbose &gt; <span class="number">1</span> <span class="keyword">or</span> (i + <span class="number">1</span>) % self.verbose_mod == <span class="number">0</span>:</span><br><span class="line">            oob_impr = est.oob_improvement_[j] <span class="keyword">if</span> do_query_oob <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            remaining_time = ((est.n_estimators - (j + <span class="number">1</span>)) *</span><br><span class="line">                              (time.time() - self.start_time) / float(i + <span class="number">1</span>))</span><br><span class="line">            <span class="keyword">if</span> remaining_time &gt; <span class="number">60</span>:</span><br><span class="line">                remaining_time = <span class="string">'&#123;0:.2f&#125;m'</span>.format(remaining_time / <span class="number">60.0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                remaining_time = <span class="string">'&#123;0:.2f&#125;s'</span>.format(remaining_time)</span><br><span class="line">            <span class="keyword">if</span> monitor_output <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                monitor_output = <span class="string">''</span></span><br><span class="line">            print(self.verbose_fmt.format(iter=j + <span class="number">1</span>,</span><br><span class="line">                                          train_score=est.train_score_[j],</span><br><span class="line">                                          oob_impr=oob_impr,</span><br><span class="line">                                          remaining_time=remaining_time,</span><br><span class="line">                                          monitor_output=monitor_output))</span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &gt;= <span class="number">10</span>:</span><br><span class="line">                self.verbose_mod = <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &gt;= <span class="number">50</span>:</span><br><span class="line">                self.verbose_mod = <span class="number">10</span></span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &gt;= <span class="number">100</span>:</span><br><span class="line">                self.verbose_mod = <span class="number">20</span></span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &gt;= <span class="number">500</span>:</span><br><span class="line">                self.verbose_mod = <span class="number">50</span></span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &gt;= <span class="number">1000</span>:</span><br><span class="line">                self.verbose_mod = <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<p><a href="https://imgtu.com/i/5qj7Z9" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/10/28/5qj7Z9.png" alt="5qj7Z9.png"></a></p>
<p>å…¶ä¸­è¾“å‡ºçš„æ¯ä¸ªå­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>Iter</td>
<td>è¿­ä»£è½®æ•°</td>
</tr>
<tr>
<td>train score</td>
<td>å¹³å‡çš„NDCGåˆ†æ•°ï¼ˆè¶Šé«˜çº¦å¥½ï¼‰</td>
</tr>
<tr>
<td>OOB Improve</td>
<td>æ¯æ¬¡ä¸ä¸Šä¸€æ­¥è¿­ä»£æå‡çš„train_scoreï¼Œå³delta train_scoreï¼›</td>
</tr>
<tr>
<td>Remaining</td>
<td>æ ¹æ®å½“å‰è®­ç»ƒè½®æ•°å’ŒèŠ±è´¹æ—¶é—´é¢„ä¼°è®­ç»ƒå®Œæˆæ—¶é—´</td>
</tr>
<tr>
<td>C</td>
<td>éªŒè¯é›†çš„å¹³å‡NDGC</td>
</tr>
<tr>
<td>B</td>
<td>å†æ¬¡è¿­ä»£ä¸­éªŒè¯é›†ä¸­æœ€é«˜çš„å¹³å‡NDGC</td>
</tr>
<tr>
<td>S</td>
<td>è¿­è¾¾åˆ°å½“å‰æ­¥æ•°ï¼Œè·ç¦»éªŒè¯é›†æœ€é«˜çš„å¹³å‡ndgcè¿­ä»£æ­¥æ•°çš„å·®(i-best_socre_i)</td>
</tr>
</tbody>
</table>
</div>
<h1 id="å­˜å‚¨æ¨¡å‹å¹¶è¾“å‡ºç›¸å…³æ•ˆæœ"><a href="#å­˜å‚¨æ¨¡å‹å¹¶è¾“å‡ºç›¸å…³æ•ˆæœ" class="headerlink" title="å­˜å‚¨æ¨¡å‹å¹¶è¾“å‡ºç›¸å…³æ•ˆæœ"></a>å­˜å‚¨æ¨¡å‹å¹¶è¾“å‡ºç›¸å…³æ•ˆæœ</h1><p>ä½¿ç”¨pickleåŒ…å­˜å‚¨æ¨¡å‹ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_model</span><span class="params">(model, file)</span>:</span></span><br><span class="line">    save_file = open(file, <span class="string">"wb"</span>)</span><br><span class="line">    pickle.dump(model, save_file)</span><br><span class="line">    save_file.close()</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºæ¯ä¸ªå› å­çš„é‡è¦æ€§ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">id2featrue = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">'../dicts/featrue2id'</span>):</span><br><span class="line">        line = line.strip()</span><br><span class="line">        featrue,id = line.split()</span><br><span class="line">        id = int(id)</span><br><span class="line">        id2featrue[id] = featrue</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> np.argsort(model.feature_importances_):</span><br><span class="line">        <span class="keyword">print</span> id2featrue[i],model.feature_importances_[i]</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ä¸­å­˜å‚¨äº†featureidåˆ°featurenameçš„æ˜ å°„å…³ç³»ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ctr_norm 0</span><br><span class="line">title_oral_tight_term_hit_count_norm 1</span><br><span class="line">cqr_norm 2</span><br><span class="line">pcqr 3</span><br><span class="line">likeRank 4</span><br><span class="line">title_oral_offset_value 5</span><br><span class="line">title_oral_boost_term_hit_count 6</span><br><span class="line">title_oral_offset_value_norm 7</span><br><span class="line">tag_match_score 8</span><br><span class="line">cqr_ 9</span><br><span class="line">title_oral_levenshtein_distance_norm 10</span><br></pre></td></tr></table></figure>
<h1 id="æ¨¡å‹è½¬æ¢"><a href="#æ¨¡å‹è½¬æ¢" class="headerlink" title="æ¨¡å‹è½¬æ¢"></a>æ¨¡å‹è½¬æ¢</h1><p>gbrankåªæ”¯æŒgbrankæ¨¡å‹ï¼Œå› æ­¤éœ€è¦å°†è®­ç»ƒå®Œæˆçš„lambdaMARTæ¨¡å‹è¿›è¡Œä¸€ä¸‹è½¬æ¢ã€‚</p>
<p>ä¿®æ”¹<code>notes/bin/trans_model_format.sh</code>ä¸­çš„è¾“å…¥å’Œè¾“å‡ºæ¨¡å‹å³å¯ã€‚</p>
<p>æ‰§è¡Œå¯¹åº”è„šæœ¬å³è·å¾—å¯ä»¥ç›´æ¥åœ¨vsrankä¸­ä½¿ç”¨çš„æ¨¡å‹ã€‚</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/æ’åº/" rel="tag"># æ’åº</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/30/nginxæ¶æ„åŠæºç è§£è¯»/" rel="next" title="nginxæ¶æ„åŠæºç é˜…è¯»">
                <i class="fa fa-chevron-left"></i> nginxæ¶æ„åŠæºç é˜…è¯»
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">chst</p>
              <p class="site-description motion-element" itemprop="description">äººç”Ÿè‹¦é…’,è‡ªé…¿è‡ªå“</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#NDCGè¯„ä¼°æŒ‡æ ‡"><span class="nav-number">1.</span> <span class="nav-text">NDCGè¯„ä¼°æŒ‡æ ‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç´¯è®¡å¢ç›Š-CG"><span class="nav-number">1.1.</span> <span class="nav-text">ç´¯è®¡å¢ç›Š(CG)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æŠ˜æŸç´¯è®¡å¢ç›Š-DCG"><span class="nav-number">1.2.</span> <span class="nav-text">æŠ˜æŸç´¯è®¡å¢ç›Š(DCG)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š-NDCG"><span class="nav-number">1.3.</span> <span class="nav-text">å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š(NDCG)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ’åºå­¦ä¹ LTR"><span class="nav-number">2.</span> <span class="nav-text">æ’åºå­¦ä¹ LTR</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å•ç‚¹æ³•"><span class="nav-number">2.1.</span> <span class="nav-text">å•ç‚¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é…å¯¹æ³•"><span class="nav-number">2.2.</span> <span class="nav-text">é…å¯¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ—è¡¨æ³•"><span class="nav-number">2.3.</span> <span class="nav-text">åˆ—è¡¨æ³•</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LambdaMARTç®—æ³•"><span class="nav-number">3.</span> <span class="nav-text">LambdaMARTç®—æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RankNet"><span class="nav-number">3.1.</span> <span class="nav-text">RankNet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#çœŸå®çš„ç›¸å…³æ€§æ¦‚ç‡"><span class="nav-number">3.1.1.</span> <span class="nav-text">çœŸå®çš„ç›¸å…³æ€§æ¦‚ç‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æŸå¤±å‡½æ•°"><span class="nav-number">3.1.2.</span> <span class="nav-text">æŸå¤±å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‚æ•°æ›´æ–°"><span class="nav-number">3.1.3.</span> <span class="nav-text">å‚æ•°æ›´æ–°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LambdaRank"><span class="nav-number">3.2.</span> <span class="nav-text">LambdaRank</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LambdaMARTç®—æ³•-1"><span class="nav-number">3.3.</span> <span class="nav-text">LambdaMARTç®—æ³•</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç¨‹åºæ‰§è¡Œé€»è¾‘"><span class="nav-number">4.</span> <span class="nav-text">ç¨‹åºæ‰§è¡Œé€»è¾‘</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#è¯»å–æ•°æ®"><span class="nav-number">4.1.</span> <span class="nav-text">è¯»å–æ•°æ®</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#lambdaMart"><span class="nav-number">5.</span> <span class="nav-text">lambdaMart</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆå§‹åŒ–å‚æ•°"><span class="nav-number">5.1.</span> <span class="nav-text">åˆå§‹åŒ–å‚æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#metric"><span class="nav-number">5.1.1.</span> <span class="nav-text">metric</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ‰§è¡Œfitï¼ˆæ‹Ÿåˆï¼‰å‡½æ•°"><span class="nav-number">5.2.</span> <span class="nav-text">æ‰§è¡Œfitï¼ˆæ‹Ÿåˆï¼‰å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è·å–lambdaåŠç›¸å¯¹äºå½“å‰æ¨¡å‹çš„æ¢¯åº¦"><span class="nav-number">5.3.</span> <span class="nav-text">è·å–lambdaåŠç›¸å¯¹äºå½“å‰æ¨¡å‹çš„æ¢¯åº¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è®¡ç®—äº’æ¢ä½ç½®åNDCGå€¼"><span class="nav-number">5.4.</span> <span class="nav-text">è®¡ç®—äº’æ¢ä½ç½®åNDCGå€¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ›´æ–°æ¨¡å‹"><span class="nav-number">5.5.</span> <span class="nav-text">æ›´æ–°æ¨¡å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é¢„æµ‹"><span class="nav-number">5.6.</span> <span class="nav-text">é¢„æµ‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»ˆæ­¢è®­ç»ƒåˆ¤æ–­"><span class="nav-number">5.7.</span> <span class="nav-text">ç»ˆæ­¢è®­ç»ƒåˆ¤æ–­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ—¥å¿—è¾“å‡º"><span class="nav-number">5.8.</span> <span class="nav-text">æ—¥å¿—è¾“å‡º</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å­˜å‚¨æ¨¡å‹å¹¶è¾“å‡ºç›¸å…³æ•ˆæœ"><span class="nav-number">6.</span> <span class="nav-text">å­˜å‚¨æ¨¡å‹å¹¶è¾“å‡ºç›¸å…³æ•ˆæœ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ¨¡å‹è½¬æ¢"><span class="nav-number">7.</span> <span class="nav-text">æ¨¡å‹è½¬æ¢</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chst</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="../js/src/av-min.js"></script>
  <script src="../js/src/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '0j9TGrGA2Aq8e4SO1sUkgQCv-gzGzoHsz',
        appKey: 'Q6jotQjlp43pwpkFCJhQ9s95',
        placeholder: 'è¯·ç•™ä¸‹è”ç³»æ–¹å¼ï¼Œæˆ‘ä¼šå°½å¿«å›å¤',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("0j9TGrGA2Aq8e4SO1sUkgQCv-gzGzoHsz", "Q6jotQjlp43pwpkFCJhQ9s95");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
<!-- é¡µé¢ç‚¹å‡»å°çº¢å¿ƒ -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
